<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>world_agent API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="index.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;
                Module Index
            </a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#WorldAgent">WorldAgent</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#WorldAgent.__init__">WorldAgent</a>
                        </li>
                        <li>
                                <a class="variable" href="#WorldAgent.world">world</a>
                        </li>
                        <li>
                                <a class="class" href="#WorldAgent.TimeDeltaBehaviour">WorldAgent.TimeDeltaBehaviour</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#WorldAgent.TimeDeltaBehaviour.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#WorldAgent.MessageHandlerBehaviour">WorldAgent.MessageHandlerBehaviour</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#WorldAgent.MessageHandlerBehaviour.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="function" href="#WorldAgent.setup">setup</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#main">main</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
world_agent    </h1>

                
                        <input id="mod-world_agent-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-world_agent-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">spade</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.behaviour</span><span class="w"> </span><span class="kn">import</span> <span class="n">CyclicBehaviour</span><span class="p">,</span> <span class="n">OneShotBehaviour</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">Message</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">Template</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">world.world</span><span class="w"> </span><span class="kn">import</span> <span class="n">World</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="k">class</span><span class="w"> </span><span class="nc">WorldAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A SPADE agent that manages and simulates the supply chain world.</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">    </span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    This agent serves as the central coordinator for the supply chain simulation,</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">    managing the world state, executing simulation ticks, and handling communication</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">    with other agents (Store, Warehouse, Supplier, and Event agents). It implements</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">    the FIPA Agent Management Specification for agent discovery and coordination.</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">    </span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">    The WorldAgent acts as a service provider, offering query services for world</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">    state information and event simulation. It follows FIPA protocols for:</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">    - Request/Response interactions (for time-delta and traffic simulations)</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">    - Inform interactions (for world state broadcasts and query responses)</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">    </span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">    Attributes:</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">        world (World): The World instance containing the graph structure and</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">            simulation state (nodes, edges, facilities, etc.).</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">        subscribers (list): A list of agent JIDs subscribed to world state updates.</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">        tick_interval (float): Time in seconds between consecutive world ticks.</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">    </span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">    Responsibilities:</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">        - Manage and maintain the world state and simulation progress</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">        - Execute world ticks at regular intervals and simulate time progression</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">        - Handle traffic dynamics and traffic simulation requests from Event agents</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">        - Respond to queries from other agents about world state (nodes, edges, facilities)</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">        - Broadcast world state updates to subscribed agents</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">        - Coordinate time-delta simulations with configurable duration</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">world</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the WorldAgent.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">        </span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">        Creates a new WorldAgent instance and optionally associates it with a World</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">        object. The agent initializes with empty subscriber list and default</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">        tick interval. If no world is provided, it must be set before the agent</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        is fully operational.</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">        </span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">        Args:</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">            jid (str): The Jabber ID (JID) for this agent on the XMPP server.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">                Format: &#39;agent_name@server_address&#39;</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">            password (str): The authentication password for the agent on the XMPP server.</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">            world (World, optional): A pre-initialized World instance containing</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">                the simulation graph and state. If None, must be assigned before</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">                the agent starts handling simulation requests. Defaults to None.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">        </span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">        Returns:</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">            None: Constructor initializes the parent Agent class and stores references.</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">world</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">TimeDeltaBehaviour</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles time-delta simulation requests and traffic simulation requests.</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">        </span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">        This behaviour implements FIPA Request/Response protocol for handling two types</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">        of simulation requests from other agents:</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">        </span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">        1. Traffic Simulation Requests: Receive requests from Event agents to simulate</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">           traffic dynamics. Processes &quot;simulate_traffic&quot; action requests, runs the</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">           simulation for the specified duration, and returns generated traffic events.</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">        </span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">        2. Time-Delta Requests: Receive requests to advance the simulation by a</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">           specified number of ticks. Tracks edge weight changes (travel times and</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">           fuel consumption) during the simulation period and returns detailed</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">           information about which edges changed and when.</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">        </span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">        FIPA Protocol Compliance:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">        - Implements the FIPA Request interaction protocol</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">        - Receives REQUEST messages with performative=&quot;request&quot;</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">        - Sends back INFORM messages with performative=&quot;inform&quot;</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">        - Gracefully handles protocol violations with JSON decode errors</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">        </span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">        This behaviour runs cyclically (continuously) checking for incoming messages</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">        with a timeout to prevent blocking the agent&#39;s other behaviours.</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Process time-delta messages and simulate world.</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">            </span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">            Executes one iteration of the cyclic behaviour. This method:</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">            1. Waits for incoming messages with a 1-second timeout</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">            2. If a message is received, parses its JSON content</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">            3. Identifies the message type (traffic simulation or time-delta)</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">            4. Routes to appropriate handler based on action metadata</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">            5. Sends response back to sender with simulation results</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">            6. Handles exceptions gracefully, logging errors</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">            </span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">            The method operates on two distinct message types:</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">            - Traffic Simulation: Calls world.get_events() to simulate traffic</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">            - Time-Delta: Simulates multiple ticks and tracks edge state changes</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">            </span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">            For time-delta requests, the behaviour:</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">            - Records initial edge weights before simulation</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">            - Executes the requested number of ticks sequentially</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">            - For each edge that changes, calculates fuel consumption</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">            - Tracks the tick index where each change occurred</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">            - Returns complete change history to the requester</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">            </span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">            Raises:</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">                json.JSONDecodeError: If message body is invalid JSON (logged, not raised)</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">                Exception: Any other runtime error (logged, not raised)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">            </span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">            Yields:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">                None: This cyclic behaviour continues indefinitely</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>            
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>                    <span class="c1"># Check if it&#39;s a traffic simulation request from event agent</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;request&quot;</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;simulate_traffic&quot;</span><span class="p">:</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>                        <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>                        <span class="n">simulation_time</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simulation_time&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>                        <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>                        
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Traffic simulation request received&quot;</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sender: </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Simulation time: </span><span class="si">{</span><span class="n">simulation_time</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>                        
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>                        <span class="c1"># Simulate traffic events using get_events</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>                        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">simulation_time</span><span class="p">))</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>                        
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Simulation completed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="si">}</span><span class="s2"> events generated&quot;</span><span class="p">)</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>                        
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>                        <span class="c1"># Send response with traffic events (FIPA Inform)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>                        <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>                        <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>                        <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;traffic_events&quot;</span><span class="p">)</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>                        <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>                            <span class="s2">&quot;events&quot;</span><span class="p">:</span> <span class="n">events</span><span class="p">,</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>                            <span class="s2">&quot;simulation_time&quot;</span><span class="p">:</span> <span class="n">simulation_time</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>                        <span class="p">})</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>                        
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Traffic events sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>                        <span class="k">return</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>                    
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>                    <span class="c1"># Handle normal time-delta requests (FIPA Request/Response pattern)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>                    <span class="n">delta_time</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delta_time&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>                    <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>                    
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Received time-delta request: </span><span class="si">{</span><span class="n">delta_time</span><span class="si">}</span><span class="s2"> ticks from </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>                    
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>                    <span class="c1"># Store initial edge states for change detection</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>                    <span class="n">initial_states</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>                    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>                        <span class="n">initial_states</span><span class="p">[(</span><span class="n">edge</span><span class="o">.</span><span class="n">node1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>                    
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>                    <span class="c1"># Simulate delta_time ticks and track changes</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>                    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">delta_time</span><span class="p">):</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Simulate one tick at a time</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>                        <span class="n">current_tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>                        
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Simulated tick </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">delta_time</span><span class="si">}</span><span class="s2"> (current tick: </span><span class="si">{</span><span class="n">current_tick</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>                        
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>                        <span class="c1"># Check which edges changed in this tick</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>                        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>                            <span class="n">edge_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">node1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>                            <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">!=</span> <span class="n">initial_states</span><span class="p">[</span><span class="n">edge_key</span><span class="p">]:</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>                                <span class="c1"># Edge changed - record the instant (tick index)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>                                <span class="n">edge</span><span class="o">.</span><span class="n">calculate_fuel_consumption</span><span class="p">()</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>                                <span class="n">edge_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>                                    <span class="s2">&quot;node1_id&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">node1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>                                    <span class="s2">&quot;node2_id&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>                                    <span class="s2">&quot;new_time&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>                                    <span class="s2">&quot;new_fuel_consumption&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">fuel_consumption</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>                                    <span class="s2">&quot;instant&quot;</span><span class="p">:</span> <span class="n">i</span>  <span class="c1"># The tick index when it changed</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>                                <span class="p">}</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>                                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_info</span><span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>                                <span class="c1"># Update the initial state to current state</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>                                <span class="n">initial_states</span><span class="p">[</span><span class="n">edge_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>                    
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>                    <span class="c1"># Send response with all edge states (FIPA Inform)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;time_delta_response&quot;</span><span class="p">,</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>                        <span class="s2">&quot;delta_time&quot;</span><span class="p">:</span> <span class="n">delta_time</span><span class="p">,</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>                        <span class="s2">&quot;final_tick&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span><span class="p">,</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>                        <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="n">results</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>                    <span class="p">})</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>                    
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Sent time-delta response with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> edge updates&quot;</span><span class="p">)</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>                    
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error decoding time-delta message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error in TimeDeltaBehaviour: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">MessageHandlerBehaviour</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles incoming messages from other agents.</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">        </span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">        This behaviour processes all general query and subscription messages from</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">        other agents in the supply chain system. It operates as a message dispatcher,</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        routing incoming messages to specialized handler methods based on the</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">        message type field.</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="sd">        </span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">        Supported message types and their handlers:</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">        - &quot;query_world_state&quot;: Returns complete world simulation state</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">        - &quot;query_node_info&quot;: Returns information about a specific graph node</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">        - &quot;query_edge_info&quot;: Returns information about a specific edge</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">        - &quot;query_facilities&quot;: Returns locations of all supply chain facilities</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">        - &quot;subscribe&quot;: Registers an agent for periodic world state updates</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">        </span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">        FIPA Protocol Compliance:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">        - Processes messages from agents following FIPA protocols</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">        - Sends INFORM messages (performative=&quot;inform&quot;) for successful queries</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">        - Returns ERROR messages for queries that fail or have invalid parameters</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">        - Handles SUBSCRIBE messages for publish/subscribe pattern coordination</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        </span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">        Message Flow:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">        1. Receives a message with JSON body containing &quot;type&quot; field</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">        2. Validates JSON structure and extracts message type</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a><span class="sd">        3. Routes to appropriate private handler method (_handle_*)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="sd">        4. Handler method constructs response with agent&#39;s data</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">        5. Response sent back to originating agent</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">        </span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">        Error Handling:</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">        - JSON decode errors are logged and ignored</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">        - Unknown message types are logged with diagnostic info</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="sd">        - Handler exceptions are caught and logged</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">        </span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">        This behaviour runs cyclically with a 1-second timeout between iterations.</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Process incoming messages.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">            </span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">            Executes one iteration of the cyclic message handling. This method:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">            1. Waits up to 1 second for an incoming message</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">            2. If no message arrives within timeout, cycles immediately</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">            3. If a message arrives, attempts to parse it as JSON</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">            4. Extracts the &quot;type&quot; field to determine message category</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="sd">            5. Dispatches to the appropriate handler coroutine</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">            6. Catches and logs any JSON or handler exceptions</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">            </span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">            The dispatcher pattern allows different message types to be handled</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">            by specialized methods, keeping this method focused on high-level</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">            message routing and error handling.</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">            </span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="sd">            Raises:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a><span class="sd">                json.JSONDecodeError: If msg.body is not valid JSON (caught, logged)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="sd">                Exception: Any handler exception (caught, logged)</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a><span class="sd">            </span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a><span class="sd">            Yields:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a><span class="sd">                None: Continues indefinitely as a cyclic behaviour</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>            
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                    <span class="n">msg_type</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>                    
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>                    <span class="k">if</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_world_state&quot;</span><span class="p">:</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_world_state_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                    
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_node_info&quot;</span><span class="p">:</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_node_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>                    
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_edge_info&quot;</span><span class="p">:</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_edge_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                    
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_facilities&quot;</span><span class="p">:</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_facilities_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>                    
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">:</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_subscribe</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>                    
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Unknown message type: </span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                        
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error decoding message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error handling message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_world_state_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle query for complete world state.</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a><span class="sd">            </span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="sd">            Responds to queries requesting the complete world state snapshot.</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a><span class="sd">            Compiles all relevant world information including simulation progress,</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a><span class="sd">            grid dimensions, facility counts, and infected edge statistics.</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a><span class="sd">            </span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="sd">            This handler follows the FIPA Query interaction protocol by:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a><span class="sd">            - Receiving a query request message</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="sd">            - Preparing comprehensive state information</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">            - Sending an INFORM message with the complete state</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">            </span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="sd">            Args:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">                msg (Message): The incoming query message from sender agent.</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a><span class="sd">                    Expected to be of type &quot;query_world_state&quot; in JSON body.</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="sd">            </span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="sd">            Returns:</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">                None: Sends response asynchronously via FIPA INFORM message</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="sd">            </span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">            Response payload includes:</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">                - tick: Current simulation time step counter</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="sd">                - width/height: Grid dimensions in the world graph</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="sd">                - seed: Random seed used for deterministic reproduction</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">                - mode: Simulation mode (e.g., &quot;traffic&quot; or other modes)</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="sd">                - num_nodes: Total number of nodes in the supply chain graph</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a><span class="sd">                - num_edges: Total number of edges in the supply chain graph</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="sd">                - infected_edges: Count of edges currently experiencing traffic</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="sd">                - gas_stations: Number and IDs of gas station facilities</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="sd">                - warehouses: Number and IDs of warehouse facilities</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="sd">                - suppliers: Number and IDs of supplier facilities</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a><span class="sd">                - stores: Number and IDs of store facilities</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="n">world_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>                <span class="s2">&quot;tick&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span><span class="p">,</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                <span class="s2">&quot;num_nodes&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                <span class="s2">&quot;num_edges&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">),</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                <span class="s2">&quot;infected_edges&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">infected_edges</span><span class="p">),</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                <span class="s2">&quot;gas_stations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">gas_stations</span><span class="p">,</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                <span class="s2">&quot;warehouses&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">warehouses</span><span class="p">,</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                <span class="s2">&quot;suppliers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">suppliers</span><span class="p">,</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                <span class="s2">&quot;stores&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">stores</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>            <span class="p">}</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>            
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;world_state&quot;</span><span class="p">,</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">world_data</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>            <span class="p">})</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] World state sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_node_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle query for information about a specific node.</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">            </span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">            Responds to queries requesting detailed information about a single node</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a><span class="sd">            in the supply chain graph. The node is identified by its ID in the</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="sd">            query message. Returns node coordinates, facility affiliations, and</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">            other node-specific metadata.</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">            </span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="sd">            FIPA Query/Response Protocol:</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="sd">            - Receives QUERY message with specific node_id parameter</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">            - Searches graph for the requested node</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="sd">            - Returns INFORM message with node data if found</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">            - Returns ERROR message if node not found</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a><span class="sd">            </span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">            Args:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="sd">                msg (Message): The incoming query message from sender agent.</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="sd">                    Message body must include JSON with:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="sd">                    - type: &quot;query_node_info&quot;</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a><span class="sd">                    - node_id: The ID of the node to query</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a><span class="sd">            </span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="sd">            Returns:</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">                None: Sends FIPA response message (INFORM or ERROR)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">            </span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">            Response for successful query:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a><span class="sd">                - id: The node identifier</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a><span class="sd">                - x: X-coordinate position in the world grid</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="sd">                - y: Y-coordinate position in the world grid</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a><span class="sd">                - warehouse: Boolean indicating if node hosts a warehouse</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="sd">                - supplier: Boolean indicating if node hosts a supplier</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="sd">                - store: Boolean indicating if node hosts a store</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="sd">                - gas_station: Boolean indicating if node has a gas station</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="sd">            </span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="sd">            Response for failed query (node not found):</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="sd">                - type: &quot;error&quot;</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">                - message: Descriptive error message</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="sd">            </span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">            Raises:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">                Exception: Any runtime error during query processing</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="sd">                    (caught and reported in error response)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                <span class="n">node_id</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">)</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>                
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                <span class="k">if</span> <span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Node </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s2"> not found&quot;</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>                    <span class="p">})</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>                    <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>                    <span class="n">node_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>                        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                        <span class="s2">&quot;warehouse&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">warehouse</span><span class="p">,</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                        <span class="s2">&quot;supplier&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">supplier</span><span class="p">,</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                        <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">store</span><span class="p">,</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                        <span class="s2">&quot;gas_station&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">gas_station</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                    <span class="p">}</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                    
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;node_info&quot;</span><span class="p">,</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">node_data</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>                    <span class="p">})</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Node </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s2"> information sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>                <span class="p">})</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_edge_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle query for information about edges.</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="sd">            </span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">            Responds to queries requesting detailed information about a specific edge</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="sd">            in the supply chain graph. The edge is identified by its two endpoint nodes</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="sd">            (node_u and node_v). Returns edge properties including traversal time,</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a><span class="sd">            distance, fuel consumption, and infection status.</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a><span class="sd">            </span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a><span class="sd">            FIPA Query/Response Protocol:</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a><span class="sd">            - Receives QUERY message with node_u and node_v parameters</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a><span class="sd">            - Looks up edge in graph using get_edge() method</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a><span class="sd">            - Returns INFORM message with edge data if found</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a><span class="sd">            - Returns ERROR message if edge not found</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a><span class="sd">            </span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a><span class="sd">            Args:</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a><span class="sd">                msg (Message): The incoming query message from sender agent.</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a><span class="sd">                    Message body must include JSON with:</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="sd">                    - type: &quot;query_edge_info&quot;</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">                    - node_u: Source node ID</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a><span class="sd">                    - node_v: Destination node ID</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="sd">            </span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="sd">            Returns:</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">                None: Sends FIPA response message (INFORM or ERROR)</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a><span class="sd">            </span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">            Response for successful query:</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">                - node_u: Source node ID</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="sd">                - node_v: Destination node ID</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">                - weight: Current edge weight (travel time in current tick)</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">                - initial_weight: Original edge weight from graph initialization</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">                - distance: Geometric distance between nodes</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="sd">                - fuel_consumption: Fuel needed to traverse this edge</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">                - is_infected: Boolean indicating if edge has traffic/infection</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a><span class="sd">            </span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a><span class="sd">            Response for failed query (edge not found):</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a><span class="sd">                - type: &quot;error&quot;</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a><span class="sd">                - message: Descriptive error message</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a><span class="sd">            </span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a><span class="sd">            Raises:</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a><span class="sd">                Exception: Any runtime error during query processing</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a><span class="sd">                    (caught and reported in error response)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                <span class="n">node_u</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_u&quot;</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>                <span class="n">node_v</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_v&quot;</span><span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>                
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>                <span class="n">edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">node_u</span><span class="p">,</span> <span class="n">node_v</span><span class="p">)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>                
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                <span class="k">if</span> <span class="n">edge</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Edge (</span><span class="si">{</span><span class="n">node_u</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">node_v</span><span class="si">}</span><span class="s2">) not found&quot;</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>                    <span class="p">})</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                    <span class="n">edge_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>                        <span class="s2">&quot;node_u&quot;</span><span class="p">:</span> <span class="n">node_u</span><span class="p">,</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>                        <span class="s2">&quot;node_v&quot;</span><span class="p">:</span> <span class="n">node_v</span><span class="p">,</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>                        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>                        <span class="s2">&quot;initial_weight&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">initial_weight</span><span class="p">,</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>                        <span class="s2">&quot;distance&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">distance</span><span class="p">,</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>                        <span class="s2">&quot;fuel_consumption&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">get_fuel_consumption</span><span class="p">(),</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>                        <span class="s2">&quot;is_infected&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">node_u</span><span class="p">,</span> <span class="n">node_v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">infected_edges</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>                    <span class="p">}</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>                    
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;edge_info&quot;</span><span class="p">,</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">edge_data</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>                    <span class="p">})</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>                
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Edge (</span><span class="si">{</span><span class="n">node_u</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">node_v</span><span class="si">}</span><span class="s2">) information sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>                
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>                <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>                <span class="p">})</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_facilities_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle query for facility locations.</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="sd">            </span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="sd">            Responds to queries requesting the complete list of all supply chain</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a><span class="sd">            facility locations organized by type. This includes warehouses, suppliers,</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">            gas stations, and stores. The facilities are represented by their node IDs</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">            in the supply chain graph.</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a><span class="sd">            </span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a><span class="sd">            FIPA Query/Response Protocol:</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a><span class="sd">            - Receives QUERY message for facility locations</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a><span class="sd">            - Iterates through all nodes in graph checking facility flags</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a><span class="sd">            - Returns INFORM message with categorized facility lists</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a><span class="sd">            </span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a><span class="sd">            This query is useful for agents that need to plan routes or coordinate</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a><span class="sd">            with specific facility types without needing full node data.</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a><span class="sd">            </span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a><span class="sd">            Args:</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a><span class="sd">                msg (Message): The incoming query message from sender agent.</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a><span class="sd">                    Expected to be of type &quot;query_facilities&quot; in JSON body.</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a><span class="sd">            </span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a><span class="sd">            Returns:</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a><span class="sd">                None: Sends FIPA INFORM message with facilities categorized by type</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a><span class="sd">            </span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a><span class="sd">            Response payload structure:</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a><span class="sd">                - warehouses: List of node IDs hosting warehouse facilities</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a><span class="sd">                - suppliers: List of node IDs hosting supplier facilities</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a><span class="sd">                - stores: List of node IDs hosting store facilities</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a><span class="sd">                - gas_stations: List of node IDs hosting gas station facilities</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a><span class="sd">            </span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a><span class="sd">            Note:</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a><span class="sd">                A single node can host multiple facilities simultaneously.</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a><span class="sd">                Facilities are identified based on boolean flags on node objects.</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>            
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>            <span class="n">facilities</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>                <span class="s2">&quot;warehouses&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>                <span class="s2">&quot;suppliers&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>                <span class="s2">&quot;stores&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>                <span class="s2">&quot;gas_stations&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>            <span class="p">}</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>            
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>            <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">warehouse</span><span class="p">:</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>                    <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;warehouses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">supplier</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>                    <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;suppliers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>                    <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;stores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">gas_station</span><span class="p">:</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>                    <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;gas_stations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>            
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;facilities_info&quot;</span><span class="p">,</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">facilities</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>            <span class="p">})</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Facilities information sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle subscription requests for world state updates.</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a><span class="sd">            </span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a><span class="sd">            Processes subscription requests from agents that wish to receive</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a><span class="sd">            periodic world state update broadcasts. When an agent subscribes,</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a><span class="sd">            it is added to the WorldAgent&#39;s subscriber list and will receive</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a><span class="sd">            INFORM messages whenever the world state changes significantly</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a><span class="sd">            (e.g., when new traffic events occur).</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a><span class="sd">            </span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a><span class="sd">            FIPA Publish/Subscribe Pattern:</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a><span class="sd">            - Receives SUBSCRIBE message from requesting agent</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a><span class="sd">            - Validates agent is not already subscribed (prevents duplicates)</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a><span class="sd">            - Adds agent JID to internal subscriber list</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a><span class="sd">            - Sends confirmation message back to subscriber</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a><span class="sd">            </span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a><span class="sd">            The subscription mechanism allows agents to stay informed about</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a><span class="sd">            world state changes without polling for updates.</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a><span class="sd">            </span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a><span class="sd">            Args:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a><span class="sd">                msg (Message): The incoming subscription request message.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a><span class="sd">                    Expected to be of type &quot;subscribe&quot; in JSON body.</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a><span class="sd">            </span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a><span class="sd">            Returns:</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a><span class="sd">                None: Adds sender to subscribers and sends confirmation</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a><span class="sd">            </span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a><span class="sd">            Side Effects:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a><span class="sd">                - Adds sender JID to self.agent.subscribers list</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a><span class="sd">                - Logs subscription confirmation message</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a><span class="sd">            </span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a><span class="sd">            Confirmation Response:</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a><span class="sd">                - type: &quot;subscription_confirmed&quot;</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a><span class="sd">                - performative: &quot;confirm&quot;</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a><span class="sd">            </span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a><span class="sd">            Once subscribed, the agent will receive messages via</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a><span class="sd">            _broadcast_world_state() when updates are available.</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>            <span class="k">if</span> <span class="n">sender</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">subscribers</span><span class="p">:</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">subscribers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Agent </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2"> subscribed to world updates&quot;</span><span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>            
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>            <span class="c1"># Send confirmation</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;confirm&quot;</span><span class="p">)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;subscription_confirmed&quot;</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>            <span class="p">})</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_broadcast_world_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Broadcast world state to all subscribed agents.</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a><span class="sd">        </span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a><span class="sd">        Sends a world state update message to all agents that have subscribed</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a><span class="sd">        to receive periodic updates. This implements the Publish/Subscribe pattern</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a><span class="sd">        from FIPA interactions, allowing multiple consumer agents to receive</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a><span class="sd">        notifications about world state changes without polling.</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a><span class="sd">        </span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a><span class="sd">        FIPA Publish/Subscribe Pattern:</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a><span class="sd">        - Sends INFORM messages to all subscribed agents</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a><span class="sd">        - Includes current simulation tick and infected edge count</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a><span class="sd">        - Called whenever significant world state changes occur</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a><span class="sd">        </span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a><span class="sd">        Message Structure:</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a><span class="sd">        Each broadcast message contains:</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a><span class="sd">        - type: &quot;world_tick_update&quot; identifying the message type</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a><span class="sd">        - tick: Current simulation time counter</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a><span class="sd">        - infected_edges: Current count of traffic-affected edges</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a><span class="sd">        </span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a><span class="sd">        This method iterates through self.subscribers list and sends a copy</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a><span class="sd">        of the world update message to each subscriber independently. If a</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a><span class="sd">        subscriber is no longer available, the XMPP server will handle the</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a><span class="sd">        delivery failure appropriately.</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a><span class="sd">        </span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a><span class="sd">        Args:</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a><span class="sd">            None: Uses self.world and self.subscribers from agent instance</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a><span class="sd">        </span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a><span class="sd">        Returns:</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a><span class="sd">            None: Sends messages asynchronously, does not wait for delivery</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a><span class="sd">        </span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a><span class="sd">            - Sends XMPP MESSAGE stanzas to all subscribers</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a><span class="sd">            - Does not modify agent state</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="n">world_update</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;world_tick_update&quot;</span><span class="p">,</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>            <span class="s2">&quot;tick&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span><span class="p">,</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>            <span class="s2">&quot;infected_edges&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">infected_edges</span><span class="p">),</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>        <span class="p">}</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>        
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>        <span class="k">for</span> <span class="n">subscriber</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscribers</span><span class="p">:</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">subscriber</span><span class="p">)</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">world_update</span><span class="p">)</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up the WorldAgent with its behaviors.</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a><span class="sd">        </span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a><span class="sd">        Initializes the WorldAgent by configuring all required attributes,</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a><span class="sd">        validating the world instance, and registering the agent&#39;s behaviours.</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a><span class="sd">        This method is called once when the agent starts, before it begins</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a><span class="sd">        processing messages or executing behaviours.</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a><span class="sd">        </span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a><span class="sd">        SPADE Agent Lifecycle:</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a><span class="sd">        - Called automatically by SPADE after agent initialization</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a><span class="sd">        - Must call parent&#39;s setup if overriding (implicitly done via parent)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a><span class="sd">        - Should register all behaviours before returning</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a><span class="sd">        </span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a><span class="sd">        Initialization Steps:</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a><span class="sd">        1. Initialize subscribers list if not already present</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a><span class="sd">        2. Initialize tick_interval (seconds between simulation steps)</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a><span class="sd">        3. Verify World instance is properly set</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a><span class="sd">        4. Log diagnostic information about world configuration</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a><span class="sd">        5. Register TimeDeltaBehaviour with template for specific messages</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a><span class="sd">        6. Register MessageHandlerBehaviour for general message handling</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a><span class="sd">        </span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a><span class="sd">        Behaviours Registered:</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a><span class="sd">        - TimeDeltaBehaviour: Handles time-delta requests and traffic simulation</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a><span class="sd">          This behaviour uses a template to match messages with specific metadata</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a><span class="sd">        - MessageHandlerBehaviour: Routes incoming queries to specialized handlers</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a><span class="sd">          This behaviour runs without template, accepting all remaining messages</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a><span class="sd">        </span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a><span class="sd">        Warning Conditions:</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a><span class="sd">        - If world is None, agent will be non-functional but will start</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a><span class="sd">        - Logs diagnostic warnings to help identify configuration issues</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a><span class="sd">        </span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a><span class="sd">        Args:</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a><span class="sd">            None: Uses self attributes set during __init__</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a><span class="sd">        </span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a><span class="sd">        Returns:</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a><span class="sd">            None: Configures agent in-place and returns</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a><span class="sd">        </span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a><span class="sd">            - Initializes self.subscribers to empty list</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a><span class="sd">            - Sets self.tick_interval to 2 seconds (default)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a><span class="sd">            - Registers behaviours with the SPADE framework</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a><span class="sd">            - Prints diagnostic setup information</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Setting up WorldAgent...&quot;</span><span class="p">)</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>        
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>        <span class="c1"># Initialize agent attributes if not set</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;subscribers&#39;</span><span class="p">):</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">subscribers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;tick_interval&#39;</span><span class="p">):</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tick_interval</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Seconds between world ticks</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>        
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] World instance provided&quot;</span><span class="p">)</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Grid: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Seed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] WARNING: No World instance provided!&quot;</span><span class="p">)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>        
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>        <span class="c1"># Add time-delta behaviour with template</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;request&quot;</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;performative&quot;</span><span class="p">:</span> <span class="s2">&quot;request&quot;</span><span class="p">}</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TimeDeltaBehaviour</span><span class="p">(),</span> <span class="n">template</span><span class="p">)</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>        
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MessageHandlerBehaviour</span><span class="p">())</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>        
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] WorldAgent setup complete!&quot;</span><span class="p">)</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main entry point for the WorldAgent.</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a><span class="sd">    </span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a><span class="sd">    Initializes and starts the WorldAgent instance, handling its lifecycle</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a><span class="sd">    from startup through shutdown. This is the entry function used when</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a><span class="sd">    running the WorldAgent as a standalone SPADE agent.</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a><span class="sd">    </span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a><span class="sd">    Prerequisites:</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a><span class="sd">    - An XMPP server (such as ejabberd) must be running and accessible</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a><span class="sd">    - Default configuration uses localhost:5222 (standard XMPP port)</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a><span class="sd">    - An agent account must exist on the XMPP server with matching JID/password</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a><span class="sd">    </span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a><span class="sd">    Configuration:</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a><span class="sd">    - Agent JID: &quot;world@localhost&quot; (change to match your XMPP server)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a><span class="sd">    - Password: &quot;password&quot; (change to match registered account)</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a><span class="sd">    - Server: localhost (default XMPP configuration)</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a><span class="sd">    </span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a><span class="sd">    Lifecycle:</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a><span class="sd">    1. Creates a new WorldAgent instance</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a><span class="sd">    2. Calls start() to initialize the agent on XMPP server</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a><span class="sd">    3. Enters infinite loop to keep agent running</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a><span class="sd">    4. On KeyboardInterrupt (Ctrl+C), cleanly stops the agent</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a><span class="sd">    5. Handles any exceptions during execution</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a><span class="sd">    </span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a><span class="sd">    Error Handling:</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a><span class="sd">    - KeyboardInterrupt: Graceful shutdown with cleanup</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a><span class="sd">    - Other Exceptions: Logged and agent stopped with cleanup</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a><span class="sd">    </span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a><span class="sd">    Args:</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a><span class="sd">        None: Entry function with no parameters</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a><span class="sd">    </span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a><span class="sd">    Returns:</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a><span class="sd">        None: Async coroutine, called via spade.run()</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a><span class="sd">    </span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a><span class="sd">    Usage:</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a><span class="sd">        Run via: python world_agent.py</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a><span class="sd">        Stop via: Press Ctrl+C in terminal</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a><span class="sd">    </span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a><span class="sd">    Note:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a><span class="sd">        This function is called by spade.run() which manages the asyncio event loop</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Starting SPADE WorldAgent ---&quot;</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>    
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>    <span class="c1"># Create and start the WorldAgent</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>    <span class="c1"># NOTE: Change credentials and server as needed</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>    <span class="n">world_agent</span> <span class="o">=</span> <span class="n">WorldAgent</span><span class="p">(</span><span class="s2">&quot;world@localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>    
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>        <span class="k">await</span> <span class="n">world_agent</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WorldAgent started successfully!&quot;</span><span class="p">)</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>        
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>        <span class="c1"># Keep the agent running</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>            
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Stopping WorldAgent ---&quot;</span><span class="p">)</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>        <span class="k">await</span> <span class="n">world_agent</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>        <span class="k">await</span> <span class="n">world_agent</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>    <span class="c1"># Run the WorldAgent</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>    <span class="c1"># Ensure you have an XMPP server running on localhost</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>    <span class="n">spade</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- SPADE WorldAgent Finished ---&quot;</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="WorldAgent">
                            <input id="WorldAgent-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">WorldAgent</span><wbr>(<span class="base">spade.agent.Agent</span>):

                <label class="view-source-button" for="WorldAgent-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorldAgent"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorldAgent-13"><a href="#WorldAgent-13"><span class="linenos"> 13</span></a><span class="k">class</span><span class="w"> </span><span class="nc">WorldAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
</span><span id="WorldAgent-14"><a href="#WorldAgent-14"><span class="linenos"> 14</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A SPADE agent that manages and simulates the supply chain world.</span>
</span><span id="WorldAgent-15"><a href="#WorldAgent-15"><span class="linenos"> 15</span></a><span class="sd">    </span>
</span><span id="WorldAgent-16"><a href="#WorldAgent-16"><span class="linenos"> 16</span></a><span class="sd">    This agent serves as the central coordinator for the supply chain simulation,</span>
</span><span id="WorldAgent-17"><a href="#WorldAgent-17"><span class="linenos"> 17</span></a><span class="sd">    managing the world state, executing simulation ticks, and handling communication</span>
</span><span id="WorldAgent-18"><a href="#WorldAgent-18"><span class="linenos"> 18</span></a><span class="sd">    with other agents (Store, Warehouse, Supplier, and Event agents). It implements</span>
</span><span id="WorldAgent-19"><a href="#WorldAgent-19"><span class="linenos"> 19</span></a><span class="sd">    the FIPA Agent Management Specification for agent discovery and coordination.</span>
</span><span id="WorldAgent-20"><a href="#WorldAgent-20"><span class="linenos"> 20</span></a><span class="sd">    </span>
</span><span id="WorldAgent-21"><a href="#WorldAgent-21"><span class="linenos"> 21</span></a><span class="sd">    The WorldAgent acts as a service provider, offering query services for world</span>
</span><span id="WorldAgent-22"><a href="#WorldAgent-22"><span class="linenos"> 22</span></a><span class="sd">    state information and event simulation. It follows FIPA protocols for:</span>
</span><span id="WorldAgent-23"><a href="#WorldAgent-23"><span class="linenos"> 23</span></a><span class="sd">    - Request/Response interactions (for time-delta and traffic simulations)</span>
</span><span id="WorldAgent-24"><a href="#WorldAgent-24"><span class="linenos"> 24</span></a><span class="sd">    - Inform interactions (for world state broadcasts and query responses)</span>
</span><span id="WorldAgent-25"><a href="#WorldAgent-25"><span class="linenos"> 25</span></a><span class="sd">    </span>
</span><span id="WorldAgent-26"><a href="#WorldAgent-26"><span class="linenos"> 26</span></a><span class="sd">    Attributes:</span>
</span><span id="WorldAgent-27"><a href="#WorldAgent-27"><span class="linenos"> 27</span></a><span class="sd">        world (World): The World instance containing the graph structure and</span>
</span><span id="WorldAgent-28"><a href="#WorldAgent-28"><span class="linenos"> 28</span></a><span class="sd">            simulation state (nodes, edges, facilities, etc.).</span>
</span><span id="WorldAgent-29"><a href="#WorldAgent-29"><span class="linenos"> 29</span></a><span class="sd">        subscribers (list): A list of agent JIDs subscribed to world state updates.</span>
</span><span id="WorldAgent-30"><a href="#WorldAgent-30"><span class="linenos"> 30</span></a><span class="sd">        tick_interval (float): Time in seconds between consecutive world ticks.</span>
</span><span id="WorldAgent-31"><a href="#WorldAgent-31"><span class="linenos"> 31</span></a><span class="sd">    </span>
</span><span id="WorldAgent-32"><a href="#WorldAgent-32"><span class="linenos"> 32</span></a><span class="sd">    Responsibilities:</span>
</span><span id="WorldAgent-33"><a href="#WorldAgent-33"><span class="linenos"> 33</span></a><span class="sd">        - Manage and maintain the world state and simulation progress</span>
</span><span id="WorldAgent-34"><a href="#WorldAgent-34"><span class="linenos"> 34</span></a><span class="sd">        - Execute world ticks at regular intervals and simulate time progression</span>
</span><span id="WorldAgent-35"><a href="#WorldAgent-35"><span class="linenos"> 35</span></a><span class="sd">        - Handle traffic dynamics and traffic simulation requests from Event agents</span>
</span><span id="WorldAgent-36"><a href="#WorldAgent-36"><span class="linenos"> 36</span></a><span class="sd">        - Respond to queries from other agents about world state (nodes, edges, facilities)</span>
</span><span id="WorldAgent-37"><a href="#WorldAgent-37"><span class="linenos"> 37</span></a><span class="sd">        - Broadcast world state updates to subscribed agents</span>
</span><span id="WorldAgent-38"><a href="#WorldAgent-38"><span class="linenos"> 38</span></a><span class="sd">        - Coordinate time-delta simulations with configurable duration</span>
</span><span id="WorldAgent-39"><a href="#WorldAgent-39"><span class="linenos"> 39</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="WorldAgent-40"><a href="#WorldAgent-40"><span class="linenos"> 40</span></a>    
</span><span id="WorldAgent-41"><a href="#WorldAgent-41"><span class="linenos"> 41</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">world</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="WorldAgent-42"><a href="#WorldAgent-42"><span class="linenos"> 42</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the WorldAgent.</span>
</span><span id="WorldAgent-43"><a href="#WorldAgent-43"><span class="linenos"> 43</span></a><span class="sd">        </span>
</span><span id="WorldAgent-44"><a href="#WorldAgent-44"><span class="linenos"> 44</span></a><span class="sd">        Creates a new WorldAgent instance and optionally associates it with a World</span>
</span><span id="WorldAgent-45"><a href="#WorldAgent-45"><span class="linenos"> 45</span></a><span class="sd">        object. The agent initializes with empty subscriber list and default</span>
</span><span id="WorldAgent-46"><a href="#WorldAgent-46"><span class="linenos"> 46</span></a><span class="sd">        tick interval. If no world is provided, it must be set before the agent</span>
</span><span id="WorldAgent-47"><a href="#WorldAgent-47"><span class="linenos"> 47</span></a><span class="sd">        is fully operational.</span>
</span><span id="WorldAgent-48"><a href="#WorldAgent-48"><span class="linenos"> 48</span></a><span class="sd">        </span>
</span><span id="WorldAgent-49"><a href="#WorldAgent-49"><span class="linenos"> 49</span></a><span class="sd">        Args:</span>
</span><span id="WorldAgent-50"><a href="#WorldAgent-50"><span class="linenos"> 50</span></a><span class="sd">            jid (str): The Jabber ID (JID) for this agent on the XMPP server.</span>
</span><span id="WorldAgent-51"><a href="#WorldAgent-51"><span class="linenos"> 51</span></a><span class="sd">                Format: &#39;agent_name@server_address&#39;</span>
</span><span id="WorldAgent-52"><a href="#WorldAgent-52"><span class="linenos"> 52</span></a><span class="sd">            password (str): The authentication password for the agent on the XMPP server.</span>
</span><span id="WorldAgent-53"><a href="#WorldAgent-53"><span class="linenos"> 53</span></a><span class="sd">            world (World, optional): A pre-initialized World instance containing</span>
</span><span id="WorldAgent-54"><a href="#WorldAgent-54"><span class="linenos"> 54</span></a><span class="sd">                the simulation graph and state. If None, must be assigned before</span>
</span><span id="WorldAgent-55"><a href="#WorldAgent-55"><span class="linenos"> 55</span></a><span class="sd">                the agent starts handling simulation requests. Defaults to None.</span>
</span><span id="WorldAgent-56"><a href="#WorldAgent-56"><span class="linenos"> 56</span></a><span class="sd">        </span>
</span><span id="WorldAgent-57"><a href="#WorldAgent-57"><span class="linenos"> 57</span></a><span class="sd">        Returns:</span>
</span><span id="WorldAgent-58"><a href="#WorldAgent-58"><span class="linenos"> 58</span></a><span class="sd">            None: Constructor initializes the parent Agent class and stores references.</span>
</span><span id="WorldAgent-59"><a href="#WorldAgent-59"><span class="linenos"> 59</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorldAgent-60"><a href="#WorldAgent-60"><span class="linenos"> 60</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
</span><span id="WorldAgent-61"><a href="#WorldAgent-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">world</span>
</span><span id="WorldAgent-62"><a href="#WorldAgent-62"><span class="linenos"> 62</span></a>
</span><span id="WorldAgent-63"><a href="#WorldAgent-63"><span class="linenos"> 63</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">TimeDeltaBehaviour</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="WorldAgent-64"><a href="#WorldAgent-64"><span class="linenos"> 64</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles time-delta simulation requests and traffic simulation requests.</span>
</span><span id="WorldAgent-65"><a href="#WorldAgent-65"><span class="linenos"> 65</span></a><span class="sd">        </span>
</span><span id="WorldAgent-66"><a href="#WorldAgent-66"><span class="linenos"> 66</span></a><span class="sd">        This behaviour implements FIPA Request/Response protocol for handling two types</span>
</span><span id="WorldAgent-67"><a href="#WorldAgent-67"><span class="linenos"> 67</span></a><span class="sd">        of simulation requests from other agents:</span>
</span><span id="WorldAgent-68"><a href="#WorldAgent-68"><span class="linenos"> 68</span></a><span class="sd">        </span>
</span><span id="WorldAgent-69"><a href="#WorldAgent-69"><span class="linenos"> 69</span></a><span class="sd">        1. Traffic Simulation Requests: Receive requests from Event agents to simulate</span>
</span><span id="WorldAgent-70"><a href="#WorldAgent-70"><span class="linenos"> 70</span></a><span class="sd">           traffic dynamics. Processes &quot;simulate_traffic&quot; action requests, runs the</span>
</span><span id="WorldAgent-71"><a href="#WorldAgent-71"><span class="linenos"> 71</span></a><span class="sd">           simulation for the specified duration, and returns generated traffic events.</span>
</span><span id="WorldAgent-72"><a href="#WorldAgent-72"><span class="linenos"> 72</span></a><span class="sd">        </span>
</span><span id="WorldAgent-73"><a href="#WorldAgent-73"><span class="linenos"> 73</span></a><span class="sd">        2. Time-Delta Requests: Receive requests to advance the simulation by a</span>
</span><span id="WorldAgent-74"><a href="#WorldAgent-74"><span class="linenos"> 74</span></a><span class="sd">           specified number of ticks. Tracks edge weight changes (travel times and</span>
</span><span id="WorldAgent-75"><a href="#WorldAgent-75"><span class="linenos"> 75</span></a><span class="sd">           fuel consumption) during the simulation period and returns detailed</span>
</span><span id="WorldAgent-76"><a href="#WorldAgent-76"><span class="linenos"> 76</span></a><span class="sd">           information about which edges changed and when.</span>
</span><span id="WorldAgent-77"><a href="#WorldAgent-77"><span class="linenos"> 77</span></a><span class="sd">        </span>
</span><span id="WorldAgent-78"><a href="#WorldAgent-78"><span class="linenos"> 78</span></a><span class="sd">        FIPA Protocol Compliance:</span>
</span><span id="WorldAgent-79"><a href="#WorldAgent-79"><span class="linenos"> 79</span></a><span class="sd">        - Implements the FIPA Request interaction protocol</span>
</span><span id="WorldAgent-80"><a href="#WorldAgent-80"><span class="linenos"> 80</span></a><span class="sd">        - Receives REQUEST messages with performative=&quot;request&quot;</span>
</span><span id="WorldAgent-81"><a href="#WorldAgent-81"><span class="linenos"> 81</span></a><span class="sd">        - Sends back INFORM messages with performative=&quot;inform&quot;</span>
</span><span id="WorldAgent-82"><a href="#WorldAgent-82"><span class="linenos"> 82</span></a><span class="sd">        - Gracefully handles protocol violations with JSON decode errors</span>
</span><span id="WorldAgent-83"><a href="#WorldAgent-83"><span class="linenos"> 83</span></a><span class="sd">        </span>
</span><span id="WorldAgent-84"><a href="#WorldAgent-84"><span class="linenos"> 84</span></a><span class="sd">        This behaviour runs cyclically (continuously) checking for incoming messages</span>
</span><span id="WorldAgent-85"><a href="#WorldAgent-85"><span class="linenos"> 85</span></a><span class="sd">        with a timeout to prevent blocking the agent&#39;s other behaviours.</span>
</span><span id="WorldAgent-86"><a href="#WorldAgent-86"><span class="linenos"> 86</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorldAgent-87"><a href="#WorldAgent-87"><span class="linenos"> 87</span></a>        
</span><span id="WorldAgent-88"><a href="#WorldAgent-88"><span class="linenos"> 88</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorldAgent-89"><a href="#WorldAgent-89"><span class="linenos"> 89</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Process time-delta messages and simulate world.</span>
</span><span id="WorldAgent-90"><a href="#WorldAgent-90"><span class="linenos"> 90</span></a><span class="sd">            </span>
</span><span id="WorldAgent-91"><a href="#WorldAgent-91"><span class="linenos"> 91</span></a><span class="sd">            Executes one iteration of the cyclic behaviour. This method:</span>
</span><span id="WorldAgent-92"><a href="#WorldAgent-92"><span class="linenos"> 92</span></a><span class="sd">            1. Waits for incoming messages with a 1-second timeout</span>
</span><span id="WorldAgent-93"><a href="#WorldAgent-93"><span class="linenos"> 93</span></a><span class="sd">            2. If a message is received, parses its JSON content</span>
</span><span id="WorldAgent-94"><a href="#WorldAgent-94"><span class="linenos"> 94</span></a><span class="sd">            3. Identifies the message type (traffic simulation or time-delta)</span>
</span><span id="WorldAgent-95"><a href="#WorldAgent-95"><span class="linenos"> 95</span></a><span class="sd">            4. Routes to appropriate handler based on action metadata</span>
</span><span id="WorldAgent-96"><a href="#WorldAgent-96"><span class="linenos"> 96</span></a><span class="sd">            5. Sends response back to sender with simulation results</span>
</span><span id="WorldAgent-97"><a href="#WorldAgent-97"><span class="linenos"> 97</span></a><span class="sd">            6. Handles exceptions gracefully, logging errors</span>
</span><span id="WorldAgent-98"><a href="#WorldAgent-98"><span class="linenos"> 98</span></a><span class="sd">            </span>
</span><span id="WorldAgent-99"><a href="#WorldAgent-99"><span class="linenos"> 99</span></a><span class="sd">            The method operates on two distinct message types:</span>
</span><span id="WorldAgent-100"><a href="#WorldAgent-100"><span class="linenos">100</span></a><span class="sd">            - Traffic Simulation: Calls world.get_events() to simulate traffic</span>
</span><span id="WorldAgent-101"><a href="#WorldAgent-101"><span class="linenos">101</span></a><span class="sd">            - Time-Delta: Simulates multiple ticks and tracks edge state changes</span>
</span><span id="WorldAgent-102"><a href="#WorldAgent-102"><span class="linenos">102</span></a><span class="sd">            </span>
</span><span id="WorldAgent-103"><a href="#WorldAgent-103"><span class="linenos">103</span></a><span class="sd">            For time-delta requests, the behaviour:</span>
</span><span id="WorldAgent-104"><a href="#WorldAgent-104"><span class="linenos">104</span></a><span class="sd">            - Records initial edge weights before simulation</span>
</span><span id="WorldAgent-105"><a href="#WorldAgent-105"><span class="linenos">105</span></a><span class="sd">            - Executes the requested number of ticks sequentially</span>
</span><span id="WorldAgent-106"><a href="#WorldAgent-106"><span class="linenos">106</span></a><span class="sd">            - For each edge that changes, calculates fuel consumption</span>
</span><span id="WorldAgent-107"><a href="#WorldAgent-107"><span class="linenos">107</span></a><span class="sd">            - Tracks the tick index where each change occurred</span>
</span><span id="WorldAgent-108"><a href="#WorldAgent-108"><span class="linenos">108</span></a><span class="sd">            - Returns complete change history to the requester</span>
</span><span id="WorldAgent-109"><a href="#WorldAgent-109"><span class="linenos">109</span></a><span class="sd">            </span>
</span><span id="WorldAgent-110"><a href="#WorldAgent-110"><span class="linenos">110</span></a><span class="sd">            Raises:</span>
</span><span id="WorldAgent-111"><a href="#WorldAgent-111"><span class="linenos">111</span></a><span class="sd">                json.JSONDecodeError: If message body is invalid JSON (logged, not raised)</span>
</span><span id="WorldAgent-112"><a href="#WorldAgent-112"><span class="linenos">112</span></a><span class="sd">                Exception: Any other runtime error (logged, not raised)</span>
</span><span id="WorldAgent-113"><a href="#WorldAgent-113"><span class="linenos">113</span></a><span class="sd">            </span>
</span><span id="WorldAgent-114"><a href="#WorldAgent-114"><span class="linenos">114</span></a><span class="sd">            Yields:</span>
</span><span id="WorldAgent-115"><a href="#WorldAgent-115"><span class="linenos">115</span></a><span class="sd">                None: This cyclic behaviour continues indefinitely</span>
</span><span id="WorldAgent-116"><a href="#WorldAgent-116"><span class="linenos">116</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent-117"><a href="#WorldAgent-117"><span class="linenos">117</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="WorldAgent-118"><a href="#WorldAgent-118"><span class="linenos">118</span></a>            
</span><span id="WorldAgent-119"><a href="#WorldAgent-119"><span class="linenos">119</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="WorldAgent-120"><a href="#WorldAgent-120"><span class="linenos">120</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="WorldAgent-121"><a href="#WorldAgent-121"><span class="linenos">121</span></a>                    <span class="c1"># Check if it&#39;s a traffic simulation request from event agent</span>
</span><span id="WorldAgent-122"><a href="#WorldAgent-122"><span class="linenos">122</span></a>                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;request&quot;</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;simulate_traffic&quot;</span><span class="p">:</span>
</span><span id="WorldAgent-123"><a href="#WorldAgent-123"><span class="linenos">123</span></a>                        <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent-124"><a href="#WorldAgent-124"><span class="linenos">124</span></a>                        <span class="n">simulation_time</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simulation_time&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="WorldAgent-125"><a href="#WorldAgent-125"><span class="linenos">125</span></a>                        <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-126"><a href="#WorldAgent-126"><span class="linenos">126</span></a>                        
</span><span id="WorldAgent-127"><a href="#WorldAgent-127"><span class="linenos">127</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Traffic simulation request received&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-128"><a href="#WorldAgent-128"><span class="linenos">128</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sender: </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-129"><a href="#WorldAgent-129"><span class="linenos">129</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Simulation time: </span><span class="si">{</span><span class="n">simulation_time</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-130"><a href="#WorldAgent-130"><span class="linenos">130</span></a>                        
</span><span id="WorldAgent-131"><a href="#WorldAgent-131"><span class="linenos">131</span></a>                        <span class="c1"># Simulate traffic events using get_events</span>
</span><span id="WorldAgent-132"><a href="#WorldAgent-132"><span class="linenos">132</span></a>                        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">simulation_time</span><span class="p">))</span>
</span><span id="WorldAgent-133"><a href="#WorldAgent-133"><span class="linenos">133</span></a>                        
</span><span id="WorldAgent-134"><a href="#WorldAgent-134"><span class="linenos">134</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Simulation completed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="si">}</span><span class="s2"> events generated&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-135"><a href="#WorldAgent-135"><span class="linenos">135</span></a>                        
</span><span id="WorldAgent-136"><a href="#WorldAgent-136"><span class="linenos">136</span></a>                        <span class="c1"># Send response with traffic events (FIPA Inform)</span>
</span><span id="WorldAgent-137"><a href="#WorldAgent-137"><span class="linenos">137</span></a>                        <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-138"><a href="#WorldAgent-138"><span class="linenos">138</span></a>                        <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-139"><a href="#WorldAgent-139"><span class="linenos">139</span></a>                        <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;traffic_events&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-140"><a href="#WorldAgent-140"><span class="linenos">140</span></a>                        <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent-141"><a href="#WorldAgent-141"><span class="linenos">141</span></a>                            <span class="s2">&quot;events&quot;</span><span class="p">:</span> <span class="n">events</span><span class="p">,</span>
</span><span id="WorldAgent-142"><a href="#WorldAgent-142"><span class="linenos">142</span></a>                            <span class="s2">&quot;simulation_time&quot;</span><span class="p">:</span> <span class="n">simulation_time</span>
</span><span id="WorldAgent-143"><a href="#WorldAgent-143"><span class="linenos">143</span></a>                        <span class="p">})</span>
</span><span id="WorldAgent-144"><a href="#WorldAgent-144"><span class="linenos">144</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent-145"><a href="#WorldAgent-145"><span class="linenos">145</span></a>                        
</span><span id="WorldAgent-146"><a href="#WorldAgent-146"><span class="linenos">146</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Traffic events sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-147"><a href="#WorldAgent-147"><span class="linenos">147</span></a>                        <span class="k">return</span>
</span><span id="WorldAgent-148"><a href="#WorldAgent-148"><span class="linenos">148</span></a>                    
</span><span id="WorldAgent-149"><a href="#WorldAgent-149"><span class="linenos">149</span></a>                    <span class="c1"># Handle normal time-delta requests (FIPA Request/Response pattern)</span>
</span><span id="WorldAgent-150"><a href="#WorldAgent-150"><span class="linenos">150</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent-151"><a href="#WorldAgent-151"><span class="linenos">151</span></a>                    <span class="n">delta_time</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delta_time&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="WorldAgent-152"><a href="#WorldAgent-152"><span class="linenos">152</span></a>                    <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-153"><a href="#WorldAgent-153"><span class="linenos">153</span></a>                    
</span><span id="WorldAgent-154"><a href="#WorldAgent-154"><span class="linenos">154</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Received time-delta request: </span><span class="si">{</span><span class="n">delta_time</span><span class="si">}</span><span class="s2"> ticks from </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-155"><a href="#WorldAgent-155"><span class="linenos">155</span></a>                    
</span><span id="WorldAgent-156"><a href="#WorldAgent-156"><span class="linenos">156</span></a>                    <span class="c1"># Store initial edge states for change detection</span>
</span><span id="WorldAgent-157"><a href="#WorldAgent-157"><span class="linenos">157</span></a>                    <span class="n">initial_states</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="WorldAgent-158"><a href="#WorldAgent-158"><span class="linenos">158</span></a>                    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="WorldAgent-159"><a href="#WorldAgent-159"><span class="linenos">159</span></a>                        <span class="n">initial_states</span><span class="p">[(</span><span class="n">edge</span><span class="o">.</span><span class="n">node1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span>
</span><span id="WorldAgent-160"><a href="#WorldAgent-160"><span class="linenos">160</span></a>                    
</span><span id="WorldAgent-161"><a href="#WorldAgent-161"><span class="linenos">161</span></a>                    <span class="c1"># Simulate delta_time ticks and track changes</span>
</span><span id="WorldAgent-162"><a href="#WorldAgent-162"><span class="linenos">162</span></a>                    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="WorldAgent-163"><a href="#WorldAgent-163"><span class="linenos">163</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">delta_time</span><span class="p">):</span>
</span><span id="WorldAgent-164"><a href="#WorldAgent-164"><span class="linenos">164</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Simulate one tick at a time</span>
</span><span id="WorldAgent-165"><a href="#WorldAgent-165"><span class="linenos">165</span></a>                        <span class="n">current_tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span>
</span><span id="WorldAgent-166"><a href="#WorldAgent-166"><span class="linenos">166</span></a>                        
</span><span id="WorldAgent-167"><a href="#WorldAgent-167"><span class="linenos">167</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Simulated tick </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">delta_time</span><span class="si">}</span><span class="s2"> (current tick: </span><span class="si">{</span><span class="n">current_tick</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-168"><a href="#WorldAgent-168"><span class="linenos">168</span></a>                        
</span><span id="WorldAgent-169"><a href="#WorldAgent-169"><span class="linenos">169</span></a>                        <span class="c1"># Check which edges changed in this tick</span>
</span><span id="WorldAgent-170"><a href="#WorldAgent-170"><span class="linenos">170</span></a>                        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="WorldAgent-171"><a href="#WorldAgent-171"><span class="linenos">171</span></a>                            <span class="n">edge_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">node1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="WorldAgent-172"><a href="#WorldAgent-172"><span class="linenos">172</span></a>                            <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">!=</span> <span class="n">initial_states</span><span class="p">[</span><span class="n">edge_key</span><span class="p">]:</span>
</span><span id="WorldAgent-173"><a href="#WorldAgent-173"><span class="linenos">173</span></a>                                <span class="c1"># Edge changed - record the instant (tick index)</span>
</span><span id="WorldAgent-174"><a href="#WorldAgent-174"><span class="linenos">174</span></a>                                <span class="n">edge</span><span class="o">.</span><span class="n">calculate_fuel_consumption</span><span class="p">()</span>
</span><span id="WorldAgent-175"><a href="#WorldAgent-175"><span class="linenos">175</span></a>                                <span class="n">edge_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="WorldAgent-176"><a href="#WorldAgent-176"><span class="linenos">176</span></a>                                    <span class="s2">&quot;node1_id&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">node1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="WorldAgent-177"><a href="#WorldAgent-177"><span class="linenos">177</span></a>                                    <span class="s2">&quot;node2_id&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="WorldAgent-178"><a href="#WorldAgent-178"><span class="linenos">178</span></a>                                    <span class="s2">&quot;new_time&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
</span><span id="WorldAgent-179"><a href="#WorldAgent-179"><span class="linenos">179</span></a>                                    <span class="s2">&quot;new_fuel_consumption&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">fuel_consumption</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="WorldAgent-180"><a href="#WorldAgent-180"><span class="linenos">180</span></a>                                    <span class="s2">&quot;instant&quot;</span><span class="p">:</span> <span class="n">i</span>  <span class="c1"># The tick index when it changed</span>
</span><span id="WorldAgent-181"><a href="#WorldAgent-181"><span class="linenos">181</span></a>                                <span class="p">}</span>
</span><span id="WorldAgent-182"><a href="#WorldAgent-182"><span class="linenos">182</span></a>                                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_info</span><span class="p">)</span>
</span><span id="WorldAgent-183"><a href="#WorldAgent-183"><span class="linenos">183</span></a>                                <span class="c1"># Update the initial state to current state</span>
</span><span id="WorldAgent-184"><a href="#WorldAgent-184"><span class="linenos">184</span></a>                                <span class="n">initial_states</span><span class="p">[</span><span class="n">edge_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span>
</span><span id="WorldAgent-185"><a href="#WorldAgent-185"><span class="linenos">185</span></a>                    
</span><span id="WorldAgent-186"><a href="#WorldAgent-186"><span class="linenos">186</span></a>                    <span class="c1"># Send response with all edge states (FIPA Inform)</span>
</span><span id="WorldAgent-187"><a href="#WorldAgent-187"><span class="linenos">187</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-188"><a href="#WorldAgent-188"><span class="linenos">188</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-189"><a href="#WorldAgent-189"><span class="linenos">189</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent-190"><a href="#WorldAgent-190"><span class="linenos">190</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;time_delta_response&quot;</span><span class="p">,</span>
</span><span id="WorldAgent-191"><a href="#WorldAgent-191"><span class="linenos">191</span></a>                        <span class="s2">&quot;delta_time&quot;</span><span class="p">:</span> <span class="n">delta_time</span><span class="p">,</span>
</span><span id="WorldAgent-192"><a href="#WorldAgent-192"><span class="linenos">192</span></a>                        <span class="s2">&quot;final_tick&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span><span class="p">,</span>
</span><span id="WorldAgent-193"><a href="#WorldAgent-193"><span class="linenos">193</span></a>                        <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="n">results</span>
</span><span id="WorldAgent-194"><a href="#WorldAgent-194"><span class="linenos">194</span></a>                    <span class="p">})</span>
</span><span id="WorldAgent-195"><a href="#WorldAgent-195"><span class="linenos">195</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent-196"><a href="#WorldAgent-196"><span class="linenos">196</span></a>                    
</span><span id="WorldAgent-197"><a href="#WorldAgent-197"><span class="linenos">197</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Sent time-delta response with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> edge updates&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-198"><a href="#WorldAgent-198"><span class="linenos">198</span></a>                    
</span><span id="WorldAgent-199"><a href="#WorldAgent-199"><span class="linenos">199</span></a>                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent-200"><a href="#WorldAgent-200"><span class="linenos">200</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error decoding time-delta message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-201"><a href="#WorldAgent-201"><span class="linenos">201</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent-202"><a href="#WorldAgent-202"><span class="linenos">202</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error in TimeDeltaBehaviour: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-203"><a href="#WorldAgent-203"><span class="linenos">203</span></a>
</span><span id="WorldAgent-204"><a href="#WorldAgent-204"><span class="linenos">204</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">MessageHandlerBehaviour</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="WorldAgent-205"><a href="#WorldAgent-205"><span class="linenos">205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles incoming messages from other agents.</span>
</span><span id="WorldAgent-206"><a href="#WorldAgent-206"><span class="linenos">206</span></a><span class="sd">        </span>
</span><span id="WorldAgent-207"><a href="#WorldAgent-207"><span class="linenos">207</span></a><span class="sd">        This behaviour processes all general query and subscription messages from</span>
</span><span id="WorldAgent-208"><a href="#WorldAgent-208"><span class="linenos">208</span></a><span class="sd">        other agents in the supply chain system. It operates as a message dispatcher,</span>
</span><span id="WorldAgent-209"><a href="#WorldAgent-209"><span class="linenos">209</span></a><span class="sd">        routing incoming messages to specialized handler methods based on the</span>
</span><span id="WorldAgent-210"><a href="#WorldAgent-210"><span class="linenos">210</span></a><span class="sd">        message type field.</span>
</span><span id="WorldAgent-211"><a href="#WorldAgent-211"><span class="linenos">211</span></a><span class="sd">        </span>
</span><span id="WorldAgent-212"><a href="#WorldAgent-212"><span class="linenos">212</span></a><span class="sd">        Supported message types and their handlers:</span>
</span><span id="WorldAgent-213"><a href="#WorldAgent-213"><span class="linenos">213</span></a><span class="sd">        - &quot;query_world_state&quot;: Returns complete world simulation state</span>
</span><span id="WorldAgent-214"><a href="#WorldAgent-214"><span class="linenos">214</span></a><span class="sd">        - &quot;query_node_info&quot;: Returns information about a specific graph node</span>
</span><span id="WorldAgent-215"><a href="#WorldAgent-215"><span class="linenos">215</span></a><span class="sd">        - &quot;query_edge_info&quot;: Returns information about a specific edge</span>
</span><span id="WorldAgent-216"><a href="#WorldAgent-216"><span class="linenos">216</span></a><span class="sd">        - &quot;query_facilities&quot;: Returns locations of all supply chain facilities</span>
</span><span id="WorldAgent-217"><a href="#WorldAgent-217"><span class="linenos">217</span></a><span class="sd">        - &quot;subscribe&quot;: Registers an agent for periodic world state updates</span>
</span><span id="WorldAgent-218"><a href="#WorldAgent-218"><span class="linenos">218</span></a><span class="sd">        </span>
</span><span id="WorldAgent-219"><a href="#WorldAgent-219"><span class="linenos">219</span></a><span class="sd">        FIPA Protocol Compliance:</span>
</span><span id="WorldAgent-220"><a href="#WorldAgent-220"><span class="linenos">220</span></a><span class="sd">        - Processes messages from agents following FIPA protocols</span>
</span><span id="WorldAgent-221"><a href="#WorldAgent-221"><span class="linenos">221</span></a><span class="sd">        - Sends INFORM messages (performative=&quot;inform&quot;) for successful queries</span>
</span><span id="WorldAgent-222"><a href="#WorldAgent-222"><span class="linenos">222</span></a><span class="sd">        - Returns ERROR messages for queries that fail or have invalid parameters</span>
</span><span id="WorldAgent-223"><a href="#WorldAgent-223"><span class="linenos">223</span></a><span class="sd">        - Handles SUBSCRIBE messages for publish/subscribe pattern coordination</span>
</span><span id="WorldAgent-224"><a href="#WorldAgent-224"><span class="linenos">224</span></a><span class="sd">        </span>
</span><span id="WorldAgent-225"><a href="#WorldAgent-225"><span class="linenos">225</span></a><span class="sd">        Message Flow:</span>
</span><span id="WorldAgent-226"><a href="#WorldAgent-226"><span class="linenos">226</span></a><span class="sd">        1. Receives a message with JSON body containing &quot;type&quot; field</span>
</span><span id="WorldAgent-227"><a href="#WorldAgent-227"><span class="linenos">227</span></a><span class="sd">        2. Validates JSON structure and extracts message type</span>
</span><span id="WorldAgent-228"><a href="#WorldAgent-228"><span class="linenos">228</span></a><span class="sd">        3. Routes to appropriate private handler method (_handle_*)</span>
</span><span id="WorldAgent-229"><a href="#WorldAgent-229"><span class="linenos">229</span></a><span class="sd">        4. Handler method constructs response with agent&#39;s data</span>
</span><span id="WorldAgent-230"><a href="#WorldAgent-230"><span class="linenos">230</span></a><span class="sd">        5. Response sent back to originating agent</span>
</span><span id="WorldAgent-231"><a href="#WorldAgent-231"><span class="linenos">231</span></a><span class="sd">        </span>
</span><span id="WorldAgent-232"><a href="#WorldAgent-232"><span class="linenos">232</span></a><span class="sd">        Error Handling:</span>
</span><span id="WorldAgent-233"><a href="#WorldAgent-233"><span class="linenos">233</span></a><span class="sd">        - JSON decode errors are logged and ignored</span>
</span><span id="WorldAgent-234"><a href="#WorldAgent-234"><span class="linenos">234</span></a><span class="sd">        - Unknown message types are logged with diagnostic info</span>
</span><span id="WorldAgent-235"><a href="#WorldAgent-235"><span class="linenos">235</span></a><span class="sd">        - Handler exceptions are caught and logged</span>
</span><span id="WorldAgent-236"><a href="#WorldAgent-236"><span class="linenos">236</span></a><span class="sd">        </span>
</span><span id="WorldAgent-237"><a href="#WorldAgent-237"><span class="linenos">237</span></a><span class="sd">        This behaviour runs cyclically with a 1-second timeout between iterations.</span>
</span><span id="WorldAgent-238"><a href="#WorldAgent-238"><span class="linenos">238</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorldAgent-239"><a href="#WorldAgent-239"><span class="linenos">239</span></a>        
</span><span id="WorldAgent-240"><a href="#WorldAgent-240"><span class="linenos">240</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorldAgent-241"><a href="#WorldAgent-241"><span class="linenos">241</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Process incoming messages.</span>
</span><span id="WorldAgent-242"><a href="#WorldAgent-242"><span class="linenos">242</span></a><span class="sd">            </span>
</span><span id="WorldAgent-243"><a href="#WorldAgent-243"><span class="linenos">243</span></a><span class="sd">            Executes one iteration of the cyclic message handling. This method:</span>
</span><span id="WorldAgent-244"><a href="#WorldAgent-244"><span class="linenos">244</span></a><span class="sd">            1. Waits up to 1 second for an incoming message</span>
</span><span id="WorldAgent-245"><a href="#WorldAgent-245"><span class="linenos">245</span></a><span class="sd">            2. If no message arrives within timeout, cycles immediately</span>
</span><span id="WorldAgent-246"><a href="#WorldAgent-246"><span class="linenos">246</span></a><span class="sd">            3. If a message arrives, attempts to parse it as JSON</span>
</span><span id="WorldAgent-247"><a href="#WorldAgent-247"><span class="linenos">247</span></a><span class="sd">            4. Extracts the &quot;type&quot; field to determine message category</span>
</span><span id="WorldAgent-248"><a href="#WorldAgent-248"><span class="linenos">248</span></a><span class="sd">            5. Dispatches to the appropriate handler coroutine</span>
</span><span id="WorldAgent-249"><a href="#WorldAgent-249"><span class="linenos">249</span></a><span class="sd">            6. Catches and logs any JSON or handler exceptions</span>
</span><span id="WorldAgent-250"><a href="#WorldAgent-250"><span class="linenos">250</span></a><span class="sd">            </span>
</span><span id="WorldAgent-251"><a href="#WorldAgent-251"><span class="linenos">251</span></a><span class="sd">            The dispatcher pattern allows different message types to be handled</span>
</span><span id="WorldAgent-252"><a href="#WorldAgent-252"><span class="linenos">252</span></a><span class="sd">            by specialized methods, keeping this method focused on high-level</span>
</span><span id="WorldAgent-253"><a href="#WorldAgent-253"><span class="linenos">253</span></a><span class="sd">            message routing and error handling.</span>
</span><span id="WorldAgent-254"><a href="#WorldAgent-254"><span class="linenos">254</span></a><span class="sd">            </span>
</span><span id="WorldAgent-255"><a href="#WorldAgent-255"><span class="linenos">255</span></a><span class="sd">            Raises:</span>
</span><span id="WorldAgent-256"><a href="#WorldAgent-256"><span class="linenos">256</span></a><span class="sd">                json.JSONDecodeError: If msg.body is not valid JSON (caught, logged)</span>
</span><span id="WorldAgent-257"><a href="#WorldAgent-257"><span class="linenos">257</span></a><span class="sd">                Exception: Any handler exception (caught, logged)</span>
</span><span id="WorldAgent-258"><a href="#WorldAgent-258"><span class="linenos">258</span></a><span class="sd">            </span>
</span><span id="WorldAgent-259"><a href="#WorldAgent-259"><span class="linenos">259</span></a><span class="sd">            Yields:</span>
</span><span id="WorldAgent-260"><a href="#WorldAgent-260"><span class="linenos">260</span></a><span class="sd">                None: Continues indefinitely as a cyclic behaviour</span>
</span><span id="WorldAgent-261"><a href="#WorldAgent-261"><span class="linenos">261</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent-262"><a href="#WorldAgent-262"><span class="linenos">262</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="WorldAgent-263"><a href="#WorldAgent-263"><span class="linenos">263</span></a>            
</span><span id="WorldAgent-264"><a href="#WorldAgent-264"><span class="linenos">264</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="WorldAgent-265"><a href="#WorldAgent-265"><span class="linenos">265</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="WorldAgent-266"><a href="#WorldAgent-266"><span class="linenos">266</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent-267"><a href="#WorldAgent-267"><span class="linenos">267</span></a>                    <span class="n">msg_type</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-268"><a href="#WorldAgent-268"><span class="linenos">268</span></a>                    
</span><span id="WorldAgent-269"><a href="#WorldAgent-269"><span class="linenos">269</span></a>                    <span class="k">if</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_world_state&quot;</span><span class="p">:</span>
</span><span id="WorldAgent-270"><a href="#WorldAgent-270"><span class="linenos">270</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_world_state_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent-271"><a href="#WorldAgent-271"><span class="linenos">271</span></a>                    
</span><span id="WorldAgent-272"><a href="#WorldAgent-272"><span class="linenos">272</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_node_info&quot;</span><span class="p">:</span>
</span><span id="WorldAgent-273"><a href="#WorldAgent-273"><span class="linenos">273</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_node_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent-274"><a href="#WorldAgent-274"><span class="linenos">274</span></a>                    
</span><span id="WorldAgent-275"><a href="#WorldAgent-275"><span class="linenos">275</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_edge_info&quot;</span><span class="p">:</span>
</span><span id="WorldAgent-276"><a href="#WorldAgent-276"><span class="linenos">276</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_edge_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent-277"><a href="#WorldAgent-277"><span class="linenos">277</span></a>                    
</span><span id="WorldAgent-278"><a href="#WorldAgent-278"><span class="linenos">278</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_facilities&quot;</span><span class="p">:</span>
</span><span id="WorldAgent-279"><a href="#WorldAgent-279"><span class="linenos">279</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_facilities_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent-280"><a href="#WorldAgent-280"><span class="linenos">280</span></a>                    
</span><span id="WorldAgent-281"><a href="#WorldAgent-281"><span class="linenos">281</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">:</span>
</span><span id="WorldAgent-282"><a href="#WorldAgent-282"><span class="linenos">282</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_subscribe</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent-283"><a href="#WorldAgent-283"><span class="linenos">283</span></a>                    
</span><span id="WorldAgent-284"><a href="#WorldAgent-284"><span class="linenos">284</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="WorldAgent-285"><a href="#WorldAgent-285"><span class="linenos">285</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Unknown message type: </span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-286"><a href="#WorldAgent-286"><span class="linenos">286</span></a>                        
</span><span id="WorldAgent-287"><a href="#WorldAgent-287"><span class="linenos">287</span></a>                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent-288"><a href="#WorldAgent-288"><span class="linenos">288</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error decoding message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-289"><a href="#WorldAgent-289"><span class="linenos">289</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent-290"><a href="#WorldAgent-290"><span class="linenos">290</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error handling message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-291"><a href="#WorldAgent-291"><span class="linenos">291</span></a>
</span><span id="WorldAgent-292"><a href="#WorldAgent-292"><span class="linenos">292</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_world_state_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="WorldAgent-293"><a href="#WorldAgent-293"><span class="linenos">293</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle query for complete world state.</span>
</span><span id="WorldAgent-294"><a href="#WorldAgent-294"><span class="linenos">294</span></a><span class="sd">            </span>
</span><span id="WorldAgent-295"><a href="#WorldAgent-295"><span class="linenos">295</span></a><span class="sd">            Responds to queries requesting the complete world state snapshot.</span>
</span><span id="WorldAgent-296"><a href="#WorldAgent-296"><span class="linenos">296</span></a><span class="sd">            Compiles all relevant world information including simulation progress,</span>
</span><span id="WorldAgent-297"><a href="#WorldAgent-297"><span class="linenos">297</span></a><span class="sd">            grid dimensions, facility counts, and infected edge statistics.</span>
</span><span id="WorldAgent-298"><a href="#WorldAgent-298"><span class="linenos">298</span></a><span class="sd">            </span>
</span><span id="WorldAgent-299"><a href="#WorldAgent-299"><span class="linenos">299</span></a><span class="sd">            This handler follows the FIPA Query interaction protocol by:</span>
</span><span id="WorldAgent-300"><a href="#WorldAgent-300"><span class="linenos">300</span></a><span class="sd">            - Receiving a query request message</span>
</span><span id="WorldAgent-301"><a href="#WorldAgent-301"><span class="linenos">301</span></a><span class="sd">            - Preparing comprehensive state information</span>
</span><span id="WorldAgent-302"><a href="#WorldAgent-302"><span class="linenos">302</span></a><span class="sd">            - Sending an INFORM message with the complete state</span>
</span><span id="WorldAgent-303"><a href="#WorldAgent-303"><span class="linenos">303</span></a><span class="sd">            </span>
</span><span id="WorldAgent-304"><a href="#WorldAgent-304"><span class="linenos">304</span></a><span class="sd">            Args:</span>
</span><span id="WorldAgent-305"><a href="#WorldAgent-305"><span class="linenos">305</span></a><span class="sd">                msg (Message): The incoming query message from sender agent.</span>
</span><span id="WorldAgent-306"><a href="#WorldAgent-306"><span class="linenos">306</span></a><span class="sd">                    Expected to be of type &quot;query_world_state&quot; in JSON body.</span>
</span><span id="WorldAgent-307"><a href="#WorldAgent-307"><span class="linenos">307</span></a><span class="sd">            </span>
</span><span id="WorldAgent-308"><a href="#WorldAgent-308"><span class="linenos">308</span></a><span class="sd">            Returns:</span>
</span><span id="WorldAgent-309"><a href="#WorldAgent-309"><span class="linenos">309</span></a><span class="sd">                None: Sends response asynchronously via FIPA INFORM message</span>
</span><span id="WorldAgent-310"><a href="#WorldAgent-310"><span class="linenos">310</span></a><span class="sd">            </span>
</span><span id="WorldAgent-311"><a href="#WorldAgent-311"><span class="linenos">311</span></a><span class="sd">            Response payload includes:</span>
</span><span id="WorldAgent-312"><a href="#WorldAgent-312"><span class="linenos">312</span></a><span class="sd">                - tick: Current simulation time step counter</span>
</span><span id="WorldAgent-313"><a href="#WorldAgent-313"><span class="linenos">313</span></a><span class="sd">                - width/height: Grid dimensions in the world graph</span>
</span><span id="WorldAgent-314"><a href="#WorldAgent-314"><span class="linenos">314</span></a><span class="sd">                - seed: Random seed used for deterministic reproduction</span>
</span><span id="WorldAgent-315"><a href="#WorldAgent-315"><span class="linenos">315</span></a><span class="sd">                - mode: Simulation mode (e.g., &quot;traffic&quot; or other modes)</span>
</span><span id="WorldAgent-316"><a href="#WorldAgent-316"><span class="linenos">316</span></a><span class="sd">                - num_nodes: Total number of nodes in the supply chain graph</span>
</span><span id="WorldAgent-317"><a href="#WorldAgent-317"><span class="linenos">317</span></a><span class="sd">                - num_edges: Total number of edges in the supply chain graph</span>
</span><span id="WorldAgent-318"><a href="#WorldAgent-318"><span class="linenos">318</span></a><span class="sd">                - infected_edges: Count of edges currently experiencing traffic</span>
</span><span id="WorldAgent-319"><a href="#WorldAgent-319"><span class="linenos">319</span></a><span class="sd">                - gas_stations: Number and IDs of gas station facilities</span>
</span><span id="WorldAgent-320"><a href="#WorldAgent-320"><span class="linenos">320</span></a><span class="sd">                - warehouses: Number and IDs of warehouse facilities</span>
</span><span id="WorldAgent-321"><a href="#WorldAgent-321"><span class="linenos">321</span></a><span class="sd">                - suppliers: Number and IDs of supplier facilities</span>
</span><span id="WorldAgent-322"><a href="#WorldAgent-322"><span class="linenos">322</span></a><span class="sd">                - stores: Number and IDs of store facilities</span>
</span><span id="WorldAgent-323"><a href="#WorldAgent-323"><span class="linenos">323</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent-324"><a href="#WorldAgent-324"><span class="linenos">324</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-325"><a href="#WorldAgent-325"><span class="linenos">325</span></a>            <span class="n">world_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="WorldAgent-326"><a href="#WorldAgent-326"><span class="linenos">326</span></a>                <span class="s2">&quot;tick&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span><span class="p">,</span>
</span><span id="WorldAgent-327"><a href="#WorldAgent-327"><span class="linenos">327</span></a>                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
</span><span id="WorldAgent-328"><a href="#WorldAgent-328"><span class="linenos">328</span></a>                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
</span><span id="WorldAgent-329"><a href="#WorldAgent-329"><span class="linenos">329</span></a>                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
</span><span id="WorldAgent-330"><a href="#WorldAgent-330"><span class="linenos">330</span></a>                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
</span><span id="WorldAgent-331"><a href="#WorldAgent-331"><span class="linenos">331</span></a>                <span class="s2">&quot;num_nodes&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span>
</span><span id="WorldAgent-332"><a href="#WorldAgent-332"><span class="linenos">332</span></a>                <span class="s2">&quot;num_edges&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">),</span>
</span><span id="WorldAgent-333"><a href="#WorldAgent-333"><span class="linenos">333</span></a>                <span class="s2">&quot;infected_edges&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">infected_edges</span><span class="p">),</span>
</span><span id="WorldAgent-334"><a href="#WorldAgent-334"><span class="linenos">334</span></a>                <span class="s2">&quot;gas_stations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">gas_stations</span><span class="p">,</span>
</span><span id="WorldAgent-335"><a href="#WorldAgent-335"><span class="linenos">335</span></a>                <span class="s2">&quot;warehouses&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">warehouses</span><span class="p">,</span>
</span><span id="WorldAgent-336"><a href="#WorldAgent-336"><span class="linenos">336</span></a>                <span class="s2">&quot;suppliers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">suppliers</span><span class="p">,</span>
</span><span id="WorldAgent-337"><a href="#WorldAgent-337"><span class="linenos">337</span></a>                <span class="s2">&quot;stores&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">stores</span>
</span><span id="WorldAgent-338"><a href="#WorldAgent-338"><span class="linenos">338</span></a>            <span class="p">}</span>
</span><span id="WorldAgent-339"><a href="#WorldAgent-339"><span class="linenos">339</span></a>            
</span><span id="WorldAgent-340"><a href="#WorldAgent-340"><span class="linenos">340</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-341"><a href="#WorldAgent-341"><span class="linenos">341</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-342"><a href="#WorldAgent-342"><span class="linenos">342</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent-343"><a href="#WorldAgent-343"><span class="linenos">343</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;world_state&quot;</span><span class="p">,</span>
</span><span id="WorldAgent-344"><a href="#WorldAgent-344"><span class="linenos">344</span></a>                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">world_data</span>
</span><span id="WorldAgent-345"><a href="#WorldAgent-345"><span class="linenos">345</span></a>            <span class="p">})</span>
</span><span id="WorldAgent-346"><a href="#WorldAgent-346"><span class="linenos">346</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent-347"><a href="#WorldAgent-347"><span class="linenos">347</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] World state sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-348"><a href="#WorldAgent-348"><span class="linenos">348</span></a>
</span><span id="WorldAgent-349"><a href="#WorldAgent-349"><span class="linenos">349</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_node_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="WorldAgent-350"><a href="#WorldAgent-350"><span class="linenos">350</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle query for information about a specific node.</span>
</span><span id="WorldAgent-351"><a href="#WorldAgent-351"><span class="linenos">351</span></a><span class="sd">            </span>
</span><span id="WorldAgent-352"><a href="#WorldAgent-352"><span class="linenos">352</span></a><span class="sd">            Responds to queries requesting detailed information about a single node</span>
</span><span id="WorldAgent-353"><a href="#WorldAgent-353"><span class="linenos">353</span></a><span class="sd">            in the supply chain graph. The node is identified by its ID in the</span>
</span><span id="WorldAgent-354"><a href="#WorldAgent-354"><span class="linenos">354</span></a><span class="sd">            query message. Returns node coordinates, facility affiliations, and</span>
</span><span id="WorldAgent-355"><a href="#WorldAgent-355"><span class="linenos">355</span></a><span class="sd">            other node-specific metadata.</span>
</span><span id="WorldAgent-356"><a href="#WorldAgent-356"><span class="linenos">356</span></a><span class="sd">            </span>
</span><span id="WorldAgent-357"><a href="#WorldAgent-357"><span class="linenos">357</span></a><span class="sd">            FIPA Query/Response Protocol:</span>
</span><span id="WorldAgent-358"><a href="#WorldAgent-358"><span class="linenos">358</span></a><span class="sd">            - Receives QUERY message with specific node_id parameter</span>
</span><span id="WorldAgent-359"><a href="#WorldAgent-359"><span class="linenos">359</span></a><span class="sd">            - Searches graph for the requested node</span>
</span><span id="WorldAgent-360"><a href="#WorldAgent-360"><span class="linenos">360</span></a><span class="sd">            - Returns INFORM message with node data if found</span>
</span><span id="WorldAgent-361"><a href="#WorldAgent-361"><span class="linenos">361</span></a><span class="sd">            - Returns ERROR message if node not found</span>
</span><span id="WorldAgent-362"><a href="#WorldAgent-362"><span class="linenos">362</span></a><span class="sd">            </span>
</span><span id="WorldAgent-363"><a href="#WorldAgent-363"><span class="linenos">363</span></a><span class="sd">            Args:</span>
</span><span id="WorldAgent-364"><a href="#WorldAgent-364"><span class="linenos">364</span></a><span class="sd">                msg (Message): The incoming query message from sender agent.</span>
</span><span id="WorldAgent-365"><a href="#WorldAgent-365"><span class="linenos">365</span></a><span class="sd">                    Message body must include JSON with:</span>
</span><span id="WorldAgent-366"><a href="#WorldAgent-366"><span class="linenos">366</span></a><span class="sd">                    - type: &quot;query_node_info&quot;</span>
</span><span id="WorldAgent-367"><a href="#WorldAgent-367"><span class="linenos">367</span></a><span class="sd">                    - node_id: The ID of the node to query</span>
</span><span id="WorldAgent-368"><a href="#WorldAgent-368"><span class="linenos">368</span></a><span class="sd">            </span>
</span><span id="WorldAgent-369"><a href="#WorldAgent-369"><span class="linenos">369</span></a><span class="sd">            Returns:</span>
</span><span id="WorldAgent-370"><a href="#WorldAgent-370"><span class="linenos">370</span></a><span class="sd">                None: Sends FIPA response message (INFORM or ERROR)</span>
</span><span id="WorldAgent-371"><a href="#WorldAgent-371"><span class="linenos">371</span></a><span class="sd">            </span>
</span><span id="WorldAgent-372"><a href="#WorldAgent-372"><span class="linenos">372</span></a><span class="sd">            Response for successful query:</span>
</span><span id="WorldAgent-373"><a href="#WorldAgent-373"><span class="linenos">373</span></a><span class="sd">                - id: The node identifier</span>
</span><span id="WorldAgent-374"><a href="#WorldAgent-374"><span class="linenos">374</span></a><span class="sd">                - x: X-coordinate position in the world grid</span>
</span><span id="WorldAgent-375"><a href="#WorldAgent-375"><span class="linenos">375</span></a><span class="sd">                - y: Y-coordinate position in the world grid</span>
</span><span id="WorldAgent-376"><a href="#WorldAgent-376"><span class="linenos">376</span></a><span class="sd">                - warehouse: Boolean indicating if node hosts a warehouse</span>
</span><span id="WorldAgent-377"><a href="#WorldAgent-377"><span class="linenos">377</span></a><span class="sd">                - supplier: Boolean indicating if node hosts a supplier</span>
</span><span id="WorldAgent-378"><a href="#WorldAgent-378"><span class="linenos">378</span></a><span class="sd">                - store: Boolean indicating if node hosts a store</span>
</span><span id="WorldAgent-379"><a href="#WorldAgent-379"><span class="linenos">379</span></a><span class="sd">                - gas_station: Boolean indicating if node has a gas station</span>
</span><span id="WorldAgent-380"><a href="#WorldAgent-380"><span class="linenos">380</span></a><span class="sd">            </span>
</span><span id="WorldAgent-381"><a href="#WorldAgent-381"><span class="linenos">381</span></a><span class="sd">            Response for failed query (node not found):</span>
</span><span id="WorldAgent-382"><a href="#WorldAgent-382"><span class="linenos">382</span></a><span class="sd">                - type: &quot;error&quot;</span>
</span><span id="WorldAgent-383"><a href="#WorldAgent-383"><span class="linenos">383</span></a><span class="sd">                - message: Descriptive error message</span>
</span><span id="WorldAgent-384"><a href="#WorldAgent-384"><span class="linenos">384</span></a><span class="sd">            </span>
</span><span id="WorldAgent-385"><a href="#WorldAgent-385"><span class="linenos">385</span></a><span class="sd">            Raises:</span>
</span><span id="WorldAgent-386"><a href="#WorldAgent-386"><span class="linenos">386</span></a><span class="sd">                Exception: Any runtime error during query processing</span>
</span><span id="WorldAgent-387"><a href="#WorldAgent-387"><span class="linenos">387</span></a><span class="sd">                    (caught and reported in error response)</span>
</span><span id="WorldAgent-388"><a href="#WorldAgent-388"><span class="linenos">388</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent-389"><a href="#WorldAgent-389"><span class="linenos">389</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-390"><a href="#WorldAgent-390"><span class="linenos">390</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="WorldAgent-391"><a href="#WorldAgent-391"><span class="linenos">391</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent-392"><a href="#WorldAgent-392"><span class="linenos">392</span></a>                <span class="n">node_id</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-393"><a href="#WorldAgent-393"><span class="linenos">393</span></a>                
</span><span id="WorldAgent-394"><a href="#WorldAgent-394"><span class="linenos">394</span></a>                <span class="k">if</span> <span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="WorldAgent-395"><a href="#WorldAgent-395"><span class="linenos">395</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-396"><a href="#WorldAgent-396"><span class="linenos">396</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent-397"><a href="#WorldAgent-397"><span class="linenos">397</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="WorldAgent-398"><a href="#WorldAgent-398"><span class="linenos">398</span></a>                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Node </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s2"> not found&quot;</span>
</span><span id="WorldAgent-399"><a href="#WorldAgent-399"><span class="linenos">399</span></a>                    <span class="p">})</span>
</span><span id="WorldAgent-400"><a href="#WorldAgent-400"><span class="linenos">400</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="WorldAgent-401"><a href="#WorldAgent-401"><span class="linenos">401</span></a>                    <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
</span><span id="WorldAgent-402"><a href="#WorldAgent-402"><span class="linenos">402</span></a>                    <span class="n">node_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="WorldAgent-403"><a href="#WorldAgent-403"><span class="linenos">403</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span>
</span><span id="WorldAgent-404"><a href="#WorldAgent-404"><span class="linenos">404</span></a>                        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
</span><span id="WorldAgent-405"><a href="#WorldAgent-405"><span class="linenos">405</span></a>                        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
</span><span id="WorldAgent-406"><a href="#WorldAgent-406"><span class="linenos">406</span></a>                        <span class="s2">&quot;warehouse&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">warehouse</span><span class="p">,</span>
</span><span id="WorldAgent-407"><a href="#WorldAgent-407"><span class="linenos">407</span></a>                        <span class="s2">&quot;supplier&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">supplier</span><span class="p">,</span>
</span><span id="WorldAgent-408"><a href="#WorldAgent-408"><span class="linenos">408</span></a>                        <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">store</span><span class="p">,</span>
</span><span id="WorldAgent-409"><a href="#WorldAgent-409"><span class="linenos">409</span></a>                        <span class="s2">&quot;gas_station&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">gas_station</span>
</span><span id="WorldAgent-410"><a href="#WorldAgent-410"><span class="linenos">410</span></a>                    <span class="p">}</span>
</span><span id="WorldAgent-411"><a href="#WorldAgent-411"><span class="linenos">411</span></a>                    
</span><span id="WorldAgent-412"><a href="#WorldAgent-412"><span class="linenos">412</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-413"><a href="#WorldAgent-413"><span class="linenos">413</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-414"><a href="#WorldAgent-414"><span class="linenos">414</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent-415"><a href="#WorldAgent-415"><span class="linenos">415</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;node_info&quot;</span><span class="p">,</span>
</span><span id="WorldAgent-416"><a href="#WorldAgent-416"><span class="linenos">416</span></a>                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">node_data</span>
</span><span id="WorldAgent-417"><a href="#WorldAgent-417"><span class="linenos">417</span></a>                    <span class="p">})</span>
</span><span id="WorldAgent-418"><a href="#WorldAgent-418"><span class="linenos">418</span></a>                
</span><span id="WorldAgent-419"><a href="#WorldAgent-419"><span class="linenos">419</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent-420"><a href="#WorldAgent-420"><span class="linenos">420</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Node </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s2"> information sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-421"><a href="#WorldAgent-421"><span class="linenos">421</span></a>                
</span><span id="WorldAgent-422"><a href="#WorldAgent-422"><span class="linenos">422</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent-423"><a href="#WorldAgent-423"><span class="linenos">423</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-424"><a href="#WorldAgent-424"><span class="linenos">424</span></a>                <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent-425"><a href="#WorldAgent-425"><span class="linenos">425</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="WorldAgent-426"><a href="#WorldAgent-426"><span class="linenos">426</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="WorldAgent-427"><a href="#WorldAgent-427"><span class="linenos">427</span></a>                <span class="p">})</span>
</span><span id="WorldAgent-428"><a href="#WorldAgent-428"><span class="linenos">428</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent-429"><a href="#WorldAgent-429"><span class="linenos">429</span></a>
</span><span id="WorldAgent-430"><a href="#WorldAgent-430"><span class="linenos">430</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_edge_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="WorldAgent-431"><a href="#WorldAgent-431"><span class="linenos">431</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle query for information about edges.</span>
</span><span id="WorldAgent-432"><a href="#WorldAgent-432"><span class="linenos">432</span></a><span class="sd">            </span>
</span><span id="WorldAgent-433"><a href="#WorldAgent-433"><span class="linenos">433</span></a><span class="sd">            Responds to queries requesting detailed information about a specific edge</span>
</span><span id="WorldAgent-434"><a href="#WorldAgent-434"><span class="linenos">434</span></a><span class="sd">            in the supply chain graph. The edge is identified by its two endpoint nodes</span>
</span><span id="WorldAgent-435"><a href="#WorldAgent-435"><span class="linenos">435</span></a><span class="sd">            (node_u and node_v). Returns edge properties including traversal time,</span>
</span><span id="WorldAgent-436"><a href="#WorldAgent-436"><span class="linenos">436</span></a><span class="sd">            distance, fuel consumption, and infection status.</span>
</span><span id="WorldAgent-437"><a href="#WorldAgent-437"><span class="linenos">437</span></a><span class="sd">            </span>
</span><span id="WorldAgent-438"><a href="#WorldAgent-438"><span class="linenos">438</span></a><span class="sd">            FIPA Query/Response Protocol:</span>
</span><span id="WorldAgent-439"><a href="#WorldAgent-439"><span class="linenos">439</span></a><span class="sd">            - Receives QUERY message with node_u and node_v parameters</span>
</span><span id="WorldAgent-440"><a href="#WorldAgent-440"><span class="linenos">440</span></a><span class="sd">            - Looks up edge in graph using get_edge() method</span>
</span><span id="WorldAgent-441"><a href="#WorldAgent-441"><span class="linenos">441</span></a><span class="sd">            - Returns INFORM message with edge data if found</span>
</span><span id="WorldAgent-442"><a href="#WorldAgent-442"><span class="linenos">442</span></a><span class="sd">            - Returns ERROR message if edge not found</span>
</span><span id="WorldAgent-443"><a href="#WorldAgent-443"><span class="linenos">443</span></a><span class="sd">            </span>
</span><span id="WorldAgent-444"><a href="#WorldAgent-444"><span class="linenos">444</span></a><span class="sd">            Args:</span>
</span><span id="WorldAgent-445"><a href="#WorldAgent-445"><span class="linenos">445</span></a><span class="sd">                msg (Message): The incoming query message from sender agent.</span>
</span><span id="WorldAgent-446"><a href="#WorldAgent-446"><span class="linenos">446</span></a><span class="sd">                    Message body must include JSON with:</span>
</span><span id="WorldAgent-447"><a href="#WorldAgent-447"><span class="linenos">447</span></a><span class="sd">                    - type: &quot;query_edge_info&quot;</span>
</span><span id="WorldAgent-448"><a href="#WorldAgent-448"><span class="linenos">448</span></a><span class="sd">                    - node_u: Source node ID</span>
</span><span id="WorldAgent-449"><a href="#WorldAgent-449"><span class="linenos">449</span></a><span class="sd">                    - node_v: Destination node ID</span>
</span><span id="WorldAgent-450"><a href="#WorldAgent-450"><span class="linenos">450</span></a><span class="sd">            </span>
</span><span id="WorldAgent-451"><a href="#WorldAgent-451"><span class="linenos">451</span></a><span class="sd">            Returns:</span>
</span><span id="WorldAgent-452"><a href="#WorldAgent-452"><span class="linenos">452</span></a><span class="sd">                None: Sends FIPA response message (INFORM or ERROR)</span>
</span><span id="WorldAgent-453"><a href="#WorldAgent-453"><span class="linenos">453</span></a><span class="sd">            </span>
</span><span id="WorldAgent-454"><a href="#WorldAgent-454"><span class="linenos">454</span></a><span class="sd">            Response for successful query:</span>
</span><span id="WorldAgent-455"><a href="#WorldAgent-455"><span class="linenos">455</span></a><span class="sd">                - node_u: Source node ID</span>
</span><span id="WorldAgent-456"><a href="#WorldAgent-456"><span class="linenos">456</span></a><span class="sd">                - node_v: Destination node ID</span>
</span><span id="WorldAgent-457"><a href="#WorldAgent-457"><span class="linenos">457</span></a><span class="sd">                - weight: Current edge weight (travel time in current tick)</span>
</span><span id="WorldAgent-458"><a href="#WorldAgent-458"><span class="linenos">458</span></a><span class="sd">                - initial_weight: Original edge weight from graph initialization</span>
</span><span id="WorldAgent-459"><a href="#WorldAgent-459"><span class="linenos">459</span></a><span class="sd">                - distance: Geometric distance between nodes</span>
</span><span id="WorldAgent-460"><a href="#WorldAgent-460"><span class="linenos">460</span></a><span class="sd">                - fuel_consumption: Fuel needed to traverse this edge</span>
</span><span id="WorldAgent-461"><a href="#WorldAgent-461"><span class="linenos">461</span></a><span class="sd">                - is_infected: Boolean indicating if edge has traffic/infection</span>
</span><span id="WorldAgent-462"><a href="#WorldAgent-462"><span class="linenos">462</span></a><span class="sd">            </span>
</span><span id="WorldAgent-463"><a href="#WorldAgent-463"><span class="linenos">463</span></a><span class="sd">            Response for failed query (edge not found):</span>
</span><span id="WorldAgent-464"><a href="#WorldAgent-464"><span class="linenos">464</span></a><span class="sd">                - type: &quot;error&quot;</span>
</span><span id="WorldAgent-465"><a href="#WorldAgent-465"><span class="linenos">465</span></a><span class="sd">                - message: Descriptive error message</span>
</span><span id="WorldAgent-466"><a href="#WorldAgent-466"><span class="linenos">466</span></a><span class="sd">            </span>
</span><span id="WorldAgent-467"><a href="#WorldAgent-467"><span class="linenos">467</span></a><span class="sd">            Raises:</span>
</span><span id="WorldAgent-468"><a href="#WorldAgent-468"><span class="linenos">468</span></a><span class="sd">                Exception: Any runtime error during query processing</span>
</span><span id="WorldAgent-469"><a href="#WorldAgent-469"><span class="linenos">469</span></a><span class="sd">                    (caught and reported in error response)</span>
</span><span id="WorldAgent-470"><a href="#WorldAgent-470"><span class="linenos">470</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent-471"><a href="#WorldAgent-471"><span class="linenos">471</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-472"><a href="#WorldAgent-472"><span class="linenos">472</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="WorldAgent-473"><a href="#WorldAgent-473"><span class="linenos">473</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent-474"><a href="#WorldAgent-474"><span class="linenos">474</span></a>                <span class="n">node_u</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_u&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-475"><a href="#WorldAgent-475"><span class="linenos">475</span></a>                <span class="n">node_v</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_v&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-476"><a href="#WorldAgent-476"><span class="linenos">476</span></a>                
</span><span id="WorldAgent-477"><a href="#WorldAgent-477"><span class="linenos">477</span></a>                <span class="n">edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">node_u</span><span class="p">,</span> <span class="n">node_v</span><span class="p">)</span>
</span><span id="WorldAgent-478"><a href="#WorldAgent-478"><span class="linenos">478</span></a>                
</span><span id="WorldAgent-479"><a href="#WorldAgent-479"><span class="linenos">479</span></a>                <span class="k">if</span> <span class="n">edge</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="WorldAgent-480"><a href="#WorldAgent-480"><span class="linenos">480</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-481"><a href="#WorldAgent-481"><span class="linenos">481</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent-482"><a href="#WorldAgent-482"><span class="linenos">482</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="WorldAgent-483"><a href="#WorldAgent-483"><span class="linenos">483</span></a>                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Edge (</span><span class="si">{</span><span class="n">node_u</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">node_v</span><span class="si">}</span><span class="s2">) not found&quot;</span>
</span><span id="WorldAgent-484"><a href="#WorldAgent-484"><span class="linenos">484</span></a>                    <span class="p">})</span>
</span><span id="WorldAgent-485"><a href="#WorldAgent-485"><span class="linenos">485</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="WorldAgent-486"><a href="#WorldAgent-486"><span class="linenos">486</span></a>                    <span class="n">edge_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="WorldAgent-487"><a href="#WorldAgent-487"><span class="linenos">487</span></a>                        <span class="s2">&quot;node_u&quot;</span><span class="p">:</span> <span class="n">node_u</span><span class="p">,</span>
</span><span id="WorldAgent-488"><a href="#WorldAgent-488"><span class="linenos">488</span></a>                        <span class="s2">&quot;node_v&quot;</span><span class="p">:</span> <span class="n">node_v</span><span class="p">,</span>
</span><span id="WorldAgent-489"><a href="#WorldAgent-489"><span class="linenos">489</span></a>                        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
</span><span id="WorldAgent-490"><a href="#WorldAgent-490"><span class="linenos">490</span></a>                        <span class="s2">&quot;initial_weight&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">initial_weight</span><span class="p">,</span>
</span><span id="WorldAgent-491"><a href="#WorldAgent-491"><span class="linenos">491</span></a>                        <span class="s2">&quot;distance&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">distance</span><span class="p">,</span>
</span><span id="WorldAgent-492"><a href="#WorldAgent-492"><span class="linenos">492</span></a>                        <span class="s2">&quot;fuel_consumption&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">get_fuel_consumption</span><span class="p">(),</span>
</span><span id="WorldAgent-493"><a href="#WorldAgent-493"><span class="linenos">493</span></a>                        <span class="s2">&quot;is_infected&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">node_u</span><span class="p">,</span> <span class="n">node_v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">infected_edges</span>
</span><span id="WorldAgent-494"><a href="#WorldAgent-494"><span class="linenos">494</span></a>                    <span class="p">}</span>
</span><span id="WorldAgent-495"><a href="#WorldAgent-495"><span class="linenos">495</span></a>                    
</span><span id="WorldAgent-496"><a href="#WorldAgent-496"><span class="linenos">496</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-497"><a href="#WorldAgent-497"><span class="linenos">497</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-498"><a href="#WorldAgent-498"><span class="linenos">498</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent-499"><a href="#WorldAgent-499"><span class="linenos">499</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;edge_info&quot;</span><span class="p">,</span>
</span><span id="WorldAgent-500"><a href="#WorldAgent-500"><span class="linenos">500</span></a>                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">edge_data</span>
</span><span id="WorldAgent-501"><a href="#WorldAgent-501"><span class="linenos">501</span></a>                    <span class="p">})</span>
</span><span id="WorldAgent-502"><a href="#WorldAgent-502"><span class="linenos">502</span></a>                
</span><span id="WorldAgent-503"><a href="#WorldAgent-503"><span class="linenos">503</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent-504"><a href="#WorldAgent-504"><span class="linenos">504</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Edge (</span><span class="si">{</span><span class="n">node_u</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">node_v</span><span class="si">}</span><span class="s2">) information sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-505"><a href="#WorldAgent-505"><span class="linenos">505</span></a>                
</span><span id="WorldAgent-506"><a href="#WorldAgent-506"><span class="linenos">506</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent-507"><a href="#WorldAgent-507"><span class="linenos">507</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-508"><a href="#WorldAgent-508"><span class="linenos">508</span></a>                <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent-509"><a href="#WorldAgent-509"><span class="linenos">509</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="WorldAgent-510"><a href="#WorldAgent-510"><span class="linenos">510</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="WorldAgent-511"><a href="#WorldAgent-511"><span class="linenos">511</span></a>                <span class="p">})</span>
</span><span id="WorldAgent-512"><a href="#WorldAgent-512"><span class="linenos">512</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent-513"><a href="#WorldAgent-513"><span class="linenos">513</span></a>
</span><span id="WorldAgent-514"><a href="#WorldAgent-514"><span class="linenos">514</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_facilities_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="WorldAgent-515"><a href="#WorldAgent-515"><span class="linenos">515</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle query for facility locations.</span>
</span><span id="WorldAgent-516"><a href="#WorldAgent-516"><span class="linenos">516</span></a><span class="sd">            </span>
</span><span id="WorldAgent-517"><a href="#WorldAgent-517"><span class="linenos">517</span></a><span class="sd">            Responds to queries requesting the complete list of all supply chain</span>
</span><span id="WorldAgent-518"><a href="#WorldAgent-518"><span class="linenos">518</span></a><span class="sd">            facility locations organized by type. This includes warehouses, suppliers,</span>
</span><span id="WorldAgent-519"><a href="#WorldAgent-519"><span class="linenos">519</span></a><span class="sd">            gas stations, and stores. The facilities are represented by their node IDs</span>
</span><span id="WorldAgent-520"><a href="#WorldAgent-520"><span class="linenos">520</span></a><span class="sd">            in the supply chain graph.</span>
</span><span id="WorldAgent-521"><a href="#WorldAgent-521"><span class="linenos">521</span></a><span class="sd">            </span>
</span><span id="WorldAgent-522"><a href="#WorldAgent-522"><span class="linenos">522</span></a><span class="sd">            FIPA Query/Response Protocol:</span>
</span><span id="WorldAgent-523"><a href="#WorldAgent-523"><span class="linenos">523</span></a><span class="sd">            - Receives QUERY message for facility locations</span>
</span><span id="WorldAgent-524"><a href="#WorldAgent-524"><span class="linenos">524</span></a><span class="sd">            - Iterates through all nodes in graph checking facility flags</span>
</span><span id="WorldAgent-525"><a href="#WorldAgent-525"><span class="linenos">525</span></a><span class="sd">            - Returns INFORM message with categorized facility lists</span>
</span><span id="WorldAgent-526"><a href="#WorldAgent-526"><span class="linenos">526</span></a><span class="sd">            </span>
</span><span id="WorldAgent-527"><a href="#WorldAgent-527"><span class="linenos">527</span></a><span class="sd">            This query is useful for agents that need to plan routes or coordinate</span>
</span><span id="WorldAgent-528"><a href="#WorldAgent-528"><span class="linenos">528</span></a><span class="sd">            with specific facility types without needing full node data.</span>
</span><span id="WorldAgent-529"><a href="#WorldAgent-529"><span class="linenos">529</span></a><span class="sd">            </span>
</span><span id="WorldAgent-530"><a href="#WorldAgent-530"><span class="linenos">530</span></a><span class="sd">            Args:</span>
</span><span id="WorldAgent-531"><a href="#WorldAgent-531"><span class="linenos">531</span></a><span class="sd">                msg (Message): The incoming query message from sender agent.</span>
</span><span id="WorldAgent-532"><a href="#WorldAgent-532"><span class="linenos">532</span></a><span class="sd">                    Expected to be of type &quot;query_facilities&quot; in JSON body.</span>
</span><span id="WorldAgent-533"><a href="#WorldAgent-533"><span class="linenos">533</span></a><span class="sd">            </span>
</span><span id="WorldAgent-534"><a href="#WorldAgent-534"><span class="linenos">534</span></a><span class="sd">            Returns:</span>
</span><span id="WorldAgent-535"><a href="#WorldAgent-535"><span class="linenos">535</span></a><span class="sd">                None: Sends FIPA INFORM message with facilities categorized by type</span>
</span><span id="WorldAgent-536"><a href="#WorldAgent-536"><span class="linenos">536</span></a><span class="sd">            </span>
</span><span id="WorldAgent-537"><a href="#WorldAgent-537"><span class="linenos">537</span></a><span class="sd">            Response payload structure:</span>
</span><span id="WorldAgent-538"><a href="#WorldAgent-538"><span class="linenos">538</span></a><span class="sd">                - warehouses: List of node IDs hosting warehouse facilities</span>
</span><span id="WorldAgent-539"><a href="#WorldAgent-539"><span class="linenos">539</span></a><span class="sd">                - suppliers: List of node IDs hosting supplier facilities</span>
</span><span id="WorldAgent-540"><a href="#WorldAgent-540"><span class="linenos">540</span></a><span class="sd">                - stores: List of node IDs hosting store facilities</span>
</span><span id="WorldAgent-541"><a href="#WorldAgent-541"><span class="linenos">541</span></a><span class="sd">                - gas_stations: List of node IDs hosting gas station facilities</span>
</span><span id="WorldAgent-542"><a href="#WorldAgent-542"><span class="linenos">542</span></a><span class="sd">            </span>
</span><span id="WorldAgent-543"><a href="#WorldAgent-543"><span class="linenos">543</span></a><span class="sd">            Note:</span>
</span><span id="WorldAgent-544"><a href="#WorldAgent-544"><span class="linenos">544</span></a><span class="sd">                A single node can host multiple facilities simultaneously.</span>
</span><span id="WorldAgent-545"><a href="#WorldAgent-545"><span class="linenos">545</span></a><span class="sd">                Facilities are identified based on boolean flags on node objects.</span>
</span><span id="WorldAgent-546"><a href="#WorldAgent-546"><span class="linenos">546</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent-547"><a href="#WorldAgent-547"><span class="linenos">547</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-548"><a href="#WorldAgent-548"><span class="linenos">548</span></a>            
</span><span id="WorldAgent-549"><a href="#WorldAgent-549"><span class="linenos">549</span></a>            <span class="n">facilities</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="WorldAgent-550"><a href="#WorldAgent-550"><span class="linenos">550</span></a>                <span class="s2">&quot;warehouses&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="WorldAgent-551"><a href="#WorldAgent-551"><span class="linenos">551</span></a>                <span class="s2">&quot;suppliers&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="WorldAgent-552"><a href="#WorldAgent-552"><span class="linenos">552</span></a>                <span class="s2">&quot;stores&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="WorldAgent-553"><a href="#WorldAgent-553"><span class="linenos">553</span></a>                <span class="s2">&quot;gas_stations&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="WorldAgent-554"><a href="#WorldAgent-554"><span class="linenos">554</span></a>            <span class="p">}</span>
</span><span id="WorldAgent-555"><a href="#WorldAgent-555"><span class="linenos">555</span></a>            
</span><span id="WorldAgent-556"><a href="#WorldAgent-556"><span class="linenos">556</span></a>            <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="WorldAgent-557"><a href="#WorldAgent-557"><span class="linenos">557</span></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">warehouse</span><span class="p">:</span>
</span><span id="WorldAgent-558"><a href="#WorldAgent-558"><span class="linenos">558</span></a>                    <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;warehouses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="WorldAgent-559"><a href="#WorldAgent-559"><span class="linenos">559</span></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">supplier</span><span class="p">:</span>
</span><span id="WorldAgent-560"><a href="#WorldAgent-560"><span class="linenos">560</span></a>                    <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;suppliers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="WorldAgent-561"><a href="#WorldAgent-561"><span class="linenos">561</span></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
</span><span id="WorldAgent-562"><a href="#WorldAgent-562"><span class="linenos">562</span></a>                    <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;stores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="WorldAgent-563"><a href="#WorldAgent-563"><span class="linenos">563</span></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">gas_station</span><span class="p">:</span>
</span><span id="WorldAgent-564"><a href="#WorldAgent-564"><span class="linenos">564</span></a>                    <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;gas_stations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="WorldAgent-565"><a href="#WorldAgent-565"><span class="linenos">565</span></a>            
</span><span id="WorldAgent-566"><a href="#WorldAgent-566"><span class="linenos">566</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-567"><a href="#WorldAgent-567"><span class="linenos">567</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-568"><a href="#WorldAgent-568"><span class="linenos">568</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent-569"><a href="#WorldAgent-569"><span class="linenos">569</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;facilities_info&quot;</span><span class="p">,</span>
</span><span id="WorldAgent-570"><a href="#WorldAgent-570"><span class="linenos">570</span></a>                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">facilities</span>
</span><span id="WorldAgent-571"><a href="#WorldAgent-571"><span class="linenos">571</span></a>            <span class="p">})</span>
</span><span id="WorldAgent-572"><a href="#WorldAgent-572"><span class="linenos">572</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent-573"><a href="#WorldAgent-573"><span class="linenos">573</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Facilities information sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-574"><a href="#WorldAgent-574"><span class="linenos">574</span></a>
</span><span id="WorldAgent-575"><a href="#WorldAgent-575"><span class="linenos">575</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="WorldAgent-576"><a href="#WorldAgent-576"><span class="linenos">576</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle subscription requests for world state updates.</span>
</span><span id="WorldAgent-577"><a href="#WorldAgent-577"><span class="linenos">577</span></a><span class="sd">            </span>
</span><span id="WorldAgent-578"><a href="#WorldAgent-578"><span class="linenos">578</span></a><span class="sd">            Processes subscription requests from agents that wish to receive</span>
</span><span id="WorldAgent-579"><a href="#WorldAgent-579"><span class="linenos">579</span></a><span class="sd">            periodic world state update broadcasts. When an agent subscribes,</span>
</span><span id="WorldAgent-580"><a href="#WorldAgent-580"><span class="linenos">580</span></a><span class="sd">            it is added to the WorldAgent&#39;s subscriber list and will receive</span>
</span><span id="WorldAgent-581"><a href="#WorldAgent-581"><span class="linenos">581</span></a><span class="sd">            INFORM messages whenever the world state changes significantly</span>
</span><span id="WorldAgent-582"><a href="#WorldAgent-582"><span class="linenos">582</span></a><span class="sd">            (e.g., when new traffic events occur).</span>
</span><span id="WorldAgent-583"><a href="#WorldAgent-583"><span class="linenos">583</span></a><span class="sd">            </span>
</span><span id="WorldAgent-584"><a href="#WorldAgent-584"><span class="linenos">584</span></a><span class="sd">            FIPA Publish/Subscribe Pattern:</span>
</span><span id="WorldAgent-585"><a href="#WorldAgent-585"><span class="linenos">585</span></a><span class="sd">            - Receives SUBSCRIBE message from requesting agent</span>
</span><span id="WorldAgent-586"><a href="#WorldAgent-586"><span class="linenos">586</span></a><span class="sd">            - Validates agent is not already subscribed (prevents duplicates)</span>
</span><span id="WorldAgent-587"><a href="#WorldAgent-587"><span class="linenos">587</span></a><span class="sd">            - Adds agent JID to internal subscriber list</span>
</span><span id="WorldAgent-588"><a href="#WorldAgent-588"><span class="linenos">588</span></a><span class="sd">            - Sends confirmation message back to subscriber</span>
</span><span id="WorldAgent-589"><a href="#WorldAgent-589"><span class="linenos">589</span></a><span class="sd">            </span>
</span><span id="WorldAgent-590"><a href="#WorldAgent-590"><span class="linenos">590</span></a><span class="sd">            The subscription mechanism allows agents to stay informed about</span>
</span><span id="WorldAgent-591"><a href="#WorldAgent-591"><span class="linenos">591</span></a><span class="sd">            world state changes without polling for updates.</span>
</span><span id="WorldAgent-592"><a href="#WorldAgent-592"><span class="linenos">592</span></a><span class="sd">            </span>
</span><span id="WorldAgent-593"><a href="#WorldAgent-593"><span class="linenos">593</span></a><span class="sd">            Args:</span>
</span><span id="WorldAgent-594"><a href="#WorldAgent-594"><span class="linenos">594</span></a><span class="sd">                msg (Message): The incoming subscription request message.</span>
</span><span id="WorldAgent-595"><a href="#WorldAgent-595"><span class="linenos">595</span></a><span class="sd">                    Expected to be of type &quot;subscribe&quot; in JSON body.</span>
</span><span id="WorldAgent-596"><a href="#WorldAgent-596"><span class="linenos">596</span></a><span class="sd">            </span>
</span><span id="WorldAgent-597"><a href="#WorldAgent-597"><span class="linenos">597</span></a><span class="sd">            Returns:</span>
</span><span id="WorldAgent-598"><a href="#WorldAgent-598"><span class="linenos">598</span></a><span class="sd">                None: Adds sender to subscribers and sends confirmation</span>
</span><span id="WorldAgent-599"><a href="#WorldAgent-599"><span class="linenos">599</span></a><span class="sd">            </span>
</span><span id="WorldAgent-600"><a href="#WorldAgent-600"><span class="linenos">600</span></a><span class="sd">            Side Effects:</span>
</span><span id="WorldAgent-601"><a href="#WorldAgent-601"><span class="linenos">601</span></a><span class="sd">                - Adds sender JID to self.agent.subscribers list</span>
</span><span id="WorldAgent-602"><a href="#WorldAgent-602"><span class="linenos">602</span></a><span class="sd">                - Logs subscription confirmation message</span>
</span><span id="WorldAgent-603"><a href="#WorldAgent-603"><span class="linenos">603</span></a><span class="sd">            </span>
</span><span id="WorldAgent-604"><a href="#WorldAgent-604"><span class="linenos">604</span></a><span class="sd">            Confirmation Response:</span>
</span><span id="WorldAgent-605"><a href="#WorldAgent-605"><span class="linenos">605</span></a><span class="sd">                - type: &quot;subscription_confirmed&quot;</span>
</span><span id="WorldAgent-606"><a href="#WorldAgent-606"><span class="linenos">606</span></a><span class="sd">                - performative: &quot;confirm&quot;</span>
</span><span id="WorldAgent-607"><a href="#WorldAgent-607"><span class="linenos">607</span></a><span class="sd">            </span>
</span><span id="WorldAgent-608"><a href="#WorldAgent-608"><span class="linenos">608</span></a><span class="sd">            Once subscribed, the agent will receive messages via</span>
</span><span id="WorldAgent-609"><a href="#WorldAgent-609"><span class="linenos">609</span></a><span class="sd">            _broadcast_world_state() when updates are available.</span>
</span><span id="WorldAgent-610"><a href="#WorldAgent-610"><span class="linenos">610</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent-611"><a href="#WorldAgent-611"><span class="linenos">611</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-612"><a href="#WorldAgent-612"><span class="linenos">612</span></a>            <span class="k">if</span> <span class="n">sender</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">subscribers</span><span class="p">:</span>
</span><span id="WorldAgent-613"><a href="#WorldAgent-613"><span class="linenos">613</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">subscribers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-614"><a href="#WorldAgent-614"><span class="linenos">614</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Agent </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2"> subscribed to world updates&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-615"><a href="#WorldAgent-615"><span class="linenos">615</span></a>            
</span><span id="WorldAgent-616"><a href="#WorldAgent-616"><span class="linenos">616</span></a>            <span class="c1"># Send confirmation</span>
</span><span id="WorldAgent-617"><a href="#WorldAgent-617"><span class="linenos">617</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent-618"><a href="#WorldAgent-618"><span class="linenos">618</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;confirm&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-619"><a href="#WorldAgent-619"><span class="linenos">619</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent-620"><a href="#WorldAgent-620"><span class="linenos">620</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;subscription_confirmed&quot;</span>
</span><span id="WorldAgent-621"><a href="#WorldAgent-621"><span class="linenos">621</span></a>            <span class="p">})</span>
</span><span id="WorldAgent-622"><a href="#WorldAgent-622"><span class="linenos">622</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent-623"><a href="#WorldAgent-623"><span class="linenos">623</span></a>
</span><span id="WorldAgent-624"><a href="#WorldAgent-624"><span class="linenos">624</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_broadcast_world_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorldAgent-625"><a href="#WorldAgent-625"><span class="linenos">625</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Broadcast world state to all subscribed agents.</span>
</span><span id="WorldAgent-626"><a href="#WorldAgent-626"><span class="linenos">626</span></a><span class="sd">        </span>
</span><span id="WorldAgent-627"><a href="#WorldAgent-627"><span class="linenos">627</span></a><span class="sd">        Sends a world state update message to all agents that have subscribed</span>
</span><span id="WorldAgent-628"><a href="#WorldAgent-628"><span class="linenos">628</span></a><span class="sd">        to receive periodic updates. This implements the Publish/Subscribe pattern</span>
</span><span id="WorldAgent-629"><a href="#WorldAgent-629"><span class="linenos">629</span></a><span class="sd">        from FIPA interactions, allowing multiple consumer agents to receive</span>
</span><span id="WorldAgent-630"><a href="#WorldAgent-630"><span class="linenos">630</span></a><span class="sd">        notifications about world state changes without polling.</span>
</span><span id="WorldAgent-631"><a href="#WorldAgent-631"><span class="linenos">631</span></a><span class="sd">        </span>
</span><span id="WorldAgent-632"><a href="#WorldAgent-632"><span class="linenos">632</span></a><span class="sd">        FIPA Publish/Subscribe Pattern:</span>
</span><span id="WorldAgent-633"><a href="#WorldAgent-633"><span class="linenos">633</span></a><span class="sd">        - Sends INFORM messages to all subscribed agents</span>
</span><span id="WorldAgent-634"><a href="#WorldAgent-634"><span class="linenos">634</span></a><span class="sd">        - Includes current simulation tick and infected edge count</span>
</span><span id="WorldAgent-635"><a href="#WorldAgent-635"><span class="linenos">635</span></a><span class="sd">        - Called whenever significant world state changes occur</span>
</span><span id="WorldAgent-636"><a href="#WorldAgent-636"><span class="linenos">636</span></a><span class="sd">        </span>
</span><span id="WorldAgent-637"><a href="#WorldAgent-637"><span class="linenos">637</span></a><span class="sd">        Message Structure:</span>
</span><span id="WorldAgent-638"><a href="#WorldAgent-638"><span class="linenos">638</span></a><span class="sd">        Each broadcast message contains:</span>
</span><span id="WorldAgent-639"><a href="#WorldAgent-639"><span class="linenos">639</span></a><span class="sd">        - type: &quot;world_tick_update&quot; identifying the message type</span>
</span><span id="WorldAgent-640"><a href="#WorldAgent-640"><span class="linenos">640</span></a><span class="sd">        - tick: Current simulation time counter</span>
</span><span id="WorldAgent-641"><a href="#WorldAgent-641"><span class="linenos">641</span></a><span class="sd">        - infected_edges: Current count of traffic-affected edges</span>
</span><span id="WorldAgent-642"><a href="#WorldAgent-642"><span class="linenos">642</span></a><span class="sd">        </span>
</span><span id="WorldAgent-643"><a href="#WorldAgent-643"><span class="linenos">643</span></a><span class="sd">        This method iterates through self.subscribers list and sends a copy</span>
</span><span id="WorldAgent-644"><a href="#WorldAgent-644"><span class="linenos">644</span></a><span class="sd">        of the world update message to each subscriber independently. If a</span>
</span><span id="WorldAgent-645"><a href="#WorldAgent-645"><span class="linenos">645</span></a><span class="sd">        subscriber is no longer available, the XMPP server will handle the</span>
</span><span id="WorldAgent-646"><a href="#WorldAgent-646"><span class="linenos">646</span></a><span class="sd">        delivery failure appropriately.</span>
</span><span id="WorldAgent-647"><a href="#WorldAgent-647"><span class="linenos">647</span></a><span class="sd">        </span>
</span><span id="WorldAgent-648"><a href="#WorldAgent-648"><span class="linenos">648</span></a><span class="sd">        Args:</span>
</span><span id="WorldAgent-649"><a href="#WorldAgent-649"><span class="linenos">649</span></a><span class="sd">            None: Uses self.world and self.subscribers from agent instance</span>
</span><span id="WorldAgent-650"><a href="#WorldAgent-650"><span class="linenos">650</span></a><span class="sd">        </span>
</span><span id="WorldAgent-651"><a href="#WorldAgent-651"><span class="linenos">651</span></a><span class="sd">        Returns:</span>
</span><span id="WorldAgent-652"><a href="#WorldAgent-652"><span class="linenos">652</span></a><span class="sd">            None: Sends messages asynchronously, does not wait for delivery</span>
</span><span id="WorldAgent-653"><a href="#WorldAgent-653"><span class="linenos">653</span></a><span class="sd">        </span>
</span><span id="WorldAgent-654"><a href="#WorldAgent-654"><span class="linenos">654</span></a><span class="sd">        Side Effects:</span>
</span><span id="WorldAgent-655"><a href="#WorldAgent-655"><span class="linenos">655</span></a><span class="sd">            - Sends XMPP MESSAGE stanzas to all subscribers</span>
</span><span id="WorldAgent-656"><a href="#WorldAgent-656"><span class="linenos">656</span></a><span class="sd">            - Does not modify agent state</span>
</span><span id="WorldAgent-657"><a href="#WorldAgent-657"><span class="linenos">657</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorldAgent-658"><a href="#WorldAgent-658"><span class="linenos">658</span></a>        <span class="n">world_update</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="WorldAgent-659"><a href="#WorldAgent-659"><span class="linenos">659</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;world_tick_update&quot;</span><span class="p">,</span>
</span><span id="WorldAgent-660"><a href="#WorldAgent-660"><span class="linenos">660</span></a>            <span class="s2">&quot;tick&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span><span class="p">,</span>
</span><span id="WorldAgent-661"><a href="#WorldAgent-661"><span class="linenos">661</span></a>            <span class="s2">&quot;infected_edges&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">infected_edges</span><span class="p">),</span>
</span><span id="WorldAgent-662"><a href="#WorldAgent-662"><span class="linenos">662</span></a>        <span class="p">}</span>
</span><span id="WorldAgent-663"><a href="#WorldAgent-663"><span class="linenos">663</span></a>        
</span><span id="WorldAgent-664"><a href="#WorldAgent-664"><span class="linenos">664</span></a>        <span class="k">for</span> <span class="n">subscriber</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscribers</span><span class="p">:</span>
</span><span id="WorldAgent-665"><a href="#WorldAgent-665"><span class="linenos">665</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">subscriber</span><span class="p">)</span>
</span><span id="WorldAgent-666"><a href="#WorldAgent-666"><span class="linenos">666</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-667"><a href="#WorldAgent-667"><span class="linenos">667</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">world_update</span><span class="p">)</span>
</span><span id="WorldAgent-668"><a href="#WorldAgent-668"><span class="linenos">668</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent-669"><a href="#WorldAgent-669"><span class="linenos">669</span></a>
</span><span id="WorldAgent-670"><a href="#WorldAgent-670"><span class="linenos">670</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorldAgent-671"><a href="#WorldAgent-671"><span class="linenos">671</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up the WorldAgent with its behaviors.</span>
</span><span id="WorldAgent-672"><a href="#WorldAgent-672"><span class="linenos">672</span></a><span class="sd">        </span>
</span><span id="WorldAgent-673"><a href="#WorldAgent-673"><span class="linenos">673</span></a><span class="sd">        Initializes the WorldAgent by configuring all required attributes,</span>
</span><span id="WorldAgent-674"><a href="#WorldAgent-674"><span class="linenos">674</span></a><span class="sd">        validating the world instance, and registering the agent&#39;s behaviours.</span>
</span><span id="WorldAgent-675"><a href="#WorldAgent-675"><span class="linenos">675</span></a><span class="sd">        This method is called once when the agent starts, before it begins</span>
</span><span id="WorldAgent-676"><a href="#WorldAgent-676"><span class="linenos">676</span></a><span class="sd">        processing messages or executing behaviours.</span>
</span><span id="WorldAgent-677"><a href="#WorldAgent-677"><span class="linenos">677</span></a><span class="sd">        </span>
</span><span id="WorldAgent-678"><a href="#WorldAgent-678"><span class="linenos">678</span></a><span class="sd">        SPADE Agent Lifecycle:</span>
</span><span id="WorldAgent-679"><a href="#WorldAgent-679"><span class="linenos">679</span></a><span class="sd">        - Called automatically by SPADE after agent initialization</span>
</span><span id="WorldAgent-680"><a href="#WorldAgent-680"><span class="linenos">680</span></a><span class="sd">        - Must call parent&#39;s setup if overriding (implicitly done via parent)</span>
</span><span id="WorldAgent-681"><a href="#WorldAgent-681"><span class="linenos">681</span></a><span class="sd">        - Should register all behaviours before returning</span>
</span><span id="WorldAgent-682"><a href="#WorldAgent-682"><span class="linenos">682</span></a><span class="sd">        </span>
</span><span id="WorldAgent-683"><a href="#WorldAgent-683"><span class="linenos">683</span></a><span class="sd">        Initialization Steps:</span>
</span><span id="WorldAgent-684"><a href="#WorldAgent-684"><span class="linenos">684</span></a><span class="sd">        1. Initialize subscribers list if not already present</span>
</span><span id="WorldAgent-685"><a href="#WorldAgent-685"><span class="linenos">685</span></a><span class="sd">        2. Initialize tick_interval (seconds between simulation steps)</span>
</span><span id="WorldAgent-686"><a href="#WorldAgent-686"><span class="linenos">686</span></a><span class="sd">        3. Verify World instance is properly set</span>
</span><span id="WorldAgent-687"><a href="#WorldAgent-687"><span class="linenos">687</span></a><span class="sd">        4. Log diagnostic information about world configuration</span>
</span><span id="WorldAgent-688"><a href="#WorldAgent-688"><span class="linenos">688</span></a><span class="sd">        5. Register TimeDeltaBehaviour with template for specific messages</span>
</span><span id="WorldAgent-689"><a href="#WorldAgent-689"><span class="linenos">689</span></a><span class="sd">        6. Register MessageHandlerBehaviour for general message handling</span>
</span><span id="WorldAgent-690"><a href="#WorldAgent-690"><span class="linenos">690</span></a><span class="sd">        </span>
</span><span id="WorldAgent-691"><a href="#WorldAgent-691"><span class="linenos">691</span></a><span class="sd">        Behaviours Registered:</span>
</span><span id="WorldAgent-692"><a href="#WorldAgent-692"><span class="linenos">692</span></a><span class="sd">        - TimeDeltaBehaviour: Handles time-delta requests and traffic simulation</span>
</span><span id="WorldAgent-693"><a href="#WorldAgent-693"><span class="linenos">693</span></a><span class="sd">          This behaviour uses a template to match messages with specific metadata</span>
</span><span id="WorldAgent-694"><a href="#WorldAgent-694"><span class="linenos">694</span></a><span class="sd">        - MessageHandlerBehaviour: Routes incoming queries to specialized handlers</span>
</span><span id="WorldAgent-695"><a href="#WorldAgent-695"><span class="linenos">695</span></a><span class="sd">          This behaviour runs without template, accepting all remaining messages</span>
</span><span id="WorldAgent-696"><a href="#WorldAgent-696"><span class="linenos">696</span></a><span class="sd">        </span>
</span><span id="WorldAgent-697"><a href="#WorldAgent-697"><span class="linenos">697</span></a><span class="sd">        Warning Conditions:</span>
</span><span id="WorldAgent-698"><a href="#WorldAgent-698"><span class="linenos">698</span></a><span class="sd">        - If world is None, agent will be non-functional but will start</span>
</span><span id="WorldAgent-699"><a href="#WorldAgent-699"><span class="linenos">699</span></a><span class="sd">        - Logs diagnostic warnings to help identify configuration issues</span>
</span><span id="WorldAgent-700"><a href="#WorldAgent-700"><span class="linenos">700</span></a><span class="sd">        </span>
</span><span id="WorldAgent-701"><a href="#WorldAgent-701"><span class="linenos">701</span></a><span class="sd">        Args:</span>
</span><span id="WorldAgent-702"><a href="#WorldAgent-702"><span class="linenos">702</span></a><span class="sd">            None: Uses self attributes set during __init__</span>
</span><span id="WorldAgent-703"><a href="#WorldAgent-703"><span class="linenos">703</span></a><span class="sd">        </span>
</span><span id="WorldAgent-704"><a href="#WorldAgent-704"><span class="linenos">704</span></a><span class="sd">        Returns:</span>
</span><span id="WorldAgent-705"><a href="#WorldAgent-705"><span class="linenos">705</span></a><span class="sd">            None: Configures agent in-place and returns</span>
</span><span id="WorldAgent-706"><a href="#WorldAgent-706"><span class="linenos">706</span></a><span class="sd">        </span>
</span><span id="WorldAgent-707"><a href="#WorldAgent-707"><span class="linenos">707</span></a><span class="sd">        Side Effects:</span>
</span><span id="WorldAgent-708"><a href="#WorldAgent-708"><span class="linenos">708</span></a><span class="sd">            - Initializes self.subscribers to empty list</span>
</span><span id="WorldAgent-709"><a href="#WorldAgent-709"><span class="linenos">709</span></a><span class="sd">            - Sets self.tick_interval to 2 seconds (default)</span>
</span><span id="WorldAgent-710"><a href="#WorldAgent-710"><span class="linenos">710</span></a><span class="sd">            - Registers behaviours with the SPADE framework</span>
</span><span id="WorldAgent-711"><a href="#WorldAgent-711"><span class="linenos">711</span></a><span class="sd">            - Prints diagnostic setup information</span>
</span><span id="WorldAgent-712"><a href="#WorldAgent-712"><span class="linenos">712</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorldAgent-713"><a href="#WorldAgent-713"><span class="linenos">713</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Setting up WorldAgent...&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-714"><a href="#WorldAgent-714"><span class="linenos">714</span></a>        
</span><span id="WorldAgent-715"><a href="#WorldAgent-715"><span class="linenos">715</span></a>        <span class="c1"># Initialize agent attributes if not set</span>
</span><span id="WorldAgent-716"><a href="#WorldAgent-716"><span class="linenos">716</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;subscribers&#39;</span><span class="p">):</span>
</span><span id="WorldAgent-717"><a href="#WorldAgent-717"><span class="linenos">717</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">subscribers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="WorldAgent-718"><a href="#WorldAgent-718"><span class="linenos">718</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;tick_interval&#39;</span><span class="p">):</span>
</span><span id="WorldAgent-719"><a href="#WorldAgent-719"><span class="linenos">719</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tick_interval</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Seconds between world ticks</span>
</span><span id="WorldAgent-720"><a href="#WorldAgent-720"><span class="linenos">720</span></a>        
</span><span id="WorldAgent-721"><a href="#WorldAgent-721"><span class="linenos">721</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="WorldAgent-722"><a href="#WorldAgent-722"><span class="linenos">722</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] World instance provided&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-723"><a href="#WorldAgent-723"><span class="linenos">723</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Grid: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-724"><a href="#WorldAgent-724"><span class="linenos">724</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Seed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-725"><a href="#WorldAgent-725"><span class="linenos">725</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="WorldAgent-726"><a href="#WorldAgent-726"><span class="linenos">726</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] WARNING: No World instance provided!&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-727"><a href="#WorldAgent-727"><span class="linenos">727</span></a>        
</span><span id="WorldAgent-728"><a href="#WorldAgent-728"><span class="linenos">728</span></a>        <span class="c1"># Add time-delta behaviour with template</span>
</span><span id="WorldAgent-729"><a href="#WorldAgent-729"><span class="linenos">729</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="WorldAgent-730"><a href="#WorldAgent-730"><span class="linenos">730</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;request&quot;</span><span class="p">)</span>
</span><span id="WorldAgent-731"><a href="#WorldAgent-731"><span class="linenos">731</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;performative&quot;</span><span class="p">:</span> <span class="s2">&quot;request&quot;</span><span class="p">}</span>
</span><span id="WorldAgent-732"><a href="#WorldAgent-732"><span class="linenos">732</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TimeDeltaBehaviour</span><span class="p">(),</span> <span class="n">template</span><span class="p">)</span>
</span><span id="WorldAgent-733"><a href="#WorldAgent-733"><span class="linenos">733</span></a>        
</span><span id="WorldAgent-734"><a href="#WorldAgent-734"><span class="linenos">734</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MessageHandlerBehaviour</span><span class="p">())</span>
</span><span id="WorldAgent-735"><a href="#WorldAgent-735"><span class="linenos">735</span></a>        
</span><span id="WorldAgent-736"><a href="#WorldAgent-736"><span class="linenos">736</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] WorldAgent setup complete!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A SPADE agent that manages and simulates the supply chain world.</p>

<p>This agent serves as the central coordinator for the supply chain simulation,
managing the world state, executing simulation ticks, and handling communication
with other agents (Store, Warehouse, Supplier, and Event agents). It implements
the FIPA Agent Management Specification for agent discovery and coordination.</p>

<p>The WorldAgent acts as a service provider, offering query services for world
state information and event simulation. It follows FIPA protocols for:</p>

<ul>
<li>Request/Response interactions (for time-delta and traffic simulations)</li>
<li>Inform interactions (for world state broadcasts and query responses)</li>
</ul>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>world (World):</strong>  The World instance containing the graph structure and
simulation state (nodes, edges, facilities, etc.).</li>
<li><strong>subscribers (list):</strong>  A list of agent JIDs subscribed to world state updates.</li>
<li><strong>tick_interval (float):</strong>  Time in seconds between consecutive world ticks.</li>
</ul>

<h6 id="responsibilities">Responsibilities:</h6>

<blockquote>
  <ul>
  <li>Manage and maintain the world state and simulation progress</li>
  <li>Execute world ticks at regular intervals and simulate time progression</li>
  <li>Handle traffic dynamics and traffic simulation requests from Event agents</li>
  <li>Respond to queries from other agents about world state (nodes, edges, facilities)</li>
  <li>Broadcast world state updates to subscribed agents</li>
  <li>Coordinate time-delta simulations with configurable duration</li>
  </ul>
</blockquote>
</div>


                            <div id="WorldAgent.__init__" class="classattr">
                                        <input id="WorldAgent.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">WorldAgent</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">jid</span>, </span><span class="param"><span class="n">password</span>, </span><span class="param"><span class="n">world</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="WorldAgent.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorldAgent.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorldAgent.__init__-41"><a href="#WorldAgent.__init__-41"><span class="linenos">41</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">world</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="WorldAgent.__init__-42"><a href="#WorldAgent.__init__-42"><span class="linenos">42</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the WorldAgent.</span>
</span><span id="WorldAgent.__init__-43"><a href="#WorldAgent.__init__-43"><span class="linenos">43</span></a><span class="sd">        </span>
</span><span id="WorldAgent.__init__-44"><a href="#WorldAgent.__init__-44"><span class="linenos">44</span></a><span class="sd">        Creates a new WorldAgent instance and optionally associates it with a World</span>
</span><span id="WorldAgent.__init__-45"><a href="#WorldAgent.__init__-45"><span class="linenos">45</span></a><span class="sd">        object. The agent initializes with empty subscriber list and default</span>
</span><span id="WorldAgent.__init__-46"><a href="#WorldAgent.__init__-46"><span class="linenos">46</span></a><span class="sd">        tick interval. If no world is provided, it must be set before the agent</span>
</span><span id="WorldAgent.__init__-47"><a href="#WorldAgent.__init__-47"><span class="linenos">47</span></a><span class="sd">        is fully operational.</span>
</span><span id="WorldAgent.__init__-48"><a href="#WorldAgent.__init__-48"><span class="linenos">48</span></a><span class="sd">        </span>
</span><span id="WorldAgent.__init__-49"><a href="#WorldAgent.__init__-49"><span class="linenos">49</span></a><span class="sd">        Args:</span>
</span><span id="WorldAgent.__init__-50"><a href="#WorldAgent.__init__-50"><span class="linenos">50</span></a><span class="sd">            jid (str): The Jabber ID (JID) for this agent on the XMPP server.</span>
</span><span id="WorldAgent.__init__-51"><a href="#WorldAgent.__init__-51"><span class="linenos">51</span></a><span class="sd">                Format: &#39;agent_name@server_address&#39;</span>
</span><span id="WorldAgent.__init__-52"><a href="#WorldAgent.__init__-52"><span class="linenos">52</span></a><span class="sd">            password (str): The authentication password for the agent on the XMPP server.</span>
</span><span id="WorldAgent.__init__-53"><a href="#WorldAgent.__init__-53"><span class="linenos">53</span></a><span class="sd">            world (World, optional): A pre-initialized World instance containing</span>
</span><span id="WorldAgent.__init__-54"><a href="#WorldAgent.__init__-54"><span class="linenos">54</span></a><span class="sd">                the simulation graph and state. If None, must be assigned before</span>
</span><span id="WorldAgent.__init__-55"><a href="#WorldAgent.__init__-55"><span class="linenos">55</span></a><span class="sd">                the agent starts handling simulation requests. Defaults to None.</span>
</span><span id="WorldAgent.__init__-56"><a href="#WorldAgent.__init__-56"><span class="linenos">56</span></a><span class="sd">        </span>
</span><span id="WorldAgent.__init__-57"><a href="#WorldAgent.__init__-57"><span class="linenos">57</span></a><span class="sd">        Returns:</span>
</span><span id="WorldAgent.__init__-58"><a href="#WorldAgent.__init__-58"><span class="linenos">58</span></a><span class="sd">            None: Constructor initializes the parent Agent class and stores references.</span>
</span><span id="WorldAgent.__init__-59"><a href="#WorldAgent.__init__-59"><span class="linenos">59</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorldAgent.__init__-60"><a href="#WorldAgent.__init__-60"><span class="linenos">60</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
</span><span id="WorldAgent.__init__-61"><a href="#WorldAgent.__init__-61"><span class="linenos">61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">world</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the WorldAgent.</p>

<p>Creates a new WorldAgent instance and optionally associates it with a World
object. The agent initializes with empty subscriber list and default
tick interval. If no world is provided, it must be set before the agent
is fully operational.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>jid (str):</strong>  The Jabber ID (JID) for this agent on the XMPP server.
Format: 'agent_name@server_address'</li>
<li><strong>password (str):</strong>  The authentication password for the agent on the XMPP server.</li>
<li><strong>world (World, optional):</strong>  A pre-initialized World instance containing
the simulation graph and state. If None, must be assigned before
the agent starts handling simulation requests. Defaults to None.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: Constructor initializes the parent Agent class and stores references.</p>
</blockquote>
</div>


                            </div>
                            <div id="WorldAgent.world" class="classattr">
                                <div class="attr variable">
            <span class="name">world</span>

        
    </div>
    <a class="headerlink" href="#WorldAgent.world"></a>
    
    

                            </div>
                            <div id="WorldAgent.setup" class="classattr">
                                        <input id="WorldAgent.setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="WorldAgent.setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorldAgent.setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorldAgent.setup-670"><a href="#WorldAgent.setup-670"><span class="linenos">670</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorldAgent.setup-671"><a href="#WorldAgent.setup-671"><span class="linenos">671</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up the WorldAgent with its behaviors.</span>
</span><span id="WorldAgent.setup-672"><a href="#WorldAgent.setup-672"><span class="linenos">672</span></a><span class="sd">        </span>
</span><span id="WorldAgent.setup-673"><a href="#WorldAgent.setup-673"><span class="linenos">673</span></a><span class="sd">        Initializes the WorldAgent by configuring all required attributes,</span>
</span><span id="WorldAgent.setup-674"><a href="#WorldAgent.setup-674"><span class="linenos">674</span></a><span class="sd">        validating the world instance, and registering the agent&#39;s behaviours.</span>
</span><span id="WorldAgent.setup-675"><a href="#WorldAgent.setup-675"><span class="linenos">675</span></a><span class="sd">        This method is called once when the agent starts, before it begins</span>
</span><span id="WorldAgent.setup-676"><a href="#WorldAgent.setup-676"><span class="linenos">676</span></a><span class="sd">        processing messages or executing behaviours.</span>
</span><span id="WorldAgent.setup-677"><a href="#WorldAgent.setup-677"><span class="linenos">677</span></a><span class="sd">        </span>
</span><span id="WorldAgent.setup-678"><a href="#WorldAgent.setup-678"><span class="linenos">678</span></a><span class="sd">        SPADE Agent Lifecycle:</span>
</span><span id="WorldAgent.setup-679"><a href="#WorldAgent.setup-679"><span class="linenos">679</span></a><span class="sd">        - Called automatically by SPADE after agent initialization</span>
</span><span id="WorldAgent.setup-680"><a href="#WorldAgent.setup-680"><span class="linenos">680</span></a><span class="sd">        - Must call parent&#39;s setup if overriding (implicitly done via parent)</span>
</span><span id="WorldAgent.setup-681"><a href="#WorldAgent.setup-681"><span class="linenos">681</span></a><span class="sd">        - Should register all behaviours before returning</span>
</span><span id="WorldAgent.setup-682"><a href="#WorldAgent.setup-682"><span class="linenos">682</span></a><span class="sd">        </span>
</span><span id="WorldAgent.setup-683"><a href="#WorldAgent.setup-683"><span class="linenos">683</span></a><span class="sd">        Initialization Steps:</span>
</span><span id="WorldAgent.setup-684"><a href="#WorldAgent.setup-684"><span class="linenos">684</span></a><span class="sd">        1. Initialize subscribers list if not already present</span>
</span><span id="WorldAgent.setup-685"><a href="#WorldAgent.setup-685"><span class="linenos">685</span></a><span class="sd">        2. Initialize tick_interval (seconds between simulation steps)</span>
</span><span id="WorldAgent.setup-686"><a href="#WorldAgent.setup-686"><span class="linenos">686</span></a><span class="sd">        3. Verify World instance is properly set</span>
</span><span id="WorldAgent.setup-687"><a href="#WorldAgent.setup-687"><span class="linenos">687</span></a><span class="sd">        4. Log diagnostic information about world configuration</span>
</span><span id="WorldAgent.setup-688"><a href="#WorldAgent.setup-688"><span class="linenos">688</span></a><span class="sd">        5. Register TimeDeltaBehaviour with template for specific messages</span>
</span><span id="WorldAgent.setup-689"><a href="#WorldAgent.setup-689"><span class="linenos">689</span></a><span class="sd">        6. Register MessageHandlerBehaviour for general message handling</span>
</span><span id="WorldAgent.setup-690"><a href="#WorldAgent.setup-690"><span class="linenos">690</span></a><span class="sd">        </span>
</span><span id="WorldAgent.setup-691"><a href="#WorldAgent.setup-691"><span class="linenos">691</span></a><span class="sd">        Behaviours Registered:</span>
</span><span id="WorldAgent.setup-692"><a href="#WorldAgent.setup-692"><span class="linenos">692</span></a><span class="sd">        - TimeDeltaBehaviour: Handles time-delta requests and traffic simulation</span>
</span><span id="WorldAgent.setup-693"><a href="#WorldAgent.setup-693"><span class="linenos">693</span></a><span class="sd">          This behaviour uses a template to match messages with specific metadata</span>
</span><span id="WorldAgent.setup-694"><a href="#WorldAgent.setup-694"><span class="linenos">694</span></a><span class="sd">        - MessageHandlerBehaviour: Routes incoming queries to specialized handlers</span>
</span><span id="WorldAgent.setup-695"><a href="#WorldAgent.setup-695"><span class="linenos">695</span></a><span class="sd">          This behaviour runs without template, accepting all remaining messages</span>
</span><span id="WorldAgent.setup-696"><a href="#WorldAgent.setup-696"><span class="linenos">696</span></a><span class="sd">        </span>
</span><span id="WorldAgent.setup-697"><a href="#WorldAgent.setup-697"><span class="linenos">697</span></a><span class="sd">        Warning Conditions:</span>
</span><span id="WorldAgent.setup-698"><a href="#WorldAgent.setup-698"><span class="linenos">698</span></a><span class="sd">        - If world is None, agent will be non-functional but will start</span>
</span><span id="WorldAgent.setup-699"><a href="#WorldAgent.setup-699"><span class="linenos">699</span></a><span class="sd">        - Logs diagnostic warnings to help identify configuration issues</span>
</span><span id="WorldAgent.setup-700"><a href="#WorldAgent.setup-700"><span class="linenos">700</span></a><span class="sd">        </span>
</span><span id="WorldAgent.setup-701"><a href="#WorldAgent.setup-701"><span class="linenos">701</span></a><span class="sd">        Args:</span>
</span><span id="WorldAgent.setup-702"><a href="#WorldAgent.setup-702"><span class="linenos">702</span></a><span class="sd">            None: Uses self attributes set during __init__</span>
</span><span id="WorldAgent.setup-703"><a href="#WorldAgent.setup-703"><span class="linenos">703</span></a><span class="sd">        </span>
</span><span id="WorldAgent.setup-704"><a href="#WorldAgent.setup-704"><span class="linenos">704</span></a><span class="sd">        Returns:</span>
</span><span id="WorldAgent.setup-705"><a href="#WorldAgent.setup-705"><span class="linenos">705</span></a><span class="sd">            None: Configures agent in-place and returns</span>
</span><span id="WorldAgent.setup-706"><a href="#WorldAgent.setup-706"><span class="linenos">706</span></a><span class="sd">        </span>
</span><span id="WorldAgent.setup-707"><a href="#WorldAgent.setup-707"><span class="linenos">707</span></a><span class="sd">        Side Effects:</span>
</span><span id="WorldAgent.setup-708"><a href="#WorldAgent.setup-708"><span class="linenos">708</span></a><span class="sd">            - Initializes self.subscribers to empty list</span>
</span><span id="WorldAgent.setup-709"><a href="#WorldAgent.setup-709"><span class="linenos">709</span></a><span class="sd">            - Sets self.tick_interval to 2 seconds (default)</span>
</span><span id="WorldAgent.setup-710"><a href="#WorldAgent.setup-710"><span class="linenos">710</span></a><span class="sd">            - Registers behaviours with the SPADE framework</span>
</span><span id="WorldAgent.setup-711"><a href="#WorldAgent.setup-711"><span class="linenos">711</span></a><span class="sd">            - Prints diagnostic setup information</span>
</span><span id="WorldAgent.setup-712"><a href="#WorldAgent.setup-712"><span class="linenos">712</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorldAgent.setup-713"><a href="#WorldAgent.setup-713"><span class="linenos">713</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Setting up WorldAgent...&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.setup-714"><a href="#WorldAgent.setup-714"><span class="linenos">714</span></a>        
</span><span id="WorldAgent.setup-715"><a href="#WorldAgent.setup-715"><span class="linenos">715</span></a>        <span class="c1"># Initialize agent attributes if not set</span>
</span><span id="WorldAgent.setup-716"><a href="#WorldAgent.setup-716"><span class="linenos">716</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;subscribers&#39;</span><span class="p">):</span>
</span><span id="WorldAgent.setup-717"><a href="#WorldAgent.setup-717"><span class="linenos">717</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">subscribers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="WorldAgent.setup-718"><a href="#WorldAgent.setup-718"><span class="linenos">718</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;tick_interval&#39;</span><span class="p">):</span>
</span><span id="WorldAgent.setup-719"><a href="#WorldAgent.setup-719"><span class="linenos">719</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tick_interval</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Seconds between world ticks</span>
</span><span id="WorldAgent.setup-720"><a href="#WorldAgent.setup-720"><span class="linenos">720</span></a>        
</span><span id="WorldAgent.setup-721"><a href="#WorldAgent.setup-721"><span class="linenos">721</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="WorldAgent.setup-722"><a href="#WorldAgent.setup-722"><span class="linenos">722</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] World instance provided&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.setup-723"><a href="#WorldAgent.setup-723"><span class="linenos">723</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Grid: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.setup-724"><a href="#WorldAgent.setup-724"><span class="linenos">724</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Seed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.setup-725"><a href="#WorldAgent.setup-725"><span class="linenos">725</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="WorldAgent.setup-726"><a href="#WorldAgent.setup-726"><span class="linenos">726</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] WARNING: No World instance provided!&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.setup-727"><a href="#WorldAgent.setup-727"><span class="linenos">727</span></a>        
</span><span id="WorldAgent.setup-728"><a href="#WorldAgent.setup-728"><span class="linenos">728</span></a>        <span class="c1"># Add time-delta behaviour with template</span>
</span><span id="WorldAgent.setup-729"><a href="#WorldAgent.setup-729"><span class="linenos">729</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="WorldAgent.setup-730"><a href="#WorldAgent.setup-730"><span class="linenos">730</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;request&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.setup-731"><a href="#WorldAgent.setup-731"><span class="linenos">731</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;performative&quot;</span><span class="p">:</span> <span class="s2">&quot;request&quot;</span><span class="p">}</span>
</span><span id="WorldAgent.setup-732"><a href="#WorldAgent.setup-732"><span class="linenos">732</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TimeDeltaBehaviour</span><span class="p">(),</span> <span class="n">template</span><span class="p">)</span>
</span><span id="WorldAgent.setup-733"><a href="#WorldAgent.setup-733"><span class="linenos">733</span></a>        
</span><span id="WorldAgent.setup-734"><a href="#WorldAgent.setup-734"><span class="linenos">734</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MessageHandlerBehaviour</span><span class="p">())</span>
</span><span id="WorldAgent.setup-735"><a href="#WorldAgent.setup-735"><span class="linenos">735</span></a>        
</span><span id="WorldAgent.setup-736"><a href="#WorldAgent.setup-736"><span class="linenos">736</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] WorldAgent setup complete!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Set up the WorldAgent with its behaviors.</p>

<p>Initializes the WorldAgent by configuring all required attributes,
validating the world instance, and registering the agent's behaviours.
This method is called once when the agent starts, before it begins
processing messages or executing behaviours.</p>

<p>SPADE Agent Lifecycle:</p>

<ul>
<li>Called automatically by SPADE after agent initialization</li>
<li>Must call parent's setup if overriding (implicitly done via parent)</li>
<li>Should register all behaviours before returning</li>
</ul>

<p>Initialization Steps:</p>

<ol>
<li>Initialize subscribers list if not already present</li>
<li>Initialize tick_interval (seconds between simulation steps)</li>
<li>Verify World instance is properly set</li>
<li>Log diagnostic information about world configuration</li>
<li>Register TimeDeltaBehaviour with template for specific messages</li>
<li>Register MessageHandlerBehaviour for general message handling</li>
</ol>

<p>Behaviours Registered:</p>

<ul>
<li>TimeDeltaBehaviour: Handles time-delta requests and traffic simulation
This behaviour uses a template to match messages with specific metadata</li>
<li>MessageHandlerBehaviour: Routes incoming queries to specialized handlers
This behaviour runs without template, accepting all remaining messages</li>
</ul>

<p>Warning Conditions:</p>

<ul>
<li>If world is None, agent will be non-functional but will start</li>
<li>Logs diagnostic warnings to help identify configuration issues</li>
</ul>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>None:</strong>  Uses self attributes set during __init__</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: Configures agent in-place and returns</p>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Initializes self.subscribers to empty list</li>
  <li>Sets self.tick_interval to 2 seconds (default)</li>
  <li>Registers behaviours with the SPADE framework</li>
  <li>Prints diagnostic setup information</li>
  </ul>
</blockquote>
</div>


                            </div>
                </section>
                <section id="WorldAgent.TimeDeltaBehaviour">
                            <input id="WorldAgent.TimeDeltaBehaviour-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">WorldAgent.TimeDeltaBehaviour</span><wbr>(<span class="base">spade.behaviour.CyclicBehaviour</span>):

                <label class="view-source-button" for="WorldAgent.TimeDeltaBehaviour-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorldAgent.TimeDeltaBehaviour"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorldAgent.TimeDeltaBehaviour-63"><a href="#WorldAgent.TimeDeltaBehaviour-63"><span class="linenos"> 63</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">TimeDeltaBehaviour</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-64"><a href="#WorldAgent.TimeDeltaBehaviour-64"><span class="linenos"> 64</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles time-delta simulation requests and traffic simulation requests.</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-65"><a href="#WorldAgent.TimeDeltaBehaviour-65"><span class="linenos"> 65</span></a><span class="sd">        </span>
</span><span id="WorldAgent.TimeDeltaBehaviour-66"><a href="#WorldAgent.TimeDeltaBehaviour-66"><span class="linenos"> 66</span></a><span class="sd">        This behaviour implements FIPA Request/Response protocol for handling two types</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-67"><a href="#WorldAgent.TimeDeltaBehaviour-67"><span class="linenos"> 67</span></a><span class="sd">        of simulation requests from other agents:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-68"><a href="#WorldAgent.TimeDeltaBehaviour-68"><span class="linenos"> 68</span></a><span class="sd">        </span>
</span><span id="WorldAgent.TimeDeltaBehaviour-69"><a href="#WorldAgent.TimeDeltaBehaviour-69"><span class="linenos"> 69</span></a><span class="sd">        1. Traffic Simulation Requests: Receive requests from Event agents to simulate</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-70"><a href="#WorldAgent.TimeDeltaBehaviour-70"><span class="linenos"> 70</span></a><span class="sd">           traffic dynamics. Processes &quot;simulate_traffic&quot; action requests, runs the</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-71"><a href="#WorldAgent.TimeDeltaBehaviour-71"><span class="linenos"> 71</span></a><span class="sd">           simulation for the specified duration, and returns generated traffic events.</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-72"><a href="#WorldAgent.TimeDeltaBehaviour-72"><span class="linenos"> 72</span></a><span class="sd">        </span>
</span><span id="WorldAgent.TimeDeltaBehaviour-73"><a href="#WorldAgent.TimeDeltaBehaviour-73"><span class="linenos"> 73</span></a><span class="sd">        2. Time-Delta Requests: Receive requests to advance the simulation by a</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-74"><a href="#WorldAgent.TimeDeltaBehaviour-74"><span class="linenos"> 74</span></a><span class="sd">           specified number of ticks. Tracks edge weight changes (travel times and</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-75"><a href="#WorldAgent.TimeDeltaBehaviour-75"><span class="linenos"> 75</span></a><span class="sd">           fuel consumption) during the simulation period and returns detailed</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-76"><a href="#WorldAgent.TimeDeltaBehaviour-76"><span class="linenos"> 76</span></a><span class="sd">           information about which edges changed and when.</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-77"><a href="#WorldAgent.TimeDeltaBehaviour-77"><span class="linenos"> 77</span></a><span class="sd">        </span>
</span><span id="WorldAgent.TimeDeltaBehaviour-78"><a href="#WorldAgent.TimeDeltaBehaviour-78"><span class="linenos"> 78</span></a><span class="sd">        FIPA Protocol Compliance:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-79"><a href="#WorldAgent.TimeDeltaBehaviour-79"><span class="linenos"> 79</span></a><span class="sd">        - Implements the FIPA Request interaction protocol</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-80"><a href="#WorldAgent.TimeDeltaBehaviour-80"><span class="linenos"> 80</span></a><span class="sd">        - Receives REQUEST messages with performative=&quot;request&quot;</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-81"><a href="#WorldAgent.TimeDeltaBehaviour-81"><span class="linenos"> 81</span></a><span class="sd">        - Sends back INFORM messages with performative=&quot;inform&quot;</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-82"><a href="#WorldAgent.TimeDeltaBehaviour-82"><span class="linenos"> 82</span></a><span class="sd">        - Gracefully handles protocol violations with JSON decode errors</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-83"><a href="#WorldAgent.TimeDeltaBehaviour-83"><span class="linenos"> 83</span></a><span class="sd">        </span>
</span><span id="WorldAgent.TimeDeltaBehaviour-84"><a href="#WorldAgent.TimeDeltaBehaviour-84"><span class="linenos"> 84</span></a><span class="sd">        This behaviour runs cyclically (continuously) checking for incoming messages</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-85"><a href="#WorldAgent.TimeDeltaBehaviour-85"><span class="linenos"> 85</span></a><span class="sd">        with a timeout to prevent blocking the agent&#39;s other behaviours.</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-86"><a href="#WorldAgent.TimeDeltaBehaviour-86"><span class="linenos"> 86</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-87"><a href="#WorldAgent.TimeDeltaBehaviour-87"><span class="linenos"> 87</span></a>        
</span><span id="WorldAgent.TimeDeltaBehaviour-88"><a href="#WorldAgent.TimeDeltaBehaviour-88"><span class="linenos"> 88</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-89"><a href="#WorldAgent.TimeDeltaBehaviour-89"><span class="linenos"> 89</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Process time-delta messages and simulate world.</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-90"><a href="#WorldAgent.TimeDeltaBehaviour-90"><span class="linenos"> 90</span></a><span class="sd">            </span>
</span><span id="WorldAgent.TimeDeltaBehaviour-91"><a href="#WorldAgent.TimeDeltaBehaviour-91"><span class="linenos"> 91</span></a><span class="sd">            Executes one iteration of the cyclic behaviour. This method:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-92"><a href="#WorldAgent.TimeDeltaBehaviour-92"><span class="linenos"> 92</span></a><span class="sd">            1. Waits for incoming messages with a 1-second timeout</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-93"><a href="#WorldAgent.TimeDeltaBehaviour-93"><span class="linenos"> 93</span></a><span class="sd">            2. If a message is received, parses its JSON content</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-94"><a href="#WorldAgent.TimeDeltaBehaviour-94"><span class="linenos"> 94</span></a><span class="sd">            3. Identifies the message type (traffic simulation or time-delta)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-95"><a href="#WorldAgent.TimeDeltaBehaviour-95"><span class="linenos"> 95</span></a><span class="sd">            4. Routes to appropriate handler based on action metadata</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-96"><a href="#WorldAgent.TimeDeltaBehaviour-96"><span class="linenos"> 96</span></a><span class="sd">            5. Sends response back to sender with simulation results</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-97"><a href="#WorldAgent.TimeDeltaBehaviour-97"><span class="linenos"> 97</span></a><span class="sd">            6. Handles exceptions gracefully, logging errors</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-98"><a href="#WorldAgent.TimeDeltaBehaviour-98"><span class="linenos"> 98</span></a><span class="sd">            </span>
</span><span id="WorldAgent.TimeDeltaBehaviour-99"><a href="#WorldAgent.TimeDeltaBehaviour-99"><span class="linenos"> 99</span></a><span class="sd">            The method operates on two distinct message types:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-100"><a href="#WorldAgent.TimeDeltaBehaviour-100"><span class="linenos">100</span></a><span class="sd">            - Traffic Simulation: Calls world.get_events() to simulate traffic</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-101"><a href="#WorldAgent.TimeDeltaBehaviour-101"><span class="linenos">101</span></a><span class="sd">            - Time-Delta: Simulates multiple ticks and tracks edge state changes</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-102"><a href="#WorldAgent.TimeDeltaBehaviour-102"><span class="linenos">102</span></a><span class="sd">            </span>
</span><span id="WorldAgent.TimeDeltaBehaviour-103"><a href="#WorldAgent.TimeDeltaBehaviour-103"><span class="linenos">103</span></a><span class="sd">            For time-delta requests, the behaviour:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-104"><a href="#WorldAgent.TimeDeltaBehaviour-104"><span class="linenos">104</span></a><span class="sd">            - Records initial edge weights before simulation</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-105"><a href="#WorldAgent.TimeDeltaBehaviour-105"><span class="linenos">105</span></a><span class="sd">            - Executes the requested number of ticks sequentially</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-106"><a href="#WorldAgent.TimeDeltaBehaviour-106"><span class="linenos">106</span></a><span class="sd">            - For each edge that changes, calculates fuel consumption</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-107"><a href="#WorldAgent.TimeDeltaBehaviour-107"><span class="linenos">107</span></a><span class="sd">            - Tracks the tick index where each change occurred</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-108"><a href="#WorldAgent.TimeDeltaBehaviour-108"><span class="linenos">108</span></a><span class="sd">            - Returns complete change history to the requester</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-109"><a href="#WorldAgent.TimeDeltaBehaviour-109"><span class="linenos">109</span></a><span class="sd">            </span>
</span><span id="WorldAgent.TimeDeltaBehaviour-110"><a href="#WorldAgent.TimeDeltaBehaviour-110"><span class="linenos">110</span></a><span class="sd">            Raises:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-111"><a href="#WorldAgent.TimeDeltaBehaviour-111"><span class="linenos">111</span></a><span class="sd">                json.JSONDecodeError: If message body is invalid JSON (logged, not raised)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-112"><a href="#WorldAgent.TimeDeltaBehaviour-112"><span class="linenos">112</span></a><span class="sd">                Exception: Any other runtime error (logged, not raised)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-113"><a href="#WorldAgent.TimeDeltaBehaviour-113"><span class="linenos">113</span></a><span class="sd">            </span>
</span><span id="WorldAgent.TimeDeltaBehaviour-114"><a href="#WorldAgent.TimeDeltaBehaviour-114"><span class="linenos">114</span></a><span class="sd">            Yields:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-115"><a href="#WorldAgent.TimeDeltaBehaviour-115"><span class="linenos">115</span></a><span class="sd">                None: This cyclic behaviour continues indefinitely</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-116"><a href="#WorldAgent.TimeDeltaBehaviour-116"><span class="linenos">116</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-117"><a href="#WorldAgent.TimeDeltaBehaviour-117"><span class="linenos">117</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-118"><a href="#WorldAgent.TimeDeltaBehaviour-118"><span class="linenos">118</span></a>            
</span><span id="WorldAgent.TimeDeltaBehaviour-119"><a href="#WorldAgent.TimeDeltaBehaviour-119"><span class="linenos">119</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-120"><a href="#WorldAgent.TimeDeltaBehaviour-120"><span class="linenos">120</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-121"><a href="#WorldAgent.TimeDeltaBehaviour-121"><span class="linenos">121</span></a>                    <span class="c1"># Check if it&#39;s a traffic simulation request from event agent</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-122"><a href="#WorldAgent.TimeDeltaBehaviour-122"><span class="linenos">122</span></a>                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;request&quot;</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;simulate_traffic&quot;</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-123"><a href="#WorldAgent.TimeDeltaBehaviour-123"><span class="linenos">123</span></a>                        <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-124"><a href="#WorldAgent.TimeDeltaBehaviour-124"><span class="linenos">124</span></a>                        <span class="n">simulation_time</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simulation_time&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-125"><a href="#WorldAgent.TimeDeltaBehaviour-125"><span class="linenos">125</span></a>                        <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-126"><a href="#WorldAgent.TimeDeltaBehaviour-126"><span class="linenos">126</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour-127"><a href="#WorldAgent.TimeDeltaBehaviour-127"><span class="linenos">127</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Traffic simulation request received&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-128"><a href="#WorldAgent.TimeDeltaBehaviour-128"><span class="linenos">128</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sender: </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-129"><a href="#WorldAgent.TimeDeltaBehaviour-129"><span class="linenos">129</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Simulation time: </span><span class="si">{</span><span class="n">simulation_time</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-130"><a href="#WorldAgent.TimeDeltaBehaviour-130"><span class="linenos">130</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour-131"><a href="#WorldAgent.TimeDeltaBehaviour-131"><span class="linenos">131</span></a>                        <span class="c1"># Simulate traffic events using get_events</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-132"><a href="#WorldAgent.TimeDeltaBehaviour-132"><span class="linenos">132</span></a>                        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">simulation_time</span><span class="p">))</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-133"><a href="#WorldAgent.TimeDeltaBehaviour-133"><span class="linenos">133</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour-134"><a href="#WorldAgent.TimeDeltaBehaviour-134"><span class="linenos">134</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Simulation completed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="si">}</span><span class="s2"> events generated&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-135"><a href="#WorldAgent.TimeDeltaBehaviour-135"><span class="linenos">135</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour-136"><a href="#WorldAgent.TimeDeltaBehaviour-136"><span class="linenos">136</span></a>                        <span class="c1"># Send response with traffic events (FIPA Inform)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-137"><a href="#WorldAgent.TimeDeltaBehaviour-137"><span class="linenos">137</span></a>                        <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-138"><a href="#WorldAgent.TimeDeltaBehaviour-138"><span class="linenos">138</span></a>                        <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-139"><a href="#WorldAgent.TimeDeltaBehaviour-139"><span class="linenos">139</span></a>                        <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;traffic_events&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-140"><a href="#WorldAgent.TimeDeltaBehaviour-140"><span class="linenos">140</span></a>                        <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-141"><a href="#WorldAgent.TimeDeltaBehaviour-141"><span class="linenos">141</span></a>                            <span class="s2">&quot;events&quot;</span><span class="p">:</span> <span class="n">events</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-142"><a href="#WorldAgent.TimeDeltaBehaviour-142"><span class="linenos">142</span></a>                            <span class="s2">&quot;simulation_time&quot;</span><span class="p">:</span> <span class="n">simulation_time</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-143"><a href="#WorldAgent.TimeDeltaBehaviour-143"><span class="linenos">143</span></a>                        <span class="p">})</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-144"><a href="#WorldAgent.TimeDeltaBehaviour-144"><span class="linenos">144</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-145"><a href="#WorldAgent.TimeDeltaBehaviour-145"><span class="linenos">145</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour-146"><a href="#WorldAgent.TimeDeltaBehaviour-146"><span class="linenos">146</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Traffic events sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-147"><a href="#WorldAgent.TimeDeltaBehaviour-147"><span class="linenos">147</span></a>                        <span class="k">return</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-148"><a href="#WorldAgent.TimeDeltaBehaviour-148"><span class="linenos">148</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour-149"><a href="#WorldAgent.TimeDeltaBehaviour-149"><span class="linenos">149</span></a>                    <span class="c1"># Handle normal time-delta requests (FIPA Request/Response pattern)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-150"><a href="#WorldAgent.TimeDeltaBehaviour-150"><span class="linenos">150</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-151"><a href="#WorldAgent.TimeDeltaBehaviour-151"><span class="linenos">151</span></a>                    <span class="n">delta_time</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delta_time&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-152"><a href="#WorldAgent.TimeDeltaBehaviour-152"><span class="linenos">152</span></a>                    <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-153"><a href="#WorldAgent.TimeDeltaBehaviour-153"><span class="linenos">153</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour-154"><a href="#WorldAgent.TimeDeltaBehaviour-154"><span class="linenos">154</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Received time-delta request: </span><span class="si">{</span><span class="n">delta_time</span><span class="si">}</span><span class="s2"> ticks from </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-155"><a href="#WorldAgent.TimeDeltaBehaviour-155"><span class="linenos">155</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour-156"><a href="#WorldAgent.TimeDeltaBehaviour-156"><span class="linenos">156</span></a>                    <span class="c1"># Store initial edge states for change detection</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-157"><a href="#WorldAgent.TimeDeltaBehaviour-157"><span class="linenos">157</span></a>                    <span class="n">initial_states</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-158"><a href="#WorldAgent.TimeDeltaBehaviour-158"><span class="linenos">158</span></a>                    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-159"><a href="#WorldAgent.TimeDeltaBehaviour-159"><span class="linenos">159</span></a>                        <span class="n">initial_states</span><span class="p">[(</span><span class="n">edge</span><span class="o">.</span><span class="n">node1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-160"><a href="#WorldAgent.TimeDeltaBehaviour-160"><span class="linenos">160</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour-161"><a href="#WorldAgent.TimeDeltaBehaviour-161"><span class="linenos">161</span></a>                    <span class="c1"># Simulate delta_time ticks and track changes</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-162"><a href="#WorldAgent.TimeDeltaBehaviour-162"><span class="linenos">162</span></a>                    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-163"><a href="#WorldAgent.TimeDeltaBehaviour-163"><span class="linenos">163</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">delta_time</span><span class="p">):</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-164"><a href="#WorldAgent.TimeDeltaBehaviour-164"><span class="linenos">164</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Simulate one tick at a time</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-165"><a href="#WorldAgent.TimeDeltaBehaviour-165"><span class="linenos">165</span></a>                        <span class="n">current_tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-166"><a href="#WorldAgent.TimeDeltaBehaviour-166"><span class="linenos">166</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour-167"><a href="#WorldAgent.TimeDeltaBehaviour-167"><span class="linenos">167</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Simulated tick </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">delta_time</span><span class="si">}</span><span class="s2"> (current tick: </span><span class="si">{</span><span class="n">current_tick</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-168"><a href="#WorldAgent.TimeDeltaBehaviour-168"><span class="linenos">168</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour-169"><a href="#WorldAgent.TimeDeltaBehaviour-169"><span class="linenos">169</span></a>                        <span class="c1"># Check which edges changed in this tick</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-170"><a href="#WorldAgent.TimeDeltaBehaviour-170"><span class="linenos">170</span></a>                        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-171"><a href="#WorldAgent.TimeDeltaBehaviour-171"><span class="linenos">171</span></a>                            <span class="n">edge_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">node1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-172"><a href="#WorldAgent.TimeDeltaBehaviour-172"><span class="linenos">172</span></a>                            <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">!=</span> <span class="n">initial_states</span><span class="p">[</span><span class="n">edge_key</span><span class="p">]:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-173"><a href="#WorldAgent.TimeDeltaBehaviour-173"><span class="linenos">173</span></a>                                <span class="c1"># Edge changed - record the instant (tick index)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-174"><a href="#WorldAgent.TimeDeltaBehaviour-174"><span class="linenos">174</span></a>                                <span class="n">edge</span><span class="o">.</span><span class="n">calculate_fuel_consumption</span><span class="p">()</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-175"><a href="#WorldAgent.TimeDeltaBehaviour-175"><span class="linenos">175</span></a>                                <span class="n">edge_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-176"><a href="#WorldAgent.TimeDeltaBehaviour-176"><span class="linenos">176</span></a>                                    <span class="s2">&quot;node1_id&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">node1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-177"><a href="#WorldAgent.TimeDeltaBehaviour-177"><span class="linenos">177</span></a>                                    <span class="s2">&quot;node2_id&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-178"><a href="#WorldAgent.TimeDeltaBehaviour-178"><span class="linenos">178</span></a>                                    <span class="s2">&quot;new_time&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-179"><a href="#WorldAgent.TimeDeltaBehaviour-179"><span class="linenos">179</span></a>                                    <span class="s2">&quot;new_fuel_consumption&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">fuel_consumption</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-180"><a href="#WorldAgent.TimeDeltaBehaviour-180"><span class="linenos">180</span></a>                                    <span class="s2">&quot;instant&quot;</span><span class="p">:</span> <span class="n">i</span>  <span class="c1"># The tick index when it changed</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-181"><a href="#WorldAgent.TimeDeltaBehaviour-181"><span class="linenos">181</span></a>                                <span class="p">}</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-182"><a href="#WorldAgent.TimeDeltaBehaviour-182"><span class="linenos">182</span></a>                                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_info</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-183"><a href="#WorldAgent.TimeDeltaBehaviour-183"><span class="linenos">183</span></a>                                <span class="c1"># Update the initial state to current state</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-184"><a href="#WorldAgent.TimeDeltaBehaviour-184"><span class="linenos">184</span></a>                                <span class="n">initial_states</span><span class="p">[</span><span class="n">edge_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-185"><a href="#WorldAgent.TimeDeltaBehaviour-185"><span class="linenos">185</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour-186"><a href="#WorldAgent.TimeDeltaBehaviour-186"><span class="linenos">186</span></a>                    <span class="c1"># Send response with all edge states (FIPA Inform)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-187"><a href="#WorldAgent.TimeDeltaBehaviour-187"><span class="linenos">187</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-188"><a href="#WorldAgent.TimeDeltaBehaviour-188"><span class="linenos">188</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-189"><a href="#WorldAgent.TimeDeltaBehaviour-189"><span class="linenos">189</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-190"><a href="#WorldAgent.TimeDeltaBehaviour-190"><span class="linenos">190</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;time_delta_response&quot;</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-191"><a href="#WorldAgent.TimeDeltaBehaviour-191"><span class="linenos">191</span></a>                        <span class="s2">&quot;delta_time&quot;</span><span class="p">:</span> <span class="n">delta_time</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-192"><a href="#WorldAgent.TimeDeltaBehaviour-192"><span class="linenos">192</span></a>                        <span class="s2">&quot;final_tick&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-193"><a href="#WorldAgent.TimeDeltaBehaviour-193"><span class="linenos">193</span></a>                        <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="n">results</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-194"><a href="#WorldAgent.TimeDeltaBehaviour-194"><span class="linenos">194</span></a>                    <span class="p">})</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-195"><a href="#WorldAgent.TimeDeltaBehaviour-195"><span class="linenos">195</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-196"><a href="#WorldAgent.TimeDeltaBehaviour-196"><span class="linenos">196</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour-197"><a href="#WorldAgent.TimeDeltaBehaviour-197"><span class="linenos">197</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Sent time-delta response with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> edge updates&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-198"><a href="#WorldAgent.TimeDeltaBehaviour-198"><span class="linenos">198</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour-199"><a href="#WorldAgent.TimeDeltaBehaviour-199"><span class="linenos">199</span></a>                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-200"><a href="#WorldAgent.TimeDeltaBehaviour-200"><span class="linenos">200</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error decoding time-delta message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-201"><a href="#WorldAgent.TimeDeltaBehaviour-201"><span class="linenos">201</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour-202"><a href="#WorldAgent.TimeDeltaBehaviour-202"><span class="linenos">202</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error in TimeDeltaBehaviour: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Handles time-delta simulation requests and traffic simulation requests.</p>

<p>This behaviour implements FIPA Request/Response protocol for handling two types
of simulation requests from other agents:</p>

<ol>
<li><p>Traffic Simulation Requests: Receive requests from Event agents to simulate
traffic dynamics. Processes "simulate_traffic" action requests, runs the
simulation for the specified duration, and returns generated traffic events.</p></li>
<li><p>Time-Delta Requests: Receive requests to advance the simulation by a
specified number of ticks. Tracks edge weight changes (travel times and
fuel consumption) during the simulation period and returns detailed
information about which edges changed and when.</p></li>
</ol>

<p>FIPA Protocol Compliance:</p>

<ul>
<li>Implements the FIPA Request interaction protocol</li>
<li>Receives REQUEST messages with performative="request"</li>
<li>Sends back INFORM messages with performative="inform"</li>
<li>Gracefully handles protocol violations with JSON decode errors</li>
</ul>

<p>This behaviour runs cyclically (continuously) checking for incoming messages
with a timeout to prevent blocking the agent's other behaviours.</p>
</div>


                            <div id="WorldAgent.TimeDeltaBehaviour.run" class="classattr">
                                        <input id="WorldAgent.TimeDeltaBehaviour.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="WorldAgent.TimeDeltaBehaviour.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorldAgent.TimeDeltaBehaviour.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorldAgent.TimeDeltaBehaviour.run-88"><a href="#WorldAgent.TimeDeltaBehaviour.run-88"><span class="linenos"> 88</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-89"><a href="#WorldAgent.TimeDeltaBehaviour.run-89"><span class="linenos"> 89</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Process time-delta messages and simulate world.</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-90"><a href="#WorldAgent.TimeDeltaBehaviour.run-90"><span class="linenos"> 90</span></a><span class="sd">            </span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-91"><a href="#WorldAgent.TimeDeltaBehaviour.run-91"><span class="linenos"> 91</span></a><span class="sd">            Executes one iteration of the cyclic behaviour. This method:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-92"><a href="#WorldAgent.TimeDeltaBehaviour.run-92"><span class="linenos"> 92</span></a><span class="sd">            1. Waits for incoming messages with a 1-second timeout</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-93"><a href="#WorldAgent.TimeDeltaBehaviour.run-93"><span class="linenos"> 93</span></a><span class="sd">            2. If a message is received, parses its JSON content</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-94"><a href="#WorldAgent.TimeDeltaBehaviour.run-94"><span class="linenos"> 94</span></a><span class="sd">            3. Identifies the message type (traffic simulation or time-delta)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-95"><a href="#WorldAgent.TimeDeltaBehaviour.run-95"><span class="linenos"> 95</span></a><span class="sd">            4. Routes to appropriate handler based on action metadata</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-96"><a href="#WorldAgent.TimeDeltaBehaviour.run-96"><span class="linenos"> 96</span></a><span class="sd">            5. Sends response back to sender with simulation results</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-97"><a href="#WorldAgent.TimeDeltaBehaviour.run-97"><span class="linenos"> 97</span></a><span class="sd">            6. Handles exceptions gracefully, logging errors</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-98"><a href="#WorldAgent.TimeDeltaBehaviour.run-98"><span class="linenos"> 98</span></a><span class="sd">            </span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-99"><a href="#WorldAgent.TimeDeltaBehaviour.run-99"><span class="linenos"> 99</span></a><span class="sd">            The method operates on two distinct message types:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-100"><a href="#WorldAgent.TimeDeltaBehaviour.run-100"><span class="linenos">100</span></a><span class="sd">            - Traffic Simulation: Calls world.get_events() to simulate traffic</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-101"><a href="#WorldAgent.TimeDeltaBehaviour.run-101"><span class="linenos">101</span></a><span class="sd">            - Time-Delta: Simulates multiple ticks and tracks edge state changes</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-102"><a href="#WorldAgent.TimeDeltaBehaviour.run-102"><span class="linenos">102</span></a><span class="sd">            </span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-103"><a href="#WorldAgent.TimeDeltaBehaviour.run-103"><span class="linenos">103</span></a><span class="sd">            For time-delta requests, the behaviour:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-104"><a href="#WorldAgent.TimeDeltaBehaviour.run-104"><span class="linenos">104</span></a><span class="sd">            - Records initial edge weights before simulation</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-105"><a href="#WorldAgent.TimeDeltaBehaviour.run-105"><span class="linenos">105</span></a><span class="sd">            - Executes the requested number of ticks sequentially</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-106"><a href="#WorldAgent.TimeDeltaBehaviour.run-106"><span class="linenos">106</span></a><span class="sd">            - For each edge that changes, calculates fuel consumption</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-107"><a href="#WorldAgent.TimeDeltaBehaviour.run-107"><span class="linenos">107</span></a><span class="sd">            - Tracks the tick index where each change occurred</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-108"><a href="#WorldAgent.TimeDeltaBehaviour.run-108"><span class="linenos">108</span></a><span class="sd">            - Returns complete change history to the requester</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-109"><a href="#WorldAgent.TimeDeltaBehaviour.run-109"><span class="linenos">109</span></a><span class="sd">            </span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-110"><a href="#WorldAgent.TimeDeltaBehaviour.run-110"><span class="linenos">110</span></a><span class="sd">            Raises:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-111"><a href="#WorldAgent.TimeDeltaBehaviour.run-111"><span class="linenos">111</span></a><span class="sd">                json.JSONDecodeError: If message body is invalid JSON (logged, not raised)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-112"><a href="#WorldAgent.TimeDeltaBehaviour.run-112"><span class="linenos">112</span></a><span class="sd">                Exception: Any other runtime error (logged, not raised)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-113"><a href="#WorldAgent.TimeDeltaBehaviour.run-113"><span class="linenos">113</span></a><span class="sd">            </span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-114"><a href="#WorldAgent.TimeDeltaBehaviour.run-114"><span class="linenos">114</span></a><span class="sd">            Yields:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-115"><a href="#WorldAgent.TimeDeltaBehaviour.run-115"><span class="linenos">115</span></a><span class="sd">                None: This cyclic behaviour continues indefinitely</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-116"><a href="#WorldAgent.TimeDeltaBehaviour.run-116"><span class="linenos">116</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-117"><a href="#WorldAgent.TimeDeltaBehaviour.run-117"><span class="linenos">117</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-118"><a href="#WorldAgent.TimeDeltaBehaviour.run-118"><span class="linenos">118</span></a>            
</span><span id="WorldAgent.TimeDeltaBehaviour.run-119"><a href="#WorldAgent.TimeDeltaBehaviour.run-119"><span class="linenos">119</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-120"><a href="#WorldAgent.TimeDeltaBehaviour.run-120"><span class="linenos">120</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-121"><a href="#WorldAgent.TimeDeltaBehaviour.run-121"><span class="linenos">121</span></a>                    <span class="c1"># Check if it&#39;s a traffic simulation request from event agent</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-122"><a href="#WorldAgent.TimeDeltaBehaviour.run-122"><span class="linenos">122</span></a>                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;request&quot;</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;simulate_traffic&quot;</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-123"><a href="#WorldAgent.TimeDeltaBehaviour.run-123"><span class="linenos">123</span></a>                        <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-124"><a href="#WorldAgent.TimeDeltaBehaviour.run-124"><span class="linenos">124</span></a>                        <span class="n">simulation_time</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simulation_time&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-125"><a href="#WorldAgent.TimeDeltaBehaviour.run-125"><span class="linenos">125</span></a>                        <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-126"><a href="#WorldAgent.TimeDeltaBehaviour.run-126"><span class="linenos">126</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour.run-127"><a href="#WorldAgent.TimeDeltaBehaviour.run-127"><span class="linenos">127</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Traffic simulation request received&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-128"><a href="#WorldAgent.TimeDeltaBehaviour.run-128"><span class="linenos">128</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sender: </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-129"><a href="#WorldAgent.TimeDeltaBehaviour.run-129"><span class="linenos">129</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Simulation time: </span><span class="si">{</span><span class="n">simulation_time</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-130"><a href="#WorldAgent.TimeDeltaBehaviour.run-130"><span class="linenos">130</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour.run-131"><a href="#WorldAgent.TimeDeltaBehaviour.run-131"><span class="linenos">131</span></a>                        <span class="c1"># Simulate traffic events using get_events</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-132"><a href="#WorldAgent.TimeDeltaBehaviour.run-132"><span class="linenos">132</span></a>                        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">simulation_time</span><span class="p">))</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-133"><a href="#WorldAgent.TimeDeltaBehaviour.run-133"><span class="linenos">133</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour.run-134"><a href="#WorldAgent.TimeDeltaBehaviour.run-134"><span class="linenos">134</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Simulation completed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="si">}</span><span class="s2"> events generated&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-135"><a href="#WorldAgent.TimeDeltaBehaviour.run-135"><span class="linenos">135</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour.run-136"><a href="#WorldAgent.TimeDeltaBehaviour.run-136"><span class="linenos">136</span></a>                        <span class="c1"># Send response with traffic events (FIPA Inform)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-137"><a href="#WorldAgent.TimeDeltaBehaviour.run-137"><span class="linenos">137</span></a>                        <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-138"><a href="#WorldAgent.TimeDeltaBehaviour.run-138"><span class="linenos">138</span></a>                        <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-139"><a href="#WorldAgent.TimeDeltaBehaviour.run-139"><span class="linenos">139</span></a>                        <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;traffic_events&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-140"><a href="#WorldAgent.TimeDeltaBehaviour.run-140"><span class="linenos">140</span></a>                        <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-141"><a href="#WorldAgent.TimeDeltaBehaviour.run-141"><span class="linenos">141</span></a>                            <span class="s2">&quot;events&quot;</span><span class="p">:</span> <span class="n">events</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-142"><a href="#WorldAgent.TimeDeltaBehaviour.run-142"><span class="linenos">142</span></a>                            <span class="s2">&quot;simulation_time&quot;</span><span class="p">:</span> <span class="n">simulation_time</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-143"><a href="#WorldAgent.TimeDeltaBehaviour.run-143"><span class="linenos">143</span></a>                        <span class="p">})</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-144"><a href="#WorldAgent.TimeDeltaBehaviour.run-144"><span class="linenos">144</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-145"><a href="#WorldAgent.TimeDeltaBehaviour.run-145"><span class="linenos">145</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour.run-146"><a href="#WorldAgent.TimeDeltaBehaviour.run-146"><span class="linenos">146</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Traffic events sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-147"><a href="#WorldAgent.TimeDeltaBehaviour.run-147"><span class="linenos">147</span></a>                        <span class="k">return</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-148"><a href="#WorldAgent.TimeDeltaBehaviour.run-148"><span class="linenos">148</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour.run-149"><a href="#WorldAgent.TimeDeltaBehaviour.run-149"><span class="linenos">149</span></a>                    <span class="c1"># Handle normal time-delta requests (FIPA Request/Response pattern)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-150"><a href="#WorldAgent.TimeDeltaBehaviour.run-150"><span class="linenos">150</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-151"><a href="#WorldAgent.TimeDeltaBehaviour.run-151"><span class="linenos">151</span></a>                    <span class="n">delta_time</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delta_time&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-152"><a href="#WorldAgent.TimeDeltaBehaviour.run-152"><span class="linenos">152</span></a>                    <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-153"><a href="#WorldAgent.TimeDeltaBehaviour.run-153"><span class="linenos">153</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour.run-154"><a href="#WorldAgent.TimeDeltaBehaviour.run-154"><span class="linenos">154</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Received time-delta request: </span><span class="si">{</span><span class="n">delta_time</span><span class="si">}</span><span class="s2"> ticks from </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-155"><a href="#WorldAgent.TimeDeltaBehaviour.run-155"><span class="linenos">155</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour.run-156"><a href="#WorldAgent.TimeDeltaBehaviour.run-156"><span class="linenos">156</span></a>                    <span class="c1"># Store initial edge states for change detection</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-157"><a href="#WorldAgent.TimeDeltaBehaviour.run-157"><span class="linenos">157</span></a>                    <span class="n">initial_states</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-158"><a href="#WorldAgent.TimeDeltaBehaviour.run-158"><span class="linenos">158</span></a>                    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-159"><a href="#WorldAgent.TimeDeltaBehaviour.run-159"><span class="linenos">159</span></a>                        <span class="n">initial_states</span><span class="p">[(</span><span class="n">edge</span><span class="o">.</span><span class="n">node1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-160"><a href="#WorldAgent.TimeDeltaBehaviour.run-160"><span class="linenos">160</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour.run-161"><a href="#WorldAgent.TimeDeltaBehaviour.run-161"><span class="linenos">161</span></a>                    <span class="c1"># Simulate delta_time ticks and track changes</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-162"><a href="#WorldAgent.TimeDeltaBehaviour.run-162"><span class="linenos">162</span></a>                    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-163"><a href="#WorldAgent.TimeDeltaBehaviour.run-163"><span class="linenos">163</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">delta_time</span><span class="p">):</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-164"><a href="#WorldAgent.TimeDeltaBehaviour.run-164"><span class="linenos">164</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Simulate one tick at a time</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-165"><a href="#WorldAgent.TimeDeltaBehaviour.run-165"><span class="linenos">165</span></a>                        <span class="n">current_tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-166"><a href="#WorldAgent.TimeDeltaBehaviour.run-166"><span class="linenos">166</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour.run-167"><a href="#WorldAgent.TimeDeltaBehaviour.run-167"><span class="linenos">167</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Simulated tick </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">delta_time</span><span class="si">}</span><span class="s2"> (current tick: </span><span class="si">{</span><span class="n">current_tick</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-168"><a href="#WorldAgent.TimeDeltaBehaviour.run-168"><span class="linenos">168</span></a>                        
</span><span id="WorldAgent.TimeDeltaBehaviour.run-169"><a href="#WorldAgent.TimeDeltaBehaviour.run-169"><span class="linenos">169</span></a>                        <span class="c1"># Check which edges changed in this tick</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-170"><a href="#WorldAgent.TimeDeltaBehaviour.run-170"><span class="linenos">170</span></a>                        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-171"><a href="#WorldAgent.TimeDeltaBehaviour.run-171"><span class="linenos">171</span></a>                            <span class="n">edge_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">node1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-172"><a href="#WorldAgent.TimeDeltaBehaviour.run-172"><span class="linenos">172</span></a>                            <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">!=</span> <span class="n">initial_states</span><span class="p">[</span><span class="n">edge_key</span><span class="p">]:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-173"><a href="#WorldAgent.TimeDeltaBehaviour.run-173"><span class="linenos">173</span></a>                                <span class="c1"># Edge changed - record the instant (tick index)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-174"><a href="#WorldAgent.TimeDeltaBehaviour.run-174"><span class="linenos">174</span></a>                                <span class="n">edge</span><span class="o">.</span><span class="n">calculate_fuel_consumption</span><span class="p">()</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-175"><a href="#WorldAgent.TimeDeltaBehaviour.run-175"><span class="linenos">175</span></a>                                <span class="n">edge_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-176"><a href="#WorldAgent.TimeDeltaBehaviour.run-176"><span class="linenos">176</span></a>                                    <span class="s2">&quot;node1_id&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">node1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-177"><a href="#WorldAgent.TimeDeltaBehaviour.run-177"><span class="linenos">177</span></a>                                    <span class="s2">&quot;node2_id&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-178"><a href="#WorldAgent.TimeDeltaBehaviour.run-178"><span class="linenos">178</span></a>                                    <span class="s2">&quot;new_time&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-179"><a href="#WorldAgent.TimeDeltaBehaviour.run-179"><span class="linenos">179</span></a>                                    <span class="s2">&quot;new_fuel_consumption&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">fuel_consumption</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-180"><a href="#WorldAgent.TimeDeltaBehaviour.run-180"><span class="linenos">180</span></a>                                    <span class="s2">&quot;instant&quot;</span><span class="p">:</span> <span class="n">i</span>  <span class="c1"># The tick index when it changed</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-181"><a href="#WorldAgent.TimeDeltaBehaviour.run-181"><span class="linenos">181</span></a>                                <span class="p">}</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-182"><a href="#WorldAgent.TimeDeltaBehaviour.run-182"><span class="linenos">182</span></a>                                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_info</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-183"><a href="#WorldAgent.TimeDeltaBehaviour.run-183"><span class="linenos">183</span></a>                                <span class="c1"># Update the initial state to current state</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-184"><a href="#WorldAgent.TimeDeltaBehaviour.run-184"><span class="linenos">184</span></a>                                <span class="n">initial_states</span><span class="p">[</span><span class="n">edge_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-185"><a href="#WorldAgent.TimeDeltaBehaviour.run-185"><span class="linenos">185</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour.run-186"><a href="#WorldAgent.TimeDeltaBehaviour.run-186"><span class="linenos">186</span></a>                    <span class="c1"># Send response with all edge states (FIPA Inform)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-187"><a href="#WorldAgent.TimeDeltaBehaviour.run-187"><span class="linenos">187</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-188"><a href="#WorldAgent.TimeDeltaBehaviour.run-188"><span class="linenos">188</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-189"><a href="#WorldAgent.TimeDeltaBehaviour.run-189"><span class="linenos">189</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-190"><a href="#WorldAgent.TimeDeltaBehaviour.run-190"><span class="linenos">190</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;time_delta_response&quot;</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-191"><a href="#WorldAgent.TimeDeltaBehaviour.run-191"><span class="linenos">191</span></a>                        <span class="s2">&quot;delta_time&quot;</span><span class="p">:</span> <span class="n">delta_time</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-192"><a href="#WorldAgent.TimeDeltaBehaviour.run-192"><span class="linenos">192</span></a>                        <span class="s2">&quot;final_tick&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span><span class="p">,</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-193"><a href="#WorldAgent.TimeDeltaBehaviour.run-193"><span class="linenos">193</span></a>                        <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="n">results</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-194"><a href="#WorldAgent.TimeDeltaBehaviour.run-194"><span class="linenos">194</span></a>                    <span class="p">})</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-195"><a href="#WorldAgent.TimeDeltaBehaviour.run-195"><span class="linenos">195</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-196"><a href="#WorldAgent.TimeDeltaBehaviour.run-196"><span class="linenos">196</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour.run-197"><a href="#WorldAgent.TimeDeltaBehaviour.run-197"><span class="linenos">197</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Sent time-delta response with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> edge updates&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-198"><a href="#WorldAgent.TimeDeltaBehaviour.run-198"><span class="linenos">198</span></a>                    
</span><span id="WorldAgent.TimeDeltaBehaviour.run-199"><a href="#WorldAgent.TimeDeltaBehaviour.run-199"><span class="linenos">199</span></a>                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-200"><a href="#WorldAgent.TimeDeltaBehaviour.run-200"><span class="linenos">200</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error decoding time-delta message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-201"><a href="#WorldAgent.TimeDeltaBehaviour.run-201"><span class="linenos">201</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent.TimeDeltaBehaviour.run-202"><a href="#WorldAgent.TimeDeltaBehaviour.run-202"><span class="linenos">202</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error in TimeDeltaBehaviour: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Process time-delta messages and simulate world.</p>

<p>Executes one iteration of the cyclic behaviour. This method:</p>

<ol>
<li>Waits for incoming messages with a 1-second timeout</li>
<li>If a message is received, parses its JSON content</li>
<li>Identifies the message type (traffic simulation or time-delta)</li>
<li>Routes to appropriate handler based on action metadata</li>
<li>Sends response back to sender with simulation results</li>
<li>Handles exceptions gracefully, logging errors</li>
</ol>

<p>The method operates on two distinct message types:</p>

<ul>
<li>Traffic Simulation: Calls world.get_events() to simulate traffic</li>
<li>Time-Delta: Simulates multiple ticks and tracks edge state changes</li>
</ul>

<p>For time-delta requests, the behaviour:</p>

<ul>
<li>Records initial edge weights before simulation</li>
<li>Executes the requested number of ticks sequentially</li>
<li>For each edge that changes, calculates fuel consumption</li>
<li>Tracks the tick index where each change occurred</li>
<li>Returns complete change history to the requester</li>
</ul>

<h6 id="raises">Raises:</h6>

<ul>
<li><strong>json.JSONDecodeError:</strong>  If message body is invalid JSON (logged, not raised)</li>
<li><strong>Exception:</strong>  Any other runtime error (logged, not raised)</li>
</ul>

<h6 id="yields">Yields:</h6>

<blockquote>
  <p>None: This cyclic behaviour continues indefinitely</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="WorldAgent.MessageHandlerBehaviour">
                            <input id="WorldAgent.MessageHandlerBehaviour-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">WorldAgent.MessageHandlerBehaviour</span><wbr>(<span class="base">spade.behaviour.CyclicBehaviour</span>):

                <label class="view-source-button" for="WorldAgent.MessageHandlerBehaviour-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorldAgent.MessageHandlerBehaviour"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorldAgent.MessageHandlerBehaviour-204"><a href="#WorldAgent.MessageHandlerBehaviour-204"><span class="linenos">204</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">MessageHandlerBehaviour</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-205"><a href="#WorldAgent.MessageHandlerBehaviour-205"><span class="linenos">205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles incoming messages from other agents.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-206"><a href="#WorldAgent.MessageHandlerBehaviour-206"><span class="linenos">206</span></a><span class="sd">        </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-207"><a href="#WorldAgent.MessageHandlerBehaviour-207"><span class="linenos">207</span></a><span class="sd">        This behaviour processes all general query and subscription messages from</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-208"><a href="#WorldAgent.MessageHandlerBehaviour-208"><span class="linenos">208</span></a><span class="sd">        other agents in the supply chain system. It operates as a message dispatcher,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-209"><a href="#WorldAgent.MessageHandlerBehaviour-209"><span class="linenos">209</span></a><span class="sd">        routing incoming messages to specialized handler methods based on the</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-210"><a href="#WorldAgent.MessageHandlerBehaviour-210"><span class="linenos">210</span></a><span class="sd">        message type field.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-211"><a href="#WorldAgent.MessageHandlerBehaviour-211"><span class="linenos">211</span></a><span class="sd">        </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-212"><a href="#WorldAgent.MessageHandlerBehaviour-212"><span class="linenos">212</span></a><span class="sd">        Supported message types and their handlers:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-213"><a href="#WorldAgent.MessageHandlerBehaviour-213"><span class="linenos">213</span></a><span class="sd">        - &quot;query_world_state&quot;: Returns complete world simulation state</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-214"><a href="#WorldAgent.MessageHandlerBehaviour-214"><span class="linenos">214</span></a><span class="sd">        - &quot;query_node_info&quot;: Returns information about a specific graph node</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-215"><a href="#WorldAgent.MessageHandlerBehaviour-215"><span class="linenos">215</span></a><span class="sd">        - &quot;query_edge_info&quot;: Returns information about a specific edge</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-216"><a href="#WorldAgent.MessageHandlerBehaviour-216"><span class="linenos">216</span></a><span class="sd">        - &quot;query_facilities&quot;: Returns locations of all supply chain facilities</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-217"><a href="#WorldAgent.MessageHandlerBehaviour-217"><span class="linenos">217</span></a><span class="sd">        - &quot;subscribe&quot;: Registers an agent for periodic world state updates</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-218"><a href="#WorldAgent.MessageHandlerBehaviour-218"><span class="linenos">218</span></a><span class="sd">        </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-219"><a href="#WorldAgent.MessageHandlerBehaviour-219"><span class="linenos">219</span></a><span class="sd">        FIPA Protocol Compliance:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-220"><a href="#WorldAgent.MessageHandlerBehaviour-220"><span class="linenos">220</span></a><span class="sd">        - Processes messages from agents following FIPA protocols</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-221"><a href="#WorldAgent.MessageHandlerBehaviour-221"><span class="linenos">221</span></a><span class="sd">        - Sends INFORM messages (performative=&quot;inform&quot;) for successful queries</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-222"><a href="#WorldAgent.MessageHandlerBehaviour-222"><span class="linenos">222</span></a><span class="sd">        - Returns ERROR messages for queries that fail or have invalid parameters</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-223"><a href="#WorldAgent.MessageHandlerBehaviour-223"><span class="linenos">223</span></a><span class="sd">        - Handles SUBSCRIBE messages for publish/subscribe pattern coordination</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-224"><a href="#WorldAgent.MessageHandlerBehaviour-224"><span class="linenos">224</span></a><span class="sd">        </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-225"><a href="#WorldAgent.MessageHandlerBehaviour-225"><span class="linenos">225</span></a><span class="sd">        Message Flow:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-226"><a href="#WorldAgent.MessageHandlerBehaviour-226"><span class="linenos">226</span></a><span class="sd">        1. Receives a message with JSON body containing &quot;type&quot; field</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-227"><a href="#WorldAgent.MessageHandlerBehaviour-227"><span class="linenos">227</span></a><span class="sd">        2. Validates JSON structure and extracts message type</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-228"><a href="#WorldAgent.MessageHandlerBehaviour-228"><span class="linenos">228</span></a><span class="sd">        3. Routes to appropriate private handler method (_handle_*)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-229"><a href="#WorldAgent.MessageHandlerBehaviour-229"><span class="linenos">229</span></a><span class="sd">        4. Handler method constructs response with agent&#39;s data</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-230"><a href="#WorldAgent.MessageHandlerBehaviour-230"><span class="linenos">230</span></a><span class="sd">        5. Response sent back to originating agent</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-231"><a href="#WorldAgent.MessageHandlerBehaviour-231"><span class="linenos">231</span></a><span class="sd">        </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-232"><a href="#WorldAgent.MessageHandlerBehaviour-232"><span class="linenos">232</span></a><span class="sd">        Error Handling:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-233"><a href="#WorldAgent.MessageHandlerBehaviour-233"><span class="linenos">233</span></a><span class="sd">        - JSON decode errors are logged and ignored</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-234"><a href="#WorldAgent.MessageHandlerBehaviour-234"><span class="linenos">234</span></a><span class="sd">        - Unknown message types are logged with diagnostic info</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-235"><a href="#WorldAgent.MessageHandlerBehaviour-235"><span class="linenos">235</span></a><span class="sd">        - Handler exceptions are caught and logged</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-236"><a href="#WorldAgent.MessageHandlerBehaviour-236"><span class="linenos">236</span></a><span class="sd">        </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-237"><a href="#WorldAgent.MessageHandlerBehaviour-237"><span class="linenos">237</span></a><span class="sd">        This behaviour runs cyclically with a 1-second timeout between iterations.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-238"><a href="#WorldAgent.MessageHandlerBehaviour-238"><span class="linenos">238</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-239"><a href="#WorldAgent.MessageHandlerBehaviour-239"><span class="linenos">239</span></a>        
</span><span id="WorldAgent.MessageHandlerBehaviour-240"><a href="#WorldAgent.MessageHandlerBehaviour-240"><span class="linenos">240</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-241"><a href="#WorldAgent.MessageHandlerBehaviour-241"><span class="linenos">241</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Process incoming messages.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-242"><a href="#WorldAgent.MessageHandlerBehaviour-242"><span class="linenos">242</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-243"><a href="#WorldAgent.MessageHandlerBehaviour-243"><span class="linenos">243</span></a><span class="sd">            Executes one iteration of the cyclic message handling. This method:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-244"><a href="#WorldAgent.MessageHandlerBehaviour-244"><span class="linenos">244</span></a><span class="sd">            1. Waits up to 1 second for an incoming message</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-245"><a href="#WorldAgent.MessageHandlerBehaviour-245"><span class="linenos">245</span></a><span class="sd">            2. If no message arrives within timeout, cycles immediately</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-246"><a href="#WorldAgent.MessageHandlerBehaviour-246"><span class="linenos">246</span></a><span class="sd">            3. If a message arrives, attempts to parse it as JSON</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-247"><a href="#WorldAgent.MessageHandlerBehaviour-247"><span class="linenos">247</span></a><span class="sd">            4. Extracts the &quot;type&quot; field to determine message category</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-248"><a href="#WorldAgent.MessageHandlerBehaviour-248"><span class="linenos">248</span></a><span class="sd">            5. Dispatches to the appropriate handler coroutine</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-249"><a href="#WorldAgent.MessageHandlerBehaviour-249"><span class="linenos">249</span></a><span class="sd">            6. Catches and logs any JSON or handler exceptions</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-250"><a href="#WorldAgent.MessageHandlerBehaviour-250"><span class="linenos">250</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-251"><a href="#WorldAgent.MessageHandlerBehaviour-251"><span class="linenos">251</span></a><span class="sd">            The dispatcher pattern allows different message types to be handled</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-252"><a href="#WorldAgent.MessageHandlerBehaviour-252"><span class="linenos">252</span></a><span class="sd">            by specialized methods, keeping this method focused on high-level</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-253"><a href="#WorldAgent.MessageHandlerBehaviour-253"><span class="linenos">253</span></a><span class="sd">            message routing and error handling.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-254"><a href="#WorldAgent.MessageHandlerBehaviour-254"><span class="linenos">254</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-255"><a href="#WorldAgent.MessageHandlerBehaviour-255"><span class="linenos">255</span></a><span class="sd">            Raises:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-256"><a href="#WorldAgent.MessageHandlerBehaviour-256"><span class="linenos">256</span></a><span class="sd">                json.JSONDecodeError: If msg.body is not valid JSON (caught, logged)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-257"><a href="#WorldAgent.MessageHandlerBehaviour-257"><span class="linenos">257</span></a><span class="sd">                Exception: Any handler exception (caught, logged)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-258"><a href="#WorldAgent.MessageHandlerBehaviour-258"><span class="linenos">258</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-259"><a href="#WorldAgent.MessageHandlerBehaviour-259"><span class="linenos">259</span></a><span class="sd">            Yields:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-260"><a href="#WorldAgent.MessageHandlerBehaviour-260"><span class="linenos">260</span></a><span class="sd">                None: Continues indefinitely as a cyclic behaviour</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-261"><a href="#WorldAgent.MessageHandlerBehaviour-261"><span class="linenos">261</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-262"><a href="#WorldAgent.MessageHandlerBehaviour-262"><span class="linenos">262</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-263"><a href="#WorldAgent.MessageHandlerBehaviour-263"><span class="linenos">263</span></a>            
</span><span id="WorldAgent.MessageHandlerBehaviour-264"><a href="#WorldAgent.MessageHandlerBehaviour-264"><span class="linenos">264</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-265"><a href="#WorldAgent.MessageHandlerBehaviour-265"><span class="linenos">265</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-266"><a href="#WorldAgent.MessageHandlerBehaviour-266"><span class="linenos">266</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-267"><a href="#WorldAgent.MessageHandlerBehaviour-267"><span class="linenos">267</span></a>                    <span class="n">msg_type</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-268"><a href="#WorldAgent.MessageHandlerBehaviour-268"><span class="linenos">268</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour-269"><a href="#WorldAgent.MessageHandlerBehaviour-269"><span class="linenos">269</span></a>                    <span class="k">if</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_world_state&quot;</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-270"><a href="#WorldAgent.MessageHandlerBehaviour-270"><span class="linenos">270</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_world_state_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-271"><a href="#WorldAgent.MessageHandlerBehaviour-271"><span class="linenos">271</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour-272"><a href="#WorldAgent.MessageHandlerBehaviour-272"><span class="linenos">272</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_node_info&quot;</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-273"><a href="#WorldAgent.MessageHandlerBehaviour-273"><span class="linenos">273</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_node_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-274"><a href="#WorldAgent.MessageHandlerBehaviour-274"><span class="linenos">274</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour-275"><a href="#WorldAgent.MessageHandlerBehaviour-275"><span class="linenos">275</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_edge_info&quot;</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-276"><a href="#WorldAgent.MessageHandlerBehaviour-276"><span class="linenos">276</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_edge_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-277"><a href="#WorldAgent.MessageHandlerBehaviour-277"><span class="linenos">277</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour-278"><a href="#WorldAgent.MessageHandlerBehaviour-278"><span class="linenos">278</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_facilities&quot;</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-279"><a href="#WorldAgent.MessageHandlerBehaviour-279"><span class="linenos">279</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_facilities_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-280"><a href="#WorldAgent.MessageHandlerBehaviour-280"><span class="linenos">280</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour-281"><a href="#WorldAgent.MessageHandlerBehaviour-281"><span class="linenos">281</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-282"><a href="#WorldAgent.MessageHandlerBehaviour-282"><span class="linenos">282</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_subscribe</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-283"><a href="#WorldAgent.MessageHandlerBehaviour-283"><span class="linenos">283</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour-284"><a href="#WorldAgent.MessageHandlerBehaviour-284"><span class="linenos">284</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-285"><a href="#WorldAgent.MessageHandlerBehaviour-285"><span class="linenos">285</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Unknown message type: </span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-286"><a href="#WorldAgent.MessageHandlerBehaviour-286"><span class="linenos">286</span></a>                        
</span><span id="WorldAgent.MessageHandlerBehaviour-287"><a href="#WorldAgent.MessageHandlerBehaviour-287"><span class="linenos">287</span></a>                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-288"><a href="#WorldAgent.MessageHandlerBehaviour-288"><span class="linenos">288</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error decoding message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-289"><a href="#WorldAgent.MessageHandlerBehaviour-289"><span class="linenos">289</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-290"><a href="#WorldAgent.MessageHandlerBehaviour-290"><span class="linenos">290</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error handling message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-291"><a href="#WorldAgent.MessageHandlerBehaviour-291"><span class="linenos">291</span></a>
</span><span id="WorldAgent.MessageHandlerBehaviour-292"><a href="#WorldAgent.MessageHandlerBehaviour-292"><span class="linenos">292</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_world_state_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-293"><a href="#WorldAgent.MessageHandlerBehaviour-293"><span class="linenos">293</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle query for complete world state.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-294"><a href="#WorldAgent.MessageHandlerBehaviour-294"><span class="linenos">294</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-295"><a href="#WorldAgent.MessageHandlerBehaviour-295"><span class="linenos">295</span></a><span class="sd">            Responds to queries requesting the complete world state snapshot.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-296"><a href="#WorldAgent.MessageHandlerBehaviour-296"><span class="linenos">296</span></a><span class="sd">            Compiles all relevant world information including simulation progress,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-297"><a href="#WorldAgent.MessageHandlerBehaviour-297"><span class="linenos">297</span></a><span class="sd">            grid dimensions, facility counts, and infected edge statistics.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-298"><a href="#WorldAgent.MessageHandlerBehaviour-298"><span class="linenos">298</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-299"><a href="#WorldAgent.MessageHandlerBehaviour-299"><span class="linenos">299</span></a><span class="sd">            This handler follows the FIPA Query interaction protocol by:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-300"><a href="#WorldAgent.MessageHandlerBehaviour-300"><span class="linenos">300</span></a><span class="sd">            - Receiving a query request message</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-301"><a href="#WorldAgent.MessageHandlerBehaviour-301"><span class="linenos">301</span></a><span class="sd">            - Preparing comprehensive state information</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-302"><a href="#WorldAgent.MessageHandlerBehaviour-302"><span class="linenos">302</span></a><span class="sd">            - Sending an INFORM message with the complete state</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-303"><a href="#WorldAgent.MessageHandlerBehaviour-303"><span class="linenos">303</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-304"><a href="#WorldAgent.MessageHandlerBehaviour-304"><span class="linenos">304</span></a><span class="sd">            Args:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-305"><a href="#WorldAgent.MessageHandlerBehaviour-305"><span class="linenos">305</span></a><span class="sd">                msg (Message): The incoming query message from sender agent.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-306"><a href="#WorldAgent.MessageHandlerBehaviour-306"><span class="linenos">306</span></a><span class="sd">                    Expected to be of type &quot;query_world_state&quot; in JSON body.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-307"><a href="#WorldAgent.MessageHandlerBehaviour-307"><span class="linenos">307</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-308"><a href="#WorldAgent.MessageHandlerBehaviour-308"><span class="linenos">308</span></a><span class="sd">            Returns:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-309"><a href="#WorldAgent.MessageHandlerBehaviour-309"><span class="linenos">309</span></a><span class="sd">                None: Sends response asynchronously via FIPA INFORM message</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-310"><a href="#WorldAgent.MessageHandlerBehaviour-310"><span class="linenos">310</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-311"><a href="#WorldAgent.MessageHandlerBehaviour-311"><span class="linenos">311</span></a><span class="sd">            Response payload includes:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-312"><a href="#WorldAgent.MessageHandlerBehaviour-312"><span class="linenos">312</span></a><span class="sd">                - tick: Current simulation time step counter</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-313"><a href="#WorldAgent.MessageHandlerBehaviour-313"><span class="linenos">313</span></a><span class="sd">                - width/height: Grid dimensions in the world graph</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-314"><a href="#WorldAgent.MessageHandlerBehaviour-314"><span class="linenos">314</span></a><span class="sd">                - seed: Random seed used for deterministic reproduction</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-315"><a href="#WorldAgent.MessageHandlerBehaviour-315"><span class="linenos">315</span></a><span class="sd">                - mode: Simulation mode (e.g., &quot;traffic&quot; or other modes)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-316"><a href="#WorldAgent.MessageHandlerBehaviour-316"><span class="linenos">316</span></a><span class="sd">                - num_nodes: Total number of nodes in the supply chain graph</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-317"><a href="#WorldAgent.MessageHandlerBehaviour-317"><span class="linenos">317</span></a><span class="sd">                - num_edges: Total number of edges in the supply chain graph</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-318"><a href="#WorldAgent.MessageHandlerBehaviour-318"><span class="linenos">318</span></a><span class="sd">                - infected_edges: Count of edges currently experiencing traffic</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-319"><a href="#WorldAgent.MessageHandlerBehaviour-319"><span class="linenos">319</span></a><span class="sd">                - gas_stations: Number and IDs of gas station facilities</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-320"><a href="#WorldAgent.MessageHandlerBehaviour-320"><span class="linenos">320</span></a><span class="sd">                - warehouses: Number and IDs of warehouse facilities</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-321"><a href="#WorldAgent.MessageHandlerBehaviour-321"><span class="linenos">321</span></a><span class="sd">                - suppliers: Number and IDs of supplier facilities</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-322"><a href="#WorldAgent.MessageHandlerBehaviour-322"><span class="linenos">322</span></a><span class="sd">                - stores: Number and IDs of store facilities</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-323"><a href="#WorldAgent.MessageHandlerBehaviour-323"><span class="linenos">323</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-324"><a href="#WorldAgent.MessageHandlerBehaviour-324"><span class="linenos">324</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-325"><a href="#WorldAgent.MessageHandlerBehaviour-325"><span class="linenos">325</span></a>            <span class="n">world_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-326"><a href="#WorldAgent.MessageHandlerBehaviour-326"><span class="linenos">326</span></a>                <span class="s2">&quot;tick&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">tick_counter</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-327"><a href="#WorldAgent.MessageHandlerBehaviour-327"><span class="linenos">327</span></a>                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-328"><a href="#WorldAgent.MessageHandlerBehaviour-328"><span class="linenos">328</span></a>                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-329"><a href="#WorldAgent.MessageHandlerBehaviour-329"><span class="linenos">329</span></a>                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-330"><a href="#WorldAgent.MessageHandlerBehaviour-330"><span class="linenos">330</span></a>                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-331"><a href="#WorldAgent.MessageHandlerBehaviour-331"><span class="linenos">331</span></a>                <span class="s2">&quot;num_nodes&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-332"><a href="#WorldAgent.MessageHandlerBehaviour-332"><span class="linenos">332</span></a>                <span class="s2">&quot;num_edges&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">),</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-333"><a href="#WorldAgent.MessageHandlerBehaviour-333"><span class="linenos">333</span></a>                <span class="s2">&quot;infected_edges&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">infected_edges</span><span class="p">),</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-334"><a href="#WorldAgent.MessageHandlerBehaviour-334"><span class="linenos">334</span></a>                <span class="s2">&quot;gas_stations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">gas_stations</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-335"><a href="#WorldAgent.MessageHandlerBehaviour-335"><span class="linenos">335</span></a>                <span class="s2">&quot;warehouses&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">warehouses</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-336"><a href="#WorldAgent.MessageHandlerBehaviour-336"><span class="linenos">336</span></a>                <span class="s2">&quot;suppliers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">suppliers</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-337"><a href="#WorldAgent.MessageHandlerBehaviour-337"><span class="linenos">337</span></a>                <span class="s2">&quot;stores&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">stores</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-338"><a href="#WorldAgent.MessageHandlerBehaviour-338"><span class="linenos">338</span></a>            <span class="p">}</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-339"><a href="#WorldAgent.MessageHandlerBehaviour-339"><span class="linenos">339</span></a>            
</span><span id="WorldAgent.MessageHandlerBehaviour-340"><a href="#WorldAgent.MessageHandlerBehaviour-340"><span class="linenos">340</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-341"><a href="#WorldAgent.MessageHandlerBehaviour-341"><span class="linenos">341</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-342"><a href="#WorldAgent.MessageHandlerBehaviour-342"><span class="linenos">342</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-343"><a href="#WorldAgent.MessageHandlerBehaviour-343"><span class="linenos">343</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;world_state&quot;</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-344"><a href="#WorldAgent.MessageHandlerBehaviour-344"><span class="linenos">344</span></a>                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">world_data</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-345"><a href="#WorldAgent.MessageHandlerBehaviour-345"><span class="linenos">345</span></a>            <span class="p">})</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-346"><a href="#WorldAgent.MessageHandlerBehaviour-346"><span class="linenos">346</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-347"><a href="#WorldAgent.MessageHandlerBehaviour-347"><span class="linenos">347</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] World state sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-348"><a href="#WorldAgent.MessageHandlerBehaviour-348"><span class="linenos">348</span></a>
</span><span id="WorldAgent.MessageHandlerBehaviour-349"><a href="#WorldAgent.MessageHandlerBehaviour-349"><span class="linenos">349</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_node_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-350"><a href="#WorldAgent.MessageHandlerBehaviour-350"><span class="linenos">350</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle query for information about a specific node.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-351"><a href="#WorldAgent.MessageHandlerBehaviour-351"><span class="linenos">351</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-352"><a href="#WorldAgent.MessageHandlerBehaviour-352"><span class="linenos">352</span></a><span class="sd">            Responds to queries requesting detailed information about a single node</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-353"><a href="#WorldAgent.MessageHandlerBehaviour-353"><span class="linenos">353</span></a><span class="sd">            in the supply chain graph. The node is identified by its ID in the</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-354"><a href="#WorldAgent.MessageHandlerBehaviour-354"><span class="linenos">354</span></a><span class="sd">            query message. Returns node coordinates, facility affiliations, and</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-355"><a href="#WorldAgent.MessageHandlerBehaviour-355"><span class="linenos">355</span></a><span class="sd">            other node-specific metadata.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-356"><a href="#WorldAgent.MessageHandlerBehaviour-356"><span class="linenos">356</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-357"><a href="#WorldAgent.MessageHandlerBehaviour-357"><span class="linenos">357</span></a><span class="sd">            FIPA Query/Response Protocol:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-358"><a href="#WorldAgent.MessageHandlerBehaviour-358"><span class="linenos">358</span></a><span class="sd">            - Receives QUERY message with specific node_id parameter</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-359"><a href="#WorldAgent.MessageHandlerBehaviour-359"><span class="linenos">359</span></a><span class="sd">            - Searches graph for the requested node</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-360"><a href="#WorldAgent.MessageHandlerBehaviour-360"><span class="linenos">360</span></a><span class="sd">            - Returns INFORM message with node data if found</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-361"><a href="#WorldAgent.MessageHandlerBehaviour-361"><span class="linenos">361</span></a><span class="sd">            - Returns ERROR message if node not found</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-362"><a href="#WorldAgent.MessageHandlerBehaviour-362"><span class="linenos">362</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-363"><a href="#WorldAgent.MessageHandlerBehaviour-363"><span class="linenos">363</span></a><span class="sd">            Args:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-364"><a href="#WorldAgent.MessageHandlerBehaviour-364"><span class="linenos">364</span></a><span class="sd">                msg (Message): The incoming query message from sender agent.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-365"><a href="#WorldAgent.MessageHandlerBehaviour-365"><span class="linenos">365</span></a><span class="sd">                    Message body must include JSON with:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-366"><a href="#WorldAgent.MessageHandlerBehaviour-366"><span class="linenos">366</span></a><span class="sd">                    - type: &quot;query_node_info&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-367"><a href="#WorldAgent.MessageHandlerBehaviour-367"><span class="linenos">367</span></a><span class="sd">                    - node_id: The ID of the node to query</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-368"><a href="#WorldAgent.MessageHandlerBehaviour-368"><span class="linenos">368</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-369"><a href="#WorldAgent.MessageHandlerBehaviour-369"><span class="linenos">369</span></a><span class="sd">            Returns:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-370"><a href="#WorldAgent.MessageHandlerBehaviour-370"><span class="linenos">370</span></a><span class="sd">                None: Sends FIPA response message (INFORM or ERROR)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-371"><a href="#WorldAgent.MessageHandlerBehaviour-371"><span class="linenos">371</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-372"><a href="#WorldAgent.MessageHandlerBehaviour-372"><span class="linenos">372</span></a><span class="sd">            Response for successful query:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-373"><a href="#WorldAgent.MessageHandlerBehaviour-373"><span class="linenos">373</span></a><span class="sd">                - id: The node identifier</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-374"><a href="#WorldAgent.MessageHandlerBehaviour-374"><span class="linenos">374</span></a><span class="sd">                - x: X-coordinate position in the world grid</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-375"><a href="#WorldAgent.MessageHandlerBehaviour-375"><span class="linenos">375</span></a><span class="sd">                - y: Y-coordinate position in the world grid</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-376"><a href="#WorldAgent.MessageHandlerBehaviour-376"><span class="linenos">376</span></a><span class="sd">                - warehouse: Boolean indicating if node hosts a warehouse</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-377"><a href="#WorldAgent.MessageHandlerBehaviour-377"><span class="linenos">377</span></a><span class="sd">                - supplier: Boolean indicating if node hosts a supplier</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-378"><a href="#WorldAgent.MessageHandlerBehaviour-378"><span class="linenos">378</span></a><span class="sd">                - store: Boolean indicating if node hosts a store</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-379"><a href="#WorldAgent.MessageHandlerBehaviour-379"><span class="linenos">379</span></a><span class="sd">                - gas_station: Boolean indicating if node has a gas station</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-380"><a href="#WorldAgent.MessageHandlerBehaviour-380"><span class="linenos">380</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-381"><a href="#WorldAgent.MessageHandlerBehaviour-381"><span class="linenos">381</span></a><span class="sd">            Response for failed query (node not found):</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-382"><a href="#WorldAgent.MessageHandlerBehaviour-382"><span class="linenos">382</span></a><span class="sd">                - type: &quot;error&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-383"><a href="#WorldAgent.MessageHandlerBehaviour-383"><span class="linenos">383</span></a><span class="sd">                - message: Descriptive error message</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-384"><a href="#WorldAgent.MessageHandlerBehaviour-384"><span class="linenos">384</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-385"><a href="#WorldAgent.MessageHandlerBehaviour-385"><span class="linenos">385</span></a><span class="sd">            Raises:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-386"><a href="#WorldAgent.MessageHandlerBehaviour-386"><span class="linenos">386</span></a><span class="sd">                Exception: Any runtime error during query processing</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-387"><a href="#WorldAgent.MessageHandlerBehaviour-387"><span class="linenos">387</span></a><span class="sd">                    (caught and reported in error response)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-388"><a href="#WorldAgent.MessageHandlerBehaviour-388"><span class="linenos">388</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-389"><a href="#WorldAgent.MessageHandlerBehaviour-389"><span class="linenos">389</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-390"><a href="#WorldAgent.MessageHandlerBehaviour-390"><span class="linenos">390</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-391"><a href="#WorldAgent.MessageHandlerBehaviour-391"><span class="linenos">391</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-392"><a href="#WorldAgent.MessageHandlerBehaviour-392"><span class="linenos">392</span></a>                <span class="n">node_id</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-393"><a href="#WorldAgent.MessageHandlerBehaviour-393"><span class="linenos">393</span></a>                
</span><span id="WorldAgent.MessageHandlerBehaviour-394"><a href="#WorldAgent.MessageHandlerBehaviour-394"><span class="linenos">394</span></a>                <span class="k">if</span> <span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-395"><a href="#WorldAgent.MessageHandlerBehaviour-395"><span class="linenos">395</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-396"><a href="#WorldAgent.MessageHandlerBehaviour-396"><span class="linenos">396</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-397"><a href="#WorldAgent.MessageHandlerBehaviour-397"><span class="linenos">397</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-398"><a href="#WorldAgent.MessageHandlerBehaviour-398"><span class="linenos">398</span></a>                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Node </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s2"> not found&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-399"><a href="#WorldAgent.MessageHandlerBehaviour-399"><span class="linenos">399</span></a>                    <span class="p">})</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-400"><a href="#WorldAgent.MessageHandlerBehaviour-400"><span class="linenos">400</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-401"><a href="#WorldAgent.MessageHandlerBehaviour-401"><span class="linenos">401</span></a>                    <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-402"><a href="#WorldAgent.MessageHandlerBehaviour-402"><span class="linenos">402</span></a>                    <span class="n">node_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-403"><a href="#WorldAgent.MessageHandlerBehaviour-403"><span class="linenos">403</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-404"><a href="#WorldAgent.MessageHandlerBehaviour-404"><span class="linenos">404</span></a>                        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-405"><a href="#WorldAgent.MessageHandlerBehaviour-405"><span class="linenos">405</span></a>                        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-406"><a href="#WorldAgent.MessageHandlerBehaviour-406"><span class="linenos">406</span></a>                        <span class="s2">&quot;warehouse&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">warehouse</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-407"><a href="#WorldAgent.MessageHandlerBehaviour-407"><span class="linenos">407</span></a>                        <span class="s2">&quot;supplier&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">supplier</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-408"><a href="#WorldAgent.MessageHandlerBehaviour-408"><span class="linenos">408</span></a>                        <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">store</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-409"><a href="#WorldAgent.MessageHandlerBehaviour-409"><span class="linenos">409</span></a>                        <span class="s2">&quot;gas_station&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">gas_station</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-410"><a href="#WorldAgent.MessageHandlerBehaviour-410"><span class="linenos">410</span></a>                    <span class="p">}</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-411"><a href="#WorldAgent.MessageHandlerBehaviour-411"><span class="linenos">411</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour-412"><a href="#WorldAgent.MessageHandlerBehaviour-412"><span class="linenos">412</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-413"><a href="#WorldAgent.MessageHandlerBehaviour-413"><span class="linenos">413</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-414"><a href="#WorldAgent.MessageHandlerBehaviour-414"><span class="linenos">414</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-415"><a href="#WorldAgent.MessageHandlerBehaviour-415"><span class="linenos">415</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;node_info&quot;</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-416"><a href="#WorldAgent.MessageHandlerBehaviour-416"><span class="linenos">416</span></a>                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">node_data</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-417"><a href="#WorldAgent.MessageHandlerBehaviour-417"><span class="linenos">417</span></a>                    <span class="p">})</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-418"><a href="#WorldAgent.MessageHandlerBehaviour-418"><span class="linenos">418</span></a>                
</span><span id="WorldAgent.MessageHandlerBehaviour-419"><a href="#WorldAgent.MessageHandlerBehaviour-419"><span class="linenos">419</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-420"><a href="#WorldAgent.MessageHandlerBehaviour-420"><span class="linenos">420</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Node </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s2"> information sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-421"><a href="#WorldAgent.MessageHandlerBehaviour-421"><span class="linenos">421</span></a>                
</span><span id="WorldAgent.MessageHandlerBehaviour-422"><a href="#WorldAgent.MessageHandlerBehaviour-422"><span class="linenos">422</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-423"><a href="#WorldAgent.MessageHandlerBehaviour-423"><span class="linenos">423</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-424"><a href="#WorldAgent.MessageHandlerBehaviour-424"><span class="linenos">424</span></a>                <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-425"><a href="#WorldAgent.MessageHandlerBehaviour-425"><span class="linenos">425</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-426"><a href="#WorldAgent.MessageHandlerBehaviour-426"><span class="linenos">426</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-427"><a href="#WorldAgent.MessageHandlerBehaviour-427"><span class="linenos">427</span></a>                <span class="p">})</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-428"><a href="#WorldAgent.MessageHandlerBehaviour-428"><span class="linenos">428</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-429"><a href="#WorldAgent.MessageHandlerBehaviour-429"><span class="linenos">429</span></a>
</span><span id="WorldAgent.MessageHandlerBehaviour-430"><a href="#WorldAgent.MessageHandlerBehaviour-430"><span class="linenos">430</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_edge_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-431"><a href="#WorldAgent.MessageHandlerBehaviour-431"><span class="linenos">431</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle query for information about edges.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-432"><a href="#WorldAgent.MessageHandlerBehaviour-432"><span class="linenos">432</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-433"><a href="#WorldAgent.MessageHandlerBehaviour-433"><span class="linenos">433</span></a><span class="sd">            Responds to queries requesting detailed information about a specific edge</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-434"><a href="#WorldAgent.MessageHandlerBehaviour-434"><span class="linenos">434</span></a><span class="sd">            in the supply chain graph. The edge is identified by its two endpoint nodes</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-435"><a href="#WorldAgent.MessageHandlerBehaviour-435"><span class="linenos">435</span></a><span class="sd">            (node_u and node_v). Returns edge properties including traversal time,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-436"><a href="#WorldAgent.MessageHandlerBehaviour-436"><span class="linenos">436</span></a><span class="sd">            distance, fuel consumption, and infection status.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-437"><a href="#WorldAgent.MessageHandlerBehaviour-437"><span class="linenos">437</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-438"><a href="#WorldAgent.MessageHandlerBehaviour-438"><span class="linenos">438</span></a><span class="sd">            FIPA Query/Response Protocol:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-439"><a href="#WorldAgent.MessageHandlerBehaviour-439"><span class="linenos">439</span></a><span class="sd">            - Receives QUERY message with node_u and node_v parameters</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-440"><a href="#WorldAgent.MessageHandlerBehaviour-440"><span class="linenos">440</span></a><span class="sd">            - Looks up edge in graph using get_edge() method</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-441"><a href="#WorldAgent.MessageHandlerBehaviour-441"><span class="linenos">441</span></a><span class="sd">            - Returns INFORM message with edge data if found</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-442"><a href="#WorldAgent.MessageHandlerBehaviour-442"><span class="linenos">442</span></a><span class="sd">            - Returns ERROR message if edge not found</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-443"><a href="#WorldAgent.MessageHandlerBehaviour-443"><span class="linenos">443</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-444"><a href="#WorldAgent.MessageHandlerBehaviour-444"><span class="linenos">444</span></a><span class="sd">            Args:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-445"><a href="#WorldAgent.MessageHandlerBehaviour-445"><span class="linenos">445</span></a><span class="sd">                msg (Message): The incoming query message from sender agent.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-446"><a href="#WorldAgent.MessageHandlerBehaviour-446"><span class="linenos">446</span></a><span class="sd">                    Message body must include JSON with:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-447"><a href="#WorldAgent.MessageHandlerBehaviour-447"><span class="linenos">447</span></a><span class="sd">                    - type: &quot;query_edge_info&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-448"><a href="#WorldAgent.MessageHandlerBehaviour-448"><span class="linenos">448</span></a><span class="sd">                    - node_u: Source node ID</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-449"><a href="#WorldAgent.MessageHandlerBehaviour-449"><span class="linenos">449</span></a><span class="sd">                    - node_v: Destination node ID</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-450"><a href="#WorldAgent.MessageHandlerBehaviour-450"><span class="linenos">450</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-451"><a href="#WorldAgent.MessageHandlerBehaviour-451"><span class="linenos">451</span></a><span class="sd">            Returns:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-452"><a href="#WorldAgent.MessageHandlerBehaviour-452"><span class="linenos">452</span></a><span class="sd">                None: Sends FIPA response message (INFORM or ERROR)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-453"><a href="#WorldAgent.MessageHandlerBehaviour-453"><span class="linenos">453</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-454"><a href="#WorldAgent.MessageHandlerBehaviour-454"><span class="linenos">454</span></a><span class="sd">            Response for successful query:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-455"><a href="#WorldAgent.MessageHandlerBehaviour-455"><span class="linenos">455</span></a><span class="sd">                - node_u: Source node ID</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-456"><a href="#WorldAgent.MessageHandlerBehaviour-456"><span class="linenos">456</span></a><span class="sd">                - node_v: Destination node ID</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-457"><a href="#WorldAgent.MessageHandlerBehaviour-457"><span class="linenos">457</span></a><span class="sd">                - weight: Current edge weight (travel time in current tick)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-458"><a href="#WorldAgent.MessageHandlerBehaviour-458"><span class="linenos">458</span></a><span class="sd">                - initial_weight: Original edge weight from graph initialization</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-459"><a href="#WorldAgent.MessageHandlerBehaviour-459"><span class="linenos">459</span></a><span class="sd">                - distance: Geometric distance between nodes</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-460"><a href="#WorldAgent.MessageHandlerBehaviour-460"><span class="linenos">460</span></a><span class="sd">                - fuel_consumption: Fuel needed to traverse this edge</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-461"><a href="#WorldAgent.MessageHandlerBehaviour-461"><span class="linenos">461</span></a><span class="sd">                - is_infected: Boolean indicating if edge has traffic/infection</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-462"><a href="#WorldAgent.MessageHandlerBehaviour-462"><span class="linenos">462</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-463"><a href="#WorldAgent.MessageHandlerBehaviour-463"><span class="linenos">463</span></a><span class="sd">            Response for failed query (edge not found):</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-464"><a href="#WorldAgent.MessageHandlerBehaviour-464"><span class="linenos">464</span></a><span class="sd">                - type: &quot;error&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-465"><a href="#WorldAgent.MessageHandlerBehaviour-465"><span class="linenos">465</span></a><span class="sd">                - message: Descriptive error message</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-466"><a href="#WorldAgent.MessageHandlerBehaviour-466"><span class="linenos">466</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-467"><a href="#WorldAgent.MessageHandlerBehaviour-467"><span class="linenos">467</span></a><span class="sd">            Raises:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-468"><a href="#WorldAgent.MessageHandlerBehaviour-468"><span class="linenos">468</span></a><span class="sd">                Exception: Any runtime error during query processing</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-469"><a href="#WorldAgent.MessageHandlerBehaviour-469"><span class="linenos">469</span></a><span class="sd">                    (caught and reported in error response)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-470"><a href="#WorldAgent.MessageHandlerBehaviour-470"><span class="linenos">470</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-471"><a href="#WorldAgent.MessageHandlerBehaviour-471"><span class="linenos">471</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-472"><a href="#WorldAgent.MessageHandlerBehaviour-472"><span class="linenos">472</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-473"><a href="#WorldAgent.MessageHandlerBehaviour-473"><span class="linenos">473</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-474"><a href="#WorldAgent.MessageHandlerBehaviour-474"><span class="linenos">474</span></a>                <span class="n">node_u</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_u&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-475"><a href="#WorldAgent.MessageHandlerBehaviour-475"><span class="linenos">475</span></a>                <span class="n">node_v</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_v&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-476"><a href="#WorldAgent.MessageHandlerBehaviour-476"><span class="linenos">476</span></a>                
</span><span id="WorldAgent.MessageHandlerBehaviour-477"><a href="#WorldAgent.MessageHandlerBehaviour-477"><span class="linenos">477</span></a>                <span class="n">edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">node_u</span><span class="p">,</span> <span class="n">node_v</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-478"><a href="#WorldAgent.MessageHandlerBehaviour-478"><span class="linenos">478</span></a>                
</span><span id="WorldAgent.MessageHandlerBehaviour-479"><a href="#WorldAgent.MessageHandlerBehaviour-479"><span class="linenos">479</span></a>                <span class="k">if</span> <span class="n">edge</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-480"><a href="#WorldAgent.MessageHandlerBehaviour-480"><span class="linenos">480</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-481"><a href="#WorldAgent.MessageHandlerBehaviour-481"><span class="linenos">481</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-482"><a href="#WorldAgent.MessageHandlerBehaviour-482"><span class="linenos">482</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-483"><a href="#WorldAgent.MessageHandlerBehaviour-483"><span class="linenos">483</span></a>                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Edge (</span><span class="si">{</span><span class="n">node_u</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">node_v</span><span class="si">}</span><span class="s2">) not found&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-484"><a href="#WorldAgent.MessageHandlerBehaviour-484"><span class="linenos">484</span></a>                    <span class="p">})</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-485"><a href="#WorldAgent.MessageHandlerBehaviour-485"><span class="linenos">485</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-486"><a href="#WorldAgent.MessageHandlerBehaviour-486"><span class="linenos">486</span></a>                    <span class="n">edge_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-487"><a href="#WorldAgent.MessageHandlerBehaviour-487"><span class="linenos">487</span></a>                        <span class="s2">&quot;node_u&quot;</span><span class="p">:</span> <span class="n">node_u</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-488"><a href="#WorldAgent.MessageHandlerBehaviour-488"><span class="linenos">488</span></a>                        <span class="s2">&quot;node_v&quot;</span><span class="p">:</span> <span class="n">node_v</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-489"><a href="#WorldAgent.MessageHandlerBehaviour-489"><span class="linenos">489</span></a>                        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-490"><a href="#WorldAgent.MessageHandlerBehaviour-490"><span class="linenos">490</span></a>                        <span class="s2">&quot;initial_weight&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">initial_weight</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-491"><a href="#WorldAgent.MessageHandlerBehaviour-491"><span class="linenos">491</span></a>                        <span class="s2">&quot;distance&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">distance</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-492"><a href="#WorldAgent.MessageHandlerBehaviour-492"><span class="linenos">492</span></a>                        <span class="s2">&quot;fuel_consumption&quot;</span><span class="p">:</span> <span class="n">edge</span><span class="o">.</span><span class="n">get_fuel_consumption</span><span class="p">(),</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-493"><a href="#WorldAgent.MessageHandlerBehaviour-493"><span class="linenos">493</span></a>                        <span class="s2">&quot;is_infected&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">node_u</span><span class="p">,</span> <span class="n">node_v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">infected_edges</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-494"><a href="#WorldAgent.MessageHandlerBehaviour-494"><span class="linenos">494</span></a>                    <span class="p">}</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-495"><a href="#WorldAgent.MessageHandlerBehaviour-495"><span class="linenos">495</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour-496"><a href="#WorldAgent.MessageHandlerBehaviour-496"><span class="linenos">496</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-497"><a href="#WorldAgent.MessageHandlerBehaviour-497"><span class="linenos">497</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-498"><a href="#WorldAgent.MessageHandlerBehaviour-498"><span class="linenos">498</span></a>                    <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-499"><a href="#WorldAgent.MessageHandlerBehaviour-499"><span class="linenos">499</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;edge_info&quot;</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-500"><a href="#WorldAgent.MessageHandlerBehaviour-500"><span class="linenos">500</span></a>                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">edge_data</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-501"><a href="#WorldAgent.MessageHandlerBehaviour-501"><span class="linenos">501</span></a>                    <span class="p">})</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-502"><a href="#WorldAgent.MessageHandlerBehaviour-502"><span class="linenos">502</span></a>                
</span><span id="WorldAgent.MessageHandlerBehaviour-503"><a href="#WorldAgent.MessageHandlerBehaviour-503"><span class="linenos">503</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-504"><a href="#WorldAgent.MessageHandlerBehaviour-504"><span class="linenos">504</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Edge (</span><span class="si">{</span><span class="n">node_u</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">node_v</span><span class="si">}</span><span class="s2">) information sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-505"><a href="#WorldAgent.MessageHandlerBehaviour-505"><span class="linenos">505</span></a>                
</span><span id="WorldAgent.MessageHandlerBehaviour-506"><a href="#WorldAgent.MessageHandlerBehaviour-506"><span class="linenos">506</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-507"><a href="#WorldAgent.MessageHandlerBehaviour-507"><span class="linenos">507</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-508"><a href="#WorldAgent.MessageHandlerBehaviour-508"><span class="linenos">508</span></a>                <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-509"><a href="#WorldAgent.MessageHandlerBehaviour-509"><span class="linenos">509</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-510"><a href="#WorldAgent.MessageHandlerBehaviour-510"><span class="linenos">510</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-511"><a href="#WorldAgent.MessageHandlerBehaviour-511"><span class="linenos">511</span></a>                <span class="p">})</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-512"><a href="#WorldAgent.MessageHandlerBehaviour-512"><span class="linenos">512</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-513"><a href="#WorldAgent.MessageHandlerBehaviour-513"><span class="linenos">513</span></a>
</span><span id="WorldAgent.MessageHandlerBehaviour-514"><a href="#WorldAgent.MessageHandlerBehaviour-514"><span class="linenos">514</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_facilities_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-515"><a href="#WorldAgent.MessageHandlerBehaviour-515"><span class="linenos">515</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle query for facility locations.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-516"><a href="#WorldAgent.MessageHandlerBehaviour-516"><span class="linenos">516</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-517"><a href="#WorldAgent.MessageHandlerBehaviour-517"><span class="linenos">517</span></a><span class="sd">            Responds to queries requesting the complete list of all supply chain</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-518"><a href="#WorldAgent.MessageHandlerBehaviour-518"><span class="linenos">518</span></a><span class="sd">            facility locations organized by type. This includes warehouses, suppliers,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-519"><a href="#WorldAgent.MessageHandlerBehaviour-519"><span class="linenos">519</span></a><span class="sd">            gas stations, and stores. The facilities are represented by their node IDs</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-520"><a href="#WorldAgent.MessageHandlerBehaviour-520"><span class="linenos">520</span></a><span class="sd">            in the supply chain graph.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-521"><a href="#WorldAgent.MessageHandlerBehaviour-521"><span class="linenos">521</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-522"><a href="#WorldAgent.MessageHandlerBehaviour-522"><span class="linenos">522</span></a><span class="sd">            FIPA Query/Response Protocol:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-523"><a href="#WorldAgent.MessageHandlerBehaviour-523"><span class="linenos">523</span></a><span class="sd">            - Receives QUERY message for facility locations</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-524"><a href="#WorldAgent.MessageHandlerBehaviour-524"><span class="linenos">524</span></a><span class="sd">            - Iterates through all nodes in graph checking facility flags</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-525"><a href="#WorldAgent.MessageHandlerBehaviour-525"><span class="linenos">525</span></a><span class="sd">            - Returns INFORM message with categorized facility lists</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-526"><a href="#WorldAgent.MessageHandlerBehaviour-526"><span class="linenos">526</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-527"><a href="#WorldAgent.MessageHandlerBehaviour-527"><span class="linenos">527</span></a><span class="sd">            This query is useful for agents that need to plan routes or coordinate</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-528"><a href="#WorldAgent.MessageHandlerBehaviour-528"><span class="linenos">528</span></a><span class="sd">            with specific facility types without needing full node data.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-529"><a href="#WorldAgent.MessageHandlerBehaviour-529"><span class="linenos">529</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-530"><a href="#WorldAgent.MessageHandlerBehaviour-530"><span class="linenos">530</span></a><span class="sd">            Args:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-531"><a href="#WorldAgent.MessageHandlerBehaviour-531"><span class="linenos">531</span></a><span class="sd">                msg (Message): The incoming query message from sender agent.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-532"><a href="#WorldAgent.MessageHandlerBehaviour-532"><span class="linenos">532</span></a><span class="sd">                    Expected to be of type &quot;query_facilities&quot; in JSON body.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-533"><a href="#WorldAgent.MessageHandlerBehaviour-533"><span class="linenos">533</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-534"><a href="#WorldAgent.MessageHandlerBehaviour-534"><span class="linenos">534</span></a><span class="sd">            Returns:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-535"><a href="#WorldAgent.MessageHandlerBehaviour-535"><span class="linenos">535</span></a><span class="sd">                None: Sends FIPA INFORM message with facilities categorized by type</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-536"><a href="#WorldAgent.MessageHandlerBehaviour-536"><span class="linenos">536</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-537"><a href="#WorldAgent.MessageHandlerBehaviour-537"><span class="linenos">537</span></a><span class="sd">            Response payload structure:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-538"><a href="#WorldAgent.MessageHandlerBehaviour-538"><span class="linenos">538</span></a><span class="sd">                - warehouses: List of node IDs hosting warehouse facilities</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-539"><a href="#WorldAgent.MessageHandlerBehaviour-539"><span class="linenos">539</span></a><span class="sd">                - suppliers: List of node IDs hosting supplier facilities</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-540"><a href="#WorldAgent.MessageHandlerBehaviour-540"><span class="linenos">540</span></a><span class="sd">                - stores: List of node IDs hosting store facilities</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-541"><a href="#WorldAgent.MessageHandlerBehaviour-541"><span class="linenos">541</span></a><span class="sd">                - gas_stations: List of node IDs hosting gas station facilities</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-542"><a href="#WorldAgent.MessageHandlerBehaviour-542"><span class="linenos">542</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-543"><a href="#WorldAgent.MessageHandlerBehaviour-543"><span class="linenos">543</span></a><span class="sd">            Note:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-544"><a href="#WorldAgent.MessageHandlerBehaviour-544"><span class="linenos">544</span></a><span class="sd">                A single node can host multiple facilities simultaneously.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-545"><a href="#WorldAgent.MessageHandlerBehaviour-545"><span class="linenos">545</span></a><span class="sd">                Facilities are identified based on boolean flags on node objects.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-546"><a href="#WorldAgent.MessageHandlerBehaviour-546"><span class="linenos">546</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-547"><a href="#WorldAgent.MessageHandlerBehaviour-547"><span class="linenos">547</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-548"><a href="#WorldAgent.MessageHandlerBehaviour-548"><span class="linenos">548</span></a>            
</span><span id="WorldAgent.MessageHandlerBehaviour-549"><a href="#WorldAgent.MessageHandlerBehaviour-549"><span class="linenos">549</span></a>            <span class="n">facilities</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-550"><a href="#WorldAgent.MessageHandlerBehaviour-550"><span class="linenos">550</span></a>                <span class="s2">&quot;warehouses&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-551"><a href="#WorldAgent.MessageHandlerBehaviour-551"><span class="linenos">551</span></a>                <span class="s2">&quot;suppliers&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-552"><a href="#WorldAgent.MessageHandlerBehaviour-552"><span class="linenos">552</span></a>                <span class="s2">&quot;stores&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-553"><a href="#WorldAgent.MessageHandlerBehaviour-553"><span class="linenos">553</span></a>                <span class="s2">&quot;gas_stations&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-554"><a href="#WorldAgent.MessageHandlerBehaviour-554"><span class="linenos">554</span></a>            <span class="p">}</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-555"><a href="#WorldAgent.MessageHandlerBehaviour-555"><span class="linenos">555</span></a>            
</span><span id="WorldAgent.MessageHandlerBehaviour-556"><a href="#WorldAgent.MessageHandlerBehaviour-556"><span class="linenos">556</span></a>            <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-557"><a href="#WorldAgent.MessageHandlerBehaviour-557"><span class="linenos">557</span></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">warehouse</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-558"><a href="#WorldAgent.MessageHandlerBehaviour-558"><span class="linenos">558</span></a>                    <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;warehouses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-559"><a href="#WorldAgent.MessageHandlerBehaviour-559"><span class="linenos">559</span></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">supplier</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-560"><a href="#WorldAgent.MessageHandlerBehaviour-560"><span class="linenos">560</span></a>                    <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;suppliers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-561"><a href="#WorldAgent.MessageHandlerBehaviour-561"><span class="linenos">561</span></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-562"><a href="#WorldAgent.MessageHandlerBehaviour-562"><span class="linenos">562</span></a>                    <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;stores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-563"><a href="#WorldAgent.MessageHandlerBehaviour-563"><span class="linenos">563</span></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">gas_station</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-564"><a href="#WorldAgent.MessageHandlerBehaviour-564"><span class="linenos">564</span></a>                    <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;gas_stations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-565"><a href="#WorldAgent.MessageHandlerBehaviour-565"><span class="linenos">565</span></a>            
</span><span id="WorldAgent.MessageHandlerBehaviour-566"><a href="#WorldAgent.MessageHandlerBehaviour-566"><span class="linenos">566</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-567"><a href="#WorldAgent.MessageHandlerBehaviour-567"><span class="linenos">567</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-568"><a href="#WorldAgent.MessageHandlerBehaviour-568"><span class="linenos">568</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-569"><a href="#WorldAgent.MessageHandlerBehaviour-569"><span class="linenos">569</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;facilities_info&quot;</span><span class="p">,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-570"><a href="#WorldAgent.MessageHandlerBehaviour-570"><span class="linenos">570</span></a>                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">facilities</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-571"><a href="#WorldAgent.MessageHandlerBehaviour-571"><span class="linenos">571</span></a>            <span class="p">})</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-572"><a href="#WorldAgent.MessageHandlerBehaviour-572"><span class="linenos">572</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-573"><a href="#WorldAgent.MessageHandlerBehaviour-573"><span class="linenos">573</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Facilities information sent to </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-574"><a href="#WorldAgent.MessageHandlerBehaviour-574"><span class="linenos">574</span></a>
</span><span id="WorldAgent.MessageHandlerBehaviour-575"><a href="#WorldAgent.MessageHandlerBehaviour-575"><span class="linenos">575</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-576"><a href="#WorldAgent.MessageHandlerBehaviour-576"><span class="linenos">576</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle subscription requests for world state updates.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-577"><a href="#WorldAgent.MessageHandlerBehaviour-577"><span class="linenos">577</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-578"><a href="#WorldAgent.MessageHandlerBehaviour-578"><span class="linenos">578</span></a><span class="sd">            Processes subscription requests from agents that wish to receive</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-579"><a href="#WorldAgent.MessageHandlerBehaviour-579"><span class="linenos">579</span></a><span class="sd">            periodic world state update broadcasts. When an agent subscribes,</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-580"><a href="#WorldAgent.MessageHandlerBehaviour-580"><span class="linenos">580</span></a><span class="sd">            it is added to the WorldAgent&#39;s subscriber list and will receive</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-581"><a href="#WorldAgent.MessageHandlerBehaviour-581"><span class="linenos">581</span></a><span class="sd">            INFORM messages whenever the world state changes significantly</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-582"><a href="#WorldAgent.MessageHandlerBehaviour-582"><span class="linenos">582</span></a><span class="sd">            (e.g., when new traffic events occur).</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-583"><a href="#WorldAgent.MessageHandlerBehaviour-583"><span class="linenos">583</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-584"><a href="#WorldAgent.MessageHandlerBehaviour-584"><span class="linenos">584</span></a><span class="sd">            FIPA Publish/Subscribe Pattern:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-585"><a href="#WorldAgent.MessageHandlerBehaviour-585"><span class="linenos">585</span></a><span class="sd">            - Receives SUBSCRIBE message from requesting agent</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-586"><a href="#WorldAgent.MessageHandlerBehaviour-586"><span class="linenos">586</span></a><span class="sd">            - Validates agent is not already subscribed (prevents duplicates)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-587"><a href="#WorldAgent.MessageHandlerBehaviour-587"><span class="linenos">587</span></a><span class="sd">            - Adds agent JID to internal subscriber list</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-588"><a href="#WorldAgent.MessageHandlerBehaviour-588"><span class="linenos">588</span></a><span class="sd">            - Sends confirmation message back to subscriber</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-589"><a href="#WorldAgent.MessageHandlerBehaviour-589"><span class="linenos">589</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-590"><a href="#WorldAgent.MessageHandlerBehaviour-590"><span class="linenos">590</span></a><span class="sd">            The subscription mechanism allows agents to stay informed about</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-591"><a href="#WorldAgent.MessageHandlerBehaviour-591"><span class="linenos">591</span></a><span class="sd">            world state changes without polling for updates.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-592"><a href="#WorldAgent.MessageHandlerBehaviour-592"><span class="linenos">592</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-593"><a href="#WorldAgent.MessageHandlerBehaviour-593"><span class="linenos">593</span></a><span class="sd">            Args:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-594"><a href="#WorldAgent.MessageHandlerBehaviour-594"><span class="linenos">594</span></a><span class="sd">                msg (Message): The incoming subscription request message.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-595"><a href="#WorldAgent.MessageHandlerBehaviour-595"><span class="linenos">595</span></a><span class="sd">                    Expected to be of type &quot;subscribe&quot; in JSON body.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-596"><a href="#WorldAgent.MessageHandlerBehaviour-596"><span class="linenos">596</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-597"><a href="#WorldAgent.MessageHandlerBehaviour-597"><span class="linenos">597</span></a><span class="sd">            Returns:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-598"><a href="#WorldAgent.MessageHandlerBehaviour-598"><span class="linenos">598</span></a><span class="sd">                None: Adds sender to subscribers and sends confirmation</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-599"><a href="#WorldAgent.MessageHandlerBehaviour-599"><span class="linenos">599</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-600"><a href="#WorldAgent.MessageHandlerBehaviour-600"><span class="linenos">600</span></a><span class="sd">            Side Effects:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-601"><a href="#WorldAgent.MessageHandlerBehaviour-601"><span class="linenos">601</span></a><span class="sd">                - Adds sender JID to self.agent.subscribers list</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-602"><a href="#WorldAgent.MessageHandlerBehaviour-602"><span class="linenos">602</span></a><span class="sd">                - Logs subscription confirmation message</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-603"><a href="#WorldAgent.MessageHandlerBehaviour-603"><span class="linenos">603</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-604"><a href="#WorldAgent.MessageHandlerBehaviour-604"><span class="linenos">604</span></a><span class="sd">            Confirmation Response:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-605"><a href="#WorldAgent.MessageHandlerBehaviour-605"><span class="linenos">605</span></a><span class="sd">                - type: &quot;subscription_confirmed&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-606"><a href="#WorldAgent.MessageHandlerBehaviour-606"><span class="linenos">606</span></a><span class="sd">                - performative: &quot;confirm&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-607"><a href="#WorldAgent.MessageHandlerBehaviour-607"><span class="linenos">607</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour-608"><a href="#WorldAgent.MessageHandlerBehaviour-608"><span class="linenos">608</span></a><span class="sd">            Once subscribed, the agent will receive messages via</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-609"><a href="#WorldAgent.MessageHandlerBehaviour-609"><span class="linenos">609</span></a><span class="sd">            _broadcast_world_state() when updates are available.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-610"><a href="#WorldAgent.MessageHandlerBehaviour-610"><span class="linenos">610</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-611"><a href="#WorldAgent.MessageHandlerBehaviour-611"><span class="linenos">611</span></a>            <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-612"><a href="#WorldAgent.MessageHandlerBehaviour-612"><span class="linenos">612</span></a>            <span class="k">if</span> <span class="n">sender</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">subscribers</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-613"><a href="#WorldAgent.MessageHandlerBehaviour-613"><span class="linenos">613</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">subscribers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-614"><a href="#WorldAgent.MessageHandlerBehaviour-614"><span class="linenos">614</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Agent </span><span class="si">{</span><span class="n">sender</span><span class="si">}</span><span class="s2"> subscribed to world updates&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-615"><a href="#WorldAgent.MessageHandlerBehaviour-615"><span class="linenos">615</span></a>            
</span><span id="WorldAgent.MessageHandlerBehaviour-616"><a href="#WorldAgent.MessageHandlerBehaviour-616"><span class="linenos">616</span></a>            <span class="c1"># Send confirmation</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-617"><a href="#WorldAgent.MessageHandlerBehaviour-617"><span class="linenos">617</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-618"><a href="#WorldAgent.MessageHandlerBehaviour-618"><span class="linenos">618</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;confirm&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-619"><a href="#WorldAgent.MessageHandlerBehaviour-619"><span class="linenos">619</span></a>            <span class="n">response</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-620"><a href="#WorldAgent.MessageHandlerBehaviour-620"><span class="linenos">620</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;subscription_confirmed&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-621"><a href="#WorldAgent.MessageHandlerBehaviour-621"><span class="linenos">621</span></a>            <span class="p">})</span>
</span><span id="WorldAgent.MessageHandlerBehaviour-622"><a href="#WorldAgent.MessageHandlerBehaviour-622"><span class="linenos">622</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Handles incoming messages from other agents.</p>

<p>This behaviour processes all general query and subscription messages from
other agents in the supply chain system. It operates as a message dispatcher,
routing incoming messages to specialized handler methods based on the
message type field.</p>

<p>Supported message types and their handlers:</p>

<ul>
<li>"query_world_state": Returns complete world simulation state</li>
<li>"query_node_info": Returns information about a specific graph node</li>
<li>"query_edge_info": Returns information about a specific edge</li>
<li>"query_facilities": Returns locations of all supply chain facilities</li>
<li>"subscribe": Registers an agent for periodic world state updates</li>
</ul>

<p>FIPA Protocol Compliance:</p>

<ul>
<li>Processes messages from agents following FIPA protocols</li>
<li>Sends INFORM messages (performative="inform") for successful queries</li>
<li>Returns ERROR messages for queries that fail or have invalid parameters</li>
<li>Handles SUBSCRIBE messages for publish/subscribe pattern coordination</li>
</ul>

<p>Message Flow:</p>

<ol>
<li>Receives a message with JSON body containing "type" field</li>
<li>Validates JSON structure and extracts message type</li>
<li>Routes to appropriate private handler method (_handle_*)</li>
<li>Handler method constructs response with agent's data</li>
<li>Response sent back to originating agent</li>
</ol>

<p>Error Handling:</p>

<ul>
<li>JSON decode errors are logged and ignored</li>
<li>Unknown message types are logged with diagnostic info</li>
<li>Handler exceptions are caught and logged</li>
</ul>

<p>This behaviour runs cyclically with a 1-second timeout between iterations.</p>
</div>


                            <div id="WorldAgent.MessageHandlerBehaviour.run" class="classattr">
                                        <input id="WorldAgent.MessageHandlerBehaviour.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="WorldAgent.MessageHandlerBehaviour.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#WorldAgent.MessageHandlerBehaviour.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="WorldAgent.MessageHandlerBehaviour.run-240"><a href="#WorldAgent.MessageHandlerBehaviour.run-240"><span class="linenos">240</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-241"><a href="#WorldAgent.MessageHandlerBehaviour.run-241"><span class="linenos">241</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Process incoming messages.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-242"><a href="#WorldAgent.MessageHandlerBehaviour.run-242"><span class="linenos">242</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-243"><a href="#WorldAgent.MessageHandlerBehaviour.run-243"><span class="linenos">243</span></a><span class="sd">            Executes one iteration of the cyclic message handling. This method:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-244"><a href="#WorldAgent.MessageHandlerBehaviour.run-244"><span class="linenos">244</span></a><span class="sd">            1. Waits up to 1 second for an incoming message</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-245"><a href="#WorldAgent.MessageHandlerBehaviour.run-245"><span class="linenos">245</span></a><span class="sd">            2. If no message arrives within timeout, cycles immediately</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-246"><a href="#WorldAgent.MessageHandlerBehaviour.run-246"><span class="linenos">246</span></a><span class="sd">            3. If a message arrives, attempts to parse it as JSON</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-247"><a href="#WorldAgent.MessageHandlerBehaviour.run-247"><span class="linenos">247</span></a><span class="sd">            4. Extracts the &quot;type&quot; field to determine message category</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-248"><a href="#WorldAgent.MessageHandlerBehaviour.run-248"><span class="linenos">248</span></a><span class="sd">            5. Dispatches to the appropriate handler coroutine</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-249"><a href="#WorldAgent.MessageHandlerBehaviour.run-249"><span class="linenos">249</span></a><span class="sd">            6. Catches and logs any JSON or handler exceptions</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-250"><a href="#WorldAgent.MessageHandlerBehaviour.run-250"><span class="linenos">250</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-251"><a href="#WorldAgent.MessageHandlerBehaviour.run-251"><span class="linenos">251</span></a><span class="sd">            The dispatcher pattern allows different message types to be handled</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-252"><a href="#WorldAgent.MessageHandlerBehaviour.run-252"><span class="linenos">252</span></a><span class="sd">            by specialized methods, keeping this method focused on high-level</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-253"><a href="#WorldAgent.MessageHandlerBehaviour.run-253"><span class="linenos">253</span></a><span class="sd">            message routing and error handling.</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-254"><a href="#WorldAgent.MessageHandlerBehaviour.run-254"><span class="linenos">254</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-255"><a href="#WorldAgent.MessageHandlerBehaviour.run-255"><span class="linenos">255</span></a><span class="sd">            Raises:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-256"><a href="#WorldAgent.MessageHandlerBehaviour.run-256"><span class="linenos">256</span></a><span class="sd">                json.JSONDecodeError: If msg.body is not valid JSON (caught, logged)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-257"><a href="#WorldAgent.MessageHandlerBehaviour.run-257"><span class="linenos">257</span></a><span class="sd">                Exception: Any handler exception (caught, logged)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-258"><a href="#WorldAgent.MessageHandlerBehaviour.run-258"><span class="linenos">258</span></a><span class="sd">            </span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-259"><a href="#WorldAgent.MessageHandlerBehaviour.run-259"><span class="linenos">259</span></a><span class="sd">            Yields:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-260"><a href="#WorldAgent.MessageHandlerBehaviour.run-260"><span class="linenos">260</span></a><span class="sd">                None: Continues indefinitely as a cyclic behaviour</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-261"><a href="#WorldAgent.MessageHandlerBehaviour.run-261"><span class="linenos">261</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-262"><a href="#WorldAgent.MessageHandlerBehaviour.run-262"><span class="linenos">262</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-263"><a href="#WorldAgent.MessageHandlerBehaviour.run-263"><span class="linenos">263</span></a>            
</span><span id="WorldAgent.MessageHandlerBehaviour.run-264"><a href="#WorldAgent.MessageHandlerBehaviour.run-264"><span class="linenos">264</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-265"><a href="#WorldAgent.MessageHandlerBehaviour.run-265"><span class="linenos">265</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-266"><a href="#WorldAgent.MessageHandlerBehaviour.run-266"><span class="linenos">266</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-267"><a href="#WorldAgent.MessageHandlerBehaviour.run-267"><span class="linenos">267</span></a>                    <span class="n">msg_type</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-268"><a href="#WorldAgent.MessageHandlerBehaviour.run-268"><span class="linenos">268</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour.run-269"><a href="#WorldAgent.MessageHandlerBehaviour.run-269"><span class="linenos">269</span></a>                    <span class="k">if</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_world_state&quot;</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-270"><a href="#WorldAgent.MessageHandlerBehaviour.run-270"><span class="linenos">270</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_world_state_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-271"><a href="#WorldAgent.MessageHandlerBehaviour.run-271"><span class="linenos">271</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour.run-272"><a href="#WorldAgent.MessageHandlerBehaviour.run-272"><span class="linenos">272</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_node_info&quot;</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-273"><a href="#WorldAgent.MessageHandlerBehaviour.run-273"><span class="linenos">273</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_node_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-274"><a href="#WorldAgent.MessageHandlerBehaviour.run-274"><span class="linenos">274</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour.run-275"><a href="#WorldAgent.MessageHandlerBehaviour.run-275"><span class="linenos">275</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_edge_info&quot;</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-276"><a href="#WorldAgent.MessageHandlerBehaviour.run-276"><span class="linenos">276</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_edge_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-277"><a href="#WorldAgent.MessageHandlerBehaviour.run-277"><span class="linenos">277</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour.run-278"><a href="#WorldAgent.MessageHandlerBehaviour.run-278"><span class="linenos">278</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;query_facilities&quot;</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-279"><a href="#WorldAgent.MessageHandlerBehaviour.run-279"><span class="linenos">279</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_facilities_query</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-280"><a href="#WorldAgent.MessageHandlerBehaviour.run-280"><span class="linenos">280</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour.run-281"><a href="#WorldAgent.MessageHandlerBehaviour.run-281"><span class="linenos">281</span></a>                    <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-282"><a href="#WorldAgent.MessageHandlerBehaviour.run-282"><span class="linenos">282</span></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_subscribe</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-283"><a href="#WorldAgent.MessageHandlerBehaviour.run-283"><span class="linenos">283</span></a>                    
</span><span id="WorldAgent.MessageHandlerBehaviour.run-284"><a href="#WorldAgent.MessageHandlerBehaviour.run-284"><span class="linenos">284</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-285"><a href="#WorldAgent.MessageHandlerBehaviour.run-285"><span class="linenos">285</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Unknown message type: </span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-286"><a href="#WorldAgent.MessageHandlerBehaviour.run-286"><span class="linenos">286</span></a>                        
</span><span id="WorldAgent.MessageHandlerBehaviour.run-287"><a href="#WorldAgent.MessageHandlerBehaviour.run-287"><span class="linenos">287</span></a>                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-288"><a href="#WorldAgent.MessageHandlerBehaviour.run-288"><span class="linenos">288</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error decoding message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-289"><a href="#WorldAgent.MessageHandlerBehaviour.run-289"><span class="linenos">289</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="WorldAgent.MessageHandlerBehaviour.run-290"><a href="#WorldAgent.MessageHandlerBehaviour.run-290"><span class="linenos">290</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Error handling message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Process incoming messages.</p>

<p>Executes one iteration of the cyclic message handling. This method:</p>

<ol>
<li>Waits up to 1 second for an incoming message</li>
<li>If no message arrives within timeout, cycles immediately</li>
<li>If a message arrives, attempts to parse it as JSON</li>
<li>Extracts the "type" field to determine message category</li>
<li>Dispatches to the appropriate handler coroutine</li>
<li>Catches and logs any JSON or handler exceptions</li>
</ol>

<p>The dispatcher pattern allows different message types to be handled
by specialized methods, keeping this method focused on high-level
message routing and error handling.</p>

<h6 id="raises">Raises:</h6>

<ul>
<li><strong>json.JSONDecodeError:</strong>  If msg.body is not valid JSON (caught, logged)</li>
<li><strong>Exception:</strong>  Any handler exception (caught, logged)</li>
</ul>

<h6 id="yields">Yields:</h6>

<blockquote>
  <p>None: Continues indefinitely as a cyclic behaviour</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="main">
                            <input id="main-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">main</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="main-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#main"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="main-739"><a href="#main-739"><span class="linenos">739</span></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="main-740"><a href="#main-740"><span class="linenos">740</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main entry point for the WorldAgent.</span>
</span><span id="main-741"><a href="#main-741"><span class="linenos">741</span></a><span class="sd">    </span>
</span><span id="main-742"><a href="#main-742"><span class="linenos">742</span></a><span class="sd">    Initializes and starts the WorldAgent instance, handling its lifecycle</span>
</span><span id="main-743"><a href="#main-743"><span class="linenos">743</span></a><span class="sd">    from startup through shutdown. This is the entry function used when</span>
</span><span id="main-744"><a href="#main-744"><span class="linenos">744</span></a><span class="sd">    running the WorldAgent as a standalone SPADE agent.</span>
</span><span id="main-745"><a href="#main-745"><span class="linenos">745</span></a><span class="sd">    </span>
</span><span id="main-746"><a href="#main-746"><span class="linenos">746</span></a><span class="sd">    Prerequisites:</span>
</span><span id="main-747"><a href="#main-747"><span class="linenos">747</span></a><span class="sd">    - An XMPP server (such as ejabberd) must be running and accessible</span>
</span><span id="main-748"><a href="#main-748"><span class="linenos">748</span></a><span class="sd">    - Default configuration uses localhost:5222 (standard XMPP port)</span>
</span><span id="main-749"><a href="#main-749"><span class="linenos">749</span></a><span class="sd">    - An agent account must exist on the XMPP server with matching JID/password</span>
</span><span id="main-750"><a href="#main-750"><span class="linenos">750</span></a><span class="sd">    </span>
</span><span id="main-751"><a href="#main-751"><span class="linenos">751</span></a><span class="sd">    Configuration:</span>
</span><span id="main-752"><a href="#main-752"><span class="linenos">752</span></a><span class="sd">    - Agent JID: &quot;world@localhost&quot; (change to match your XMPP server)</span>
</span><span id="main-753"><a href="#main-753"><span class="linenos">753</span></a><span class="sd">    - Password: &quot;password&quot; (change to match registered account)</span>
</span><span id="main-754"><a href="#main-754"><span class="linenos">754</span></a><span class="sd">    - Server: localhost (default XMPP configuration)</span>
</span><span id="main-755"><a href="#main-755"><span class="linenos">755</span></a><span class="sd">    </span>
</span><span id="main-756"><a href="#main-756"><span class="linenos">756</span></a><span class="sd">    Lifecycle:</span>
</span><span id="main-757"><a href="#main-757"><span class="linenos">757</span></a><span class="sd">    1. Creates a new WorldAgent instance</span>
</span><span id="main-758"><a href="#main-758"><span class="linenos">758</span></a><span class="sd">    2. Calls start() to initialize the agent on XMPP server</span>
</span><span id="main-759"><a href="#main-759"><span class="linenos">759</span></a><span class="sd">    3. Enters infinite loop to keep agent running</span>
</span><span id="main-760"><a href="#main-760"><span class="linenos">760</span></a><span class="sd">    4. On KeyboardInterrupt (Ctrl+C), cleanly stops the agent</span>
</span><span id="main-761"><a href="#main-761"><span class="linenos">761</span></a><span class="sd">    5. Handles any exceptions during execution</span>
</span><span id="main-762"><a href="#main-762"><span class="linenos">762</span></a><span class="sd">    </span>
</span><span id="main-763"><a href="#main-763"><span class="linenos">763</span></a><span class="sd">    Error Handling:</span>
</span><span id="main-764"><a href="#main-764"><span class="linenos">764</span></a><span class="sd">    - KeyboardInterrupt: Graceful shutdown with cleanup</span>
</span><span id="main-765"><a href="#main-765"><span class="linenos">765</span></a><span class="sd">    - Other Exceptions: Logged and agent stopped with cleanup</span>
</span><span id="main-766"><a href="#main-766"><span class="linenos">766</span></a><span class="sd">    </span>
</span><span id="main-767"><a href="#main-767"><span class="linenos">767</span></a><span class="sd">    Args:</span>
</span><span id="main-768"><a href="#main-768"><span class="linenos">768</span></a><span class="sd">        None: Entry function with no parameters</span>
</span><span id="main-769"><a href="#main-769"><span class="linenos">769</span></a><span class="sd">    </span>
</span><span id="main-770"><a href="#main-770"><span class="linenos">770</span></a><span class="sd">    Returns:</span>
</span><span id="main-771"><a href="#main-771"><span class="linenos">771</span></a><span class="sd">        None: Async coroutine, called via spade.run()</span>
</span><span id="main-772"><a href="#main-772"><span class="linenos">772</span></a><span class="sd">    </span>
</span><span id="main-773"><a href="#main-773"><span class="linenos">773</span></a><span class="sd">    Usage:</span>
</span><span id="main-774"><a href="#main-774"><span class="linenos">774</span></a><span class="sd">        Run via: python world_agent.py</span>
</span><span id="main-775"><a href="#main-775"><span class="linenos">775</span></a><span class="sd">        Stop via: Press Ctrl+C in terminal</span>
</span><span id="main-776"><a href="#main-776"><span class="linenos">776</span></a><span class="sd">    </span>
</span><span id="main-777"><a href="#main-777"><span class="linenos">777</span></a><span class="sd">    Note:</span>
</span><span id="main-778"><a href="#main-778"><span class="linenos">778</span></a><span class="sd">        This function is called by spade.run() which manages the asyncio event loop</span>
</span><span id="main-779"><a href="#main-779"><span class="linenos">779</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="main-780"><a href="#main-780"><span class="linenos">780</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Starting SPADE WorldAgent ---&quot;</span><span class="p">)</span>
</span><span id="main-781"><a href="#main-781"><span class="linenos">781</span></a>    
</span><span id="main-782"><a href="#main-782"><span class="linenos">782</span></a>    <span class="c1"># Create and start the WorldAgent</span>
</span><span id="main-783"><a href="#main-783"><span class="linenos">783</span></a>    <span class="c1"># NOTE: Change credentials and server as needed</span>
</span><span id="main-784"><a href="#main-784"><span class="linenos">784</span></a>    <span class="n">world_agent</span> <span class="o">=</span> <span class="n">WorldAgent</span><span class="p">(</span><span class="s2">&quot;world@localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>
</span><span id="main-785"><a href="#main-785"><span class="linenos">785</span></a>    
</span><span id="main-786"><a href="#main-786"><span class="linenos">786</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="main-787"><a href="#main-787"><span class="linenos">787</span></a>        <span class="k">await</span> <span class="n">world_agent</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="main-788"><a href="#main-788"><span class="linenos">788</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WorldAgent started successfully!&quot;</span><span class="p">)</span>
</span><span id="main-789"><a href="#main-789"><span class="linenos">789</span></a>        
</span><span id="main-790"><a href="#main-790"><span class="linenos">790</span></a>        <span class="c1"># Keep the agent running</span>
</span><span id="main-791"><a href="#main-791"><span class="linenos">791</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="main-792"><a href="#main-792"><span class="linenos">792</span></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="main-793"><a href="#main-793"><span class="linenos">793</span></a>            
</span><span id="main-794"><a href="#main-794"><span class="linenos">794</span></a>    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="main-795"><a href="#main-795"><span class="linenos">795</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Stopping WorldAgent ---&quot;</span><span class="p">)</span>
</span><span id="main-796"><a href="#main-796"><span class="linenos">796</span></a>        <span class="k">await</span> <span class="n">world_agent</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="main-797"><a href="#main-797"><span class="linenos">797</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="main-798"><a href="#main-798"><span class="linenos">798</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="main-799"><a href="#main-799"><span class="linenos">799</span></a>        <span class="k">await</span> <span class="n">world_agent</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Main entry point for the WorldAgent.</p>

<p>Initializes and starts the WorldAgent instance, handling its lifecycle
from startup through shutdown. This is the entry function used when
running the WorldAgent as a standalone SPADE agent.</p>

<p>Prerequisites:</p>

<ul>
<li>An XMPP server (such as ejabberd) must be running and accessible</li>
<li>Default configuration uses localhost:5222 (standard XMPP port)</li>
<li>An agent account must exist on the XMPP server with matching JID/password</li>
</ul>

<p>Configuration:</p>

<ul>
<li>Agent JID: "world@localhost" (change to match your XMPP server)</li>
<li>Password: "password" (change to match registered account)</li>
<li>Server: localhost (default XMPP configuration)</li>
</ul>

<p>Lifecycle:</p>

<ol>
<li>Creates a new WorldAgent instance</li>
<li>Calls start() to initialize the agent on XMPP server</li>
<li>Enters infinite loop to keep agent running</li>
<li>On KeyboardInterrupt (Ctrl+C), cleanly stops the agent</li>
<li>Handles any exceptions during execution</li>
</ol>

<p>Error Handling:</p>

<ul>
<li>KeyboardInterrupt: Graceful shutdown with cleanup</li>
<li>Other Exceptions: Logged and agent stopped with cleanup</li>
</ul>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>None:</strong>  Entry function with no parameters</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None: Async coroutine, called via spade.run()</p>
</blockquote>

<h6 id="usage">Usage:</h6>

<blockquote>
  <p>Run via: python world_agent.py
  Stop via: Press Ctrl+C in terminal</p>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This function is called by spade.run() which manages the asyncio event loop</p>
</blockquote>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>