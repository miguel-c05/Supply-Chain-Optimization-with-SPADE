<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>store API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="index.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;
                Module Index
            </a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Store">Store</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Store.__init__">Store</a>
                        </li>
                        <li>
                                <a class="class" href="#Store.BuyProduct">Store.BuyProduct</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Store.BuyProduct.__init__">BuyProduct</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.BuyProduct.quantity">quantity</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.BuyProduct.product">product</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Store.BuyProduct.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Store.CollectWarehouseResponses">Store.CollectWarehouseResponses</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Store.CollectWarehouseResponses.__init__">CollectWarehouseResponses</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.CollectWarehouseResponses.request_id">request_id</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.CollectWarehouseResponses.buy_msg">buy_msg</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.CollectWarehouseResponses.num_warehouses">num_warehouses</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.CollectWarehouseResponses.quantity">quantity</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.CollectWarehouseResponses.product">product</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.CollectWarehouseResponses.acceptances">acceptances</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.CollectWarehouseResponses.rejections">rejections</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Store.CollectWarehouseResponses.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Store.ReceiveAllResponses">Store.ReceiveAllResponses</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Store.ReceiveAllResponses.__init__">ReceiveAllResponses</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.ReceiveAllResponses.request_id">request_id</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.ReceiveAllResponses.num_warehouses">num_warehouses</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.ReceiveAllResponses.acceptances">acceptances</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.ReceiveAllResponses.rejections">rejections</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.ReceiveAllResponses.responses_received">responses_received</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.ReceiveAllResponses.timeout">timeout</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Store.ReceiveAllResponses.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Store.SendStoreConfirmation">Store.SendStoreConfirmation</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Store.SendStoreConfirmation.__init__">SendStoreConfirmation</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.SendStoreConfirmation.dest">dest</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.SendStoreConfirmation.request_id">request_id</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.SendStoreConfirmation.quantity">quantity</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.SendStoreConfirmation.product">product</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.SendStoreConfirmation.msg">msg</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Store.SendStoreConfirmation.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Store.SendStoreDenial">Store.SendStoreDenial</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Store.SendStoreDenial.__init__">SendStoreDenial</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.SendStoreDenial.dest">dest</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.SendStoreDenial.request_id">request_id</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.SendStoreDenial.quantity">quantity</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Store.SendStoreDenial.product">product</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Store.SendStoreDenial.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Store.RetryPreviousBuy">Store.RetryPreviousBuy</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Store.RetryPreviousBuy.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Store.ReceiveTimeDelta">Store.ReceiveTimeDelta</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Store.ReceiveTimeDelta.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Store.ReceiveVehicleArrival">Store.ReceiveVehicleArrival</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Store.ReceiveVehicleArrival.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="function" href="#Store.calculate_warehouse_score">calculate_warehouse_score</a>
                        </li>
                        <li>
                                <a class="function" href="#Store.dict_to_order">dict_to_order</a>
                        </li>
                        <li>
                                <a class="function" href="#Store.message_to_order">message_to_order</a>
                        </li>
                        <li>
                                <a class="function" href="#Store.set_buy_metadata">set_buy_metadata</a>
                        </li>
                        <li>
                                <a class="function" href="#Store.update_graph">update_graph</a>
                        </li>
                        <li>
                                <a class="function" href="#Store.get_stats">get_stats</a>
                        </li>
                        <li>
                                <a class="function" href="#Store.print_stock">print_stock</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.node_id">node_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.map">map</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.contact_list">contact_list</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.verbose">verbose</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.id_base">id_base</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.pending_deliveries">pending_deliveries</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.order_timings">order_timings</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.current_tick">current_tick</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.stats_path">stats_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.stats_filename">stats_filename</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.product_list">product_list</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.buy_prob">buy_prob</a>
                        </li>
                        <li>
                                <a class="variable" href="#Store.max_buy_quantity">max_buy_quantity</a>
                        </li>
                        <li>
                                <a class="function" href="#Store.setup">setup</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
store    </h1>

                        <div class="docstring"><p>Store Agent Module for Supply Chain Optimization System.</p>

<p>This module implements the Store agent, which represents a retail point in the supply chain.
The Store agent is responsible for managing inventory, purchasing products from warehouses,
and interacting with the transportation system for product delivery.</p>

<p>The module follows the FIPA (Foundation for Intelligent Physical Agents) Contract Net Protocol
for warehouse selection and negotiation, implementing the roles of Initiator in procurement
processes.</p>

<h6 id="typical-usage-example">Typical usage example:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">world.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">Graph</span>

<span class="c1"># Initialize graph and store agent</span>
<span class="n">map_graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">Store</span><span class="p">(</span>
    <span class="n">jid</span><span class="o">=</span><span class="s2">&quot;store1@localhost&quot;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s2">&quot;store_password&quot;</span><span class="p">,</span>
    <span class="nb">map</span><span class="o">=</span><span class="n">map_graph</span><span class="p">,</span>
    <span class="n">node_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">contact_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;warehouse1@localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse2@localhost&quot;</span><span class="p">],</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">await</span> <span class="n">store</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre>
  </div>
</blockquote>
</div>

                        <input id="mod-store-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-store-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="sd">Store Agent Module for Supply Chain Optimization System.</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="sd">This module implements the Store agent, which represents a retail point in the supply chain.</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="sd">The Store agent is responsible for managing inventory, purchasing products from warehouses,</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="sd">and interacting with the transportation system for product delivery.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="sd">The module follows the FIPA (Foundation for Intelligent Physical Agents) Contract Net Protocol</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="sd">for warehouse selection and negotiation, implementing the roles of Initiator in procurement</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="sd">processes.</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="sd">Typical usage example:</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">    ```python</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="sd">    from world.graph import Graph</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="sd">    </span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="sd">    # Initialize graph and store agent</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">    map_graph = Graph()</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">    store = Store(</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">        jid=&quot;store1@localhost&quot;,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">        password=&quot;store_password&quot;,</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">        map=map_graph,</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">        node_id=1,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">        contact_list=[&quot;warehouse1@localhost&quot;, &quot;warehouse2@localhost&quot;],</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="sd">        verbose=True</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="sd">    )</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="sd">    await store.start()</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="sd">    ```</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">aiohttp_jinja2</span><span class="w"> </span><span class="kn">import</span> <span class="n">template</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">spade</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.behaviour</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneShotBehaviour</span><span class="p">,</span> <span class="n">PeriodicBehaviour</span><span class="p">,</span> <span class="n">CyclicBehaviour</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">Message</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">Template</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">world.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">Edge</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">veiculos.veiculos</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span> 
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Store</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">    Retail Store Agent for Supply Chain Management System.</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">    </span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">    The Store agent represents a retail point in the supply chain network. It manages</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">    inventory, purchases products from warehouses using a negotiation protocol, and</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">    coordinates with vehicle agents for product delivery. The agent operates on a</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">    graph-based world representation where each store has a specific node location.</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">    </span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">    FIPA Contract Net Protocol Implementation:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">        This agent acts as the **Initiator** in the FIPA Contract Net Protocol:</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">        </span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">        1. **Call for Proposals (CFP)**: Store broadcasts purchase requests to all warehouses</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">           using the `store-buy` performative, which corresponds to the FIPA CFP message.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">           </span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">        2. **Proposal Reception**: Warehouses respond with either `warehouse-accept` (propose)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">           or `warehouse-reject` (refuse) performatives.</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">           </span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">        3. **Proposal Evaluation**: Store evaluates all proposals using a distance-based</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">           scoring function to select the optimal warehouse.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">           </span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">        4. **Award/Rejection**: Store sends `store-confirm` (accept-proposal) to the winner</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">           and `store-deny` (reject-proposal) to non-selected participants.</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">    </span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="sd">    ID Encoding System:</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">        The Store uses a hierarchical ID encoding for unique request identification:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">        - Formula: `agent_type * 100_000_000 + instance_id * 1_000_000 + request_counter`</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">        - Agent type code for Store: 1</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">        - Example: store1&#39;s first request = 1_001_000_000</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a><span class="sd">        - This ensures globally unique request IDs across the multi-agent system.</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">    </span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">    Attributes:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">        jid (str): Jabber ID of the store agent (e.g., &quot;store1@localhost&quot;).</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a><span class="sd">        node_id (int): Graph node ID representing the store&#39;s physical location.</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="sd">        map (Graph): Reference to the world graph for pathfinding and distance calculations.</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a><span class="sd">        contact_list (list[str]): List of warehouse JIDs for subscription and communication.</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="sd">        verbose (bool): Flag to control debug output verbosity. When True, detailed logs</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="sd">            are printed; when False, only essential information is shown.</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">        id_base (int): Base value for generating unique request IDs using encoding formula.</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="sd">            Computed as `(1 * 100_000_000) + (instance_id * 1_000_000)`.</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">        stock (dict[str, int]): Current inventory mapping product names to quantities.</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">        request_counter (int): Monotonic counter for generating unique request IDs.</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">            Incremented with each purchase request.</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="sd">        current_buy_request (Message): Reference to the most recent buy request message.</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">        failed_requests (queue.Queue): FIFO queue holding failed purchase requests for retry.</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a><span class="sd">            Requests are enqueued when no warehouse accepts the order.</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">        pending_deliveries (dict[int, Order]): Orders awaiting vehicle delivery, keyed by order ID.</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">        order_timings (dict[int, int]): Tick timestamps when orders were confirmed, used for</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">            calculating time-to-delivery statistics.</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">        current_tick (int): Current simulation time tick, updated by world agent.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">        product_list (list[str]): Available products for purchase (from config.PRODUCTS).</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">        buy_prob (float): Probability (0-1) of initiating a purchase each period</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">            (from config.STORE_BUY_PROBABILITY).</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">        max_buy_quantity (int): Maximum quantity that can be purchased in a single order</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="sd">            (from config.STORE_MAX_BUY_QUANTITY).</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">        stats_path (str): Directory path for statistics CSV files.</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">        stats_filename (str): Filename for order statistics CSV (&quot;store_stats.csv&quot;).</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a><span class="sd">    </span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="sd">    Behaviours:</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="sd">        BuyProduct: Periodic behaviour that initiates purchase requests based on probability.</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">        CollectWarehouseResponses: Coordinator for FIPA Contract Net Protocol implementation.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">        ReceiveAllResponses: Worker behaviour that collects all warehouse responses.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">        SendStoreConfirmation: Sends confirmation to selected warehouse (FIPA accept-proposal).</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">        SendStoreDenial: Sends rejection to non-selected warehouses (FIPA reject-proposal).</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">        RetryPreviousBuy: Periodic behaviour that retries failed purchase requests.</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">        ReceiveTimeDelta: Cyclic behaviour that processes simulation time updates and traffic data.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">        ReceiveVehicleArrival: Cyclic behaviour that handles vehicle delivery notifications.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">    </span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="sd">    Message Protocols:</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">        Outgoing Messages:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">            - `store-buy`: Purchase request to warehouses (FIPA CFP).</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a><span class="sd">                Metadata: store_id, node_id, request_id</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">                </span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="sd">            - `store-confirm`: Confirmation to selected warehouse (FIPA accept-proposal).</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd">                Metadata: warehouse_id, store_id, node_id, request_id</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="sd">                </span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="sd">            - `store-deny`: Rejection to non-selected warehouses (FIPA reject-proposal).</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="sd">                Metadata: warehouse_id, store_id, node_id, request_id</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">        </span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="sd">        Incoming Messages:</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">            - `warehouse-accept`: Warehouse accepts order (FIPA propose).</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">                </span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="sd">            - `warehouse-reject`: Warehouse rejects order (FIPA refuse).</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">                Body format: &quot;{quantity} {product} {reason}&quot;</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="sd">                </span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">            - `vehicle-delivery`: Vehicle delivers products.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">                Body format: JSON with orderid, time (ETA)</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">                </span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">            - `inform`: Time delta and traffic updates from world agent.</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">                Body format: JSON with type, time, data</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">    </span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">    Notes:</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">        - Only ONE purchase request should be active at a time to avoid conflicts.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">        - Failed requests are automatically retried by the RetryPreviousBuy behaviour.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">        - Stock is updated only upon vehicle delivery, not upon order confirmation.</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">        - All order statistics are saved to CSV for post-simulation analysis.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">        - The agent subscribes to all warehouses in contact_list during setup.</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd">    </span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd">    Example:</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">        ```python</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">        store = Store(</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">            jid=&quot;store1@localhost&quot;,</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">            password=&quot;password&quot;,</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="sd">            map=world_graph,</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">            node_id=5,</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a><span class="sd">            contact_list=[&quot;warehouse1@localhost&quot;, &quot;warehouse2@localhost&quot;],</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="sd">            verbose=True</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">        )</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">        await store.start()</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">        ```</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>    
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>    <span class="c1">#         WAREHOUSE &lt;-&gt; STORE</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>    
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">BuyProduct</span><span class="p">(</span><span class="n">PeriodicBehaviour</span><span class="p">):</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">        Periodic behaviour that initiates product purchase requests to warehouses.</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">        </span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">        This behaviour implements the initiation phase of the FIPA Contract Net Protocol.</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a><span class="sd">        It sends a Call for Proposals (CFP) to all available warehouses, requesting quotes</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a><span class="sd">        for a specific product and quantity. The behaviour executes periodically but only</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a><span class="sd">        proceeds with a purchase based on a configured probability threshold.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="sd">        </span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a><span class="sd">        FIPA Protocol Phase: **Call for Proposals (CFP)**</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">            - Role: Initiator (Store agent)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="sd">            - Participants: All warehouses in contact list</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">            - Message type: `store-buy` (FIPA CFP equivalent)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">            - Protocol: FIPA Contract Net Protocol</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">        </span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="sd">        The behaviour uses randomization to select products and quantities for each purchase,</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="sd">        ensuring varied and realistic purchasing patterns. It then delegates response collection</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">        and warehouse selection to the CollectWarehouseResponses coordinator behaviour.</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">        </span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a><span class="sd">        Attributes:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a><span class="sd">            quantity (Optional[int]): Fixed quantity to purchase. If None, randomizes each run</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="sd">                between 1 and max_buy_quantity.</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a><span class="sd">            product (Optional[str]): Fixed product to purchase. If None, randomly selects from</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="sd">                config.PRODUCTS each run.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">            period (float): Time interval between executions in seconds (from config).</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">            start_at (datetime): Timestamp when the behaviour should first execute.</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">        </span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">        Message Format (FIPA CFP):</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">            Metadata:</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">                - performative: &quot;store-buy&quot; (FIPA CFP)</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">                - store_id: Store&#39;s JID</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">                - node_id: Store&#39;s graph node ID</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">                - request_id: Unique request ID using hierarchical encoding</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">            Body:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">        </span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="sd">        Workflow:</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="sd">            1. Roll random number (1-100) to determine if purchase should occur</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a><span class="sd">            2. Compare roll against buy_prob threshold; skip if roll fails</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a><span class="sd">            3. Randomize or use fixed quantity and product</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="sd">            4. Generate unique request_id using ID encoding: id_base + request_counter</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a><span class="sd">            5. Broadcast CFP to all warehouses in contact list</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a><span class="sd">            6. Launch CollectWarehouseResponses to handle FIPA negotiation protocol</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a><span class="sd">            7. Wait for negotiation to complete</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a><span class="sd">        </span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a><span class="sd">        Notes:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a><span class="sd">            - Uses local variables (not self.quantity/self.product) to ensure proper</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a><span class="sd">              randomization on each execution cycle.</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a><span class="sd">            - Each execution generates a new request_id to avoid conflicts.</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a><span class="sd">            - Waits for CollectWarehouseResponses to complete before finishing.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a><span class="sd">            - Probability mechanism prevents constant purchasing, simulating realistic demand.</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="sd">        </span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="sd">        Example:</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a><span class="sd">            ```python</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">            # Random purchases from config product list</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">            buy_behav = store.BuyProduct()</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">            </span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="sd">            # Fixed product and quantity for testing</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a><span class="sd">            buy_behav = store.BuyProduct(quantity=100, product=&quot;electronics&quot;)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="sd">            ```</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>                     <span class="n">quantity</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>                     <span class="n">product</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>                     <span class="n">period</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">STORE_BUY_FREQUENCY</span><span class="p">,</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>                     <span class="n">start_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)):</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a><span class="sd">            Initialize the BuyProduct periodic behaviour.</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a><span class="sd">            </span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a><span class="sd">            Args:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a><span class="sd">                quantity (Optional[int], optional): Fixed quantity to purchase each period.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a><span class="sd">                    If None, quantity is randomized between 1 and max_buy_quantity each run.</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a><span class="sd">                    Defaults to None for varied purchasing patterns.</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a><span class="sd">                product (Optional[str], optional): Fixed product name to purchase each period.</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a><span class="sd">                    If None, product is randomly selected from config.PRODUCTS each run.</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a><span class="sd">                    Defaults to None for varied product selection.</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a><span class="sd">                period (float, optional): Time interval between executions in seconds.</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a><span class="sd">                    Controls how frequently purchase attempts are made.</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a><span class="sd">                    Defaults to config.STORE_BUY_FREQUENCY.</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a><span class="sd">                start_at (datetime, optional): Timestamp when behaviour should first execute.</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a><span class="sd">                    Allows delayed start for synchronized simulation initialization.</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a><span class="sd">                    Defaults to 5 seconds from initialization time.</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a><span class="sd">            </span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a><span class="sd">            Note:</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a><span class="sd">                Using None for quantity and product (default) creates varied purchasing</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a><span class="sd">                patterns that simulate realistic retail demand, while fixed values create</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a><span class="sd">                predictable repeated orders useful for testing specific scenarios.</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">start_at</span><span class="o">=</span><span class="n">start_at</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>        
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="sd">            Execute one cycle of the purchase request behaviour.</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="sd">            </span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">            This method implements the probabilistic purchase initiation logic and</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a><span class="sd">            broadcasts FIPA CFP messages to all warehouses. It uses randomization for</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">            both the purchase decision (based on buy_prob) and the product/quantity</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">            selection (unless fixed values were provided in __init__).</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="sd">            </span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">                - **Phase**: Call for Proposals (CFP) - Initiation</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">                - **Role**: Initiator</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">                - **Performative**: store-buy (FIPA CFP)</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">                - **Content**: &quot;{quantity} {product}&quot;</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">                - **Receivers**: All warehouses in contact list (broadcast)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">                - **Protocol**: FIPA Contract Net Protocol</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">            </span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">            The method generates a unique request_id using the Store&#39;s hierarchical ID</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">            encoding system before broadcasting to ensure all responses can be properly</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">            matched to this specific request.</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">            </span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">            Workflow:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a><span class="sd">                1. **Probability Check**: Roll random number (1-100) for purchase decision</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="sd">                2. **Threshold Comparison**: Compare roll against buy_prob * 100</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">                3. **Early Return**: If roll fails, abort and wait for next period</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a><span class="sd">                4. **Randomization**: Generate or use fixed quantity and product</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a><span class="sd">                5. **ID Generation**: Create unique request_id from id_base + request_counter</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="sd">                6. **CFP Broadcast**: Send store-buy message to all warehouses</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a><span class="sd">                7. **Coordinator Launch**: Start CollectWarehouseResponses for negotiation</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="sd">                8. **Synchronization**: Wait for coordinator to complete FIPA protocol</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">            </span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="sd">            Side Effects:</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a><span class="sd">                - Increments agent.request_counter (ensures unique IDs)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a><span class="sd">                - Updates agent.current_buy_request with last sent message</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="sd">                - Adds CollectWarehouseResponses behaviour to agent</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">                - May print debug information if verbose mode is enabled</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a><span class="sd">            </span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="sd">            Returns:</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a><span class="sd">                None. Completes when CollectWarehouseResponses finishes the negotiation</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a><span class="sd">                process and a warehouse is selected (or request fails).</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a><span class="sd">            </span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a><span class="sd">            Note:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a><span class="sd">                Uses local variables (quantity, product) instead of instance variables</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a><span class="sd">                to ensure proper randomization on each execution. This prevents the bug</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a><span class="sd">                where the same product/quantity would be used repeatedly.</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>            
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>            <span class="n">roll</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>            <span class="c1"># Decide whether to buy this turn based on probability</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>            <span class="k">if</span> <span class="n">roll</span> <span class="o">&gt;</span> <span class="n">agent</span><span class="o">.</span><span class="n">buy_prob</span> <span class="o">*</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Decided NOT to buy this turn (roll=</span><span class="si">{</span><span class="n">roll</span><span class="si">}</span><span class="s2"> &gt; buy_prob=</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">buy_prob</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>                <span class="k">return</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>            <span class="k">else</span><span class="p">:</span> <span class="k">pass</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>            
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>            <span class="c1"># Randomize quantity and product for each purchase</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">max_buy_quantity</span><span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>                
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">product_list</span><span class="p">)</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>                
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Preparing to buy </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>            
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>            <span class="n">contacts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>            
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>            <span class="c1"># Get request_id before sending - use ID encoding</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>            <span class="n">request_id_for_template</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">id_base</span> <span class="o">+</span> <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>            
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will store the last sent message for current_buy_request</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>            <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">:</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">contact</span><span class="p">)</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-buy&quot;</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id_for_template</span><span class="p">))</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>                
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent request (id=</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;request_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>                
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>            
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>            <span class="c1"># Store the last message (or could store all if needed)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>        
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>                <span class="c1"># Collect responses from all warehouses</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectWarehouseResponses</span><span class="p">(</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>                    <span class="n">msg</span><span class="p">,</span> 
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>                    <span class="n">request_id_for_template</span><span class="p">,</span> 
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">contacts</span><span class="p">),</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>                    <span class="n">quantity</span><span class="p">,</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>                    <span class="n">product</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>                <span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>                
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">CollectWarehouseResponses</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="sd">        Coordinator behaviour for FIPA Contract Net Protocol implementation.</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="sd">        </span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">        This behaviour orchestrates the proposal collection, evaluation, and award phases</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a><span class="sd">        of the FIPA Contract Net Protocol. It acts as the coordinator (initiator) that</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">        manages the negotiation process with multiple warehouses, collects their responses,</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="sd">        and selects the best proposal based on a distance-based scoring function.</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a><span class="sd">        </span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="sd">        FIPA Protocol Phases Implemented:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a><span class="sd">            1. **Proposal Reception**: Collects warehouse responses (propose/refuse)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="sd">            2. **Proposal Evaluation**: Scores each acceptance using Dijkstra pathfinding</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="sd">            3. **Award Decision**: Sends accept-proposal to winner, reject-proposal to losers</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="sd">        </span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="sd">        The behaviour uses a coordinator/worker pattern:</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="sd">            - **Coordinator** (this class): Manages overall protocol flow, evaluates proposals</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a><span class="sd">            - **Worker** (ReceiveAllResponses): Handles actual message reception</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a><span class="sd">        </span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="sd">        Scoring Algorithm:</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="sd">            Uses Dijkstra pathfinding to calculate delivery time from each warehouse to store.</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="sd">            - Formula: score = delivery_time (from warehouse to store)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a><span class="sd">            - Lower score = better choice (shorter delivery time)</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">            - Tie-breaking: First warehouse with minimum score wins</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a><span class="sd">        </span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="sd">        FIPA Contract Net Protocol Flow:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="sd">            1. **Setup**: Create template matching request_id and store_id</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">            2. **Collection**: Launch ReceiveAllResponses worker to gather proposals</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="sd">            3. **Wait**: Synchronize on worker completion (timeout: 5 seconds)</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">            4. **Evaluation**: Calculate scores for all acceptances</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="sd">            5. **Selection**: Choose warehouse with minimum score</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">            6. **Award**: Send store-confirm to winner (FIPA accept-proposal)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a><span class="sd">            7. **Rejection**: Send store-deny to losers (FIPA reject-proposal)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="sd">            8. **Failure Handling**: Enqueue for retry if no acceptances received</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="sd">        </span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="sd">        Attributes:</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="sd">            request_id (int): Unique identifier for this purchase request from ID encoding.</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="sd">            buy_msg (str): Original purchase message body (&quot;{quantity} {product}&quot;).</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="sd">            num_warehouses (int): Expected number of warehouse responses for timeout logic.</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">            quantity (int): Quantity of product being purchased.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">            product (str): Name of product being purchased.</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">            acceptances (list[tuple[str, Message]]): Warehouses that proposed.</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">                Format: [(warehouse_jid, acceptance_msg), ...]</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">            rejections (list[tuple[str, Message, str]]): Warehouses that refused.</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">                Format: [(warehouse_jid, rejection_msg, reason), ...]</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a><span class="sd">        </span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="sd">        Failure Handling:</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">            - If no warehouses accept: Request added to failed_requests queue</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">            - RetryPreviousBuy behaviour will automatically retry with same request_id</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">            - Failed requests maintain original request_id for tracking</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">        </span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="sd">        Example Workflow:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a><span class="sd">            ```</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">            CFP Sent: &quot;50 electronics&quot; (request_id=1001000000)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="sd">            Responses Received:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">                - warehouse1: propose (distance=100, score=100)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="sd">                - warehouse2: propose (distance=50, score=50) &lt;- WINNER</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="sd">                - warehouse3: refuse (reason: out_of_stock)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="sd">            Actions Taken:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">                - Send accept-proposal to warehouse2</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="sd">                - Send reject-proposal to warehouse1</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a><span class="sd">                - warehouse3 already refused, no action needed</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a><span class="sd">            ```</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a><span class="sd">        </span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a><span class="sd">        Note:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a><span class="sd">            This coordinator behaviour is essential for implementing the FIPA Contract Net</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a><span class="sd">            Protocol correctly, separating concerns between message collection (worker) and</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a><span class="sd">            decision-making (coordinator).</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_warehouses</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">quantity</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">product</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="sd">            Initialize the CollectWarehouseResponses coordinator behaviour.</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="sd">            </span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a><span class="sd">            Args:</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a><span class="sd">                msg (Message): Original purchase request message sent to warehouses.</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a><span class="sd">                    Stored as reference for reconstructing failed requests if needed.</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="sd">                request_id (int): Unique request identifier from hierarchical ID encoding system.</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a><span class="sd">                    Used to match incoming responses to this specific CFP.</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a><span class="sd">                num_warehouses (int): Expected number of warehouse responses.</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a><span class="sd">                    Used to determine when all proposals have been received (or timeout).</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a><span class="sd">                quantity (int): Quantity of product being purchased.</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a><span class="sd">                    Needed for order processing and statistics tracking.</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a><span class="sd">                product (str): Name of product being purchased.</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a><span class="sd">                    Needed for order processing and statistics tracking.</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="sd">            </span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a><span class="sd">            Note:</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a><span class="sd">                Initializes empty acceptances and rejections lists that will be</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="sd">                populated by the ReceiveAllResponses worker behaviour through</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="sd">                shared reference (list objects are mutable).</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">buy_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span> <span class="o">=</span> <span class="n">num_warehouses</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of (warehouse_jid, msg)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># List of (warehouse_jid, msg, reason)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>            
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="sd">            Execute the warehouse proposal collection and evaluation process.</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="sd">            </span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">            This method coordinates the entire FIPA Contract Net Protocol workflow</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a><span class="sd">            for warehouse selection. It sets up message filtering, launches the worker</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">            behaviour for response collection, evaluates all proposals using a scoring</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="sd">            algorithm, and sends confirmations/rejections to participants according to</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">            the FIPA protocol specification.</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">            </span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">            FIPA Contract Net Protocol Implementation:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">            </span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">            1. **Setup Phase** (FIPA: Preparation):</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">                - Creates template matching request_id and store_id metadata</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="sd">                - Allows both warehouse-accept (propose) and warehouse-reject (refuse)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="sd">                - Ensures only responses for THIS specific request are collected</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="sd">                - Prevents cross-contamination between concurrent requests</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">            </span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">            2. **Collection Phase** (FIPA: Proposal Reception):</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">                - Delegates to ReceiveAllResponses worker behaviour</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">                - Worker populates acceptances (proposals) and rejections (refusals) lists</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">                - Implements timeout mechanism (5 seconds total)</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="sd">                - Handles partial responses gracefully (some warehouses may not respond)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="sd">            </span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="sd">            3. **Evaluation Phase** (FIPA: Proposal Evaluation):</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="sd">                - Calculates score for each acceptance using calculate_warehouse_score()</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a><span class="sd">                - Score based on Dijkstra pathfinding: delivery_time from warehouse to store</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a><span class="sd">                - Selects warehouse with lowest score (shortest delivery time)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a><span class="sd">                - Implements best-proposal selection strategy from FIPA specification</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a><span class="sd">            </span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a><span class="sd">            4. **Award Phase** (FIPA: Result Notification):</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a><span class="sd">                - Sends store-confirm to winner (FIPA accept-proposal performative)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a><span class="sd">                - Sends store-deny to all other acceptors (FIPA reject-proposal performative)</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a><span class="sd">                - Rejected participants (warehouse-reject) are not contacted again</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a><span class="sd">                - Winner proceeds to order confirmation and vehicle assignment</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a><span class="sd">            </span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="sd">            5. **Failure Handling**:</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a><span class="sd">                - If no acceptances received: Adds request to failed_requests queue</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a><span class="sd">                - Failed requests automatically retried by RetryPreviousBuy behaviour</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a><span class="sd">                - Maintains same request_id for tracking across retry attempts</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a><span class="sd">            </span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a><span class="sd">            Template Configuration:</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a><span class="sd">                - **Matches**: store_id (this store) AND request_id (this specific request)</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a><span class="sd">                - **Accepts**: Both warehouse-accept AND warehouse-reject performatives</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a><span class="sd">                - **Purpose**: Filters responses to avoid conflicts with concurrent requests</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a><span class="sd">                - **Design**: Intentionally doesn&#39;t filter by performative to collect all responses</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a><span class="sd">            </span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a><span class="sd">            Scoring Process (Distance-Based Selection):</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a><span class="sd">                For each warehouse that sent propose (warehouse-accept):</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="sd">                1. Extract warehouse node_id from message metadata</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a><span class="sd">                2. Use Dijkstra algorithm: calculate (path, fuel, time) warehouse -&gt; store</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a><span class="sd">                3. Score = delivery time (lower is better)</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a><span class="sd">                4. Select warehouse with minimum score</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a><span class="sd">                5. Tie-breaking: First warehouse with minimum score wins</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a><span class="sd">            </span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a><span class="sd">            Side Effects:</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="sd">                - Adds ReceiveAllResponses worker behaviour to agent (with template)</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="sd">                - Adds SendStoreConfirmation behaviour for winner</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="sd">                - Adds SendStoreDenial behaviour for each non-winner</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="sd">                - May enqueue failed request to failed_requests queue</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">                - Prints evaluation details if verbose mode enabled</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">            </span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="sd">            Returns:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">                None. Completes when all confirmations/denials are sent, or when</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">                failed request is enqueued for retry.</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a><span class="sd">            </span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">            Example Execution:</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a><span class="sd">                ```</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a><span class="sd">                CFP: &quot;50 electronics&quot; to 3 warehouses</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a><span class="sd">                Responses:</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a><span class="sd">                    - warehouse1: accept (node_id=10, distance=150, score=150)</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a><span class="sd">                    - warehouse2: accept (node_id=5, distance=80, score=80) &lt;- WINNER</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a><span class="sd">                    - warehouse3: reject (reason=out_of_stock)</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a><span class="sd">                Actions:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a><span class="sd">                    - SendStoreConfirmation(warehouse2) -&gt; accept-proposal</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a><span class="sd">                    - SendStoreDenial(warehouse1) -&gt; reject-proposal</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a><span class="sd">                    - No action for warehouse3 (already refused)</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a><span class="sd">                Result: Order placed with warehouse2</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a><span class="sd">                ```</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a><span class="sd">            </span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a><span class="sd">            Note:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a><span class="sd">                This method implements the core decision-making logic of the FIPA Contract</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a><span class="sd">                Net Protocol, transforming raw proposals into a concrete purchase order with</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a><span class="sd">                the optimal warehouse.</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>            
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>            <span class="c1"># Setup template that accepts BOTH warehouse-accept AND warehouse-reject</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>            <span class="c1"># Don&#39;t filter by performative - we want both accept and reject</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>            
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>            <span class="c1"># Create a combined behaviour to listen for both</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>            <span class="n">combined_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ReceiveAllResponses</span><span class="p">(</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span><span class="p">,</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">,</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>            <span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>            
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>            <span class="c1"># Add with template that matches both performatives</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">combined_behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>            
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>            <span class="c1"># Wait for collection to complete</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>            <span class="k">await</span> <span class="n">combined_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>            
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>            <span class="c1"># Now evaluate and choose best warehouse</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> acceptance(s) and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejection(s)&quot;</span><span class="p">)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>                
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>                <span class="c1"># Calculate scores for each warehouse that accepted</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>                <span class="n">best_warehouse</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>                <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>                
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>                
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>                <span class="k">for</span> <span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>                    <span class="n">score</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">calculate_warehouse_score</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Warehouse </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2"> score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>                    
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>                    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">best_score</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>                        <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>                        <span class="n">best_warehouse</span> <span class="o">=</span> <span class="p">(</span><span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>                
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>                <span class="k">if</span> <span class="n">best_warehouse</span><span class="p">:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>                    <span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="o">=</span> <span class="n">best_warehouse</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Selected warehouse </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2"> with score </span><span class="si">{</span><span class="n">best_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>                    
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>                    <span class="c1"># Send confirmation to the chosen warehouse</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>                    <span class="n">confirm_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendStoreConfirmation</span><span class="p">(</span><span class="n">accept_msg</span><span class="p">)</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">confirm_behav</span><span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>                    <span class="k">await</span> <span class="n">confirm_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>                    
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>                    <span class="c1"># Send denial to other warehouses that accepted but weren&#39;t chosen</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>                    <span class="k">for</span> <span class="n">other_warehouse_jid</span><span class="p">,</span> <span class="n">other_msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>                        <span class="k">if</span> <span class="n">other_warehouse_jid</span> <span class="o">!=</span> <span class="n">warehouse_jid</span><span class="p">:</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>                            <span class="n">deny_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendStoreDenial</span><span class="p">(</span><span class="n">other_msg</span><span class="p">)</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>                            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">deny_behav</span><span class="p">)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>                            <span class="k">await</span> <span class="n">deny_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>                            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent denial to </span><span class="si">{</span><span class="n">other_warehouse_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>                    
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No acceptances received. All warehouses rejected or timed out.&quot;</span><span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Request saved in self.failed_requests&quot;</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>                
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>                <span class="c1"># Add to failed requests</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>                <span class="n">failed_msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span><span class="o">.</span><span class="n">to</span><span class="p">)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">set_buy_metadata</span><span class="p">(</span><span class="n">failed_msg</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>                <span class="n">failed_msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>                <span class="n">failed_msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_msg</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">failed_msg</span><span class="p">)</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveAllResponses</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a><span class="sd">        Worker behaviour for collecting warehouse responses in FIPA Contract Net Protocol.</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a><span class="sd">        </span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="sd">        This behaviour acts as the worker component in a coordinator/worker pattern,</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a><span class="sd">        handling the actual message reception during the proposal collection phase of</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a><span class="sd">        the FIPA Contract Net Protocol. It listens for both proposals (warehouse-accept)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a><span class="sd">        and refusals (warehouse-reject) from warehouses, populating shared lists that</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a><span class="sd">        the coordinator (CollectWarehouseResponses) will evaluate.</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a><span class="sd">        </span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a><span class="sd">        FIPA Protocol Phase: **Proposal Reception**</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a><span class="sd">            - Role: Participant response collector (worker)</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a><span class="sd">            - Coordinator: CollectWarehouseResponses</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a><span class="sd">            - Expected messages: warehouse-accept (propose) and warehouse-reject (refuse)</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a><span class="sd">            - Timeout: 5 seconds total for all responses</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a><span class="sd">        </span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a><span class="sd">        The behaviour implements a timeout mechanism to handle scenarios where some</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a><span class="sd">        warehouses may be slow to respond or unavailable. It collects responses until</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a><span class="sd">        either all expected warehouses respond or the timeout expires.</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a><span class="sd">        </span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a><span class="sd">        Attributes:</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a><span class="sd">            request_id (int): Unique request identifier for filtering messages.</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a><span class="sd">                Ensures only responses for this specific CFP are processed.</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="sd">            num_warehouses (int): Expected number of warehouse responses.</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="sd">                Used to determine when collection is complete.</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a><span class="sd">            acceptances (list[tuple[str, Message]]): Shared list with coordinator.</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a><span class="sd">                Populated with (warehouse_jid, message) for each propose.</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a><span class="sd">            rejections (list[tuple[str, Message, str]]): Shared list with coordinator.</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a><span class="sd">                Populated with (warehouse_jid, message, reason) for each refuse.</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a><span class="sd">            responses_received (int): Counter tracking received responses.</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a><span class="sd">                Incremented for both accepts and rejects.</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a><span class="sd">            timeout (int): Maximum seconds to wait for all responses (default: 5).</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="sd">        </span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a><span class="sd">        Message Processing:</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a><span class="sd">            - **warehouse-accept** (FIPA propose):</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">                Action: Append (warehouse_jid, msg) to acceptances</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a><span class="sd">            </span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a><span class="sd">            - **warehouse-reject** (FIPA refuse):</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a><span class="sd">                Body format: &quot;{quantity} {product} {reason}&quot;</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">                Action: Append (warehouse_jid, msg, reason) to rejections</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a><span class="sd">        </span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="sd">        Timeout Logic:</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="sd">            - Tracks elapsed time from start</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="sd">            - Calculates remaining_timeout for each receive() call</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a><span class="sd">            - Breaks early if remaining_timeout &lt;= 0</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a><span class="sd">            - Allows partial responses (fewer than num_warehouses)</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a><span class="sd">        </span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a><span class="sd">        Example Execution:</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a><span class="sd">            ```</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a><span class="sd">            Expected: 3 warehouses</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a><span class="sd">            Timeline:</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a><span class="sd">                t=0.5s: warehouse1 -&gt; accept (1/3 received)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="sd">                t=1.2s: warehouse2 -&gt; reject (2/3 received)</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a><span class="sd">                t=5.0s: timeout reached (warehouse3 no response)</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="sd">            Result:</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">                acceptances = [(warehouse1, msg1)]</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">                rejections = [(warehouse2, msg2, &quot;out_of_stock&quot;)]</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a><span class="sd">                responses_received = 2</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a><span class="sd">            ```</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="sd">        </span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">        Note:</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">            This worker behaviour uses shared list references (not copies) to communicate</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">            with the coordinator, following the coordinator/worker pattern for efficient</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">            data sharing between behaviours.</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_warehouses</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">acceptances</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">rejections</span> <span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a><span class="sd">            Initialize the ReceiveAllResponses worker behaviour.</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="sd">            </span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="sd">            Args:</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a><span class="sd">                request_id (int): Unique request identifier from ID encoding system.</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a><span class="sd">                    Used to filter incoming messages to only this CFP&#39;s responses.</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a><span class="sd">                num_warehouses (int): Expected number of warehouse responses.</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a><span class="sd">                    Used to determine when all responses received (early termination).</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a><span class="sd">                acceptances (list[tuple[str, Message]]): Shared list reference with coordinator.</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="sd">                    Worker appends (warehouse_jid, msg) for each warehouse-accept received.</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a><span class="sd">                    Modifications visible to coordinator through shared reference.</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a><span class="sd">                rejections (list[tuple[str, Message, str]]): Shared list reference with coordinator.</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="sd">                    Worker appends (warehouse_jid, msg, reason) for each warehouse-reject.</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a><span class="sd">                    Modifications visible to coordinator through shared reference.</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a><span class="sd">            </span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a><span class="sd">            Note:</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a><span class="sd">                Lists are shared by reference (mutable), enabling communication between</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a><span class="sd">                worker and coordinator without explicit return values. This is a common</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a><span class="sd">                pattern in concurrent programming with SPADE behaviours.</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span> <span class="o">=</span> <span class="n">num_warehouses</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="n">acceptances</span>  <span class="c1"># Shared list</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="n">rejections</span>    <span class="c1"># Shared list</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds to wait for all responses</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>            
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="sd">            Execute the message collection loop for warehouse responses.</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="sd">            </span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a><span class="sd">            This method implements the core collection logic for the FIPA Contract Net</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a><span class="sd">            Protocol proposal reception phase. It continuously receives messages from</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="sd">            warehouses until either all expected responses arrive or a timeout occurs,</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a><span class="sd">            properly categorizing each response as either a proposal or refusal.</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a><span class="sd">            </span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a><span class="sd">                - **Phase**: Proposal Reception (collecting propose/refuse messages)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a><span class="sd">                - **Role**: Worker (collects data for coordinator evaluation)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a><span class="sd">                - **Timeout**: 5 seconds total (not per message)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a><span class="sd">                - **Partial Completion**: Accepts fewer responses than expected</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="sd">            </span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="sd">            Algorithm:</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">                1. **Initialization**: Record start time for timeout calculation</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a><span class="sd">                2. **Collection Loop**: While responses_received &lt; num_warehouses:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="sd">                    a. Calculate remaining timeout based on elapsed time</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a><span class="sd">                    b. Check for timeout expiration (remaining_timeout &lt;= 0)</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a><span class="sd">                    c. Receive message with dynamically calculated timeout</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="sd">                    d. Parse message: extract performative, sender, and body</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="sd">                    e. Categorize as acceptance or rejection</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">                    f. Append to appropriate shared list</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a><span class="sd">                    g. Increment responses_received counter</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="sd">                3. **Termination**: Break on timeout or no more messages</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">            </span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="sd">            Message Processing:</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a><span class="sd">            </span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="sd">                **warehouse-accept** (FIPA propose):</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">                    - Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a><span class="sd">                    - Parsing: Split on space, extract quantity (int) and product (str)</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a><span class="sd">                    - Action: Append (warehouse_jid, msg) to acceptances list</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a><span class="sd">                    - Meaning: Warehouse agrees to fulfill order</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a><span class="sd">                </span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a><span class="sd">                **warehouse-reject** (FIPA refuse):</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="sd">                    - Body format: &quot;{quantity} {product} {reason}&quot;</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">                    - Parsing: Split on space, extract quantity, product, and optional reason</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">                    - Action: Append (warehouse_jid, msg, reason) to rejections list</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">                    - Default reason: &quot;unknown&quot; if not provided</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">                    - Meaning: Warehouse cannot or will not fulfill order</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">            </span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">            Timeout Mechanism:</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">                - **Total Timeout**: 5 seconds from method start</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">                - **Dynamic Calculation**: remaining_timeout = total_timeout - elapsed_time</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">                - **Per-Message Timeout**: Each receive() uses remaining_timeout</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">                - **Early Termination**: Breaks immediately if remaining_timeout &lt;= 0</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a><span class="sd">                - **Graceful Handling**: Allows partial responses without error</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a><span class="sd">            </span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a><span class="sd">            Example Execution Timeline:</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a><span class="sd">                ```</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a><span class="sd">                t=0.0s: Start collection (expecting 3 responses)</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a><span class="sd">                t=0.3s: Receive warehouse1 accept -&gt; acceptances.append()</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a><span class="sd">                t=0.8s: Receive warehouse2 reject -&gt; rejections.append()</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a><span class="sd">                t=5.0s: Timeout reached (warehouse3 silent)</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a><span class="sd">                Result: 2/3 responses collected</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a><span class="sd">                ```</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a><span class="sd">            </span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a><span class="sd">            Side Effects:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a><span class="sd">                - Populates self.acceptances shared list with proposals</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a><span class="sd">                - Populates self.rejections shared list with refusals</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a><span class="sd">                - Increments self.responses_received counter</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a><span class="sd">                - Prints debug information if verbose mode enabled</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a><span class="sd">                - May terminate early due to timeout</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a><span class="sd">            </span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a><span class="sd">            Returns:</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a><span class="sd">                None. Results communicated through shared list references.</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a><span class="sd">            </span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a><span class="sd">            Note:</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a><span class="sd">                The timeout is global (not per-message), ensuring the entire collection</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a><span class="sd">                process completes within 5 seconds regardless of warehouse count. This</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a><span class="sd">                prevents indefinite waiting when warehouses are unresponsive.</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>            
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span><span class="p">:</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>                <span class="n">remaining_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">-</span> <span class="n">elapsed</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>                
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                <span class="k">if</span> <span class="n">remaining_timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Timeout: Only received </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span><span class="si">}</span><span class="s2"> responses&quot;</span><span class="p">)</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>                    <span class="k">break</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">remaining_timeout</span><span class="p">)</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>                
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>                    <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>                    <span class="n">warehouse_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>                    
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>                    <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;warehouse-accept&quot;</span><span class="p">:</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>                        
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received acceptance from </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>                        
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>                    <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;warehouse-reject&quot;</span><span class="p">:</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>                        <span class="n">reason</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>                        
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received rejection from </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> (reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>                    
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>                    <span class="c1"># No more messages, timeout</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>                    <span class="k">break</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>            
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Finished collecting responses: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> accepts, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejects&quot;</span><span class="p">)</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SendStoreConfirmation</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="sd">        Behaviour to send confirmation to the selected warehouse (FIPA accept-proposal).</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a><span class="sd">        </span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a><span class="sd">        This behaviour implements the award notification phase of the FIPA Contract Net</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a><span class="sd">        Protocol, informing the winning warehouse that its proposal has been accepted.</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a><span class="sd">        It sends the FIPA accept-proposal message and registers the order as pending</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a><span class="sd">        delivery, waiting for a vehicle to transport the goods.</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a><span class="sd">        </span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a><span class="sd">        FIPA Protocol Phase: **Result Notification - Award**</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="sd">            - Performative: store-confirm (FIPA accept-proposal)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="sd">            - Recipient: Selected warehouse (winner of proposal evaluation)</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">            - Purpose: Officially award the contract to the best proposal</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="sd">            - Protocol: FIPA Contract Net Protocol</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">        </span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a><span class="sd">        This behaviour does NOT update stock immediately. Stock updates occur only when</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a><span class="sd">        the vehicle delivers the products (upon receiving vehicle-delivery message).</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a><span class="sd">        This design accurately models real-world supply chains where confirmation precedes</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a><span class="sd">        actual inventory arrival.</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a><span class="sd">        </span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a><span class="sd">        Attributes:</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a><span class="sd">            dest (str): Warehouse JID (winner&#39;s address).</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="sd">            request_id (str): Unique request identifier from original CFP.</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a><span class="sd">            quantity (int): Quantity of product in the confirmed order.</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a><span class="sd">            product (str): Name of product in the confirmed order.</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a><span class="sd">            msg (Message): Original warehouse-accept message (for Order conversion).</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a><span class="sd">        </span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a><span class="sd">        Message Format (FIPA accept-proposal):</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a><span class="sd">            Metadata:</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a><span class="sd">                - performative: &quot;store-confirm&quot; (FIPA accept-proposal)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="sd">                - warehouse_id: Destination warehouse JID</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a><span class="sd">                - store_id: This store&#39;s JID</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">                - node_id: This store&#39;s graph location</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">                - request_id: Original CFP request identifier</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="sd">            Body:</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">        </span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a><span class="sd">            - Converts message to Order object using message_to_order()</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="sd">            - Adds order to agent.pending_deliveries dict (key: order_id)</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">            - Records confirmation timestamp in agent.order_timings (for statistics)</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">            - Sends store-confirm message to warehouse</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">            - Prints confirmation details (always visible, not verbose-only)</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">        </span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="sd">        Workflow:</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">            1. Convert warehouse-accept message to Order object</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a><span class="sd">            2. Register order in pending_deliveries (awaiting vehicle)</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a><span class="sd">            3. Record current tick in order_timings (for time-to-delivery calculation)</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a><span class="sd">            4. Construct store-confirm message with proper metadata</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a><span class="sd">            5. Send confirmation to warehouse</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a><span class="sd">            6. Print success message with order details</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a><span class="sd">        </span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="sd">        Example:</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a><span class="sd">            ```</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a><span class="sd">            Warehouse: warehouse2@localhost</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a><span class="sd">            Request: &quot;50 electronics&quot; (ID: 1001000000)</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a><span class="sd">            Action: Send store-confirm to warehouse2</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a><span class="sd">            Result: Order 1001000000 pending delivery</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="sd">            Print: &quot;Successfully bought 50 xelectronics from warehouse2...&quot;</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="sd">            ```</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a><span class="sd">        </span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="sd">        Note:</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">            The confirmation message triggers the warehouse to assign a vehicle for</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a><span class="sd">            delivery. The store then waits for vehicle-delivery message to update stock.</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a><span class="sd">            Initialize the SendStoreConfirmation behaviour.</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">            </span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a><span class="sd">            Args:</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a><span class="sd">                msg (Message): The warehouse-accept message from the winning warehouse.</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="sd">                    Contains all necessary information: sender, request_id, quantity, product.</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">                    Used to construct the confirmation message and create Order object.</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">            </span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">            Note:</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a><span class="sd">                Extracts and stores all relevant fields from the message for use in run().</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a><span class="sd">                The original message is preserved for Order object conversion.</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>            
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="sd">            Execute the confirmation sending process (FIPA accept-proposal).</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a><span class="sd">            </span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a><span class="sd">            This method sends the FIPA accept-proposal message to the winning warehouse,</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">            registers the order as pending delivery, and records timing information for</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a><span class="sd">            statistics. It implements the award notification phase of the FIPA Contract</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a><span class="sd">            Net Protocol.</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="sd">            </span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="sd">                - **Phase**: Result Notification - Award</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">                - **Performative**: store-confirm (FIPA accept-proposal)</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a><span class="sd">                - **Meaning**: &quot;Your proposal is accepted, prepare the order&quot;</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="sd">                - **Expected Response**: Warehouse assigns vehicle for delivery</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="sd">            </span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a><span class="sd">            Important Design Decision:</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a><span class="sd">                Stock is NOT updated immediately upon confirmation. Stock updates occur</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a><span class="sd">                only when the vehicle delivers the products (vehicle-delivery message).</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a><span class="sd">                This accurately models real-world logistics where confirmation  possession.</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="sd">            </span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a><span class="sd">            Workflow:</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">                1. **Order Conversion**: Convert warehouse-accept message to Order object</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="sd">                    - Extracts: product, quantity, orderid, sender, receiver, locations</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">                    - Uses message_to_order() helper method</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="sd">                </span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">                2. **Order Registration**: Add to pending_deliveries dict</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a><span class="sd">                    - Key: order.orderid (unique request ID)</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">                    - Value: Order object with full details</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">                    - Purpose: Track orders awaiting vehicle delivery</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">                </span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">                3. **Timing Record**: Store current tick in order_timings</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">                    - Key: order.orderid</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="sd">                    - Value: agent.current_tick (simulation time)</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">                    - Purpose: Calculate time-to-delivery for statistics</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">                </span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="sd">                4. **Message Construction**: Build store-confirm message</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="sd">                    - Performative: store-confirm (FIPA accept-proposal)</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">                    - Metadata: warehouse_id, store_id, node_id, request_id</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a><span class="sd">                    - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">                </span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">                5. **Message Transmission**: Send confirmation to warehouse</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="sd">                    - Triggers warehouse to assign vehicle</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">                    - Initiates delivery logistics process</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="sd">                </span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="sd">                6. **Status Logging**: Print confirmation details</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="sd">                    - Verbose message: Confirmation sent details</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="sd">                    - Essential message: Order success with order ID</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">            </span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="sd">            Side Effects:</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="sd">                - Modifies agent.pending_deliveries (adds order)</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="sd">                - Modifies agent.order_timings (records timestamp)</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a><span class="sd">                - Sends SPADE message to warehouse</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a><span class="sd">                - Prints status information to console</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="sd">            </span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">            Returns:</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">                None. Completes when confirmation message is sent.</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">            </span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">            Example Execution:</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">                ```</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="sd">                Input: warehouse-accept from warehouse2</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">                    Body: &quot;50 electronics&quot;</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a><span class="sd">                    request_id: 1001000000</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a><span class="sd">                Processing:</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="sd">                    - Create Order(orderid=1001000000, quantity=50, product=&quot;electronics&quot;)</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a><span class="sd">                    - pending_deliveries[1001000000] = Order(...)</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a><span class="sd">                    - order_timings[1001000000] = 42 (current tick)</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a><span class="sd">                Output:</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a><span class="sd">                    - Send store-confirm to warehouse2</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a><span class="sd">                    - Print: &quot;Successfully bought 50 xelectronics from warehouse2 under order id 1001000000&quot;</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a><span class="sd">                ```</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a><span class="sd">            </span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a><span class="sd">            Note:</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a><span class="sd">                The order remains in pending_deliveries until ReceiveVehicleArrival</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a><span class="sd">                processes the vehicle-delivery message and updates stock. This maintains</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a><span class="sd">                separation between contract award and physical delivery.</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>            
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>            <span class="c1"># Don&#39;t update stock here - wait for vehicle delivery</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>            <span class="c1"># Stock will be updated when vehicle-delivery message is received</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>            <span class="n">order</span> <span class="p">:</span> <span class="n">Order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">message_to_order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">order_timings</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">current_tick</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>            
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-confirm&quot;</span><span class="p">)</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>            
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>            
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Confirmation sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>            
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Successully bought </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> under order id </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SendStoreDenial</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a><span class="sd">        Behaviour to send rejection to non-selected warehouses (FIPA reject-proposal).</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a><span class="sd">        </span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a><span class="sd">        This behaviour implements the rejection notification phase of the FIPA Contract</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a><span class="sd">        Net Protocol, informing warehouses that submitted proposals that their bids were</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a><span class="sd">        not selected. This is an essential part of the protocol, providing feedback to</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a><span class="sd">        all participants about the outcome of the negotiation.</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a><span class="sd">        </span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="sd">        FIPA Protocol Phase: **Result Notification - Rejection**</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="sd">            - Performative: store-deny (FIPA reject-proposal)</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">            - Recipients: Warehouses that proposed but were not selected</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">            - Purpose: Inform participants their proposal was rejected</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">            - Protocol: FIPA Contract Net Protocol</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">            - Note: Warehouses that refused (warehouse-reject) do NOT receive this</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">        </span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">        This message allows warehouses to release any resources they may have reserved</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a><span class="sd">        for this order and update their internal state accordingly.</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="sd">        </span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">        Attributes:</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">            dest (str): Warehouse JID (non-selected participant&#39;s address).</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">            request_id (str): Unique request identifier from original CFP.</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a><span class="sd">            quantity (int): Quantity of product in the rejected order.</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">            product (str): Name of product in the rejected order.</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">        </span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="sd">        Message Format (FIPA reject-proposal):</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="sd">            Metadata:</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">                - performative: &quot;store-deny&quot; (FIPA reject-proposal)</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a><span class="sd">                - warehouse_id: Destination warehouse JID</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a><span class="sd">                - store_id: This store&#39;s JID</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a><span class="sd">                - node_id: This store&#39;s graph location</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a><span class="sd">                - request_id: Original CFP request identifier</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a><span class="sd">            Body:</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">        </span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a><span class="sd">            - Sends store-deny message to warehouse</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a><span class="sd">            - Prints denial confirmation (verbose mode only)</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a><span class="sd">        </span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a><span class="sd">        Example:</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a><span class="sd">            ```</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a><span class="sd">            Scenario: 3 warehouses proposed, warehouse2 won</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a><span class="sd">            Recipients: warehouse1, warehouse3 (both receive store-deny)</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a><span class="sd">            Message: &quot;50 electronics&quot;</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a><span class="sd">            Result: warehouse1 and warehouse3 know they were not selected</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a><span class="sd">            ```</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a><span class="sd">        </span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a><span class="sd">        Note:</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a><span class="sd">            This notification is important for warehouses to maintain accurate internal</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a><span class="sd">            state and avoid waiting indefinitely for a confirmation that will never come.</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a><span class="sd">            Initialize the SendStoreDenial behaviour.</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a><span class="sd">            </span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a><span class="sd">            Args:</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a><span class="sd">                msg (Message): The warehouse-accept message from the non-selected warehouse.</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a><span class="sd">                    Contains sender information and order details needed for rejection message.</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a><span class="sd">            </span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a><span class="sd">            Note:</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a><span class="sd">                Extracts only the essential fields needed to construct the rejection.</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a><span class="sd">                Unlike SendStoreConfirmation, this doesn&#39;t need to create an Order object.</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>        
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a><span class="sd">            Execute the rejection sending process (FIPA reject-proposal).</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a><span class="sd">            </span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a><span class="sd">            This method sends the FIPA reject-proposal message to non-selected warehouses,</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a><span class="sd">            completing the result notification phase of the FIPA Contract Net Protocol.</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a><span class="sd">            </span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a><span class="sd">                - **Phase**: Result Notification - Rejection</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a><span class="sd">                - **Performative**: store-deny (FIPA reject-proposal)</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a><span class="sd">                - **Meaning**: &quot;Your proposal was not selected&quot;</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a><span class="sd">                - **Expected Response**: Warehouse releases resources, updates state</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a><span class="sd">            </span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a><span class="sd">            Workflow:</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a><span class="sd">                1. **Message Construction**: Build store-deny message</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a><span class="sd">                    - Performative: store-deny (FIPA reject-proposal)</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a><span class="sd">                    - Metadata: warehouse_id, store_id, node_id, request_id</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a><span class="sd">                    - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a><span class="sd">                </span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a><span class="sd">                2. **Message Transmission**: Send rejection to warehouse</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a><span class="sd">                    - Notifies warehouse of negative outcome</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a><span class="sd">                    - Allows warehouse to handle rejection gracefully</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a><span class="sd">                </span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a><span class="sd">                3. **Status Logging**: Print denial confirmation (verbose only)</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a><span class="sd">            </span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a><span class="sd">            Side Effects:</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a><span class="sd">                - Sends SPADE message to warehouse</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a><span class="sd">                - Prints status information if verbose mode enabled</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a><span class="sd">            </span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a><span class="sd">            Returns:</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">                None. Completes when rejection message is sent.</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a><span class="sd">            </span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a><span class="sd">            Example Execution:</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a><span class="sd">                ```</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a><span class="sd">                Input: warehouse-accept from warehouse1 (not selected)</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a><span class="sd">                    Body: &quot;50 electronics&quot;</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a><span class="sd">                    request_id: 1001000000</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a><span class="sd">                Processing:</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a><span class="sd">                    - Create store-deny message</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a><span class="sd">                    - Set metadata and body</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a><span class="sd">                Output:</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a><span class="sd">                    - Send store-deny to warehouse1</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="sd">                    - Print (if verbose): &quot;Denial sent to warehouse1 for request: 50 electronics&quot;</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a><span class="sd">                ```</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>            
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-deny&quot;</span><span class="p">)</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>            
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>            
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Denial sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>    
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">RetryPreviousBuy</span><span class="p">(</span><span class="n">PeriodicBehaviour</span><span class="p">):</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a><span class="sd">        Periodic behaviour that retries failed purchase requests.</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a><span class="sd">        </span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a><span class="sd">        This behaviour implements automatic retry logic for purchase requests that failed</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a><span class="sd">        due to all warehouses rejecting or timing out. It periodically checks the</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a><span class="sd">        failed_requests queue and re-initiates the FIPA Contract Net Protocol for any</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a><span class="sd">        pending failed requests.</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a><span class="sd">        </span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a><span class="sd">        Failure Scenarios:</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a><span class="sd">            - All warehouses sent warehouse-reject (refuse)</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a><span class="sd">            - All warehouses timed out (no response)</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a><span class="sd">            - Mix of rejects and timeouts with zero acceptances</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a><span class="sd">        </span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a><span class="sd">        The behaviour maintains the original request_id for tracking and statistics,</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a><span class="sd">        allowing correlation between original attempt and retry attempts in logs.</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a><span class="sd">        </span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a><span class="sd">        Attributes:</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a><span class="sd">            Inherited from PeriodicBehaviour:</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a><span class="sd">                - period (float): Time between retry attempts (default: 5 seconds)</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a><span class="sd">                - Executes continuously while agent is running</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a><span class="sd">        </span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a><span class="sd">        Retry Logic:</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a><span class="sd">            - Checks failed_requests queue (FIFO)</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a><span class="sd">            - Dequeues one request per execution</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a><span class="sd">            - Preserves original request_id (no new ID generated)</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a><span class="sd">            - Re-broadcasts CFP to all warehouses</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a><span class="sd">            - Launches CollectWarehouseResponses coordinator</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a><span class="sd">        </span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a><span class="sd">        FIPA Protocol:</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a><span class="sd">            Restarts the entire FIPA Contract Net Protocol:</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a><span class="sd">            1. Call for Proposals (CFP) - re-broadcast with same request_id</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a><span class="sd">            2. Proposal Reception - collect new responses</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a><span class="sd">            3. Proposal Evaluation - score and select best warehouse</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a><span class="sd">            4. Result Notification - confirm winner, deny losers</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a><span class="sd">        </span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a><span class="sd">        Workflow:</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a><span class="sd">            1. **Queue Check**: Test if failed_requests queue is empty</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a><span class="sd">            2. **Dequeue**: Get oldest failed request from queue</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a><span class="sd">            3. **Parse**: Extract request_id, quantity, product from message</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a><span class="sd">            4. **Re-broadcast**: Send store-buy to all warehouses (same request_id)</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a><span class="sd">            5. **Coordinate**: Launch CollectWarehouseResponses for this retry</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a><span class="sd">            6. **Synchronize**: Wait for coordinator to complete</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a><span class="sd">            7. **Repeat**: Next period, check queue again</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a><span class="sd">        </span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a><span class="sd">        Example Execution:</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a><span class="sd">            ```</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a><span class="sd">            Initial Attempt (t=10s):</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a><span class="sd">                - Request &quot;50 electronics&quot; (ID: 1001000000)</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a><span class="sd">                - All warehouses reject or timeout</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a><span class="sd">                - Added to failed_requests queue</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a><span class="sd">            </span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a><span class="sd">            Retry Attempt (t=15s):</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a><span class="sd">                - Dequeue request 1001000000</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a><span class="sd">                - Re-broadcast to all warehouses (same ID)</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a><span class="sd">                - New responses: warehouse2 accepts</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a><span class="sd">                - Success: Order placed with warehouse2</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a><span class="sd">            ```</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a><span class="sd">        </span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a><span class="sd">            - Dequeues from agent.failed_requests</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a><span class="sd">            - Sends store-buy messages to all warehouses</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a><span class="sd">            - Adds CollectWarehouseResponses behaviour</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a><span class="sd">            - Prints retry information if verbose mode enabled</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a><span class="sd">        </span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a><span class="sd">        Notes:</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a><span class="sd">            - Retries use the SAME request_id as original attempt</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a><span class="sd">            - No limit on retry attempts (will retry until success)</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a><span class="sd">            - Failed retries are re-enqueued by CollectWarehouseResponses</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a><span class="sd">            - Period of 5 seconds prevents overwhelming warehouses</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a><span class="sd">            Execute one retry cycle for failed purchase requests.</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a><span class="sd">            </span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a><span class="sd">            This method checks the failed_requests queue and, if not empty, dequeues</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a><span class="sd">            one request and re-initiates the FIPA Contract Net Protocol with the same</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a><span class="sd">            request_id. This maintains traceability across retry attempts.</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a><span class="sd">            </span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a><span class="sd">            Workflow:</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a><span class="sd">                1. **Queue Check**: If failed_requests is empty, do nothing</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a><span class="sd">                2. **Dequeue Request**: Get oldest failed request (FIFO order)</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a><span class="sd">                3. **Extract Data**: Parse request_id, quantity, product from message</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a><span class="sd">                4. **Count Participants**: Get number of warehouses for response tracking</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a><span class="sd">                5. **Rebuild Messages**: Create new store-buy messages for each warehouse</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a><span class="sd">                6. **Broadcast CFP**: Send retry request to all warehouses</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a><span class="sd">                7. **Launch Coordinator**: Start CollectWarehouseResponses with same request_id</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a><span class="sd">                8. **Wait**: Synchronize on coordinator completion</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a><span class="sd">            </span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a><span class="sd">            Request ID Preservation:</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a><span class="sd">                The original request_id is preserved across retries, enabling:</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a><span class="sd">                - Statistics tracking (correlate original and retries)</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a><span class="sd">                - Debugging (trace request lifecycle)</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a><span class="sd">                - Avoiding duplicate processing (warehouses can detect retries)</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">            </span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a><span class="sd">            Side Effects:</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">                - Removes one message from agent.failed_requests queue</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">                - Sends multiple store-buy messages (one per warehouse)</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a><span class="sd">                - Adds CollectWarehouseResponses behaviour to agent</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a><span class="sd">                - Prints retry notifications if verbose mode enabled</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a><span class="sd">            </span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a><span class="sd">            Returns:</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a><span class="sd">                None. Completes when coordinator finishes negotiation, or immediately</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a><span class="sd">                if queue is empty.</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a><span class="sd">            </span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a><span class="sd">            Example Execution:</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a><span class="sd">                ```</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a><span class="sd">                Queue State: [Request(ID=1001000000, &quot;50 electronics&quot;)]</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a><span class="sd">                Processing:</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a><span class="sd">                    - Dequeue: Request 1001000000</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a><span class="sd">                    - Parse: quantity=50, product=&quot;electronics&quot;</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a><span class="sd">                    - Broadcast: Send to warehouse1, warehouse2, warehouse3</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a><span class="sd">                    - Coordinate: Launch CollectWarehouseResponses(1001000000, ...)</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a><span class="sd">                    - Wait: Until new responses collected and evaluated</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a><span class="sd">                Result:</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a><span class="sd">                    - If success: Order placed</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a><span class="sd">                    - If failure: Re-enqueued for next retry cycle</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a><span class="sd">                ```</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a><span class="sd">            </span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a><span class="sd">            Note:</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a><span class="sd">                This method processes only ONE request per execution cycle (period=5s).</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a><span class="sd">                This prevents flooding warehouses with retry requests and allows</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a><span class="sd">                gradual processing of the failed_requests backlog.</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>            
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>                <span class="n">request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>                <span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>                <span class="n">parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>                
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>                <span class="n">contacts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>                <span class="n">num_warehouses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contacts</span><span class="p">)</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>                
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>                <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">:</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>                    <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">contact</span><span class="p">)</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">set_buy_metadata</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Retrying request (id=</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>                              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>                <span class="c1"># Use CollectWarehouseResponses instead</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectWarehouseResponses</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">num_warehouses</span><span class="p">)</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>    
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveTimeDelta</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a><span class="sd">        Cyclic behaviour that processes simulation time updates and traffic information.</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a><span class="sd">        </span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a><span class="sd">        This behaviour listens for time synchronization messages from the world agent,</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a><span class="sd">        updating the store&#39;s internal clock and applying dynamic traffic changes to the</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a><span class="sd">        graph. It implements an event-driven architecture where the world agent controls</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a><span class="sd">        simulation time progression.</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a><span class="sd">        </span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a><span class="sd">        Message Types Processed:</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a><span class="sd">            1. **Time Updates** (all messages):</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a><span class="sd">                - Updates agent.current_tick with time delta</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a><span class="sd">                - Synchronizes store with global simulation time</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a><span class="sd">            </span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a><span class="sd">            2. **Traffic Updates** (type=&quot;Transit&quot;):</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a><span class="sd">                - Applies dynamic edge weight changes to graph</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a><span class="sd">                - Updates fuel consumption values for routes</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a><span class="sd">                - Reflects real-time traffic conditions</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a><span class="sd">        </span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a><span class="sd">        Message Format:</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a><span class="sd">            Metadata:</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a><span class="sd">                - performative: &quot;inform&quot;</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a><span class="sd">            Body (JSON):</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a><span class="sd">                ```json</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a><span class="sd">                {</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a><span class="sd">                    &quot;type&quot;: &quot;Transit&quot;,  // or other types</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a><span class="sd">                    &quot;time&quot;: 5,          // delta in ticks</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a><span class="sd">                    &quot;data&quot;: {</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a><span class="sd">                        &quot;edges&quot;: [</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a><span class="sd">                            {</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a><span class="sd">                                &quot;node1&quot;: 1,</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a><span class="sd">                                &quot;node2&quot;: 2,</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="sd">                                &quot;weight&quot;: 150,</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a><span class="sd">                                &quot;fuel_consumption&quot;: 12.5</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a><span class="sd">                            },</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a><span class="sd">                            ...</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a><span class="sd">                        ]</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a><span class="sd">                    }</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a><span class="sd">                }</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a><span class="sd">                ```</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a><span class="sd">        </span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a><span class="sd">        Attributes:</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a><span class="sd">            Inherits from CyclicBehaviour:</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a><span class="sd">                - Runs continuously in infinite loop</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a><span class="sd">                - Processes one message per cycle</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a><span class="sd">                - 20-second timeout per receive attempt</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a><span class="sd">        </span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a><span class="sd">        Workflow:</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a><span class="sd">            1. **Receive Message**: Wait up to 20 seconds for inform message</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a><span class="sd">            2. **Parse JSON**: Extract type, time delta, and data</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a><span class="sd">            3. **Update Time**: Increment current_tick by delta</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a><span class="sd">            4. **Check Type**: If type is &quot;Transit&quot;, process traffic updates</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a><span class="sd">            5. **Update Graph**: Apply edge weight changes using update_graph()</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a><span class="sd">            6. **Repeat**: Return to step 1 (cyclic behaviour)</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a><span class="sd">        </span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a><span class="sd">        Traffic Update Process:</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a><span class="sd">            When type=&quot;Transit&quot;:</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a><span class="sd">                - Extract edges array from data field</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a><span class="sd">                - For each edge: update weight and fuel_consumption</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a><span class="sd">                - Uses update_graph() helper method</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a><span class="sd">                - Affects pathfinding calculations in warehouse selection</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a><span class="sd">        </span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a><span class="sd">        Example Execution:</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a><span class="sd">            ```</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a><span class="sd">            Message Received:</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a><span class="sd">                {</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a><span class="sd">                    &quot;type&quot;: &quot;Transit&quot;,</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a><span class="sd">                    &quot;time&quot;: 3,</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a><span class="sd">                    &quot;data&quot;: {</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a><span class="sd">                        &quot;edges&quot;: [</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a><span class="sd">                            {&quot;node1&quot;: 5, &quot;node2&quot;: 10, &quot;weight&quot;: 200, &quot;fuel_consumption&quot;: 15.0}</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a><span class="sd">                        ]</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a><span class="sd">                    }</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a><span class="sd">                }</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a><span class="sd">            Processing:</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a><span class="sd">                - current_tick: 42 -&gt; 45 (increment by 3)</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a><span class="sd">                - Update edge (5, 10): weight=200, fuel=15.0</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a><span class="sd">                - Next warehouse selection uses new weights</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a><span class="sd">            ```</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a><span class="sd">        </span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a><span class="sd">            - Increments agent.current_tick (time synchronization)</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a><span class="sd">            - Modifies agent.map edge weights (traffic updates)</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a><span class="sd">            - Affects future pathfinding and warehouse scoring</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a><span class="sd">        </span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a><span class="sd">        Returns:</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a><span class="sd">            Never returns (cyclic behaviour runs until agent stops).</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a><span class="sd">        </span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a><span class="sd">        Note:</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a><span class="sd">            The 20-second timeout prevents indefinite blocking if world agent stops</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a><span class="sd">            sending updates. This is a safety mechanism for graceful degradation.</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a><span class="sd">            Execute one cycle of time delta reception and processing.</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a><span class="sd">            </span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a><span class="sd">            This method receives one time synchronization message, updates the store&#39;s</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a><span class="sd">            internal clock, and applies any traffic updates to the graph if present.</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a><span class="sd">            </span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a><span class="sd">            Workflow:</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a><span class="sd">                1. **Receive**: Wait up to 20 seconds for inform message</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a><span class="sd">                2. **Validation**: Check if message received (not None)</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a><span class="sd">                3. **Parse**: Deserialize JSON body</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a><span class="sd">                4. **Extract**: Get type, time delta from JSON</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a><span class="sd">                5. **Sync Time**: Add delta to current_tick</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a><span class="sd">                6. **Check Type**: Test if type is &quot;Transit&quot; (case-insensitive)</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a><span class="sd">                7. **Update Graph**: If Transit, apply edge changes via update_graph()</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a><span class="sd">            </span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a><span class="sd">            Time Synchronization:</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a><span class="sd">                Every message (regardless of type) causes time advancement:</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a><span class="sd">                - current_tick += delta</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a><span class="sd">                - Keeps store synchronized with global simulation time</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a><span class="sd">                - Used for order timing statistics</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a><span class="sd">            </span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a><span class="sd">            Traffic Updates:</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a><span class="sd">                Only Transit messages include graph updates:</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a><span class="sd">                - data.edges contains array of edge changes</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a><span class="sd">                - Each edge: node1, node2, new weight, fuel_consumption</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a><span class="sd">                - Calls update_graph() to apply changes atomically</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a><span class="sd">            </span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a><span class="sd">            Side Effects:</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a><span class="sd">                - Always increments agent.current_tick</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a><span class="sd">                - Conditionally modifies agent.map (if Transit message)</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a><span class="sd">            </span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a><span class="sd">            Returns:</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a><span class="sd">                None. Continues to next cycle after processing one message.</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a><span class="sd">            </span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a><span class="sd">            Example:</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a><span class="sd">                ```</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a><span class="sd">                Input: {&quot;type&quot;: &quot;Transit&quot;, &quot;time&quot;: 2, &quot;data&quot;: {&quot;edges&quot;: [...]}}</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a><span class="sd">                Effect:</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a><span class="sd">                    - current_tick: 100 -&gt; 102</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a><span class="sd">                    - Graph edges updated with new weights</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a><span class="sd">                Next Cycle: Wait for next message</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a><span class="sd">                ```</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>            
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>            
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>                
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>                <span class="nb">type</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>                <span class="n">delta</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>                
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;transit&quot;</span><span class="p">:</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>                    <span class="n">map_updates</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">update_graph</span><span class="p">(</span><span class="n">map_updates</span><span class="p">)</span>         
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>    
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveVehicleArrival</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a><span class="sd">        Cyclic behaviour that handles vehicle delivery notifications.</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a><span class="sd">        </span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a><span class="sd">        This behaviour processes delivery completion messages from vehicle agents,</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a><span class="sd">        updating inventory when products arrive at the store. It represents the final</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a><span class="sd">        step in the supply chain: physical delivery and stock replenishment.</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a><span class="sd">        </span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a><span class="sd">        Message Types Accepted:</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a><span class="sd">            - **vehicle-delivery**: Vehicle completed delivery to store (primary)</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a><span class="sd">            - **vehicle-pickup**: Vehicle picked up goods from warehouse (informational)</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a><span class="sd">        </span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a><span class="sd">        The behaviour is filtered by template to only receive vehicle-delivery messages,</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a><span class="sd">        but includes validation as a safety mechanism.</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a><span class="sd">        </span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a><span class="sd">        Message Format:</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a><span class="sd">            Metadata:</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a><span class="sd">                - performative: &quot;vehicle-delivery&quot;</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a><span class="sd">                - sender: Vehicle JID</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a><span class="sd">            Body (JSON):</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a><span class="sd">                ```json</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a><span class="sd">                {</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a><span class="sd">                    &quot;orderid&quot;: 1001000000,  // Unique order identifier</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a><span class="sd">                    &quot;time&quot;: 150             // ETA or delivery time</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a><span class="sd">                }</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a><span class="sd">                ```</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a><span class="sd">        </span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a><span class="sd">        Attributes:</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a><span class="sd">            Inherits from CyclicBehaviour:</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a><span class="sd">                - Runs continuously in infinite loop</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a><span class="sd">                - Processes one message per cycle</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a><span class="sd">                - 20-second timeout per receive attempt</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a><span class="sd">        </span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a><span class="sd">        Workflow:</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a><span class="sd">            1. **Receive Message**: Wait up to 20 seconds for vehicle-delivery</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a><span class="sd">            2. **Validate Performative**: Verify it&#39;s vehicle-delivery (should be filtered)</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a><span class="sd">            3. **Parse JSON**: Extract orderid and time (ETA)</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a><span class="sd">            4. **Lookup Order**: Find order in pending_deliveries by orderid</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a><span class="sd">            5. **Update Stock**: Add delivered quantity to inventory</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a><span class="sd">            6. **Remove Pending**: Delete order from pending_deliveries</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a><span class="sd">            7. **Record Statistics**: Save delivery data to CSV</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a><span class="sd">            8. **Log Delivery**: Print confirmation and current stock</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a><span class="sd">            9. **Repeat**: Return to step 1 (cyclic behaviour)</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a><span class="sd">        </span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a><span class="sd">        Stock Update Logic:</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a><span class="sd">            ```python</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a><span class="sd">            if product in stock:</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a><span class="sd">                stock[product] += quantity  # Increment existing</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a><span class="sd">            else:</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a><span class="sd">                stock[product] = quantity   # Create new entry</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a><span class="sd">            ```</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a><span class="sd">        </span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a><span class="sd">        Statistics Recorded:</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a><span class="sd">            - order_id: Unique identifier</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a><span class="sd">            - store_jid: This store&#39;s identifier</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a><span class="sd">            - vehicle_jid: Delivering vehicle identifier</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a><span class="sd">            - origin_warehouse: Warehouse that fulfilled order</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a><span class="sd">            - product: Product name</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a><span class="sd">            - quantity: Amount delivered</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a><span class="sd">            - ETA: Estimated time of arrival</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a><span class="sd">            - time_to_delivery: Ticks from confirmation to delivery</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a><span class="sd">            - current_tick: Current simulation time</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a><span class="sd">            - final_state: &quot;delivered&quot; (success indicator)</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a><span class="sd">        </span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a><span class="sd">        Error Handling:</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a><span class="sd">            - **Wrong Performative**: Prints ERROR and returns early</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a><span class="sd">            - **JSON Parse Failure**: Catches JSONDecodeError, prints ERROR</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a><span class="sd">            - **Missing Order ID**: Catches KeyError, prints ERROR</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a><span class="sd">            - Graceful degradation: Does not crash agent on malformed messages</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a><span class="sd">        </span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a><span class="sd">        Example Execution:</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a><span class="sd">            ```</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a><span class="sd">            Message Received:</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a><span class="sd">                {</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a><span class="sd">                    &quot;orderid&quot;: 1001000000,</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a><span class="sd">                    &quot;time&quot;: 120</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a><span class="sd">                }</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a><span class="sd">            Processing:</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a><span class="sd">                - Find Order: product=&quot;electronics&quot;, quantity=50</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a><span class="sd">                - Update Stock: electronics: 200 -&gt; 250</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a><span class="sd">                - Remove: pending_deliveries[1001000000] deleted</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a><span class="sd">                - Record Stats: CSV entry with all details</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a><span class="sd">                - Print: &quot;Vehicle vehicle1@localhost delivered 50 units of electronics&quot;</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a><span class="sd">                - Print: Current stock display</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a><span class="sd">            ```</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a><span class="sd">        </span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a><span class="sd">            - Modifies agent.stock (inventory increase)</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a><span class="sd">            - Removes order from agent.pending_deliveries</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a><span class="sd">            - Writes statistics to CSV file</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a><span class="sd">            - Prints delivery confirmation and stock status</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a><span class="sd">        </span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a><span class="sd">        Returns:</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a><span class="sd">            Never returns (cyclic behaviour runs until agent stops).</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a><span class="sd">        </span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a><span class="sd">        Note:</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a><span class="sd">            This is the ONLY place where stock is updated. Confirmations do NOT update</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a><span class="sd">            stock - only physical delivery does. This accurately models real-world</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a><span class="sd">            inventory management where confirmation  possession.</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a><span class="sd">            Execute one cycle of vehicle delivery message processing.</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a><span class="sd">            </span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a><span class="sd">            This method receives one delivery notification, updates inventory, records</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a><span class="sd">            statistics, and prepares for the next delivery message.</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a><span class="sd">            </span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a><span class="sd">            Workflow:</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a><span class="sd">                1. **Receive**: Wait up to 20 seconds for message</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a><span class="sd">                2. **Validation**: Check performative is vehicle-delivery</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a><span class="sd">                3. **Parsing**: Deserialize JSON and extract orderid, time</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a><span class="sd">                4. **Order Lookup**: Find order in pending_deliveries</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a><span class="sd">                5. **Stock Update**: Add quantity to inventory (create or increment)</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a><span class="sd">                6. **Cleanup**: Remove order from pending_deliveries</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a><span class="sd">                7. **Statistics**: Record delivery details to CSV</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a><span class="sd">                8. **Logging**: Print delivery confirmation and stock display</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a><span class="sd">            </span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a><span class="sd">            Error Handling:</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a><span class="sd">                Three validation layers:</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a><span class="sd">                1. Template filter (should only receive vehicle-delivery)</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a><span class="sd">                2. Performative check (safety validation)</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a><span class="sd">                3. Try-except for JSON parsing and order lookup</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a><span class="sd">            </span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a><span class="sd">            Stock Update Details:</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a><span class="sd">                - Retrieves product and quantity from pending order</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a><span class="sd">                - If product exists: stock[product] += quantity</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a><span class="sd">                - If product new: stock[product] = quantity</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a><span class="sd">                - Thread-safe (single-threaded SPADE execution)</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a><span class="sd">            </span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a><span class="sd">            Statistics Recording:</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a><span class="sd">                Calls get_stats() with:</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a><span class="sd">                - order: Order object with all details</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a><span class="sd">                - eta: Estimated time from message</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a><span class="sd">                - state: &quot;delivered&quot; (success indicator)</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a><span class="sd">                - vehicle: Vehicle JID from message sender</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a><span class="sd">            </span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a><span class="sd">            Side Effects:</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a><span class="sd">                - Increments stock for delivered product</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a><span class="sd">                - Removes order from pending_deliveries dict</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a><span class="sd">                - Appends row to store_stats.csv</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a><span class="sd">                - Prints to console (always visible, not verbose-only)</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a><span class="sd">            </span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a><span class="sd">            Returns:</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a><span class="sd">                None. Continues to next cycle after processing one delivery.</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a><span class="sd">            </span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a><span class="sd">            Example:</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a><span class="sd">                ```</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a><span class="sd">                Input: vehicle-delivery from vehicle1</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a><span class="sd">                    Body: {&quot;orderid&quot;: 1001000000, &quot;time&quot;: 120}</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a><span class="sd">                Pending Order: Order(product=&quot;electronics&quot;, quantity=50, ...)</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a><span class="sd">                Processing:</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a><span class="sd">                    - Stock before: {&quot;electronics&quot;: 200, &quot;food&quot;: 100}</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a><span class="sd">                    - Update: electronics += 50</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a><span class="sd">                    - Stock after: {&quot;electronics&quot;: 250, &quot;food&quot;: 100}</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a><span class="sd">                    - Remove from pending_deliveries</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a><span class="sd">                    - Write CSV row</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a><span class="sd">                Output:</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a><span class="sd">                    Print: &quot;Vehicle vehicle1@localhost delivered 50 units of electronics&quot;</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a><span class="sd">                    Print: &quot;Current stock: electronics: 250 units, food: 100 units&quot;</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a><span class="sd">                ```</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>            
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>                <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>                
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>                <span class="c1"># Double-check (should already be filtered by templates)</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">]:</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Received unexpected performative &#39;</span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>                    <span class="k">return</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>                
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>                <span class="c1"># Parse message body</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>                    <span class="n">orderid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">]</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">orderid</span><span class="p">]</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>                    <span class="n">eta</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>          
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>                <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Failed to parse vehicle message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>                    <span class="k">return</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>                <span class="c1"># Vehicle is delivering supplies from supplier</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>                
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>                <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>                <span class="k">del</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>                
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>                <span class="c1"># Save order stats</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span><span class="s2">&quot;delivered&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>                
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> delivered </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>    
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>    <span class="c1">#           AUXILARY FUNCTIONS</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>    
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_warehouse_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a><span class="sd">        Calculate the score for a warehouse proposal based on delivery time.</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a><span class="sd">        </span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a><span class="sd">        This method implements the proposal evaluation logic for the FIPA Contract Net</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a><span class="sd">        Protocol, scoring each warehouse that submitted a proposal (warehouse-accept).</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a><span class="sd">        The score is based on the estimated delivery time using Dijkstra&#39;s shortest path</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a><span class="sd">        algorithm on the world graph.</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a><span class="sd">        </span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a><span class="sd">        Scoring Algorithm:</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a><span class="sd">            - Uses Dijkstra pathfinding: warehouse_node -&gt; store_node</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a><span class="sd">            - Returns: (path, fuel_cost, delivery_time)</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a><span class="sd">            - Score = delivery_time (lower is better)</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a><span class="sd">            - Optimization goal: Minimize delivery time</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a><span class="sd">        </span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a><span class="sd">        FIPA Contract Net Protocol Context:</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a><span class="sd">            - Phase: Proposal Evaluation</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a><span class="sd">            - Purpose: Compare multiple proposals objectively</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a><span class="sd">            - Decision Criteria: Distance-based (delivery time)</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a><span class="sd">            - Result: Enables selection of optimal warehouse</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a><span class="sd">        </span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a><span class="sd">        Args:</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a><span class="sd">            accept_msg (Message): The warehouse-accept message from a warehouse.</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a><span class="sd">                Contains metadata with node_id of the warehouse&#39;s location.</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a><span class="sd">        </span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a><span class="sd">        Returns:</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a><span class="sd">            float: Delivery time score. Lower values indicate better proposals</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a><span class="sd">                (shorter delivery time).</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a><span class="sd">        </span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a><span class="sd">        Scoring Details:</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a><span class="sd">            - Extracts warehouse node_id from message metadata</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a><span class="sd">            - Calls Dijkstra: map.djikstra(warehouse_id, store_id)</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a><span class="sd">            - Returns time component (ignores path and fuel for scoring)</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a><span class="sd">            - Units: Simulation ticks (time units in the simulation)</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a><span class="sd">        </span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a><span class="sd">        Example:</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a><span class="sd">            ```python</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a><span class="sd">            # Warehouse at node 10, Store at node 5</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a><span class="sd">            msg = warehouse_accept_message  # node_id = 10</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a><span class="sd">            score = store.calculate_warehouse_score(msg)</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a><span class="sd">            # Dijkstra returns: ([10, 8, 5], 12.5, 120)</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a><span class="sd">            # score = 120 (delivery time)</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a><span class="sd">            ```</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a><span class="sd">        </span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a><span class="sd">        Note:</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a><span class="sd">            This method is called by CollectWarehouseResponses during proposal</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a><span class="sd">            evaluation. All warehouses that sent warehouse-accept are scored,</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a><span class="sd">            and the one with the lowest score (minimum time) is selected.</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a><span class="sd">        </span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a><span class="sd">        Alternative Scoring Strategies:</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a><span class="sd">            The algorithm could be extended to consider:</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a><span class="sd">            - Weighted combination: time * w1 + fuel * w2</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a><span class="sd">            - Multi-criteria: time, fuel, warehouse reputation</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a><span class="sd">            - Dynamic weights: Based on urgency or fuel costs</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>        
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>        <span class="n">warehouse_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">accept_msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">))</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>        <span class="n">path</span><span class="p">,</span> <span class="n">fuel</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">djikstra</span><span class="p">(</span><span class="n">warehouse_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>        
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>        <span class="k">return</span> <span class="n">time</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>    
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dict_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a><span class="sd">        Convert a dictionary representation to an Order object.</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a><span class="sd">        </span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a><span class="sd">        This helper method deserializes order data from dictionary format into</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a><span class="sd">        an Order object instance, setting all required fields and optional location</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a><span class="sd">        information if present.</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a><span class="sd">        </span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a><span class="sd">        Args:</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a><span class="sd">            data (dict): Dictionary containing order information with keys:</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a><span class="sd">                - product (str): Product name</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a><span class="sd">                - quantity (int): Quantity ordered</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a><span class="sd">                - orderid (int): Unique order identifier</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a><span class="sd">                - sender (str): Sender&#39;s JID</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a><span class="sd">                - receiver (str): Receiver&#39;s JID</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a><span class="sd">                - sender_location (int, optional): Sender&#39;s graph node ID</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a><span class="sd">                - receiver_location (int, optional): Receiver&#39;s graph node ID</span>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a><span class="sd">        </span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a><span class="sd">        Returns:</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a><span class="sd">            Order: Fully populated Order object with all fields from dictionary.</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a><span class="sd">        </span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a><span class="sd">        Example:</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a><span class="sd">            ```python</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a><span class="sd">            data = {</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a><span class="sd">                &quot;product&quot;: &quot;electronics&quot;,</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a><span class="sd">                &quot;quantity&quot;: 50,</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a><span class="sd">                &quot;orderid&quot;: 1001000000,</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a><span class="sd">                &quot;sender&quot;: &quot;warehouse1@localhost&quot;,</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a><span class="sd">                &quot;receiver&quot;: &quot;store1@localhost&quot;,</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a><span class="sd">                &quot;sender_location&quot;: 10,</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a><span class="sd">                &quot;receiver_location&quot;: 5</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a><span class="sd">            }</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a><span class="sd">            order = store.dict_to_order(data)</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a><span class="sd">            # order.product == &quot;electronics&quot;, order.quantity == 50, etc.</span>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a><span class="sd">            ```</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a><span class="sd">        </span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a><span class="sd">        Note:</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a><span class="sd">            Uses dict.get() for optional location fields to handle cases where</span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a><span class="sd">            location information is not provided (returns None by default).</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>        <span class="n">order</span> <span class="o">=</span>  <span class="n">Order</span><span class="p">(</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a>            <span class="n">product</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">],</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>            <span class="n">orderid</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">],</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a>            <span class="n">sender</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;sender&quot;</span><span class="p">],</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>            <span class="n">receiver</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;receiver&quot;</span><span class="p">]</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>        <span class="p">)</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sender_location&quot;</span><span class="p">)</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;receiver_location&quot;</span><span class="p">)</span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>        <span class="k">return</span> <span class="n">order</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>    
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">message_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a><span class="sd">        Convert a warehouse-accept message to an Order object.</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a><span class="sd">        </span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a><span class="sd">        This helper method transforms a SPADE message received during the FIPA Contract</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a><span class="sd">        Net Protocol into a structured Order object suitable for tracking and processing.</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a><span class="sd">        It extracts all relevant information from the message metadata and body.</span>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a><span class="sd">        </span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a><span class="sd">        The method is used after a warehouse is selected (during SendStoreConfirmation)</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a><span class="sd">        to create an Order object for tracking in pending_deliveries.</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a><span class="sd">        </span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a><span class="sd">        Args:</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a><span class="sd">            msg (Message): The warehouse-accept message containing order details.</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a><span class="sd">                Metadata includes: request_id, node_id (warehouse location)</span>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a><span class="sd">        </span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a><span class="sd">        Returns:</span>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a><span class="sd">            Order: Fully populated Order object with:</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a><span class="sd">                - product: Extracted from message body</span>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a><span class="sd">                - quantity: Extracted from message body</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a><span class="sd">                - orderid: From request_id metadata</span>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a><span class="sd">                - sender: Warehouse JID (message sender)</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a><span class="sd">                - receiver: Store JID (this store)</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a><span class="sd">                - sender_location: Warehouse node ID (from metadata)</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a><span class="sd">                - receiver_location: Store node ID (this store&#39;s location)</span>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a><span class="sd">        </span>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a><span class="sd">        Message Parsing:</span>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a><span class="sd">            Body:</span>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a><span class="sd">                - Split on space: parts[0] = quantity, parts[1] = product</span>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a><span class="sd">                - Example: &quot;50 electronics&quot; -&gt; quantity=50, product=&quot;electronics&quot;</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a><span class="sd">            </span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a><span class="sd">            Metadata:</span>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a><span class="sd">                - request_id: Used as orderid for correlation</span>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a><span class="sd">                - node_id: Warehouse&#39;s graph location</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a><span class="sd">                - sender: Warehouse&#39;s JID</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a><span class="sd">        </span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a><span class="sd">        Location Assignment:</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a><span class="sd">            - sender_location: Warehouse node (from message node_id)</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a><span class="sd">            - receiver_location: Store node (this store&#39;s node_id)</span>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a><span class="sd">            - Note: Reversed compared to dict_to_order perspective</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a><span class="sd">        </span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a><span class="sd">        Example:</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a><span class="sd">            ```python</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a><span class="sd">            # Warehouse-accept message</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a><span class="sd">            msg.body = &quot;50 electronics&quot;</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a><span class="sd">            msg.sender = &quot;warehouse2@localhost&quot;</span>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a><span class="sd">            msg.metadata[&quot;request_id&quot;] = &quot;1001000000&quot;</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a><span class="sd">            msg.metadata[&quot;node_id&quot;] = &quot;10&quot;</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a><span class="sd">            </span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a><span class="sd">            order = store.message_to_order(msg)</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a><span class="sd">            # order.product = &quot;electronics&quot;</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a><span class="sd">            # order.quantity = 50</span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a><span class="sd">            # order.orderid = 1001000000</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a><span class="sd">            # order.sender = &quot;warehouse2@localhost&quot;</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a><span class="sd">            # order.receiver = &quot;store1@localhost&quot;</span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a><span class="sd">            # order.sender_location = 10 (warehouse)</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a><span class="sd">            # order.receiver_location = 5 (store)</span>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a><span class="sd">            ```</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a><span class="sd">        </span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a><span class="sd">        Note:</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a><span class="sd">            The Order object is used for:</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a><span class="sd">            - Tracking in pending_deliveries dict (awaiting vehicle delivery)</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a><span class="sd">            - Recording timing information for statistics</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a><span class="sd">            - Providing vehicle with delivery instructions</span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a>        <span class="n">body</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a>        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>        
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a>        <span class="n">order_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>        <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>  <span class="c1"># Store JID</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>        <span class="n">receiver</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">)</span>  <span class="c1"># Warehouse JID</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>        <span class="n">store_location</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">))</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>        <span class="n">warehouse_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>        
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>            <span class="n">product</span><span class="o">=</span><span class="n">product</span><span class="p">,</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>            <span class="n">orderid</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>            <span class="n">sender</span><span class="o">=</span><span class="n">sender</span><span class="p">,</span>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>            <span class="n">receiver</span><span class="o">=</span><span class="n">receiver</span>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>        <span class="p">)</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a>        
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a>        <span class="c1"># Set locations</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span> <span class="o">=</span> <span class="n">store_location</span>  <span class="c1"># Store location</span>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span> <span class="o">=</span> <span class="n">warehouse_location</span>  <span class="c1"># Warehouse location</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>        
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>        <span class="k">return</span> <span class="n">order</span>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a>    
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_buy_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a><span class="sd">        Set standard metadata for purchase request messages (FIPA CFP).</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a><span class="sd">        </span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a><span class="sd">        This helper method populates common metadata fields for store-buy messages,</span>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a><span class="sd">        ensuring consistency across all purchase requests. It sets the performative</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a><span class="sd">        and store identifier, with the caller responsible for setting the request_id.</span>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a><span class="sd">        </span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a><span class="sd">        FIPA Protocol:</span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a><span class="sd">            This prepares the message for the Call for Proposals (CFP) phase of the</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a><span class="sd">            FIPA Contract Net Protocol.</span>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a><span class="sd">        </span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a><span class="sd">        Args:</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a><span class="sd">            msg (Message): The message to populate with metadata. Modified in-place.</span>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a><span class="sd">        </span>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a><span class="sd">            Modifies msg metadata:</span>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a><span class="sd">                - performative: Set to &quot;store-buy&quot; (FIPA CFP)</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a><span class="sd">                - store_id: Set to this store&#39;s JID</span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a><span class="sd">        </span>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a><span class="sd">        Note:</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a><span class="sd">            The request_id must be set separately by the caller to ensure unique</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a><span class="sd">            identification for each purchase request. This separation allows for</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a><span class="sd">            proper ID encoding and avoids duplication.</span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a><span class="sd">        </span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a><span class="sd">        Example:</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a><span class="sd">            ```python</span>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a><span class="sd">            msg = Message(to=&quot;warehouse1@localhost&quot;)</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a><span class="sd">            store.set_buy_metadata(msg)</span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a><span class="sd">            msg.set_metadata(&quot;request_id&quot;, &quot;1001000000&quot;)  # Caller sets this</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a><span class="sd">            msg.body = &quot;50 electronics&quot;</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a><span class="sd">            # Message ready to send as FIPA CFP</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a><span class="sd">            ```</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-buy&quot;</span><span class="p">)</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a>        <span class="c1"># NOTE: request_id should be set separately by the caller</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a>    
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traffic_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a><span class="sd">        Apply dynamic traffic updates to the world graph.</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a><span class="sd">        </span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a><span class="sd">        This method processes transit messages from the world agent, updating edge</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a><span class="sd">        weights in the graph to reflect current traffic conditions. These updates</span>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a><span class="sd">        affect pathfinding calculations used in warehouse selection, making the</span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a><span class="sd">        system responsive to real-time network conditions.</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a><span class="sd">        </span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a><span class="sd">        Traffic Data Format:</span>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a><span class="sd">            ```json</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a><span class="sd">            {</span>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a><span class="sd">                &quot;edges&quot;: [</span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a><span class="sd">                    {</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a><span class="sd">                        &quot;node1&quot;: 5,</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a><span class="sd">                        &quot;node2&quot;: 10,</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a><span class="sd">                        &quot;weight&quot;: 200,</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a><span class="sd">                        &quot;fuel_consumption&quot;: 15.0</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a><span class="sd">                    },</span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a><span class="sd">                    ...</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a><span class="sd">                ]</span>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a><span class="sd">            }</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a><span class="sd">            ```</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a><span class="sd">        </span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a><span class="sd">        Args:</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a><span class="sd">            traffic_data (dict): Dictionary containing edge updates with key &quot;edges&quot;</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a><span class="sd">                mapping to a list of edge information dictionaries.</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a><span class="sd">        </span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a><span class="sd">        Edge Processing:</span>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a><span class="sd">            For each edge in traffic_data[&quot;edges&quot;]:</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a><span class="sd">                - Extract: node1, node2, new_weight</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a><span class="sd">                - Lookup: Find edge in graph using get_edge(node1, node2)</span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a><span class="sd">                - Update: Set edge.weight = new_weight if edge exists</span>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a><span class="sd">                - Skip: If edge not found (graceful handling)</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a><span class="sd">        </span>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a><span class="sd">            - Modifies edge weights in self.map (world graph)</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a><span class="sd">            - Affects future Dijkstra calculations</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a><span class="sd">            - Changes warehouse scoring results</span>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a><span class="sd">            - Does NOT modify fuel_consumption (current implementation)</span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a><span class="sd">        </span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a><span class="sd">        Example:</span>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a><span class="sd">            ```python</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a><span class="sd">            traffic_data = {</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a><span class="sd">                &quot;edges&quot;: [</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a><span class="sd">                    {&quot;node1&quot;: 5, &quot;node2&quot;: 10, &quot;weight&quot;: 200, &quot;fuel_consumption&quot;: 15.0},</span>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a><span class="sd">                    {&quot;node1&quot;: 10, &quot;node2&quot;: 15, &quot;weight&quot;: 150, &quot;fuel_consumption&quot;: 12.0}</span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a><span class="sd">                ]</span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a><span class="sd">            }</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a><span class="sd">            store.update_graph(traffic_data)</span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a><span class="sd">            # Edge (5, 10) weight updated to 200</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a><span class="sd">            # Edge (10, 15) weight updated to 150</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a><span class="sd">            # Future pathfinding uses new weights</span>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a><span class="sd">            ```</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a><span class="sd">        </span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a><span class="sd">        Note:</span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a><span class="sd">            Currently only updates weight, not fuel_consumption. Future enhancement</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a><span class="sd">            could update fuel_consumption as well for more realistic simulation:</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a><span class="sd">            ```python</span>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a><span class="sd">            if edge:</span>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a><span class="sd">                edge.weight = new_weight</span>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a><span class="sd">                edge.fuel_consumption = new_fuel  # Not currently implemented</span>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a><span class="sd">            ```</span>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a><span class="sd">        </span>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a><span class="sd">        Impact on System:</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a><span class="sd">            - Dynamic responsiveness to traffic conditions</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a><span class="sd">            - Warehouses with congested routes become less attractive</span>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a><span class="sd">            - Enables simulation of rush hours, accidents, road closures</span>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a><span class="sd">            - Realistic supply chain behavior under varying conditions</span>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a>        <span class="k">for</span> <span class="n">edge_info</span> <span class="ow">in</span> <span class="n">traffic_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a>                <span class="n">node1_id</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node1&quot;</span><span class="p">)</span>
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a>                <span class="n">node2_id</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node2&quot;</span><span class="p">)</span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a>                <span class="n">new_weight</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a>                
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a>                <span class="n">edge</span> <span class="p">:</span> <span class="n">Edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">node1_id</span><span class="p">,</span> <span class="n">node2_id</span><span class="p">)</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a>                <span class="k">if</span> <span class="n">edge</span><span class="p">:</span>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a>                    <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">new_weight</span>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a>    
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span> <span class="p">:</span> <span class="n">Order</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a><span class="sd">        Record order statistics to CSV file for post-simulation analysis.</span>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a><span class="sd">        </span>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a><span class="sd">        This method captures comprehensive metrics about each order, including timing,</span>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a><span class="sd">        participants, and outcome. Statistics are appended to a CSV file for later</span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a><span class="sd">        analysis of supply chain performance, bottlenecks, and optimization opportunities.</span>
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a><span class="sd">        </span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a><span class="sd">        Args:</span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a><span class="sd">            order (Order): The order object containing product, quantity, and IDs.</span>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a><span class="sd">            eta (int): Estimated time of arrival or delivery time in simulation ticks.</span>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a><span class="sd">            state (str): Final state of the order. Possible values:</span>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a><span class="sd">                - &quot;delivered&quot;: Successfully completed</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a><span class="sd">                - &quot;pending&quot;: Awaiting delivery</span>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a><span class="sd">                - &quot;failed&quot;: Order failed (not currently used)</span>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a><span class="sd">            vehicle (str): JID of the vehicle that handled the delivery.</span>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a><span class="sd">        </span>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a><span class="sd">        Statistics Captured:</span>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a><span class="sd">            - order_id: Unique request identifier</span>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a><span class="sd">            - store_jid: This store&#39;s identifier (without @domain)</span>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a><span class="sd">            - vehicle_jid: Delivering vehicle&#39;s identifier (without @domain)</span>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a><span class="sd">            - origin_warehouse: Warehouse that fulfilled order (without @domain)</span>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a><span class="sd">            - product: Product name</span>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a><span class="sd">            - quantity: Amount ordered/delivered</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a><span class="sd">            - ETA: Estimated time of arrival from vehicle</span>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a><span class="sd">            - time_to_delivery: Total ticks from confirmation to delivery</span>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a><span class="sd">            - current_tick: Simulation time when stats recorded</span>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a><span class="sd">            - final_state: Outcome indicator (delivered/pending/failed)</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a><span class="sd">        </span>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a><span class="sd">        CSV File Format:</span>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a><span class="sd">            - Location: stats/store_stats.csv</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a><span class="sd">            - Encoding: UTF-8</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a><span class="sd">            - Headers: Written automatically on first write</span>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a><span class="sd">            - Mode: Append (preserves previous records)</span>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a><span class="sd">        </span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a><span class="sd">        Time-to-Delivery Calculation:</span>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a><span class="sd">            ```python</span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a><span class="sd">            time_to_delivery = current_tick - order_timings[orderid]</span>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a><span class="sd">            # order_timings[orderid] set during SendStoreConfirmation</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a><span class="sd">            # Measures: Confirmation -&gt; Delivery complete</span>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a><span class="sd">            ```</span>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a><span class="sd">        </span>
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a><span class="sd">            - Creates stats/ directory if it doesn&#39;t exist</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a><span class="sd">            - Creates or appends to store_stats.csv</span>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a><span class="sd">            - Prints confirmation if verbose mode enabled</span>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a><span class="sd">            - Prints error if file operation fails</span>
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a><span class="sd">        </span>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a><span class="sd">        Error Handling:</span>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a><span class="sd">            - Wraps file operations in try-except</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a><span class="sd">            - Catches all exceptions (broad handling for robustness)</span>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a><span class="sd">            - Prints error message with exception details</span>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a><span class="sd">            - Does not crash agent on statistics failure</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a><span class="sd">        </span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a><span class="sd">        Example CSV Output:</span>
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a><span class="sd">            ```csv</span>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a><span class="sd">            order_id,store_jid,vehicle_jid,origin_warehouse,product,quantity,ETA,time_to_delivery,current_tick,final_state</span>
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a><span class="sd">            1001000000,store1,vehicle1,warehouse2,electronics,50,120,125,345,delivered</span>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a><span class="sd">            1001000001,store1,vehicle2,warehouse1,food,30,80,85,430,delivered</span>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a><span class="sd">            ```</span>
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a><span class="sd">        </span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a><span class="sd">        Performance Metrics Enabled:</span>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a><span class="sd">            - Average delivery time per product</span>
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a><span class="sd">            - Warehouse performance comparison</span>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a><span class="sd">            - Vehicle efficiency analysis</span>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a><span class="sd">            - Bottleneck identification</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a><span class="sd">            - Demand pattern analysis</span>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a><span class="sd">        </span>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a><span class="sd">        Example Usage:</span>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a><span class="sd">            ```python</span>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a><span class="sd">            # Called from ReceiveVehicleArrival after delivery</span>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a><span class="sd">            order = pending_deliveries[orderid]</span>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a><span class="sd">            eta = 120  # From vehicle message</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a><span class="sd">            store.get_stats(order, eta, &quot;delivered&quot;, msg.sender)</span>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a><span class="sd">            # CSV row appended with all order metrics</span>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a><span class="sd">            ```</span>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a><span class="sd">        </span>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a><span class="sd">        Note:</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a><span class="sd">            Statistics are append-only. For new simulation runs, manually delete or</span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a><span class="sd">            rename the CSV file to avoid mixing data from different experiments.</span>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a>        <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a>        
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a>        <span class="n">order_stats</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a>            <span class="s2">&quot;order_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a>            <span class="s2">&quot;store_jid&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a>            <span class="s2">&quot;vehicle_jid&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a>            <span class="s2">&quot;origin_warehouse&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a>            <span class="s2">&quot;product&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="p">,</span>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a>            <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a>            <span class="s2">&quot;ETA&quot;</span><span class="p">:</span> <span class="n">eta</span> <span class="k">if</span> <span class="n">eta</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a>            <span class="s2">&quot;time_to_delivery&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_timings</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">],</span>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a>            <span class="s2">&quot;current_tick&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_tick</span><span class="p">,</span>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a>            <span class="s2">&quot;final_state&quot;</span><span class="p">:</span> <span class="n">state</span>  <span class="c1"># pending, delivered, failed</span>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a>        <span class="p">}</span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a>        
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a>        <span class="c1"># Build full file path</span>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a>        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_filename</span><span class="p">)</span>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a>        
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a>        <span class="c1"># Check if file exists to determine if we need to write headers</span>
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a>        <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a>        
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a>        <span class="c1"># Write to CSV</span>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a>            <span class="c1"># Create directory if it doesn&#39;t exist</span>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a>            
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">:</span> <span class="n">open_mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a>            <span class="k">else</span><span class="p">:</span> <span class="n">open_mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a>            
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">open_mode</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a>                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">order_stats</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a>                
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a>                <span class="c1"># Write header only if file is new</span>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">:</span>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a>                    <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a>                
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a>                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_stats</span><span class="p">)</span>
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a>            
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Stats saved to </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2"> for order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR saving stats: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a>    
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_stock</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a><span class="sd">        Print the current stock inventory to console.</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a><span class="sd">        </span>
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a><span class="sd">        This helper method provides a human-readable display of the store&#39;s current</span>
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a><span class="sd">        inventory, showing all products and their quantities. Used after deliveries</span>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a><span class="sd">        to provide visibility into stock levels.</span>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a><span class="sd">        </span>
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a><span class="sd">        Output Format:</span>
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a><span class="sd">            If stock is empty:</span>
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a><span class="sd">                &quot;{jid}&gt; Stock is empty&quot;</span>
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a><span class="sd">            </span>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a><span class="sd">            If stock has items:</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a><span class="sd">                &quot;{jid}&gt; Current stock:&quot;</span>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a><span class="sd">                &quot;  - product1: quantity1 units&quot;</span>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a><span class="sd">                &quot;  - product2: quantity2 units&quot;</span>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a><span class="sd">                ...</span>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a><span class="sd">        </span>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a><span class="sd">            - Prints to standard output (console)</span>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a><span class="sd">            - Always visible (not affected by verbose setting)</span>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a><span class="sd">        </span>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a><span class="sd">        Example Output:</span>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a><span class="sd">            ```</span>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a><span class="sd">            store1@localhost&gt; Current stock:</span>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a><span class="sd">              - electronics: 250 units</span>
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a><span class="sd">              - food: 100 units</span>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a><span class="sd">              - clothing: 75 units</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a><span class="sd">            ```</span>
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a><span class="sd">        </span>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a><span class="sd">        Note:</span>
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a><span class="sd">            This method is called after every successful delivery to provide</span>
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a><span class="sd">            immediate feedback about inventory changes.</span>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Stock is empty&quot;</span><span class="p">)</span>
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Current stock:&quot;</span><span class="p">)</span>
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a>            <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units&quot;</span><span class="p">)</span>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a>    
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="nb">map</span> <span class="p">:</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">node_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">5222</span><span class="p">,</span> <span class="n">verify_security</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">contact_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a><span class="sd">        Initialize the Store agent with configuration and state.</span>
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a><span class="sd">        </span>
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a><span class="sd">        This constructor sets up the store agent with all necessary parameters for</span>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a><span class="sd">        operation, including network configuration, graph reference, ID encoding,</span>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a><span class="sd">        and statistics tracking. It prepares the agent for FIPA Contract Net Protocol</span>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a><span class="sd">        negotiations and supply chain operations.</span>
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a><span class="sd">        </span>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a><span class="sd">        Args:</span>
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a><span class="sd">            jid (str): Jabber ID for the store agent (e.g., &quot;store1@localhost&quot;).</span>
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a><span class="sd">                Must be unique within the XMPP server.</span>
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a><span class="sd">            password (str): Authentication password for XMPP server connection.</span>
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a><span class="sd">            map (Graph): Reference to the world graph for pathfinding and distance</span>
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a><span class="sd">                calculations. Shared across all agents in the simulation.</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a><span class="sd">            node_id (int): Graph node ID representing the store&#39;s physical location.</span>
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a><span class="sd">                Used in pathfinding and warehouse scoring.</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a><span class="sd">            port (int, optional): XMPP server port. Defaults to 5222 (standard XMPP).</span>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a><span class="sd">            verify_security (bool, optional): Whether to verify SSL/TLS certificates.</span>
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a><span class="sd">                Defaults to False for local development. Set True for production.</span>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a><span class="sd">            contact_list (list[str], optional): List of warehouse JIDs to subscribe to.</span>
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a><span class="sd">                Store will send purchase requests to these warehouses.</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a><span class="sd">                Defaults to empty list.</span>
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a><span class="sd">            verbose (bool, optional): Enable detailed debug logging.</span>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a><span class="sd">                True: Print all debug information</span>
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a><span class="sd">                False: Print only essential messages</span>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a><span class="sd">                Defaults to False.</span>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a><span class="sd">        </span>
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a><span class="sd">        ID Encoding System:</span>
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a><span class="sd">            Generates unique request IDs using hierarchical encoding:</span>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a><span class="sd">            - Formula: `(agent_type * 100_000_000) + (instance_id * 1_000_000) + counter`</span>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a><span class="sd">            - Store type code: 1</span>
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a><span class="sd">            - Instance ID: Extracted from JID (e.g., &quot;store1&quot; -&gt; 1, &quot;store42&quot; -&gt; 42)</span>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a><span class="sd">            - Example: store1&#39;s first request = 1_001_000_000</span>
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a><span class="sd">            - Example: store1&#39;s second request = 1_001_000_001</span>
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a><span class="sd">            - Ensures global uniqueness across all agents and requests</span>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a><span class="sd">        </span>
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a><span class="sd">        Configuration Loading:</span>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a><span class="sd">            Imports from config module:</span>
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a><span class="sd">            - PRODUCTS: List of available products for purchase</span>
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a><span class="sd">            - STORE_BUY_PROBABILITY: Probability (0-1) of purchase attempt per period</span>
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a><span class="sd">            - STORE_MAX_BUY_QUANTITY: Maximum quantity per purchase order</span>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a><span class="sd">        </span>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a><span class="sd">        State Initialization:</span>
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a><span class="sd">            - pending_deliveries: Empty dict for tracking orders awaiting delivery</span>
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a><span class="sd">            - order_timings: Empty dict for recording confirmation timestamps</span>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a><span class="sd">            - current_tick: 0 (synchronized by world agent during runtime)</span>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a><span class="sd">            - stock: Initialized in setup() as empty dict</span>
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a><span class="sd">            - failed_requests: Initialized in setup() as empty queue</span>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a><span class="sd">            - request_counter: Initialized in setup() as 0</span>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a><span class="sd">        </span>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a><span class="sd">        Statistics Configuration:</span>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a><span class="sd">            - stats_path: &quot;stats/&quot; directory (created automatically if needed)</span>
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a><span class="sd">            - stats_filename: &quot;store_stats.csv&quot; (append mode)</span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a><span class="sd">        </span>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a><span class="sd">        Example:</span>
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a><span class="sd">            ```python</span>
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a><span class="sd">            from world.graph import Graph</span>
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a><span class="sd">            </span>
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a><span class="sd">            map_graph = Graph()</span>
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a><span class="sd">            # ... add nodes and edges to graph ...</span>
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a><span class="sd">            </span>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a><span class="sd">            store = Store(</span>
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a><span class="sd">                jid=&quot;store1@localhost&quot;,</span>
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a><span class="sd">                password=&quot;secure_password&quot;,</span>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a><span class="sd">                map=map_graph,</span>
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a><span class="sd">                node_id=5,</span>
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a><span class="sd">                port=5222,</span>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a><span class="sd">                verify_security=False,</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a><span class="sd">                contact_list=[&quot;warehouse1@localhost&quot;, &quot;warehouse2@localhost&quot;],</span>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a><span class="sd">                verbose=True</span>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a><span class="sd">            )</span>
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a><span class="sd">            </span>
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a><span class="sd">            # store.id_base = 1_001_000_000</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a><span class="sd">            # Ready to start and begin purchasing</span>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a><span class="sd">            await store.start()</span>
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a><span class="sd">            ```</span>
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a><span class="sd">        </span>
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a><span class="sd">        Note:</span>
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a><span class="sd">            The agent is not fully operational until setup() is called (automatically</span>
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a><span class="sd">            by SPADE when start() is invoked). The setup() method initializes</span>
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a><span class="sd">            behaviours and subscribes to contacts.</span>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">verify_security</span><span class="p">)</span>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node_id</span>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="p">:</span> <span class="n">Graph</span> <span class="o">=</span> <span class="nb">map</span>
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contact_list</span> <span class="o">=</span> <span class="n">contact_list</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a>        
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a>        <span class="c1"># Extract instance number from JID for ID encoding (e.g., &quot;store1@localhost&quot; -&gt; 1)</span>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a>        <span class="n">jid_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a>        <span class="n">instance_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">,</span> <span class="n">jid_name</span><span class="p">)))</span>
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a>        
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a>        <span class="c1"># Calculate ID base: Store type code = 1</span>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id_base</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">100_000_000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">instance_id</span> <span class="o">*</span> <span class="mi">1_000_000</span><span class="p">)</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a>        
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pending_deliveries</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># key: request_id, value: Order object</span>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">order_timings</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{}</span>  <span class="c1"># key: request_id, value: ticks at confirmation</span>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_tick</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stats_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;stats&quot;</span><span class="p">)</span>
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stats_filename</span> <span class="o">=</span> <span class="s2">&quot;store_stats.csv&quot;</span>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a>        
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a>        <span class="c1"># Constants from config</span>
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">product_list</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">PRODUCTS</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buy_prob</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">STORE_BUY_PROBABILITY</span>
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_buy_quantity</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">STORE_MAX_BUY_QUANTITY</span>
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a>        
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a><span class="sd">        Setup method called automatically by SPADE when agent starts.</span>
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a><span class="sd">        </span>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a><span class="sd">        This method initializes the agent&#39;s operational state and registers all</span>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a><span class="sd">        behaviours with appropriate message templates. It completes the agent</span>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a><span class="sd">        initialization process started in __init__, preparing the store for</span>
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a><span class="sd">        active participation in the supply chain simulation.</span>
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a><span class="sd">        </span>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a><span class="sd">        Initialization Steps:</span>
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a><span class="sd">            1. Configure presence management (auto-approve subscriptions)</span>
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a><span class="sd">            2. Subscribe to all warehouses in contact list</span>
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a><span class="sd">            3. Initialize runtime state variables (stock, counters, queues)</span>
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a><span class="sd">            4. Register BuyProduct behaviour (periodic purchasing)</span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a><span class="sd">            5. Register ReceiveTimeDelta behaviour (time synchronization)</span>
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a><span class="sd">            6. Register RetryPreviousBuy behaviour (failed request retry)</span>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a><span class="sd">            7. Register ReceiveVehicleArrival behaviour (delivery reception)</span>
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a><span class="sd">        </span>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a><span class="sd">        Presence Configuration:</span>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a><span class="sd">            - presence.approve_all = True: Auto-accept all subscription requests</span>
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a><span class="sd">            - Subscribes to each warehouse in contact_list</span>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a><span class="sd">            - Enables bidirectional communication with warehouses</span>
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a><span class="sd">        </span>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a><span class="sd">        State Initialization:</span>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a><span class="sd">            - stock: Empty dict (populated by deliveries)</span>
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a><span class="sd">            - current_buy_request: None (set during purchase attempts)</span>
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a><span class="sd">            - failed_requests: Empty FIFO queue (populated by failed negotiations)</span>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a><span class="sd">            - request_counter: 0 (incremented for each purchase request)</span>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a><span class="sd">        </span>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a><span class="sd">        Behaviour Registration:</span>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a><span class="sd">        </span>
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a><span class="sd">            1. **BuyProduct** (PeriodicBehaviour):</span>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a><span class="sd">                - No template filter (self-triggered by period)</span>
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a><span class="sd">                - Period: config.STORE_BUY_FREQUENCY seconds</span>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a><span class="sd">                - Purpose: Initiate FIPA Contract Net Protocol for purchases</span>
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a><span class="sd">            </span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a><span class="sd">            2. **ReceiveTimeDelta** (CyclicBehaviour):</span>
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a><span class="sd">                - Template: performative=&quot;inform&quot;</span>
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a><span class="sd">                - Purpose: Receive time updates and traffic data from world agent</span>
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a><span class="sd">                - Continuous operation</span>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a><span class="sd">            </span>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a><span class="sd">            3. **RetryPreviousBuy** (PeriodicBehaviour):</span>
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a><span class="sd">                - No template filter (self-triggered)</span>
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a><span class="sd">                - Period: 5 seconds</span>
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a><span class="sd">                - Purpose: Retry failed purchase requests</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a><span class="sd">            </span>
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a><span class="sd">            4. **ReceiveVehicleArrival** (CyclicBehaviour):</span>
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a><span class="sd">                - Template: performative=&quot;vehicle-delivery&quot;</span>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a><span class="sd">                - Purpose: Receive delivery notifications and update stock</span>
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a><span class="sd">                - Continuous operation</span>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a><span class="sd">        </span>
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a><span class="sd">        Template Filtering:</span>
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a><span class="sd">            Templates ensure behaviours only receive relevant messages:</span>
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a><span class="sd">            - ReceiveTimeDelta: Only &quot;inform&quot; messages (from world agent)</span>
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a><span class="sd">            - ReceiveVehicleArrival: Only &quot;vehicle-delivery&quot; messages (from vehicles)</span>
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a><span class="sd">            - BuyProduct/RetryPreviousBuy: No template (time-triggered, not message-triggered)</span>
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a><span class="sd">        </span>
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a><span class="sd">            - Sends presence subscription requests to all warehouses</span>
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a><span class="sd">            - Adds four behaviours to agent&#39;s behaviour queue</span>
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a><span class="sd">            - Prints subscription confirmations if verbose mode enabled</span>
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a><span class="sd">        </span>
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a><span class="sd">        Returns:</span>
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a><span class="sd">            None. Completes when all behaviours are registered and agent is operational.</span>
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a><span class="sd">        </span>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a><span class="sd">        Example Flow:</span>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a><span class="sd">            ```</span>
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a><span class="sd">            Agent Start:</span>
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a><span class="sd">                1. SPADE calls setup()</span>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a><span class="sd">                2. Subscribe to warehouse1, warehouse2</span>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a><span class="sd">                3. Initialize stock = {}</span>
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a><span class="sd">                4. Register BuyProduct (will start after 5s)</span>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a><span class="sd">                5. Register ReceiveTimeDelta (active immediately)</span>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a><span class="sd">                6. Register RetryPreviousBuy (checks every 5s)</span>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a><span class="sd">                7. Register ReceiveVehicleArrival (active immediately)</span>
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a><span class="sd">                8. Agent ready for operation</span>
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a><span class="sd">            ```</span>
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a><span class="sd">        </span>
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a><span class="sd">        Note:</span>
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a><span class="sd">            This method is asynchronous and is automatically called by SPADE&#39;s</span>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a><span class="sd">            agent lifecycle management. Do not call this method manually.</span>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">approve_all</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a>        <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_list</span><span class="p">:</span>
</span><span id="L-2340"><a href="#L-2340"><span class="linenos">2340</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
</span><span id="L-2341"><a href="#L-2341"><span class="linenos">2341</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2342"><a href="#L-2342"><span class="linenos">2342</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent subscription request to </span><span class="si">{</span><span class="n">contact</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2343"><a href="#L-2343"><span class="linenos">2343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stock</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-2344"><a href="#L-2344"><span class="linenos">2344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2345"><a href="#L-2345"><span class="linenos">2345</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failed_requests</span> <span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span><span id="L-2346"><a href="#L-2346"><span class="linenos">2346</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2347"><a href="#L-2347"><span class="linenos">2347</span></a>
</span><span id="L-2348"><a href="#L-2348"><span class="linenos">2348</span></a>        <span class="c1"># BuyProduct behaviour initialization</span>
</span><span id="L-2349"><a href="#L-2349"><span class="linenos">2349</span></a>        <span class="n">buy_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BuyProduct</span><span class="p">()</span>
</span><span id="L-2350"><a href="#L-2350"><span class="linenos">2350</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">buy_behav</span><span class="p">)</span>
</span><span id="L-2351"><a href="#L-2351"><span class="linenos">2351</span></a>
</span><span id="L-2352"><a href="#L-2352"><span class="linenos">2352</span></a>        <span class="c1"># Time delta behaviour</span>
</span><span id="L-2353"><a href="#L-2353"><span class="linenos">2353</span></a>        <span class="n">time_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveTimeDelta</span><span class="p">()</span>
</span><span id="L-2354"><a href="#L-2354"><span class="linenos">2354</span></a>        <span class="n">time_template</span> <span class="p">:</span> <span class="n">Template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="L-2355"><a href="#L-2355"><span class="linenos">2355</span></a>        <span class="n">time_template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="L-2356"><a href="#L-2356"><span class="linenos">2356</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">time_behav</span><span class="p">,</span> <span class="n">time_template</span><span class="p">)</span>
</span><span id="L-2357"><a href="#L-2357"><span class="linenos">2357</span></a>        
</span><span id="L-2358"><a href="#L-2358"><span class="linenos">2358</span></a>        <span class="c1"># Buy retrying is not bound by ticks</span>
</span><span id="L-2359"><a href="#L-2359"><span class="linenos">2359</span></a>        <span class="n">retry_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RetryPreviousBuy</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-2360"><a href="#L-2360"><span class="linenos">2360</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">retry_behav</span><span class="p">)</span>
</span><span id="L-2361"><a href="#L-2361"><span class="linenos">2361</span></a>        
</span><span id="L-2362"><a href="#L-2362"><span class="linenos">2362</span></a>        <span class="c1"># Vehicle arrival behaviour</span>
</span><span id="L-2363"><a href="#L-2363"><span class="linenos">2363</span></a>        <span class="n">vehicle_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveVehicleArrival</span><span class="p">()</span>
</span><span id="L-2364"><a href="#L-2364"><span class="linenos">2364</span></a>        <span class="n">delivery_temp</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="L-2365"><a href="#L-2365"><span class="linenos">2365</span></a>        <span class="n">delivery_temp</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">)</span>
</span><span id="L-2366"><a href="#L-2366"><span class="linenos">2366</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">vehicle_behav</span><span class="p">,</span> <span class="n">delivery_temp</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="Store">
                            <input id="Store-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Store</span><wbr>(<span class="base">spade.agent.Agent</span>):

                <label class="view-source-button" for="Store-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store-49"><a href="#Store-49"><span class="linenos">  49</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Store</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
</span><span id="Store-50"><a href="#Store-50"><span class="linenos">  50</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-51"><a href="#Store-51"><span class="linenos">  51</span></a><span class="sd">    Retail Store Agent for Supply Chain Management System.</span>
</span><span id="Store-52"><a href="#Store-52"><span class="linenos">  52</span></a><span class="sd">    </span>
</span><span id="Store-53"><a href="#Store-53"><span class="linenos">  53</span></a><span class="sd">    The Store agent represents a retail point in the supply chain network. It manages</span>
</span><span id="Store-54"><a href="#Store-54"><span class="linenos">  54</span></a><span class="sd">    inventory, purchases products from warehouses using a negotiation protocol, and</span>
</span><span id="Store-55"><a href="#Store-55"><span class="linenos">  55</span></a><span class="sd">    coordinates with vehicle agents for product delivery. The agent operates on a</span>
</span><span id="Store-56"><a href="#Store-56"><span class="linenos">  56</span></a><span class="sd">    graph-based world representation where each store has a specific node location.</span>
</span><span id="Store-57"><a href="#Store-57"><span class="linenos">  57</span></a><span class="sd">    </span>
</span><span id="Store-58"><a href="#Store-58"><span class="linenos">  58</span></a><span class="sd">    FIPA Contract Net Protocol Implementation:</span>
</span><span id="Store-59"><a href="#Store-59"><span class="linenos">  59</span></a><span class="sd">        This agent acts as the **Initiator** in the FIPA Contract Net Protocol:</span>
</span><span id="Store-60"><a href="#Store-60"><span class="linenos">  60</span></a><span class="sd">        </span>
</span><span id="Store-61"><a href="#Store-61"><span class="linenos">  61</span></a><span class="sd">        1. **Call for Proposals (CFP)**: Store broadcasts purchase requests to all warehouses</span>
</span><span id="Store-62"><a href="#Store-62"><span class="linenos">  62</span></a><span class="sd">           using the `store-buy` performative, which corresponds to the FIPA CFP message.</span>
</span><span id="Store-63"><a href="#Store-63"><span class="linenos">  63</span></a><span class="sd">           </span>
</span><span id="Store-64"><a href="#Store-64"><span class="linenos">  64</span></a><span class="sd">        2. **Proposal Reception**: Warehouses respond with either `warehouse-accept` (propose)</span>
</span><span id="Store-65"><a href="#Store-65"><span class="linenos">  65</span></a><span class="sd">           or `warehouse-reject` (refuse) performatives.</span>
</span><span id="Store-66"><a href="#Store-66"><span class="linenos">  66</span></a><span class="sd">           </span>
</span><span id="Store-67"><a href="#Store-67"><span class="linenos">  67</span></a><span class="sd">        3. **Proposal Evaluation**: Store evaluates all proposals using a distance-based</span>
</span><span id="Store-68"><a href="#Store-68"><span class="linenos">  68</span></a><span class="sd">           scoring function to select the optimal warehouse.</span>
</span><span id="Store-69"><a href="#Store-69"><span class="linenos">  69</span></a><span class="sd">           </span>
</span><span id="Store-70"><a href="#Store-70"><span class="linenos">  70</span></a><span class="sd">        4. **Award/Rejection**: Store sends `store-confirm` (accept-proposal) to the winner</span>
</span><span id="Store-71"><a href="#Store-71"><span class="linenos">  71</span></a><span class="sd">           and `store-deny` (reject-proposal) to non-selected participants.</span>
</span><span id="Store-72"><a href="#Store-72"><span class="linenos">  72</span></a><span class="sd">    </span>
</span><span id="Store-73"><a href="#Store-73"><span class="linenos">  73</span></a><span class="sd">    ID Encoding System:</span>
</span><span id="Store-74"><a href="#Store-74"><span class="linenos">  74</span></a><span class="sd">        The Store uses a hierarchical ID encoding for unique request identification:</span>
</span><span id="Store-75"><a href="#Store-75"><span class="linenos">  75</span></a><span class="sd">        - Formula: `agent_type * 100_000_000 + instance_id * 1_000_000 + request_counter`</span>
</span><span id="Store-76"><a href="#Store-76"><span class="linenos">  76</span></a><span class="sd">        - Agent type code for Store: 1</span>
</span><span id="Store-77"><a href="#Store-77"><span class="linenos">  77</span></a><span class="sd">        - Example: store1&#39;s first request = 1_001_000_000</span>
</span><span id="Store-78"><a href="#Store-78"><span class="linenos">  78</span></a><span class="sd">        - This ensures globally unique request IDs across the multi-agent system.</span>
</span><span id="Store-79"><a href="#Store-79"><span class="linenos">  79</span></a><span class="sd">    </span>
</span><span id="Store-80"><a href="#Store-80"><span class="linenos">  80</span></a><span class="sd">    Attributes:</span>
</span><span id="Store-81"><a href="#Store-81"><span class="linenos">  81</span></a><span class="sd">        jid (str): Jabber ID of the store agent (e.g., &quot;store1@localhost&quot;).</span>
</span><span id="Store-82"><a href="#Store-82"><span class="linenos">  82</span></a><span class="sd">        node_id (int): Graph node ID representing the store&#39;s physical location.</span>
</span><span id="Store-83"><a href="#Store-83"><span class="linenos">  83</span></a><span class="sd">        map (Graph): Reference to the world graph for pathfinding and distance calculations.</span>
</span><span id="Store-84"><a href="#Store-84"><span class="linenos">  84</span></a><span class="sd">        contact_list (list[str]): List of warehouse JIDs for subscription and communication.</span>
</span><span id="Store-85"><a href="#Store-85"><span class="linenos">  85</span></a><span class="sd">        verbose (bool): Flag to control debug output verbosity. When True, detailed logs</span>
</span><span id="Store-86"><a href="#Store-86"><span class="linenos">  86</span></a><span class="sd">            are printed; when False, only essential information is shown.</span>
</span><span id="Store-87"><a href="#Store-87"><span class="linenos">  87</span></a><span class="sd">        id_base (int): Base value for generating unique request IDs using encoding formula.</span>
</span><span id="Store-88"><a href="#Store-88"><span class="linenos">  88</span></a><span class="sd">            Computed as `(1 * 100_000_000) + (instance_id * 1_000_000)`.</span>
</span><span id="Store-89"><a href="#Store-89"><span class="linenos">  89</span></a><span class="sd">        stock (dict[str, int]): Current inventory mapping product names to quantities.</span>
</span><span id="Store-90"><a href="#Store-90"><span class="linenos">  90</span></a><span class="sd">        request_counter (int): Monotonic counter for generating unique request IDs.</span>
</span><span id="Store-91"><a href="#Store-91"><span class="linenos">  91</span></a><span class="sd">            Incremented with each purchase request.</span>
</span><span id="Store-92"><a href="#Store-92"><span class="linenos">  92</span></a><span class="sd">        current_buy_request (Message): Reference to the most recent buy request message.</span>
</span><span id="Store-93"><a href="#Store-93"><span class="linenos">  93</span></a><span class="sd">        failed_requests (queue.Queue): FIFO queue holding failed purchase requests for retry.</span>
</span><span id="Store-94"><a href="#Store-94"><span class="linenos">  94</span></a><span class="sd">            Requests are enqueued when no warehouse accepts the order.</span>
</span><span id="Store-95"><a href="#Store-95"><span class="linenos">  95</span></a><span class="sd">        pending_deliveries (dict[int, Order]): Orders awaiting vehicle delivery, keyed by order ID.</span>
</span><span id="Store-96"><a href="#Store-96"><span class="linenos">  96</span></a><span class="sd">        order_timings (dict[int, int]): Tick timestamps when orders were confirmed, used for</span>
</span><span id="Store-97"><a href="#Store-97"><span class="linenos">  97</span></a><span class="sd">            calculating time-to-delivery statistics.</span>
</span><span id="Store-98"><a href="#Store-98"><span class="linenos">  98</span></a><span class="sd">        current_tick (int): Current simulation time tick, updated by world agent.</span>
</span><span id="Store-99"><a href="#Store-99"><span class="linenos">  99</span></a><span class="sd">        product_list (list[str]): Available products for purchase (from config.PRODUCTS).</span>
</span><span id="Store-100"><a href="#Store-100"><span class="linenos"> 100</span></a><span class="sd">        buy_prob (float): Probability (0-1) of initiating a purchase each period</span>
</span><span id="Store-101"><a href="#Store-101"><span class="linenos"> 101</span></a><span class="sd">            (from config.STORE_BUY_PROBABILITY).</span>
</span><span id="Store-102"><a href="#Store-102"><span class="linenos"> 102</span></a><span class="sd">        max_buy_quantity (int): Maximum quantity that can be purchased in a single order</span>
</span><span id="Store-103"><a href="#Store-103"><span class="linenos"> 103</span></a><span class="sd">            (from config.STORE_MAX_BUY_QUANTITY).</span>
</span><span id="Store-104"><a href="#Store-104"><span class="linenos"> 104</span></a><span class="sd">        stats_path (str): Directory path for statistics CSV files.</span>
</span><span id="Store-105"><a href="#Store-105"><span class="linenos"> 105</span></a><span class="sd">        stats_filename (str): Filename for order statistics CSV (&quot;store_stats.csv&quot;).</span>
</span><span id="Store-106"><a href="#Store-106"><span class="linenos"> 106</span></a><span class="sd">    </span>
</span><span id="Store-107"><a href="#Store-107"><span class="linenos"> 107</span></a><span class="sd">    Behaviours:</span>
</span><span id="Store-108"><a href="#Store-108"><span class="linenos"> 108</span></a><span class="sd">        BuyProduct: Periodic behaviour that initiates purchase requests based on probability.</span>
</span><span id="Store-109"><a href="#Store-109"><span class="linenos"> 109</span></a><span class="sd">        CollectWarehouseResponses: Coordinator for FIPA Contract Net Protocol implementation.</span>
</span><span id="Store-110"><a href="#Store-110"><span class="linenos"> 110</span></a><span class="sd">        ReceiveAllResponses: Worker behaviour that collects all warehouse responses.</span>
</span><span id="Store-111"><a href="#Store-111"><span class="linenos"> 111</span></a><span class="sd">        SendStoreConfirmation: Sends confirmation to selected warehouse (FIPA accept-proposal).</span>
</span><span id="Store-112"><a href="#Store-112"><span class="linenos"> 112</span></a><span class="sd">        SendStoreDenial: Sends rejection to non-selected warehouses (FIPA reject-proposal).</span>
</span><span id="Store-113"><a href="#Store-113"><span class="linenos"> 113</span></a><span class="sd">        RetryPreviousBuy: Periodic behaviour that retries failed purchase requests.</span>
</span><span id="Store-114"><a href="#Store-114"><span class="linenos"> 114</span></a><span class="sd">        ReceiveTimeDelta: Cyclic behaviour that processes simulation time updates and traffic data.</span>
</span><span id="Store-115"><a href="#Store-115"><span class="linenos"> 115</span></a><span class="sd">        ReceiveVehicleArrival: Cyclic behaviour that handles vehicle delivery notifications.</span>
</span><span id="Store-116"><a href="#Store-116"><span class="linenos"> 116</span></a><span class="sd">    </span>
</span><span id="Store-117"><a href="#Store-117"><span class="linenos"> 117</span></a><span class="sd">    Message Protocols:</span>
</span><span id="Store-118"><a href="#Store-118"><span class="linenos"> 118</span></a><span class="sd">        Outgoing Messages:</span>
</span><span id="Store-119"><a href="#Store-119"><span class="linenos"> 119</span></a><span class="sd">            - `store-buy`: Purchase request to warehouses (FIPA CFP).</span>
</span><span id="Store-120"><a href="#Store-120"><span class="linenos"> 120</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-121"><a href="#Store-121"><span class="linenos"> 121</span></a><span class="sd">                Metadata: store_id, node_id, request_id</span>
</span><span id="Store-122"><a href="#Store-122"><span class="linenos"> 122</span></a><span class="sd">                </span>
</span><span id="Store-123"><a href="#Store-123"><span class="linenos"> 123</span></a><span class="sd">            - `store-confirm`: Confirmation to selected warehouse (FIPA accept-proposal).</span>
</span><span id="Store-124"><a href="#Store-124"><span class="linenos"> 124</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-125"><a href="#Store-125"><span class="linenos"> 125</span></a><span class="sd">                Metadata: warehouse_id, store_id, node_id, request_id</span>
</span><span id="Store-126"><a href="#Store-126"><span class="linenos"> 126</span></a><span class="sd">                </span>
</span><span id="Store-127"><a href="#Store-127"><span class="linenos"> 127</span></a><span class="sd">            - `store-deny`: Rejection to non-selected warehouses (FIPA reject-proposal).</span>
</span><span id="Store-128"><a href="#Store-128"><span class="linenos"> 128</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-129"><a href="#Store-129"><span class="linenos"> 129</span></a><span class="sd">                Metadata: warehouse_id, store_id, node_id, request_id</span>
</span><span id="Store-130"><a href="#Store-130"><span class="linenos"> 130</span></a><span class="sd">        </span>
</span><span id="Store-131"><a href="#Store-131"><span class="linenos"> 131</span></a><span class="sd">        Incoming Messages:</span>
</span><span id="Store-132"><a href="#Store-132"><span class="linenos"> 132</span></a><span class="sd">            - `warehouse-accept`: Warehouse accepts order (FIPA propose).</span>
</span><span id="Store-133"><a href="#Store-133"><span class="linenos"> 133</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-134"><a href="#Store-134"><span class="linenos"> 134</span></a><span class="sd">                </span>
</span><span id="Store-135"><a href="#Store-135"><span class="linenos"> 135</span></a><span class="sd">            - `warehouse-reject`: Warehouse rejects order (FIPA refuse).</span>
</span><span id="Store-136"><a href="#Store-136"><span class="linenos"> 136</span></a><span class="sd">                Body format: &quot;{quantity} {product} {reason}&quot;</span>
</span><span id="Store-137"><a href="#Store-137"><span class="linenos"> 137</span></a><span class="sd">                </span>
</span><span id="Store-138"><a href="#Store-138"><span class="linenos"> 138</span></a><span class="sd">            - `vehicle-delivery`: Vehicle delivers products.</span>
</span><span id="Store-139"><a href="#Store-139"><span class="linenos"> 139</span></a><span class="sd">                Body format: JSON with orderid, time (ETA)</span>
</span><span id="Store-140"><a href="#Store-140"><span class="linenos"> 140</span></a><span class="sd">                </span>
</span><span id="Store-141"><a href="#Store-141"><span class="linenos"> 141</span></a><span class="sd">            - `inform`: Time delta and traffic updates from world agent.</span>
</span><span id="Store-142"><a href="#Store-142"><span class="linenos"> 142</span></a><span class="sd">                Body format: JSON with type, time, data</span>
</span><span id="Store-143"><a href="#Store-143"><span class="linenos"> 143</span></a><span class="sd">    </span>
</span><span id="Store-144"><a href="#Store-144"><span class="linenos"> 144</span></a><span class="sd">    Notes:</span>
</span><span id="Store-145"><a href="#Store-145"><span class="linenos"> 145</span></a><span class="sd">        - Only ONE purchase request should be active at a time to avoid conflicts.</span>
</span><span id="Store-146"><a href="#Store-146"><span class="linenos"> 146</span></a><span class="sd">        - Failed requests are automatically retried by the RetryPreviousBuy behaviour.</span>
</span><span id="Store-147"><a href="#Store-147"><span class="linenos"> 147</span></a><span class="sd">        - Stock is updated only upon vehicle delivery, not upon order confirmation.</span>
</span><span id="Store-148"><a href="#Store-148"><span class="linenos"> 148</span></a><span class="sd">        - All order statistics are saved to CSV for post-simulation analysis.</span>
</span><span id="Store-149"><a href="#Store-149"><span class="linenos"> 149</span></a><span class="sd">        - The agent subscribes to all warehouses in contact_list during setup.</span>
</span><span id="Store-150"><a href="#Store-150"><span class="linenos"> 150</span></a><span class="sd">    </span>
</span><span id="Store-151"><a href="#Store-151"><span class="linenos"> 151</span></a><span class="sd">    Example:</span>
</span><span id="Store-152"><a href="#Store-152"><span class="linenos"> 152</span></a><span class="sd">        ```python</span>
</span><span id="Store-153"><a href="#Store-153"><span class="linenos"> 153</span></a><span class="sd">        store = Store(</span>
</span><span id="Store-154"><a href="#Store-154"><span class="linenos"> 154</span></a><span class="sd">            jid=&quot;store1@localhost&quot;,</span>
</span><span id="Store-155"><a href="#Store-155"><span class="linenos"> 155</span></a><span class="sd">            password=&quot;password&quot;,</span>
</span><span id="Store-156"><a href="#Store-156"><span class="linenos"> 156</span></a><span class="sd">            map=world_graph,</span>
</span><span id="Store-157"><a href="#Store-157"><span class="linenos"> 157</span></a><span class="sd">            node_id=5,</span>
</span><span id="Store-158"><a href="#Store-158"><span class="linenos"> 158</span></a><span class="sd">            contact_list=[&quot;warehouse1@localhost&quot;, &quot;warehouse2@localhost&quot;],</span>
</span><span id="Store-159"><a href="#Store-159"><span class="linenos"> 159</span></a><span class="sd">            verbose=True</span>
</span><span id="Store-160"><a href="#Store-160"><span class="linenos"> 160</span></a><span class="sd">        )</span>
</span><span id="Store-161"><a href="#Store-161"><span class="linenos"> 161</span></a><span class="sd">        await store.start()</span>
</span><span id="Store-162"><a href="#Store-162"><span class="linenos"> 162</span></a><span class="sd">        ```</span>
</span><span id="Store-163"><a href="#Store-163"><span class="linenos"> 163</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Store-164"><a href="#Store-164"><span class="linenos"> 164</span></a>    
</span><span id="Store-165"><a href="#Store-165"><span class="linenos"> 165</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Store-166"><a href="#Store-166"><span class="linenos"> 166</span></a>    <span class="c1">#         WAREHOUSE &lt;-&gt; STORE</span>
</span><span id="Store-167"><a href="#Store-167"><span class="linenos"> 167</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Store-168"><a href="#Store-168"><span class="linenos"> 168</span></a>    
</span><span id="Store-169"><a href="#Store-169"><span class="linenos"> 169</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">BuyProduct</span><span class="p">(</span><span class="n">PeriodicBehaviour</span><span class="p">):</span>
</span><span id="Store-170"><a href="#Store-170"><span class="linenos"> 170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-171"><a href="#Store-171"><span class="linenos"> 171</span></a><span class="sd">        Periodic behaviour that initiates product purchase requests to warehouses.</span>
</span><span id="Store-172"><a href="#Store-172"><span class="linenos"> 172</span></a><span class="sd">        </span>
</span><span id="Store-173"><a href="#Store-173"><span class="linenos"> 173</span></a><span class="sd">        This behaviour implements the initiation phase of the FIPA Contract Net Protocol.</span>
</span><span id="Store-174"><a href="#Store-174"><span class="linenos"> 174</span></a><span class="sd">        It sends a Call for Proposals (CFP) to all available warehouses, requesting quotes</span>
</span><span id="Store-175"><a href="#Store-175"><span class="linenos"> 175</span></a><span class="sd">        for a specific product and quantity. The behaviour executes periodically but only</span>
</span><span id="Store-176"><a href="#Store-176"><span class="linenos"> 176</span></a><span class="sd">        proceeds with a purchase based on a configured probability threshold.</span>
</span><span id="Store-177"><a href="#Store-177"><span class="linenos"> 177</span></a><span class="sd">        </span>
</span><span id="Store-178"><a href="#Store-178"><span class="linenos"> 178</span></a><span class="sd">        FIPA Protocol Phase: **Call for Proposals (CFP)**</span>
</span><span id="Store-179"><a href="#Store-179"><span class="linenos"> 179</span></a><span class="sd">            - Role: Initiator (Store agent)</span>
</span><span id="Store-180"><a href="#Store-180"><span class="linenos"> 180</span></a><span class="sd">            - Participants: All warehouses in contact list</span>
</span><span id="Store-181"><a href="#Store-181"><span class="linenos"> 181</span></a><span class="sd">            - Message type: `store-buy` (FIPA CFP equivalent)</span>
</span><span id="Store-182"><a href="#Store-182"><span class="linenos"> 182</span></a><span class="sd">            - Protocol: FIPA Contract Net Protocol</span>
</span><span id="Store-183"><a href="#Store-183"><span class="linenos"> 183</span></a><span class="sd">        </span>
</span><span id="Store-184"><a href="#Store-184"><span class="linenos"> 184</span></a><span class="sd">        The behaviour uses randomization to select products and quantities for each purchase,</span>
</span><span id="Store-185"><a href="#Store-185"><span class="linenos"> 185</span></a><span class="sd">        ensuring varied and realistic purchasing patterns. It then delegates response collection</span>
</span><span id="Store-186"><a href="#Store-186"><span class="linenos"> 186</span></a><span class="sd">        and warehouse selection to the CollectWarehouseResponses coordinator behaviour.</span>
</span><span id="Store-187"><a href="#Store-187"><span class="linenos"> 187</span></a><span class="sd">        </span>
</span><span id="Store-188"><a href="#Store-188"><span class="linenos"> 188</span></a><span class="sd">        Attributes:</span>
</span><span id="Store-189"><a href="#Store-189"><span class="linenos"> 189</span></a><span class="sd">            quantity (Optional[int]): Fixed quantity to purchase. If None, randomizes each run</span>
</span><span id="Store-190"><a href="#Store-190"><span class="linenos"> 190</span></a><span class="sd">                between 1 and max_buy_quantity.</span>
</span><span id="Store-191"><a href="#Store-191"><span class="linenos"> 191</span></a><span class="sd">            product (Optional[str]): Fixed product to purchase. If None, randomly selects from</span>
</span><span id="Store-192"><a href="#Store-192"><span class="linenos"> 192</span></a><span class="sd">                config.PRODUCTS each run.</span>
</span><span id="Store-193"><a href="#Store-193"><span class="linenos"> 193</span></a><span class="sd">            period (float): Time interval between executions in seconds (from config).</span>
</span><span id="Store-194"><a href="#Store-194"><span class="linenos"> 194</span></a><span class="sd">            start_at (datetime): Timestamp when the behaviour should first execute.</span>
</span><span id="Store-195"><a href="#Store-195"><span class="linenos"> 195</span></a><span class="sd">        </span>
</span><span id="Store-196"><a href="#Store-196"><span class="linenos"> 196</span></a><span class="sd">        Message Format (FIPA CFP):</span>
</span><span id="Store-197"><a href="#Store-197"><span class="linenos"> 197</span></a><span class="sd">            Metadata:</span>
</span><span id="Store-198"><a href="#Store-198"><span class="linenos"> 198</span></a><span class="sd">                - performative: &quot;store-buy&quot; (FIPA CFP)</span>
</span><span id="Store-199"><a href="#Store-199"><span class="linenos"> 199</span></a><span class="sd">                - store_id: Store&#39;s JID</span>
</span><span id="Store-200"><a href="#Store-200"><span class="linenos"> 200</span></a><span class="sd">                - node_id: Store&#39;s graph node ID</span>
</span><span id="Store-201"><a href="#Store-201"><span class="linenos"> 201</span></a><span class="sd">                - request_id: Unique request ID using hierarchical encoding</span>
</span><span id="Store-202"><a href="#Store-202"><span class="linenos"> 202</span></a><span class="sd">            Body:</span>
</span><span id="Store-203"><a href="#Store-203"><span class="linenos"> 203</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-204"><a href="#Store-204"><span class="linenos"> 204</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="Store-205"><a href="#Store-205"><span class="linenos"> 205</span></a><span class="sd">        </span>
</span><span id="Store-206"><a href="#Store-206"><span class="linenos"> 206</span></a><span class="sd">        Workflow:</span>
</span><span id="Store-207"><a href="#Store-207"><span class="linenos"> 207</span></a><span class="sd">            1. Roll random number (1-100) to determine if purchase should occur</span>
</span><span id="Store-208"><a href="#Store-208"><span class="linenos"> 208</span></a><span class="sd">            2. Compare roll against buy_prob threshold; skip if roll fails</span>
</span><span id="Store-209"><a href="#Store-209"><span class="linenos"> 209</span></a><span class="sd">            3. Randomize or use fixed quantity and product</span>
</span><span id="Store-210"><a href="#Store-210"><span class="linenos"> 210</span></a><span class="sd">            4. Generate unique request_id using ID encoding: id_base + request_counter</span>
</span><span id="Store-211"><a href="#Store-211"><span class="linenos"> 211</span></a><span class="sd">            5. Broadcast CFP to all warehouses in contact list</span>
</span><span id="Store-212"><a href="#Store-212"><span class="linenos"> 212</span></a><span class="sd">            6. Launch CollectWarehouseResponses to handle FIPA negotiation protocol</span>
</span><span id="Store-213"><a href="#Store-213"><span class="linenos"> 213</span></a><span class="sd">            7. Wait for negotiation to complete</span>
</span><span id="Store-214"><a href="#Store-214"><span class="linenos"> 214</span></a><span class="sd">        </span>
</span><span id="Store-215"><a href="#Store-215"><span class="linenos"> 215</span></a><span class="sd">        Notes:</span>
</span><span id="Store-216"><a href="#Store-216"><span class="linenos"> 216</span></a><span class="sd">            - Uses local variables (not self.quantity/self.product) to ensure proper</span>
</span><span id="Store-217"><a href="#Store-217"><span class="linenos"> 217</span></a><span class="sd">              randomization on each execution cycle.</span>
</span><span id="Store-218"><a href="#Store-218"><span class="linenos"> 218</span></a><span class="sd">            - Each execution generates a new request_id to avoid conflicts.</span>
</span><span id="Store-219"><a href="#Store-219"><span class="linenos"> 219</span></a><span class="sd">            - Waits for CollectWarehouseResponses to complete before finishing.</span>
</span><span id="Store-220"><a href="#Store-220"><span class="linenos"> 220</span></a><span class="sd">            - Probability mechanism prevents constant purchasing, simulating realistic demand.</span>
</span><span id="Store-221"><a href="#Store-221"><span class="linenos"> 221</span></a><span class="sd">        </span>
</span><span id="Store-222"><a href="#Store-222"><span class="linenos"> 222</span></a><span class="sd">        Example:</span>
</span><span id="Store-223"><a href="#Store-223"><span class="linenos"> 223</span></a><span class="sd">            ```python</span>
</span><span id="Store-224"><a href="#Store-224"><span class="linenos"> 224</span></a><span class="sd">            # Random purchases from config product list</span>
</span><span id="Store-225"><a href="#Store-225"><span class="linenos"> 225</span></a><span class="sd">            buy_behav = store.BuyProduct()</span>
</span><span id="Store-226"><a href="#Store-226"><span class="linenos"> 226</span></a><span class="sd">            </span>
</span><span id="Store-227"><a href="#Store-227"><span class="linenos"> 227</span></a><span class="sd">            # Fixed product and quantity for testing</span>
</span><span id="Store-228"><a href="#Store-228"><span class="linenos"> 228</span></a><span class="sd">            buy_behav = store.BuyProduct(quantity=100, product=&quot;electronics&quot;)</span>
</span><span id="Store-229"><a href="#Store-229"><span class="linenos"> 229</span></a><span class="sd">            ```</span>
</span><span id="Store-230"><a href="#Store-230"><span class="linenos"> 230</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-231"><a href="#Store-231"><span class="linenos"> 231</span></a>
</span><span id="Store-232"><a href="#Store-232"><span class="linenos"> 232</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Store-233"><a href="#Store-233"><span class="linenos"> 233</span></a>                     <span class="n">quantity</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Store-234"><a href="#Store-234"><span class="linenos"> 234</span></a>                     <span class="n">product</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Store-235"><a href="#Store-235"><span class="linenos"> 235</span></a>                     <span class="n">period</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">STORE_BUY_FREQUENCY</span><span class="p">,</span>
</span><span id="Store-236"><a href="#Store-236"><span class="linenos"> 236</span></a>                     <span class="n">start_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)):</span>
</span><span id="Store-237"><a href="#Store-237"><span class="linenos"> 237</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-238"><a href="#Store-238"><span class="linenos"> 238</span></a><span class="sd">            Initialize the BuyProduct periodic behaviour.</span>
</span><span id="Store-239"><a href="#Store-239"><span class="linenos"> 239</span></a><span class="sd">            </span>
</span><span id="Store-240"><a href="#Store-240"><span class="linenos"> 240</span></a><span class="sd">            Args:</span>
</span><span id="Store-241"><a href="#Store-241"><span class="linenos"> 241</span></a><span class="sd">                quantity (Optional[int], optional): Fixed quantity to purchase each period.</span>
</span><span id="Store-242"><a href="#Store-242"><span class="linenos"> 242</span></a><span class="sd">                    If None, quantity is randomized between 1 and max_buy_quantity each run.</span>
</span><span id="Store-243"><a href="#Store-243"><span class="linenos"> 243</span></a><span class="sd">                    Defaults to None for varied purchasing patterns.</span>
</span><span id="Store-244"><a href="#Store-244"><span class="linenos"> 244</span></a><span class="sd">                product (Optional[str], optional): Fixed product name to purchase each period.</span>
</span><span id="Store-245"><a href="#Store-245"><span class="linenos"> 245</span></a><span class="sd">                    If None, product is randomly selected from config.PRODUCTS each run.</span>
</span><span id="Store-246"><a href="#Store-246"><span class="linenos"> 246</span></a><span class="sd">                    Defaults to None for varied product selection.</span>
</span><span id="Store-247"><a href="#Store-247"><span class="linenos"> 247</span></a><span class="sd">                period (float, optional): Time interval between executions in seconds.</span>
</span><span id="Store-248"><a href="#Store-248"><span class="linenos"> 248</span></a><span class="sd">                    Controls how frequently purchase attempts are made.</span>
</span><span id="Store-249"><a href="#Store-249"><span class="linenos"> 249</span></a><span class="sd">                    Defaults to config.STORE_BUY_FREQUENCY.</span>
</span><span id="Store-250"><a href="#Store-250"><span class="linenos"> 250</span></a><span class="sd">                start_at (datetime, optional): Timestamp when behaviour should first execute.</span>
</span><span id="Store-251"><a href="#Store-251"><span class="linenos"> 251</span></a><span class="sd">                    Allows delayed start for synchronized simulation initialization.</span>
</span><span id="Store-252"><a href="#Store-252"><span class="linenos"> 252</span></a><span class="sd">                    Defaults to 5 seconds from initialization time.</span>
</span><span id="Store-253"><a href="#Store-253"><span class="linenos"> 253</span></a><span class="sd">            </span>
</span><span id="Store-254"><a href="#Store-254"><span class="linenos"> 254</span></a><span class="sd">            Note:</span>
</span><span id="Store-255"><a href="#Store-255"><span class="linenos"> 255</span></a><span class="sd">                Using None for quantity and product (default) creates varied purchasing</span>
</span><span id="Store-256"><a href="#Store-256"><span class="linenos"> 256</span></a><span class="sd">                patterns that simulate realistic retail demand, while fixed values create</span>
</span><span id="Store-257"><a href="#Store-257"><span class="linenos"> 257</span></a><span class="sd">                predictable repeated orders useful for testing specific scenarios.</span>
</span><span id="Store-258"><a href="#Store-258"><span class="linenos"> 258</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-259"><a href="#Store-259"><span class="linenos"> 259</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">start_at</span><span class="o">=</span><span class="n">start_at</span><span class="p">)</span>
</span><span id="Store-260"><a href="#Store-260"><span class="linenos"> 260</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Store-261"><a href="#Store-261"><span class="linenos"> 261</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="Store-262"><a href="#Store-262"><span class="linenos"> 262</span></a>        
</span><span id="Store-263"><a href="#Store-263"><span class="linenos"> 263</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store-264"><a href="#Store-264"><span class="linenos"> 264</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-265"><a href="#Store-265"><span class="linenos"> 265</span></a><span class="sd">            Execute one cycle of the purchase request behaviour.</span>
</span><span id="Store-266"><a href="#Store-266"><span class="linenos"> 266</span></a><span class="sd">            </span>
</span><span id="Store-267"><a href="#Store-267"><span class="linenos"> 267</span></a><span class="sd">            This method implements the probabilistic purchase initiation logic and</span>
</span><span id="Store-268"><a href="#Store-268"><span class="linenos"> 268</span></a><span class="sd">            broadcasts FIPA CFP messages to all warehouses. It uses randomization for</span>
</span><span id="Store-269"><a href="#Store-269"><span class="linenos"> 269</span></a><span class="sd">            both the purchase decision (based on buy_prob) and the product/quantity</span>
</span><span id="Store-270"><a href="#Store-270"><span class="linenos"> 270</span></a><span class="sd">            selection (unless fixed values were provided in __init__).</span>
</span><span id="Store-271"><a href="#Store-271"><span class="linenos"> 271</span></a><span class="sd">            </span>
</span><span id="Store-272"><a href="#Store-272"><span class="linenos"> 272</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Store-273"><a href="#Store-273"><span class="linenos"> 273</span></a><span class="sd">                - **Phase**: Call for Proposals (CFP) - Initiation</span>
</span><span id="Store-274"><a href="#Store-274"><span class="linenos"> 274</span></a><span class="sd">                - **Role**: Initiator</span>
</span><span id="Store-275"><a href="#Store-275"><span class="linenos"> 275</span></a><span class="sd">                - **Performative**: store-buy (FIPA CFP)</span>
</span><span id="Store-276"><a href="#Store-276"><span class="linenos"> 276</span></a><span class="sd">                - **Content**: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-277"><a href="#Store-277"><span class="linenos"> 277</span></a><span class="sd">                - **Receivers**: All warehouses in contact list (broadcast)</span>
</span><span id="Store-278"><a href="#Store-278"><span class="linenos"> 278</span></a><span class="sd">                - **Protocol**: FIPA Contract Net Protocol</span>
</span><span id="Store-279"><a href="#Store-279"><span class="linenos"> 279</span></a><span class="sd">            </span>
</span><span id="Store-280"><a href="#Store-280"><span class="linenos"> 280</span></a><span class="sd">            The method generates a unique request_id using the Store&#39;s hierarchical ID</span>
</span><span id="Store-281"><a href="#Store-281"><span class="linenos"> 281</span></a><span class="sd">            encoding system before broadcasting to ensure all responses can be properly</span>
</span><span id="Store-282"><a href="#Store-282"><span class="linenos"> 282</span></a><span class="sd">            matched to this specific request.</span>
</span><span id="Store-283"><a href="#Store-283"><span class="linenos"> 283</span></a><span class="sd">            </span>
</span><span id="Store-284"><a href="#Store-284"><span class="linenos"> 284</span></a><span class="sd">            Workflow:</span>
</span><span id="Store-285"><a href="#Store-285"><span class="linenos"> 285</span></a><span class="sd">                1. **Probability Check**: Roll random number (1-100) for purchase decision</span>
</span><span id="Store-286"><a href="#Store-286"><span class="linenos"> 286</span></a><span class="sd">                2. **Threshold Comparison**: Compare roll against buy_prob * 100</span>
</span><span id="Store-287"><a href="#Store-287"><span class="linenos"> 287</span></a><span class="sd">                3. **Early Return**: If roll fails, abort and wait for next period</span>
</span><span id="Store-288"><a href="#Store-288"><span class="linenos"> 288</span></a><span class="sd">                4. **Randomization**: Generate or use fixed quantity and product</span>
</span><span id="Store-289"><a href="#Store-289"><span class="linenos"> 289</span></a><span class="sd">                5. **ID Generation**: Create unique request_id from id_base + request_counter</span>
</span><span id="Store-290"><a href="#Store-290"><span class="linenos"> 290</span></a><span class="sd">                6. **CFP Broadcast**: Send store-buy message to all warehouses</span>
</span><span id="Store-291"><a href="#Store-291"><span class="linenos"> 291</span></a><span class="sd">                7. **Coordinator Launch**: Start CollectWarehouseResponses for negotiation</span>
</span><span id="Store-292"><a href="#Store-292"><span class="linenos"> 292</span></a><span class="sd">                8. **Synchronization**: Wait for coordinator to complete FIPA protocol</span>
</span><span id="Store-293"><a href="#Store-293"><span class="linenos"> 293</span></a><span class="sd">            </span>
</span><span id="Store-294"><a href="#Store-294"><span class="linenos"> 294</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store-295"><a href="#Store-295"><span class="linenos"> 295</span></a><span class="sd">                - Increments agent.request_counter (ensures unique IDs)</span>
</span><span id="Store-296"><a href="#Store-296"><span class="linenos"> 296</span></a><span class="sd">                - Updates agent.current_buy_request with last sent message</span>
</span><span id="Store-297"><a href="#Store-297"><span class="linenos"> 297</span></a><span class="sd">                - Adds CollectWarehouseResponses behaviour to agent</span>
</span><span id="Store-298"><a href="#Store-298"><span class="linenos"> 298</span></a><span class="sd">                - May print debug information if verbose mode is enabled</span>
</span><span id="Store-299"><a href="#Store-299"><span class="linenos"> 299</span></a><span class="sd">            </span>
</span><span id="Store-300"><a href="#Store-300"><span class="linenos"> 300</span></a><span class="sd">            Returns:</span>
</span><span id="Store-301"><a href="#Store-301"><span class="linenos"> 301</span></a><span class="sd">                None. Completes when CollectWarehouseResponses finishes the negotiation</span>
</span><span id="Store-302"><a href="#Store-302"><span class="linenos"> 302</span></a><span class="sd">                process and a warehouse is selected (or request fails).</span>
</span><span id="Store-303"><a href="#Store-303"><span class="linenos"> 303</span></a><span class="sd">            </span>
</span><span id="Store-304"><a href="#Store-304"><span class="linenos"> 304</span></a><span class="sd">            Note:</span>
</span><span id="Store-305"><a href="#Store-305"><span class="linenos"> 305</span></a><span class="sd">                Uses local variables (quantity, product) instead of instance variables</span>
</span><span id="Store-306"><a href="#Store-306"><span class="linenos"> 306</span></a><span class="sd">                to ensure proper randomization on each execution. This prevents the bug</span>
</span><span id="Store-307"><a href="#Store-307"><span class="linenos"> 307</span></a><span class="sd">                where the same product/quantity would be used repeatedly.</span>
</span><span id="Store-308"><a href="#Store-308"><span class="linenos"> 308</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-309"><a href="#Store-309"><span class="linenos"> 309</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store-310"><a href="#Store-310"><span class="linenos"> 310</span></a>            
</span><span id="Store-311"><a href="#Store-311"><span class="linenos"> 311</span></a>            <span class="n">roll</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
</span><span id="Store-312"><a href="#Store-312"><span class="linenos"> 312</span></a>            <span class="c1"># Decide whether to buy this turn based on probability</span>
</span><span id="Store-313"><a href="#Store-313"><span class="linenos"> 313</span></a>            <span class="k">if</span> <span class="n">roll</span> <span class="o">&gt;</span> <span class="n">agent</span><span class="o">.</span><span class="n">buy_prob</span> <span class="o">*</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="Store-314"><a href="#Store-314"><span class="linenos"> 314</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-315"><a href="#Store-315"><span class="linenos"> 315</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Decided NOT to buy this turn (roll=</span><span class="si">{</span><span class="n">roll</span><span class="si">}</span><span class="s2"> &gt; buy_prob=</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">buy_prob</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Store-316"><a href="#Store-316"><span class="linenos"> 316</span></a>                <span class="k">return</span>
</span><span id="Store-317"><a href="#Store-317"><span class="linenos"> 317</span></a>            <span class="k">else</span><span class="p">:</span> <span class="k">pass</span>
</span><span id="Store-318"><a href="#Store-318"><span class="linenos"> 318</span></a>            
</span><span id="Store-319"><a href="#Store-319"><span class="linenos"> 319</span></a>            <span class="c1"># Randomize quantity and product for each purchase</span>
</span><span id="Store-320"><a href="#Store-320"><span class="linenos"> 320</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="Store-321"><a href="#Store-321"><span class="linenos"> 321</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">max_buy_quantity</span><span class="p">)</span>
</span><span id="Store-322"><a href="#Store-322"><span class="linenos"> 322</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Store-323"><a href="#Store-323"><span class="linenos"> 323</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="Store-324"><a href="#Store-324"><span class="linenos"> 324</span></a>                
</span><span id="Store-325"><a href="#Store-325"><span class="linenos"> 325</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store-326"><a href="#Store-326"><span class="linenos"> 326</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">product_list</span><span class="p">)</span>
</span><span id="Store-327"><a href="#Store-327"><span class="linenos"> 327</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Store-328"><a href="#Store-328"><span class="linenos"> 328</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span>
</span><span id="Store-329"><a href="#Store-329"><span class="linenos"> 329</span></a>                
</span><span id="Store-330"><a href="#Store-330"><span class="linenos"> 330</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Preparing to buy </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-331"><a href="#Store-331"><span class="linenos"> 331</span></a>            
</span><span id="Store-332"><a href="#Store-332"><span class="linenos"> 332</span></a>            <span class="n">contacts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Store-333"><a href="#Store-333"><span class="linenos"> 333</span></a>            
</span><span id="Store-334"><a href="#Store-334"><span class="linenos"> 334</span></a>            <span class="c1"># Get request_id before sending - use ID encoding</span>
</span><span id="Store-335"><a href="#Store-335"><span class="linenos"> 335</span></a>            <span class="n">request_id_for_template</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">id_base</span> <span class="o">+</span> <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span>
</span><span id="Store-336"><a href="#Store-336"><span class="linenos"> 336</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Store-337"><a href="#Store-337"><span class="linenos"> 337</span></a>            
</span><span id="Store-338"><a href="#Store-338"><span class="linenos"> 338</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will store the last sent message for current_buy_request</span>
</span><span id="Store-339"><a href="#Store-339"><span class="linenos"> 339</span></a>            <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">:</span>
</span><span id="Store-340"><a href="#Store-340"><span class="linenos"> 340</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">contact</span><span class="p">)</span>
</span><span id="Store-341"><a href="#Store-341"><span class="linenos"> 341</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-buy&quot;</span><span class="p">)</span>
</span><span id="Store-342"><a href="#Store-342"><span class="linenos"> 342</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store-343"><a href="#Store-343"><span class="linenos"> 343</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Store-344"><a href="#Store-344"><span class="linenos"> 344</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id_for_template</span><span class="p">))</span>
</span><span id="Store-345"><a href="#Store-345"><span class="linenos"> 345</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Store-346"><a href="#Store-346"><span class="linenos"> 346</span></a>                
</span><span id="Store-347"><a href="#Store-347"><span class="linenos"> 347</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-348"><a href="#Store-348"><span class="linenos"> 348</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent request (id=</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;request_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="Store-349"><a href="#Store-349"><span class="linenos"> 349</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-350"><a href="#Store-350"><span class="linenos"> 350</span></a>                
</span><span id="Store-351"><a href="#Store-351"><span class="linenos"> 351</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store-352"><a href="#Store-352"><span class="linenos"> 352</span></a>            
</span><span id="Store-353"><a href="#Store-353"><span class="linenos"> 353</span></a>            <span class="c1"># Store the last message (or could store all if needed)</span>
</span><span id="Store-354"><a href="#Store-354"><span class="linenos"> 354</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Store-355"><a href="#Store-355"><span class="linenos"> 355</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="Store-356"><a href="#Store-356"><span class="linenos"> 356</span></a>        
</span><span id="Store-357"><a href="#Store-357"><span class="linenos"> 357</span></a>                <span class="c1"># Collect responses from all warehouses</span>
</span><span id="Store-358"><a href="#Store-358"><span class="linenos"> 358</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectWarehouseResponses</span><span class="p">(</span>
</span><span id="Store-359"><a href="#Store-359"><span class="linenos"> 359</span></a>                    <span class="n">msg</span><span class="p">,</span> 
</span><span id="Store-360"><a href="#Store-360"><span class="linenos"> 360</span></a>                    <span class="n">request_id_for_template</span><span class="p">,</span> 
</span><span id="Store-361"><a href="#Store-361"><span class="linenos"> 361</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">contacts</span><span class="p">),</span>
</span><span id="Store-362"><a href="#Store-362"><span class="linenos"> 362</span></a>                    <span class="n">quantity</span><span class="p">,</span>
</span><span id="Store-363"><a href="#Store-363"><span class="linenos"> 363</span></a>                    <span class="n">product</span>
</span><span id="Store-364"><a href="#Store-364"><span class="linenos"> 364</span></a>                <span class="p">)</span>
</span><span id="Store-365"><a href="#Store-365"><span class="linenos"> 365</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Store-366"><a href="#Store-366"><span class="linenos"> 366</span></a>                
</span><span id="Store-367"><a href="#Store-367"><span class="linenos"> 367</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Store-368"><a href="#Store-368"><span class="linenos"> 368</span></a>
</span><span id="Store-369"><a href="#Store-369"><span class="linenos"> 369</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">CollectWarehouseResponses</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Store-370"><a href="#Store-370"><span class="linenos"> 370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-371"><a href="#Store-371"><span class="linenos"> 371</span></a><span class="sd">        Coordinator behaviour for FIPA Contract Net Protocol implementation.</span>
</span><span id="Store-372"><a href="#Store-372"><span class="linenos"> 372</span></a><span class="sd">        </span>
</span><span id="Store-373"><a href="#Store-373"><span class="linenos"> 373</span></a><span class="sd">        This behaviour orchestrates the proposal collection, evaluation, and award phases</span>
</span><span id="Store-374"><a href="#Store-374"><span class="linenos"> 374</span></a><span class="sd">        of the FIPA Contract Net Protocol. It acts as the coordinator (initiator) that</span>
</span><span id="Store-375"><a href="#Store-375"><span class="linenos"> 375</span></a><span class="sd">        manages the negotiation process with multiple warehouses, collects their responses,</span>
</span><span id="Store-376"><a href="#Store-376"><span class="linenos"> 376</span></a><span class="sd">        and selects the best proposal based on a distance-based scoring function.</span>
</span><span id="Store-377"><a href="#Store-377"><span class="linenos"> 377</span></a><span class="sd">        </span>
</span><span id="Store-378"><a href="#Store-378"><span class="linenos"> 378</span></a><span class="sd">        FIPA Protocol Phases Implemented:</span>
</span><span id="Store-379"><a href="#Store-379"><span class="linenos"> 379</span></a><span class="sd">            1. **Proposal Reception**: Collects warehouse responses (propose/refuse)</span>
</span><span id="Store-380"><a href="#Store-380"><span class="linenos"> 380</span></a><span class="sd">            2. **Proposal Evaluation**: Scores each acceptance using Dijkstra pathfinding</span>
</span><span id="Store-381"><a href="#Store-381"><span class="linenos"> 381</span></a><span class="sd">            3. **Award Decision**: Sends accept-proposal to winner, reject-proposal to losers</span>
</span><span id="Store-382"><a href="#Store-382"><span class="linenos"> 382</span></a><span class="sd">        </span>
</span><span id="Store-383"><a href="#Store-383"><span class="linenos"> 383</span></a><span class="sd">        The behaviour uses a coordinator/worker pattern:</span>
</span><span id="Store-384"><a href="#Store-384"><span class="linenos"> 384</span></a><span class="sd">            - **Coordinator** (this class): Manages overall protocol flow, evaluates proposals</span>
</span><span id="Store-385"><a href="#Store-385"><span class="linenos"> 385</span></a><span class="sd">            - **Worker** (ReceiveAllResponses): Handles actual message reception</span>
</span><span id="Store-386"><a href="#Store-386"><span class="linenos"> 386</span></a><span class="sd">        </span>
</span><span id="Store-387"><a href="#Store-387"><span class="linenos"> 387</span></a><span class="sd">        Scoring Algorithm:</span>
</span><span id="Store-388"><a href="#Store-388"><span class="linenos"> 388</span></a><span class="sd">            Uses Dijkstra pathfinding to calculate delivery time from each warehouse to store.</span>
</span><span id="Store-389"><a href="#Store-389"><span class="linenos"> 389</span></a><span class="sd">            - Formula: score = delivery_time (from warehouse to store)</span>
</span><span id="Store-390"><a href="#Store-390"><span class="linenos"> 390</span></a><span class="sd">            - Lower score = better choice (shorter delivery time)</span>
</span><span id="Store-391"><a href="#Store-391"><span class="linenos"> 391</span></a><span class="sd">            - Tie-breaking: First warehouse with minimum score wins</span>
</span><span id="Store-392"><a href="#Store-392"><span class="linenos"> 392</span></a><span class="sd">        </span>
</span><span id="Store-393"><a href="#Store-393"><span class="linenos"> 393</span></a><span class="sd">        FIPA Contract Net Protocol Flow:</span>
</span><span id="Store-394"><a href="#Store-394"><span class="linenos"> 394</span></a><span class="sd">            1. **Setup**: Create template matching request_id and store_id</span>
</span><span id="Store-395"><a href="#Store-395"><span class="linenos"> 395</span></a><span class="sd">            2. **Collection**: Launch ReceiveAllResponses worker to gather proposals</span>
</span><span id="Store-396"><a href="#Store-396"><span class="linenos"> 396</span></a><span class="sd">            3. **Wait**: Synchronize on worker completion (timeout: 5 seconds)</span>
</span><span id="Store-397"><a href="#Store-397"><span class="linenos"> 397</span></a><span class="sd">            4. **Evaluation**: Calculate scores for all acceptances</span>
</span><span id="Store-398"><a href="#Store-398"><span class="linenos"> 398</span></a><span class="sd">            5. **Selection**: Choose warehouse with minimum score</span>
</span><span id="Store-399"><a href="#Store-399"><span class="linenos"> 399</span></a><span class="sd">            6. **Award**: Send store-confirm to winner (FIPA accept-proposal)</span>
</span><span id="Store-400"><a href="#Store-400"><span class="linenos"> 400</span></a><span class="sd">            7. **Rejection**: Send store-deny to losers (FIPA reject-proposal)</span>
</span><span id="Store-401"><a href="#Store-401"><span class="linenos"> 401</span></a><span class="sd">            8. **Failure Handling**: Enqueue for retry if no acceptances received</span>
</span><span id="Store-402"><a href="#Store-402"><span class="linenos"> 402</span></a><span class="sd">        </span>
</span><span id="Store-403"><a href="#Store-403"><span class="linenos"> 403</span></a><span class="sd">        Attributes:</span>
</span><span id="Store-404"><a href="#Store-404"><span class="linenos"> 404</span></a><span class="sd">            request_id (int): Unique identifier for this purchase request from ID encoding.</span>
</span><span id="Store-405"><a href="#Store-405"><span class="linenos"> 405</span></a><span class="sd">            buy_msg (str): Original purchase message body (&quot;{quantity} {product}&quot;).</span>
</span><span id="Store-406"><a href="#Store-406"><span class="linenos"> 406</span></a><span class="sd">            num_warehouses (int): Expected number of warehouse responses for timeout logic.</span>
</span><span id="Store-407"><a href="#Store-407"><span class="linenos"> 407</span></a><span class="sd">            quantity (int): Quantity of product being purchased.</span>
</span><span id="Store-408"><a href="#Store-408"><span class="linenos"> 408</span></a><span class="sd">            product (str): Name of product being purchased.</span>
</span><span id="Store-409"><a href="#Store-409"><span class="linenos"> 409</span></a><span class="sd">            acceptances (list[tuple[str, Message]]): Warehouses that proposed.</span>
</span><span id="Store-410"><a href="#Store-410"><span class="linenos"> 410</span></a><span class="sd">                Format: [(warehouse_jid, acceptance_msg), ...]</span>
</span><span id="Store-411"><a href="#Store-411"><span class="linenos"> 411</span></a><span class="sd">            rejections (list[tuple[str, Message, str]]): Warehouses that refused.</span>
</span><span id="Store-412"><a href="#Store-412"><span class="linenos"> 412</span></a><span class="sd">                Format: [(warehouse_jid, rejection_msg, reason), ...]</span>
</span><span id="Store-413"><a href="#Store-413"><span class="linenos"> 413</span></a><span class="sd">        </span>
</span><span id="Store-414"><a href="#Store-414"><span class="linenos"> 414</span></a><span class="sd">        Failure Handling:</span>
</span><span id="Store-415"><a href="#Store-415"><span class="linenos"> 415</span></a><span class="sd">            - If no warehouses accept: Request added to failed_requests queue</span>
</span><span id="Store-416"><a href="#Store-416"><span class="linenos"> 416</span></a><span class="sd">            - RetryPreviousBuy behaviour will automatically retry with same request_id</span>
</span><span id="Store-417"><a href="#Store-417"><span class="linenos"> 417</span></a><span class="sd">            - Failed requests maintain original request_id for tracking</span>
</span><span id="Store-418"><a href="#Store-418"><span class="linenos"> 418</span></a><span class="sd">        </span>
</span><span id="Store-419"><a href="#Store-419"><span class="linenos"> 419</span></a><span class="sd">        Example Workflow:</span>
</span><span id="Store-420"><a href="#Store-420"><span class="linenos"> 420</span></a><span class="sd">            ```</span>
</span><span id="Store-421"><a href="#Store-421"><span class="linenos"> 421</span></a><span class="sd">            CFP Sent: &quot;50 electronics&quot; (request_id=1001000000)</span>
</span><span id="Store-422"><a href="#Store-422"><span class="linenos"> 422</span></a><span class="sd">            Responses Received:</span>
</span><span id="Store-423"><a href="#Store-423"><span class="linenos"> 423</span></a><span class="sd">                - warehouse1: propose (distance=100, score=100)</span>
</span><span id="Store-424"><a href="#Store-424"><span class="linenos"> 424</span></a><span class="sd">                - warehouse2: propose (distance=50, score=50) &lt;- WINNER</span>
</span><span id="Store-425"><a href="#Store-425"><span class="linenos"> 425</span></a><span class="sd">                - warehouse3: refuse (reason: out_of_stock)</span>
</span><span id="Store-426"><a href="#Store-426"><span class="linenos"> 426</span></a><span class="sd">            Actions Taken:</span>
</span><span id="Store-427"><a href="#Store-427"><span class="linenos"> 427</span></a><span class="sd">                - Send accept-proposal to warehouse2</span>
</span><span id="Store-428"><a href="#Store-428"><span class="linenos"> 428</span></a><span class="sd">                - Send reject-proposal to warehouse1</span>
</span><span id="Store-429"><a href="#Store-429"><span class="linenos"> 429</span></a><span class="sd">                - warehouse3 already refused, no action needed</span>
</span><span id="Store-430"><a href="#Store-430"><span class="linenos"> 430</span></a><span class="sd">            ```</span>
</span><span id="Store-431"><a href="#Store-431"><span class="linenos"> 431</span></a><span class="sd">        </span>
</span><span id="Store-432"><a href="#Store-432"><span class="linenos"> 432</span></a><span class="sd">        Note:</span>
</span><span id="Store-433"><a href="#Store-433"><span class="linenos"> 433</span></a><span class="sd">            This coordinator behaviour is essential for implementing the FIPA Contract Net</span>
</span><span id="Store-434"><a href="#Store-434"><span class="linenos"> 434</span></a><span class="sd">            Protocol correctly, separating concerns between message collection (worker) and</span>
</span><span id="Store-435"><a href="#Store-435"><span class="linenos"> 435</span></a><span class="sd">            decision-making (coordinator).</span>
</span><span id="Store-436"><a href="#Store-436"><span class="linenos"> 436</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-437"><a href="#Store-437"><span class="linenos"> 437</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_warehouses</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">quantity</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">product</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Store-438"><a href="#Store-438"><span class="linenos"> 438</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-439"><a href="#Store-439"><span class="linenos"> 439</span></a><span class="sd">            Initialize the CollectWarehouseResponses coordinator behaviour.</span>
</span><span id="Store-440"><a href="#Store-440"><span class="linenos"> 440</span></a><span class="sd">            </span>
</span><span id="Store-441"><a href="#Store-441"><span class="linenos"> 441</span></a><span class="sd">            Args:</span>
</span><span id="Store-442"><a href="#Store-442"><span class="linenos"> 442</span></a><span class="sd">                msg (Message): Original purchase request message sent to warehouses.</span>
</span><span id="Store-443"><a href="#Store-443"><span class="linenos"> 443</span></a><span class="sd">                    Stored as reference for reconstructing failed requests if needed.</span>
</span><span id="Store-444"><a href="#Store-444"><span class="linenos"> 444</span></a><span class="sd">                request_id (int): Unique request identifier from hierarchical ID encoding system.</span>
</span><span id="Store-445"><a href="#Store-445"><span class="linenos"> 445</span></a><span class="sd">                    Used to match incoming responses to this specific CFP.</span>
</span><span id="Store-446"><a href="#Store-446"><span class="linenos"> 446</span></a><span class="sd">                num_warehouses (int): Expected number of warehouse responses.</span>
</span><span id="Store-447"><a href="#Store-447"><span class="linenos"> 447</span></a><span class="sd">                    Used to determine when all proposals have been received (or timeout).</span>
</span><span id="Store-448"><a href="#Store-448"><span class="linenos"> 448</span></a><span class="sd">                quantity (int): Quantity of product being purchased.</span>
</span><span id="Store-449"><a href="#Store-449"><span class="linenos"> 449</span></a><span class="sd">                    Needed for order processing and statistics tracking.</span>
</span><span id="Store-450"><a href="#Store-450"><span class="linenos"> 450</span></a><span class="sd">                product (str): Name of product being purchased.</span>
</span><span id="Store-451"><a href="#Store-451"><span class="linenos"> 451</span></a><span class="sd">                    Needed for order processing and statistics tracking.</span>
</span><span id="Store-452"><a href="#Store-452"><span class="linenos"> 452</span></a><span class="sd">            </span>
</span><span id="Store-453"><a href="#Store-453"><span class="linenos"> 453</span></a><span class="sd">            Note:</span>
</span><span id="Store-454"><a href="#Store-454"><span class="linenos"> 454</span></a><span class="sd">                Initializes empty acceptances and rejections lists that will be</span>
</span><span id="Store-455"><a href="#Store-455"><span class="linenos"> 455</span></a><span class="sd">                populated by the ReceiveAllResponses worker behaviour through</span>
</span><span id="Store-456"><a href="#Store-456"><span class="linenos"> 456</span></a><span class="sd">                shared reference (list objects are mutable).</span>
</span><span id="Store-457"><a href="#Store-457"><span class="linenos"> 457</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-458"><a href="#Store-458"><span class="linenos"> 458</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Store-459"><a href="#Store-459"><span class="linenos"> 459</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Store-460"><a href="#Store-460"><span class="linenos"> 460</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">buy_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="Store-461"><a href="#Store-461"><span class="linenos"> 461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span> <span class="o">=</span> <span class="n">num_warehouses</span>
</span><span id="Store-462"><a href="#Store-462"><span class="linenos"> 462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Store-463"><a href="#Store-463"><span class="linenos"> 463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="Store-464"><a href="#Store-464"><span class="linenos"> 464</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of (warehouse_jid, msg)</span>
</span><span id="Store-465"><a href="#Store-465"><span class="linenos"> 465</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># List of (warehouse_jid, msg, reason)</span>
</span><span id="Store-466"><a href="#Store-466"><span class="linenos"> 466</span></a>            
</span><span id="Store-467"><a href="#Store-467"><span class="linenos"> 467</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store-468"><a href="#Store-468"><span class="linenos"> 468</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-469"><a href="#Store-469"><span class="linenos"> 469</span></a><span class="sd">            Execute the warehouse proposal collection and evaluation process.</span>
</span><span id="Store-470"><a href="#Store-470"><span class="linenos"> 470</span></a><span class="sd">            </span>
</span><span id="Store-471"><a href="#Store-471"><span class="linenos"> 471</span></a><span class="sd">            This method coordinates the entire FIPA Contract Net Protocol workflow</span>
</span><span id="Store-472"><a href="#Store-472"><span class="linenos"> 472</span></a><span class="sd">            for warehouse selection. It sets up message filtering, launches the worker</span>
</span><span id="Store-473"><a href="#Store-473"><span class="linenos"> 473</span></a><span class="sd">            behaviour for response collection, evaluates all proposals using a scoring</span>
</span><span id="Store-474"><a href="#Store-474"><span class="linenos"> 474</span></a><span class="sd">            algorithm, and sends confirmations/rejections to participants according to</span>
</span><span id="Store-475"><a href="#Store-475"><span class="linenos"> 475</span></a><span class="sd">            the FIPA protocol specification.</span>
</span><span id="Store-476"><a href="#Store-476"><span class="linenos"> 476</span></a><span class="sd">            </span>
</span><span id="Store-477"><a href="#Store-477"><span class="linenos"> 477</span></a><span class="sd">            FIPA Contract Net Protocol Implementation:</span>
</span><span id="Store-478"><a href="#Store-478"><span class="linenos"> 478</span></a><span class="sd">            </span>
</span><span id="Store-479"><a href="#Store-479"><span class="linenos"> 479</span></a><span class="sd">            1. **Setup Phase** (FIPA: Preparation):</span>
</span><span id="Store-480"><a href="#Store-480"><span class="linenos"> 480</span></a><span class="sd">                - Creates template matching request_id and store_id metadata</span>
</span><span id="Store-481"><a href="#Store-481"><span class="linenos"> 481</span></a><span class="sd">                - Allows both warehouse-accept (propose) and warehouse-reject (refuse)</span>
</span><span id="Store-482"><a href="#Store-482"><span class="linenos"> 482</span></a><span class="sd">                - Ensures only responses for THIS specific request are collected</span>
</span><span id="Store-483"><a href="#Store-483"><span class="linenos"> 483</span></a><span class="sd">                - Prevents cross-contamination between concurrent requests</span>
</span><span id="Store-484"><a href="#Store-484"><span class="linenos"> 484</span></a><span class="sd">            </span>
</span><span id="Store-485"><a href="#Store-485"><span class="linenos"> 485</span></a><span class="sd">            2. **Collection Phase** (FIPA: Proposal Reception):</span>
</span><span id="Store-486"><a href="#Store-486"><span class="linenos"> 486</span></a><span class="sd">                - Delegates to ReceiveAllResponses worker behaviour</span>
</span><span id="Store-487"><a href="#Store-487"><span class="linenos"> 487</span></a><span class="sd">                - Worker populates acceptances (proposals) and rejections (refusals) lists</span>
</span><span id="Store-488"><a href="#Store-488"><span class="linenos"> 488</span></a><span class="sd">                - Implements timeout mechanism (5 seconds total)</span>
</span><span id="Store-489"><a href="#Store-489"><span class="linenos"> 489</span></a><span class="sd">                - Handles partial responses gracefully (some warehouses may not respond)</span>
</span><span id="Store-490"><a href="#Store-490"><span class="linenos"> 490</span></a><span class="sd">            </span>
</span><span id="Store-491"><a href="#Store-491"><span class="linenos"> 491</span></a><span class="sd">            3. **Evaluation Phase** (FIPA: Proposal Evaluation):</span>
</span><span id="Store-492"><a href="#Store-492"><span class="linenos"> 492</span></a><span class="sd">                - Calculates score for each acceptance using calculate_warehouse_score()</span>
</span><span id="Store-493"><a href="#Store-493"><span class="linenos"> 493</span></a><span class="sd">                - Score based on Dijkstra pathfinding: delivery_time from warehouse to store</span>
</span><span id="Store-494"><a href="#Store-494"><span class="linenos"> 494</span></a><span class="sd">                - Selects warehouse with lowest score (shortest delivery time)</span>
</span><span id="Store-495"><a href="#Store-495"><span class="linenos"> 495</span></a><span class="sd">                - Implements best-proposal selection strategy from FIPA specification</span>
</span><span id="Store-496"><a href="#Store-496"><span class="linenos"> 496</span></a><span class="sd">            </span>
</span><span id="Store-497"><a href="#Store-497"><span class="linenos"> 497</span></a><span class="sd">            4. **Award Phase** (FIPA: Result Notification):</span>
</span><span id="Store-498"><a href="#Store-498"><span class="linenos"> 498</span></a><span class="sd">                - Sends store-confirm to winner (FIPA accept-proposal performative)</span>
</span><span id="Store-499"><a href="#Store-499"><span class="linenos"> 499</span></a><span class="sd">                - Sends store-deny to all other acceptors (FIPA reject-proposal performative)</span>
</span><span id="Store-500"><a href="#Store-500"><span class="linenos"> 500</span></a><span class="sd">                - Rejected participants (warehouse-reject) are not contacted again</span>
</span><span id="Store-501"><a href="#Store-501"><span class="linenos"> 501</span></a><span class="sd">                - Winner proceeds to order confirmation and vehicle assignment</span>
</span><span id="Store-502"><a href="#Store-502"><span class="linenos"> 502</span></a><span class="sd">            </span>
</span><span id="Store-503"><a href="#Store-503"><span class="linenos"> 503</span></a><span class="sd">            5. **Failure Handling**:</span>
</span><span id="Store-504"><a href="#Store-504"><span class="linenos"> 504</span></a><span class="sd">                - If no acceptances received: Adds request to failed_requests queue</span>
</span><span id="Store-505"><a href="#Store-505"><span class="linenos"> 505</span></a><span class="sd">                - Failed requests automatically retried by RetryPreviousBuy behaviour</span>
</span><span id="Store-506"><a href="#Store-506"><span class="linenos"> 506</span></a><span class="sd">                - Maintains same request_id for tracking across retry attempts</span>
</span><span id="Store-507"><a href="#Store-507"><span class="linenos"> 507</span></a><span class="sd">            </span>
</span><span id="Store-508"><a href="#Store-508"><span class="linenos"> 508</span></a><span class="sd">            Template Configuration:</span>
</span><span id="Store-509"><a href="#Store-509"><span class="linenos"> 509</span></a><span class="sd">                - **Matches**: store_id (this store) AND request_id (this specific request)</span>
</span><span id="Store-510"><a href="#Store-510"><span class="linenos"> 510</span></a><span class="sd">                - **Accepts**: Both warehouse-accept AND warehouse-reject performatives</span>
</span><span id="Store-511"><a href="#Store-511"><span class="linenos"> 511</span></a><span class="sd">                - **Purpose**: Filters responses to avoid conflicts with concurrent requests</span>
</span><span id="Store-512"><a href="#Store-512"><span class="linenos"> 512</span></a><span class="sd">                - **Design**: Intentionally doesn&#39;t filter by performative to collect all responses</span>
</span><span id="Store-513"><a href="#Store-513"><span class="linenos"> 513</span></a><span class="sd">            </span>
</span><span id="Store-514"><a href="#Store-514"><span class="linenos"> 514</span></a><span class="sd">            Scoring Process (Distance-Based Selection):</span>
</span><span id="Store-515"><a href="#Store-515"><span class="linenos"> 515</span></a><span class="sd">                For each warehouse that sent propose (warehouse-accept):</span>
</span><span id="Store-516"><a href="#Store-516"><span class="linenos"> 516</span></a><span class="sd">                1. Extract warehouse node_id from message metadata</span>
</span><span id="Store-517"><a href="#Store-517"><span class="linenos"> 517</span></a><span class="sd">                2. Use Dijkstra algorithm: calculate (path, fuel, time) warehouse -&gt; store</span>
</span><span id="Store-518"><a href="#Store-518"><span class="linenos"> 518</span></a><span class="sd">                3. Score = delivery time (lower is better)</span>
</span><span id="Store-519"><a href="#Store-519"><span class="linenos"> 519</span></a><span class="sd">                4. Select warehouse with minimum score</span>
</span><span id="Store-520"><a href="#Store-520"><span class="linenos"> 520</span></a><span class="sd">                5. Tie-breaking: First warehouse with minimum score wins</span>
</span><span id="Store-521"><a href="#Store-521"><span class="linenos"> 521</span></a><span class="sd">            </span>
</span><span id="Store-522"><a href="#Store-522"><span class="linenos"> 522</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store-523"><a href="#Store-523"><span class="linenos"> 523</span></a><span class="sd">                - Adds ReceiveAllResponses worker behaviour to agent (with template)</span>
</span><span id="Store-524"><a href="#Store-524"><span class="linenos"> 524</span></a><span class="sd">                - Adds SendStoreConfirmation behaviour for winner</span>
</span><span id="Store-525"><a href="#Store-525"><span class="linenos"> 525</span></a><span class="sd">                - Adds SendStoreDenial behaviour for each non-winner</span>
</span><span id="Store-526"><a href="#Store-526"><span class="linenos"> 526</span></a><span class="sd">                - May enqueue failed request to failed_requests queue</span>
</span><span id="Store-527"><a href="#Store-527"><span class="linenos"> 527</span></a><span class="sd">                - Prints evaluation details if verbose mode enabled</span>
</span><span id="Store-528"><a href="#Store-528"><span class="linenos"> 528</span></a><span class="sd">            </span>
</span><span id="Store-529"><a href="#Store-529"><span class="linenos"> 529</span></a><span class="sd">            Returns:</span>
</span><span id="Store-530"><a href="#Store-530"><span class="linenos"> 530</span></a><span class="sd">                None. Completes when all confirmations/denials are sent, or when</span>
</span><span id="Store-531"><a href="#Store-531"><span class="linenos"> 531</span></a><span class="sd">                failed request is enqueued for retry.</span>
</span><span id="Store-532"><a href="#Store-532"><span class="linenos"> 532</span></a><span class="sd">            </span>
</span><span id="Store-533"><a href="#Store-533"><span class="linenos"> 533</span></a><span class="sd">            Example Execution:</span>
</span><span id="Store-534"><a href="#Store-534"><span class="linenos"> 534</span></a><span class="sd">                ```</span>
</span><span id="Store-535"><a href="#Store-535"><span class="linenos"> 535</span></a><span class="sd">                CFP: &quot;50 electronics&quot; to 3 warehouses</span>
</span><span id="Store-536"><a href="#Store-536"><span class="linenos"> 536</span></a><span class="sd">                Responses:</span>
</span><span id="Store-537"><a href="#Store-537"><span class="linenos"> 537</span></a><span class="sd">                    - warehouse1: accept (node_id=10, distance=150, score=150)</span>
</span><span id="Store-538"><a href="#Store-538"><span class="linenos"> 538</span></a><span class="sd">                    - warehouse2: accept (node_id=5, distance=80, score=80) &lt;- WINNER</span>
</span><span id="Store-539"><a href="#Store-539"><span class="linenos"> 539</span></a><span class="sd">                    - warehouse3: reject (reason=out_of_stock)</span>
</span><span id="Store-540"><a href="#Store-540"><span class="linenos"> 540</span></a><span class="sd">                Actions:</span>
</span><span id="Store-541"><a href="#Store-541"><span class="linenos"> 541</span></a><span class="sd">                    - SendStoreConfirmation(warehouse2) -&gt; accept-proposal</span>
</span><span id="Store-542"><a href="#Store-542"><span class="linenos"> 542</span></a><span class="sd">                    - SendStoreDenial(warehouse1) -&gt; reject-proposal</span>
</span><span id="Store-543"><a href="#Store-543"><span class="linenos"> 543</span></a><span class="sd">                    - No action for warehouse3 (already refused)</span>
</span><span id="Store-544"><a href="#Store-544"><span class="linenos"> 544</span></a><span class="sd">                Result: Order placed with warehouse2</span>
</span><span id="Store-545"><a href="#Store-545"><span class="linenos"> 545</span></a><span class="sd">                ```</span>
</span><span id="Store-546"><a href="#Store-546"><span class="linenos"> 546</span></a><span class="sd">            </span>
</span><span id="Store-547"><a href="#Store-547"><span class="linenos"> 547</span></a><span class="sd">            Note:</span>
</span><span id="Store-548"><a href="#Store-548"><span class="linenos"> 548</span></a><span class="sd">                This method implements the core decision-making logic of the FIPA Contract</span>
</span><span id="Store-549"><a href="#Store-549"><span class="linenos"> 549</span></a><span class="sd">                Net Protocol, transforming raw proposals into a concrete purchase order with</span>
</span><span id="Store-550"><a href="#Store-550"><span class="linenos"> 550</span></a><span class="sd">                the optimal warehouse.</span>
</span><span id="Store-551"><a href="#Store-551"><span class="linenos"> 551</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-552"><a href="#Store-552"><span class="linenos"> 552</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store-553"><a href="#Store-553"><span class="linenos"> 553</span></a>            
</span><span id="Store-554"><a href="#Store-554"><span class="linenos"> 554</span></a>            <span class="c1"># Setup template that accepts BOTH warehouse-accept AND warehouse-reject</span>
</span><span id="Store-555"><a href="#Store-555"><span class="linenos"> 555</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Store-556"><a href="#Store-556"><span class="linenos"> 556</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store-557"><a href="#Store-557"><span class="linenos"> 557</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store-558"><a href="#Store-558"><span class="linenos"> 558</span></a>            <span class="c1"># Don&#39;t filter by performative - we want both accept and reject</span>
</span><span id="Store-559"><a href="#Store-559"><span class="linenos"> 559</span></a>            
</span><span id="Store-560"><a href="#Store-560"><span class="linenos"> 560</span></a>            <span class="c1"># Create a combined behaviour to listen for both</span>
</span><span id="Store-561"><a href="#Store-561"><span class="linenos"> 561</span></a>            <span class="n">combined_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ReceiveAllResponses</span><span class="p">(</span>
</span><span id="Store-562"><a href="#Store-562"><span class="linenos"> 562</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span id="Store-563"><a href="#Store-563"><span class="linenos"> 563</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span><span class="p">,</span>
</span><span id="Store-564"><a href="#Store-564"><span class="linenos"> 564</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">,</span>
</span><span id="Store-565"><a href="#Store-565"><span class="linenos"> 565</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span>
</span><span id="Store-566"><a href="#Store-566"><span class="linenos"> 566</span></a>            <span class="p">)</span>
</span><span id="Store-567"><a href="#Store-567"><span class="linenos"> 567</span></a>            
</span><span id="Store-568"><a href="#Store-568"><span class="linenos"> 568</span></a>            <span class="c1"># Add with template that matches both performatives</span>
</span><span id="Store-569"><a href="#Store-569"><span class="linenos"> 569</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">combined_behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Store-570"><a href="#Store-570"><span class="linenos"> 570</span></a>            
</span><span id="Store-571"><a href="#Store-571"><span class="linenos"> 571</span></a>            <span class="c1"># Wait for collection to complete</span>
</span><span id="Store-572"><a href="#Store-572"><span class="linenos"> 572</span></a>            <span class="k">await</span> <span class="n">combined_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Store-573"><a href="#Store-573"><span class="linenos"> 573</span></a>            
</span><span id="Store-574"><a href="#Store-574"><span class="linenos"> 574</span></a>            <span class="c1"># Now evaluate and choose best warehouse</span>
</span><span id="Store-575"><a href="#Store-575"><span class="linenos"> 575</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Store-576"><a href="#Store-576"><span class="linenos"> 576</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-577"><a href="#Store-577"><span class="linenos"> 577</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> acceptance(s) and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejection(s)&quot;</span><span class="p">)</span>
</span><span id="Store-578"><a href="#Store-578"><span class="linenos"> 578</span></a>                
</span><span id="Store-579"><a href="#Store-579"><span class="linenos"> 579</span></a>                <span class="c1"># Calculate scores for each warehouse that accepted</span>
</span><span id="Store-580"><a href="#Store-580"><span class="linenos"> 580</span></a>                <span class="n">best_warehouse</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Store-581"><a href="#Store-581"><span class="linenos"> 581</span></a>                <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="Store-582"><a href="#Store-582"><span class="linenos"> 582</span></a>                
</span><span id="Store-583"><a href="#Store-583"><span class="linenos"> 583</span></a>                
</span><span id="Store-584"><a href="#Store-584"><span class="linenos"> 584</span></a>                <span class="k">for</span> <span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Store-585"><a href="#Store-585"><span class="linenos"> 585</span></a>                    <span class="n">score</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">calculate_warehouse_score</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store-586"><a href="#Store-586"><span class="linenos"> 586</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-587"><a href="#Store-587"><span class="linenos"> 587</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Warehouse </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2"> score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-588"><a href="#Store-588"><span class="linenos"> 588</span></a>                    
</span><span id="Store-589"><a href="#Store-589"><span class="linenos"> 589</span></a>                    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">best_score</span><span class="p">:</span>
</span><span id="Store-590"><a href="#Store-590"><span class="linenos"> 590</span></a>                        <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
</span><span id="Store-591"><a href="#Store-591"><span class="linenos"> 591</span></a>                        <span class="n">best_warehouse</span> <span class="o">=</span> <span class="p">(</span><span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="Store-592"><a href="#Store-592"><span class="linenos"> 592</span></a>                
</span><span id="Store-593"><a href="#Store-593"><span class="linenos"> 593</span></a>                <span class="k">if</span> <span class="n">best_warehouse</span><span class="p">:</span>
</span><span id="Store-594"><a href="#Store-594"><span class="linenos"> 594</span></a>                    <span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="o">=</span> <span class="n">best_warehouse</span>
</span><span id="Store-595"><a href="#Store-595"><span class="linenos"> 595</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-596"><a href="#Store-596"><span class="linenos"> 596</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Selected warehouse </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2"> with score </span><span class="si">{</span><span class="n">best_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-597"><a href="#Store-597"><span class="linenos"> 597</span></a>                    
</span><span id="Store-598"><a href="#Store-598"><span class="linenos"> 598</span></a>                    <span class="c1"># Send confirmation to the chosen warehouse</span>
</span><span id="Store-599"><a href="#Store-599"><span class="linenos"> 599</span></a>                    <span class="n">confirm_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendStoreConfirmation</span><span class="p">(</span><span class="n">accept_msg</span><span class="p">)</span>
</span><span id="Store-600"><a href="#Store-600"><span class="linenos"> 600</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">confirm_behav</span><span class="p">)</span>
</span><span id="Store-601"><a href="#Store-601"><span class="linenos"> 601</span></a>                    <span class="k">await</span> <span class="n">confirm_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Store-602"><a href="#Store-602"><span class="linenos"> 602</span></a>                    
</span><span id="Store-603"><a href="#Store-603"><span class="linenos"> 603</span></a>                    <span class="c1"># Send denial to other warehouses that accepted but weren&#39;t chosen</span>
</span><span id="Store-604"><a href="#Store-604"><span class="linenos"> 604</span></a>                    <span class="k">for</span> <span class="n">other_warehouse_jid</span><span class="p">,</span> <span class="n">other_msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Store-605"><a href="#Store-605"><span class="linenos"> 605</span></a>                        <span class="k">if</span> <span class="n">other_warehouse_jid</span> <span class="o">!=</span> <span class="n">warehouse_jid</span><span class="p">:</span>
</span><span id="Store-606"><a href="#Store-606"><span class="linenos"> 606</span></a>                            <span class="n">deny_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendStoreDenial</span><span class="p">(</span><span class="n">other_msg</span><span class="p">)</span>
</span><span id="Store-607"><a href="#Store-607"><span class="linenos"> 607</span></a>                            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">deny_behav</span><span class="p">)</span>
</span><span id="Store-608"><a href="#Store-608"><span class="linenos"> 608</span></a>                            <span class="k">await</span> <span class="n">deny_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Store-609"><a href="#Store-609"><span class="linenos"> 609</span></a>                            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-610"><a href="#Store-610"><span class="linenos"> 610</span></a>                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent denial to </span><span class="si">{</span><span class="n">other_warehouse_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-611"><a href="#Store-611"><span class="linenos"> 611</span></a>                    
</span><span id="Store-612"><a href="#Store-612"><span class="linenos"> 612</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Store-613"><a href="#Store-613"><span class="linenos"> 613</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-614"><a href="#Store-614"><span class="linenos"> 614</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No acceptances received. All warehouses rejected or timed out.&quot;</span><span class="p">)</span>
</span><span id="Store-615"><a href="#Store-615"><span class="linenos"> 615</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Request saved in self.failed_requests&quot;</span><span class="p">)</span>
</span><span id="Store-616"><a href="#Store-616"><span class="linenos"> 616</span></a>                
</span><span id="Store-617"><a href="#Store-617"><span class="linenos"> 617</span></a>                <span class="c1"># Add to failed requests</span>
</span><span id="Store-618"><a href="#Store-618"><span class="linenos"> 618</span></a>                <span class="n">failed_msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span><span class="o">.</span><span class="n">to</span><span class="p">)</span>
</span><span id="Store-619"><a href="#Store-619"><span class="linenos"> 619</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">set_buy_metadata</span><span class="p">(</span><span class="n">failed_msg</span><span class="p">)</span>
</span><span id="Store-620"><a href="#Store-620"><span class="linenos"> 620</span></a>                <span class="n">failed_msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store-621"><a href="#Store-621"><span class="linenos"> 621</span></a>                <span class="n">failed_msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_msg</span>
</span><span id="Store-622"><a href="#Store-622"><span class="linenos"> 622</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">failed_msg</span><span class="p">)</span>
</span><span id="Store-623"><a href="#Store-623"><span class="linenos"> 623</span></a>
</span><span id="Store-624"><a href="#Store-624"><span class="linenos"> 624</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveAllResponses</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Store-625"><a href="#Store-625"><span class="linenos"> 625</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-626"><a href="#Store-626"><span class="linenos"> 626</span></a><span class="sd">        Worker behaviour for collecting warehouse responses in FIPA Contract Net Protocol.</span>
</span><span id="Store-627"><a href="#Store-627"><span class="linenos"> 627</span></a><span class="sd">        </span>
</span><span id="Store-628"><a href="#Store-628"><span class="linenos"> 628</span></a><span class="sd">        This behaviour acts as the worker component in a coordinator/worker pattern,</span>
</span><span id="Store-629"><a href="#Store-629"><span class="linenos"> 629</span></a><span class="sd">        handling the actual message reception during the proposal collection phase of</span>
</span><span id="Store-630"><a href="#Store-630"><span class="linenos"> 630</span></a><span class="sd">        the FIPA Contract Net Protocol. It listens for both proposals (warehouse-accept)</span>
</span><span id="Store-631"><a href="#Store-631"><span class="linenos"> 631</span></a><span class="sd">        and refusals (warehouse-reject) from warehouses, populating shared lists that</span>
</span><span id="Store-632"><a href="#Store-632"><span class="linenos"> 632</span></a><span class="sd">        the coordinator (CollectWarehouseResponses) will evaluate.</span>
</span><span id="Store-633"><a href="#Store-633"><span class="linenos"> 633</span></a><span class="sd">        </span>
</span><span id="Store-634"><a href="#Store-634"><span class="linenos"> 634</span></a><span class="sd">        FIPA Protocol Phase: **Proposal Reception**</span>
</span><span id="Store-635"><a href="#Store-635"><span class="linenos"> 635</span></a><span class="sd">            - Role: Participant response collector (worker)</span>
</span><span id="Store-636"><a href="#Store-636"><span class="linenos"> 636</span></a><span class="sd">            - Coordinator: CollectWarehouseResponses</span>
</span><span id="Store-637"><a href="#Store-637"><span class="linenos"> 637</span></a><span class="sd">            - Expected messages: warehouse-accept (propose) and warehouse-reject (refuse)</span>
</span><span id="Store-638"><a href="#Store-638"><span class="linenos"> 638</span></a><span class="sd">            - Timeout: 5 seconds total for all responses</span>
</span><span id="Store-639"><a href="#Store-639"><span class="linenos"> 639</span></a><span class="sd">        </span>
</span><span id="Store-640"><a href="#Store-640"><span class="linenos"> 640</span></a><span class="sd">        The behaviour implements a timeout mechanism to handle scenarios where some</span>
</span><span id="Store-641"><a href="#Store-641"><span class="linenos"> 641</span></a><span class="sd">        warehouses may be slow to respond or unavailable. It collects responses until</span>
</span><span id="Store-642"><a href="#Store-642"><span class="linenos"> 642</span></a><span class="sd">        either all expected warehouses respond or the timeout expires.</span>
</span><span id="Store-643"><a href="#Store-643"><span class="linenos"> 643</span></a><span class="sd">        </span>
</span><span id="Store-644"><a href="#Store-644"><span class="linenos"> 644</span></a><span class="sd">        Attributes:</span>
</span><span id="Store-645"><a href="#Store-645"><span class="linenos"> 645</span></a><span class="sd">            request_id (int): Unique request identifier for filtering messages.</span>
</span><span id="Store-646"><a href="#Store-646"><span class="linenos"> 646</span></a><span class="sd">                Ensures only responses for this specific CFP are processed.</span>
</span><span id="Store-647"><a href="#Store-647"><span class="linenos"> 647</span></a><span class="sd">            num_warehouses (int): Expected number of warehouse responses.</span>
</span><span id="Store-648"><a href="#Store-648"><span class="linenos"> 648</span></a><span class="sd">                Used to determine when collection is complete.</span>
</span><span id="Store-649"><a href="#Store-649"><span class="linenos"> 649</span></a><span class="sd">            acceptances (list[tuple[str, Message]]): Shared list with coordinator.</span>
</span><span id="Store-650"><a href="#Store-650"><span class="linenos"> 650</span></a><span class="sd">                Populated with (warehouse_jid, message) for each propose.</span>
</span><span id="Store-651"><a href="#Store-651"><span class="linenos"> 651</span></a><span class="sd">            rejections (list[tuple[str, Message, str]]): Shared list with coordinator.</span>
</span><span id="Store-652"><a href="#Store-652"><span class="linenos"> 652</span></a><span class="sd">                Populated with (warehouse_jid, message, reason) for each refuse.</span>
</span><span id="Store-653"><a href="#Store-653"><span class="linenos"> 653</span></a><span class="sd">            responses_received (int): Counter tracking received responses.</span>
</span><span id="Store-654"><a href="#Store-654"><span class="linenos"> 654</span></a><span class="sd">                Incremented for both accepts and rejects.</span>
</span><span id="Store-655"><a href="#Store-655"><span class="linenos"> 655</span></a><span class="sd">            timeout (int): Maximum seconds to wait for all responses (default: 5).</span>
</span><span id="Store-656"><a href="#Store-656"><span class="linenos"> 656</span></a><span class="sd">        </span>
</span><span id="Store-657"><a href="#Store-657"><span class="linenos"> 657</span></a><span class="sd">        Message Processing:</span>
</span><span id="Store-658"><a href="#Store-658"><span class="linenos"> 658</span></a><span class="sd">            - **warehouse-accept** (FIPA propose):</span>
</span><span id="Store-659"><a href="#Store-659"><span class="linenos"> 659</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-660"><a href="#Store-660"><span class="linenos"> 660</span></a><span class="sd">                Action: Append (warehouse_jid, msg) to acceptances</span>
</span><span id="Store-661"><a href="#Store-661"><span class="linenos"> 661</span></a><span class="sd">            </span>
</span><span id="Store-662"><a href="#Store-662"><span class="linenos"> 662</span></a><span class="sd">            - **warehouse-reject** (FIPA refuse):</span>
</span><span id="Store-663"><a href="#Store-663"><span class="linenos"> 663</span></a><span class="sd">                Body format: &quot;{quantity} {product} {reason}&quot;</span>
</span><span id="Store-664"><a href="#Store-664"><span class="linenos"> 664</span></a><span class="sd">                Action: Append (warehouse_jid, msg, reason) to rejections</span>
</span><span id="Store-665"><a href="#Store-665"><span class="linenos"> 665</span></a><span class="sd">        </span>
</span><span id="Store-666"><a href="#Store-666"><span class="linenos"> 666</span></a><span class="sd">        Timeout Logic:</span>
</span><span id="Store-667"><a href="#Store-667"><span class="linenos"> 667</span></a><span class="sd">            - Tracks elapsed time from start</span>
</span><span id="Store-668"><a href="#Store-668"><span class="linenos"> 668</span></a><span class="sd">            - Calculates remaining_timeout for each receive() call</span>
</span><span id="Store-669"><a href="#Store-669"><span class="linenos"> 669</span></a><span class="sd">            - Breaks early if remaining_timeout &lt;= 0</span>
</span><span id="Store-670"><a href="#Store-670"><span class="linenos"> 670</span></a><span class="sd">            - Allows partial responses (fewer than num_warehouses)</span>
</span><span id="Store-671"><a href="#Store-671"><span class="linenos"> 671</span></a><span class="sd">        </span>
</span><span id="Store-672"><a href="#Store-672"><span class="linenos"> 672</span></a><span class="sd">        Example Execution:</span>
</span><span id="Store-673"><a href="#Store-673"><span class="linenos"> 673</span></a><span class="sd">            ```</span>
</span><span id="Store-674"><a href="#Store-674"><span class="linenos"> 674</span></a><span class="sd">            Expected: 3 warehouses</span>
</span><span id="Store-675"><a href="#Store-675"><span class="linenos"> 675</span></a><span class="sd">            Timeline:</span>
</span><span id="Store-676"><a href="#Store-676"><span class="linenos"> 676</span></a><span class="sd">                t=0.5s: warehouse1 -&gt; accept (1/3 received)</span>
</span><span id="Store-677"><a href="#Store-677"><span class="linenos"> 677</span></a><span class="sd">                t=1.2s: warehouse2 -&gt; reject (2/3 received)</span>
</span><span id="Store-678"><a href="#Store-678"><span class="linenos"> 678</span></a><span class="sd">                t=5.0s: timeout reached (warehouse3 no response)</span>
</span><span id="Store-679"><a href="#Store-679"><span class="linenos"> 679</span></a><span class="sd">            Result:</span>
</span><span id="Store-680"><a href="#Store-680"><span class="linenos"> 680</span></a><span class="sd">                acceptances = [(warehouse1, msg1)]</span>
</span><span id="Store-681"><a href="#Store-681"><span class="linenos"> 681</span></a><span class="sd">                rejections = [(warehouse2, msg2, &quot;out_of_stock&quot;)]</span>
</span><span id="Store-682"><a href="#Store-682"><span class="linenos"> 682</span></a><span class="sd">                responses_received = 2</span>
</span><span id="Store-683"><a href="#Store-683"><span class="linenos"> 683</span></a><span class="sd">            ```</span>
</span><span id="Store-684"><a href="#Store-684"><span class="linenos"> 684</span></a><span class="sd">        </span>
</span><span id="Store-685"><a href="#Store-685"><span class="linenos"> 685</span></a><span class="sd">        Note:</span>
</span><span id="Store-686"><a href="#Store-686"><span class="linenos"> 686</span></a><span class="sd">            This worker behaviour uses shared list references (not copies) to communicate</span>
</span><span id="Store-687"><a href="#Store-687"><span class="linenos"> 687</span></a><span class="sd">            with the coordinator, following the coordinator/worker pattern for efficient</span>
</span><span id="Store-688"><a href="#Store-688"><span class="linenos"> 688</span></a><span class="sd">            data sharing between behaviours.</span>
</span><span id="Store-689"><a href="#Store-689"><span class="linenos"> 689</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-690"><a href="#Store-690"><span class="linenos"> 690</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_warehouses</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">acceptances</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">rejections</span> <span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Store-691"><a href="#Store-691"><span class="linenos"> 691</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-692"><a href="#Store-692"><span class="linenos"> 692</span></a><span class="sd">            Initialize the ReceiveAllResponses worker behaviour.</span>
</span><span id="Store-693"><a href="#Store-693"><span class="linenos"> 693</span></a><span class="sd">            </span>
</span><span id="Store-694"><a href="#Store-694"><span class="linenos"> 694</span></a><span class="sd">            Args:</span>
</span><span id="Store-695"><a href="#Store-695"><span class="linenos"> 695</span></a><span class="sd">                request_id (int): Unique request identifier from ID encoding system.</span>
</span><span id="Store-696"><a href="#Store-696"><span class="linenos"> 696</span></a><span class="sd">                    Used to filter incoming messages to only this CFP&#39;s responses.</span>
</span><span id="Store-697"><a href="#Store-697"><span class="linenos"> 697</span></a><span class="sd">                num_warehouses (int): Expected number of warehouse responses.</span>
</span><span id="Store-698"><a href="#Store-698"><span class="linenos"> 698</span></a><span class="sd">                    Used to determine when all responses received (early termination).</span>
</span><span id="Store-699"><a href="#Store-699"><span class="linenos"> 699</span></a><span class="sd">                acceptances (list[tuple[str, Message]]): Shared list reference with coordinator.</span>
</span><span id="Store-700"><a href="#Store-700"><span class="linenos"> 700</span></a><span class="sd">                    Worker appends (warehouse_jid, msg) for each warehouse-accept received.</span>
</span><span id="Store-701"><a href="#Store-701"><span class="linenos"> 701</span></a><span class="sd">                    Modifications visible to coordinator through shared reference.</span>
</span><span id="Store-702"><a href="#Store-702"><span class="linenos"> 702</span></a><span class="sd">                rejections (list[tuple[str, Message, str]]): Shared list reference with coordinator.</span>
</span><span id="Store-703"><a href="#Store-703"><span class="linenos"> 703</span></a><span class="sd">                    Worker appends (warehouse_jid, msg, reason) for each warehouse-reject.</span>
</span><span id="Store-704"><a href="#Store-704"><span class="linenos"> 704</span></a><span class="sd">                    Modifications visible to coordinator through shared reference.</span>
</span><span id="Store-705"><a href="#Store-705"><span class="linenos"> 705</span></a><span class="sd">            </span>
</span><span id="Store-706"><a href="#Store-706"><span class="linenos"> 706</span></a><span class="sd">            Note:</span>
</span><span id="Store-707"><a href="#Store-707"><span class="linenos"> 707</span></a><span class="sd">                Lists are shared by reference (mutable), enabling communication between</span>
</span><span id="Store-708"><a href="#Store-708"><span class="linenos"> 708</span></a><span class="sd">                worker and coordinator without explicit return values. This is a common</span>
</span><span id="Store-709"><a href="#Store-709"><span class="linenos"> 709</span></a><span class="sd">                pattern in concurrent programming with SPADE behaviours.</span>
</span><span id="Store-710"><a href="#Store-710"><span class="linenos"> 710</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-711"><a href="#Store-711"><span class="linenos"> 711</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Store-712"><a href="#Store-712"><span class="linenos"> 712</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Store-713"><a href="#Store-713"><span class="linenos"> 713</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span> <span class="o">=</span> <span class="n">num_warehouses</span>
</span><span id="Store-714"><a href="#Store-714"><span class="linenos"> 714</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="n">acceptances</span>  <span class="c1"># Shared list</span>
</span><span id="Store-715"><a href="#Store-715"><span class="linenos"> 715</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="n">rejections</span>    <span class="c1"># Shared list</span>
</span><span id="Store-716"><a href="#Store-716"><span class="linenos"> 716</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Store-717"><a href="#Store-717"><span class="linenos"> 717</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds to wait for all responses</span>
</span><span id="Store-718"><a href="#Store-718"><span class="linenos"> 718</span></a>            
</span><span id="Store-719"><a href="#Store-719"><span class="linenos"> 719</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store-720"><a href="#Store-720"><span class="linenos"> 720</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-721"><a href="#Store-721"><span class="linenos"> 721</span></a><span class="sd">            Execute the message collection loop for warehouse responses.</span>
</span><span id="Store-722"><a href="#Store-722"><span class="linenos"> 722</span></a><span class="sd">            </span>
</span><span id="Store-723"><a href="#Store-723"><span class="linenos"> 723</span></a><span class="sd">            This method implements the core collection logic for the FIPA Contract Net</span>
</span><span id="Store-724"><a href="#Store-724"><span class="linenos"> 724</span></a><span class="sd">            Protocol proposal reception phase. It continuously receives messages from</span>
</span><span id="Store-725"><a href="#Store-725"><span class="linenos"> 725</span></a><span class="sd">            warehouses until either all expected responses arrive or a timeout occurs,</span>
</span><span id="Store-726"><a href="#Store-726"><span class="linenos"> 726</span></a><span class="sd">            properly categorizing each response as either a proposal or refusal.</span>
</span><span id="Store-727"><a href="#Store-727"><span class="linenos"> 727</span></a><span class="sd">            </span>
</span><span id="Store-728"><a href="#Store-728"><span class="linenos"> 728</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Store-729"><a href="#Store-729"><span class="linenos"> 729</span></a><span class="sd">                - **Phase**: Proposal Reception (collecting propose/refuse messages)</span>
</span><span id="Store-730"><a href="#Store-730"><span class="linenos"> 730</span></a><span class="sd">                - **Role**: Worker (collects data for coordinator evaluation)</span>
</span><span id="Store-731"><a href="#Store-731"><span class="linenos"> 731</span></a><span class="sd">                - **Timeout**: 5 seconds total (not per message)</span>
</span><span id="Store-732"><a href="#Store-732"><span class="linenos"> 732</span></a><span class="sd">                - **Partial Completion**: Accepts fewer responses than expected</span>
</span><span id="Store-733"><a href="#Store-733"><span class="linenos"> 733</span></a><span class="sd">            </span>
</span><span id="Store-734"><a href="#Store-734"><span class="linenos"> 734</span></a><span class="sd">            Algorithm:</span>
</span><span id="Store-735"><a href="#Store-735"><span class="linenos"> 735</span></a><span class="sd">                1. **Initialization**: Record start time for timeout calculation</span>
</span><span id="Store-736"><a href="#Store-736"><span class="linenos"> 736</span></a><span class="sd">                2. **Collection Loop**: While responses_received &lt; num_warehouses:</span>
</span><span id="Store-737"><a href="#Store-737"><span class="linenos"> 737</span></a><span class="sd">                    a. Calculate remaining timeout based on elapsed time</span>
</span><span id="Store-738"><a href="#Store-738"><span class="linenos"> 738</span></a><span class="sd">                    b. Check for timeout expiration (remaining_timeout &lt;= 0)</span>
</span><span id="Store-739"><a href="#Store-739"><span class="linenos"> 739</span></a><span class="sd">                    c. Receive message with dynamically calculated timeout</span>
</span><span id="Store-740"><a href="#Store-740"><span class="linenos"> 740</span></a><span class="sd">                    d. Parse message: extract performative, sender, and body</span>
</span><span id="Store-741"><a href="#Store-741"><span class="linenos"> 741</span></a><span class="sd">                    e. Categorize as acceptance or rejection</span>
</span><span id="Store-742"><a href="#Store-742"><span class="linenos"> 742</span></a><span class="sd">                    f. Append to appropriate shared list</span>
</span><span id="Store-743"><a href="#Store-743"><span class="linenos"> 743</span></a><span class="sd">                    g. Increment responses_received counter</span>
</span><span id="Store-744"><a href="#Store-744"><span class="linenos"> 744</span></a><span class="sd">                3. **Termination**: Break on timeout or no more messages</span>
</span><span id="Store-745"><a href="#Store-745"><span class="linenos"> 745</span></a><span class="sd">            </span>
</span><span id="Store-746"><a href="#Store-746"><span class="linenos"> 746</span></a><span class="sd">            Message Processing:</span>
</span><span id="Store-747"><a href="#Store-747"><span class="linenos"> 747</span></a><span class="sd">            </span>
</span><span id="Store-748"><a href="#Store-748"><span class="linenos"> 748</span></a><span class="sd">                **warehouse-accept** (FIPA propose):</span>
</span><span id="Store-749"><a href="#Store-749"><span class="linenos"> 749</span></a><span class="sd">                    - Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-750"><a href="#Store-750"><span class="linenos"> 750</span></a><span class="sd">                    - Parsing: Split on space, extract quantity (int) and product (str)</span>
</span><span id="Store-751"><a href="#Store-751"><span class="linenos"> 751</span></a><span class="sd">                    - Action: Append (warehouse_jid, msg) to acceptances list</span>
</span><span id="Store-752"><a href="#Store-752"><span class="linenos"> 752</span></a><span class="sd">                    - Meaning: Warehouse agrees to fulfill order</span>
</span><span id="Store-753"><a href="#Store-753"><span class="linenos"> 753</span></a><span class="sd">                </span>
</span><span id="Store-754"><a href="#Store-754"><span class="linenos"> 754</span></a><span class="sd">                **warehouse-reject** (FIPA refuse):</span>
</span><span id="Store-755"><a href="#Store-755"><span class="linenos"> 755</span></a><span class="sd">                    - Body format: &quot;{quantity} {product} {reason}&quot;</span>
</span><span id="Store-756"><a href="#Store-756"><span class="linenos"> 756</span></a><span class="sd">                    - Parsing: Split on space, extract quantity, product, and optional reason</span>
</span><span id="Store-757"><a href="#Store-757"><span class="linenos"> 757</span></a><span class="sd">                    - Action: Append (warehouse_jid, msg, reason) to rejections list</span>
</span><span id="Store-758"><a href="#Store-758"><span class="linenos"> 758</span></a><span class="sd">                    - Default reason: &quot;unknown&quot; if not provided</span>
</span><span id="Store-759"><a href="#Store-759"><span class="linenos"> 759</span></a><span class="sd">                    - Meaning: Warehouse cannot or will not fulfill order</span>
</span><span id="Store-760"><a href="#Store-760"><span class="linenos"> 760</span></a><span class="sd">            </span>
</span><span id="Store-761"><a href="#Store-761"><span class="linenos"> 761</span></a><span class="sd">            Timeout Mechanism:</span>
</span><span id="Store-762"><a href="#Store-762"><span class="linenos"> 762</span></a><span class="sd">                - **Total Timeout**: 5 seconds from method start</span>
</span><span id="Store-763"><a href="#Store-763"><span class="linenos"> 763</span></a><span class="sd">                - **Dynamic Calculation**: remaining_timeout = total_timeout - elapsed_time</span>
</span><span id="Store-764"><a href="#Store-764"><span class="linenos"> 764</span></a><span class="sd">                - **Per-Message Timeout**: Each receive() uses remaining_timeout</span>
</span><span id="Store-765"><a href="#Store-765"><span class="linenos"> 765</span></a><span class="sd">                - **Early Termination**: Breaks immediately if remaining_timeout &lt;= 0</span>
</span><span id="Store-766"><a href="#Store-766"><span class="linenos"> 766</span></a><span class="sd">                - **Graceful Handling**: Allows partial responses without error</span>
</span><span id="Store-767"><a href="#Store-767"><span class="linenos"> 767</span></a><span class="sd">            </span>
</span><span id="Store-768"><a href="#Store-768"><span class="linenos"> 768</span></a><span class="sd">            Example Execution Timeline:</span>
</span><span id="Store-769"><a href="#Store-769"><span class="linenos"> 769</span></a><span class="sd">                ```</span>
</span><span id="Store-770"><a href="#Store-770"><span class="linenos"> 770</span></a><span class="sd">                t=0.0s: Start collection (expecting 3 responses)</span>
</span><span id="Store-771"><a href="#Store-771"><span class="linenos"> 771</span></a><span class="sd">                t=0.3s: Receive warehouse1 accept -&gt; acceptances.append()</span>
</span><span id="Store-772"><a href="#Store-772"><span class="linenos"> 772</span></a><span class="sd">                t=0.8s: Receive warehouse2 reject -&gt; rejections.append()</span>
</span><span id="Store-773"><a href="#Store-773"><span class="linenos"> 773</span></a><span class="sd">                t=5.0s: Timeout reached (warehouse3 silent)</span>
</span><span id="Store-774"><a href="#Store-774"><span class="linenos"> 774</span></a><span class="sd">                Result: 2/3 responses collected</span>
</span><span id="Store-775"><a href="#Store-775"><span class="linenos"> 775</span></a><span class="sd">                ```</span>
</span><span id="Store-776"><a href="#Store-776"><span class="linenos"> 776</span></a><span class="sd">            </span>
</span><span id="Store-777"><a href="#Store-777"><span class="linenos"> 777</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store-778"><a href="#Store-778"><span class="linenos"> 778</span></a><span class="sd">                - Populates self.acceptances shared list with proposals</span>
</span><span id="Store-779"><a href="#Store-779"><span class="linenos"> 779</span></a><span class="sd">                - Populates self.rejections shared list with refusals</span>
</span><span id="Store-780"><a href="#Store-780"><span class="linenos"> 780</span></a><span class="sd">                - Increments self.responses_received counter</span>
</span><span id="Store-781"><a href="#Store-781"><span class="linenos"> 781</span></a><span class="sd">                - Prints debug information if verbose mode enabled</span>
</span><span id="Store-782"><a href="#Store-782"><span class="linenos"> 782</span></a><span class="sd">                - May terminate early due to timeout</span>
</span><span id="Store-783"><a href="#Store-783"><span class="linenos"> 783</span></a><span class="sd">            </span>
</span><span id="Store-784"><a href="#Store-784"><span class="linenos"> 784</span></a><span class="sd">            Returns:</span>
</span><span id="Store-785"><a href="#Store-785"><span class="linenos"> 785</span></a><span class="sd">                None. Results communicated through shared list references.</span>
</span><span id="Store-786"><a href="#Store-786"><span class="linenos"> 786</span></a><span class="sd">            </span>
</span><span id="Store-787"><a href="#Store-787"><span class="linenos"> 787</span></a><span class="sd">            Note:</span>
</span><span id="Store-788"><a href="#Store-788"><span class="linenos"> 788</span></a><span class="sd">                The timeout is global (not per-message), ensuring the entire collection</span>
</span><span id="Store-789"><a href="#Store-789"><span class="linenos"> 789</span></a><span class="sd">                process completes within 5 seconds regardless of warehouse count. This</span>
</span><span id="Store-790"><a href="#Store-790"><span class="linenos"> 790</span></a><span class="sd">                prevents indefinite waiting when warehouses are unresponsive.</span>
</span><span id="Store-791"><a href="#Store-791"><span class="linenos"> 791</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-792"><a href="#Store-792"><span class="linenos"> 792</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store-793"><a href="#Store-793"><span class="linenos"> 793</span></a>            
</span><span id="Store-794"><a href="#Store-794"><span class="linenos"> 794</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="Store-795"><a href="#Store-795"><span class="linenos"> 795</span></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="Store-796"><a href="#Store-796"><span class="linenos"> 796</span></a>            
</span><span id="Store-797"><a href="#Store-797"><span class="linenos"> 797</span></a>            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span><span class="p">:</span>
</span><span id="Store-798"><a href="#Store-798"><span class="linenos"> 798</span></a>                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="Store-799"><a href="#Store-799"><span class="linenos"> 799</span></a>                <span class="n">remaining_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">-</span> <span class="n">elapsed</span>
</span><span id="Store-800"><a href="#Store-800"><span class="linenos"> 800</span></a>                
</span><span id="Store-801"><a href="#Store-801"><span class="linenos"> 801</span></a>                <span class="k">if</span> <span class="n">remaining_timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Store-802"><a href="#Store-802"><span class="linenos"> 802</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-803"><a href="#Store-803"><span class="linenos"> 803</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Timeout: Only received </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span><span class="si">}</span><span class="s2"> responses&quot;</span><span class="p">)</span>
</span><span id="Store-804"><a href="#Store-804"><span class="linenos"> 804</span></a>                    <span class="k">break</span>
</span><span id="Store-805"><a href="#Store-805"><span class="linenos"> 805</span></a>                
</span><span id="Store-806"><a href="#Store-806"><span class="linenos"> 806</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">remaining_timeout</span><span class="p">)</span>
</span><span id="Store-807"><a href="#Store-807"><span class="linenos"> 807</span></a>                
</span><span id="Store-808"><a href="#Store-808"><span class="linenos"> 808</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Store-809"><a href="#Store-809"><span class="linenos"> 809</span></a>                    <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Store-810"><a href="#Store-810"><span class="linenos"> 810</span></a>                    <span class="n">warehouse_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Store-811"><a href="#Store-811"><span class="linenos"> 811</span></a>                    
</span><span id="Store-812"><a href="#Store-812"><span class="linenos"> 812</span></a>                    <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;warehouse-accept&quot;</span><span class="p">:</span>
</span><span id="Store-813"><a href="#Store-813"><span class="linenos"> 813</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store-814"><a href="#Store-814"><span class="linenos"> 814</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store-815"><a href="#Store-815"><span class="linenos"> 815</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store-816"><a href="#Store-816"><span class="linenos"> 816</span></a>                        
</span><span id="Store-817"><a href="#Store-817"><span class="linenos"> 817</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-818"><a href="#Store-818"><span class="linenos"> 818</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received acceptance from </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-819"><a href="#Store-819"><span class="linenos"> 819</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
</span><span id="Store-820"><a href="#Store-820"><span class="linenos"> 820</span></a>                        
</span><span id="Store-821"><a href="#Store-821"><span class="linenos"> 821</span></a>                    <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;warehouse-reject&quot;</span><span class="p">:</span>
</span><span id="Store-822"><a href="#Store-822"><span class="linenos"> 822</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store-823"><a href="#Store-823"><span class="linenos"> 823</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store-824"><a href="#Store-824"><span class="linenos"> 824</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store-825"><a href="#Store-825"><span class="linenos"> 825</span></a>                        <span class="n">reason</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
</span><span id="Store-826"><a href="#Store-826"><span class="linenos"> 826</span></a>                        
</span><span id="Store-827"><a href="#Store-827"><span class="linenos"> 827</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-828"><a href="#Store-828"><span class="linenos"> 828</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received rejection from </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> (reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Store-829"><a href="#Store-829"><span class="linenos"> 829</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
</span><span id="Store-830"><a href="#Store-830"><span class="linenos"> 830</span></a>                    
</span><span id="Store-831"><a href="#Store-831"><span class="linenos"> 831</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Store-832"><a href="#Store-832"><span class="linenos"> 832</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Store-833"><a href="#Store-833"><span class="linenos"> 833</span></a>                    <span class="c1"># No more messages, timeout</span>
</span><span id="Store-834"><a href="#Store-834"><span class="linenos"> 834</span></a>                    <span class="k">break</span>
</span><span id="Store-835"><a href="#Store-835"><span class="linenos"> 835</span></a>            
</span><span id="Store-836"><a href="#Store-836"><span class="linenos"> 836</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-837"><a href="#Store-837"><span class="linenos"> 837</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Finished collecting responses: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> accepts, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejects&quot;</span><span class="p">)</span>
</span><span id="Store-838"><a href="#Store-838"><span class="linenos"> 838</span></a>
</span><span id="Store-839"><a href="#Store-839"><span class="linenos"> 839</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SendStoreConfirmation</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Store-840"><a href="#Store-840"><span class="linenos"> 840</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-841"><a href="#Store-841"><span class="linenos"> 841</span></a><span class="sd">        Behaviour to send confirmation to the selected warehouse (FIPA accept-proposal).</span>
</span><span id="Store-842"><a href="#Store-842"><span class="linenos"> 842</span></a><span class="sd">        </span>
</span><span id="Store-843"><a href="#Store-843"><span class="linenos"> 843</span></a><span class="sd">        This behaviour implements the award notification phase of the FIPA Contract Net</span>
</span><span id="Store-844"><a href="#Store-844"><span class="linenos"> 844</span></a><span class="sd">        Protocol, informing the winning warehouse that its proposal has been accepted.</span>
</span><span id="Store-845"><a href="#Store-845"><span class="linenos"> 845</span></a><span class="sd">        It sends the FIPA accept-proposal message and registers the order as pending</span>
</span><span id="Store-846"><a href="#Store-846"><span class="linenos"> 846</span></a><span class="sd">        delivery, waiting for a vehicle to transport the goods.</span>
</span><span id="Store-847"><a href="#Store-847"><span class="linenos"> 847</span></a><span class="sd">        </span>
</span><span id="Store-848"><a href="#Store-848"><span class="linenos"> 848</span></a><span class="sd">        FIPA Protocol Phase: **Result Notification - Award**</span>
</span><span id="Store-849"><a href="#Store-849"><span class="linenos"> 849</span></a><span class="sd">            - Performative: store-confirm (FIPA accept-proposal)</span>
</span><span id="Store-850"><a href="#Store-850"><span class="linenos"> 850</span></a><span class="sd">            - Recipient: Selected warehouse (winner of proposal evaluation)</span>
</span><span id="Store-851"><a href="#Store-851"><span class="linenos"> 851</span></a><span class="sd">            - Purpose: Officially award the contract to the best proposal</span>
</span><span id="Store-852"><a href="#Store-852"><span class="linenos"> 852</span></a><span class="sd">            - Protocol: FIPA Contract Net Protocol</span>
</span><span id="Store-853"><a href="#Store-853"><span class="linenos"> 853</span></a><span class="sd">        </span>
</span><span id="Store-854"><a href="#Store-854"><span class="linenos"> 854</span></a><span class="sd">        This behaviour does NOT update stock immediately. Stock updates occur only when</span>
</span><span id="Store-855"><a href="#Store-855"><span class="linenos"> 855</span></a><span class="sd">        the vehicle delivers the products (upon receiving vehicle-delivery message).</span>
</span><span id="Store-856"><a href="#Store-856"><span class="linenos"> 856</span></a><span class="sd">        This design accurately models real-world supply chains where confirmation precedes</span>
</span><span id="Store-857"><a href="#Store-857"><span class="linenos"> 857</span></a><span class="sd">        actual inventory arrival.</span>
</span><span id="Store-858"><a href="#Store-858"><span class="linenos"> 858</span></a><span class="sd">        </span>
</span><span id="Store-859"><a href="#Store-859"><span class="linenos"> 859</span></a><span class="sd">        Attributes:</span>
</span><span id="Store-860"><a href="#Store-860"><span class="linenos"> 860</span></a><span class="sd">            dest (str): Warehouse JID (winner&#39;s address).</span>
</span><span id="Store-861"><a href="#Store-861"><span class="linenos"> 861</span></a><span class="sd">            request_id (str): Unique request identifier from original CFP.</span>
</span><span id="Store-862"><a href="#Store-862"><span class="linenos"> 862</span></a><span class="sd">            quantity (int): Quantity of product in the confirmed order.</span>
</span><span id="Store-863"><a href="#Store-863"><span class="linenos"> 863</span></a><span class="sd">            product (str): Name of product in the confirmed order.</span>
</span><span id="Store-864"><a href="#Store-864"><span class="linenos"> 864</span></a><span class="sd">            msg (Message): Original warehouse-accept message (for Order conversion).</span>
</span><span id="Store-865"><a href="#Store-865"><span class="linenos"> 865</span></a><span class="sd">        </span>
</span><span id="Store-866"><a href="#Store-866"><span class="linenos"> 866</span></a><span class="sd">        Message Format (FIPA accept-proposal):</span>
</span><span id="Store-867"><a href="#Store-867"><span class="linenos"> 867</span></a><span class="sd">            Metadata:</span>
</span><span id="Store-868"><a href="#Store-868"><span class="linenos"> 868</span></a><span class="sd">                - performative: &quot;store-confirm&quot; (FIPA accept-proposal)</span>
</span><span id="Store-869"><a href="#Store-869"><span class="linenos"> 869</span></a><span class="sd">                - warehouse_id: Destination warehouse JID</span>
</span><span id="Store-870"><a href="#Store-870"><span class="linenos"> 870</span></a><span class="sd">                - store_id: This store&#39;s JID</span>
</span><span id="Store-871"><a href="#Store-871"><span class="linenos"> 871</span></a><span class="sd">                - node_id: This store&#39;s graph location</span>
</span><span id="Store-872"><a href="#Store-872"><span class="linenos"> 872</span></a><span class="sd">                - request_id: Original CFP request identifier</span>
</span><span id="Store-873"><a href="#Store-873"><span class="linenos"> 873</span></a><span class="sd">            Body:</span>
</span><span id="Store-874"><a href="#Store-874"><span class="linenos"> 874</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-875"><a href="#Store-875"><span class="linenos"> 875</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="Store-876"><a href="#Store-876"><span class="linenos"> 876</span></a><span class="sd">        </span>
</span><span id="Store-877"><a href="#Store-877"><span class="linenos"> 877</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store-878"><a href="#Store-878"><span class="linenos"> 878</span></a><span class="sd">            - Converts message to Order object using message_to_order()</span>
</span><span id="Store-879"><a href="#Store-879"><span class="linenos"> 879</span></a><span class="sd">            - Adds order to agent.pending_deliveries dict (key: order_id)</span>
</span><span id="Store-880"><a href="#Store-880"><span class="linenos"> 880</span></a><span class="sd">            - Records confirmation timestamp in agent.order_timings (for statistics)</span>
</span><span id="Store-881"><a href="#Store-881"><span class="linenos"> 881</span></a><span class="sd">            - Sends store-confirm message to warehouse</span>
</span><span id="Store-882"><a href="#Store-882"><span class="linenos"> 882</span></a><span class="sd">            - Prints confirmation details (always visible, not verbose-only)</span>
</span><span id="Store-883"><a href="#Store-883"><span class="linenos"> 883</span></a><span class="sd">        </span>
</span><span id="Store-884"><a href="#Store-884"><span class="linenos"> 884</span></a><span class="sd">        Workflow:</span>
</span><span id="Store-885"><a href="#Store-885"><span class="linenos"> 885</span></a><span class="sd">            1. Convert warehouse-accept message to Order object</span>
</span><span id="Store-886"><a href="#Store-886"><span class="linenos"> 886</span></a><span class="sd">            2. Register order in pending_deliveries (awaiting vehicle)</span>
</span><span id="Store-887"><a href="#Store-887"><span class="linenos"> 887</span></a><span class="sd">            3. Record current tick in order_timings (for time-to-delivery calculation)</span>
</span><span id="Store-888"><a href="#Store-888"><span class="linenos"> 888</span></a><span class="sd">            4. Construct store-confirm message with proper metadata</span>
</span><span id="Store-889"><a href="#Store-889"><span class="linenos"> 889</span></a><span class="sd">            5. Send confirmation to warehouse</span>
</span><span id="Store-890"><a href="#Store-890"><span class="linenos"> 890</span></a><span class="sd">            6. Print success message with order details</span>
</span><span id="Store-891"><a href="#Store-891"><span class="linenos"> 891</span></a><span class="sd">        </span>
</span><span id="Store-892"><a href="#Store-892"><span class="linenos"> 892</span></a><span class="sd">        Example:</span>
</span><span id="Store-893"><a href="#Store-893"><span class="linenos"> 893</span></a><span class="sd">            ```</span>
</span><span id="Store-894"><a href="#Store-894"><span class="linenos"> 894</span></a><span class="sd">            Warehouse: warehouse2@localhost</span>
</span><span id="Store-895"><a href="#Store-895"><span class="linenos"> 895</span></a><span class="sd">            Request: &quot;50 electronics&quot; (ID: 1001000000)</span>
</span><span id="Store-896"><a href="#Store-896"><span class="linenos"> 896</span></a><span class="sd">            Action: Send store-confirm to warehouse2</span>
</span><span id="Store-897"><a href="#Store-897"><span class="linenos"> 897</span></a><span class="sd">            Result: Order 1001000000 pending delivery</span>
</span><span id="Store-898"><a href="#Store-898"><span class="linenos"> 898</span></a><span class="sd">            Print: &quot;Successfully bought 50 xelectronics from warehouse2...&quot;</span>
</span><span id="Store-899"><a href="#Store-899"><span class="linenos"> 899</span></a><span class="sd">            ```</span>
</span><span id="Store-900"><a href="#Store-900"><span class="linenos"> 900</span></a><span class="sd">        </span>
</span><span id="Store-901"><a href="#Store-901"><span class="linenos"> 901</span></a><span class="sd">        Note:</span>
</span><span id="Store-902"><a href="#Store-902"><span class="linenos"> 902</span></a><span class="sd">            The confirmation message triggers the warehouse to assign a vehicle for</span>
</span><span id="Store-903"><a href="#Store-903"><span class="linenos"> 903</span></a><span class="sd">            delivery. The store then waits for vehicle-delivery message to update stock.</span>
</span><span id="Store-904"><a href="#Store-904"><span class="linenos"> 904</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-905"><a href="#Store-905"><span class="linenos"> 905</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Store-906"><a href="#Store-906"><span class="linenos"> 906</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-907"><a href="#Store-907"><span class="linenos"> 907</span></a><span class="sd">            Initialize the SendStoreConfirmation behaviour.</span>
</span><span id="Store-908"><a href="#Store-908"><span class="linenos"> 908</span></a><span class="sd">            </span>
</span><span id="Store-909"><a href="#Store-909"><span class="linenos"> 909</span></a><span class="sd">            Args:</span>
</span><span id="Store-910"><a href="#Store-910"><span class="linenos"> 910</span></a><span class="sd">                msg (Message): The warehouse-accept message from the winning warehouse.</span>
</span><span id="Store-911"><a href="#Store-911"><span class="linenos"> 911</span></a><span class="sd">                    Contains all necessary information: sender, request_id, quantity, product.</span>
</span><span id="Store-912"><a href="#Store-912"><span class="linenos"> 912</span></a><span class="sd">                    Used to construct the confirmation message and create Order object.</span>
</span><span id="Store-913"><a href="#Store-913"><span class="linenos"> 913</span></a><span class="sd">            </span>
</span><span id="Store-914"><a href="#Store-914"><span class="linenos"> 914</span></a><span class="sd">            Note:</span>
</span><span id="Store-915"><a href="#Store-915"><span class="linenos"> 915</span></a><span class="sd">                Extracts and stores all relevant fields from the message for use in run().</span>
</span><span id="Store-916"><a href="#Store-916"><span class="linenos"> 916</span></a><span class="sd">                The original message is preserved for Order object conversion.</span>
</span><span id="Store-917"><a href="#Store-917"><span class="linenos"> 917</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-918"><a href="#Store-918"><span class="linenos"> 918</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Store-919"><a href="#Store-919"><span class="linenos"> 919</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Store-920"><a href="#Store-920"><span class="linenos"> 920</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Store-921"><a href="#Store-921"><span class="linenos"> 921</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store-922"><a href="#Store-922"><span class="linenos"> 922</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store-923"><a href="#Store-923"><span class="linenos"> 923</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store-924"><a href="#Store-924"><span class="linenos"> 924</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="Store-925"><a href="#Store-925"><span class="linenos"> 925</span></a>            
</span><span id="Store-926"><a href="#Store-926"><span class="linenos"> 926</span></a>        
</span><span id="Store-927"><a href="#Store-927"><span class="linenos"> 927</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store-928"><a href="#Store-928"><span class="linenos"> 928</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-929"><a href="#Store-929"><span class="linenos"> 929</span></a><span class="sd">            Execute the confirmation sending process (FIPA accept-proposal).</span>
</span><span id="Store-930"><a href="#Store-930"><span class="linenos"> 930</span></a><span class="sd">            </span>
</span><span id="Store-931"><a href="#Store-931"><span class="linenos"> 931</span></a><span class="sd">            This method sends the FIPA accept-proposal message to the winning warehouse,</span>
</span><span id="Store-932"><a href="#Store-932"><span class="linenos"> 932</span></a><span class="sd">            registers the order as pending delivery, and records timing information for</span>
</span><span id="Store-933"><a href="#Store-933"><span class="linenos"> 933</span></a><span class="sd">            statistics. It implements the award notification phase of the FIPA Contract</span>
</span><span id="Store-934"><a href="#Store-934"><span class="linenos"> 934</span></a><span class="sd">            Net Protocol.</span>
</span><span id="Store-935"><a href="#Store-935"><span class="linenos"> 935</span></a><span class="sd">            </span>
</span><span id="Store-936"><a href="#Store-936"><span class="linenos"> 936</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Store-937"><a href="#Store-937"><span class="linenos"> 937</span></a><span class="sd">                - **Phase**: Result Notification - Award</span>
</span><span id="Store-938"><a href="#Store-938"><span class="linenos"> 938</span></a><span class="sd">                - **Performative**: store-confirm (FIPA accept-proposal)</span>
</span><span id="Store-939"><a href="#Store-939"><span class="linenos"> 939</span></a><span class="sd">                - **Meaning**: &quot;Your proposal is accepted, prepare the order&quot;</span>
</span><span id="Store-940"><a href="#Store-940"><span class="linenos"> 940</span></a><span class="sd">                - **Expected Response**: Warehouse assigns vehicle for delivery</span>
</span><span id="Store-941"><a href="#Store-941"><span class="linenos"> 941</span></a><span class="sd">            </span>
</span><span id="Store-942"><a href="#Store-942"><span class="linenos"> 942</span></a><span class="sd">            Important Design Decision:</span>
</span><span id="Store-943"><a href="#Store-943"><span class="linenos"> 943</span></a><span class="sd">                Stock is NOT updated immediately upon confirmation. Stock updates occur</span>
</span><span id="Store-944"><a href="#Store-944"><span class="linenos"> 944</span></a><span class="sd">                only when the vehicle delivers the products (vehicle-delivery message).</span>
</span><span id="Store-945"><a href="#Store-945"><span class="linenos"> 945</span></a><span class="sd">                This accurately models real-world logistics where confirmation  possession.</span>
</span><span id="Store-946"><a href="#Store-946"><span class="linenos"> 946</span></a><span class="sd">            </span>
</span><span id="Store-947"><a href="#Store-947"><span class="linenos"> 947</span></a><span class="sd">            Workflow:</span>
</span><span id="Store-948"><a href="#Store-948"><span class="linenos"> 948</span></a><span class="sd">                1. **Order Conversion**: Convert warehouse-accept message to Order object</span>
</span><span id="Store-949"><a href="#Store-949"><span class="linenos"> 949</span></a><span class="sd">                    - Extracts: product, quantity, orderid, sender, receiver, locations</span>
</span><span id="Store-950"><a href="#Store-950"><span class="linenos"> 950</span></a><span class="sd">                    - Uses message_to_order() helper method</span>
</span><span id="Store-951"><a href="#Store-951"><span class="linenos"> 951</span></a><span class="sd">                </span>
</span><span id="Store-952"><a href="#Store-952"><span class="linenos"> 952</span></a><span class="sd">                2. **Order Registration**: Add to pending_deliveries dict</span>
</span><span id="Store-953"><a href="#Store-953"><span class="linenos"> 953</span></a><span class="sd">                    - Key: order.orderid (unique request ID)</span>
</span><span id="Store-954"><a href="#Store-954"><span class="linenos"> 954</span></a><span class="sd">                    - Value: Order object with full details</span>
</span><span id="Store-955"><a href="#Store-955"><span class="linenos"> 955</span></a><span class="sd">                    - Purpose: Track orders awaiting vehicle delivery</span>
</span><span id="Store-956"><a href="#Store-956"><span class="linenos"> 956</span></a><span class="sd">                </span>
</span><span id="Store-957"><a href="#Store-957"><span class="linenos"> 957</span></a><span class="sd">                3. **Timing Record**: Store current tick in order_timings</span>
</span><span id="Store-958"><a href="#Store-958"><span class="linenos"> 958</span></a><span class="sd">                    - Key: order.orderid</span>
</span><span id="Store-959"><a href="#Store-959"><span class="linenos"> 959</span></a><span class="sd">                    - Value: agent.current_tick (simulation time)</span>
</span><span id="Store-960"><a href="#Store-960"><span class="linenos"> 960</span></a><span class="sd">                    - Purpose: Calculate time-to-delivery for statistics</span>
</span><span id="Store-961"><a href="#Store-961"><span class="linenos"> 961</span></a><span class="sd">                </span>
</span><span id="Store-962"><a href="#Store-962"><span class="linenos"> 962</span></a><span class="sd">                4. **Message Construction**: Build store-confirm message</span>
</span><span id="Store-963"><a href="#Store-963"><span class="linenos"> 963</span></a><span class="sd">                    - Performative: store-confirm (FIPA accept-proposal)</span>
</span><span id="Store-964"><a href="#Store-964"><span class="linenos"> 964</span></a><span class="sd">                    - Metadata: warehouse_id, store_id, node_id, request_id</span>
</span><span id="Store-965"><a href="#Store-965"><span class="linenos"> 965</span></a><span class="sd">                    - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-966"><a href="#Store-966"><span class="linenos"> 966</span></a><span class="sd">                </span>
</span><span id="Store-967"><a href="#Store-967"><span class="linenos"> 967</span></a><span class="sd">                5. **Message Transmission**: Send confirmation to warehouse</span>
</span><span id="Store-968"><a href="#Store-968"><span class="linenos"> 968</span></a><span class="sd">                    - Triggers warehouse to assign vehicle</span>
</span><span id="Store-969"><a href="#Store-969"><span class="linenos"> 969</span></a><span class="sd">                    - Initiates delivery logistics process</span>
</span><span id="Store-970"><a href="#Store-970"><span class="linenos"> 970</span></a><span class="sd">                </span>
</span><span id="Store-971"><a href="#Store-971"><span class="linenos"> 971</span></a><span class="sd">                6. **Status Logging**: Print confirmation details</span>
</span><span id="Store-972"><a href="#Store-972"><span class="linenos"> 972</span></a><span class="sd">                    - Verbose message: Confirmation sent details</span>
</span><span id="Store-973"><a href="#Store-973"><span class="linenos"> 973</span></a><span class="sd">                    - Essential message: Order success with order ID</span>
</span><span id="Store-974"><a href="#Store-974"><span class="linenos"> 974</span></a><span class="sd">            </span>
</span><span id="Store-975"><a href="#Store-975"><span class="linenos"> 975</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store-976"><a href="#Store-976"><span class="linenos"> 976</span></a><span class="sd">                - Modifies agent.pending_deliveries (adds order)</span>
</span><span id="Store-977"><a href="#Store-977"><span class="linenos"> 977</span></a><span class="sd">                - Modifies agent.order_timings (records timestamp)</span>
</span><span id="Store-978"><a href="#Store-978"><span class="linenos"> 978</span></a><span class="sd">                - Sends SPADE message to warehouse</span>
</span><span id="Store-979"><a href="#Store-979"><span class="linenos"> 979</span></a><span class="sd">                - Prints status information to console</span>
</span><span id="Store-980"><a href="#Store-980"><span class="linenos"> 980</span></a><span class="sd">            </span>
</span><span id="Store-981"><a href="#Store-981"><span class="linenos"> 981</span></a><span class="sd">            Returns:</span>
</span><span id="Store-982"><a href="#Store-982"><span class="linenos"> 982</span></a><span class="sd">                None. Completes when confirmation message is sent.</span>
</span><span id="Store-983"><a href="#Store-983"><span class="linenos"> 983</span></a><span class="sd">            </span>
</span><span id="Store-984"><a href="#Store-984"><span class="linenos"> 984</span></a><span class="sd">            Example Execution:</span>
</span><span id="Store-985"><a href="#Store-985"><span class="linenos"> 985</span></a><span class="sd">                ```</span>
</span><span id="Store-986"><a href="#Store-986"><span class="linenos"> 986</span></a><span class="sd">                Input: warehouse-accept from warehouse2</span>
</span><span id="Store-987"><a href="#Store-987"><span class="linenos"> 987</span></a><span class="sd">                    Body: &quot;50 electronics&quot;</span>
</span><span id="Store-988"><a href="#Store-988"><span class="linenos"> 988</span></a><span class="sd">                    request_id: 1001000000</span>
</span><span id="Store-989"><a href="#Store-989"><span class="linenos"> 989</span></a><span class="sd">                Processing:</span>
</span><span id="Store-990"><a href="#Store-990"><span class="linenos"> 990</span></a><span class="sd">                    - Create Order(orderid=1001000000, quantity=50, product=&quot;electronics&quot;)</span>
</span><span id="Store-991"><a href="#Store-991"><span class="linenos"> 991</span></a><span class="sd">                    - pending_deliveries[1001000000] = Order(...)</span>
</span><span id="Store-992"><a href="#Store-992"><span class="linenos"> 992</span></a><span class="sd">                    - order_timings[1001000000] = 42 (current tick)</span>
</span><span id="Store-993"><a href="#Store-993"><span class="linenos"> 993</span></a><span class="sd">                Output:</span>
</span><span id="Store-994"><a href="#Store-994"><span class="linenos"> 994</span></a><span class="sd">                    - Send store-confirm to warehouse2</span>
</span><span id="Store-995"><a href="#Store-995"><span class="linenos"> 995</span></a><span class="sd">                    - Print: &quot;Successfully bought 50 xelectronics from warehouse2 under order id 1001000000&quot;</span>
</span><span id="Store-996"><a href="#Store-996"><span class="linenos"> 996</span></a><span class="sd">                ```</span>
</span><span id="Store-997"><a href="#Store-997"><span class="linenos"> 997</span></a><span class="sd">            </span>
</span><span id="Store-998"><a href="#Store-998"><span class="linenos"> 998</span></a><span class="sd">            Note:</span>
</span><span id="Store-999"><a href="#Store-999"><span class="linenos"> 999</span></a><span class="sd">                The order remains in pending_deliveries until ReceiveVehicleArrival</span>
</span><span id="Store-1000"><a href="#Store-1000"><span class="linenos">1000</span></a><span class="sd">                processes the vehicle-delivery message and updates stock. This maintains</span>
</span><span id="Store-1001"><a href="#Store-1001"><span class="linenos">1001</span></a><span class="sd">                separation between contract award and physical delivery.</span>
</span><span id="Store-1002"><a href="#Store-1002"><span class="linenos">1002</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-1003"><a href="#Store-1003"><span class="linenos">1003</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store-1004"><a href="#Store-1004"><span class="linenos">1004</span></a>            
</span><span id="Store-1005"><a href="#Store-1005"><span class="linenos">1005</span></a>            <span class="c1"># Don&#39;t update stock here - wait for vehicle delivery</span>
</span><span id="Store-1006"><a href="#Store-1006"><span class="linenos">1006</span></a>            <span class="c1"># Stock will be updated when vehicle-delivery message is received</span>
</span><span id="Store-1007"><a href="#Store-1007"><span class="linenos">1007</span></a>            <span class="n">order</span> <span class="p">:</span> <span class="n">Order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">message_to_order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store-1008"><a href="#Store-1008"><span class="linenos">1008</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
</span><span id="Store-1009"><a href="#Store-1009"><span class="linenos">1009</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">order_timings</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">current_tick</span>
</span><span id="Store-1010"><a href="#Store-1010"><span class="linenos">1010</span></a>            
</span><span id="Store-1011"><a href="#Store-1011"><span class="linenos">1011</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="Store-1012"><a href="#Store-1012"><span class="linenos">1012</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-confirm&quot;</span><span class="p">)</span>
</span><span id="Store-1013"><a href="#Store-1013"><span class="linenos">1013</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="Store-1014"><a href="#Store-1014"><span class="linenos">1014</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store-1015"><a href="#Store-1015"><span class="linenos">1015</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Store-1016"><a href="#Store-1016"><span class="linenos">1016</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store-1017"><a href="#Store-1017"><span class="linenos">1017</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Store-1018"><a href="#Store-1018"><span class="linenos">1018</span></a>            
</span><span id="Store-1019"><a href="#Store-1019"><span class="linenos">1019</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store-1020"><a href="#Store-1020"><span class="linenos">1020</span></a>            
</span><span id="Store-1021"><a href="#Store-1021"><span class="linenos">1021</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-1022"><a href="#Store-1022"><span class="linenos">1022</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Confirmation sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-1023"><a href="#Store-1023"><span class="linenos">1023</span></a>            
</span><span id="Store-1024"><a href="#Store-1024"><span class="linenos">1024</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Successully bought </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> under order id </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-1025"><a href="#Store-1025"><span class="linenos">1025</span></a>
</span><span id="Store-1026"><a href="#Store-1026"><span class="linenos">1026</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SendStoreDenial</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Store-1027"><a href="#Store-1027"><span class="linenos">1027</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1028"><a href="#Store-1028"><span class="linenos">1028</span></a><span class="sd">        Behaviour to send rejection to non-selected warehouses (FIPA reject-proposal).</span>
</span><span id="Store-1029"><a href="#Store-1029"><span class="linenos">1029</span></a><span class="sd">        </span>
</span><span id="Store-1030"><a href="#Store-1030"><span class="linenos">1030</span></a><span class="sd">        This behaviour implements the rejection notification phase of the FIPA Contract</span>
</span><span id="Store-1031"><a href="#Store-1031"><span class="linenos">1031</span></a><span class="sd">        Net Protocol, informing warehouses that submitted proposals that their bids were</span>
</span><span id="Store-1032"><a href="#Store-1032"><span class="linenos">1032</span></a><span class="sd">        not selected. This is an essential part of the protocol, providing feedback to</span>
</span><span id="Store-1033"><a href="#Store-1033"><span class="linenos">1033</span></a><span class="sd">        all participants about the outcome of the negotiation.</span>
</span><span id="Store-1034"><a href="#Store-1034"><span class="linenos">1034</span></a><span class="sd">        </span>
</span><span id="Store-1035"><a href="#Store-1035"><span class="linenos">1035</span></a><span class="sd">        FIPA Protocol Phase: **Result Notification - Rejection**</span>
</span><span id="Store-1036"><a href="#Store-1036"><span class="linenos">1036</span></a><span class="sd">            - Performative: store-deny (FIPA reject-proposal)</span>
</span><span id="Store-1037"><a href="#Store-1037"><span class="linenos">1037</span></a><span class="sd">            - Recipients: Warehouses that proposed but were not selected</span>
</span><span id="Store-1038"><a href="#Store-1038"><span class="linenos">1038</span></a><span class="sd">            - Purpose: Inform participants their proposal was rejected</span>
</span><span id="Store-1039"><a href="#Store-1039"><span class="linenos">1039</span></a><span class="sd">            - Protocol: FIPA Contract Net Protocol</span>
</span><span id="Store-1040"><a href="#Store-1040"><span class="linenos">1040</span></a><span class="sd">            - Note: Warehouses that refused (warehouse-reject) do NOT receive this</span>
</span><span id="Store-1041"><a href="#Store-1041"><span class="linenos">1041</span></a><span class="sd">        </span>
</span><span id="Store-1042"><a href="#Store-1042"><span class="linenos">1042</span></a><span class="sd">        This message allows warehouses to release any resources they may have reserved</span>
</span><span id="Store-1043"><a href="#Store-1043"><span class="linenos">1043</span></a><span class="sd">        for this order and update their internal state accordingly.</span>
</span><span id="Store-1044"><a href="#Store-1044"><span class="linenos">1044</span></a><span class="sd">        </span>
</span><span id="Store-1045"><a href="#Store-1045"><span class="linenos">1045</span></a><span class="sd">        Attributes:</span>
</span><span id="Store-1046"><a href="#Store-1046"><span class="linenos">1046</span></a><span class="sd">            dest (str): Warehouse JID (non-selected participant&#39;s address).</span>
</span><span id="Store-1047"><a href="#Store-1047"><span class="linenos">1047</span></a><span class="sd">            request_id (str): Unique request identifier from original CFP.</span>
</span><span id="Store-1048"><a href="#Store-1048"><span class="linenos">1048</span></a><span class="sd">            quantity (int): Quantity of product in the rejected order.</span>
</span><span id="Store-1049"><a href="#Store-1049"><span class="linenos">1049</span></a><span class="sd">            product (str): Name of product in the rejected order.</span>
</span><span id="Store-1050"><a href="#Store-1050"><span class="linenos">1050</span></a><span class="sd">        </span>
</span><span id="Store-1051"><a href="#Store-1051"><span class="linenos">1051</span></a><span class="sd">        Message Format (FIPA reject-proposal):</span>
</span><span id="Store-1052"><a href="#Store-1052"><span class="linenos">1052</span></a><span class="sd">            Metadata:</span>
</span><span id="Store-1053"><a href="#Store-1053"><span class="linenos">1053</span></a><span class="sd">                - performative: &quot;store-deny&quot; (FIPA reject-proposal)</span>
</span><span id="Store-1054"><a href="#Store-1054"><span class="linenos">1054</span></a><span class="sd">                - warehouse_id: Destination warehouse JID</span>
</span><span id="Store-1055"><a href="#Store-1055"><span class="linenos">1055</span></a><span class="sd">                - store_id: This store&#39;s JID</span>
</span><span id="Store-1056"><a href="#Store-1056"><span class="linenos">1056</span></a><span class="sd">                - node_id: This store&#39;s graph location</span>
</span><span id="Store-1057"><a href="#Store-1057"><span class="linenos">1057</span></a><span class="sd">                - request_id: Original CFP request identifier</span>
</span><span id="Store-1058"><a href="#Store-1058"><span class="linenos">1058</span></a><span class="sd">            Body:</span>
</span><span id="Store-1059"><a href="#Store-1059"><span class="linenos">1059</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-1060"><a href="#Store-1060"><span class="linenos">1060</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="Store-1061"><a href="#Store-1061"><span class="linenos">1061</span></a><span class="sd">        </span>
</span><span id="Store-1062"><a href="#Store-1062"><span class="linenos">1062</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store-1063"><a href="#Store-1063"><span class="linenos">1063</span></a><span class="sd">            - Sends store-deny message to warehouse</span>
</span><span id="Store-1064"><a href="#Store-1064"><span class="linenos">1064</span></a><span class="sd">            - Prints denial confirmation (verbose mode only)</span>
</span><span id="Store-1065"><a href="#Store-1065"><span class="linenos">1065</span></a><span class="sd">        </span>
</span><span id="Store-1066"><a href="#Store-1066"><span class="linenos">1066</span></a><span class="sd">        Example:</span>
</span><span id="Store-1067"><a href="#Store-1067"><span class="linenos">1067</span></a><span class="sd">            ```</span>
</span><span id="Store-1068"><a href="#Store-1068"><span class="linenos">1068</span></a><span class="sd">            Scenario: 3 warehouses proposed, warehouse2 won</span>
</span><span id="Store-1069"><a href="#Store-1069"><span class="linenos">1069</span></a><span class="sd">            Recipients: warehouse1, warehouse3 (both receive store-deny)</span>
</span><span id="Store-1070"><a href="#Store-1070"><span class="linenos">1070</span></a><span class="sd">            Message: &quot;50 electronics&quot;</span>
</span><span id="Store-1071"><a href="#Store-1071"><span class="linenos">1071</span></a><span class="sd">            Result: warehouse1 and warehouse3 know they were not selected</span>
</span><span id="Store-1072"><a href="#Store-1072"><span class="linenos">1072</span></a><span class="sd">            ```</span>
</span><span id="Store-1073"><a href="#Store-1073"><span class="linenos">1073</span></a><span class="sd">        </span>
</span><span id="Store-1074"><a href="#Store-1074"><span class="linenos">1074</span></a><span class="sd">        Note:</span>
</span><span id="Store-1075"><a href="#Store-1075"><span class="linenos">1075</span></a><span class="sd">            This notification is important for warehouses to maintain accurate internal</span>
</span><span id="Store-1076"><a href="#Store-1076"><span class="linenos">1076</span></a><span class="sd">            state and avoid waiting indefinitely for a confirmation that will never come.</span>
</span><span id="Store-1077"><a href="#Store-1077"><span class="linenos">1077</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-1078"><a href="#Store-1078"><span class="linenos">1078</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Store-1079"><a href="#Store-1079"><span class="linenos">1079</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1080"><a href="#Store-1080"><span class="linenos">1080</span></a><span class="sd">            Initialize the SendStoreDenial behaviour.</span>
</span><span id="Store-1081"><a href="#Store-1081"><span class="linenos">1081</span></a><span class="sd">            </span>
</span><span id="Store-1082"><a href="#Store-1082"><span class="linenos">1082</span></a><span class="sd">            Args:</span>
</span><span id="Store-1083"><a href="#Store-1083"><span class="linenos">1083</span></a><span class="sd">                msg (Message): The warehouse-accept message from the non-selected warehouse.</span>
</span><span id="Store-1084"><a href="#Store-1084"><span class="linenos">1084</span></a><span class="sd">                    Contains sender information and order details needed for rejection message.</span>
</span><span id="Store-1085"><a href="#Store-1085"><span class="linenos">1085</span></a><span class="sd">            </span>
</span><span id="Store-1086"><a href="#Store-1086"><span class="linenos">1086</span></a><span class="sd">            Note:</span>
</span><span id="Store-1087"><a href="#Store-1087"><span class="linenos">1087</span></a><span class="sd">                Extracts only the essential fields needed to construct the rejection.</span>
</span><span id="Store-1088"><a href="#Store-1088"><span class="linenos">1088</span></a><span class="sd">                Unlike SendStoreConfirmation, this doesn&#39;t need to create an Order object.</span>
</span><span id="Store-1089"><a href="#Store-1089"><span class="linenos">1089</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-1090"><a href="#Store-1090"><span class="linenos">1090</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Store-1091"><a href="#Store-1091"><span class="linenos">1091</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Store-1092"><a href="#Store-1092"><span class="linenos">1092</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Store-1093"><a href="#Store-1093"><span class="linenos">1093</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store-1094"><a href="#Store-1094"><span class="linenos">1094</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store-1095"><a href="#Store-1095"><span class="linenos">1095</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store-1096"><a href="#Store-1096"><span class="linenos">1096</span></a>        
</span><span id="Store-1097"><a href="#Store-1097"><span class="linenos">1097</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store-1098"><a href="#Store-1098"><span class="linenos">1098</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1099"><a href="#Store-1099"><span class="linenos">1099</span></a><span class="sd">            Execute the rejection sending process (FIPA reject-proposal).</span>
</span><span id="Store-1100"><a href="#Store-1100"><span class="linenos">1100</span></a><span class="sd">            </span>
</span><span id="Store-1101"><a href="#Store-1101"><span class="linenos">1101</span></a><span class="sd">            This method sends the FIPA reject-proposal message to non-selected warehouses,</span>
</span><span id="Store-1102"><a href="#Store-1102"><span class="linenos">1102</span></a><span class="sd">            completing the result notification phase of the FIPA Contract Net Protocol.</span>
</span><span id="Store-1103"><a href="#Store-1103"><span class="linenos">1103</span></a><span class="sd">            </span>
</span><span id="Store-1104"><a href="#Store-1104"><span class="linenos">1104</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Store-1105"><a href="#Store-1105"><span class="linenos">1105</span></a><span class="sd">                - **Phase**: Result Notification - Rejection</span>
</span><span id="Store-1106"><a href="#Store-1106"><span class="linenos">1106</span></a><span class="sd">                - **Performative**: store-deny (FIPA reject-proposal)</span>
</span><span id="Store-1107"><a href="#Store-1107"><span class="linenos">1107</span></a><span class="sd">                - **Meaning**: &quot;Your proposal was not selected&quot;</span>
</span><span id="Store-1108"><a href="#Store-1108"><span class="linenos">1108</span></a><span class="sd">                - **Expected Response**: Warehouse releases resources, updates state</span>
</span><span id="Store-1109"><a href="#Store-1109"><span class="linenos">1109</span></a><span class="sd">            </span>
</span><span id="Store-1110"><a href="#Store-1110"><span class="linenos">1110</span></a><span class="sd">            Workflow:</span>
</span><span id="Store-1111"><a href="#Store-1111"><span class="linenos">1111</span></a><span class="sd">                1. **Message Construction**: Build store-deny message</span>
</span><span id="Store-1112"><a href="#Store-1112"><span class="linenos">1112</span></a><span class="sd">                    - Performative: store-deny (FIPA reject-proposal)</span>
</span><span id="Store-1113"><a href="#Store-1113"><span class="linenos">1113</span></a><span class="sd">                    - Metadata: warehouse_id, store_id, node_id, request_id</span>
</span><span id="Store-1114"><a href="#Store-1114"><span class="linenos">1114</span></a><span class="sd">                    - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-1115"><a href="#Store-1115"><span class="linenos">1115</span></a><span class="sd">                </span>
</span><span id="Store-1116"><a href="#Store-1116"><span class="linenos">1116</span></a><span class="sd">                2. **Message Transmission**: Send rejection to warehouse</span>
</span><span id="Store-1117"><a href="#Store-1117"><span class="linenos">1117</span></a><span class="sd">                    - Notifies warehouse of negative outcome</span>
</span><span id="Store-1118"><a href="#Store-1118"><span class="linenos">1118</span></a><span class="sd">                    - Allows warehouse to handle rejection gracefully</span>
</span><span id="Store-1119"><a href="#Store-1119"><span class="linenos">1119</span></a><span class="sd">                </span>
</span><span id="Store-1120"><a href="#Store-1120"><span class="linenos">1120</span></a><span class="sd">                3. **Status Logging**: Print denial confirmation (verbose only)</span>
</span><span id="Store-1121"><a href="#Store-1121"><span class="linenos">1121</span></a><span class="sd">            </span>
</span><span id="Store-1122"><a href="#Store-1122"><span class="linenos">1122</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store-1123"><a href="#Store-1123"><span class="linenos">1123</span></a><span class="sd">                - Sends SPADE message to warehouse</span>
</span><span id="Store-1124"><a href="#Store-1124"><span class="linenos">1124</span></a><span class="sd">                - Prints status information if verbose mode enabled</span>
</span><span id="Store-1125"><a href="#Store-1125"><span class="linenos">1125</span></a><span class="sd">            </span>
</span><span id="Store-1126"><a href="#Store-1126"><span class="linenos">1126</span></a><span class="sd">            Returns:</span>
</span><span id="Store-1127"><a href="#Store-1127"><span class="linenos">1127</span></a><span class="sd">                None. Completes when rejection message is sent.</span>
</span><span id="Store-1128"><a href="#Store-1128"><span class="linenos">1128</span></a><span class="sd">            </span>
</span><span id="Store-1129"><a href="#Store-1129"><span class="linenos">1129</span></a><span class="sd">            Example Execution:</span>
</span><span id="Store-1130"><a href="#Store-1130"><span class="linenos">1130</span></a><span class="sd">                ```</span>
</span><span id="Store-1131"><a href="#Store-1131"><span class="linenos">1131</span></a><span class="sd">                Input: warehouse-accept from warehouse1 (not selected)</span>
</span><span id="Store-1132"><a href="#Store-1132"><span class="linenos">1132</span></a><span class="sd">                    Body: &quot;50 electronics&quot;</span>
</span><span id="Store-1133"><a href="#Store-1133"><span class="linenos">1133</span></a><span class="sd">                    request_id: 1001000000</span>
</span><span id="Store-1134"><a href="#Store-1134"><span class="linenos">1134</span></a><span class="sd">                Processing:</span>
</span><span id="Store-1135"><a href="#Store-1135"><span class="linenos">1135</span></a><span class="sd">                    - Create store-deny message</span>
</span><span id="Store-1136"><a href="#Store-1136"><span class="linenos">1136</span></a><span class="sd">                    - Set metadata and body</span>
</span><span id="Store-1137"><a href="#Store-1137"><span class="linenos">1137</span></a><span class="sd">                Output:</span>
</span><span id="Store-1138"><a href="#Store-1138"><span class="linenos">1138</span></a><span class="sd">                    - Send store-deny to warehouse1</span>
</span><span id="Store-1139"><a href="#Store-1139"><span class="linenos">1139</span></a><span class="sd">                    - Print (if verbose): &quot;Denial sent to warehouse1 for request: 50 electronics&quot;</span>
</span><span id="Store-1140"><a href="#Store-1140"><span class="linenos">1140</span></a><span class="sd">                ```</span>
</span><span id="Store-1141"><a href="#Store-1141"><span class="linenos">1141</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-1142"><a href="#Store-1142"><span class="linenos">1142</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store-1143"><a href="#Store-1143"><span class="linenos">1143</span></a>            
</span><span id="Store-1144"><a href="#Store-1144"><span class="linenos">1144</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="Store-1145"><a href="#Store-1145"><span class="linenos">1145</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-deny&quot;</span><span class="p">)</span>
</span><span id="Store-1146"><a href="#Store-1146"><span class="linenos">1146</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="Store-1147"><a href="#Store-1147"><span class="linenos">1147</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store-1148"><a href="#Store-1148"><span class="linenos">1148</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Store-1149"><a href="#Store-1149"><span class="linenos">1149</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store-1150"><a href="#Store-1150"><span class="linenos">1150</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Store-1151"><a href="#Store-1151"><span class="linenos">1151</span></a>            
</span><span id="Store-1152"><a href="#Store-1152"><span class="linenos">1152</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store-1153"><a href="#Store-1153"><span class="linenos">1153</span></a>            
</span><span id="Store-1154"><a href="#Store-1154"><span class="linenos">1154</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-1155"><a href="#Store-1155"><span class="linenos">1155</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Denial sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-1156"><a href="#Store-1156"><span class="linenos">1156</span></a>    
</span><span id="Store-1157"><a href="#Store-1157"><span class="linenos">1157</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">RetryPreviousBuy</span><span class="p">(</span><span class="n">PeriodicBehaviour</span><span class="p">):</span>
</span><span id="Store-1158"><a href="#Store-1158"><span class="linenos">1158</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1159"><a href="#Store-1159"><span class="linenos">1159</span></a><span class="sd">        Periodic behaviour that retries failed purchase requests.</span>
</span><span id="Store-1160"><a href="#Store-1160"><span class="linenos">1160</span></a><span class="sd">        </span>
</span><span id="Store-1161"><a href="#Store-1161"><span class="linenos">1161</span></a><span class="sd">        This behaviour implements automatic retry logic for purchase requests that failed</span>
</span><span id="Store-1162"><a href="#Store-1162"><span class="linenos">1162</span></a><span class="sd">        due to all warehouses rejecting or timing out. It periodically checks the</span>
</span><span id="Store-1163"><a href="#Store-1163"><span class="linenos">1163</span></a><span class="sd">        failed_requests queue and re-initiates the FIPA Contract Net Protocol for any</span>
</span><span id="Store-1164"><a href="#Store-1164"><span class="linenos">1164</span></a><span class="sd">        pending failed requests.</span>
</span><span id="Store-1165"><a href="#Store-1165"><span class="linenos">1165</span></a><span class="sd">        </span>
</span><span id="Store-1166"><a href="#Store-1166"><span class="linenos">1166</span></a><span class="sd">        Failure Scenarios:</span>
</span><span id="Store-1167"><a href="#Store-1167"><span class="linenos">1167</span></a><span class="sd">            - All warehouses sent warehouse-reject (refuse)</span>
</span><span id="Store-1168"><a href="#Store-1168"><span class="linenos">1168</span></a><span class="sd">            - All warehouses timed out (no response)</span>
</span><span id="Store-1169"><a href="#Store-1169"><span class="linenos">1169</span></a><span class="sd">            - Mix of rejects and timeouts with zero acceptances</span>
</span><span id="Store-1170"><a href="#Store-1170"><span class="linenos">1170</span></a><span class="sd">        </span>
</span><span id="Store-1171"><a href="#Store-1171"><span class="linenos">1171</span></a><span class="sd">        The behaviour maintains the original request_id for tracking and statistics,</span>
</span><span id="Store-1172"><a href="#Store-1172"><span class="linenos">1172</span></a><span class="sd">        allowing correlation between original attempt and retry attempts in logs.</span>
</span><span id="Store-1173"><a href="#Store-1173"><span class="linenos">1173</span></a><span class="sd">        </span>
</span><span id="Store-1174"><a href="#Store-1174"><span class="linenos">1174</span></a><span class="sd">        Attributes:</span>
</span><span id="Store-1175"><a href="#Store-1175"><span class="linenos">1175</span></a><span class="sd">            Inherited from PeriodicBehaviour:</span>
</span><span id="Store-1176"><a href="#Store-1176"><span class="linenos">1176</span></a><span class="sd">                - period (float): Time between retry attempts (default: 5 seconds)</span>
</span><span id="Store-1177"><a href="#Store-1177"><span class="linenos">1177</span></a><span class="sd">                - Executes continuously while agent is running</span>
</span><span id="Store-1178"><a href="#Store-1178"><span class="linenos">1178</span></a><span class="sd">        </span>
</span><span id="Store-1179"><a href="#Store-1179"><span class="linenos">1179</span></a><span class="sd">        Retry Logic:</span>
</span><span id="Store-1180"><a href="#Store-1180"><span class="linenos">1180</span></a><span class="sd">            - Checks failed_requests queue (FIFO)</span>
</span><span id="Store-1181"><a href="#Store-1181"><span class="linenos">1181</span></a><span class="sd">            - Dequeues one request per execution</span>
</span><span id="Store-1182"><a href="#Store-1182"><span class="linenos">1182</span></a><span class="sd">            - Preserves original request_id (no new ID generated)</span>
</span><span id="Store-1183"><a href="#Store-1183"><span class="linenos">1183</span></a><span class="sd">            - Re-broadcasts CFP to all warehouses</span>
</span><span id="Store-1184"><a href="#Store-1184"><span class="linenos">1184</span></a><span class="sd">            - Launches CollectWarehouseResponses coordinator</span>
</span><span id="Store-1185"><a href="#Store-1185"><span class="linenos">1185</span></a><span class="sd">        </span>
</span><span id="Store-1186"><a href="#Store-1186"><span class="linenos">1186</span></a><span class="sd">        FIPA Protocol:</span>
</span><span id="Store-1187"><a href="#Store-1187"><span class="linenos">1187</span></a><span class="sd">            Restarts the entire FIPA Contract Net Protocol:</span>
</span><span id="Store-1188"><a href="#Store-1188"><span class="linenos">1188</span></a><span class="sd">            1. Call for Proposals (CFP) - re-broadcast with same request_id</span>
</span><span id="Store-1189"><a href="#Store-1189"><span class="linenos">1189</span></a><span class="sd">            2. Proposal Reception - collect new responses</span>
</span><span id="Store-1190"><a href="#Store-1190"><span class="linenos">1190</span></a><span class="sd">            3. Proposal Evaluation - score and select best warehouse</span>
</span><span id="Store-1191"><a href="#Store-1191"><span class="linenos">1191</span></a><span class="sd">            4. Result Notification - confirm winner, deny losers</span>
</span><span id="Store-1192"><a href="#Store-1192"><span class="linenos">1192</span></a><span class="sd">        </span>
</span><span id="Store-1193"><a href="#Store-1193"><span class="linenos">1193</span></a><span class="sd">        Workflow:</span>
</span><span id="Store-1194"><a href="#Store-1194"><span class="linenos">1194</span></a><span class="sd">            1. **Queue Check**: Test if failed_requests queue is empty</span>
</span><span id="Store-1195"><a href="#Store-1195"><span class="linenos">1195</span></a><span class="sd">            2. **Dequeue**: Get oldest failed request from queue</span>
</span><span id="Store-1196"><a href="#Store-1196"><span class="linenos">1196</span></a><span class="sd">            3. **Parse**: Extract request_id, quantity, product from message</span>
</span><span id="Store-1197"><a href="#Store-1197"><span class="linenos">1197</span></a><span class="sd">            4. **Re-broadcast**: Send store-buy to all warehouses (same request_id)</span>
</span><span id="Store-1198"><a href="#Store-1198"><span class="linenos">1198</span></a><span class="sd">            5. **Coordinate**: Launch CollectWarehouseResponses for this retry</span>
</span><span id="Store-1199"><a href="#Store-1199"><span class="linenos">1199</span></a><span class="sd">            6. **Synchronize**: Wait for coordinator to complete</span>
</span><span id="Store-1200"><a href="#Store-1200"><span class="linenos">1200</span></a><span class="sd">            7. **Repeat**: Next period, check queue again</span>
</span><span id="Store-1201"><a href="#Store-1201"><span class="linenos">1201</span></a><span class="sd">        </span>
</span><span id="Store-1202"><a href="#Store-1202"><span class="linenos">1202</span></a><span class="sd">        Example Execution:</span>
</span><span id="Store-1203"><a href="#Store-1203"><span class="linenos">1203</span></a><span class="sd">            ```</span>
</span><span id="Store-1204"><a href="#Store-1204"><span class="linenos">1204</span></a><span class="sd">            Initial Attempt (t=10s):</span>
</span><span id="Store-1205"><a href="#Store-1205"><span class="linenos">1205</span></a><span class="sd">                - Request &quot;50 electronics&quot; (ID: 1001000000)</span>
</span><span id="Store-1206"><a href="#Store-1206"><span class="linenos">1206</span></a><span class="sd">                - All warehouses reject or timeout</span>
</span><span id="Store-1207"><a href="#Store-1207"><span class="linenos">1207</span></a><span class="sd">                - Added to failed_requests queue</span>
</span><span id="Store-1208"><a href="#Store-1208"><span class="linenos">1208</span></a><span class="sd">            </span>
</span><span id="Store-1209"><a href="#Store-1209"><span class="linenos">1209</span></a><span class="sd">            Retry Attempt (t=15s):</span>
</span><span id="Store-1210"><a href="#Store-1210"><span class="linenos">1210</span></a><span class="sd">                - Dequeue request 1001000000</span>
</span><span id="Store-1211"><a href="#Store-1211"><span class="linenos">1211</span></a><span class="sd">                - Re-broadcast to all warehouses (same ID)</span>
</span><span id="Store-1212"><a href="#Store-1212"><span class="linenos">1212</span></a><span class="sd">                - New responses: warehouse2 accepts</span>
</span><span id="Store-1213"><a href="#Store-1213"><span class="linenos">1213</span></a><span class="sd">                - Success: Order placed with warehouse2</span>
</span><span id="Store-1214"><a href="#Store-1214"><span class="linenos">1214</span></a><span class="sd">            ```</span>
</span><span id="Store-1215"><a href="#Store-1215"><span class="linenos">1215</span></a><span class="sd">        </span>
</span><span id="Store-1216"><a href="#Store-1216"><span class="linenos">1216</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store-1217"><a href="#Store-1217"><span class="linenos">1217</span></a><span class="sd">            - Dequeues from agent.failed_requests</span>
</span><span id="Store-1218"><a href="#Store-1218"><span class="linenos">1218</span></a><span class="sd">            - Sends store-buy messages to all warehouses</span>
</span><span id="Store-1219"><a href="#Store-1219"><span class="linenos">1219</span></a><span class="sd">            - Adds CollectWarehouseResponses behaviour</span>
</span><span id="Store-1220"><a href="#Store-1220"><span class="linenos">1220</span></a><span class="sd">            - Prints retry information if verbose mode enabled</span>
</span><span id="Store-1221"><a href="#Store-1221"><span class="linenos">1221</span></a><span class="sd">        </span>
</span><span id="Store-1222"><a href="#Store-1222"><span class="linenos">1222</span></a><span class="sd">        Notes:</span>
</span><span id="Store-1223"><a href="#Store-1223"><span class="linenos">1223</span></a><span class="sd">            - Retries use the SAME request_id as original attempt</span>
</span><span id="Store-1224"><a href="#Store-1224"><span class="linenos">1224</span></a><span class="sd">            - No limit on retry attempts (will retry until success)</span>
</span><span id="Store-1225"><a href="#Store-1225"><span class="linenos">1225</span></a><span class="sd">            - Failed retries are re-enqueued by CollectWarehouseResponses</span>
</span><span id="Store-1226"><a href="#Store-1226"><span class="linenos">1226</span></a><span class="sd">            - Period of 5 seconds prevents overwhelming warehouses</span>
</span><span id="Store-1227"><a href="#Store-1227"><span class="linenos">1227</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-1228"><a href="#Store-1228"><span class="linenos">1228</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store-1229"><a href="#Store-1229"><span class="linenos">1229</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1230"><a href="#Store-1230"><span class="linenos">1230</span></a><span class="sd">            Execute one retry cycle for failed purchase requests.</span>
</span><span id="Store-1231"><a href="#Store-1231"><span class="linenos">1231</span></a><span class="sd">            </span>
</span><span id="Store-1232"><a href="#Store-1232"><span class="linenos">1232</span></a><span class="sd">            This method checks the failed_requests queue and, if not empty, dequeues</span>
</span><span id="Store-1233"><a href="#Store-1233"><span class="linenos">1233</span></a><span class="sd">            one request and re-initiates the FIPA Contract Net Protocol with the same</span>
</span><span id="Store-1234"><a href="#Store-1234"><span class="linenos">1234</span></a><span class="sd">            request_id. This maintains traceability across retry attempts.</span>
</span><span id="Store-1235"><a href="#Store-1235"><span class="linenos">1235</span></a><span class="sd">            </span>
</span><span id="Store-1236"><a href="#Store-1236"><span class="linenos">1236</span></a><span class="sd">            Workflow:</span>
</span><span id="Store-1237"><a href="#Store-1237"><span class="linenos">1237</span></a><span class="sd">                1. **Queue Check**: If failed_requests is empty, do nothing</span>
</span><span id="Store-1238"><a href="#Store-1238"><span class="linenos">1238</span></a><span class="sd">                2. **Dequeue Request**: Get oldest failed request (FIFO order)</span>
</span><span id="Store-1239"><a href="#Store-1239"><span class="linenos">1239</span></a><span class="sd">                3. **Extract Data**: Parse request_id, quantity, product from message</span>
</span><span id="Store-1240"><a href="#Store-1240"><span class="linenos">1240</span></a><span class="sd">                4. **Count Participants**: Get number of warehouses for response tracking</span>
</span><span id="Store-1241"><a href="#Store-1241"><span class="linenos">1241</span></a><span class="sd">                5. **Rebuild Messages**: Create new store-buy messages for each warehouse</span>
</span><span id="Store-1242"><a href="#Store-1242"><span class="linenos">1242</span></a><span class="sd">                6. **Broadcast CFP**: Send retry request to all warehouses</span>
</span><span id="Store-1243"><a href="#Store-1243"><span class="linenos">1243</span></a><span class="sd">                7. **Launch Coordinator**: Start CollectWarehouseResponses with same request_id</span>
</span><span id="Store-1244"><a href="#Store-1244"><span class="linenos">1244</span></a><span class="sd">                8. **Wait**: Synchronize on coordinator completion</span>
</span><span id="Store-1245"><a href="#Store-1245"><span class="linenos">1245</span></a><span class="sd">            </span>
</span><span id="Store-1246"><a href="#Store-1246"><span class="linenos">1246</span></a><span class="sd">            Request ID Preservation:</span>
</span><span id="Store-1247"><a href="#Store-1247"><span class="linenos">1247</span></a><span class="sd">                The original request_id is preserved across retries, enabling:</span>
</span><span id="Store-1248"><a href="#Store-1248"><span class="linenos">1248</span></a><span class="sd">                - Statistics tracking (correlate original and retries)</span>
</span><span id="Store-1249"><a href="#Store-1249"><span class="linenos">1249</span></a><span class="sd">                - Debugging (trace request lifecycle)</span>
</span><span id="Store-1250"><a href="#Store-1250"><span class="linenos">1250</span></a><span class="sd">                - Avoiding duplicate processing (warehouses can detect retries)</span>
</span><span id="Store-1251"><a href="#Store-1251"><span class="linenos">1251</span></a><span class="sd">            </span>
</span><span id="Store-1252"><a href="#Store-1252"><span class="linenos">1252</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store-1253"><a href="#Store-1253"><span class="linenos">1253</span></a><span class="sd">                - Removes one message from agent.failed_requests queue</span>
</span><span id="Store-1254"><a href="#Store-1254"><span class="linenos">1254</span></a><span class="sd">                - Sends multiple store-buy messages (one per warehouse)</span>
</span><span id="Store-1255"><a href="#Store-1255"><span class="linenos">1255</span></a><span class="sd">                - Adds CollectWarehouseResponses behaviour to agent</span>
</span><span id="Store-1256"><a href="#Store-1256"><span class="linenos">1256</span></a><span class="sd">                - Prints retry notifications if verbose mode enabled</span>
</span><span id="Store-1257"><a href="#Store-1257"><span class="linenos">1257</span></a><span class="sd">            </span>
</span><span id="Store-1258"><a href="#Store-1258"><span class="linenos">1258</span></a><span class="sd">            Returns:</span>
</span><span id="Store-1259"><a href="#Store-1259"><span class="linenos">1259</span></a><span class="sd">                None. Completes when coordinator finishes negotiation, or immediately</span>
</span><span id="Store-1260"><a href="#Store-1260"><span class="linenos">1260</span></a><span class="sd">                if queue is empty.</span>
</span><span id="Store-1261"><a href="#Store-1261"><span class="linenos">1261</span></a><span class="sd">            </span>
</span><span id="Store-1262"><a href="#Store-1262"><span class="linenos">1262</span></a><span class="sd">            Example Execution:</span>
</span><span id="Store-1263"><a href="#Store-1263"><span class="linenos">1263</span></a><span class="sd">                ```</span>
</span><span id="Store-1264"><a href="#Store-1264"><span class="linenos">1264</span></a><span class="sd">                Queue State: [Request(ID=1001000000, &quot;50 electronics&quot;)]</span>
</span><span id="Store-1265"><a href="#Store-1265"><span class="linenos">1265</span></a><span class="sd">                Processing:</span>
</span><span id="Store-1266"><a href="#Store-1266"><span class="linenos">1266</span></a><span class="sd">                    - Dequeue: Request 1001000000</span>
</span><span id="Store-1267"><a href="#Store-1267"><span class="linenos">1267</span></a><span class="sd">                    - Parse: quantity=50, product=&quot;electronics&quot;</span>
</span><span id="Store-1268"><a href="#Store-1268"><span class="linenos">1268</span></a><span class="sd">                    - Broadcast: Send to warehouse1, warehouse2, warehouse3</span>
</span><span id="Store-1269"><a href="#Store-1269"><span class="linenos">1269</span></a><span class="sd">                    - Coordinate: Launch CollectWarehouseResponses(1001000000, ...)</span>
</span><span id="Store-1270"><a href="#Store-1270"><span class="linenos">1270</span></a><span class="sd">                    - Wait: Until new responses collected and evaluated</span>
</span><span id="Store-1271"><a href="#Store-1271"><span class="linenos">1271</span></a><span class="sd">                Result:</span>
</span><span id="Store-1272"><a href="#Store-1272"><span class="linenos">1272</span></a><span class="sd">                    - If success: Order placed</span>
</span><span id="Store-1273"><a href="#Store-1273"><span class="linenos">1273</span></a><span class="sd">                    - If failure: Re-enqueued for next retry cycle</span>
</span><span id="Store-1274"><a href="#Store-1274"><span class="linenos">1274</span></a><span class="sd">                ```</span>
</span><span id="Store-1275"><a href="#Store-1275"><span class="linenos">1275</span></a><span class="sd">            </span>
</span><span id="Store-1276"><a href="#Store-1276"><span class="linenos">1276</span></a><span class="sd">            Note:</span>
</span><span id="Store-1277"><a href="#Store-1277"><span class="linenos">1277</span></a><span class="sd">                This method processes only ONE request per execution cycle (period=5s).</span>
</span><span id="Store-1278"><a href="#Store-1278"><span class="linenos">1278</span></a><span class="sd">                This prevents flooding warehouses with retry requests and allows</span>
</span><span id="Store-1279"><a href="#Store-1279"><span class="linenos">1279</span></a><span class="sd">                gradual processing of the failed_requests backlog.</span>
</span><span id="Store-1280"><a href="#Store-1280"><span class="linenos">1280</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-1281"><a href="#Store-1281"><span class="linenos">1281</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store-1282"><a href="#Store-1282"><span class="linenos">1282</span></a>            
</span><span id="Store-1283"><a href="#Store-1283"><span class="linenos">1283</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="Store-1284"><a href="#Store-1284"><span class="linenos">1284</span></a>                <span class="n">request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="Store-1285"><a href="#Store-1285"><span class="linenos">1285</span></a>                <span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Store-1286"><a href="#Store-1286"><span class="linenos">1286</span></a>                <span class="n">parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store-1287"><a href="#Store-1287"><span class="linenos">1287</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store-1288"><a href="#Store-1288"><span class="linenos">1288</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store-1289"><a href="#Store-1289"><span class="linenos">1289</span></a>                
</span><span id="Store-1290"><a href="#Store-1290"><span class="linenos">1290</span></a>                <span class="n">contacts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Store-1291"><a href="#Store-1291"><span class="linenos">1291</span></a>                <span class="n">num_warehouses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contacts</span><span class="p">)</span>
</span><span id="Store-1292"><a href="#Store-1292"><span class="linenos">1292</span></a>                
</span><span id="Store-1293"><a href="#Store-1293"><span class="linenos">1293</span></a>                <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">:</span>
</span><span id="Store-1294"><a href="#Store-1294"><span class="linenos">1294</span></a>                    <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">contact</span><span class="p">)</span>
</span><span id="Store-1295"><a href="#Store-1295"><span class="linenos">1295</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">set_buy_metadata</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store-1296"><a href="#Store-1296"><span class="linenos">1296</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Store-1297"><a href="#Store-1297"><span class="linenos">1297</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store-1298"><a href="#Store-1298"><span class="linenos">1298</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
</span><span id="Store-1299"><a href="#Store-1299"><span class="linenos">1299</span></a>
</span><span id="Store-1300"><a href="#Store-1300"><span class="linenos">1300</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-1301"><a href="#Store-1301"><span class="linenos">1301</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Retrying request (id=</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="Store-1302"><a href="#Store-1302"><span class="linenos">1302</span></a>                              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-1303"><a href="#Store-1303"><span class="linenos">1303</span></a>
</span><span id="Store-1304"><a href="#Store-1304"><span class="linenos">1304</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store-1305"><a href="#Store-1305"><span class="linenos">1305</span></a>
</span><span id="Store-1306"><a href="#Store-1306"><span class="linenos">1306</span></a>                <span class="c1"># Use CollectWarehouseResponses instead</span>
</span><span id="Store-1307"><a href="#Store-1307"><span class="linenos">1307</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectWarehouseResponses</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">num_warehouses</span><span class="p">)</span>
</span><span id="Store-1308"><a href="#Store-1308"><span class="linenos">1308</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Store-1309"><a href="#Store-1309"><span class="linenos">1309</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Store-1310"><a href="#Store-1310"><span class="linenos">1310</span></a>    
</span><span id="Store-1311"><a href="#Store-1311"><span class="linenos">1311</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveTimeDelta</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="Store-1312"><a href="#Store-1312"><span class="linenos">1312</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1313"><a href="#Store-1313"><span class="linenos">1313</span></a><span class="sd">        Cyclic behaviour that processes simulation time updates and traffic information.</span>
</span><span id="Store-1314"><a href="#Store-1314"><span class="linenos">1314</span></a><span class="sd">        </span>
</span><span id="Store-1315"><a href="#Store-1315"><span class="linenos">1315</span></a><span class="sd">        This behaviour listens for time synchronization messages from the world agent,</span>
</span><span id="Store-1316"><a href="#Store-1316"><span class="linenos">1316</span></a><span class="sd">        updating the store&#39;s internal clock and applying dynamic traffic changes to the</span>
</span><span id="Store-1317"><a href="#Store-1317"><span class="linenos">1317</span></a><span class="sd">        graph. It implements an event-driven architecture where the world agent controls</span>
</span><span id="Store-1318"><a href="#Store-1318"><span class="linenos">1318</span></a><span class="sd">        simulation time progression.</span>
</span><span id="Store-1319"><a href="#Store-1319"><span class="linenos">1319</span></a><span class="sd">        </span>
</span><span id="Store-1320"><a href="#Store-1320"><span class="linenos">1320</span></a><span class="sd">        Message Types Processed:</span>
</span><span id="Store-1321"><a href="#Store-1321"><span class="linenos">1321</span></a><span class="sd">            1. **Time Updates** (all messages):</span>
</span><span id="Store-1322"><a href="#Store-1322"><span class="linenos">1322</span></a><span class="sd">                - Updates agent.current_tick with time delta</span>
</span><span id="Store-1323"><a href="#Store-1323"><span class="linenos">1323</span></a><span class="sd">                - Synchronizes store with global simulation time</span>
</span><span id="Store-1324"><a href="#Store-1324"><span class="linenos">1324</span></a><span class="sd">            </span>
</span><span id="Store-1325"><a href="#Store-1325"><span class="linenos">1325</span></a><span class="sd">            2. **Traffic Updates** (type=&quot;Transit&quot;):</span>
</span><span id="Store-1326"><a href="#Store-1326"><span class="linenos">1326</span></a><span class="sd">                - Applies dynamic edge weight changes to graph</span>
</span><span id="Store-1327"><a href="#Store-1327"><span class="linenos">1327</span></a><span class="sd">                - Updates fuel consumption values for routes</span>
</span><span id="Store-1328"><a href="#Store-1328"><span class="linenos">1328</span></a><span class="sd">                - Reflects real-time traffic conditions</span>
</span><span id="Store-1329"><a href="#Store-1329"><span class="linenos">1329</span></a><span class="sd">        </span>
</span><span id="Store-1330"><a href="#Store-1330"><span class="linenos">1330</span></a><span class="sd">        Message Format:</span>
</span><span id="Store-1331"><a href="#Store-1331"><span class="linenos">1331</span></a><span class="sd">            Metadata:</span>
</span><span id="Store-1332"><a href="#Store-1332"><span class="linenos">1332</span></a><span class="sd">                - performative: &quot;inform&quot;</span>
</span><span id="Store-1333"><a href="#Store-1333"><span class="linenos">1333</span></a><span class="sd">            Body (JSON):</span>
</span><span id="Store-1334"><a href="#Store-1334"><span class="linenos">1334</span></a><span class="sd">                ```json</span>
</span><span id="Store-1335"><a href="#Store-1335"><span class="linenos">1335</span></a><span class="sd">                {</span>
</span><span id="Store-1336"><a href="#Store-1336"><span class="linenos">1336</span></a><span class="sd">                    &quot;type&quot;: &quot;Transit&quot;,  // or other types</span>
</span><span id="Store-1337"><a href="#Store-1337"><span class="linenos">1337</span></a><span class="sd">                    &quot;time&quot;: 5,          // delta in ticks</span>
</span><span id="Store-1338"><a href="#Store-1338"><span class="linenos">1338</span></a><span class="sd">                    &quot;data&quot;: {</span>
</span><span id="Store-1339"><a href="#Store-1339"><span class="linenos">1339</span></a><span class="sd">                        &quot;edges&quot;: [</span>
</span><span id="Store-1340"><a href="#Store-1340"><span class="linenos">1340</span></a><span class="sd">                            {</span>
</span><span id="Store-1341"><a href="#Store-1341"><span class="linenos">1341</span></a><span class="sd">                                &quot;node1&quot;: 1,</span>
</span><span id="Store-1342"><a href="#Store-1342"><span class="linenos">1342</span></a><span class="sd">                                &quot;node2&quot;: 2,</span>
</span><span id="Store-1343"><a href="#Store-1343"><span class="linenos">1343</span></a><span class="sd">                                &quot;weight&quot;: 150,</span>
</span><span id="Store-1344"><a href="#Store-1344"><span class="linenos">1344</span></a><span class="sd">                                &quot;fuel_consumption&quot;: 12.5</span>
</span><span id="Store-1345"><a href="#Store-1345"><span class="linenos">1345</span></a><span class="sd">                            },</span>
</span><span id="Store-1346"><a href="#Store-1346"><span class="linenos">1346</span></a><span class="sd">                            ...</span>
</span><span id="Store-1347"><a href="#Store-1347"><span class="linenos">1347</span></a><span class="sd">                        ]</span>
</span><span id="Store-1348"><a href="#Store-1348"><span class="linenos">1348</span></a><span class="sd">                    }</span>
</span><span id="Store-1349"><a href="#Store-1349"><span class="linenos">1349</span></a><span class="sd">                }</span>
</span><span id="Store-1350"><a href="#Store-1350"><span class="linenos">1350</span></a><span class="sd">                ```</span>
</span><span id="Store-1351"><a href="#Store-1351"><span class="linenos">1351</span></a><span class="sd">        </span>
</span><span id="Store-1352"><a href="#Store-1352"><span class="linenos">1352</span></a><span class="sd">        Attributes:</span>
</span><span id="Store-1353"><a href="#Store-1353"><span class="linenos">1353</span></a><span class="sd">            Inherits from CyclicBehaviour:</span>
</span><span id="Store-1354"><a href="#Store-1354"><span class="linenos">1354</span></a><span class="sd">                - Runs continuously in infinite loop</span>
</span><span id="Store-1355"><a href="#Store-1355"><span class="linenos">1355</span></a><span class="sd">                - Processes one message per cycle</span>
</span><span id="Store-1356"><a href="#Store-1356"><span class="linenos">1356</span></a><span class="sd">                - 20-second timeout per receive attempt</span>
</span><span id="Store-1357"><a href="#Store-1357"><span class="linenos">1357</span></a><span class="sd">        </span>
</span><span id="Store-1358"><a href="#Store-1358"><span class="linenos">1358</span></a><span class="sd">        Workflow:</span>
</span><span id="Store-1359"><a href="#Store-1359"><span class="linenos">1359</span></a><span class="sd">            1. **Receive Message**: Wait up to 20 seconds for inform message</span>
</span><span id="Store-1360"><a href="#Store-1360"><span class="linenos">1360</span></a><span class="sd">            2. **Parse JSON**: Extract type, time delta, and data</span>
</span><span id="Store-1361"><a href="#Store-1361"><span class="linenos">1361</span></a><span class="sd">            3. **Update Time**: Increment current_tick by delta</span>
</span><span id="Store-1362"><a href="#Store-1362"><span class="linenos">1362</span></a><span class="sd">            4. **Check Type**: If type is &quot;Transit&quot;, process traffic updates</span>
</span><span id="Store-1363"><a href="#Store-1363"><span class="linenos">1363</span></a><span class="sd">            5. **Update Graph**: Apply edge weight changes using update_graph()</span>
</span><span id="Store-1364"><a href="#Store-1364"><span class="linenos">1364</span></a><span class="sd">            6. **Repeat**: Return to step 1 (cyclic behaviour)</span>
</span><span id="Store-1365"><a href="#Store-1365"><span class="linenos">1365</span></a><span class="sd">        </span>
</span><span id="Store-1366"><a href="#Store-1366"><span class="linenos">1366</span></a><span class="sd">        Traffic Update Process:</span>
</span><span id="Store-1367"><a href="#Store-1367"><span class="linenos">1367</span></a><span class="sd">            When type=&quot;Transit&quot;:</span>
</span><span id="Store-1368"><a href="#Store-1368"><span class="linenos">1368</span></a><span class="sd">                - Extract edges array from data field</span>
</span><span id="Store-1369"><a href="#Store-1369"><span class="linenos">1369</span></a><span class="sd">                - For each edge: update weight and fuel_consumption</span>
</span><span id="Store-1370"><a href="#Store-1370"><span class="linenos">1370</span></a><span class="sd">                - Uses update_graph() helper method</span>
</span><span id="Store-1371"><a href="#Store-1371"><span class="linenos">1371</span></a><span class="sd">                - Affects pathfinding calculations in warehouse selection</span>
</span><span id="Store-1372"><a href="#Store-1372"><span class="linenos">1372</span></a><span class="sd">        </span>
</span><span id="Store-1373"><a href="#Store-1373"><span class="linenos">1373</span></a><span class="sd">        Example Execution:</span>
</span><span id="Store-1374"><a href="#Store-1374"><span class="linenos">1374</span></a><span class="sd">            ```</span>
</span><span id="Store-1375"><a href="#Store-1375"><span class="linenos">1375</span></a><span class="sd">            Message Received:</span>
</span><span id="Store-1376"><a href="#Store-1376"><span class="linenos">1376</span></a><span class="sd">                {</span>
</span><span id="Store-1377"><a href="#Store-1377"><span class="linenos">1377</span></a><span class="sd">                    &quot;type&quot;: &quot;Transit&quot;,</span>
</span><span id="Store-1378"><a href="#Store-1378"><span class="linenos">1378</span></a><span class="sd">                    &quot;time&quot;: 3,</span>
</span><span id="Store-1379"><a href="#Store-1379"><span class="linenos">1379</span></a><span class="sd">                    &quot;data&quot;: {</span>
</span><span id="Store-1380"><a href="#Store-1380"><span class="linenos">1380</span></a><span class="sd">                        &quot;edges&quot;: [</span>
</span><span id="Store-1381"><a href="#Store-1381"><span class="linenos">1381</span></a><span class="sd">                            {&quot;node1&quot;: 5, &quot;node2&quot;: 10, &quot;weight&quot;: 200, &quot;fuel_consumption&quot;: 15.0}</span>
</span><span id="Store-1382"><a href="#Store-1382"><span class="linenos">1382</span></a><span class="sd">                        ]</span>
</span><span id="Store-1383"><a href="#Store-1383"><span class="linenos">1383</span></a><span class="sd">                    }</span>
</span><span id="Store-1384"><a href="#Store-1384"><span class="linenos">1384</span></a><span class="sd">                }</span>
</span><span id="Store-1385"><a href="#Store-1385"><span class="linenos">1385</span></a><span class="sd">            Processing:</span>
</span><span id="Store-1386"><a href="#Store-1386"><span class="linenos">1386</span></a><span class="sd">                - current_tick: 42 -&gt; 45 (increment by 3)</span>
</span><span id="Store-1387"><a href="#Store-1387"><span class="linenos">1387</span></a><span class="sd">                - Update edge (5, 10): weight=200, fuel=15.0</span>
</span><span id="Store-1388"><a href="#Store-1388"><span class="linenos">1388</span></a><span class="sd">                - Next warehouse selection uses new weights</span>
</span><span id="Store-1389"><a href="#Store-1389"><span class="linenos">1389</span></a><span class="sd">            ```</span>
</span><span id="Store-1390"><a href="#Store-1390"><span class="linenos">1390</span></a><span class="sd">        </span>
</span><span id="Store-1391"><a href="#Store-1391"><span class="linenos">1391</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store-1392"><a href="#Store-1392"><span class="linenos">1392</span></a><span class="sd">            - Increments agent.current_tick (time synchronization)</span>
</span><span id="Store-1393"><a href="#Store-1393"><span class="linenos">1393</span></a><span class="sd">            - Modifies agent.map edge weights (traffic updates)</span>
</span><span id="Store-1394"><a href="#Store-1394"><span class="linenos">1394</span></a><span class="sd">            - Affects future pathfinding and warehouse scoring</span>
</span><span id="Store-1395"><a href="#Store-1395"><span class="linenos">1395</span></a><span class="sd">        </span>
</span><span id="Store-1396"><a href="#Store-1396"><span class="linenos">1396</span></a><span class="sd">        Returns:</span>
</span><span id="Store-1397"><a href="#Store-1397"><span class="linenos">1397</span></a><span class="sd">            Never returns (cyclic behaviour runs until agent stops).</span>
</span><span id="Store-1398"><a href="#Store-1398"><span class="linenos">1398</span></a><span class="sd">        </span>
</span><span id="Store-1399"><a href="#Store-1399"><span class="linenos">1399</span></a><span class="sd">        Note:</span>
</span><span id="Store-1400"><a href="#Store-1400"><span class="linenos">1400</span></a><span class="sd">            The 20-second timeout prevents indefinite blocking if world agent stops</span>
</span><span id="Store-1401"><a href="#Store-1401"><span class="linenos">1401</span></a><span class="sd">            sending updates. This is a safety mechanism for graceful degradation.</span>
</span><span id="Store-1402"><a href="#Store-1402"><span class="linenos">1402</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-1403"><a href="#Store-1403"><span class="linenos">1403</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store-1404"><a href="#Store-1404"><span class="linenos">1404</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1405"><a href="#Store-1405"><span class="linenos">1405</span></a><span class="sd">            Execute one cycle of time delta reception and processing.</span>
</span><span id="Store-1406"><a href="#Store-1406"><span class="linenos">1406</span></a><span class="sd">            </span>
</span><span id="Store-1407"><a href="#Store-1407"><span class="linenos">1407</span></a><span class="sd">            This method receives one time synchronization message, updates the store&#39;s</span>
</span><span id="Store-1408"><a href="#Store-1408"><span class="linenos">1408</span></a><span class="sd">            internal clock, and applies any traffic updates to the graph if present.</span>
</span><span id="Store-1409"><a href="#Store-1409"><span class="linenos">1409</span></a><span class="sd">            </span>
</span><span id="Store-1410"><a href="#Store-1410"><span class="linenos">1410</span></a><span class="sd">            Workflow:</span>
</span><span id="Store-1411"><a href="#Store-1411"><span class="linenos">1411</span></a><span class="sd">                1. **Receive**: Wait up to 20 seconds for inform message</span>
</span><span id="Store-1412"><a href="#Store-1412"><span class="linenos">1412</span></a><span class="sd">                2. **Validation**: Check if message received (not None)</span>
</span><span id="Store-1413"><a href="#Store-1413"><span class="linenos">1413</span></a><span class="sd">                3. **Parse**: Deserialize JSON body</span>
</span><span id="Store-1414"><a href="#Store-1414"><span class="linenos">1414</span></a><span class="sd">                4. **Extract**: Get type, time delta from JSON</span>
</span><span id="Store-1415"><a href="#Store-1415"><span class="linenos">1415</span></a><span class="sd">                5. **Sync Time**: Add delta to current_tick</span>
</span><span id="Store-1416"><a href="#Store-1416"><span class="linenos">1416</span></a><span class="sd">                6. **Check Type**: Test if type is &quot;Transit&quot; (case-insensitive)</span>
</span><span id="Store-1417"><a href="#Store-1417"><span class="linenos">1417</span></a><span class="sd">                7. **Update Graph**: If Transit, apply edge changes via update_graph()</span>
</span><span id="Store-1418"><a href="#Store-1418"><span class="linenos">1418</span></a><span class="sd">            </span>
</span><span id="Store-1419"><a href="#Store-1419"><span class="linenos">1419</span></a><span class="sd">            Time Synchronization:</span>
</span><span id="Store-1420"><a href="#Store-1420"><span class="linenos">1420</span></a><span class="sd">                Every message (regardless of type) causes time advancement:</span>
</span><span id="Store-1421"><a href="#Store-1421"><span class="linenos">1421</span></a><span class="sd">                - current_tick += delta</span>
</span><span id="Store-1422"><a href="#Store-1422"><span class="linenos">1422</span></a><span class="sd">                - Keeps store synchronized with global simulation time</span>
</span><span id="Store-1423"><a href="#Store-1423"><span class="linenos">1423</span></a><span class="sd">                - Used for order timing statistics</span>
</span><span id="Store-1424"><a href="#Store-1424"><span class="linenos">1424</span></a><span class="sd">            </span>
</span><span id="Store-1425"><a href="#Store-1425"><span class="linenos">1425</span></a><span class="sd">            Traffic Updates:</span>
</span><span id="Store-1426"><a href="#Store-1426"><span class="linenos">1426</span></a><span class="sd">                Only Transit messages include graph updates:</span>
</span><span id="Store-1427"><a href="#Store-1427"><span class="linenos">1427</span></a><span class="sd">                - data.edges contains array of edge changes</span>
</span><span id="Store-1428"><a href="#Store-1428"><span class="linenos">1428</span></a><span class="sd">                - Each edge: node1, node2, new weight, fuel_consumption</span>
</span><span id="Store-1429"><a href="#Store-1429"><span class="linenos">1429</span></a><span class="sd">                - Calls update_graph() to apply changes atomically</span>
</span><span id="Store-1430"><a href="#Store-1430"><span class="linenos">1430</span></a><span class="sd">            </span>
</span><span id="Store-1431"><a href="#Store-1431"><span class="linenos">1431</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store-1432"><a href="#Store-1432"><span class="linenos">1432</span></a><span class="sd">                - Always increments agent.current_tick</span>
</span><span id="Store-1433"><a href="#Store-1433"><span class="linenos">1433</span></a><span class="sd">                - Conditionally modifies agent.map (if Transit message)</span>
</span><span id="Store-1434"><a href="#Store-1434"><span class="linenos">1434</span></a><span class="sd">            </span>
</span><span id="Store-1435"><a href="#Store-1435"><span class="linenos">1435</span></a><span class="sd">            Returns:</span>
</span><span id="Store-1436"><a href="#Store-1436"><span class="linenos">1436</span></a><span class="sd">                None. Continues to next cycle after processing one message.</span>
</span><span id="Store-1437"><a href="#Store-1437"><span class="linenos">1437</span></a><span class="sd">            </span>
</span><span id="Store-1438"><a href="#Store-1438"><span class="linenos">1438</span></a><span class="sd">            Example:</span>
</span><span id="Store-1439"><a href="#Store-1439"><span class="linenos">1439</span></a><span class="sd">                ```</span>
</span><span id="Store-1440"><a href="#Store-1440"><span class="linenos">1440</span></a><span class="sd">                Input: {&quot;type&quot;: &quot;Transit&quot;, &quot;time&quot;: 2, &quot;data&quot;: {&quot;edges&quot;: [...]}}</span>
</span><span id="Store-1441"><a href="#Store-1441"><span class="linenos">1441</span></a><span class="sd">                Effect:</span>
</span><span id="Store-1442"><a href="#Store-1442"><span class="linenos">1442</span></a><span class="sd">                    - current_tick: 100 -&gt; 102</span>
</span><span id="Store-1443"><a href="#Store-1443"><span class="linenos">1443</span></a><span class="sd">                    - Graph edges updated with new weights</span>
</span><span id="Store-1444"><a href="#Store-1444"><span class="linenos">1444</span></a><span class="sd">                Next Cycle: Wait for next message</span>
</span><span id="Store-1445"><a href="#Store-1445"><span class="linenos">1445</span></a><span class="sd">                ```</span>
</span><span id="Store-1446"><a href="#Store-1446"><span class="linenos">1446</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-1447"><a href="#Store-1447"><span class="linenos">1447</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store-1448"><a href="#Store-1448"><span class="linenos">1448</span></a>            
</span><span id="Store-1449"><a href="#Store-1449"><span class="linenos">1449</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Store-1450"><a href="#Store-1450"><span class="linenos">1450</span></a>            
</span><span id="Store-1451"><a href="#Store-1451"><span class="linenos">1451</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store-1452"><a href="#Store-1452"><span class="linenos">1452</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Store-1453"><a href="#Store-1453"><span class="linenos">1453</span></a>                
</span><span id="Store-1454"><a href="#Store-1454"><span class="linenos">1454</span></a>                <span class="nb">type</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="Store-1455"><a href="#Store-1455"><span class="linenos">1455</span></a>                <span class="n">delta</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
</span><span id="Store-1456"><a href="#Store-1456"><span class="linenos">1456</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="Store-1457"><a href="#Store-1457"><span class="linenos">1457</span></a>                
</span><span id="Store-1458"><a href="#Store-1458"><span class="linenos">1458</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;transit&quot;</span><span class="p">:</span>
</span><span id="Store-1459"><a href="#Store-1459"><span class="linenos">1459</span></a>                    <span class="n">map_updates</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="Store-1460"><a href="#Store-1460"><span class="linenos">1460</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">update_graph</span><span class="p">(</span><span class="n">map_updates</span><span class="p">)</span>         
</span><span id="Store-1461"><a href="#Store-1461"><span class="linenos">1461</span></a>    
</span><span id="Store-1462"><a href="#Store-1462"><span class="linenos">1462</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveVehicleArrival</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="Store-1463"><a href="#Store-1463"><span class="linenos">1463</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1464"><a href="#Store-1464"><span class="linenos">1464</span></a><span class="sd">        Cyclic behaviour that handles vehicle delivery notifications.</span>
</span><span id="Store-1465"><a href="#Store-1465"><span class="linenos">1465</span></a><span class="sd">        </span>
</span><span id="Store-1466"><a href="#Store-1466"><span class="linenos">1466</span></a><span class="sd">        This behaviour processes delivery completion messages from vehicle agents,</span>
</span><span id="Store-1467"><a href="#Store-1467"><span class="linenos">1467</span></a><span class="sd">        updating inventory when products arrive at the store. It represents the final</span>
</span><span id="Store-1468"><a href="#Store-1468"><span class="linenos">1468</span></a><span class="sd">        step in the supply chain: physical delivery and stock replenishment.</span>
</span><span id="Store-1469"><a href="#Store-1469"><span class="linenos">1469</span></a><span class="sd">        </span>
</span><span id="Store-1470"><a href="#Store-1470"><span class="linenos">1470</span></a><span class="sd">        Message Types Accepted:</span>
</span><span id="Store-1471"><a href="#Store-1471"><span class="linenos">1471</span></a><span class="sd">            - **vehicle-delivery**: Vehicle completed delivery to store (primary)</span>
</span><span id="Store-1472"><a href="#Store-1472"><span class="linenos">1472</span></a><span class="sd">            - **vehicle-pickup**: Vehicle picked up goods from warehouse (informational)</span>
</span><span id="Store-1473"><a href="#Store-1473"><span class="linenos">1473</span></a><span class="sd">        </span>
</span><span id="Store-1474"><a href="#Store-1474"><span class="linenos">1474</span></a><span class="sd">        The behaviour is filtered by template to only receive vehicle-delivery messages,</span>
</span><span id="Store-1475"><a href="#Store-1475"><span class="linenos">1475</span></a><span class="sd">        but includes validation as a safety mechanism.</span>
</span><span id="Store-1476"><a href="#Store-1476"><span class="linenos">1476</span></a><span class="sd">        </span>
</span><span id="Store-1477"><a href="#Store-1477"><span class="linenos">1477</span></a><span class="sd">        Message Format:</span>
</span><span id="Store-1478"><a href="#Store-1478"><span class="linenos">1478</span></a><span class="sd">            Metadata:</span>
</span><span id="Store-1479"><a href="#Store-1479"><span class="linenos">1479</span></a><span class="sd">                - performative: &quot;vehicle-delivery&quot;</span>
</span><span id="Store-1480"><a href="#Store-1480"><span class="linenos">1480</span></a><span class="sd">                - sender: Vehicle JID</span>
</span><span id="Store-1481"><a href="#Store-1481"><span class="linenos">1481</span></a><span class="sd">            Body (JSON):</span>
</span><span id="Store-1482"><a href="#Store-1482"><span class="linenos">1482</span></a><span class="sd">                ```json</span>
</span><span id="Store-1483"><a href="#Store-1483"><span class="linenos">1483</span></a><span class="sd">                {</span>
</span><span id="Store-1484"><a href="#Store-1484"><span class="linenos">1484</span></a><span class="sd">                    &quot;orderid&quot;: 1001000000,  // Unique order identifier</span>
</span><span id="Store-1485"><a href="#Store-1485"><span class="linenos">1485</span></a><span class="sd">                    &quot;time&quot;: 150             // ETA or delivery time</span>
</span><span id="Store-1486"><a href="#Store-1486"><span class="linenos">1486</span></a><span class="sd">                }</span>
</span><span id="Store-1487"><a href="#Store-1487"><span class="linenos">1487</span></a><span class="sd">                ```</span>
</span><span id="Store-1488"><a href="#Store-1488"><span class="linenos">1488</span></a><span class="sd">        </span>
</span><span id="Store-1489"><a href="#Store-1489"><span class="linenos">1489</span></a><span class="sd">        Attributes:</span>
</span><span id="Store-1490"><a href="#Store-1490"><span class="linenos">1490</span></a><span class="sd">            Inherits from CyclicBehaviour:</span>
</span><span id="Store-1491"><a href="#Store-1491"><span class="linenos">1491</span></a><span class="sd">                - Runs continuously in infinite loop</span>
</span><span id="Store-1492"><a href="#Store-1492"><span class="linenos">1492</span></a><span class="sd">                - Processes one message per cycle</span>
</span><span id="Store-1493"><a href="#Store-1493"><span class="linenos">1493</span></a><span class="sd">                - 20-second timeout per receive attempt</span>
</span><span id="Store-1494"><a href="#Store-1494"><span class="linenos">1494</span></a><span class="sd">        </span>
</span><span id="Store-1495"><a href="#Store-1495"><span class="linenos">1495</span></a><span class="sd">        Workflow:</span>
</span><span id="Store-1496"><a href="#Store-1496"><span class="linenos">1496</span></a><span class="sd">            1. **Receive Message**: Wait up to 20 seconds for vehicle-delivery</span>
</span><span id="Store-1497"><a href="#Store-1497"><span class="linenos">1497</span></a><span class="sd">            2. **Validate Performative**: Verify it&#39;s vehicle-delivery (should be filtered)</span>
</span><span id="Store-1498"><a href="#Store-1498"><span class="linenos">1498</span></a><span class="sd">            3. **Parse JSON**: Extract orderid and time (ETA)</span>
</span><span id="Store-1499"><a href="#Store-1499"><span class="linenos">1499</span></a><span class="sd">            4. **Lookup Order**: Find order in pending_deliveries by orderid</span>
</span><span id="Store-1500"><a href="#Store-1500"><span class="linenos">1500</span></a><span class="sd">            5. **Update Stock**: Add delivered quantity to inventory</span>
</span><span id="Store-1501"><a href="#Store-1501"><span class="linenos">1501</span></a><span class="sd">            6. **Remove Pending**: Delete order from pending_deliveries</span>
</span><span id="Store-1502"><a href="#Store-1502"><span class="linenos">1502</span></a><span class="sd">            7. **Record Statistics**: Save delivery data to CSV</span>
</span><span id="Store-1503"><a href="#Store-1503"><span class="linenos">1503</span></a><span class="sd">            8. **Log Delivery**: Print confirmation and current stock</span>
</span><span id="Store-1504"><a href="#Store-1504"><span class="linenos">1504</span></a><span class="sd">            9. **Repeat**: Return to step 1 (cyclic behaviour)</span>
</span><span id="Store-1505"><a href="#Store-1505"><span class="linenos">1505</span></a><span class="sd">        </span>
</span><span id="Store-1506"><a href="#Store-1506"><span class="linenos">1506</span></a><span class="sd">        Stock Update Logic:</span>
</span><span id="Store-1507"><a href="#Store-1507"><span class="linenos">1507</span></a><span class="sd">            ```python</span>
</span><span id="Store-1508"><a href="#Store-1508"><span class="linenos">1508</span></a><span class="sd">            if product in stock:</span>
</span><span id="Store-1509"><a href="#Store-1509"><span class="linenos">1509</span></a><span class="sd">                stock[product] += quantity  # Increment existing</span>
</span><span id="Store-1510"><a href="#Store-1510"><span class="linenos">1510</span></a><span class="sd">            else:</span>
</span><span id="Store-1511"><a href="#Store-1511"><span class="linenos">1511</span></a><span class="sd">                stock[product] = quantity   # Create new entry</span>
</span><span id="Store-1512"><a href="#Store-1512"><span class="linenos">1512</span></a><span class="sd">            ```</span>
</span><span id="Store-1513"><a href="#Store-1513"><span class="linenos">1513</span></a><span class="sd">        </span>
</span><span id="Store-1514"><a href="#Store-1514"><span class="linenos">1514</span></a><span class="sd">        Statistics Recorded:</span>
</span><span id="Store-1515"><a href="#Store-1515"><span class="linenos">1515</span></a><span class="sd">            - order_id: Unique identifier</span>
</span><span id="Store-1516"><a href="#Store-1516"><span class="linenos">1516</span></a><span class="sd">            - store_jid: This store&#39;s identifier</span>
</span><span id="Store-1517"><a href="#Store-1517"><span class="linenos">1517</span></a><span class="sd">            - vehicle_jid: Delivering vehicle identifier</span>
</span><span id="Store-1518"><a href="#Store-1518"><span class="linenos">1518</span></a><span class="sd">            - origin_warehouse: Warehouse that fulfilled order</span>
</span><span id="Store-1519"><a href="#Store-1519"><span class="linenos">1519</span></a><span class="sd">            - product: Product name</span>
</span><span id="Store-1520"><a href="#Store-1520"><span class="linenos">1520</span></a><span class="sd">            - quantity: Amount delivered</span>
</span><span id="Store-1521"><a href="#Store-1521"><span class="linenos">1521</span></a><span class="sd">            - ETA: Estimated time of arrival</span>
</span><span id="Store-1522"><a href="#Store-1522"><span class="linenos">1522</span></a><span class="sd">            - time_to_delivery: Ticks from confirmation to delivery</span>
</span><span id="Store-1523"><a href="#Store-1523"><span class="linenos">1523</span></a><span class="sd">            - current_tick: Current simulation time</span>
</span><span id="Store-1524"><a href="#Store-1524"><span class="linenos">1524</span></a><span class="sd">            - final_state: &quot;delivered&quot; (success indicator)</span>
</span><span id="Store-1525"><a href="#Store-1525"><span class="linenos">1525</span></a><span class="sd">        </span>
</span><span id="Store-1526"><a href="#Store-1526"><span class="linenos">1526</span></a><span class="sd">        Error Handling:</span>
</span><span id="Store-1527"><a href="#Store-1527"><span class="linenos">1527</span></a><span class="sd">            - **Wrong Performative**: Prints ERROR and returns early</span>
</span><span id="Store-1528"><a href="#Store-1528"><span class="linenos">1528</span></a><span class="sd">            - **JSON Parse Failure**: Catches JSONDecodeError, prints ERROR</span>
</span><span id="Store-1529"><a href="#Store-1529"><span class="linenos">1529</span></a><span class="sd">            - **Missing Order ID**: Catches KeyError, prints ERROR</span>
</span><span id="Store-1530"><a href="#Store-1530"><span class="linenos">1530</span></a><span class="sd">            - Graceful degradation: Does not crash agent on malformed messages</span>
</span><span id="Store-1531"><a href="#Store-1531"><span class="linenos">1531</span></a><span class="sd">        </span>
</span><span id="Store-1532"><a href="#Store-1532"><span class="linenos">1532</span></a><span class="sd">        Example Execution:</span>
</span><span id="Store-1533"><a href="#Store-1533"><span class="linenos">1533</span></a><span class="sd">            ```</span>
</span><span id="Store-1534"><a href="#Store-1534"><span class="linenos">1534</span></a><span class="sd">            Message Received:</span>
</span><span id="Store-1535"><a href="#Store-1535"><span class="linenos">1535</span></a><span class="sd">                {</span>
</span><span id="Store-1536"><a href="#Store-1536"><span class="linenos">1536</span></a><span class="sd">                    &quot;orderid&quot;: 1001000000,</span>
</span><span id="Store-1537"><a href="#Store-1537"><span class="linenos">1537</span></a><span class="sd">                    &quot;time&quot;: 120</span>
</span><span id="Store-1538"><a href="#Store-1538"><span class="linenos">1538</span></a><span class="sd">                }</span>
</span><span id="Store-1539"><a href="#Store-1539"><span class="linenos">1539</span></a><span class="sd">            Processing:</span>
</span><span id="Store-1540"><a href="#Store-1540"><span class="linenos">1540</span></a><span class="sd">                - Find Order: product=&quot;electronics&quot;, quantity=50</span>
</span><span id="Store-1541"><a href="#Store-1541"><span class="linenos">1541</span></a><span class="sd">                - Update Stock: electronics: 200 -&gt; 250</span>
</span><span id="Store-1542"><a href="#Store-1542"><span class="linenos">1542</span></a><span class="sd">                - Remove: pending_deliveries[1001000000] deleted</span>
</span><span id="Store-1543"><a href="#Store-1543"><span class="linenos">1543</span></a><span class="sd">                - Record Stats: CSV entry with all details</span>
</span><span id="Store-1544"><a href="#Store-1544"><span class="linenos">1544</span></a><span class="sd">                - Print: &quot;Vehicle vehicle1@localhost delivered 50 units of electronics&quot;</span>
</span><span id="Store-1545"><a href="#Store-1545"><span class="linenos">1545</span></a><span class="sd">                - Print: Current stock display</span>
</span><span id="Store-1546"><a href="#Store-1546"><span class="linenos">1546</span></a><span class="sd">            ```</span>
</span><span id="Store-1547"><a href="#Store-1547"><span class="linenos">1547</span></a><span class="sd">        </span>
</span><span id="Store-1548"><a href="#Store-1548"><span class="linenos">1548</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store-1549"><a href="#Store-1549"><span class="linenos">1549</span></a><span class="sd">            - Modifies agent.stock (inventory increase)</span>
</span><span id="Store-1550"><a href="#Store-1550"><span class="linenos">1550</span></a><span class="sd">            - Removes order from agent.pending_deliveries</span>
</span><span id="Store-1551"><a href="#Store-1551"><span class="linenos">1551</span></a><span class="sd">            - Writes statistics to CSV file</span>
</span><span id="Store-1552"><a href="#Store-1552"><span class="linenos">1552</span></a><span class="sd">            - Prints delivery confirmation and stock status</span>
</span><span id="Store-1553"><a href="#Store-1553"><span class="linenos">1553</span></a><span class="sd">        </span>
</span><span id="Store-1554"><a href="#Store-1554"><span class="linenos">1554</span></a><span class="sd">        Returns:</span>
</span><span id="Store-1555"><a href="#Store-1555"><span class="linenos">1555</span></a><span class="sd">            Never returns (cyclic behaviour runs until agent stops).</span>
</span><span id="Store-1556"><a href="#Store-1556"><span class="linenos">1556</span></a><span class="sd">        </span>
</span><span id="Store-1557"><a href="#Store-1557"><span class="linenos">1557</span></a><span class="sd">        Note:</span>
</span><span id="Store-1558"><a href="#Store-1558"><span class="linenos">1558</span></a><span class="sd">            This is the ONLY place where stock is updated. Confirmations do NOT update</span>
</span><span id="Store-1559"><a href="#Store-1559"><span class="linenos">1559</span></a><span class="sd">            stock - only physical delivery does. This accurately models real-world</span>
</span><span id="Store-1560"><a href="#Store-1560"><span class="linenos">1560</span></a><span class="sd">            inventory management where confirmation  possession.</span>
</span><span id="Store-1561"><a href="#Store-1561"><span class="linenos">1561</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-1562"><a href="#Store-1562"><span class="linenos">1562</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store-1563"><a href="#Store-1563"><span class="linenos">1563</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1564"><a href="#Store-1564"><span class="linenos">1564</span></a><span class="sd">            Execute one cycle of vehicle delivery message processing.</span>
</span><span id="Store-1565"><a href="#Store-1565"><span class="linenos">1565</span></a><span class="sd">            </span>
</span><span id="Store-1566"><a href="#Store-1566"><span class="linenos">1566</span></a><span class="sd">            This method receives one delivery notification, updates inventory, records</span>
</span><span id="Store-1567"><a href="#Store-1567"><span class="linenos">1567</span></a><span class="sd">            statistics, and prepares for the next delivery message.</span>
</span><span id="Store-1568"><a href="#Store-1568"><span class="linenos">1568</span></a><span class="sd">            </span>
</span><span id="Store-1569"><a href="#Store-1569"><span class="linenos">1569</span></a><span class="sd">            Workflow:</span>
</span><span id="Store-1570"><a href="#Store-1570"><span class="linenos">1570</span></a><span class="sd">                1. **Receive**: Wait up to 20 seconds for message</span>
</span><span id="Store-1571"><a href="#Store-1571"><span class="linenos">1571</span></a><span class="sd">                2. **Validation**: Check performative is vehicle-delivery</span>
</span><span id="Store-1572"><a href="#Store-1572"><span class="linenos">1572</span></a><span class="sd">                3. **Parsing**: Deserialize JSON and extract orderid, time</span>
</span><span id="Store-1573"><a href="#Store-1573"><span class="linenos">1573</span></a><span class="sd">                4. **Order Lookup**: Find order in pending_deliveries</span>
</span><span id="Store-1574"><a href="#Store-1574"><span class="linenos">1574</span></a><span class="sd">                5. **Stock Update**: Add quantity to inventory (create or increment)</span>
</span><span id="Store-1575"><a href="#Store-1575"><span class="linenos">1575</span></a><span class="sd">                6. **Cleanup**: Remove order from pending_deliveries</span>
</span><span id="Store-1576"><a href="#Store-1576"><span class="linenos">1576</span></a><span class="sd">                7. **Statistics**: Record delivery details to CSV</span>
</span><span id="Store-1577"><a href="#Store-1577"><span class="linenos">1577</span></a><span class="sd">                8. **Logging**: Print delivery confirmation and stock display</span>
</span><span id="Store-1578"><a href="#Store-1578"><span class="linenos">1578</span></a><span class="sd">            </span>
</span><span id="Store-1579"><a href="#Store-1579"><span class="linenos">1579</span></a><span class="sd">            Error Handling:</span>
</span><span id="Store-1580"><a href="#Store-1580"><span class="linenos">1580</span></a><span class="sd">                Three validation layers:</span>
</span><span id="Store-1581"><a href="#Store-1581"><span class="linenos">1581</span></a><span class="sd">                1. Template filter (should only receive vehicle-delivery)</span>
</span><span id="Store-1582"><a href="#Store-1582"><span class="linenos">1582</span></a><span class="sd">                2. Performative check (safety validation)</span>
</span><span id="Store-1583"><a href="#Store-1583"><span class="linenos">1583</span></a><span class="sd">                3. Try-except for JSON parsing and order lookup</span>
</span><span id="Store-1584"><a href="#Store-1584"><span class="linenos">1584</span></a><span class="sd">            </span>
</span><span id="Store-1585"><a href="#Store-1585"><span class="linenos">1585</span></a><span class="sd">            Stock Update Details:</span>
</span><span id="Store-1586"><a href="#Store-1586"><span class="linenos">1586</span></a><span class="sd">                - Retrieves product and quantity from pending order</span>
</span><span id="Store-1587"><a href="#Store-1587"><span class="linenos">1587</span></a><span class="sd">                - If product exists: stock[product] += quantity</span>
</span><span id="Store-1588"><a href="#Store-1588"><span class="linenos">1588</span></a><span class="sd">                - If product new: stock[product] = quantity</span>
</span><span id="Store-1589"><a href="#Store-1589"><span class="linenos">1589</span></a><span class="sd">                - Thread-safe (single-threaded SPADE execution)</span>
</span><span id="Store-1590"><a href="#Store-1590"><span class="linenos">1590</span></a><span class="sd">            </span>
</span><span id="Store-1591"><a href="#Store-1591"><span class="linenos">1591</span></a><span class="sd">            Statistics Recording:</span>
</span><span id="Store-1592"><a href="#Store-1592"><span class="linenos">1592</span></a><span class="sd">                Calls get_stats() with:</span>
</span><span id="Store-1593"><a href="#Store-1593"><span class="linenos">1593</span></a><span class="sd">                - order: Order object with all details</span>
</span><span id="Store-1594"><a href="#Store-1594"><span class="linenos">1594</span></a><span class="sd">                - eta: Estimated time from message</span>
</span><span id="Store-1595"><a href="#Store-1595"><span class="linenos">1595</span></a><span class="sd">                - state: &quot;delivered&quot; (success indicator)</span>
</span><span id="Store-1596"><a href="#Store-1596"><span class="linenos">1596</span></a><span class="sd">                - vehicle: Vehicle JID from message sender</span>
</span><span id="Store-1597"><a href="#Store-1597"><span class="linenos">1597</span></a><span class="sd">            </span>
</span><span id="Store-1598"><a href="#Store-1598"><span class="linenos">1598</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store-1599"><a href="#Store-1599"><span class="linenos">1599</span></a><span class="sd">                - Increments stock for delivered product</span>
</span><span id="Store-1600"><a href="#Store-1600"><span class="linenos">1600</span></a><span class="sd">                - Removes order from pending_deliveries dict</span>
</span><span id="Store-1601"><a href="#Store-1601"><span class="linenos">1601</span></a><span class="sd">                - Appends row to store_stats.csv</span>
</span><span id="Store-1602"><a href="#Store-1602"><span class="linenos">1602</span></a><span class="sd">                - Prints to console (always visible, not verbose-only)</span>
</span><span id="Store-1603"><a href="#Store-1603"><span class="linenos">1603</span></a><span class="sd">            </span>
</span><span id="Store-1604"><a href="#Store-1604"><span class="linenos">1604</span></a><span class="sd">            Returns:</span>
</span><span id="Store-1605"><a href="#Store-1605"><span class="linenos">1605</span></a><span class="sd">                None. Continues to next cycle after processing one delivery.</span>
</span><span id="Store-1606"><a href="#Store-1606"><span class="linenos">1606</span></a><span class="sd">            </span>
</span><span id="Store-1607"><a href="#Store-1607"><span class="linenos">1607</span></a><span class="sd">            Example:</span>
</span><span id="Store-1608"><a href="#Store-1608"><span class="linenos">1608</span></a><span class="sd">                ```</span>
</span><span id="Store-1609"><a href="#Store-1609"><span class="linenos">1609</span></a><span class="sd">                Input: vehicle-delivery from vehicle1</span>
</span><span id="Store-1610"><a href="#Store-1610"><span class="linenos">1610</span></a><span class="sd">                    Body: {&quot;orderid&quot;: 1001000000, &quot;time&quot;: 120}</span>
</span><span id="Store-1611"><a href="#Store-1611"><span class="linenos">1611</span></a><span class="sd">                Pending Order: Order(product=&quot;electronics&quot;, quantity=50, ...)</span>
</span><span id="Store-1612"><a href="#Store-1612"><span class="linenos">1612</span></a><span class="sd">                Processing:</span>
</span><span id="Store-1613"><a href="#Store-1613"><span class="linenos">1613</span></a><span class="sd">                    - Stock before: {&quot;electronics&quot;: 200, &quot;food&quot;: 100}</span>
</span><span id="Store-1614"><a href="#Store-1614"><span class="linenos">1614</span></a><span class="sd">                    - Update: electronics += 50</span>
</span><span id="Store-1615"><a href="#Store-1615"><span class="linenos">1615</span></a><span class="sd">                    - Stock after: {&quot;electronics&quot;: 250, &quot;food&quot;: 100}</span>
</span><span id="Store-1616"><a href="#Store-1616"><span class="linenos">1616</span></a><span class="sd">                    - Remove from pending_deliveries</span>
</span><span id="Store-1617"><a href="#Store-1617"><span class="linenos">1617</span></a><span class="sd">                    - Write CSV row</span>
</span><span id="Store-1618"><a href="#Store-1618"><span class="linenos">1618</span></a><span class="sd">                Output:</span>
</span><span id="Store-1619"><a href="#Store-1619"><span class="linenos">1619</span></a><span class="sd">                    Print: &quot;Vehicle vehicle1@localhost delivered 50 units of electronics&quot;</span>
</span><span id="Store-1620"><a href="#Store-1620"><span class="linenos">1620</span></a><span class="sd">                    Print: &quot;Current stock: electronics: 250 units, food: 100 units&quot;</span>
</span><span id="Store-1621"><a href="#Store-1621"><span class="linenos">1621</span></a><span class="sd">                ```</span>
</span><span id="Store-1622"><a href="#Store-1622"><span class="linenos">1622</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store-1623"><a href="#Store-1623"><span class="linenos">1623</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store-1624"><a href="#Store-1624"><span class="linenos">1624</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Store-1625"><a href="#Store-1625"><span class="linenos">1625</span></a>            
</span><span id="Store-1626"><a href="#Store-1626"><span class="linenos">1626</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Store-1627"><a href="#Store-1627"><span class="linenos">1627</span></a>                <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Store-1628"><a href="#Store-1628"><span class="linenos">1628</span></a>                
</span><span id="Store-1629"><a href="#Store-1629"><span class="linenos">1629</span></a>                <span class="c1"># Double-check (should already be filtered by templates)</span>
</span><span id="Store-1630"><a href="#Store-1630"><span class="linenos">1630</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">]:</span>
</span><span id="Store-1631"><a href="#Store-1631"><span class="linenos">1631</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Received unexpected performative &#39;</span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="Store-1632"><a href="#Store-1632"><span class="linenos">1632</span></a>                    <span class="k">return</span>
</span><span id="Store-1633"><a href="#Store-1633"><span class="linenos">1633</span></a>                
</span><span id="Store-1634"><a href="#Store-1634"><span class="linenos">1634</span></a>                <span class="c1"># Parse message body</span>
</span><span id="Store-1635"><a href="#Store-1635"><span class="linenos">1635</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Store-1636"><a href="#Store-1636"><span class="linenos">1636</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Store-1637"><a href="#Store-1637"><span class="linenos">1637</span></a>                    <span class="n">orderid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">]</span>
</span><span id="Store-1638"><a href="#Store-1638"><span class="linenos">1638</span></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">orderid</span><span class="p">]</span>
</span><span id="Store-1639"><a href="#Store-1639"><span class="linenos">1639</span></a>                    <span class="n">eta</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>          
</span><span id="Store-1640"><a href="#Store-1640"><span class="linenos">1640</span></a>                <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Store-1641"><a href="#Store-1641"><span class="linenos">1641</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Failed to parse vehicle message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-1642"><a href="#Store-1642"><span class="linenos">1642</span></a>                    <span class="k">return</span>
</span><span id="Store-1643"><a href="#Store-1643"><span class="linenos">1643</span></a>
</span><span id="Store-1644"><a href="#Store-1644"><span class="linenos">1644</span></a>                <span class="c1"># Vehicle is delivering supplies from supplier</span>
</span><span id="Store-1645"><a href="#Store-1645"><span class="linenos">1645</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span>
</span><span id="Store-1646"><a href="#Store-1646"><span class="linenos">1646</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="Store-1647"><a href="#Store-1647"><span class="linenos">1647</span></a>                
</span><span id="Store-1648"><a href="#Store-1648"><span class="linenos">1648</span></a>                <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="Store-1649"><a href="#Store-1649"><span class="linenos">1649</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="Store-1650"><a href="#Store-1650"><span class="linenos">1650</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Store-1651"><a href="#Store-1651"><span class="linenos">1651</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Store-1652"><a href="#Store-1652"><span class="linenos">1652</span></a>                <span class="k">del</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span>
</span><span id="Store-1653"><a href="#Store-1653"><span class="linenos">1653</span></a>                
</span><span id="Store-1654"><a href="#Store-1654"><span class="linenos">1654</span></a>                <span class="c1"># Save order stats</span>
</span><span id="Store-1655"><a href="#Store-1655"><span class="linenos">1655</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span><span class="s2">&quot;delivered&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Store-1656"><a href="#Store-1656"><span class="linenos">1656</span></a>                
</span><span id="Store-1657"><a href="#Store-1657"><span class="linenos">1657</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> delivered </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-1658"><a href="#Store-1658"><span class="linenos">1658</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>    
</span><span id="Store-1659"><a href="#Store-1659"><span class="linenos">1659</span></a>
</span><span id="Store-1660"><a href="#Store-1660"><span class="linenos">1660</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Store-1661"><a href="#Store-1661"><span class="linenos">1661</span></a>    <span class="c1">#           AUXILARY FUNCTIONS</span>
</span><span id="Store-1662"><a href="#Store-1662"><span class="linenos">1662</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Store-1663"><a href="#Store-1663"><span class="linenos">1663</span></a>    
</span><span id="Store-1664"><a href="#Store-1664"><span class="linenos">1664</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_warehouse_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Store-1665"><a href="#Store-1665"><span class="linenos">1665</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1666"><a href="#Store-1666"><span class="linenos">1666</span></a><span class="sd">        Calculate the score for a warehouse proposal based on delivery time.</span>
</span><span id="Store-1667"><a href="#Store-1667"><span class="linenos">1667</span></a><span class="sd">        </span>
</span><span id="Store-1668"><a href="#Store-1668"><span class="linenos">1668</span></a><span class="sd">        This method implements the proposal evaluation logic for the FIPA Contract Net</span>
</span><span id="Store-1669"><a href="#Store-1669"><span class="linenos">1669</span></a><span class="sd">        Protocol, scoring each warehouse that submitted a proposal (warehouse-accept).</span>
</span><span id="Store-1670"><a href="#Store-1670"><span class="linenos">1670</span></a><span class="sd">        The score is based on the estimated delivery time using Dijkstra&#39;s shortest path</span>
</span><span id="Store-1671"><a href="#Store-1671"><span class="linenos">1671</span></a><span class="sd">        algorithm on the world graph.</span>
</span><span id="Store-1672"><a href="#Store-1672"><span class="linenos">1672</span></a><span class="sd">        </span>
</span><span id="Store-1673"><a href="#Store-1673"><span class="linenos">1673</span></a><span class="sd">        Scoring Algorithm:</span>
</span><span id="Store-1674"><a href="#Store-1674"><span class="linenos">1674</span></a><span class="sd">            - Uses Dijkstra pathfinding: warehouse_node -&gt; store_node</span>
</span><span id="Store-1675"><a href="#Store-1675"><span class="linenos">1675</span></a><span class="sd">            - Returns: (path, fuel_cost, delivery_time)</span>
</span><span id="Store-1676"><a href="#Store-1676"><span class="linenos">1676</span></a><span class="sd">            - Score = delivery_time (lower is better)</span>
</span><span id="Store-1677"><a href="#Store-1677"><span class="linenos">1677</span></a><span class="sd">            - Optimization goal: Minimize delivery time</span>
</span><span id="Store-1678"><a href="#Store-1678"><span class="linenos">1678</span></a><span class="sd">        </span>
</span><span id="Store-1679"><a href="#Store-1679"><span class="linenos">1679</span></a><span class="sd">        FIPA Contract Net Protocol Context:</span>
</span><span id="Store-1680"><a href="#Store-1680"><span class="linenos">1680</span></a><span class="sd">            - Phase: Proposal Evaluation</span>
</span><span id="Store-1681"><a href="#Store-1681"><span class="linenos">1681</span></a><span class="sd">            - Purpose: Compare multiple proposals objectively</span>
</span><span id="Store-1682"><a href="#Store-1682"><span class="linenos">1682</span></a><span class="sd">            - Decision Criteria: Distance-based (delivery time)</span>
</span><span id="Store-1683"><a href="#Store-1683"><span class="linenos">1683</span></a><span class="sd">            - Result: Enables selection of optimal warehouse</span>
</span><span id="Store-1684"><a href="#Store-1684"><span class="linenos">1684</span></a><span class="sd">        </span>
</span><span id="Store-1685"><a href="#Store-1685"><span class="linenos">1685</span></a><span class="sd">        Args:</span>
</span><span id="Store-1686"><a href="#Store-1686"><span class="linenos">1686</span></a><span class="sd">            accept_msg (Message): The warehouse-accept message from a warehouse.</span>
</span><span id="Store-1687"><a href="#Store-1687"><span class="linenos">1687</span></a><span class="sd">                Contains metadata with node_id of the warehouse&#39;s location.</span>
</span><span id="Store-1688"><a href="#Store-1688"><span class="linenos">1688</span></a><span class="sd">        </span>
</span><span id="Store-1689"><a href="#Store-1689"><span class="linenos">1689</span></a><span class="sd">        Returns:</span>
</span><span id="Store-1690"><a href="#Store-1690"><span class="linenos">1690</span></a><span class="sd">            float: Delivery time score. Lower values indicate better proposals</span>
</span><span id="Store-1691"><a href="#Store-1691"><span class="linenos">1691</span></a><span class="sd">                (shorter delivery time).</span>
</span><span id="Store-1692"><a href="#Store-1692"><span class="linenos">1692</span></a><span class="sd">        </span>
</span><span id="Store-1693"><a href="#Store-1693"><span class="linenos">1693</span></a><span class="sd">        Scoring Details:</span>
</span><span id="Store-1694"><a href="#Store-1694"><span class="linenos">1694</span></a><span class="sd">            - Extracts warehouse node_id from message metadata</span>
</span><span id="Store-1695"><a href="#Store-1695"><span class="linenos">1695</span></a><span class="sd">            - Calls Dijkstra: map.djikstra(warehouse_id, store_id)</span>
</span><span id="Store-1696"><a href="#Store-1696"><span class="linenos">1696</span></a><span class="sd">            - Returns time component (ignores path and fuel for scoring)</span>
</span><span id="Store-1697"><a href="#Store-1697"><span class="linenos">1697</span></a><span class="sd">            - Units: Simulation ticks (time units in the simulation)</span>
</span><span id="Store-1698"><a href="#Store-1698"><span class="linenos">1698</span></a><span class="sd">        </span>
</span><span id="Store-1699"><a href="#Store-1699"><span class="linenos">1699</span></a><span class="sd">        Example:</span>
</span><span id="Store-1700"><a href="#Store-1700"><span class="linenos">1700</span></a><span class="sd">            ```python</span>
</span><span id="Store-1701"><a href="#Store-1701"><span class="linenos">1701</span></a><span class="sd">            # Warehouse at node 10, Store at node 5</span>
</span><span id="Store-1702"><a href="#Store-1702"><span class="linenos">1702</span></a><span class="sd">            msg = warehouse_accept_message  # node_id = 10</span>
</span><span id="Store-1703"><a href="#Store-1703"><span class="linenos">1703</span></a><span class="sd">            score = store.calculate_warehouse_score(msg)</span>
</span><span id="Store-1704"><a href="#Store-1704"><span class="linenos">1704</span></a><span class="sd">            # Dijkstra returns: ([10, 8, 5], 12.5, 120)</span>
</span><span id="Store-1705"><a href="#Store-1705"><span class="linenos">1705</span></a><span class="sd">            # score = 120 (delivery time)</span>
</span><span id="Store-1706"><a href="#Store-1706"><span class="linenos">1706</span></a><span class="sd">            ```</span>
</span><span id="Store-1707"><a href="#Store-1707"><span class="linenos">1707</span></a><span class="sd">        </span>
</span><span id="Store-1708"><a href="#Store-1708"><span class="linenos">1708</span></a><span class="sd">        Note:</span>
</span><span id="Store-1709"><a href="#Store-1709"><span class="linenos">1709</span></a><span class="sd">            This method is called by CollectWarehouseResponses during proposal</span>
</span><span id="Store-1710"><a href="#Store-1710"><span class="linenos">1710</span></a><span class="sd">            evaluation. All warehouses that sent warehouse-accept are scored,</span>
</span><span id="Store-1711"><a href="#Store-1711"><span class="linenos">1711</span></a><span class="sd">            and the one with the lowest score (minimum time) is selected.</span>
</span><span id="Store-1712"><a href="#Store-1712"><span class="linenos">1712</span></a><span class="sd">        </span>
</span><span id="Store-1713"><a href="#Store-1713"><span class="linenos">1713</span></a><span class="sd">        Alternative Scoring Strategies:</span>
</span><span id="Store-1714"><a href="#Store-1714"><span class="linenos">1714</span></a><span class="sd">            The algorithm could be extended to consider:</span>
</span><span id="Store-1715"><a href="#Store-1715"><span class="linenos">1715</span></a><span class="sd">            - Weighted combination: time * w1 + fuel * w2</span>
</span><span id="Store-1716"><a href="#Store-1716"><span class="linenos">1716</span></a><span class="sd">            - Multi-criteria: time, fuel, warehouse reputation</span>
</span><span id="Store-1717"><a href="#Store-1717"><span class="linenos">1717</span></a><span class="sd">            - Dynamic weights: Based on urgency or fuel costs</span>
</span><span id="Store-1718"><a href="#Store-1718"><span class="linenos">1718</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-1719"><a href="#Store-1719"><span class="linenos">1719</span></a>        
</span><span id="Store-1720"><a href="#Store-1720"><span class="linenos">1720</span></a>        <span class="n">warehouse_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">accept_msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">))</span>
</span><span id="Store-1721"><a href="#Store-1721"><span class="linenos">1721</span></a>        <span class="n">path</span><span class="p">,</span> <span class="n">fuel</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">djikstra</span><span class="p">(</span><span class="n">warehouse_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="Store-1722"><a href="#Store-1722"><span class="linenos">1722</span></a>        
</span><span id="Store-1723"><a href="#Store-1723"><span class="linenos">1723</span></a>        <span class="k">return</span> <span class="n">time</span>
</span><span id="Store-1724"><a href="#Store-1724"><span class="linenos">1724</span></a>    
</span><span id="Store-1725"><a href="#Store-1725"><span class="linenos">1725</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dict_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
</span><span id="Store-1726"><a href="#Store-1726"><span class="linenos">1726</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1727"><a href="#Store-1727"><span class="linenos">1727</span></a><span class="sd">        Convert a dictionary representation to an Order object.</span>
</span><span id="Store-1728"><a href="#Store-1728"><span class="linenos">1728</span></a><span class="sd">        </span>
</span><span id="Store-1729"><a href="#Store-1729"><span class="linenos">1729</span></a><span class="sd">        This helper method deserializes order data from dictionary format into</span>
</span><span id="Store-1730"><a href="#Store-1730"><span class="linenos">1730</span></a><span class="sd">        an Order object instance, setting all required fields and optional location</span>
</span><span id="Store-1731"><a href="#Store-1731"><span class="linenos">1731</span></a><span class="sd">        information if present.</span>
</span><span id="Store-1732"><a href="#Store-1732"><span class="linenos">1732</span></a><span class="sd">        </span>
</span><span id="Store-1733"><a href="#Store-1733"><span class="linenos">1733</span></a><span class="sd">        Args:</span>
</span><span id="Store-1734"><a href="#Store-1734"><span class="linenos">1734</span></a><span class="sd">            data (dict): Dictionary containing order information with keys:</span>
</span><span id="Store-1735"><a href="#Store-1735"><span class="linenos">1735</span></a><span class="sd">                - product (str): Product name</span>
</span><span id="Store-1736"><a href="#Store-1736"><span class="linenos">1736</span></a><span class="sd">                - quantity (int): Quantity ordered</span>
</span><span id="Store-1737"><a href="#Store-1737"><span class="linenos">1737</span></a><span class="sd">                - orderid (int): Unique order identifier</span>
</span><span id="Store-1738"><a href="#Store-1738"><span class="linenos">1738</span></a><span class="sd">                - sender (str): Sender&#39;s JID</span>
</span><span id="Store-1739"><a href="#Store-1739"><span class="linenos">1739</span></a><span class="sd">                - receiver (str): Receiver&#39;s JID</span>
</span><span id="Store-1740"><a href="#Store-1740"><span class="linenos">1740</span></a><span class="sd">                - sender_location (int, optional): Sender&#39;s graph node ID</span>
</span><span id="Store-1741"><a href="#Store-1741"><span class="linenos">1741</span></a><span class="sd">                - receiver_location (int, optional): Receiver&#39;s graph node ID</span>
</span><span id="Store-1742"><a href="#Store-1742"><span class="linenos">1742</span></a><span class="sd">        </span>
</span><span id="Store-1743"><a href="#Store-1743"><span class="linenos">1743</span></a><span class="sd">        Returns:</span>
</span><span id="Store-1744"><a href="#Store-1744"><span class="linenos">1744</span></a><span class="sd">            Order: Fully populated Order object with all fields from dictionary.</span>
</span><span id="Store-1745"><a href="#Store-1745"><span class="linenos">1745</span></a><span class="sd">        </span>
</span><span id="Store-1746"><a href="#Store-1746"><span class="linenos">1746</span></a><span class="sd">        Example:</span>
</span><span id="Store-1747"><a href="#Store-1747"><span class="linenos">1747</span></a><span class="sd">            ```python</span>
</span><span id="Store-1748"><a href="#Store-1748"><span class="linenos">1748</span></a><span class="sd">            data = {</span>
</span><span id="Store-1749"><a href="#Store-1749"><span class="linenos">1749</span></a><span class="sd">                &quot;product&quot;: &quot;electronics&quot;,</span>
</span><span id="Store-1750"><a href="#Store-1750"><span class="linenos">1750</span></a><span class="sd">                &quot;quantity&quot;: 50,</span>
</span><span id="Store-1751"><a href="#Store-1751"><span class="linenos">1751</span></a><span class="sd">                &quot;orderid&quot;: 1001000000,</span>
</span><span id="Store-1752"><a href="#Store-1752"><span class="linenos">1752</span></a><span class="sd">                &quot;sender&quot;: &quot;warehouse1@localhost&quot;,</span>
</span><span id="Store-1753"><a href="#Store-1753"><span class="linenos">1753</span></a><span class="sd">                &quot;receiver&quot;: &quot;store1@localhost&quot;,</span>
</span><span id="Store-1754"><a href="#Store-1754"><span class="linenos">1754</span></a><span class="sd">                &quot;sender_location&quot;: 10,</span>
</span><span id="Store-1755"><a href="#Store-1755"><span class="linenos">1755</span></a><span class="sd">                &quot;receiver_location&quot;: 5</span>
</span><span id="Store-1756"><a href="#Store-1756"><span class="linenos">1756</span></a><span class="sd">            }</span>
</span><span id="Store-1757"><a href="#Store-1757"><span class="linenos">1757</span></a><span class="sd">            order = store.dict_to_order(data)</span>
</span><span id="Store-1758"><a href="#Store-1758"><span class="linenos">1758</span></a><span class="sd">            # order.product == &quot;electronics&quot;, order.quantity == 50, etc.</span>
</span><span id="Store-1759"><a href="#Store-1759"><span class="linenos">1759</span></a><span class="sd">            ```</span>
</span><span id="Store-1760"><a href="#Store-1760"><span class="linenos">1760</span></a><span class="sd">        </span>
</span><span id="Store-1761"><a href="#Store-1761"><span class="linenos">1761</span></a><span class="sd">        Note:</span>
</span><span id="Store-1762"><a href="#Store-1762"><span class="linenos">1762</span></a><span class="sd">            Uses dict.get() for optional location fields to handle cases where</span>
</span><span id="Store-1763"><a href="#Store-1763"><span class="linenos">1763</span></a><span class="sd">            location information is not provided (returns None by default).</span>
</span><span id="Store-1764"><a href="#Store-1764"><span class="linenos">1764</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-1765"><a href="#Store-1765"><span class="linenos">1765</span></a>        <span class="n">order</span> <span class="o">=</span>  <span class="n">Order</span><span class="p">(</span>
</span><span id="Store-1766"><a href="#Store-1766"><span class="linenos">1766</span></a>            <span class="n">product</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span>
</span><span id="Store-1767"><a href="#Store-1767"><span class="linenos">1767</span></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">],</span>
</span><span id="Store-1768"><a href="#Store-1768"><span class="linenos">1768</span></a>            <span class="n">orderid</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">],</span>
</span><span id="Store-1769"><a href="#Store-1769"><span class="linenos">1769</span></a>            <span class="n">sender</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;sender&quot;</span><span class="p">],</span>
</span><span id="Store-1770"><a href="#Store-1770"><span class="linenos">1770</span></a>            <span class="n">receiver</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;receiver&quot;</span><span class="p">]</span>
</span><span id="Store-1771"><a href="#Store-1771"><span class="linenos">1771</span></a>        <span class="p">)</span>
</span><span id="Store-1772"><a href="#Store-1772"><span class="linenos">1772</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sender_location&quot;</span><span class="p">)</span>
</span><span id="Store-1773"><a href="#Store-1773"><span class="linenos">1773</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;receiver_location&quot;</span><span class="p">)</span>
</span><span id="Store-1774"><a href="#Store-1774"><span class="linenos">1774</span></a>        <span class="k">return</span> <span class="n">order</span>
</span><span id="Store-1775"><a href="#Store-1775"><span class="linenos">1775</span></a>    
</span><span id="Store-1776"><a href="#Store-1776"><span class="linenos">1776</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">message_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
</span><span id="Store-1777"><a href="#Store-1777"><span class="linenos">1777</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1778"><a href="#Store-1778"><span class="linenos">1778</span></a><span class="sd">        Convert a warehouse-accept message to an Order object.</span>
</span><span id="Store-1779"><a href="#Store-1779"><span class="linenos">1779</span></a><span class="sd">        </span>
</span><span id="Store-1780"><a href="#Store-1780"><span class="linenos">1780</span></a><span class="sd">        This helper method transforms a SPADE message received during the FIPA Contract</span>
</span><span id="Store-1781"><a href="#Store-1781"><span class="linenos">1781</span></a><span class="sd">        Net Protocol into a structured Order object suitable for tracking and processing.</span>
</span><span id="Store-1782"><a href="#Store-1782"><span class="linenos">1782</span></a><span class="sd">        It extracts all relevant information from the message metadata and body.</span>
</span><span id="Store-1783"><a href="#Store-1783"><span class="linenos">1783</span></a><span class="sd">        </span>
</span><span id="Store-1784"><a href="#Store-1784"><span class="linenos">1784</span></a><span class="sd">        The method is used after a warehouse is selected (during SendStoreConfirmation)</span>
</span><span id="Store-1785"><a href="#Store-1785"><span class="linenos">1785</span></a><span class="sd">        to create an Order object for tracking in pending_deliveries.</span>
</span><span id="Store-1786"><a href="#Store-1786"><span class="linenos">1786</span></a><span class="sd">        </span>
</span><span id="Store-1787"><a href="#Store-1787"><span class="linenos">1787</span></a><span class="sd">        Args:</span>
</span><span id="Store-1788"><a href="#Store-1788"><span class="linenos">1788</span></a><span class="sd">            msg (Message): The warehouse-accept message containing order details.</span>
</span><span id="Store-1789"><a href="#Store-1789"><span class="linenos">1789</span></a><span class="sd">                Metadata includes: request_id, node_id (warehouse location)</span>
</span><span id="Store-1790"><a href="#Store-1790"><span class="linenos">1790</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-1791"><a href="#Store-1791"><span class="linenos">1791</span></a><span class="sd">        </span>
</span><span id="Store-1792"><a href="#Store-1792"><span class="linenos">1792</span></a><span class="sd">        Returns:</span>
</span><span id="Store-1793"><a href="#Store-1793"><span class="linenos">1793</span></a><span class="sd">            Order: Fully populated Order object with:</span>
</span><span id="Store-1794"><a href="#Store-1794"><span class="linenos">1794</span></a><span class="sd">                - product: Extracted from message body</span>
</span><span id="Store-1795"><a href="#Store-1795"><span class="linenos">1795</span></a><span class="sd">                - quantity: Extracted from message body</span>
</span><span id="Store-1796"><a href="#Store-1796"><span class="linenos">1796</span></a><span class="sd">                - orderid: From request_id metadata</span>
</span><span id="Store-1797"><a href="#Store-1797"><span class="linenos">1797</span></a><span class="sd">                - sender: Warehouse JID (message sender)</span>
</span><span id="Store-1798"><a href="#Store-1798"><span class="linenos">1798</span></a><span class="sd">                - receiver: Store JID (this store)</span>
</span><span id="Store-1799"><a href="#Store-1799"><span class="linenos">1799</span></a><span class="sd">                - sender_location: Warehouse node ID (from metadata)</span>
</span><span id="Store-1800"><a href="#Store-1800"><span class="linenos">1800</span></a><span class="sd">                - receiver_location: Store node ID (this store&#39;s location)</span>
</span><span id="Store-1801"><a href="#Store-1801"><span class="linenos">1801</span></a><span class="sd">        </span>
</span><span id="Store-1802"><a href="#Store-1802"><span class="linenos">1802</span></a><span class="sd">        Message Parsing:</span>
</span><span id="Store-1803"><a href="#Store-1803"><span class="linenos">1803</span></a><span class="sd">            Body:</span>
</span><span id="Store-1804"><a href="#Store-1804"><span class="linenos">1804</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store-1805"><a href="#Store-1805"><span class="linenos">1805</span></a><span class="sd">                - Split on space: parts[0] = quantity, parts[1] = product</span>
</span><span id="Store-1806"><a href="#Store-1806"><span class="linenos">1806</span></a><span class="sd">                - Example: &quot;50 electronics&quot; -&gt; quantity=50, product=&quot;electronics&quot;</span>
</span><span id="Store-1807"><a href="#Store-1807"><span class="linenos">1807</span></a><span class="sd">            </span>
</span><span id="Store-1808"><a href="#Store-1808"><span class="linenos">1808</span></a><span class="sd">            Metadata:</span>
</span><span id="Store-1809"><a href="#Store-1809"><span class="linenos">1809</span></a><span class="sd">                - request_id: Used as orderid for correlation</span>
</span><span id="Store-1810"><a href="#Store-1810"><span class="linenos">1810</span></a><span class="sd">                - node_id: Warehouse&#39;s graph location</span>
</span><span id="Store-1811"><a href="#Store-1811"><span class="linenos">1811</span></a><span class="sd">                - sender: Warehouse&#39;s JID</span>
</span><span id="Store-1812"><a href="#Store-1812"><span class="linenos">1812</span></a><span class="sd">        </span>
</span><span id="Store-1813"><a href="#Store-1813"><span class="linenos">1813</span></a><span class="sd">        Location Assignment:</span>
</span><span id="Store-1814"><a href="#Store-1814"><span class="linenos">1814</span></a><span class="sd">            - sender_location: Warehouse node (from message node_id)</span>
</span><span id="Store-1815"><a href="#Store-1815"><span class="linenos">1815</span></a><span class="sd">            - receiver_location: Store node (this store&#39;s node_id)</span>
</span><span id="Store-1816"><a href="#Store-1816"><span class="linenos">1816</span></a><span class="sd">            - Note: Reversed compared to dict_to_order perspective</span>
</span><span id="Store-1817"><a href="#Store-1817"><span class="linenos">1817</span></a><span class="sd">        </span>
</span><span id="Store-1818"><a href="#Store-1818"><span class="linenos">1818</span></a><span class="sd">        Example:</span>
</span><span id="Store-1819"><a href="#Store-1819"><span class="linenos">1819</span></a><span class="sd">            ```python</span>
</span><span id="Store-1820"><a href="#Store-1820"><span class="linenos">1820</span></a><span class="sd">            # Warehouse-accept message</span>
</span><span id="Store-1821"><a href="#Store-1821"><span class="linenos">1821</span></a><span class="sd">            msg.body = &quot;50 electronics&quot;</span>
</span><span id="Store-1822"><a href="#Store-1822"><span class="linenos">1822</span></a><span class="sd">            msg.sender = &quot;warehouse2@localhost&quot;</span>
</span><span id="Store-1823"><a href="#Store-1823"><span class="linenos">1823</span></a><span class="sd">            msg.metadata[&quot;request_id&quot;] = &quot;1001000000&quot;</span>
</span><span id="Store-1824"><a href="#Store-1824"><span class="linenos">1824</span></a><span class="sd">            msg.metadata[&quot;node_id&quot;] = &quot;10&quot;</span>
</span><span id="Store-1825"><a href="#Store-1825"><span class="linenos">1825</span></a><span class="sd">            </span>
</span><span id="Store-1826"><a href="#Store-1826"><span class="linenos">1826</span></a><span class="sd">            order = store.message_to_order(msg)</span>
</span><span id="Store-1827"><a href="#Store-1827"><span class="linenos">1827</span></a><span class="sd">            # order.product = &quot;electronics&quot;</span>
</span><span id="Store-1828"><a href="#Store-1828"><span class="linenos">1828</span></a><span class="sd">            # order.quantity = 50</span>
</span><span id="Store-1829"><a href="#Store-1829"><span class="linenos">1829</span></a><span class="sd">            # order.orderid = 1001000000</span>
</span><span id="Store-1830"><a href="#Store-1830"><span class="linenos">1830</span></a><span class="sd">            # order.sender = &quot;warehouse2@localhost&quot;</span>
</span><span id="Store-1831"><a href="#Store-1831"><span class="linenos">1831</span></a><span class="sd">            # order.receiver = &quot;store1@localhost&quot;</span>
</span><span id="Store-1832"><a href="#Store-1832"><span class="linenos">1832</span></a><span class="sd">            # order.sender_location = 10 (warehouse)</span>
</span><span id="Store-1833"><a href="#Store-1833"><span class="linenos">1833</span></a><span class="sd">            # order.receiver_location = 5 (store)</span>
</span><span id="Store-1834"><a href="#Store-1834"><span class="linenos">1834</span></a><span class="sd">            ```</span>
</span><span id="Store-1835"><a href="#Store-1835"><span class="linenos">1835</span></a><span class="sd">        </span>
</span><span id="Store-1836"><a href="#Store-1836"><span class="linenos">1836</span></a><span class="sd">        Note:</span>
</span><span id="Store-1837"><a href="#Store-1837"><span class="linenos">1837</span></a><span class="sd">            The Order object is used for:</span>
</span><span id="Store-1838"><a href="#Store-1838"><span class="linenos">1838</span></a><span class="sd">            - Tracking in pending_deliveries dict (awaiting vehicle delivery)</span>
</span><span id="Store-1839"><a href="#Store-1839"><span class="linenos">1839</span></a><span class="sd">            - Recording timing information for statistics</span>
</span><span id="Store-1840"><a href="#Store-1840"><span class="linenos">1840</span></a><span class="sd">            - Providing vehicle with delivery instructions</span>
</span><span id="Store-1841"><a href="#Store-1841"><span class="linenos">1841</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-1842"><a href="#Store-1842"><span class="linenos">1842</span></a>        <span class="n">body</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="Store-1843"><a href="#Store-1843"><span class="linenos">1843</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store-1844"><a href="#Store-1844"><span class="linenos">1844</span></a>        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store-1845"><a href="#Store-1845"><span class="linenos">1845</span></a>        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store-1846"><a href="#Store-1846"><span class="linenos">1846</span></a>        
</span><span id="Store-1847"><a href="#Store-1847"><span class="linenos">1847</span></a>        <span class="n">order_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Store-1848"><a href="#Store-1848"><span class="linenos">1848</span></a>        <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>  <span class="c1"># Store JID</span>
</span><span id="Store-1849"><a href="#Store-1849"><span class="linenos">1849</span></a>        <span class="n">receiver</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">)</span>  <span class="c1"># Warehouse JID</span>
</span><span id="Store-1850"><a href="#Store-1850"><span class="linenos">1850</span></a>        <span class="n">store_location</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">))</span>
</span><span id="Store-1851"><a href="#Store-1851"><span class="linenos">1851</span></a>        <span class="n">warehouse_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span>
</span><span id="Store-1852"><a href="#Store-1852"><span class="linenos">1852</span></a>        
</span><span id="Store-1853"><a href="#Store-1853"><span class="linenos">1853</span></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
</span><span id="Store-1854"><a href="#Store-1854"><span class="linenos">1854</span></a>            <span class="n">product</span><span class="o">=</span><span class="n">product</span><span class="p">,</span>
</span><span id="Store-1855"><a href="#Store-1855"><span class="linenos">1855</span></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="Store-1856"><a href="#Store-1856"><span class="linenos">1856</span></a>            <span class="n">orderid</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
</span><span id="Store-1857"><a href="#Store-1857"><span class="linenos">1857</span></a>            <span class="n">sender</span><span class="o">=</span><span class="n">sender</span><span class="p">,</span>
</span><span id="Store-1858"><a href="#Store-1858"><span class="linenos">1858</span></a>            <span class="n">receiver</span><span class="o">=</span><span class="n">receiver</span>
</span><span id="Store-1859"><a href="#Store-1859"><span class="linenos">1859</span></a>        <span class="p">)</span>
</span><span id="Store-1860"><a href="#Store-1860"><span class="linenos">1860</span></a>        
</span><span id="Store-1861"><a href="#Store-1861"><span class="linenos">1861</span></a>        <span class="c1"># Set locations</span>
</span><span id="Store-1862"><a href="#Store-1862"><span class="linenos">1862</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span> <span class="o">=</span> <span class="n">store_location</span>  <span class="c1"># Store location</span>
</span><span id="Store-1863"><a href="#Store-1863"><span class="linenos">1863</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span> <span class="o">=</span> <span class="n">warehouse_location</span>  <span class="c1"># Warehouse location</span>
</span><span id="Store-1864"><a href="#Store-1864"><span class="linenos">1864</span></a>        
</span><span id="Store-1865"><a href="#Store-1865"><span class="linenos">1865</span></a>        <span class="k">return</span> <span class="n">order</span>
</span><span id="Store-1866"><a href="#Store-1866"><span class="linenos">1866</span></a>    
</span><span id="Store-1867"><a href="#Store-1867"><span class="linenos">1867</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_buy_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store-1868"><a href="#Store-1868"><span class="linenos">1868</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1869"><a href="#Store-1869"><span class="linenos">1869</span></a><span class="sd">        Set standard metadata for purchase request messages (FIPA CFP).</span>
</span><span id="Store-1870"><a href="#Store-1870"><span class="linenos">1870</span></a><span class="sd">        </span>
</span><span id="Store-1871"><a href="#Store-1871"><span class="linenos">1871</span></a><span class="sd">        This helper method populates common metadata fields for store-buy messages,</span>
</span><span id="Store-1872"><a href="#Store-1872"><span class="linenos">1872</span></a><span class="sd">        ensuring consistency across all purchase requests. It sets the performative</span>
</span><span id="Store-1873"><a href="#Store-1873"><span class="linenos">1873</span></a><span class="sd">        and store identifier, with the caller responsible for setting the request_id.</span>
</span><span id="Store-1874"><a href="#Store-1874"><span class="linenos">1874</span></a><span class="sd">        </span>
</span><span id="Store-1875"><a href="#Store-1875"><span class="linenos">1875</span></a><span class="sd">        FIPA Protocol:</span>
</span><span id="Store-1876"><a href="#Store-1876"><span class="linenos">1876</span></a><span class="sd">            This prepares the message for the Call for Proposals (CFP) phase of the</span>
</span><span id="Store-1877"><a href="#Store-1877"><span class="linenos">1877</span></a><span class="sd">            FIPA Contract Net Protocol.</span>
</span><span id="Store-1878"><a href="#Store-1878"><span class="linenos">1878</span></a><span class="sd">        </span>
</span><span id="Store-1879"><a href="#Store-1879"><span class="linenos">1879</span></a><span class="sd">        Args:</span>
</span><span id="Store-1880"><a href="#Store-1880"><span class="linenos">1880</span></a><span class="sd">            msg (Message): The message to populate with metadata. Modified in-place.</span>
</span><span id="Store-1881"><a href="#Store-1881"><span class="linenos">1881</span></a><span class="sd">        </span>
</span><span id="Store-1882"><a href="#Store-1882"><span class="linenos">1882</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store-1883"><a href="#Store-1883"><span class="linenos">1883</span></a><span class="sd">            Modifies msg metadata:</span>
</span><span id="Store-1884"><a href="#Store-1884"><span class="linenos">1884</span></a><span class="sd">                - performative: Set to &quot;store-buy&quot; (FIPA CFP)</span>
</span><span id="Store-1885"><a href="#Store-1885"><span class="linenos">1885</span></a><span class="sd">                - store_id: Set to this store&#39;s JID</span>
</span><span id="Store-1886"><a href="#Store-1886"><span class="linenos">1886</span></a><span class="sd">        </span>
</span><span id="Store-1887"><a href="#Store-1887"><span class="linenos">1887</span></a><span class="sd">        Note:</span>
</span><span id="Store-1888"><a href="#Store-1888"><span class="linenos">1888</span></a><span class="sd">            The request_id must be set separately by the caller to ensure unique</span>
</span><span id="Store-1889"><a href="#Store-1889"><span class="linenos">1889</span></a><span class="sd">            identification for each purchase request. This separation allows for</span>
</span><span id="Store-1890"><a href="#Store-1890"><span class="linenos">1890</span></a><span class="sd">            proper ID encoding and avoids duplication.</span>
</span><span id="Store-1891"><a href="#Store-1891"><span class="linenos">1891</span></a><span class="sd">        </span>
</span><span id="Store-1892"><a href="#Store-1892"><span class="linenos">1892</span></a><span class="sd">        Example:</span>
</span><span id="Store-1893"><a href="#Store-1893"><span class="linenos">1893</span></a><span class="sd">            ```python</span>
</span><span id="Store-1894"><a href="#Store-1894"><span class="linenos">1894</span></a><span class="sd">            msg = Message(to=&quot;warehouse1@localhost&quot;)</span>
</span><span id="Store-1895"><a href="#Store-1895"><span class="linenos">1895</span></a><span class="sd">            store.set_buy_metadata(msg)</span>
</span><span id="Store-1896"><a href="#Store-1896"><span class="linenos">1896</span></a><span class="sd">            msg.set_metadata(&quot;request_id&quot;, &quot;1001000000&quot;)  # Caller sets this</span>
</span><span id="Store-1897"><a href="#Store-1897"><span class="linenos">1897</span></a><span class="sd">            msg.body = &quot;50 electronics&quot;</span>
</span><span id="Store-1898"><a href="#Store-1898"><span class="linenos">1898</span></a><span class="sd">            # Message ready to send as FIPA CFP</span>
</span><span id="Store-1899"><a href="#Store-1899"><span class="linenos">1899</span></a><span class="sd">            ```</span>
</span><span id="Store-1900"><a href="#Store-1900"><span class="linenos">1900</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-1901"><a href="#Store-1901"><span class="linenos">1901</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-buy&quot;</span><span class="p">)</span>
</span><span id="Store-1902"><a href="#Store-1902"><span class="linenos">1902</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store-1903"><a href="#Store-1903"><span class="linenos">1903</span></a>        <span class="c1"># NOTE: request_id should be set separately by the caller</span>
</span><span id="Store-1904"><a href="#Store-1904"><span class="linenos">1904</span></a>    
</span><span id="Store-1905"><a href="#Store-1905"><span class="linenos">1905</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traffic_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store-1906"><a href="#Store-1906"><span class="linenos">1906</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1907"><a href="#Store-1907"><span class="linenos">1907</span></a><span class="sd">        Apply dynamic traffic updates to the world graph.</span>
</span><span id="Store-1908"><a href="#Store-1908"><span class="linenos">1908</span></a><span class="sd">        </span>
</span><span id="Store-1909"><a href="#Store-1909"><span class="linenos">1909</span></a><span class="sd">        This method processes transit messages from the world agent, updating edge</span>
</span><span id="Store-1910"><a href="#Store-1910"><span class="linenos">1910</span></a><span class="sd">        weights in the graph to reflect current traffic conditions. These updates</span>
</span><span id="Store-1911"><a href="#Store-1911"><span class="linenos">1911</span></a><span class="sd">        affect pathfinding calculations used in warehouse selection, making the</span>
</span><span id="Store-1912"><a href="#Store-1912"><span class="linenos">1912</span></a><span class="sd">        system responsive to real-time network conditions.</span>
</span><span id="Store-1913"><a href="#Store-1913"><span class="linenos">1913</span></a><span class="sd">        </span>
</span><span id="Store-1914"><a href="#Store-1914"><span class="linenos">1914</span></a><span class="sd">        Traffic Data Format:</span>
</span><span id="Store-1915"><a href="#Store-1915"><span class="linenos">1915</span></a><span class="sd">            ```json</span>
</span><span id="Store-1916"><a href="#Store-1916"><span class="linenos">1916</span></a><span class="sd">            {</span>
</span><span id="Store-1917"><a href="#Store-1917"><span class="linenos">1917</span></a><span class="sd">                &quot;edges&quot;: [</span>
</span><span id="Store-1918"><a href="#Store-1918"><span class="linenos">1918</span></a><span class="sd">                    {</span>
</span><span id="Store-1919"><a href="#Store-1919"><span class="linenos">1919</span></a><span class="sd">                        &quot;node1&quot;: 5,</span>
</span><span id="Store-1920"><a href="#Store-1920"><span class="linenos">1920</span></a><span class="sd">                        &quot;node2&quot;: 10,</span>
</span><span id="Store-1921"><a href="#Store-1921"><span class="linenos">1921</span></a><span class="sd">                        &quot;weight&quot;: 200,</span>
</span><span id="Store-1922"><a href="#Store-1922"><span class="linenos">1922</span></a><span class="sd">                        &quot;fuel_consumption&quot;: 15.0</span>
</span><span id="Store-1923"><a href="#Store-1923"><span class="linenos">1923</span></a><span class="sd">                    },</span>
</span><span id="Store-1924"><a href="#Store-1924"><span class="linenos">1924</span></a><span class="sd">                    ...</span>
</span><span id="Store-1925"><a href="#Store-1925"><span class="linenos">1925</span></a><span class="sd">                ]</span>
</span><span id="Store-1926"><a href="#Store-1926"><span class="linenos">1926</span></a><span class="sd">            }</span>
</span><span id="Store-1927"><a href="#Store-1927"><span class="linenos">1927</span></a><span class="sd">            ```</span>
</span><span id="Store-1928"><a href="#Store-1928"><span class="linenos">1928</span></a><span class="sd">        </span>
</span><span id="Store-1929"><a href="#Store-1929"><span class="linenos">1929</span></a><span class="sd">        Args:</span>
</span><span id="Store-1930"><a href="#Store-1930"><span class="linenos">1930</span></a><span class="sd">            traffic_data (dict): Dictionary containing edge updates with key &quot;edges&quot;</span>
</span><span id="Store-1931"><a href="#Store-1931"><span class="linenos">1931</span></a><span class="sd">                mapping to a list of edge information dictionaries.</span>
</span><span id="Store-1932"><a href="#Store-1932"><span class="linenos">1932</span></a><span class="sd">        </span>
</span><span id="Store-1933"><a href="#Store-1933"><span class="linenos">1933</span></a><span class="sd">        Edge Processing:</span>
</span><span id="Store-1934"><a href="#Store-1934"><span class="linenos">1934</span></a><span class="sd">            For each edge in traffic_data[&quot;edges&quot;]:</span>
</span><span id="Store-1935"><a href="#Store-1935"><span class="linenos">1935</span></a><span class="sd">                - Extract: node1, node2, new_weight</span>
</span><span id="Store-1936"><a href="#Store-1936"><span class="linenos">1936</span></a><span class="sd">                - Lookup: Find edge in graph using get_edge(node1, node2)</span>
</span><span id="Store-1937"><a href="#Store-1937"><span class="linenos">1937</span></a><span class="sd">                - Update: Set edge.weight = new_weight if edge exists</span>
</span><span id="Store-1938"><a href="#Store-1938"><span class="linenos">1938</span></a><span class="sd">                - Skip: If edge not found (graceful handling)</span>
</span><span id="Store-1939"><a href="#Store-1939"><span class="linenos">1939</span></a><span class="sd">        </span>
</span><span id="Store-1940"><a href="#Store-1940"><span class="linenos">1940</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store-1941"><a href="#Store-1941"><span class="linenos">1941</span></a><span class="sd">            - Modifies edge weights in self.map (world graph)</span>
</span><span id="Store-1942"><a href="#Store-1942"><span class="linenos">1942</span></a><span class="sd">            - Affects future Dijkstra calculations</span>
</span><span id="Store-1943"><a href="#Store-1943"><span class="linenos">1943</span></a><span class="sd">            - Changes warehouse scoring results</span>
</span><span id="Store-1944"><a href="#Store-1944"><span class="linenos">1944</span></a><span class="sd">            - Does NOT modify fuel_consumption (current implementation)</span>
</span><span id="Store-1945"><a href="#Store-1945"><span class="linenos">1945</span></a><span class="sd">        </span>
</span><span id="Store-1946"><a href="#Store-1946"><span class="linenos">1946</span></a><span class="sd">        Example:</span>
</span><span id="Store-1947"><a href="#Store-1947"><span class="linenos">1947</span></a><span class="sd">            ```python</span>
</span><span id="Store-1948"><a href="#Store-1948"><span class="linenos">1948</span></a><span class="sd">            traffic_data = {</span>
</span><span id="Store-1949"><a href="#Store-1949"><span class="linenos">1949</span></a><span class="sd">                &quot;edges&quot;: [</span>
</span><span id="Store-1950"><a href="#Store-1950"><span class="linenos">1950</span></a><span class="sd">                    {&quot;node1&quot;: 5, &quot;node2&quot;: 10, &quot;weight&quot;: 200, &quot;fuel_consumption&quot;: 15.0},</span>
</span><span id="Store-1951"><a href="#Store-1951"><span class="linenos">1951</span></a><span class="sd">                    {&quot;node1&quot;: 10, &quot;node2&quot;: 15, &quot;weight&quot;: 150, &quot;fuel_consumption&quot;: 12.0}</span>
</span><span id="Store-1952"><a href="#Store-1952"><span class="linenos">1952</span></a><span class="sd">                ]</span>
</span><span id="Store-1953"><a href="#Store-1953"><span class="linenos">1953</span></a><span class="sd">            }</span>
</span><span id="Store-1954"><a href="#Store-1954"><span class="linenos">1954</span></a><span class="sd">            store.update_graph(traffic_data)</span>
</span><span id="Store-1955"><a href="#Store-1955"><span class="linenos">1955</span></a><span class="sd">            # Edge (5, 10) weight updated to 200</span>
</span><span id="Store-1956"><a href="#Store-1956"><span class="linenos">1956</span></a><span class="sd">            # Edge (10, 15) weight updated to 150</span>
</span><span id="Store-1957"><a href="#Store-1957"><span class="linenos">1957</span></a><span class="sd">            # Future pathfinding uses new weights</span>
</span><span id="Store-1958"><a href="#Store-1958"><span class="linenos">1958</span></a><span class="sd">            ```</span>
</span><span id="Store-1959"><a href="#Store-1959"><span class="linenos">1959</span></a><span class="sd">        </span>
</span><span id="Store-1960"><a href="#Store-1960"><span class="linenos">1960</span></a><span class="sd">        Note:</span>
</span><span id="Store-1961"><a href="#Store-1961"><span class="linenos">1961</span></a><span class="sd">            Currently only updates weight, not fuel_consumption. Future enhancement</span>
</span><span id="Store-1962"><a href="#Store-1962"><span class="linenos">1962</span></a><span class="sd">            could update fuel_consumption as well for more realistic simulation:</span>
</span><span id="Store-1963"><a href="#Store-1963"><span class="linenos">1963</span></a><span class="sd">            ```python</span>
</span><span id="Store-1964"><a href="#Store-1964"><span class="linenos">1964</span></a><span class="sd">            if edge:</span>
</span><span id="Store-1965"><a href="#Store-1965"><span class="linenos">1965</span></a><span class="sd">                edge.weight = new_weight</span>
</span><span id="Store-1966"><a href="#Store-1966"><span class="linenos">1966</span></a><span class="sd">                edge.fuel_consumption = new_fuel  # Not currently implemented</span>
</span><span id="Store-1967"><a href="#Store-1967"><span class="linenos">1967</span></a><span class="sd">            ```</span>
</span><span id="Store-1968"><a href="#Store-1968"><span class="linenos">1968</span></a><span class="sd">        </span>
</span><span id="Store-1969"><a href="#Store-1969"><span class="linenos">1969</span></a><span class="sd">        Impact on System:</span>
</span><span id="Store-1970"><a href="#Store-1970"><span class="linenos">1970</span></a><span class="sd">            - Dynamic responsiveness to traffic conditions</span>
</span><span id="Store-1971"><a href="#Store-1971"><span class="linenos">1971</span></a><span class="sd">            - Warehouses with congested routes become less attractive</span>
</span><span id="Store-1972"><a href="#Store-1972"><span class="linenos">1972</span></a><span class="sd">            - Enables simulation of rush hours, accidents, road closures</span>
</span><span id="Store-1973"><a href="#Store-1973"><span class="linenos">1973</span></a><span class="sd">            - Realistic supply chain behavior under varying conditions</span>
</span><span id="Store-1974"><a href="#Store-1974"><span class="linenos">1974</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-1975"><a href="#Store-1975"><span class="linenos">1975</span></a>        <span class="k">for</span> <span class="n">edge_info</span> <span class="ow">in</span> <span class="n">traffic_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Store-1976"><a href="#Store-1976"><span class="linenos">1976</span></a>                <span class="n">node1_id</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node1&quot;</span><span class="p">)</span>
</span><span id="Store-1977"><a href="#Store-1977"><span class="linenos">1977</span></a>                <span class="n">node2_id</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node2&quot;</span><span class="p">)</span>
</span><span id="Store-1978"><a href="#Store-1978"><span class="linenos">1978</span></a>                <span class="n">new_weight</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
</span><span id="Store-1979"><a href="#Store-1979"><span class="linenos">1979</span></a>                
</span><span id="Store-1980"><a href="#Store-1980"><span class="linenos">1980</span></a>                <span class="n">edge</span> <span class="p">:</span> <span class="n">Edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">node1_id</span><span class="p">,</span> <span class="n">node2_id</span><span class="p">)</span>
</span><span id="Store-1981"><a href="#Store-1981"><span class="linenos">1981</span></a>                <span class="k">if</span> <span class="n">edge</span><span class="p">:</span>
</span><span id="Store-1982"><a href="#Store-1982"><span class="linenos">1982</span></a>                    <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">new_weight</span>
</span><span id="Store-1983"><a href="#Store-1983"><span class="linenos">1983</span></a>    
</span><span id="Store-1984"><a href="#Store-1984"><span class="linenos">1984</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span> <span class="p">:</span> <span class="n">Order</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store-1985"><a href="#Store-1985"><span class="linenos">1985</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-1986"><a href="#Store-1986"><span class="linenos">1986</span></a><span class="sd">        Record order statistics to CSV file for post-simulation analysis.</span>
</span><span id="Store-1987"><a href="#Store-1987"><span class="linenos">1987</span></a><span class="sd">        </span>
</span><span id="Store-1988"><a href="#Store-1988"><span class="linenos">1988</span></a><span class="sd">        This method captures comprehensive metrics about each order, including timing,</span>
</span><span id="Store-1989"><a href="#Store-1989"><span class="linenos">1989</span></a><span class="sd">        participants, and outcome. Statistics are appended to a CSV file for later</span>
</span><span id="Store-1990"><a href="#Store-1990"><span class="linenos">1990</span></a><span class="sd">        analysis of supply chain performance, bottlenecks, and optimization opportunities.</span>
</span><span id="Store-1991"><a href="#Store-1991"><span class="linenos">1991</span></a><span class="sd">        </span>
</span><span id="Store-1992"><a href="#Store-1992"><span class="linenos">1992</span></a><span class="sd">        Args:</span>
</span><span id="Store-1993"><a href="#Store-1993"><span class="linenos">1993</span></a><span class="sd">            order (Order): The order object containing product, quantity, and IDs.</span>
</span><span id="Store-1994"><a href="#Store-1994"><span class="linenos">1994</span></a><span class="sd">            eta (int): Estimated time of arrival or delivery time in simulation ticks.</span>
</span><span id="Store-1995"><a href="#Store-1995"><span class="linenos">1995</span></a><span class="sd">            state (str): Final state of the order. Possible values:</span>
</span><span id="Store-1996"><a href="#Store-1996"><span class="linenos">1996</span></a><span class="sd">                - &quot;delivered&quot;: Successfully completed</span>
</span><span id="Store-1997"><a href="#Store-1997"><span class="linenos">1997</span></a><span class="sd">                - &quot;pending&quot;: Awaiting delivery</span>
</span><span id="Store-1998"><a href="#Store-1998"><span class="linenos">1998</span></a><span class="sd">                - &quot;failed&quot;: Order failed (not currently used)</span>
</span><span id="Store-1999"><a href="#Store-1999"><span class="linenos">1999</span></a><span class="sd">            vehicle (str): JID of the vehicle that handled the delivery.</span>
</span><span id="Store-2000"><a href="#Store-2000"><span class="linenos">2000</span></a><span class="sd">        </span>
</span><span id="Store-2001"><a href="#Store-2001"><span class="linenos">2001</span></a><span class="sd">        Statistics Captured:</span>
</span><span id="Store-2002"><a href="#Store-2002"><span class="linenos">2002</span></a><span class="sd">            - order_id: Unique request identifier</span>
</span><span id="Store-2003"><a href="#Store-2003"><span class="linenos">2003</span></a><span class="sd">            - store_jid: This store&#39;s identifier (without @domain)</span>
</span><span id="Store-2004"><a href="#Store-2004"><span class="linenos">2004</span></a><span class="sd">            - vehicle_jid: Delivering vehicle&#39;s identifier (without @domain)</span>
</span><span id="Store-2005"><a href="#Store-2005"><span class="linenos">2005</span></a><span class="sd">            - origin_warehouse: Warehouse that fulfilled order (without @domain)</span>
</span><span id="Store-2006"><a href="#Store-2006"><span class="linenos">2006</span></a><span class="sd">            - product: Product name</span>
</span><span id="Store-2007"><a href="#Store-2007"><span class="linenos">2007</span></a><span class="sd">            - quantity: Amount ordered/delivered</span>
</span><span id="Store-2008"><a href="#Store-2008"><span class="linenos">2008</span></a><span class="sd">            - ETA: Estimated time of arrival from vehicle</span>
</span><span id="Store-2009"><a href="#Store-2009"><span class="linenos">2009</span></a><span class="sd">            - time_to_delivery: Total ticks from confirmation to delivery</span>
</span><span id="Store-2010"><a href="#Store-2010"><span class="linenos">2010</span></a><span class="sd">            - current_tick: Simulation time when stats recorded</span>
</span><span id="Store-2011"><a href="#Store-2011"><span class="linenos">2011</span></a><span class="sd">            - final_state: Outcome indicator (delivered/pending/failed)</span>
</span><span id="Store-2012"><a href="#Store-2012"><span class="linenos">2012</span></a><span class="sd">        </span>
</span><span id="Store-2013"><a href="#Store-2013"><span class="linenos">2013</span></a><span class="sd">        CSV File Format:</span>
</span><span id="Store-2014"><a href="#Store-2014"><span class="linenos">2014</span></a><span class="sd">            - Location: stats/store_stats.csv</span>
</span><span id="Store-2015"><a href="#Store-2015"><span class="linenos">2015</span></a><span class="sd">            - Encoding: UTF-8</span>
</span><span id="Store-2016"><a href="#Store-2016"><span class="linenos">2016</span></a><span class="sd">            - Headers: Written automatically on first write</span>
</span><span id="Store-2017"><a href="#Store-2017"><span class="linenos">2017</span></a><span class="sd">            - Mode: Append (preserves previous records)</span>
</span><span id="Store-2018"><a href="#Store-2018"><span class="linenos">2018</span></a><span class="sd">        </span>
</span><span id="Store-2019"><a href="#Store-2019"><span class="linenos">2019</span></a><span class="sd">        Time-to-Delivery Calculation:</span>
</span><span id="Store-2020"><a href="#Store-2020"><span class="linenos">2020</span></a><span class="sd">            ```python</span>
</span><span id="Store-2021"><a href="#Store-2021"><span class="linenos">2021</span></a><span class="sd">            time_to_delivery = current_tick - order_timings[orderid]</span>
</span><span id="Store-2022"><a href="#Store-2022"><span class="linenos">2022</span></a><span class="sd">            # order_timings[orderid] set during SendStoreConfirmation</span>
</span><span id="Store-2023"><a href="#Store-2023"><span class="linenos">2023</span></a><span class="sd">            # Measures: Confirmation -&gt; Delivery complete</span>
</span><span id="Store-2024"><a href="#Store-2024"><span class="linenos">2024</span></a><span class="sd">            ```</span>
</span><span id="Store-2025"><a href="#Store-2025"><span class="linenos">2025</span></a><span class="sd">        </span>
</span><span id="Store-2026"><a href="#Store-2026"><span class="linenos">2026</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store-2027"><a href="#Store-2027"><span class="linenos">2027</span></a><span class="sd">            - Creates stats/ directory if it doesn&#39;t exist</span>
</span><span id="Store-2028"><a href="#Store-2028"><span class="linenos">2028</span></a><span class="sd">            - Creates or appends to store_stats.csv</span>
</span><span id="Store-2029"><a href="#Store-2029"><span class="linenos">2029</span></a><span class="sd">            - Prints confirmation if verbose mode enabled</span>
</span><span id="Store-2030"><a href="#Store-2030"><span class="linenos">2030</span></a><span class="sd">            - Prints error if file operation fails</span>
</span><span id="Store-2031"><a href="#Store-2031"><span class="linenos">2031</span></a><span class="sd">        </span>
</span><span id="Store-2032"><a href="#Store-2032"><span class="linenos">2032</span></a><span class="sd">        Error Handling:</span>
</span><span id="Store-2033"><a href="#Store-2033"><span class="linenos">2033</span></a><span class="sd">            - Wraps file operations in try-except</span>
</span><span id="Store-2034"><a href="#Store-2034"><span class="linenos">2034</span></a><span class="sd">            - Catches all exceptions (broad handling for robustness)</span>
</span><span id="Store-2035"><a href="#Store-2035"><span class="linenos">2035</span></a><span class="sd">            - Prints error message with exception details</span>
</span><span id="Store-2036"><a href="#Store-2036"><span class="linenos">2036</span></a><span class="sd">            - Does not crash agent on statistics failure</span>
</span><span id="Store-2037"><a href="#Store-2037"><span class="linenos">2037</span></a><span class="sd">        </span>
</span><span id="Store-2038"><a href="#Store-2038"><span class="linenos">2038</span></a><span class="sd">        Example CSV Output:</span>
</span><span id="Store-2039"><a href="#Store-2039"><span class="linenos">2039</span></a><span class="sd">            ```csv</span>
</span><span id="Store-2040"><a href="#Store-2040"><span class="linenos">2040</span></a><span class="sd">            order_id,store_jid,vehicle_jid,origin_warehouse,product,quantity,ETA,time_to_delivery,current_tick,final_state</span>
</span><span id="Store-2041"><a href="#Store-2041"><span class="linenos">2041</span></a><span class="sd">            1001000000,store1,vehicle1,warehouse2,electronics,50,120,125,345,delivered</span>
</span><span id="Store-2042"><a href="#Store-2042"><span class="linenos">2042</span></a><span class="sd">            1001000001,store1,vehicle2,warehouse1,food,30,80,85,430,delivered</span>
</span><span id="Store-2043"><a href="#Store-2043"><span class="linenos">2043</span></a><span class="sd">            ```</span>
</span><span id="Store-2044"><a href="#Store-2044"><span class="linenos">2044</span></a><span class="sd">        </span>
</span><span id="Store-2045"><a href="#Store-2045"><span class="linenos">2045</span></a><span class="sd">        Performance Metrics Enabled:</span>
</span><span id="Store-2046"><a href="#Store-2046"><span class="linenos">2046</span></a><span class="sd">            - Average delivery time per product</span>
</span><span id="Store-2047"><a href="#Store-2047"><span class="linenos">2047</span></a><span class="sd">            - Warehouse performance comparison</span>
</span><span id="Store-2048"><a href="#Store-2048"><span class="linenos">2048</span></a><span class="sd">            - Vehicle efficiency analysis</span>
</span><span id="Store-2049"><a href="#Store-2049"><span class="linenos">2049</span></a><span class="sd">            - Bottleneck identification</span>
</span><span id="Store-2050"><a href="#Store-2050"><span class="linenos">2050</span></a><span class="sd">            - Demand pattern analysis</span>
</span><span id="Store-2051"><a href="#Store-2051"><span class="linenos">2051</span></a><span class="sd">        </span>
</span><span id="Store-2052"><a href="#Store-2052"><span class="linenos">2052</span></a><span class="sd">        Example Usage:</span>
</span><span id="Store-2053"><a href="#Store-2053"><span class="linenos">2053</span></a><span class="sd">            ```python</span>
</span><span id="Store-2054"><a href="#Store-2054"><span class="linenos">2054</span></a><span class="sd">            # Called from ReceiveVehicleArrival after delivery</span>
</span><span id="Store-2055"><a href="#Store-2055"><span class="linenos">2055</span></a><span class="sd">            order = pending_deliveries[orderid]</span>
</span><span id="Store-2056"><a href="#Store-2056"><span class="linenos">2056</span></a><span class="sd">            eta = 120  # From vehicle message</span>
</span><span id="Store-2057"><a href="#Store-2057"><span class="linenos">2057</span></a><span class="sd">            store.get_stats(order, eta, &quot;delivered&quot;, msg.sender)</span>
</span><span id="Store-2058"><a href="#Store-2058"><span class="linenos">2058</span></a><span class="sd">            # CSV row appended with all order metrics</span>
</span><span id="Store-2059"><a href="#Store-2059"><span class="linenos">2059</span></a><span class="sd">            ```</span>
</span><span id="Store-2060"><a href="#Store-2060"><span class="linenos">2060</span></a><span class="sd">        </span>
</span><span id="Store-2061"><a href="#Store-2061"><span class="linenos">2061</span></a><span class="sd">        Note:</span>
</span><span id="Store-2062"><a href="#Store-2062"><span class="linenos">2062</span></a><span class="sd">            Statistics are append-only. For new simulation runs, manually delete or</span>
</span><span id="Store-2063"><a href="#Store-2063"><span class="linenos">2063</span></a><span class="sd">            rename the CSV file to avoid mixing data from different experiments.</span>
</span><span id="Store-2064"><a href="#Store-2064"><span class="linenos">2064</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-2065"><a href="#Store-2065"><span class="linenos">2065</span></a>        <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="Store-2066"><a href="#Store-2066"><span class="linenos">2066</span></a>        
</span><span id="Store-2067"><a href="#Store-2067"><span class="linenos">2067</span></a>        <span class="n">order_stats</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Store-2068"><a href="#Store-2068"><span class="linenos">2068</span></a>            <span class="s2">&quot;order_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span>
</span><span id="Store-2069"><a href="#Store-2069"><span class="linenos">2069</span></a>            <span class="s2">&quot;store_jid&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Store-2070"><a href="#Store-2070"><span class="linenos">2070</span></a>            <span class="s2">&quot;vehicle_jid&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Store-2071"><a href="#Store-2071"><span class="linenos">2071</span></a>            <span class="s2">&quot;origin_warehouse&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Store-2072"><a href="#Store-2072"><span class="linenos">2072</span></a>            <span class="s2">&quot;product&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="p">,</span>
</span><span id="Store-2073"><a href="#Store-2073"><span class="linenos">2073</span></a>            <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="Store-2074"><a href="#Store-2074"><span class="linenos">2074</span></a>            <span class="s2">&quot;ETA&quot;</span><span class="p">:</span> <span class="n">eta</span> <span class="k">if</span> <span class="n">eta</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Store-2075"><a href="#Store-2075"><span class="linenos">2075</span></a>            <span class="s2">&quot;time_to_delivery&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_timings</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">],</span>
</span><span id="Store-2076"><a href="#Store-2076"><span class="linenos">2076</span></a>            <span class="s2">&quot;current_tick&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_tick</span><span class="p">,</span>
</span><span id="Store-2077"><a href="#Store-2077"><span class="linenos">2077</span></a>            <span class="s2">&quot;final_state&quot;</span><span class="p">:</span> <span class="n">state</span>  <span class="c1"># pending, delivered, failed</span>
</span><span id="Store-2078"><a href="#Store-2078"><span class="linenos">2078</span></a>        <span class="p">}</span>
</span><span id="Store-2079"><a href="#Store-2079"><span class="linenos">2079</span></a>        
</span><span id="Store-2080"><a href="#Store-2080"><span class="linenos">2080</span></a>        <span class="c1"># Build full file path</span>
</span><span id="Store-2081"><a href="#Store-2081"><span class="linenos">2081</span></a>        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_filename</span><span class="p">)</span>
</span><span id="Store-2082"><a href="#Store-2082"><span class="linenos">2082</span></a>        
</span><span id="Store-2083"><a href="#Store-2083"><span class="linenos">2083</span></a>        <span class="c1"># Check if file exists to determine if we need to write headers</span>
</span><span id="Store-2084"><a href="#Store-2084"><span class="linenos">2084</span></a>        <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
</span><span id="Store-2085"><a href="#Store-2085"><span class="linenos">2085</span></a>        
</span><span id="Store-2086"><a href="#Store-2086"><span class="linenos">2086</span></a>        <span class="c1"># Write to CSV</span>
</span><span id="Store-2087"><a href="#Store-2087"><span class="linenos">2087</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Store-2088"><a href="#Store-2088"><span class="linenos">2088</span></a>            <span class="c1"># Create directory if it doesn&#39;t exist</span>
</span><span id="Store-2089"><a href="#Store-2089"><span class="linenos">2089</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Store-2090"><a href="#Store-2090"><span class="linenos">2090</span></a>            
</span><span id="Store-2091"><a href="#Store-2091"><span class="linenos">2091</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">:</span> <span class="n">open_mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>
</span><span id="Store-2092"><a href="#Store-2092"><span class="linenos">2092</span></a>            <span class="k">else</span><span class="p">:</span> <span class="n">open_mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
</span><span id="Store-2093"><a href="#Store-2093"><span class="linenos">2093</span></a>            
</span><span id="Store-2094"><a href="#Store-2094"><span class="linenos">2094</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">open_mode</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="Store-2095"><a href="#Store-2095"><span class="linenos">2095</span></a>                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">order_stats</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Store-2096"><a href="#Store-2096"><span class="linenos">2096</span></a>                
</span><span id="Store-2097"><a href="#Store-2097"><span class="linenos">2097</span></a>                <span class="c1"># Write header only if file is new</span>
</span><span id="Store-2098"><a href="#Store-2098"><span class="linenos">2098</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">:</span>
</span><span id="Store-2099"><a href="#Store-2099"><span class="linenos">2099</span></a>                    <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="Store-2100"><a href="#Store-2100"><span class="linenos">2100</span></a>                
</span><span id="Store-2101"><a href="#Store-2101"><span class="linenos">2101</span></a>                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_stats</span><span class="p">)</span>
</span><span id="Store-2102"><a href="#Store-2102"><span class="linenos">2102</span></a>            
</span><span id="Store-2103"><a href="#Store-2103"><span class="linenos">2103</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-2104"><a href="#Store-2104"><span class="linenos">2104</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Stats saved to </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2"> for order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-2105"><a href="#Store-2105"><span class="linenos">2105</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Store-2106"><a href="#Store-2106"><span class="linenos">2106</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR saving stats: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        
</span><span id="Store-2107"><a href="#Store-2107"><span class="linenos">2107</span></a>    
</span><span id="Store-2108"><a href="#Store-2108"><span class="linenos">2108</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_stock</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store-2109"><a href="#Store-2109"><span class="linenos">2109</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-2110"><a href="#Store-2110"><span class="linenos">2110</span></a><span class="sd">        Print the current stock inventory to console.</span>
</span><span id="Store-2111"><a href="#Store-2111"><span class="linenos">2111</span></a><span class="sd">        </span>
</span><span id="Store-2112"><a href="#Store-2112"><span class="linenos">2112</span></a><span class="sd">        This helper method provides a human-readable display of the store&#39;s current</span>
</span><span id="Store-2113"><a href="#Store-2113"><span class="linenos">2113</span></a><span class="sd">        inventory, showing all products and their quantities. Used after deliveries</span>
</span><span id="Store-2114"><a href="#Store-2114"><span class="linenos">2114</span></a><span class="sd">        to provide visibility into stock levels.</span>
</span><span id="Store-2115"><a href="#Store-2115"><span class="linenos">2115</span></a><span class="sd">        </span>
</span><span id="Store-2116"><a href="#Store-2116"><span class="linenos">2116</span></a><span class="sd">        Output Format:</span>
</span><span id="Store-2117"><a href="#Store-2117"><span class="linenos">2117</span></a><span class="sd">            If stock is empty:</span>
</span><span id="Store-2118"><a href="#Store-2118"><span class="linenos">2118</span></a><span class="sd">                &quot;{jid}&gt; Stock is empty&quot;</span>
</span><span id="Store-2119"><a href="#Store-2119"><span class="linenos">2119</span></a><span class="sd">            </span>
</span><span id="Store-2120"><a href="#Store-2120"><span class="linenos">2120</span></a><span class="sd">            If stock has items:</span>
</span><span id="Store-2121"><a href="#Store-2121"><span class="linenos">2121</span></a><span class="sd">                &quot;{jid}&gt; Current stock:&quot;</span>
</span><span id="Store-2122"><a href="#Store-2122"><span class="linenos">2122</span></a><span class="sd">                &quot;  - product1: quantity1 units&quot;</span>
</span><span id="Store-2123"><a href="#Store-2123"><span class="linenos">2123</span></a><span class="sd">                &quot;  - product2: quantity2 units&quot;</span>
</span><span id="Store-2124"><a href="#Store-2124"><span class="linenos">2124</span></a><span class="sd">                ...</span>
</span><span id="Store-2125"><a href="#Store-2125"><span class="linenos">2125</span></a><span class="sd">        </span>
</span><span id="Store-2126"><a href="#Store-2126"><span class="linenos">2126</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store-2127"><a href="#Store-2127"><span class="linenos">2127</span></a><span class="sd">            - Prints to standard output (console)</span>
</span><span id="Store-2128"><a href="#Store-2128"><span class="linenos">2128</span></a><span class="sd">            - Always visible (not affected by verbose setting)</span>
</span><span id="Store-2129"><a href="#Store-2129"><span class="linenos">2129</span></a><span class="sd">        </span>
</span><span id="Store-2130"><a href="#Store-2130"><span class="linenos">2130</span></a><span class="sd">        Example Output:</span>
</span><span id="Store-2131"><a href="#Store-2131"><span class="linenos">2131</span></a><span class="sd">            ```</span>
</span><span id="Store-2132"><a href="#Store-2132"><span class="linenos">2132</span></a><span class="sd">            store1@localhost&gt; Current stock:</span>
</span><span id="Store-2133"><a href="#Store-2133"><span class="linenos">2133</span></a><span class="sd">              - electronics: 250 units</span>
</span><span id="Store-2134"><a href="#Store-2134"><span class="linenos">2134</span></a><span class="sd">              - food: 100 units</span>
</span><span id="Store-2135"><a href="#Store-2135"><span class="linenos">2135</span></a><span class="sd">              - clothing: 75 units</span>
</span><span id="Store-2136"><a href="#Store-2136"><span class="linenos">2136</span></a><span class="sd">            ```</span>
</span><span id="Store-2137"><a href="#Store-2137"><span class="linenos">2137</span></a><span class="sd">        </span>
</span><span id="Store-2138"><a href="#Store-2138"><span class="linenos">2138</span></a><span class="sd">        Note:</span>
</span><span id="Store-2139"><a href="#Store-2139"><span class="linenos">2139</span></a><span class="sd">            This method is called after every successful delivery to provide</span>
</span><span id="Store-2140"><a href="#Store-2140"><span class="linenos">2140</span></a><span class="sd">            immediate feedback about inventory changes.</span>
</span><span id="Store-2141"><a href="#Store-2141"><span class="linenos">2141</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-2142"><a href="#Store-2142"><span class="linenos">2142</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="Store-2143"><a href="#Store-2143"><span class="linenos">2143</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Stock is empty&quot;</span><span class="p">)</span>
</span><span id="Store-2144"><a href="#Store-2144"><span class="linenos">2144</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Store-2145"><a href="#Store-2145"><span class="linenos">2145</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Current stock:&quot;</span><span class="p">)</span>
</span><span id="Store-2146"><a href="#Store-2146"><span class="linenos">2146</span></a>            <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Store-2147"><a href="#Store-2147"><span class="linenos">2147</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units&quot;</span><span class="p">)</span>
</span><span id="Store-2148"><a href="#Store-2148"><span class="linenos">2148</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Store-2149"><a href="#Store-2149"><span class="linenos">2149</span></a>    
</span><span id="Store-2150"><a href="#Store-2150"><span class="linenos">2150</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="nb">map</span> <span class="p">:</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">node_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">5222</span><span class="p">,</span> <span class="n">verify_security</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">contact_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="Store-2151"><a href="#Store-2151"><span class="linenos">2151</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-2152"><a href="#Store-2152"><span class="linenos">2152</span></a><span class="sd">        Initialize the Store agent with configuration and state.</span>
</span><span id="Store-2153"><a href="#Store-2153"><span class="linenos">2153</span></a><span class="sd">        </span>
</span><span id="Store-2154"><a href="#Store-2154"><span class="linenos">2154</span></a><span class="sd">        This constructor sets up the store agent with all necessary parameters for</span>
</span><span id="Store-2155"><a href="#Store-2155"><span class="linenos">2155</span></a><span class="sd">        operation, including network configuration, graph reference, ID encoding,</span>
</span><span id="Store-2156"><a href="#Store-2156"><span class="linenos">2156</span></a><span class="sd">        and statistics tracking. It prepares the agent for FIPA Contract Net Protocol</span>
</span><span id="Store-2157"><a href="#Store-2157"><span class="linenos">2157</span></a><span class="sd">        negotiations and supply chain operations.</span>
</span><span id="Store-2158"><a href="#Store-2158"><span class="linenos">2158</span></a><span class="sd">        </span>
</span><span id="Store-2159"><a href="#Store-2159"><span class="linenos">2159</span></a><span class="sd">        Args:</span>
</span><span id="Store-2160"><a href="#Store-2160"><span class="linenos">2160</span></a><span class="sd">            jid (str): Jabber ID for the store agent (e.g., &quot;store1@localhost&quot;).</span>
</span><span id="Store-2161"><a href="#Store-2161"><span class="linenos">2161</span></a><span class="sd">                Must be unique within the XMPP server.</span>
</span><span id="Store-2162"><a href="#Store-2162"><span class="linenos">2162</span></a><span class="sd">            password (str): Authentication password for XMPP server connection.</span>
</span><span id="Store-2163"><a href="#Store-2163"><span class="linenos">2163</span></a><span class="sd">            map (Graph): Reference to the world graph for pathfinding and distance</span>
</span><span id="Store-2164"><a href="#Store-2164"><span class="linenos">2164</span></a><span class="sd">                calculations. Shared across all agents in the simulation.</span>
</span><span id="Store-2165"><a href="#Store-2165"><span class="linenos">2165</span></a><span class="sd">            node_id (int): Graph node ID representing the store&#39;s physical location.</span>
</span><span id="Store-2166"><a href="#Store-2166"><span class="linenos">2166</span></a><span class="sd">                Used in pathfinding and warehouse scoring.</span>
</span><span id="Store-2167"><a href="#Store-2167"><span class="linenos">2167</span></a><span class="sd">            port (int, optional): XMPP server port. Defaults to 5222 (standard XMPP).</span>
</span><span id="Store-2168"><a href="#Store-2168"><span class="linenos">2168</span></a><span class="sd">            verify_security (bool, optional): Whether to verify SSL/TLS certificates.</span>
</span><span id="Store-2169"><a href="#Store-2169"><span class="linenos">2169</span></a><span class="sd">                Defaults to False for local development. Set True for production.</span>
</span><span id="Store-2170"><a href="#Store-2170"><span class="linenos">2170</span></a><span class="sd">            contact_list (list[str], optional): List of warehouse JIDs to subscribe to.</span>
</span><span id="Store-2171"><a href="#Store-2171"><span class="linenos">2171</span></a><span class="sd">                Store will send purchase requests to these warehouses.</span>
</span><span id="Store-2172"><a href="#Store-2172"><span class="linenos">2172</span></a><span class="sd">                Defaults to empty list.</span>
</span><span id="Store-2173"><a href="#Store-2173"><span class="linenos">2173</span></a><span class="sd">            verbose (bool, optional): Enable detailed debug logging.</span>
</span><span id="Store-2174"><a href="#Store-2174"><span class="linenos">2174</span></a><span class="sd">                True: Print all debug information</span>
</span><span id="Store-2175"><a href="#Store-2175"><span class="linenos">2175</span></a><span class="sd">                False: Print only essential messages</span>
</span><span id="Store-2176"><a href="#Store-2176"><span class="linenos">2176</span></a><span class="sd">                Defaults to False.</span>
</span><span id="Store-2177"><a href="#Store-2177"><span class="linenos">2177</span></a><span class="sd">        </span>
</span><span id="Store-2178"><a href="#Store-2178"><span class="linenos">2178</span></a><span class="sd">        ID Encoding System:</span>
</span><span id="Store-2179"><a href="#Store-2179"><span class="linenos">2179</span></a><span class="sd">            Generates unique request IDs using hierarchical encoding:</span>
</span><span id="Store-2180"><a href="#Store-2180"><span class="linenos">2180</span></a><span class="sd">            - Formula: `(agent_type * 100_000_000) + (instance_id * 1_000_000) + counter`</span>
</span><span id="Store-2181"><a href="#Store-2181"><span class="linenos">2181</span></a><span class="sd">            - Store type code: 1</span>
</span><span id="Store-2182"><a href="#Store-2182"><span class="linenos">2182</span></a><span class="sd">            - Instance ID: Extracted from JID (e.g., &quot;store1&quot; -&gt; 1, &quot;store42&quot; -&gt; 42)</span>
</span><span id="Store-2183"><a href="#Store-2183"><span class="linenos">2183</span></a><span class="sd">            - Example: store1&#39;s first request = 1_001_000_000</span>
</span><span id="Store-2184"><a href="#Store-2184"><span class="linenos">2184</span></a><span class="sd">            - Example: store1&#39;s second request = 1_001_000_001</span>
</span><span id="Store-2185"><a href="#Store-2185"><span class="linenos">2185</span></a><span class="sd">            - Ensures global uniqueness across all agents and requests</span>
</span><span id="Store-2186"><a href="#Store-2186"><span class="linenos">2186</span></a><span class="sd">        </span>
</span><span id="Store-2187"><a href="#Store-2187"><span class="linenos">2187</span></a><span class="sd">        Configuration Loading:</span>
</span><span id="Store-2188"><a href="#Store-2188"><span class="linenos">2188</span></a><span class="sd">            Imports from config module:</span>
</span><span id="Store-2189"><a href="#Store-2189"><span class="linenos">2189</span></a><span class="sd">            - PRODUCTS: List of available products for purchase</span>
</span><span id="Store-2190"><a href="#Store-2190"><span class="linenos">2190</span></a><span class="sd">            - STORE_BUY_PROBABILITY: Probability (0-1) of purchase attempt per period</span>
</span><span id="Store-2191"><a href="#Store-2191"><span class="linenos">2191</span></a><span class="sd">            - STORE_MAX_BUY_QUANTITY: Maximum quantity per purchase order</span>
</span><span id="Store-2192"><a href="#Store-2192"><span class="linenos">2192</span></a><span class="sd">        </span>
</span><span id="Store-2193"><a href="#Store-2193"><span class="linenos">2193</span></a><span class="sd">        State Initialization:</span>
</span><span id="Store-2194"><a href="#Store-2194"><span class="linenos">2194</span></a><span class="sd">            - pending_deliveries: Empty dict for tracking orders awaiting delivery</span>
</span><span id="Store-2195"><a href="#Store-2195"><span class="linenos">2195</span></a><span class="sd">            - order_timings: Empty dict for recording confirmation timestamps</span>
</span><span id="Store-2196"><a href="#Store-2196"><span class="linenos">2196</span></a><span class="sd">            - current_tick: 0 (synchronized by world agent during runtime)</span>
</span><span id="Store-2197"><a href="#Store-2197"><span class="linenos">2197</span></a><span class="sd">            - stock: Initialized in setup() as empty dict</span>
</span><span id="Store-2198"><a href="#Store-2198"><span class="linenos">2198</span></a><span class="sd">            - failed_requests: Initialized in setup() as empty queue</span>
</span><span id="Store-2199"><a href="#Store-2199"><span class="linenos">2199</span></a><span class="sd">            - request_counter: Initialized in setup() as 0</span>
</span><span id="Store-2200"><a href="#Store-2200"><span class="linenos">2200</span></a><span class="sd">        </span>
</span><span id="Store-2201"><a href="#Store-2201"><span class="linenos">2201</span></a><span class="sd">        Statistics Configuration:</span>
</span><span id="Store-2202"><a href="#Store-2202"><span class="linenos">2202</span></a><span class="sd">            - stats_path: &quot;stats/&quot; directory (created automatically if needed)</span>
</span><span id="Store-2203"><a href="#Store-2203"><span class="linenos">2203</span></a><span class="sd">            - stats_filename: &quot;store_stats.csv&quot; (append mode)</span>
</span><span id="Store-2204"><a href="#Store-2204"><span class="linenos">2204</span></a><span class="sd">        </span>
</span><span id="Store-2205"><a href="#Store-2205"><span class="linenos">2205</span></a><span class="sd">        Example:</span>
</span><span id="Store-2206"><a href="#Store-2206"><span class="linenos">2206</span></a><span class="sd">            ```python</span>
</span><span id="Store-2207"><a href="#Store-2207"><span class="linenos">2207</span></a><span class="sd">            from world.graph import Graph</span>
</span><span id="Store-2208"><a href="#Store-2208"><span class="linenos">2208</span></a><span class="sd">            </span>
</span><span id="Store-2209"><a href="#Store-2209"><span class="linenos">2209</span></a><span class="sd">            map_graph = Graph()</span>
</span><span id="Store-2210"><a href="#Store-2210"><span class="linenos">2210</span></a><span class="sd">            # ... add nodes and edges to graph ...</span>
</span><span id="Store-2211"><a href="#Store-2211"><span class="linenos">2211</span></a><span class="sd">            </span>
</span><span id="Store-2212"><a href="#Store-2212"><span class="linenos">2212</span></a><span class="sd">            store = Store(</span>
</span><span id="Store-2213"><a href="#Store-2213"><span class="linenos">2213</span></a><span class="sd">                jid=&quot;store1@localhost&quot;,</span>
</span><span id="Store-2214"><a href="#Store-2214"><span class="linenos">2214</span></a><span class="sd">                password=&quot;secure_password&quot;,</span>
</span><span id="Store-2215"><a href="#Store-2215"><span class="linenos">2215</span></a><span class="sd">                map=map_graph,</span>
</span><span id="Store-2216"><a href="#Store-2216"><span class="linenos">2216</span></a><span class="sd">                node_id=5,</span>
</span><span id="Store-2217"><a href="#Store-2217"><span class="linenos">2217</span></a><span class="sd">                port=5222,</span>
</span><span id="Store-2218"><a href="#Store-2218"><span class="linenos">2218</span></a><span class="sd">                verify_security=False,</span>
</span><span id="Store-2219"><a href="#Store-2219"><span class="linenos">2219</span></a><span class="sd">                contact_list=[&quot;warehouse1@localhost&quot;, &quot;warehouse2@localhost&quot;],</span>
</span><span id="Store-2220"><a href="#Store-2220"><span class="linenos">2220</span></a><span class="sd">                verbose=True</span>
</span><span id="Store-2221"><a href="#Store-2221"><span class="linenos">2221</span></a><span class="sd">            )</span>
</span><span id="Store-2222"><a href="#Store-2222"><span class="linenos">2222</span></a><span class="sd">            </span>
</span><span id="Store-2223"><a href="#Store-2223"><span class="linenos">2223</span></a><span class="sd">            # store.id_base = 1_001_000_000</span>
</span><span id="Store-2224"><a href="#Store-2224"><span class="linenos">2224</span></a><span class="sd">            # Ready to start and begin purchasing</span>
</span><span id="Store-2225"><a href="#Store-2225"><span class="linenos">2225</span></a><span class="sd">            await store.start()</span>
</span><span id="Store-2226"><a href="#Store-2226"><span class="linenos">2226</span></a><span class="sd">            ```</span>
</span><span id="Store-2227"><a href="#Store-2227"><span class="linenos">2227</span></a><span class="sd">        </span>
</span><span id="Store-2228"><a href="#Store-2228"><span class="linenos">2228</span></a><span class="sd">        Note:</span>
</span><span id="Store-2229"><a href="#Store-2229"><span class="linenos">2229</span></a><span class="sd">            The agent is not fully operational until setup() is called (automatically</span>
</span><span id="Store-2230"><a href="#Store-2230"><span class="linenos">2230</span></a><span class="sd">            by SPADE when start() is invoked). The setup() method initializes</span>
</span><span id="Store-2231"><a href="#Store-2231"><span class="linenos">2231</span></a><span class="sd">            behaviours and subscribes to contacts.</span>
</span><span id="Store-2232"><a href="#Store-2232"><span class="linenos">2232</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-2233"><a href="#Store-2233"><span class="linenos">2233</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">verify_security</span><span class="p">)</span>
</span><span id="Store-2234"><a href="#Store-2234"><span class="linenos">2234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node_id</span>
</span><span id="Store-2235"><a href="#Store-2235"><span class="linenos">2235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="p">:</span> <span class="n">Graph</span> <span class="o">=</span> <span class="nb">map</span>
</span><span id="Store-2236"><a href="#Store-2236"><span class="linenos">2236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contact_list</span> <span class="o">=</span> <span class="n">contact_list</span>
</span><span id="Store-2237"><a href="#Store-2237"><span class="linenos">2237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="Store-2238"><a href="#Store-2238"><span class="linenos">2238</span></a>        
</span><span id="Store-2239"><a href="#Store-2239"><span class="linenos">2239</span></a>        <span class="c1"># Extract instance number from JID for ID encoding (e.g., &quot;store1@localhost&quot; -&gt; 1)</span>
</span><span id="Store-2240"><a href="#Store-2240"><span class="linenos">2240</span></a>        <span class="n">jid_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Store-2241"><a href="#Store-2241"><span class="linenos">2241</span></a>        <span class="n">instance_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">,</span> <span class="n">jid_name</span><span class="p">)))</span>
</span><span id="Store-2242"><a href="#Store-2242"><span class="linenos">2242</span></a>        
</span><span id="Store-2243"><a href="#Store-2243"><span class="linenos">2243</span></a>        <span class="c1"># Calculate ID base: Store type code = 1</span>
</span><span id="Store-2244"><a href="#Store-2244"><span class="linenos">2244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id_base</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">100_000_000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">instance_id</span> <span class="o">*</span> <span class="mi">1_000_000</span><span class="p">)</span>
</span><span id="Store-2245"><a href="#Store-2245"><span class="linenos">2245</span></a>        
</span><span id="Store-2246"><a href="#Store-2246"><span class="linenos">2246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pending_deliveries</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># key: request_id, value: Order object</span>
</span><span id="Store-2247"><a href="#Store-2247"><span class="linenos">2247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">order_timings</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{}</span>  <span class="c1"># key: request_id, value: ticks at confirmation</span>
</span><span id="Store-2248"><a href="#Store-2248"><span class="linenos">2248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_tick</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Store-2249"><a href="#Store-2249"><span class="linenos">2249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stats_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;stats&quot;</span><span class="p">)</span>
</span><span id="Store-2250"><a href="#Store-2250"><span class="linenos">2250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stats_filename</span> <span class="o">=</span> <span class="s2">&quot;store_stats.csv&quot;</span>
</span><span id="Store-2251"><a href="#Store-2251"><span class="linenos">2251</span></a>        
</span><span id="Store-2252"><a href="#Store-2252"><span class="linenos">2252</span></a>        <span class="c1"># Constants from config</span>
</span><span id="Store-2253"><a href="#Store-2253"><span class="linenos">2253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">product_list</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">PRODUCTS</span>
</span><span id="Store-2254"><a href="#Store-2254"><span class="linenos">2254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buy_prob</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">STORE_BUY_PROBABILITY</span>
</span><span id="Store-2255"><a href="#Store-2255"><span class="linenos">2255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_buy_quantity</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">STORE_MAX_BUY_QUANTITY</span>
</span><span id="Store-2256"><a href="#Store-2256"><span class="linenos">2256</span></a>        
</span><span id="Store-2257"><a href="#Store-2257"><span class="linenos">2257</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store-2258"><a href="#Store-2258"><span class="linenos">2258</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store-2259"><a href="#Store-2259"><span class="linenos">2259</span></a><span class="sd">        Setup method called automatically by SPADE when agent starts.</span>
</span><span id="Store-2260"><a href="#Store-2260"><span class="linenos">2260</span></a><span class="sd">        </span>
</span><span id="Store-2261"><a href="#Store-2261"><span class="linenos">2261</span></a><span class="sd">        This method initializes the agent&#39;s operational state and registers all</span>
</span><span id="Store-2262"><a href="#Store-2262"><span class="linenos">2262</span></a><span class="sd">        behaviours with appropriate message templates. It completes the agent</span>
</span><span id="Store-2263"><a href="#Store-2263"><span class="linenos">2263</span></a><span class="sd">        initialization process started in __init__, preparing the store for</span>
</span><span id="Store-2264"><a href="#Store-2264"><span class="linenos">2264</span></a><span class="sd">        active participation in the supply chain simulation.</span>
</span><span id="Store-2265"><a href="#Store-2265"><span class="linenos">2265</span></a><span class="sd">        </span>
</span><span id="Store-2266"><a href="#Store-2266"><span class="linenos">2266</span></a><span class="sd">        Initialization Steps:</span>
</span><span id="Store-2267"><a href="#Store-2267"><span class="linenos">2267</span></a><span class="sd">            1. Configure presence management (auto-approve subscriptions)</span>
</span><span id="Store-2268"><a href="#Store-2268"><span class="linenos">2268</span></a><span class="sd">            2. Subscribe to all warehouses in contact list</span>
</span><span id="Store-2269"><a href="#Store-2269"><span class="linenos">2269</span></a><span class="sd">            3. Initialize runtime state variables (stock, counters, queues)</span>
</span><span id="Store-2270"><a href="#Store-2270"><span class="linenos">2270</span></a><span class="sd">            4. Register BuyProduct behaviour (periodic purchasing)</span>
</span><span id="Store-2271"><a href="#Store-2271"><span class="linenos">2271</span></a><span class="sd">            5. Register ReceiveTimeDelta behaviour (time synchronization)</span>
</span><span id="Store-2272"><a href="#Store-2272"><span class="linenos">2272</span></a><span class="sd">            6. Register RetryPreviousBuy behaviour (failed request retry)</span>
</span><span id="Store-2273"><a href="#Store-2273"><span class="linenos">2273</span></a><span class="sd">            7. Register ReceiveVehicleArrival behaviour (delivery reception)</span>
</span><span id="Store-2274"><a href="#Store-2274"><span class="linenos">2274</span></a><span class="sd">        </span>
</span><span id="Store-2275"><a href="#Store-2275"><span class="linenos">2275</span></a><span class="sd">        Presence Configuration:</span>
</span><span id="Store-2276"><a href="#Store-2276"><span class="linenos">2276</span></a><span class="sd">            - presence.approve_all = True: Auto-accept all subscription requests</span>
</span><span id="Store-2277"><a href="#Store-2277"><span class="linenos">2277</span></a><span class="sd">            - Subscribes to each warehouse in contact_list</span>
</span><span id="Store-2278"><a href="#Store-2278"><span class="linenos">2278</span></a><span class="sd">            - Enables bidirectional communication with warehouses</span>
</span><span id="Store-2279"><a href="#Store-2279"><span class="linenos">2279</span></a><span class="sd">        </span>
</span><span id="Store-2280"><a href="#Store-2280"><span class="linenos">2280</span></a><span class="sd">        State Initialization:</span>
</span><span id="Store-2281"><a href="#Store-2281"><span class="linenos">2281</span></a><span class="sd">            - stock: Empty dict (populated by deliveries)</span>
</span><span id="Store-2282"><a href="#Store-2282"><span class="linenos">2282</span></a><span class="sd">            - current_buy_request: None (set during purchase attempts)</span>
</span><span id="Store-2283"><a href="#Store-2283"><span class="linenos">2283</span></a><span class="sd">            - failed_requests: Empty FIFO queue (populated by failed negotiations)</span>
</span><span id="Store-2284"><a href="#Store-2284"><span class="linenos">2284</span></a><span class="sd">            - request_counter: 0 (incremented for each purchase request)</span>
</span><span id="Store-2285"><a href="#Store-2285"><span class="linenos">2285</span></a><span class="sd">        </span>
</span><span id="Store-2286"><a href="#Store-2286"><span class="linenos">2286</span></a><span class="sd">        Behaviour Registration:</span>
</span><span id="Store-2287"><a href="#Store-2287"><span class="linenos">2287</span></a><span class="sd">        </span>
</span><span id="Store-2288"><a href="#Store-2288"><span class="linenos">2288</span></a><span class="sd">            1. **BuyProduct** (PeriodicBehaviour):</span>
</span><span id="Store-2289"><a href="#Store-2289"><span class="linenos">2289</span></a><span class="sd">                - No template filter (self-triggered by period)</span>
</span><span id="Store-2290"><a href="#Store-2290"><span class="linenos">2290</span></a><span class="sd">                - Period: config.STORE_BUY_FREQUENCY seconds</span>
</span><span id="Store-2291"><a href="#Store-2291"><span class="linenos">2291</span></a><span class="sd">                - Purpose: Initiate FIPA Contract Net Protocol for purchases</span>
</span><span id="Store-2292"><a href="#Store-2292"><span class="linenos">2292</span></a><span class="sd">            </span>
</span><span id="Store-2293"><a href="#Store-2293"><span class="linenos">2293</span></a><span class="sd">            2. **ReceiveTimeDelta** (CyclicBehaviour):</span>
</span><span id="Store-2294"><a href="#Store-2294"><span class="linenos">2294</span></a><span class="sd">                - Template: performative=&quot;inform&quot;</span>
</span><span id="Store-2295"><a href="#Store-2295"><span class="linenos">2295</span></a><span class="sd">                - Purpose: Receive time updates and traffic data from world agent</span>
</span><span id="Store-2296"><a href="#Store-2296"><span class="linenos">2296</span></a><span class="sd">                - Continuous operation</span>
</span><span id="Store-2297"><a href="#Store-2297"><span class="linenos">2297</span></a><span class="sd">            </span>
</span><span id="Store-2298"><a href="#Store-2298"><span class="linenos">2298</span></a><span class="sd">            3. **RetryPreviousBuy** (PeriodicBehaviour):</span>
</span><span id="Store-2299"><a href="#Store-2299"><span class="linenos">2299</span></a><span class="sd">                - No template filter (self-triggered)</span>
</span><span id="Store-2300"><a href="#Store-2300"><span class="linenos">2300</span></a><span class="sd">                - Period: 5 seconds</span>
</span><span id="Store-2301"><a href="#Store-2301"><span class="linenos">2301</span></a><span class="sd">                - Purpose: Retry failed purchase requests</span>
</span><span id="Store-2302"><a href="#Store-2302"><span class="linenos">2302</span></a><span class="sd">            </span>
</span><span id="Store-2303"><a href="#Store-2303"><span class="linenos">2303</span></a><span class="sd">            4. **ReceiveVehicleArrival** (CyclicBehaviour):</span>
</span><span id="Store-2304"><a href="#Store-2304"><span class="linenos">2304</span></a><span class="sd">                - Template: performative=&quot;vehicle-delivery&quot;</span>
</span><span id="Store-2305"><a href="#Store-2305"><span class="linenos">2305</span></a><span class="sd">                - Purpose: Receive delivery notifications and update stock</span>
</span><span id="Store-2306"><a href="#Store-2306"><span class="linenos">2306</span></a><span class="sd">                - Continuous operation</span>
</span><span id="Store-2307"><a href="#Store-2307"><span class="linenos">2307</span></a><span class="sd">        </span>
</span><span id="Store-2308"><a href="#Store-2308"><span class="linenos">2308</span></a><span class="sd">        Template Filtering:</span>
</span><span id="Store-2309"><a href="#Store-2309"><span class="linenos">2309</span></a><span class="sd">            Templates ensure behaviours only receive relevant messages:</span>
</span><span id="Store-2310"><a href="#Store-2310"><span class="linenos">2310</span></a><span class="sd">            - ReceiveTimeDelta: Only &quot;inform&quot; messages (from world agent)</span>
</span><span id="Store-2311"><a href="#Store-2311"><span class="linenos">2311</span></a><span class="sd">            - ReceiveVehicleArrival: Only &quot;vehicle-delivery&quot; messages (from vehicles)</span>
</span><span id="Store-2312"><a href="#Store-2312"><span class="linenos">2312</span></a><span class="sd">            - BuyProduct/RetryPreviousBuy: No template (time-triggered, not message-triggered)</span>
</span><span id="Store-2313"><a href="#Store-2313"><span class="linenos">2313</span></a><span class="sd">        </span>
</span><span id="Store-2314"><a href="#Store-2314"><span class="linenos">2314</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store-2315"><a href="#Store-2315"><span class="linenos">2315</span></a><span class="sd">            - Sends presence subscription requests to all warehouses</span>
</span><span id="Store-2316"><a href="#Store-2316"><span class="linenos">2316</span></a><span class="sd">            - Adds four behaviours to agent&#39;s behaviour queue</span>
</span><span id="Store-2317"><a href="#Store-2317"><span class="linenos">2317</span></a><span class="sd">            - Prints subscription confirmations if verbose mode enabled</span>
</span><span id="Store-2318"><a href="#Store-2318"><span class="linenos">2318</span></a><span class="sd">        </span>
</span><span id="Store-2319"><a href="#Store-2319"><span class="linenos">2319</span></a><span class="sd">        Returns:</span>
</span><span id="Store-2320"><a href="#Store-2320"><span class="linenos">2320</span></a><span class="sd">            None. Completes when all behaviours are registered and agent is operational.</span>
</span><span id="Store-2321"><a href="#Store-2321"><span class="linenos">2321</span></a><span class="sd">        </span>
</span><span id="Store-2322"><a href="#Store-2322"><span class="linenos">2322</span></a><span class="sd">        Example Flow:</span>
</span><span id="Store-2323"><a href="#Store-2323"><span class="linenos">2323</span></a><span class="sd">            ```</span>
</span><span id="Store-2324"><a href="#Store-2324"><span class="linenos">2324</span></a><span class="sd">            Agent Start:</span>
</span><span id="Store-2325"><a href="#Store-2325"><span class="linenos">2325</span></a><span class="sd">                1. SPADE calls setup()</span>
</span><span id="Store-2326"><a href="#Store-2326"><span class="linenos">2326</span></a><span class="sd">                2. Subscribe to warehouse1, warehouse2</span>
</span><span id="Store-2327"><a href="#Store-2327"><span class="linenos">2327</span></a><span class="sd">                3. Initialize stock = {}</span>
</span><span id="Store-2328"><a href="#Store-2328"><span class="linenos">2328</span></a><span class="sd">                4. Register BuyProduct (will start after 5s)</span>
</span><span id="Store-2329"><a href="#Store-2329"><span class="linenos">2329</span></a><span class="sd">                5. Register ReceiveTimeDelta (active immediately)</span>
</span><span id="Store-2330"><a href="#Store-2330"><span class="linenos">2330</span></a><span class="sd">                6. Register RetryPreviousBuy (checks every 5s)</span>
</span><span id="Store-2331"><a href="#Store-2331"><span class="linenos">2331</span></a><span class="sd">                7. Register ReceiveVehicleArrival (active immediately)</span>
</span><span id="Store-2332"><a href="#Store-2332"><span class="linenos">2332</span></a><span class="sd">                8. Agent ready for operation</span>
</span><span id="Store-2333"><a href="#Store-2333"><span class="linenos">2333</span></a><span class="sd">            ```</span>
</span><span id="Store-2334"><a href="#Store-2334"><span class="linenos">2334</span></a><span class="sd">        </span>
</span><span id="Store-2335"><a href="#Store-2335"><span class="linenos">2335</span></a><span class="sd">        Note:</span>
</span><span id="Store-2336"><a href="#Store-2336"><span class="linenos">2336</span></a><span class="sd">            This method is asynchronous and is automatically called by SPADE&#39;s</span>
</span><span id="Store-2337"><a href="#Store-2337"><span class="linenos">2337</span></a><span class="sd">            agent lifecycle management. Do not call this method manually.</span>
</span><span id="Store-2338"><a href="#Store-2338"><span class="linenos">2338</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store-2339"><a href="#Store-2339"><span class="linenos">2339</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">approve_all</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Store-2340"><a href="#Store-2340"><span class="linenos">2340</span></a>        <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_list</span><span class="p">:</span>
</span><span id="Store-2341"><a href="#Store-2341"><span class="linenos">2341</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
</span><span id="Store-2342"><a href="#Store-2342"><span class="linenos">2342</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store-2343"><a href="#Store-2343"><span class="linenos">2343</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent subscription request to </span><span class="si">{</span><span class="n">contact</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store-2344"><a href="#Store-2344"><span class="linenos">2344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stock</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Store-2345"><a href="#Store-2345"><span class="linenos">2345</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Store-2346"><a href="#Store-2346"><span class="linenos">2346</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failed_requests</span> <span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span><span id="Store-2347"><a href="#Store-2347"><span class="linenos">2347</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Store-2348"><a href="#Store-2348"><span class="linenos">2348</span></a>
</span><span id="Store-2349"><a href="#Store-2349"><span class="linenos">2349</span></a>        <span class="c1"># BuyProduct behaviour initialization</span>
</span><span id="Store-2350"><a href="#Store-2350"><span class="linenos">2350</span></a>        <span class="n">buy_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BuyProduct</span><span class="p">()</span>
</span><span id="Store-2351"><a href="#Store-2351"><span class="linenos">2351</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">buy_behav</span><span class="p">)</span>
</span><span id="Store-2352"><a href="#Store-2352"><span class="linenos">2352</span></a>
</span><span id="Store-2353"><a href="#Store-2353"><span class="linenos">2353</span></a>        <span class="c1"># Time delta behaviour</span>
</span><span id="Store-2354"><a href="#Store-2354"><span class="linenos">2354</span></a>        <span class="n">time_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveTimeDelta</span><span class="p">()</span>
</span><span id="Store-2355"><a href="#Store-2355"><span class="linenos">2355</span></a>        <span class="n">time_template</span> <span class="p">:</span> <span class="n">Template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Store-2356"><a href="#Store-2356"><span class="linenos">2356</span></a>        <span class="n">time_template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="Store-2357"><a href="#Store-2357"><span class="linenos">2357</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">time_behav</span><span class="p">,</span> <span class="n">time_template</span><span class="p">)</span>
</span><span id="Store-2358"><a href="#Store-2358"><span class="linenos">2358</span></a>        
</span><span id="Store-2359"><a href="#Store-2359"><span class="linenos">2359</span></a>        <span class="c1"># Buy retrying is not bound by ticks</span>
</span><span id="Store-2360"><a href="#Store-2360"><span class="linenos">2360</span></a>        <span class="n">retry_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RetryPreviousBuy</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="Store-2361"><a href="#Store-2361"><span class="linenos">2361</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">retry_behav</span><span class="p">)</span>
</span><span id="Store-2362"><a href="#Store-2362"><span class="linenos">2362</span></a>        
</span><span id="Store-2363"><a href="#Store-2363"><span class="linenos">2363</span></a>        <span class="c1"># Vehicle arrival behaviour</span>
</span><span id="Store-2364"><a href="#Store-2364"><span class="linenos">2364</span></a>        <span class="n">vehicle_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveVehicleArrival</span><span class="p">()</span>
</span><span id="Store-2365"><a href="#Store-2365"><span class="linenos">2365</span></a>        <span class="n">delivery_temp</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Store-2366"><a href="#Store-2366"><span class="linenos">2366</span></a>        <span class="n">delivery_temp</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">)</span>
</span><span id="Store-2367"><a href="#Store-2367"><span class="linenos">2367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">vehicle_behav</span><span class="p">,</span> <span class="n">delivery_temp</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Retail Store Agent for Supply Chain Management System.</p>

<p>The Store agent represents a retail point in the supply chain network. It manages
inventory, purchases products from warehouses using a negotiation protocol, and
coordinates with vehicle agents for product delivery. The agent operates on a
graph-based world representation where each store has a specific node location.</p>

<h6 id="fipa-contract-net-protocol-implementation">FIPA Contract Net Protocol Implementation:</h6>

<blockquote>
  <p>This agent acts as the <strong>Initiator</strong> in the FIPA Contract Net Protocol:</p>
  
  <ol>
  <li><p><strong>Call for Proposals (CFP)</strong>: Store broadcasts purchase requests to all warehouses
  using the <code>store-buy</code> performative, which corresponds to the FIPA CFP message.</p></li>
  <li><p><strong>Proposal Reception</strong>: Warehouses respond with either <code>warehouse-accept</code> (propose)
  or <code>warehouse-reject</code> (refuse) performatives.</p></li>
  <li><p><strong>Proposal Evaluation</strong>: Store evaluates all proposals using a distance-based
  scoring function to select the optimal warehouse.</p></li>
  <li><p><strong>Award/Rejection</strong>: Store sends <code>store-confirm</code> (accept-proposal) to the winner
  and <code>store-deny</code> (reject-proposal) to non-selected participants.</p></li>
  </ol>
</blockquote>

<h6 id="id-encoding-system">ID Encoding System:</h6>

<blockquote>
  <p>The Store uses a hierarchical ID encoding for unique request identification:</p>
  
  <ul>
  <li>Formula: <code>agent_type * 100_000_000 + instance_id * 1_000_000 + request_counter</code></li>
  <li>Agent type code for Store: 1</li>
  <li>Example: store1's first request = 1_001_000_000</li>
  <li>This ensures globally unique request IDs across the multi-agent system.</li>
  </ul>
</blockquote>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>jid (str):</strong>  Jabber ID of the store agent (e.g., "store1@localhost").</li>
<li><strong>node_id (int):</strong>  Graph node ID representing the store's physical location.</li>
<li><strong>map (Graph):</strong>  Reference to the world graph for pathfinding and distance calculations.</li>
<li><strong>contact_list (list[str]):</strong>  List of warehouse JIDs for subscription and communication.</li>
<li><strong>verbose (bool):</strong>  Flag to control debug output verbosity. When True, detailed logs
are printed; when False, only essential information is shown.</li>
<li><strong>id_base (int):</strong>  Base value for generating unique request IDs using encoding formula.
Computed as <code>(1 * 100_000_000) + (instance_id * 1_000_000)</code>.</li>
<li><strong>stock (dict[str, int]):</strong>  Current inventory mapping product names to quantities.</li>
<li><strong>request_counter (int):</strong>  Monotonic counter for generating unique request IDs.
Incremented with each purchase request.</li>
<li><strong>current_buy_request (Message):</strong>  Reference to the most recent buy request message.</li>
<li><strong>failed_requests (queue.Queue):</strong>  FIFO queue holding failed purchase requests for retry.
Requests are enqueued when no warehouse accepts the order.</li>
<li><strong>pending_deliveries (dict[int, Order]):</strong>  Orders awaiting vehicle delivery, keyed by order ID.</li>
<li><strong>order_timings (dict[int, int]):</strong>  Tick timestamps when orders were confirmed, used for
calculating time-to-delivery statistics.</li>
<li><strong>current_tick (int):</strong>  Current simulation time tick, updated by world agent.</li>
<li><strong>product_list (list[str]):</strong>  Available products for purchase (from config.PRODUCTS).</li>
<li><strong>buy_prob (float):</strong>  Probability (0-1) of initiating a purchase each period
(from config.STORE_BUY_PROBABILITY).</li>
<li><strong>max_buy_quantity (int):</strong>  Maximum quantity that can be purchased in a single order
(from config.STORE_MAX_BUY_QUANTITY).</li>
<li><strong>stats_path (str):</strong>  Directory path for statistics CSV files.</li>
<li><strong>stats_filename (str):</strong>  Filename for order statistics CSV ("store_stats.csv").</li>
</ul>

<h6 id="behaviours">Behaviours:</h6>

<blockquote>
  <p>BuyProduct: Periodic behaviour that initiates purchase requests based on probability.
  CollectWarehouseResponses: Coordinator for FIPA Contract Net Protocol implementation.
  ReceiveAllResponses: Worker behaviour that collects all warehouse responses.
  SendStoreConfirmation: Sends confirmation to selected warehouse (FIPA accept-proposal).
  SendStoreDenial: Sends rejection to non-selected warehouses (FIPA reject-proposal).
  RetryPreviousBuy: Periodic behaviour that retries failed purchase requests.
  ReceiveTimeDelta: Cyclic behaviour that processes simulation time updates and traffic data.
  ReceiveVehicleArrival: Cyclic behaviour that handles vehicle delivery notifications.</p>
</blockquote>

<h6 id="message-protocols">Message Protocols:</h6>

<blockquote>
  <p>Outgoing Messages:
      - <code>store-buy</code>: Purchase request to warehouses (FIPA CFP).
          Body format: "{quantity} {product}"
          Metadata: store_id, node_id, request_id</p>

<pre><code>- `store-confirm`: Confirmation to selected warehouse (FIPA accept-proposal).
    Body format: "{quantity} {product}"
    Metadata: warehouse_id, store_id, node_id, request_id

- `store-deny`: Rejection to non-selected warehouses (FIPA reject-proposal).
    Body format: "{quantity} {product}"
    Metadata: warehouse_id, store_id, node_id, request_id
</code></pre>
  
  <p>Incoming Messages:
      - <code>warehouse-accept</code>: Warehouse accepts order (FIPA propose).
          Body format: "{quantity} {product}"</p>

<pre><code>- `warehouse-reject`: Warehouse rejects order (FIPA refuse).
    Body format: "{quantity} {product} {reason}"

- `vehicle-delivery`: Vehicle delivers products.
    Body format: JSON with orderid, time (ETA)

- `inform`: Time delta and traffic updates from world agent.
    Body format: JSON with type, time, data
</code></pre>
</blockquote>

<h6 id="notes">Notes:</h6>

<blockquote>
  <ul>
  <li>Only ONE purchase request should be active at a time to avoid conflicts.</li>
  <li>Failed requests are automatically retried by the RetryPreviousBuy behaviour.</li>
  <li>Stock is updated only upon vehicle delivery, not upon order confirmation.</li>
  <li>All order statistics are saved to CSV for post-simulation analysis.</li>
  <li>The agent subscribes to all warehouses in contact_list during setup.</li>
  </ul>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">store</span> <span class="o">=</span> <span class="n">Store</span><span class="p">(</span>
    <span class="n">jid</span><span class="o">=</span><span class="s2">&quot;store1@localhost&quot;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">,</span>
    <span class="nb">map</span><span class="o">=</span><span class="n">world_graph</span><span class="p">,</span>
    <span class="n">node_id</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">contact_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;warehouse1@localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse2@localhost&quot;</span><span class="p">],</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">await</span> <span class="n">store</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre>
  </div>
</blockquote>
</div>


                            <div id="Store.__init__" class="classattr">
                                        <input id="Store.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Store</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">jid</span>,</span><span class="param">	<span class="n">password</span>,</span><span class="param">	<span class="nb">map</span><span class="p">:</span> <span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Graph</span>,</span><span class="param">	<span class="n">node_id</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">port</span><span class="o">=</span><span class="mi">5222</span>,</span><span class="param">	<span class="n">verify_security</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">contact_list</span><span class="o">=</span><span class="p">[]</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="Store.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.__init__-2150"><a href="#Store.__init__-2150"><span class="linenos">2150</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="nb">map</span> <span class="p">:</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">node_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">5222</span><span class="p">,</span> <span class="n">verify_security</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">contact_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="Store.__init__-2151"><a href="#Store.__init__-2151"><span class="linenos">2151</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.__init__-2152"><a href="#Store.__init__-2152"><span class="linenos">2152</span></a><span class="sd">        Initialize the Store agent with configuration and state.</span>
</span><span id="Store.__init__-2153"><a href="#Store.__init__-2153"><span class="linenos">2153</span></a><span class="sd">        </span>
</span><span id="Store.__init__-2154"><a href="#Store.__init__-2154"><span class="linenos">2154</span></a><span class="sd">        This constructor sets up the store agent with all necessary parameters for</span>
</span><span id="Store.__init__-2155"><a href="#Store.__init__-2155"><span class="linenos">2155</span></a><span class="sd">        operation, including network configuration, graph reference, ID encoding,</span>
</span><span id="Store.__init__-2156"><a href="#Store.__init__-2156"><span class="linenos">2156</span></a><span class="sd">        and statistics tracking. It prepares the agent for FIPA Contract Net Protocol</span>
</span><span id="Store.__init__-2157"><a href="#Store.__init__-2157"><span class="linenos">2157</span></a><span class="sd">        negotiations and supply chain operations.</span>
</span><span id="Store.__init__-2158"><a href="#Store.__init__-2158"><span class="linenos">2158</span></a><span class="sd">        </span>
</span><span id="Store.__init__-2159"><a href="#Store.__init__-2159"><span class="linenos">2159</span></a><span class="sd">        Args:</span>
</span><span id="Store.__init__-2160"><a href="#Store.__init__-2160"><span class="linenos">2160</span></a><span class="sd">            jid (str): Jabber ID for the store agent (e.g., &quot;store1@localhost&quot;).</span>
</span><span id="Store.__init__-2161"><a href="#Store.__init__-2161"><span class="linenos">2161</span></a><span class="sd">                Must be unique within the XMPP server.</span>
</span><span id="Store.__init__-2162"><a href="#Store.__init__-2162"><span class="linenos">2162</span></a><span class="sd">            password (str): Authentication password for XMPP server connection.</span>
</span><span id="Store.__init__-2163"><a href="#Store.__init__-2163"><span class="linenos">2163</span></a><span class="sd">            map (Graph): Reference to the world graph for pathfinding and distance</span>
</span><span id="Store.__init__-2164"><a href="#Store.__init__-2164"><span class="linenos">2164</span></a><span class="sd">                calculations. Shared across all agents in the simulation.</span>
</span><span id="Store.__init__-2165"><a href="#Store.__init__-2165"><span class="linenos">2165</span></a><span class="sd">            node_id (int): Graph node ID representing the store&#39;s physical location.</span>
</span><span id="Store.__init__-2166"><a href="#Store.__init__-2166"><span class="linenos">2166</span></a><span class="sd">                Used in pathfinding and warehouse scoring.</span>
</span><span id="Store.__init__-2167"><a href="#Store.__init__-2167"><span class="linenos">2167</span></a><span class="sd">            port (int, optional): XMPP server port. Defaults to 5222 (standard XMPP).</span>
</span><span id="Store.__init__-2168"><a href="#Store.__init__-2168"><span class="linenos">2168</span></a><span class="sd">            verify_security (bool, optional): Whether to verify SSL/TLS certificates.</span>
</span><span id="Store.__init__-2169"><a href="#Store.__init__-2169"><span class="linenos">2169</span></a><span class="sd">                Defaults to False for local development. Set True for production.</span>
</span><span id="Store.__init__-2170"><a href="#Store.__init__-2170"><span class="linenos">2170</span></a><span class="sd">            contact_list (list[str], optional): List of warehouse JIDs to subscribe to.</span>
</span><span id="Store.__init__-2171"><a href="#Store.__init__-2171"><span class="linenos">2171</span></a><span class="sd">                Store will send purchase requests to these warehouses.</span>
</span><span id="Store.__init__-2172"><a href="#Store.__init__-2172"><span class="linenos">2172</span></a><span class="sd">                Defaults to empty list.</span>
</span><span id="Store.__init__-2173"><a href="#Store.__init__-2173"><span class="linenos">2173</span></a><span class="sd">            verbose (bool, optional): Enable detailed debug logging.</span>
</span><span id="Store.__init__-2174"><a href="#Store.__init__-2174"><span class="linenos">2174</span></a><span class="sd">                True: Print all debug information</span>
</span><span id="Store.__init__-2175"><a href="#Store.__init__-2175"><span class="linenos">2175</span></a><span class="sd">                False: Print only essential messages</span>
</span><span id="Store.__init__-2176"><a href="#Store.__init__-2176"><span class="linenos">2176</span></a><span class="sd">                Defaults to False.</span>
</span><span id="Store.__init__-2177"><a href="#Store.__init__-2177"><span class="linenos">2177</span></a><span class="sd">        </span>
</span><span id="Store.__init__-2178"><a href="#Store.__init__-2178"><span class="linenos">2178</span></a><span class="sd">        ID Encoding System:</span>
</span><span id="Store.__init__-2179"><a href="#Store.__init__-2179"><span class="linenos">2179</span></a><span class="sd">            Generates unique request IDs using hierarchical encoding:</span>
</span><span id="Store.__init__-2180"><a href="#Store.__init__-2180"><span class="linenos">2180</span></a><span class="sd">            - Formula: `(agent_type * 100_000_000) + (instance_id * 1_000_000) + counter`</span>
</span><span id="Store.__init__-2181"><a href="#Store.__init__-2181"><span class="linenos">2181</span></a><span class="sd">            - Store type code: 1</span>
</span><span id="Store.__init__-2182"><a href="#Store.__init__-2182"><span class="linenos">2182</span></a><span class="sd">            - Instance ID: Extracted from JID (e.g., &quot;store1&quot; -&gt; 1, &quot;store42&quot; -&gt; 42)</span>
</span><span id="Store.__init__-2183"><a href="#Store.__init__-2183"><span class="linenos">2183</span></a><span class="sd">            - Example: store1&#39;s first request = 1_001_000_000</span>
</span><span id="Store.__init__-2184"><a href="#Store.__init__-2184"><span class="linenos">2184</span></a><span class="sd">            - Example: store1&#39;s second request = 1_001_000_001</span>
</span><span id="Store.__init__-2185"><a href="#Store.__init__-2185"><span class="linenos">2185</span></a><span class="sd">            - Ensures global uniqueness across all agents and requests</span>
</span><span id="Store.__init__-2186"><a href="#Store.__init__-2186"><span class="linenos">2186</span></a><span class="sd">        </span>
</span><span id="Store.__init__-2187"><a href="#Store.__init__-2187"><span class="linenos">2187</span></a><span class="sd">        Configuration Loading:</span>
</span><span id="Store.__init__-2188"><a href="#Store.__init__-2188"><span class="linenos">2188</span></a><span class="sd">            Imports from config module:</span>
</span><span id="Store.__init__-2189"><a href="#Store.__init__-2189"><span class="linenos">2189</span></a><span class="sd">            - PRODUCTS: List of available products for purchase</span>
</span><span id="Store.__init__-2190"><a href="#Store.__init__-2190"><span class="linenos">2190</span></a><span class="sd">            - STORE_BUY_PROBABILITY: Probability (0-1) of purchase attempt per period</span>
</span><span id="Store.__init__-2191"><a href="#Store.__init__-2191"><span class="linenos">2191</span></a><span class="sd">            - STORE_MAX_BUY_QUANTITY: Maximum quantity per purchase order</span>
</span><span id="Store.__init__-2192"><a href="#Store.__init__-2192"><span class="linenos">2192</span></a><span class="sd">        </span>
</span><span id="Store.__init__-2193"><a href="#Store.__init__-2193"><span class="linenos">2193</span></a><span class="sd">        State Initialization:</span>
</span><span id="Store.__init__-2194"><a href="#Store.__init__-2194"><span class="linenos">2194</span></a><span class="sd">            - pending_deliveries: Empty dict for tracking orders awaiting delivery</span>
</span><span id="Store.__init__-2195"><a href="#Store.__init__-2195"><span class="linenos">2195</span></a><span class="sd">            - order_timings: Empty dict for recording confirmation timestamps</span>
</span><span id="Store.__init__-2196"><a href="#Store.__init__-2196"><span class="linenos">2196</span></a><span class="sd">            - current_tick: 0 (synchronized by world agent during runtime)</span>
</span><span id="Store.__init__-2197"><a href="#Store.__init__-2197"><span class="linenos">2197</span></a><span class="sd">            - stock: Initialized in setup() as empty dict</span>
</span><span id="Store.__init__-2198"><a href="#Store.__init__-2198"><span class="linenos">2198</span></a><span class="sd">            - failed_requests: Initialized in setup() as empty queue</span>
</span><span id="Store.__init__-2199"><a href="#Store.__init__-2199"><span class="linenos">2199</span></a><span class="sd">            - request_counter: Initialized in setup() as 0</span>
</span><span id="Store.__init__-2200"><a href="#Store.__init__-2200"><span class="linenos">2200</span></a><span class="sd">        </span>
</span><span id="Store.__init__-2201"><a href="#Store.__init__-2201"><span class="linenos">2201</span></a><span class="sd">        Statistics Configuration:</span>
</span><span id="Store.__init__-2202"><a href="#Store.__init__-2202"><span class="linenos">2202</span></a><span class="sd">            - stats_path: &quot;stats/&quot; directory (created automatically if needed)</span>
</span><span id="Store.__init__-2203"><a href="#Store.__init__-2203"><span class="linenos">2203</span></a><span class="sd">            - stats_filename: &quot;store_stats.csv&quot; (append mode)</span>
</span><span id="Store.__init__-2204"><a href="#Store.__init__-2204"><span class="linenos">2204</span></a><span class="sd">        </span>
</span><span id="Store.__init__-2205"><a href="#Store.__init__-2205"><span class="linenos">2205</span></a><span class="sd">        Example:</span>
</span><span id="Store.__init__-2206"><a href="#Store.__init__-2206"><span class="linenos">2206</span></a><span class="sd">            ```python</span>
</span><span id="Store.__init__-2207"><a href="#Store.__init__-2207"><span class="linenos">2207</span></a><span class="sd">            from world.graph import Graph</span>
</span><span id="Store.__init__-2208"><a href="#Store.__init__-2208"><span class="linenos">2208</span></a><span class="sd">            </span>
</span><span id="Store.__init__-2209"><a href="#Store.__init__-2209"><span class="linenos">2209</span></a><span class="sd">            map_graph = Graph()</span>
</span><span id="Store.__init__-2210"><a href="#Store.__init__-2210"><span class="linenos">2210</span></a><span class="sd">            # ... add nodes and edges to graph ...</span>
</span><span id="Store.__init__-2211"><a href="#Store.__init__-2211"><span class="linenos">2211</span></a><span class="sd">            </span>
</span><span id="Store.__init__-2212"><a href="#Store.__init__-2212"><span class="linenos">2212</span></a><span class="sd">            store = Store(</span>
</span><span id="Store.__init__-2213"><a href="#Store.__init__-2213"><span class="linenos">2213</span></a><span class="sd">                jid=&quot;store1@localhost&quot;,</span>
</span><span id="Store.__init__-2214"><a href="#Store.__init__-2214"><span class="linenos">2214</span></a><span class="sd">                password=&quot;secure_password&quot;,</span>
</span><span id="Store.__init__-2215"><a href="#Store.__init__-2215"><span class="linenos">2215</span></a><span class="sd">                map=map_graph,</span>
</span><span id="Store.__init__-2216"><a href="#Store.__init__-2216"><span class="linenos">2216</span></a><span class="sd">                node_id=5,</span>
</span><span id="Store.__init__-2217"><a href="#Store.__init__-2217"><span class="linenos">2217</span></a><span class="sd">                port=5222,</span>
</span><span id="Store.__init__-2218"><a href="#Store.__init__-2218"><span class="linenos">2218</span></a><span class="sd">                verify_security=False,</span>
</span><span id="Store.__init__-2219"><a href="#Store.__init__-2219"><span class="linenos">2219</span></a><span class="sd">                contact_list=[&quot;warehouse1@localhost&quot;, &quot;warehouse2@localhost&quot;],</span>
</span><span id="Store.__init__-2220"><a href="#Store.__init__-2220"><span class="linenos">2220</span></a><span class="sd">                verbose=True</span>
</span><span id="Store.__init__-2221"><a href="#Store.__init__-2221"><span class="linenos">2221</span></a><span class="sd">            )</span>
</span><span id="Store.__init__-2222"><a href="#Store.__init__-2222"><span class="linenos">2222</span></a><span class="sd">            </span>
</span><span id="Store.__init__-2223"><a href="#Store.__init__-2223"><span class="linenos">2223</span></a><span class="sd">            # store.id_base = 1_001_000_000</span>
</span><span id="Store.__init__-2224"><a href="#Store.__init__-2224"><span class="linenos">2224</span></a><span class="sd">            # Ready to start and begin purchasing</span>
</span><span id="Store.__init__-2225"><a href="#Store.__init__-2225"><span class="linenos">2225</span></a><span class="sd">            await store.start()</span>
</span><span id="Store.__init__-2226"><a href="#Store.__init__-2226"><span class="linenos">2226</span></a><span class="sd">            ```</span>
</span><span id="Store.__init__-2227"><a href="#Store.__init__-2227"><span class="linenos">2227</span></a><span class="sd">        </span>
</span><span id="Store.__init__-2228"><a href="#Store.__init__-2228"><span class="linenos">2228</span></a><span class="sd">        Note:</span>
</span><span id="Store.__init__-2229"><a href="#Store.__init__-2229"><span class="linenos">2229</span></a><span class="sd">            The agent is not fully operational until setup() is called (automatically</span>
</span><span id="Store.__init__-2230"><a href="#Store.__init__-2230"><span class="linenos">2230</span></a><span class="sd">            by SPADE when start() is invoked). The setup() method initializes</span>
</span><span id="Store.__init__-2231"><a href="#Store.__init__-2231"><span class="linenos">2231</span></a><span class="sd">            behaviours and subscribes to contacts.</span>
</span><span id="Store.__init__-2232"><a href="#Store.__init__-2232"><span class="linenos">2232</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.__init__-2233"><a href="#Store.__init__-2233"><span class="linenos">2233</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">verify_security</span><span class="p">)</span>
</span><span id="Store.__init__-2234"><a href="#Store.__init__-2234"><span class="linenos">2234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node_id</span>
</span><span id="Store.__init__-2235"><a href="#Store.__init__-2235"><span class="linenos">2235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="p">:</span> <span class="n">Graph</span> <span class="o">=</span> <span class="nb">map</span>
</span><span id="Store.__init__-2236"><a href="#Store.__init__-2236"><span class="linenos">2236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contact_list</span> <span class="o">=</span> <span class="n">contact_list</span>
</span><span id="Store.__init__-2237"><a href="#Store.__init__-2237"><span class="linenos">2237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="Store.__init__-2238"><a href="#Store.__init__-2238"><span class="linenos">2238</span></a>        
</span><span id="Store.__init__-2239"><a href="#Store.__init__-2239"><span class="linenos">2239</span></a>        <span class="c1"># Extract instance number from JID for ID encoding (e.g., &quot;store1@localhost&quot; -&gt; 1)</span>
</span><span id="Store.__init__-2240"><a href="#Store.__init__-2240"><span class="linenos">2240</span></a>        <span class="n">jid_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Store.__init__-2241"><a href="#Store.__init__-2241"><span class="linenos">2241</span></a>        <span class="n">instance_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">,</span> <span class="n">jid_name</span><span class="p">)))</span>
</span><span id="Store.__init__-2242"><a href="#Store.__init__-2242"><span class="linenos">2242</span></a>        
</span><span id="Store.__init__-2243"><a href="#Store.__init__-2243"><span class="linenos">2243</span></a>        <span class="c1"># Calculate ID base: Store type code = 1</span>
</span><span id="Store.__init__-2244"><a href="#Store.__init__-2244"><span class="linenos">2244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id_base</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">100_000_000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">instance_id</span> <span class="o">*</span> <span class="mi">1_000_000</span><span class="p">)</span>
</span><span id="Store.__init__-2245"><a href="#Store.__init__-2245"><span class="linenos">2245</span></a>        
</span><span id="Store.__init__-2246"><a href="#Store.__init__-2246"><span class="linenos">2246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pending_deliveries</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># key: request_id, value: Order object</span>
</span><span id="Store.__init__-2247"><a href="#Store.__init__-2247"><span class="linenos">2247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">order_timings</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{}</span>  <span class="c1"># key: request_id, value: ticks at confirmation</span>
</span><span id="Store.__init__-2248"><a href="#Store.__init__-2248"><span class="linenos">2248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_tick</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Store.__init__-2249"><a href="#Store.__init__-2249"><span class="linenos">2249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stats_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;stats&quot;</span><span class="p">)</span>
</span><span id="Store.__init__-2250"><a href="#Store.__init__-2250"><span class="linenos">2250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stats_filename</span> <span class="o">=</span> <span class="s2">&quot;store_stats.csv&quot;</span>
</span><span id="Store.__init__-2251"><a href="#Store.__init__-2251"><span class="linenos">2251</span></a>        
</span><span id="Store.__init__-2252"><a href="#Store.__init__-2252"><span class="linenos">2252</span></a>        <span class="c1"># Constants from config</span>
</span><span id="Store.__init__-2253"><a href="#Store.__init__-2253"><span class="linenos">2253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">product_list</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">PRODUCTS</span>
</span><span id="Store.__init__-2254"><a href="#Store.__init__-2254"><span class="linenos">2254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buy_prob</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">STORE_BUY_PROBABILITY</span>
</span><span id="Store.__init__-2255"><a href="#Store.__init__-2255"><span class="linenos">2255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_buy_quantity</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">STORE_MAX_BUY_QUANTITY</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the Store agent with configuration and state.</p>

<p>This constructor sets up the store agent with all necessary parameters for
operation, including network configuration, graph reference, ID encoding,
and statistics tracking. It prepares the agent for FIPA Contract Net Protocol
negotiations and supply chain operations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>jid (str):</strong>  Jabber ID for the store agent (e.g., "store1@localhost").
Must be unique within the XMPP server.</li>
<li><strong>password (str):</strong>  Authentication password for XMPP server connection.</li>
<li><strong>map (Graph):</strong>  Reference to the world graph for pathfinding and distance
calculations. Shared across all agents in the simulation.</li>
<li><strong>node_id (int):</strong>  Graph node ID representing the store's physical location.
Used in pathfinding and warehouse scoring.</li>
<li><strong>port (int, optional):</strong>  XMPP server port. Defaults to 5222 (standard XMPP).</li>
<li><strong>verify_security (bool, optional):</strong>  Whether to verify SSL/TLS certificates.
Defaults to False for local development. Set True for production.</li>
<li><strong>contact_list (list[str], optional):</strong>  List of warehouse JIDs to subscribe to.
Store will send purchase requests to these warehouses.
Defaults to empty list.</li>
<li><strong>verbose (bool, optional):</strong>  Enable detailed debug logging.
True: Print all debug information
False: Print only essential messages
Defaults to False.</li>
</ul>

<h6 id="id-encoding-system">ID Encoding System:</h6>

<blockquote>
  <p>Generates unique request IDs using hierarchical encoding:</p>
  
  <ul>
  <li>Formula: <code>(agent_type * 100_000_000) + (instance_id * 1_000_000) + counter</code></li>
  <li>Store type code: 1</li>
  <li>Instance ID: Extracted from JID (e.g., "store1" -> 1, "store42" -> 42)</li>
  <li>Example: store1's first request = 1_001_000_000</li>
  <li>Example: store1's second request = 1_001_000_001</li>
  <li>Ensures global uniqueness across all agents and requests</li>
  </ul>
</blockquote>

<h6 id="configuration-loading">Configuration Loading:</h6>

<blockquote>
  <p>Imports from config module:</p>
  
  <ul>
  <li>PRODUCTS: List of available products for purchase</li>
  <li>STORE_BUY_PROBABILITY: Probability (0-1) of purchase attempt per period</li>
  <li>STORE_MAX_BUY_QUANTITY: Maximum quantity per purchase order</li>
  </ul>
</blockquote>

<h6 id="state-initialization">State Initialization:</h6>

<blockquote>
  <ul>
  <li>pending_deliveries: Empty dict for tracking orders awaiting delivery</li>
  <li>order_timings: Empty dict for recording confirmation timestamps</li>
  <li>current_tick: 0 (synchronized by world agent during runtime)</li>
  <li>stock: Initialized in setup() as empty dict</li>
  <li>failed_requests: Initialized in setup() as empty queue</li>
  <li>request_counter: Initialized in setup() as 0</li>
  </ul>
</blockquote>

<h6 id="statistics-configuration">Statistics Configuration:</h6>

<blockquote>
  <ul>
  <li>stats_path: "stats/" directory (created automatically if needed)</li>
  <li>stats_filename: "store_stats.csv" (append mode)</li>
  </ul>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">world.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">Graph</span>

<span class="n">map_graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
<span class="c1"># ... add nodes and edges to graph ...</span>

<span class="n">store</span> <span class="o">=</span> <span class="n">Store</span><span class="p">(</span>
    <span class="n">jid</span><span class="o">=</span><span class="s2">&quot;store1@localhost&quot;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s2">&quot;secure_password&quot;</span><span class="p">,</span>
    <span class="nb">map</span><span class="o">=</span><span class="n">map_graph</span><span class="p">,</span>
    <span class="n">node_id</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="mi">5222</span><span class="p">,</span>
    <span class="n">verify_security</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">contact_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;warehouse1@localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse2@localhost&quot;</span><span class="p">],</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># store.id_base = 1_001_000_000</span>
<span class="c1"># Ready to start and begin purchasing</span>
<span class="k">await</span> <span class="n">store</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre>
  </div>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>The agent is not fully operational until setup() is called (automatically
  by SPADE when start() is invoked). The setup() method initializes
  behaviours and subscribes to contacts.</p>
</blockquote>
</div>


                            </div>
                            <div id="Store.calculate_warehouse_score" class="classattr">
                                        <input id="Store.calculate_warehouse_score-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_warehouse_score</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">accept_msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Store.calculate_warehouse_score-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.calculate_warehouse_score"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.calculate_warehouse_score-1664"><a href="#Store.calculate_warehouse_score-1664"><span class="linenos">1664</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_warehouse_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Store.calculate_warehouse_score-1665"><a href="#Store.calculate_warehouse_score-1665"><span class="linenos">1665</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.calculate_warehouse_score-1666"><a href="#Store.calculate_warehouse_score-1666"><span class="linenos">1666</span></a><span class="sd">        Calculate the score for a warehouse proposal based on delivery time.</span>
</span><span id="Store.calculate_warehouse_score-1667"><a href="#Store.calculate_warehouse_score-1667"><span class="linenos">1667</span></a><span class="sd">        </span>
</span><span id="Store.calculate_warehouse_score-1668"><a href="#Store.calculate_warehouse_score-1668"><span class="linenos">1668</span></a><span class="sd">        This method implements the proposal evaluation logic for the FIPA Contract Net</span>
</span><span id="Store.calculate_warehouse_score-1669"><a href="#Store.calculate_warehouse_score-1669"><span class="linenos">1669</span></a><span class="sd">        Protocol, scoring each warehouse that submitted a proposal (warehouse-accept).</span>
</span><span id="Store.calculate_warehouse_score-1670"><a href="#Store.calculate_warehouse_score-1670"><span class="linenos">1670</span></a><span class="sd">        The score is based on the estimated delivery time using Dijkstra&#39;s shortest path</span>
</span><span id="Store.calculate_warehouse_score-1671"><a href="#Store.calculate_warehouse_score-1671"><span class="linenos">1671</span></a><span class="sd">        algorithm on the world graph.</span>
</span><span id="Store.calculate_warehouse_score-1672"><a href="#Store.calculate_warehouse_score-1672"><span class="linenos">1672</span></a><span class="sd">        </span>
</span><span id="Store.calculate_warehouse_score-1673"><a href="#Store.calculate_warehouse_score-1673"><span class="linenos">1673</span></a><span class="sd">        Scoring Algorithm:</span>
</span><span id="Store.calculate_warehouse_score-1674"><a href="#Store.calculate_warehouse_score-1674"><span class="linenos">1674</span></a><span class="sd">            - Uses Dijkstra pathfinding: warehouse_node -&gt; store_node</span>
</span><span id="Store.calculate_warehouse_score-1675"><a href="#Store.calculate_warehouse_score-1675"><span class="linenos">1675</span></a><span class="sd">            - Returns: (path, fuel_cost, delivery_time)</span>
</span><span id="Store.calculate_warehouse_score-1676"><a href="#Store.calculate_warehouse_score-1676"><span class="linenos">1676</span></a><span class="sd">            - Score = delivery_time (lower is better)</span>
</span><span id="Store.calculate_warehouse_score-1677"><a href="#Store.calculate_warehouse_score-1677"><span class="linenos">1677</span></a><span class="sd">            - Optimization goal: Minimize delivery time</span>
</span><span id="Store.calculate_warehouse_score-1678"><a href="#Store.calculate_warehouse_score-1678"><span class="linenos">1678</span></a><span class="sd">        </span>
</span><span id="Store.calculate_warehouse_score-1679"><a href="#Store.calculate_warehouse_score-1679"><span class="linenos">1679</span></a><span class="sd">        FIPA Contract Net Protocol Context:</span>
</span><span id="Store.calculate_warehouse_score-1680"><a href="#Store.calculate_warehouse_score-1680"><span class="linenos">1680</span></a><span class="sd">            - Phase: Proposal Evaluation</span>
</span><span id="Store.calculate_warehouse_score-1681"><a href="#Store.calculate_warehouse_score-1681"><span class="linenos">1681</span></a><span class="sd">            - Purpose: Compare multiple proposals objectively</span>
</span><span id="Store.calculate_warehouse_score-1682"><a href="#Store.calculate_warehouse_score-1682"><span class="linenos">1682</span></a><span class="sd">            - Decision Criteria: Distance-based (delivery time)</span>
</span><span id="Store.calculate_warehouse_score-1683"><a href="#Store.calculate_warehouse_score-1683"><span class="linenos">1683</span></a><span class="sd">            - Result: Enables selection of optimal warehouse</span>
</span><span id="Store.calculate_warehouse_score-1684"><a href="#Store.calculate_warehouse_score-1684"><span class="linenos">1684</span></a><span class="sd">        </span>
</span><span id="Store.calculate_warehouse_score-1685"><a href="#Store.calculate_warehouse_score-1685"><span class="linenos">1685</span></a><span class="sd">        Args:</span>
</span><span id="Store.calculate_warehouse_score-1686"><a href="#Store.calculate_warehouse_score-1686"><span class="linenos">1686</span></a><span class="sd">            accept_msg (Message): The warehouse-accept message from a warehouse.</span>
</span><span id="Store.calculate_warehouse_score-1687"><a href="#Store.calculate_warehouse_score-1687"><span class="linenos">1687</span></a><span class="sd">                Contains metadata with node_id of the warehouse&#39;s location.</span>
</span><span id="Store.calculate_warehouse_score-1688"><a href="#Store.calculate_warehouse_score-1688"><span class="linenos">1688</span></a><span class="sd">        </span>
</span><span id="Store.calculate_warehouse_score-1689"><a href="#Store.calculate_warehouse_score-1689"><span class="linenos">1689</span></a><span class="sd">        Returns:</span>
</span><span id="Store.calculate_warehouse_score-1690"><a href="#Store.calculate_warehouse_score-1690"><span class="linenos">1690</span></a><span class="sd">            float: Delivery time score. Lower values indicate better proposals</span>
</span><span id="Store.calculate_warehouse_score-1691"><a href="#Store.calculate_warehouse_score-1691"><span class="linenos">1691</span></a><span class="sd">                (shorter delivery time).</span>
</span><span id="Store.calculate_warehouse_score-1692"><a href="#Store.calculate_warehouse_score-1692"><span class="linenos">1692</span></a><span class="sd">        </span>
</span><span id="Store.calculate_warehouse_score-1693"><a href="#Store.calculate_warehouse_score-1693"><span class="linenos">1693</span></a><span class="sd">        Scoring Details:</span>
</span><span id="Store.calculate_warehouse_score-1694"><a href="#Store.calculate_warehouse_score-1694"><span class="linenos">1694</span></a><span class="sd">            - Extracts warehouse node_id from message metadata</span>
</span><span id="Store.calculate_warehouse_score-1695"><a href="#Store.calculate_warehouse_score-1695"><span class="linenos">1695</span></a><span class="sd">            - Calls Dijkstra: map.djikstra(warehouse_id, store_id)</span>
</span><span id="Store.calculate_warehouse_score-1696"><a href="#Store.calculate_warehouse_score-1696"><span class="linenos">1696</span></a><span class="sd">            - Returns time component (ignores path and fuel for scoring)</span>
</span><span id="Store.calculate_warehouse_score-1697"><a href="#Store.calculate_warehouse_score-1697"><span class="linenos">1697</span></a><span class="sd">            - Units: Simulation ticks (time units in the simulation)</span>
</span><span id="Store.calculate_warehouse_score-1698"><a href="#Store.calculate_warehouse_score-1698"><span class="linenos">1698</span></a><span class="sd">        </span>
</span><span id="Store.calculate_warehouse_score-1699"><a href="#Store.calculate_warehouse_score-1699"><span class="linenos">1699</span></a><span class="sd">        Example:</span>
</span><span id="Store.calculate_warehouse_score-1700"><a href="#Store.calculate_warehouse_score-1700"><span class="linenos">1700</span></a><span class="sd">            ```python</span>
</span><span id="Store.calculate_warehouse_score-1701"><a href="#Store.calculate_warehouse_score-1701"><span class="linenos">1701</span></a><span class="sd">            # Warehouse at node 10, Store at node 5</span>
</span><span id="Store.calculate_warehouse_score-1702"><a href="#Store.calculate_warehouse_score-1702"><span class="linenos">1702</span></a><span class="sd">            msg = warehouse_accept_message  # node_id = 10</span>
</span><span id="Store.calculate_warehouse_score-1703"><a href="#Store.calculate_warehouse_score-1703"><span class="linenos">1703</span></a><span class="sd">            score = store.calculate_warehouse_score(msg)</span>
</span><span id="Store.calculate_warehouse_score-1704"><a href="#Store.calculate_warehouse_score-1704"><span class="linenos">1704</span></a><span class="sd">            # Dijkstra returns: ([10, 8, 5], 12.5, 120)</span>
</span><span id="Store.calculate_warehouse_score-1705"><a href="#Store.calculate_warehouse_score-1705"><span class="linenos">1705</span></a><span class="sd">            # score = 120 (delivery time)</span>
</span><span id="Store.calculate_warehouse_score-1706"><a href="#Store.calculate_warehouse_score-1706"><span class="linenos">1706</span></a><span class="sd">            ```</span>
</span><span id="Store.calculate_warehouse_score-1707"><a href="#Store.calculate_warehouse_score-1707"><span class="linenos">1707</span></a><span class="sd">        </span>
</span><span id="Store.calculate_warehouse_score-1708"><a href="#Store.calculate_warehouse_score-1708"><span class="linenos">1708</span></a><span class="sd">        Note:</span>
</span><span id="Store.calculate_warehouse_score-1709"><a href="#Store.calculate_warehouse_score-1709"><span class="linenos">1709</span></a><span class="sd">            This method is called by CollectWarehouseResponses during proposal</span>
</span><span id="Store.calculate_warehouse_score-1710"><a href="#Store.calculate_warehouse_score-1710"><span class="linenos">1710</span></a><span class="sd">            evaluation. All warehouses that sent warehouse-accept are scored,</span>
</span><span id="Store.calculate_warehouse_score-1711"><a href="#Store.calculate_warehouse_score-1711"><span class="linenos">1711</span></a><span class="sd">            and the one with the lowest score (minimum time) is selected.</span>
</span><span id="Store.calculate_warehouse_score-1712"><a href="#Store.calculate_warehouse_score-1712"><span class="linenos">1712</span></a><span class="sd">        </span>
</span><span id="Store.calculate_warehouse_score-1713"><a href="#Store.calculate_warehouse_score-1713"><span class="linenos">1713</span></a><span class="sd">        Alternative Scoring Strategies:</span>
</span><span id="Store.calculate_warehouse_score-1714"><a href="#Store.calculate_warehouse_score-1714"><span class="linenos">1714</span></a><span class="sd">            The algorithm could be extended to consider:</span>
</span><span id="Store.calculate_warehouse_score-1715"><a href="#Store.calculate_warehouse_score-1715"><span class="linenos">1715</span></a><span class="sd">            - Weighted combination: time * w1 + fuel * w2</span>
</span><span id="Store.calculate_warehouse_score-1716"><a href="#Store.calculate_warehouse_score-1716"><span class="linenos">1716</span></a><span class="sd">            - Multi-criteria: time, fuel, warehouse reputation</span>
</span><span id="Store.calculate_warehouse_score-1717"><a href="#Store.calculate_warehouse_score-1717"><span class="linenos">1717</span></a><span class="sd">            - Dynamic weights: Based on urgency or fuel costs</span>
</span><span id="Store.calculate_warehouse_score-1718"><a href="#Store.calculate_warehouse_score-1718"><span class="linenos">1718</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.calculate_warehouse_score-1719"><a href="#Store.calculate_warehouse_score-1719"><span class="linenos">1719</span></a>        
</span><span id="Store.calculate_warehouse_score-1720"><a href="#Store.calculate_warehouse_score-1720"><span class="linenos">1720</span></a>        <span class="n">warehouse_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">accept_msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">))</span>
</span><span id="Store.calculate_warehouse_score-1721"><a href="#Store.calculate_warehouse_score-1721"><span class="linenos">1721</span></a>        <span class="n">path</span><span class="p">,</span> <span class="n">fuel</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">djikstra</span><span class="p">(</span><span class="n">warehouse_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="Store.calculate_warehouse_score-1722"><a href="#Store.calculate_warehouse_score-1722"><span class="linenos">1722</span></a>        
</span><span id="Store.calculate_warehouse_score-1723"><a href="#Store.calculate_warehouse_score-1723"><span class="linenos">1723</span></a>        <span class="k">return</span> <span class="n">time</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the score for a warehouse proposal based on delivery time.</p>

<p>This method implements the proposal evaluation logic for the FIPA Contract Net
Protocol, scoring each warehouse that submitted a proposal (warehouse-accept).
The score is based on the estimated delivery time using Dijkstra's shortest path
algorithm on the world graph.</p>

<h6 id="scoring-algorithm">Scoring Algorithm:</h6>

<blockquote>
  <ul>
  <li>Uses Dijkstra pathfinding: warehouse_node -> store_node</li>
  <li>Returns: (path, fuel_cost, delivery_time)</li>
  <li>Score = delivery_time (lower is better)</li>
  <li>Optimization goal: Minimize delivery time</li>
  </ul>
</blockquote>

<h6 id="fipa-contract-net-protocol-context">FIPA Contract Net Protocol Context:</h6>

<blockquote>
  <ul>
  <li>Phase: Proposal Evaluation</li>
  <li>Purpose: Compare multiple proposals objectively</li>
  <li>Decision Criteria: Distance-based (delivery time)</li>
  <li>Result: Enables selection of optimal warehouse</li>
  </ul>
</blockquote>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>accept_msg (Message):</strong>  The warehouse-accept message from a warehouse.
Contains metadata with node_id of the warehouse's location.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>float: Delivery time score. Lower values indicate better proposals
      (shorter delivery time).</p>
</blockquote>

<h6 id="scoring-details">Scoring Details:</h6>

<blockquote>
  <ul>
  <li>Extracts warehouse node_id from message metadata</li>
  <li>Calls Dijkstra: map.djikstra(warehouse_id, store_id)</li>
  <li>Returns time component (ignores path and fuel for scoring)</li>
  <li>Units: Simulation ticks (time units in the simulation)</li>
  </ul>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># Warehouse at node 10, Store at node 5</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">warehouse_accept_message</span>  <span class="c1"># node_id = 10</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">calculate_warehouse_score</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="c1"># Dijkstra returns: ([10, 8, 5], 12.5, 120)</span>
<span class="c1"># score = 120 (delivery time)</span>
</code></pre>
  </div>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This method is called by CollectWarehouseResponses during proposal
  evaluation. All warehouses that sent warehouse-accept are scored,
  and the one with the lowest score (minimum time) is selected.</p>
</blockquote>

<h6 id="alternative-scoring-strategies">Alternative Scoring Strategies:</h6>

<blockquote>
  <p>The algorithm could be extended to consider:</p>
  
  <ul>
  <li>Weighted combination: time * w1 + fuel * w2</li>
  <li>Multi-criteria: time, fuel, warehouse reputation</li>
  <li>Dynamic weights: Based on urgency or fuel costs</li>
  </ul>
</blockquote>
</div>


                            </div>
                            <div id="Store.dict_to_order" class="classattr">
                                        <input id="Store.dict_to_order-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dict_to_order</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">) -> <span class="n"><a href="veiculos/veiculos.html#Order">veiculos.veiculos.Order</a></span>:</span></span>

                <label class="view-source-button" for="Store.dict_to_order-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.dict_to_order"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.dict_to_order-1725"><a href="#Store.dict_to_order-1725"><span class="linenos">1725</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dict_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
</span><span id="Store.dict_to_order-1726"><a href="#Store.dict_to_order-1726"><span class="linenos">1726</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.dict_to_order-1727"><a href="#Store.dict_to_order-1727"><span class="linenos">1727</span></a><span class="sd">        Convert a dictionary representation to an Order object.</span>
</span><span id="Store.dict_to_order-1728"><a href="#Store.dict_to_order-1728"><span class="linenos">1728</span></a><span class="sd">        </span>
</span><span id="Store.dict_to_order-1729"><a href="#Store.dict_to_order-1729"><span class="linenos">1729</span></a><span class="sd">        This helper method deserializes order data from dictionary format into</span>
</span><span id="Store.dict_to_order-1730"><a href="#Store.dict_to_order-1730"><span class="linenos">1730</span></a><span class="sd">        an Order object instance, setting all required fields and optional location</span>
</span><span id="Store.dict_to_order-1731"><a href="#Store.dict_to_order-1731"><span class="linenos">1731</span></a><span class="sd">        information if present.</span>
</span><span id="Store.dict_to_order-1732"><a href="#Store.dict_to_order-1732"><span class="linenos">1732</span></a><span class="sd">        </span>
</span><span id="Store.dict_to_order-1733"><a href="#Store.dict_to_order-1733"><span class="linenos">1733</span></a><span class="sd">        Args:</span>
</span><span id="Store.dict_to_order-1734"><a href="#Store.dict_to_order-1734"><span class="linenos">1734</span></a><span class="sd">            data (dict): Dictionary containing order information with keys:</span>
</span><span id="Store.dict_to_order-1735"><a href="#Store.dict_to_order-1735"><span class="linenos">1735</span></a><span class="sd">                - product (str): Product name</span>
</span><span id="Store.dict_to_order-1736"><a href="#Store.dict_to_order-1736"><span class="linenos">1736</span></a><span class="sd">                - quantity (int): Quantity ordered</span>
</span><span id="Store.dict_to_order-1737"><a href="#Store.dict_to_order-1737"><span class="linenos">1737</span></a><span class="sd">                - orderid (int): Unique order identifier</span>
</span><span id="Store.dict_to_order-1738"><a href="#Store.dict_to_order-1738"><span class="linenos">1738</span></a><span class="sd">                - sender (str): Sender&#39;s JID</span>
</span><span id="Store.dict_to_order-1739"><a href="#Store.dict_to_order-1739"><span class="linenos">1739</span></a><span class="sd">                - receiver (str): Receiver&#39;s JID</span>
</span><span id="Store.dict_to_order-1740"><a href="#Store.dict_to_order-1740"><span class="linenos">1740</span></a><span class="sd">                - sender_location (int, optional): Sender&#39;s graph node ID</span>
</span><span id="Store.dict_to_order-1741"><a href="#Store.dict_to_order-1741"><span class="linenos">1741</span></a><span class="sd">                - receiver_location (int, optional): Receiver&#39;s graph node ID</span>
</span><span id="Store.dict_to_order-1742"><a href="#Store.dict_to_order-1742"><span class="linenos">1742</span></a><span class="sd">        </span>
</span><span id="Store.dict_to_order-1743"><a href="#Store.dict_to_order-1743"><span class="linenos">1743</span></a><span class="sd">        Returns:</span>
</span><span id="Store.dict_to_order-1744"><a href="#Store.dict_to_order-1744"><span class="linenos">1744</span></a><span class="sd">            Order: Fully populated Order object with all fields from dictionary.</span>
</span><span id="Store.dict_to_order-1745"><a href="#Store.dict_to_order-1745"><span class="linenos">1745</span></a><span class="sd">        </span>
</span><span id="Store.dict_to_order-1746"><a href="#Store.dict_to_order-1746"><span class="linenos">1746</span></a><span class="sd">        Example:</span>
</span><span id="Store.dict_to_order-1747"><a href="#Store.dict_to_order-1747"><span class="linenos">1747</span></a><span class="sd">            ```python</span>
</span><span id="Store.dict_to_order-1748"><a href="#Store.dict_to_order-1748"><span class="linenos">1748</span></a><span class="sd">            data = {</span>
</span><span id="Store.dict_to_order-1749"><a href="#Store.dict_to_order-1749"><span class="linenos">1749</span></a><span class="sd">                &quot;product&quot;: &quot;electronics&quot;,</span>
</span><span id="Store.dict_to_order-1750"><a href="#Store.dict_to_order-1750"><span class="linenos">1750</span></a><span class="sd">                &quot;quantity&quot;: 50,</span>
</span><span id="Store.dict_to_order-1751"><a href="#Store.dict_to_order-1751"><span class="linenos">1751</span></a><span class="sd">                &quot;orderid&quot;: 1001000000,</span>
</span><span id="Store.dict_to_order-1752"><a href="#Store.dict_to_order-1752"><span class="linenos">1752</span></a><span class="sd">                &quot;sender&quot;: &quot;warehouse1@localhost&quot;,</span>
</span><span id="Store.dict_to_order-1753"><a href="#Store.dict_to_order-1753"><span class="linenos">1753</span></a><span class="sd">                &quot;receiver&quot;: &quot;store1@localhost&quot;,</span>
</span><span id="Store.dict_to_order-1754"><a href="#Store.dict_to_order-1754"><span class="linenos">1754</span></a><span class="sd">                &quot;sender_location&quot;: 10,</span>
</span><span id="Store.dict_to_order-1755"><a href="#Store.dict_to_order-1755"><span class="linenos">1755</span></a><span class="sd">                &quot;receiver_location&quot;: 5</span>
</span><span id="Store.dict_to_order-1756"><a href="#Store.dict_to_order-1756"><span class="linenos">1756</span></a><span class="sd">            }</span>
</span><span id="Store.dict_to_order-1757"><a href="#Store.dict_to_order-1757"><span class="linenos">1757</span></a><span class="sd">            order = store.dict_to_order(data)</span>
</span><span id="Store.dict_to_order-1758"><a href="#Store.dict_to_order-1758"><span class="linenos">1758</span></a><span class="sd">            # order.product == &quot;electronics&quot;, order.quantity == 50, etc.</span>
</span><span id="Store.dict_to_order-1759"><a href="#Store.dict_to_order-1759"><span class="linenos">1759</span></a><span class="sd">            ```</span>
</span><span id="Store.dict_to_order-1760"><a href="#Store.dict_to_order-1760"><span class="linenos">1760</span></a><span class="sd">        </span>
</span><span id="Store.dict_to_order-1761"><a href="#Store.dict_to_order-1761"><span class="linenos">1761</span></a><span class="sd">        Note:</span>
</span><span id="Store.dict_to_order-1762"><a href="#Store.dict_to_order-1762"><span class="linenos">1762</span></a><span class="sd">            Uses dict.get() for optional location fields to handle cases where</span>
</span><span id="Store.dict_to_order-1763"><a href="#Store.dict_to_order-1763"><span class="linenos">1763</span></a><span class="sd">            location information is not provided (returns None by default).</span>
</span><span id="Store.dict_to_order-1764"><a href="#Store.dict_to_order-1764"><span class="linenos">1764</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.dict_to_order-1765"><a href="#Store.dict_to_order-1765"><span class="linenos">1765</span></a>        <span class="n">order</span> <span class="o">=</span>  <span class="n">Order</span><span class="p">(</span>
</span><span id="Store.dict_to_order-1766"><a href="#Store.dict_to_order-1766"><span class="linenos">1766</span></a>            <span class="n">product</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span>
</span><span id="Store.dict_to_order-1767"><a href="#Store.dict_to_order-1767"><span class="linenos">1767</span></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">],</span>
</span><span id="Store.dict_to_order-1768"><a href="#Store.dict_to_order-1768"><span class="linenos">1768</span></a>            <span class="n">orderid</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">],</span>
</span><span id="Store.dict_to_order-1769"><a href="#Store.dict_to_order-1769"><span class="linenos">1769</span></a>            <span class="n">sender</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;sender&quot;</span><span class="p">],</span>
</span><span id="Store.dict_to_order-1770"><a href="#Store.dict_to_order-1770"><span class="linenos">1770</span></a>            <span class="n">receiver</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;receiver&quot;</span><span class="p">]</span>
</span><span id="Store.dict_to_order-1771"><a href="#Store.dict_to_order-1771"><span class="linenos">1771</span></a>        <span class="p">)</span>
</span><span id="Store.dict_to_order-1772"><a href="#Store.dict_to_order-1772"><span class="linenos">1772</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sender_location&quot;</span><span class="p">)</span>
</span><span id="Store.dict_to_order-1773"><a href="#Store.dict_to_order-1773"><span class="linenos">1773</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;receiver_location&quot;</span><span class="p">)</span>
</span><span id="Store.dict_to_order-1774"><a href="#Store.dict_to_order-1774"><span class="linenos">1774</span></a>        <span class="k">return</span> <span class="n">order</span>
</span></pre></div>


            <div class="docstring"><p>Convert a dictionary representation to an Order object.</p>

<p>This helper method deserializes order data from dictionary format into
an Order object instance, setting all required fields and optional location
information if present.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>data (dict):</strong>  Dictionary containing order information with keys:
<ul>
<li>product (str): Product name</li>
<li>quantity (int): Quantity ordered</li>
<li>orderid (int): Unique order identifier</li>
<li>sender (str): Sender's JID</li>
<li>receiver (str): Receiver's JID</li>
<li>sender_location (int, optional): Sender's graph node ID</li>
<li>receiver_location (int, optional): Receiver's graph node ID</li>
</ul></li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Order: Fully populated Order object with all fields from dictionary.</p>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;product&quot;</span><span class="p">:</span> <span class="s2">&quot;electronics&quot;</span><span class="p">,</span>
    <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="s2">&quot;orderid&quot;</span><span class="p">:</span> <span class="mi">1001000000</span><span class="p">,</span>
    <span class="s2">&quot;sender&quot;</span><span class="p">:</span> <span class="s2">&quot;warehouse1@localhost&quot;</span><span class="p">,</span>
    <span class="s2">&quot;receiver&quot;</span><span class="p">:</span> <span class="s2">&quot;store1@localhost&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sender_location&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;receiver_location&quot;</span><span class="p">:</span> <span class="mi">5</span>
<span class="p">}</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">dict_to_order</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="c1"># order.product == &quot;electronics&quot;, order.quantity == 50, etc.</span>
</code></pre>
  </div>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Uses dict.get() for optional location fields to handle cases where
  location information is not provided (returns None by default).</p>
</blockquote>
</div>


                            </div>
                            <div id="Store.message_to_order" class="classattr">
                                        <input id="Store.message_to_order-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">message_to_order</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span></span><span class="return-annotation">) -> <span class="n"><a href="veiculos/veiculos.html#Order">veiculos.veiculos.Order</a></span>:</span></span>

                <label class="view-source-button" for="Store.message_to_order-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.message_to_order"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.message_to_order-1776"><a href="#Store.message_to_order-1776"><span class="linenos">1776</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">message_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
</span><span id="Store.message_to_order-1777"><a href="#Store.message_to_order-1777"><span class="linenos">1777</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.message_to_order-1778"><a href="#Store.message_to_order-1778"><span class="linenos">1778</span></a><span class="sd">        Convert a warehouse-accept message to an Order object.</span>
</span><span id="Store.message_to_order-1779"><a href="#Store.message_to_order-1779"><span class="linenos">1779</span></a><span class="sd">        </span>
</span><span id="Store.message_to_order-1780"><a href="#Store.message_to_order-1780"><span class="linenos">1780</span></a><span class="sd">        This helper method transforms a SPADE message received during the FIPA Contract</span>
</span><span id="Store.message_to_order-1781"><a href="#Store.message_to_order-1781"><span class="linenos">1781</span></a><span class="sd">        Net Protocol into a structured Order object suitable for tracking and processing.</span>
</span><span id="Store.message_to_order-1782"><a href="#Store.message_to_order-1782"><span class="linenos">1782</span></a><span class="sd">        It extracts all relevant information from the message metadata and body.</span>
</span><span id="Store.message_to_order-1783"><a href="#Store.message_to_order-1783"><span class="linenos">1783</span></a><span class="sd">        </span>
</span><span id="Store.message_to_order-1784"><a href="#Store.message_to_order-1784"><span class="linenos">1784</span></a><span class="sd">        The method is used after a warehouse is selected (during SendStoreConfirmation)</span>
</span><span id="Store.message_to_order-1785"><a href="#Store.message_to_order-1785"><span class="linenos">1785</span></a><span class="sd">        to create an Order object for tracking in pending_deliveries.</span>
</span><span id="Store.message_to_order-1786"><a href="#Store.message_to_order-1786"><span class="linenos">1786</span></a><span class="sd">        </span>
</span><span id="Store.message_to_order-1787"><a href="#Store.message_to_order-1787"><span class="linenos">1787</span></a><span class="sd">        Args:</span>
</span><span id="Store.message_to_order-1788"><a href="#Store.message_to_order-1788"><span class="linenos">1788</span></a><span class="sd">            msg (Message): The warehouse-accept message containing order details.</span>
</span><span id="Store.message_to_order-1789"><a href="#Store.message_to_order-1789"><span class="linenos">1789</span></a><span class="sd">                Metadata includes: request_id, node_id (warehouse location)</span>
</span><span id="Store.message_to_order-1790"><a href="#Store.message_to_order-1790"><span class="linenos">1790</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.message_to_order-1791"><a href="#Store.message_to_order-1791"><span class="linenos">1791</span></a><span class="sd">        </span>
</span><span id="Store.message_to_order-1792"><a href="#Store.message_to_order-1792"><span class="linenos">1792</span></a><span class="sd">        Returns:</span>
</span><span id="Store.message_to_order-1793"><a href="#Store.message_to_order-1793"><span class="linenos">1793</span></a><span class="sd">            Order: Fully populated Order object with:</span>
</span><span id="Store.message_to_order-1794"><a href="#Store.message_to_order-1794"><span class="linenos">1794</span></a><span class="sd">                - product: Extracted from message body</span>
</span><span id="Store.message_to_order-1795"><a href="#Store.message_to_order-1795"><span class="linenos">1795</span></a><span class="sd">                - quantity: Extracted from message body</span>
</span><span id="Store.message_to_order-1796"><a href="#Store.message_to_order-1796"><span class="linenos">1796</span></a><span class="sd">                - orderid: From request_id metadata</span>
</span><span id="Store.message_to_order-1797"><a href="#Store.message_to_order-1797"><span class="linenos">1797</span></a><span class="sd">                - sender: Warehouse JID (message sender)</span>
</span><span id="Store.message_to_order-1798"><a href="#Store.message_to_order-1798"><span class="linenos">1798</span></a><span class="sd">                - receiver: Store JID (this store)</span>
</span><span id="Store.message_to_order-1799"><a href="#Store.message_to_order-1799"><span class="linenos">1799</span></a><span class="sd">                - sender_location: Warehouse node ID (from metadata)</span>
</span><span id="Store.message_to_order-1800"><a href="#Store.message_to_order-1800"><span class="linenos">1800</span></a><span class="sd">                - receiver_location: Store node ID (this store&#39;s location)</span>
</span><span id="Store.message_to_order-1801"><a href="#Store.message_to_order-1801"><span class="linenos">1801</span></a><span class="sd">        </span>
</span><span id="Store.message_to_order-1802"><a href="#Store.message_to_order-1802"><span class="linenos">1802</span></a><span class="sd">        Message Parsing:</span>
</span><span id="Store.message_to_order-1803"><a href="#Store.message_to_order-1803"><span class="linenos">1803</span></a><span class="sd">            Body:</span>
</span><span id="Store.message_to_order-1804"><a href="#Store.message_to_order-1804"><span class="linenos">1804</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.message_to_order-1805"><a href="#Store.message_to_order-1805"><span class="linenos">1805</span></a><span class="sd">                - Split on space: parts[0] = quantity, parts[1] = product</span>
</span><span id="Store.message_to_order-1806"><a href="#Store.message_to_order-1806"><span class="linenos">1806</span></a><span class="sd">                - Example: &quot;50 electronics&quot; -&gt; quantity=50, product=&quot;electronics&quot;</span>
</span><span id="Store.message_to_order-1807"><a href="#Store.message_to_order-1807"><span class="linenos">1807</span></a><span class="sd">            </span>
</span><span id="Store.message_to_order-1808"><a href="#Store.message_to_order-1808"><span class="linenos">1808</span></a><span class="sd">            Metadata:</span>
</span><span id="Store.message_to_order-1809"><a href="#Store.message_to_order-1809"><span class="linenos">1809</span></a><span class="sd">                - request_id: Used as orderid for correlation</span>
</span><span id="Store.message_to_order-1810"><a href="#Store.message_to_order-1810"><span class="linenos">1810</span></a><span class="sd">                - node_id: Warehouse&#39;s graph location</span>
</span><span id="Store.message_to_order-1811"><a href="#Store.message_to_order-1811"><span class="linenos">1811</span></a><span class="sd">                - sender: Warehouse&#39;s JID</span>
</span><span id="Store.message_to_order-1812"><a href="#Store.message_to_order-1812"><span class="linenos">1812</span></a><span class="sd">        </span>
</span><span id="Store.message_to_order-1813"><a href="#Store.message_to_order-1813"><span class="linenos">1813</span></a><span class="sd">        Location Assignment:</span>
</span><span id="Store.message_to_order-1814"><a href="#Store.message_to_order-1814"><span class="linenos">1814</span></a><span class="sd">            - sender_location: Warehouse node (from message node_id)</span>
</span><span id="Store.message_to_order-1815"><a href="#Store.message_to_order-1815"><span class="linenos">1815</span></a><span class="sd">            - receiver_location: Store node (this store&#39;s node_id)</span>
</span><span id="Store.message_to_order-1816"><a href="#Store.message_to_order-1816"><span class="linenos">1816</span></a><span class="sd">            - Note: Reversed compared to dict_to_order perspective</span>
</span><span id="Store.message_to_order-1817"><a href="#Store.message_to_order-1817"><span class="linenos">1817</span></a><span class="sd">        </span>
</span><span id="Store.message_to_order-1818"><a href="#Store.message_to_order-1818"><span class="linenos">1818</span></a><span class="sd">        Example:</span>
</span><span id="Store.message_to_order-1819"><a href="#Store.message_to_order-1819"><span class="linenos">1819</span></a><span class="sd">            ```python</span>
</span><span id="Store.message_to_order-1820"><a href="#Store.message_to_order-1820"><span class="linenos">1820</span></a><span class="sd">            # Warehouse-accept message</span>
</span><span id="Store.message_to_order-1821"><a href="#Store.message_to_order-1821"><span class="linenos">1821</span></a><span class="sd">            msg.body = &quot;50 electronics&quot;</span>
</span><span id="Store.message_to_order-1822"><a href="#Store.message_to_order-1822"><span class="linenos">1822</span></a><span class="sd">            msg.sender = &quot;warehouse2@localhost&quot;</span>
</span><span id="Store.message_to_order-1823"><a href="#Store.message_to_order-1823"><span class="linenos">1823</span></a><span class="sd">            msg.metadata[&quot;request_id&quot;] = &quot;1001000000&quot;</span>
</span><span id="Store.message_to_order-1824"><a href="#Store.message_to_order-1824"><span class="linenos">1824</span></a><span class="sd">            msg.metadata[&quot;node_id&quot;] = &quot;10&quot;</span>
</span><span id="Store.message_to_order-1825"><a href="#Store.message_to_order-1825"><span class="linenos">1825</span></a><span class="sd">            </span>
</span><span id="Store.message_to_order-1826"><a href="#Store.message_to_order-1826"><span class="linenos">1826</span></a><span class="sd">            order = store.message_to_order(msg)</span>
</span><span id="Store.message_to_order-1827"><a href="#Store.message_to_order-1827"><span class="linenos">1827</span></a><span class="sd">            # order.product = &quot;electronics&quot;</span>
</span><span id="Store.message_to_order-1828"><a href="#Store.message_to_order-1828"><span class="linenos">1828</span></a><span class="sd">            # order.quantity = 50</span>
</span><span id="Store.message_to_order-1829"><a href="#Store.message_to_order-1829"><span class="linenos">1829</span></a><span class="sd">            # order.orderid = 1001000000</span>
</span><span id="Store.message_to_order-1830"><a href="#Store.message_to_order-1830"><span class="linenos">1830</span></a><span class="sd">            # order.sender = &quot;warehouse2@localhost&quot;</span>
</span><span id="Store.message_to_order-1831"><a href="#Store.message_to_order-1831"><span class="linenos">1831</span></a><span class="sd">            # order.receiver = &quot;store1@localhost&quot;</span>
</span><span id="Store.message_to_order-1832"><a href="#Store.message_to_order-1832"><span class="linenos">1832</span></a><span class="sd">            # order.sender_location = 10 (warehouse)</span>
</span><span id="Store.message_to_order-1833"><a href="#Store.message_to_order-1833"><span class="linenos">1833</span></a><span class="sd">            # order.receiver_location = 5 (store)</span>
</span><span id="Store.message_to_order-1834"><a href="#Store.message_to_order-1834"><span class="linenos">1834</span></a><span class="sd">            ```</span>
</span><span id="Store.message_to_order-1835"><a href="#Store.message_to_order-1835"><span class="linenos">1835</span></a><span class="sd">        </span>
</span><span id="Store.message_to_order-1836"><a href="#Store.message_to_order-1836"><span class="linenos">1836</span></a><span class="sd">        Note:</span>
</span><span id="Store.message_to_order-1837"><a href="#Store.message_to_order-1837"><span class="linenos">1837</span></a><span class="sd">            The Order object is used for:</span>
</span><span id="Store.message_to_order-1838"><a href="#Store.message_to_order-1838"><span class="linenos">1838</span></a><span class="sd">            - Tracking in pending_deliveries dict (awaiting vehicle delivery)</span>
</span><span id="Store.message_to_order-1839"><a href="#Store.message_to_order-1839"><span class="linenos">1839</span></a><span class="sd">            - Recording timing information for statistics</span>
</span><span id="Store.message_to_order-1840"><a href="#Store.message_to_order-1840"><span class="linenos">1840</span></a><span class="sd">            - Providing vehicle with delivery instructions</span>
</span><span id="Store.message_to_order-1841"><a href="#Store.message_to_order-1841"><span class="linenos">1841</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.message_to_order-1842"><a href="#Store.message_to_order-1842"><span class="linenos">1842</span></a>        <span class="n">body</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="Store.message_to_order-1843"><a href="#Store.message_to_order-1843"><span class="linenos">1843</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store.message_to_order-1844"><a href="#Store.message_to_order-1844"><span class="linenos">1844</span></a>        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store.message_to_order-1845"><a href="#Store.message_to_order-1845"><span class="linenos">1845</span></a>        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store.message_to_order-1846"><a href="#Store.message_to_order-1846"><span class="linenos">1846</span></a>        
</span><span id="Store.message_to_order-1847"><a href="#Store.message_to_order-1847"><span class="linenos">1847</span></a>        <span class="n">order_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Store.message_to_order-1848"><a href="#Store.message_to_order-1848"><span class="linenos">1848</span></a>        <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>  <span class="c1"># Store JID</span>
</span><span id="Store.message_to_order-1849"><a href="#Store.message_to_order-1849"><span class="linenos">1849</span></a>        <span class="n">receiver</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">)</span>  <span class="c1"># Warehouse JID</span>
</span><span id="Store.message_to_order-1850"><a href="#Store.message_to_order-1850"><span class="linenos">1850</span></a>        <span class="n">store_location</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">))</span>
</span><span id="Store.message_to_order-1851"><a href="#Store.message_to_order-1851"><span class="linenos">1851</span></a>        <span class="n">warehouse_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span>
</span><span id="Store.message_to_order-1852"><a href="#Store.message_to_order-1852"><span class="linenos">1852</span></a>        
</span><span id="Store.message_to_order-1853"><a href="#Store.message_to_order-1853"><span class="linenos">1853</span></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
</span><span id="Store.message_to_order-1854"><a href="#Store.message_to_order-1854"><span class="linenos">1854</span></a>            <span class="n">product</span><span class="o">=</span><span class="n">product</span><span class="p">,</span>
</span><span id="Store.message_to_order-1855"><a href="#Store.message_to_order-1855"><span class="linenos">1855</span></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="Store.message_to_order-1856"><a href="#Store.message_to_order-1856"><span class="linenos">1856</span></a>            <span class="n">orderid</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
</span><span id="Store.message_to_order-1857"><a href="#Store.message_to_order-1857"><span class="linenos">1857</span></a>            <span class="n">sender</span><span class="o">=</span><span class="n">sender</span><span class="p">,</span>
</span><span id="Store.message_to_order-1858"><a href="#Store.message_to_order-1858"><span class="linenos">1858</span></a>            <span class="n">receiver</span><span class="o">=</span><span class="n">receiver</span>
</span><span id="Store.message_to_order-1859"><a href="#Store.message_to_order-1859"><span class="linenos">1859</span></a>        <span class="p">)</span>
</span><span id="Store.message_to_order-1860"><a href="#Store.message_to_order-1860"><span class="linenos">1860</span></a>        
</span><span id="Store.message_to_order-1861"><a href="#Store.message_to_order-1861"><span class="linenos">1861</span></a>        <span class="c1"># Set locations</span>
</span><span id="Store.message_to_order-1862"><a href="#Store.message_to_order-1862"><span class="linenos">1862</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span> <span class="o">=</span> <span class="n">store_location</span>  <span class="c1"># Store location</span>
</span><span id="Store.message_to_order-1863"><a href="#Store.message_to_order-1863"><span class="linenos">1863</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span> <span class="o">=</span> <span class="n">warehouse_location</span>  <span class="c1"># Warehouse location</span>
</span><span id="Store.message_to_order-1864"><a href="#Store.message_to_order-1864"><span class="linenos">1864</span></a>        
</span><span id="Store.message_to_order-1865"><a href="#Store.message_to_order-1865"><span class="linenos">1865</span></a>        <span class="k">return</span> <span class="n">order</span>
</span></pre></div>


            <div class="docstring"><p>Convert a warehouse-accept message to an Order object.</p>

<p>This helper method transforms a SPADE message received during the FIPA Contract
Net Protocol into a structured Order object suitable for tracking and processing.
It extracts all relevant information from the message metadata and body.</p>

<p>The method is used after a warehouse is selected (during SendStoreConfirmation)
to create an Order object for tracking in pending_deliveries.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>msg (Message):</strong>  The warehouse-accept message containing order details.
Metadata includes: request_id, node_id (warehouse location)
Body format: "{quantity} {product}"</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Order: Fully populated Order object with:
      - product: Extracted from message body
      - quantity: Extracted from message body
      - orderid: From request_id metadata
      - sender: Warehouse JID (message sender)
      - receiver: Store JID (this store)
      - sender_location: Warehouse node ID (from metadata)
      - receiver_location: Store node ID (this store's location)</p>
</blockquote>

<h6 id="message-parsing">Message Parsing:</h6>

<blockquote>
  <p>Body:
      - Format: "{quantity} {product}"
      - Split on space: parts[0] = quantity, parts[1] = product
      - Example: "50 electronics" -> quantity=50, product="electronics"</p>
  
  <p>Metadata:
      - request_id: Used as orderid for correlation
      - node_id: Warehouse's graph location
      - sender: Warehouse's JID</p>
</blockquote>

<h6 id="location-assignment">Location Assignment:</h6>

<blockquote>
  <ul>
  <li>sender_location: Warehouse node (from message node_id)</li>
  <li>receiver_location: Store node (this store's node_id)</li>
  <li>Note: Reversed compared to dict_to_order perspective</li>
  </ul>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># Warehouse-accept message</span>
<span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;50 electronics&quot;</span>
<span class="n">msg</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="s2">&quot;warehouse2@localhost&quot;</span>
<span class="n">msg</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;request_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1001000000&quot;</span>
<span class="n">msg</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;node_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;10&quot;</span>

<span class="n">order</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">message_to_order</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="c1"># order.product = &quot;electronics&quot;</span>
<span class="c1"># order.quantity = 50</span>
<span class="c1"># order.orderid = 1001000000</span>
<span class="c1"># order.sender = &quot;warehouse2@localhost&quot;</span>
<span class="c1"># order.receiver = &quot;store1@localhost&quot;</span>
<span class="c1"># order.sender_location = 10 (warehouse)</span>
<span class="c1"># order.receiver_location = 5 (store)</span>
</code></pre>
  </div>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>The Order object is used for:</p>
  
  <ul>
  <li>Tracking in pending_deliveries dict (awaiting vehicle delivery)</li>
  <li>Recording timing information for statistics</li>
  <li>Providing vehicle with delivery instructions</li>
  </ul>
</blockquote>
</div>


                            </div>
                            <div id="Store.set_buy_metadata" class="classattr">
                                        <input id="Store.set_buy_metadata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_buy_metadata</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Store.set_buy_metadata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.set_buy_metadata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.set_buy_metadata-1867"><a href="#Store.set_buy_metadata-1867"><span class="linenos">1867</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_buy_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store.set_buy_metadata-1868"><a href="#Store.set_buy_metadata-1868"><span class="linenos">1868</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.set_buy_metadata-1869"><a href="#Store.set_buy_metadata-1869"><span class="linenos">1869</span></a><span class="sd">        Set standard metadata for purchase request messages (FIPA CFP).</span>
</span><span id="Store.set_buy_metadata-1870"><a href="#Store.set_buy_metadata-1870"><span class="linenos">1870</span></a><span class="sd">        </span>
</span><span id="Store.set_buy_metadata-1871"><a href="#Store.set_buy_metadata-1871"><span class="linenos">1871</span></a><span class="sd">        This helper method populates common metadata fields for store-buy messages,</span>
</span><span id="Store.set_buy_metadata-1872"><a href="#Store.set_buy_metadata-1872"><span class="linenos">1872</span></a><span class="sd">        ensuring consistency across all purchase requests. It sets the performative</span>
</span><span id="Store.set_buy_metadata-1873"><a href="#Store.set_buy_metadata-1873"><span class="linenos">1873</span></a><span class="sd">        and store identifier, with the caller responsible for setting the request_id.</span>
</span><span id="Store.set_buy_metadata-1874"><a href="#Store.set_buy_metadata-1874"><span class="linenos">1874</span></a><span class="sd">        </span>
</span><span id="Store.set_buy_metadata-1875"><a href="#Store.set_buy_metadata-1875"><span class="linenos">1875</span></a><span class="sd">        FIPA Protocol:</span>
</span><span id="Store.set_buy_metadata-1876"><a href="#Store.set_buy_metadata-1876"><span class="linenos">1876</span></a><span class="sd">            This prepares the message for the Call for Proposals (CFP) phase of the</span>
</span><span id="Store.set_buy_metadata-1877"><a href="#Store.set_buy_metadata-1877"><span class="linenos">1877</span></a><span class="sd">            FIPA Contract Net Protocol.</span>
</span><span id="Store.set_buy_metadata-1878"><a href="#Store.set_buy_metadata-1878"><span class="linenos">1878</span></a><span class="sd">        </span>
</span><span id="Store.set_buy_metadata-1879"><a href="#Store.set_buy_metadata-1879"><span class="linenos">1879</span></a><span class="sd">        Args:</span>
</span><span id="Store.set_buy_metadata-1880"><a href="#Store.set_buy_metadata-1880"><span class="linenos">1880</span></a><span class="sd">            msg (Message): The message to populate with metadata. Modified in-place.</span>
</span><span id="Store.set_buy_metadata-1881"><a href="#Store.set_buy_metadata-1881"><span class="linenos">1881</span></a><span class="sd">        </span>
</span><span id="Store.set_buy_metadata-1882"><a href="#Store.set_buy_metadata-1882"><span class="linenos">1882</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store.set_buy_metadata-1883"><a href="#Store.set_buy_metadata-1883"><span class="linenos">1883</span></a><span class="sd">            Modifies msg metadata:</span>
</span><span id="Store.set_buy_metadata-1884"><a href="#Store.set_buy_metadata-1884"><span class="linenos">1884</span></a><span class="sd">                - performative: Set to &quot;store-buy&quot; (FIPA CFP)</span>
</span><span id="Store.set_buy_metadata-1885"><a href="#Store.set_buy_metadata-1885"><span class="linenos">1885</span></a><span class="sd">                - store_id: Set to this store&#39;s JID</span>
</span><span id="Store.set_buy_metadata-1886"><a href="#Store.set_buy_metadata-1886"><span class="linenos">1886</span></a><span class="sd">        </span>
</span><span id="Store.set_buy_metadata-1887"><a href="#Store.set_buy_metadata-1887"><span class="linenos">1887</span></a><span class="sd">        Note:</span>
</span><span id="Store.set_buy_metadata-1888"><a href="#Store.set_buy_metadata-1888"><span class="linenos">1888</span></a><span class="sd">            The request_id must be set separately by the caller to ensure unique</span>
</span><span id="Store.set_buy_metadata-1889"><a href="#Store.set_buy_metadata-1889"><span class="linenos">1889</span></a><span class="sd">            identification for each purchase request. This separation allows for</span>
</span><span id="Store.set_buy_metadata-1890"><a href="#Store.set_buy_metadata-1890"><span class="linenos">1890</span></a><span class="sd">            proper ID encoding and avoids duplication.</span>
</span><span id="Store.set_buy_metadata-1891"><a href="#Store.set_buy_metadata-1891"><span class="linenos">1891</span></a><span class="sd">        </span>
</span><span id="Store.set_buy_metadata-1892"><a href="#Store.set_buy_metadata-1892"><span class="linenos">1892</span></a><span class="sd">        Example:</span>
</span><span id="Store.set_buy_metadata-1893"><a href="#Store.set_buy_metadata-1893"><span class="linenos">1893</span></a><span class="sd">            ```python</span>
</span><span id="Store.set_buy_metadata-1894"><a href="#Store.set_buy_metadata-1894"><span class="linenos">1894</span></a><span class="sd">            msg = Message(to=&quot;warehouse1@localhost&quot;)</span>
</span><span id="Store.set_buy_metadata-1895"><a href="#Store.set_buy_metadata-1895"><span class="linenos">1895</span></a><span class="sd">            store.set_buy_metadata(msg)</span>
</span><span id="Store.set_buy_metadata-1896"><a href="#Store.set_buy_metadata-1896"><span class="linenos">1896</span></a><span class="sd">            msg.set_metadata(&quot;request_id&quot;, &quot;1001000000&quot;)  # Caller sets this</span>
</span><span id="Store.set_buy_metadata-1897"><a href="#Store.set_buy_metadata-1897"><span class="linenos">1897</span></a><span class="sd">            msg.body = &quot;50 electronics&quot;</span>
</span><span id="Store.set_buy_metadata-1898"><a href="#Store.set_buy_metadata-1898"><span class="linenos">1898</span></a><span class="sd">            # Message ready to send as FIPA CFP</span>
</span><span id="Store.set_buy_metadata-1899"><a href="#Store.set_buy_metadata-1899"><span class="linenos">1899</span></a><span class="sd">            ```</span>
</span><span id="Store.set_buy_metadata-1900"><a href="#Store.set_buy_metadata-1900"><span class="linenos">1900</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.set_buy_metadata-1901"><a href="#Store.set_buy_metadata-1901"><span class="linenos">1901</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-buy&quot;</span><span class="p">)</span>
</span><span id="Store.set_buy_metadata-1902"><a href="#Store.set_buy_metadata-1902"><span class="linenos">1902</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store.set_buy_metadata-1903"><a href="#Store.set_buy_metadata-1903"><span class="linenos">1903</span></a>        <span class="c1"># NOTE: request_id should be set separately by the caller</span>
</span></pre></div>


            <div class="docstring"><p>Set standard metadata for purchase request messages (FIPA CFP).</p>

<p>This helper method populates common metadata fields for store-buy messages,
ensuring consistency across all purchase requests. It sets the performative
and store identifier, with the caller responsible for setting the request_id.</p>

<h6 id="fipa-protocol">FIPA Protocol:</h6>

<blockquote>
  <p>This prepares the message for the Call for Proposals (CFP) phase of the
  FIPA Contract Net Protocol.</p>
</blockquote>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>msg (Message):</strong>  The message to populate with metadata. Modified in-place.</li>
</ul>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <p>Modifies msg metadata:
      - performative: Set to "store-buy" (FIPA CFP)
      - store_id: Set to this store's JID</p>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>The request_id must be set separately by the caller to ensure unique
  identification for each purchase request. This separation allows for
  proper ID encoding and avoids duplication.</p>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="s2">&quot;warehouse1@localhost&quot;</span><span class="p">)</span>
<span class="n">store</span><span class="o">.</span><span class="n">set_buy_metadata</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="s2">&quot;1001000000&quot;</span><span class="p">)</span>  <span class="c1"># Caller sets this</span>
<span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;50 electronics&quot;</span>
<span class="c1"># Message ready to send as FIPA CFP</span>
</code></pre>
  </div>
</blockquote>
</div>


                            </div>
                            <div id="Store.update_graph" class="classattr">
                                        <input id="Store.update_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_graph</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">traffic_data</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Store.update_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.update_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.update_graph-1905"><a href="#Store.update_graph-1905"><span class="linenos">1905</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traffic_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store.update_graph-1906"><a href="#Store.update_graph-1906"><span class="linenos">1906</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.update_graph-1907"><a href="#Store.update_graph-1907"><span class="linenos">1907</span></a><span class="sd">        Apply dynamic traffic updates to the world graph.</span>
</span><span id="Store.update_graph-1908"><a href="#Store.update_graph-1908"><span class="linenos">1908</span></a><span class="sd">        </span>
</span><span id="Store.update_graph-1909"><a href="#Store.update_graph-1909"><span class="linenos">1909</span></a><span class="sd">        This method processes transit messages from the world agent, updating edge</span>
</span><span id="Store.update_graph-1910"><a href="#Store.update_graph-1910"><span class="linenos">1910</span></a><span class="sd">        weights in the graph to reflect current traffic conditions. These updates</span>
</span><span id="Store.update_graph-1911"><a href="#Store.update_graph-1911"><span class="linenos">1911</span></a><span class="sd">        affect pathfinding calculations used in warehouse selection, making the</span>
</span><span id="Store.update_graph-1912"><a href="#Store.update_graph-1912"><span class="linenos">1912</span></a><span class="sd">        system responsive to real-time network conditions.</span>
</span><span id="Store.update_graph-1913"><a href="#Store.update_graph-1913"><span class="linenos">1913</span></a><span class="sd">        </span>
</span><span id="Store.update_graph-1914"><a href="#Store.update_graph-1914"><span class="linenos">1914</span></a><span class="sd">        Traffic Data Format:</span>
</span><span id="Store.update_graph-1915"><a href="#Store.update_graph-1915"><span class="linenos">1915</span></a><span class="sd">            ```json</span>
</span><span id="Store.update_graph-1916"><a href="#Store.update_graph-1916"><span class="linenos">1916</span></a><span class="sd">            {</span>
</span><span id="Store.update_graph-1917"><a href="#Store.update_graph-1917"><span class="linenos">1917</span></a><span class="sd">                &quot;edges&quot;: [</span>
</span><span id="Store.update_graph-1918"><a href="#Store.update_graph-1918"><span class="linenos">1918</span></a><span class="sd">                    {</span>
</span><span id="Store.update_graph-1919"><a href="#Store.update_graph-1919"><span class="linenos">1919</span></a><span class="sd">                        &quot;node1&quot;: 5,</span>
</span><span id="Store.update_graph-1920"><a href="#Store.update_graph-1920"><span class="linenos">1920</span></a><span class="sd">                        &quot;node2&quot;: 10,</span>
</span><span id="Store.update_graph-1921"><a href="#Store.update_graph-1921"><span class="linenos">1921</span></a><span class="sd">                        &quot;weight&quot;: 200,</span>
</span><span id="Store.update_graph-1922"><a href="#Store.update_graph-1922"><span class="linenos">1922</span></a><span class="sd">                        &quot;fuel_consumption&quot;: 15.0</span>
</span><span id="Store.update_graph-1923"><a href="#Store.update_graph-1923"><span class="linenos">1923</span></a><span class="sd">                    },</span>
</span><span id="Store.update_graph-1924"><a href="#Store.update_graph-1924"><span class="linenos">1924</span></a><span class="sd">                    ...</span>
</span><span id="Store.update_graph-1925"><a href="#Store.update_graph-1925"><span class="linenos">1925</span></a><span class="sd">                ]</span>
</span><span id="Store.update_graph-1926"><a href="#Store.update_graph-1926"><span class="linenos">1926</span></a><span class="sd">            }</span>
</span><span id="Store.update_graph-1927"><a href="#Store.update_graph-1927"><span class="linenos">1927</span></a><span class="sd">            ```</span>
</span><span id="Store.update_graph-1928"><a href="#Store.update_graph-1928"><span class="linenos">1928</span></a><span class="sd">        </span>
</span><span id="Store.update_graph-1929"><a href="#Store.update_graph-1929"><span class="linenos">1929</span></a><span class="sd">        Args:</span>
</span><span id="Store.update_graph-1930"><a href="#Store.update_graph-1930"><span class="linenos">1930</span></a><span class="sd">            traffic_data (dict): Dictionary containing edge updates with key &quot;edges&quot;</span>
</span><span id="Store.update_graph-1931"><a href="#Store.update_graph-1931"><span class="linenos">1931</span></a><span class="sd">                mapping to a list of edge information dictionaries.</span>
</span><span id="Store.update_graph-1932"><a href="#Store.update_graph-1932"><span class="linenos">1932</span></a><span class="sd">        </span>
</span><span id="Store.update_graph-1933"><a href="#Store.update_graph-1933"><span class="linenos">1933</span></a><span class="sd">        Edge Processing:</span>
</span><span id="Store.update_graph-1934"><a href="#Store.update_graph-1934"><span class="linenos">1934</span></a><span class="sd">            For each edge in traffic_data[&quot;edges&quot;]:</span>
</span><span id="Store.update_graph-1935"><a href="#Store.update_graph-1935"><span class="linenos">1935</span></a><span class="sd">                - Extract: node1, node2, new_weight</span>
</span><span id="Store.update_graph-1936"><a href="#Store.update_graph-1936"><span class="linenos">1936</span></a><span class="sd">                - Lookup: Find edge in graph using get_edge(node1, node2)</span>
</span><span id="Store.update_graph-1937"><a href="#Store.update_graph-1937"><span class="linenos">1937</span></a><span class="sd">                - Update: Set edge.weight = new_weight if edge exists</span>
</span><span id="Store.update_graph-1938"><a href="#Store.update_graph-1938"><span class="linenos">1938</span></a><span class="sd">                - Skip: If edge not found (graceful handling)</span>
</span><span id="Store.update_graph-1939"><a href="#Store.update_graph-1939"><span class="linenos">1939</span></a><span class="sd">        </span>
</span><span id="Store.update_graph-1940"><a href="#Store.update_graph-1940"><span class="linenos">1940</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store.update_graph-1941"><a href="#Store.update_graph-1941"><span class="linenos">1941</span></a><span class="sd">            - Modifies edge weights in self.map (world graph)</span>
</span><span id="Store.update_graph-1942"><a href="#Store.update_graph-1942"><span class="linenos">1942</span></a><span class="sd">            - Affects future Dijkstra calculations</span>
</span><span id="Store.update_graph-1943"><a href="#Store.update_graph-1943"><span class="linenos">1943</span></a><span class="sd">            - Changes warehouse scoring results</span>
</span><span id="Store.update_graph-1944"><a href="#Store.update_graph-1944"><span class="linenos">1944</span></a><span class="sd">            - Does NOT modify fuel_consumption (current implementation)</span>
</span><span id="Store.update_graph-1945"><a href="#Store.update_graph-1945"><span class="linenos">1945</span></a><span class="sd">        </span>
</span><span id="Store.update_graph-1946"><a href="#Store.update_graph-1946"><span class="linenos">1946</span></a><span class="sd">        Example:</span>
</span><span id="Store.update_graph-1947"><a href="#Store.update_graph-1947"><span class="linenos">1947</span></a><span class="sd">            ```python</span>
</span><span id="Store.update_graph-1948"><a href="#Store.update_graph-1948"><span class="linenos">1948</span></a><span class="sd">            traffic_data = {</span>
</span><span id="Store.update_graph-1949"><a href="#Store.update_graph-1949"><span class="linenos">1949</span></a><span class="sd">                &quot;edges&quot;: [</span>
</span><span id="Store.update_graph-1950"><a href="#Store.update_graph-1950"><span class="linenos">1950</span></a><span class="sd">                    {&quot;node1&quot;: 5, &quot;node2&quot;: 10, &quot;weight&quot;: 200, &quot;fuel_consumption&quot;: 15.0},</span>
</span><span id="Store.update_graph-1951"><a href="#Store.update_graph-1951"><span class="linenos">1951</span></a><span class="sd">                    {&quot;node1&quot;: 10, &quot;node2&quot;: 15, &quot;weight&quot;: 150, &quot;fuel_consumption&quot;: 12.0}</span>
</span><span id="Store.update_graph-1952"><a href="#Store.update_graph-1952"><span class="linenos">1952</span></a><span class="sd">                ]</span>
</span><span id="Store.update_graph-1953"><a href="#Store.update_graph-1953"><span class="linenos">1953</span></a><span class="sd">            }</span>
</span><span id="Store.update_graph-1954"><a href="#Store.update_graph-1954"><span class="linenos">1954</span></a><span class="sd">            store.update_graph(traffic_data)</span>
</span><span id="Store.update_graph-1955"><a href="#Store.update_graph-1955"><span class="linenos">1955</span></a><span class="sd">            # Edge (5, 10) weight updated to 200</span>
</span><span id="Store.update_graph-1956"><a href="#Store.update_graph-1956"><span class="linenos">1956</span></a><span class="sd">            # Edge (10, 15) weight updated to 150</span>
</span><span id="Store.update_graph-1957"><a href="#Store.update_graph-1957"><span class="linenos">1957</span></a><span class="sd">            # Future pathfinding uses new weights</span>
</span><span id="Store.update_graph-1958"><a href="#Store.update_graph-1958"><span class="linenos">1958</span></a><span class="sd">            ```</span>
</span><span id="Store.update_graph-1959"><a href="#Store.update_graph-1959"><span class="linenos">1959</span></a><span class="sd">        </span>
</span><span id="Store.update_graph-1960"><a href="#Store.update_graph-1960"><span class="linenos">1960</span></a><span class="sd">        Note:</span>
</span><span id="Store.update_graph-1961"><a href="#Store.update_graph-1961"><span class="linenos">1961</span></a><span class="sd">            Currently only updates weight, not fuel_consumption. Future enhancement</span>
</span><span id="Store.update_graph-1962"><a href="#Store.update_graph-1962"><span class="linenos">1962</span></a><span class="sd">            could update fuel_consumption as well for more realistic simulation:</span>
</span><span id="Store.update_graph-1963"><a href="#Store.update_graph-1963"><span class="linenos">1963</span></a><span class="sd">            ```python</span>
</span><span id="Store.update_graph-1964"><a href="#Store.update_graph-1964"><span class="linenos">1964</span></a><span class="sd">            if edge:</span>
</span><span id="Store.update_graph-1965"><a href="#Store.update_graph-1965"><span class="linenos">1965</span></a><span class="sd">                edge.weight = new_weight</span>
</span><span id="Store.update_graph-1966"><a href="#Store.update_graph-1966"><span class="linenos">1966</span></a><span class="sd">                edge.fuel_consumption = new_fuel  # Not currently implemented</span>
</span><span id="Store.update_graph-1967"><a href="#Store.update_graph-1967"><span class="linenos">1967</span></a><span class="sd">            ```</span>
</span><span id="Store.update_graph-1968"><a href="#Store.update_graph-1968"><span class="linenos">1968</span></a><span class="sd">        </span>
</span><span id="Store.update_graph-1969"><a href="#Store.update_graph-1969"><span class="linenos">1969</span></a><span class="sd">        Impact on System:</span>
</span><span id="Store.update_graph-1970"><a href="#Store.update_graph-1970"><span class="linenos">1970</span></a><span class="sd">            - Dynamic responsiveness to traffic conditions</span>
</span><span id="Store.update_graph-1971"><a href="#Store.update_graph-1971"><span class="linenos">1971</span></a><span class="sd">            - Warehouses with congested routes become less attractive</span>
</span><span id="Store.update_graph-1972"><a href="#Store.update_graph-1972"><span class="linenos">1972</span></a><span class="sd">            - Enables simulation of rush hours, accidents, road closures</span>
</span><span id="Store.update_graph-1973"><a href="#Store.update_graph-1973"><span class="linenos">1973</span></a><span class="sd">            - Realistic supply chain behavior under varying conditions</span>
</span><span id="Store.update_graph-1974"><a href="#Store.update_graph-1974"><span class="linenos">1974</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.update_graph-1975"><a href="#Store.update_graph-1975"><span class="linenos">1975</span></a>        <span class="k">for</span> <span class="n">edge_info</span> <span class="ow">in</span> <span class="n">traffic_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Store.update_graph-1976"><a href="#Store.update_graph-1976"><span class="linenos">1976</span></a>                <span class="n">node1_id</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node1&quot;</span><span class="p">)</span>
</span><span id="Store.update_graph-1977"><a href="#Store.update_graph-1977"><span class="linenos">1977</span></a>                <span class="n">node2_id</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node2&quot;</span><span class="p">)</span>
</span><span id="Store.update_graph-1978"><a href="#Store.update_graph-1978"><span class="linenos">1978</span></a>                <span class="n">new_weight</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
</span><span id="Store.update_graph-1979"><a href="#Store.update_graph-1979"><span class="linenos">1979</span></a>                
</span><span id="Store.update_graph-1980"><a href="#Store.update_graph-1980"><span class="linenos">1980</span></a>                <span class="n">edge</span> <span class="p">:</span> <span class="n">Edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">node1_id</span><span class="p">,</span> <span class="n">node2_id</span><span class="p">)</span>
</span><span id="Store.update_graph-1981"><a href="#Store.update_graph-1981"><span class="linenos">1981</span></a>                <span class="k">if</span> <span class="n">edge</span><span class="p">:</span>
</span><span id="Store.update_graph-1982"><a href="#Store.update_graph-1982"><span class="linenos">1982</span></a>                    <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">new_weight</span>
</span></pre></div>


            <div class="docstring"><p>Apply dynamic traffic updates to the world graph.</p>

<p>This method processes transit messages from the world agent, updating edge
weights in the graph to reflect current traffic conditions. These updates
affect pathfinding calculations used in warehouse selection, making the
system responsive to real-time network conditions.</p>

<h6 id="traffic-data-format">Traffic Data Format:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;edges&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;node1&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;node2&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;weight&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;fuel_consumption&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">15.0</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="err">...</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre>
  </div>
</blockquote>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>traffic_data (dict):</strong>  Dictionary containing edge updates with key "edges"
mapping to a list of edge information dictionaries.</li>
</ul>

<h6 id="edge-processing">Edge Processing:</h6>

<blockquote>
  <p>For each edge in traffic_data["edges"]:
      - Extract: node1, node2, new_weight
      - Lookup: Find edge in graph using get_edge(node1, node2)
      - Update: Set edge.weight = new_weight if edge exists
      - Skip: If edge not found (graceful handling)</p>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Modifies edge weights in self.map (world graph)</li>
  <li>Affects future Dijkstra calculations</li>
  <li>Changes warehouse scoring results</li>
  <li>Does NOT modify fuel_consumption (current implementation)</li>
  </ul>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">traffic_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;node1&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;node2&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;fuel_consumption&quot;</span><span class="p">:</span> <span class="mf">15.0</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;node1&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;node2&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="s2">&quot;fuel_consumption&quot;</span><span class="p">:</span> <span class="mf">12.0</span><span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="n">store</span><span class="o">.</span><span class="n">update_graph</span><span class="p">(</span><span class="n">traffic_data</span><span class="p">)</span>
<span class="c1"># Edge (5, 10) weight updated to 200</span>
<span class="c1"># Edge (10, 15) weight updated to 150</span>
<span class="c1"># Future pathfinding uses new weights</span>
</code></pre>
  </div>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Currently only updates weight, not fuel_consumption. Future enhancement
  could update fuel_consumption as well for more realistic simulation:</p>
  
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="k">if</span> <span class="n">edge</span><span class="p">:</span>
    <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">new_weight</span>
    <span class="n">edge</span><span class="o">.</span><span class="n">fuel_consumption</span> <span class="o">=</span> <span class="n">new_fuel</span>  <span class="c1"># Not currently implemented</span>
</code></pre>
  </div>
</blockquote>

<h6 id="impact-on-system">Impact on System:</h6>

<blockquote>
  <ul>
  <li>Dynamic responsiveness to traffic conditions</li>
  <li>Warehouses with congested routes become less attractive</li>
  <li>Enables simulation of rush hours, accidents, road closures</li>
  <li>Realistic supply chain behavior under varying conditions</li>
  </ul>
</blockquote>
</div>


                            </div>
                            <div id="Store.get_stats" class="classattr">
                                        <input id="Store.get_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">order</span><span class="p">:</span> <span class="n"><a href="veiculos/veiculos.html#Order">veiculos.veiculos.Order</a></span>, </span><span class="param"><span class="n">eta</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">vehicle</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Store.get_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.get_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.get_stats-1984"><a href="#Store.get_stats-1984"><span class="linenos">1984</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span> <span class="p">:</span> <span class="n">Order</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store.get_stats-1985"><a href="#Store.get_stats-1985"><span class="linenos">1985</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.get_stats-1986"><a href="#Store.get_stats-1986"><span class="linenos">1986</span></a><span class="sd">        Record order statistics to CSV file for post-simulation analysis.</span>
</span><span id="Store.get_stats-1987"><a href="#Store.get_stats-1987"><span class="linenos">1987</span></a><span class="sd">        </span>
</span><span id="Store.get_stats-1988"><a href="#Store.get_stats-1988"><span class="linenos">1988</span></a><span class="sd">        This method captures comprehensive metrics about each order, including timing,</span>
</span><span id="Store.get_stats-1989"><a href="#Store.get_stats-1989"><span class="linenos">1989</span></a><span class="sd">        participants, and outcome. Statistics are appended to a CSV file for later</span>
</span><span id="Store.get_stats-1990"><a href="#Store.get_stats-1990"><span class="linenos">1990</span></a><span class="sd">        analysis of supply chain performance, bottlenecks, and optimization opportunities.</span>
</span><span id="Store.get_stats-1991"><a href="#Store.get_stats-1991"><span class="linenos">1991</span></a><span class="sd">        </span>
</span><span id="Store.get_stats-1992"><a href="#Store.get_stats-1992"><span class="linenos">1992</span></a><span class="sd">        Args:</span>
</span><span id="Store.get_stats-1993"><a href="#Store.get_stats-1993"><span class="linenos">1993</span></a><span class="sd">            order (Order): The order object containing product, quantity, and IDs.</span>
</span><span id="Store.get_stats-1994"><a href="#Store.get_stats-1994"><span class="linenos">1994</span></a><span class="sd">            eta (int): Estimated time of arrival or delivery time in simulation ticks.</span>
</span><span id="Store.get_stats-1995"><a href="#Store.get_stats-1995"><span class="linenos">1995</span></a><span class="sd">            state (str): Final state of the order. Possible values:</span>
</span><span id="Store.get_stats-1996"><a href="#Store.get_stats-1996"><span class="linenos">1996</span></a><span class="sd">                - &quot;delivered&quot;: Successfully completed</span>
</span><span id="Store.get_stats-1997"><a href="#Store.get_stats-1997"><span class="linenos">1997</span></a><span class="sd">                - &quot;pending&quot;: Awaiting delivery</span>
</span><span id="Store.get_stats-1998"><a href="#Store.get_stats-1998"><span class="linenos">1998</span></a><span class="sd">                - &quot;failed&quot;: Order failed (not currently used)</span>
</span><span id="Store.get_stats-1999"><a href="#Store.get_stats-1999"><span class="linenos">1999</span></a><span class="sd">            vehicle (str): JID of the vehicle that handled the delivery.</span>
</span><span id="Store.get_stats-2000"><a href="#Store.get_stats-2000"><span class="linenos">2000</span></a><span class="sd">        </span>
</span><span id="Store.get_stats-2001"><a href="#Store.get_stats-2001"><span class="linenos">2001</span></a><span class="sd">        Statistics Captured:</span>
</span><span id="Store.get_stats-2002"><a href="#Store.get_stats-2002"><span class="linenos">2002</span></a><span class="sd">            - order_id: Unique request identifier</span>
</span><span id="Store.get_stats-2003"><a href="#Store.get_stats-2003"><span class="linenos">2003</span></a><span class="sd">            - store_jid: This store&#39;s identifier (without @domain)</span>
</span><span id="Store.get_stats-2004"><a href="#Store.get_stats-2004"><span class="linenos">2004</span></a><span class="sd">            - vehicle_jid: Delivering vehicle&#39;s identifier (without @domain)</span>
</span><span id="Store.get_stats-2005"><a href="#Store.get_stats-2005"><span class="linenos">2005</span></a><span class="sd">            - origin_warehouse: Warehouse that fulfilled order (without @domain)</span>
</span><span id="Store.get_stats-2006"><a href="#Store.get_stats-2006"><span class="linenos">2006</span></a><span class="sd">            - product: Product name</span>
</span><span id="Store.get_stats-2007"><a href="#Store.get_stats-2007"><span class="linenos">2007</span></a><span class="sd">            - quantity: Amount ordered/delivered</span>
</span><span id="Store.get_stats-2008"><a href="#Store.get_stats-2008"><span class="linenos">2008</span></a><span class="sd">            - ETA: Estimated time of arrival from vehicle</span>
</span><span id="Store.get_stats-2009"><a href="#Store.get_stats-2009"><span class="linenos">2009</span></a><span class="sd">            - time_to_delivery: Total ticks from confirmation to delivery</span>
</span><span id="Store.get_stats-2010"><a href="#Store.get_stats-2010"><span class="linenos">2010</span></a><span class="sd">            - current_tick: Simulation time when stats recorded</span>
</span><span id="Store.get_stats-2011"><a href="#Store.get_stats-2011"><span class="linenos">2011</span></a><span class="sd">            - final_state: Outcome indicator (delivered/pending/failed)</span>
</span><span id="Store.get_stats-2012"><a href="#Store.get_stats-2012"><span class="linenos">2012</span></a><span class="sd">        </span>
</span><span id="Store.get_stats-2013"><a href="#Store.get_stats-2013"><span class="linenos">2013</span></a><span class="sd">        CSV File Format:</span>
</span><span id="Store.get_stats-2014"><a href="#Store.get_stats-2014"><span class="linenos">2014</span></a><span class="sd">            - Location: stats/store_stats.csv</span>
</span><span id="Store.get_stats-2015"><a href="#Store.get_stats-2015"><span class="linenos">2015</span></a><span class="sd">            - Encoding: UTF-8</span>
</span><span id="Store.get_stats-2016"><a href="#Store.get_stats-2016"><span class="linenos">2016</span></a><span class="sd">            - Headers: Written automatically on first write</span>
</span><span id="Store.get_stats-2017"><a href="#Store.get_stats-2017"><span class="linenos">2017</span></a><span class="sd">            - Mode: Append (preserves previous records)</span>
</span><span id="Store.get_stats-2018"><a href="#Store.get_stats-2018"><span class="linenos">2018</span></a><span class="sd">        </span>
</span><span id="Store.get_stats-2019"><a href="#Store.get_stats-2019"><span class="linenos">2019</span></a><span class="sd">        Time-to-Delivery Calculation:</span>
</span><span id="Store.get_stats-2020"><a href="#Store.get_stats-2020"><span class="linenos">2020</span></a><span class="sd">            ```python</span>
</span><span id="Store.get_stats-2021"><a href="#Store.get_stats-2021"><span class="linenos">2021</span></a><span class="sd">            time_to_delivery = current_tick - order_timings[orderid]</span>
</span><span id="Store.get_stats-2022"><a href="#Store.get_stats-2022"><span class="linenos">2022</span></a><span class="sd">            # order_timings[orderid] set during SendStoreConfirmation</span>
</span><span id="Store.get_stats-2023"><a href="#Store.get_stats-2023"><span class="linenos">2023</span></a><span class="sd">            # Measures: Confirmation -&gt; Delivery complete</span>
</span><span id="Store.get_stats-2024"><a href="#Store.get_stats-2024"><span class="linenos">2024</span></a><span class="sd">            ```</span>
</span><span id="Store.get_stats-2025"><a href="#Store.get_stats-2025"><span class="linenos">2025</span></a><span class="sd">        </span>
</span><span id="Store.get_stats-2026"><a href="#Store.get_stats-2026"><span class="linenos">2026</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store.get_stats-2027"><a href="#Store.get_stats-2027"><span class="linenos">2027</span></a><span class="sd">            - Creates stats/ directory if it doesn&#39;t exist</span>
</span><span id="Store.get_stats-2028"><a href="#Store.get_stats-2028"><span class="linenos">2028</span></a><span class="sd">            - Creates or appends to store_stats.csv</span>
</span><span id="Store.get_stats-2029"><a href="#Store.get_stats-2029"><span class="linenos">2029</span></a><span class="sd">            - Prints confirmation if verbose mode enabled</span>
</span><span id="Store.get_stats-2030"><a href="#Store.get_stats-2030"><span class="linenos">2030</span></a><span class="sd">            - Prints error if file operation fails</span>
</span><span id="Store.get_stats-2031"><a href="#Store.get_stats-2031"><span class="linenos">2031</span></a><span class="sd">        </span>
</span><span id="Store.get_stats-2032"><a href="#Store.get_stats-2032"><span class="linenos">2032</span></a><span class="sd">        Error Handling:</span>
</span><span id="Store.get_stats-2033"><a href="#Store.get_stats-2033"><span class="linenos">2033</span></a><span class="sd">            - Wraps file operations in try-except</span>
</span><span id="Store.get_stats-2034"><a href="#Store.get_stats-2034"><span class="linenos">2034</span></a><span class="sd">            - Catches all exceptions (broad handling for robustness)</span>
</span><span id="Store.get_stats-2035"><a href="#Store.get_stats-2035"><span class="linenos">2035</span></a><span class="sd">            - Prints error message with exception details</span>
</span><span id="Store.get_stats-2036"><a href="#Store.get_stats-2036"><span class="linenos">2036</span></a><span class="sd">            - Does not crash agent on statistics failure</span>
</span><span id="Store.get_stats-2037"><a href="#Store.get_stats-2037"><span class="linenos">2037</span></a><span class="sd">        </span>
</span><span id="Store.get_stats-2038"><a href="#Store.get_stats-2038"><span class="linenos">2038</span></a><span class="sd">        Example CSV Output:</span>
</span><span id="Store.get_stats-2039"><a href="#Store.get_stats-2039"><span class="linenos">2039</span></a><span class="sd">            ```csv</span>
</span><span id="Store.get_stats-2040"><a href="#Store.get_stats-2040"><span class="linenos">2040</span></a><span class="sd">            order_id,store_jid,vehicle_jid,origin_warehouse,product,quantity,ETA,time_to_delivery,current_tick,final_state</span>
</span><span id="Store.get_stats-2041"><a href="#Store.get_stats-2041"><span class="linenos">2041</span></a><span class="sd">            1001000000,store1,vehicle1,warehouse2,electronics,50,120,125,345,delivered</span>
</span><span id="Store.get_stats-2042"><a href="#Store.get_stats-2042"><span class="linenos">2042</span></a><span class="sd">            1001000001,store1,vehicle2,warehouse1,food,30,80,85,430,delivered</span>
</span><span id="Store.get_stats-2043"><a href="#Store.get_stats-2043"><span class="linenos">2043</span></a><span class="sd">            ```</span>
</span><span id="Store.get_stats-2044"><a href="#Store.get_stats-2044"><span class="linenos">2044</span></a><span class="sd">        </span>
</span><span id="Store.get_stats-2045"><a href="#Store.get_stats-2045"><span class="linenos">2045</span></a><span class="sd">        Performance Metrics Enabled:</span>
</span><span id="Store.get_stats-2046"><a href="#Store.get_stats-2046"><span class="linenos">2046</span></a><span class="sd">            - Average delivery time per product</span>
</span><span id="Store.get_stats-2047"><a href="#Store.get_stats-2047"><span class="linenos">2047</span></a><span class="sd">            - Warehouse performance comparison</span>
</span><span id="Store.get_stats-2048"><a href="#Store.get_stats-2048"><span class="linenos">2048</span></a><span class="sd">            - Vehicle efficiency analysis</span>
</span><span id="Store.get_stats-2049"><a href="#Store.get_stats-2049"><span class="linenos">2049</span></a><span class="sd">            - Bottleneck identification</span>
</span><span id="Store.get_stats-2050"><a href="#Store.get_stats-2050"><span class="linenos">2050</span></a><span class="sd">            - Demand pattern analysis</span>
</span><span id="Store.get_stats-2051"><a href="#Store.get_stats-2051"><span class="linenos">2051</span></a><span class="sd">        </span>
</span><span id="Store.get_stats-2052"><a href="#Store.get_stats-2052"><span class="linenos">2052</span></a><span class="sd">        Example Usage:</span>
</span><span id="Store.get_stats-2053"><a href="#Store.get_stats-2053"><span class="linenos">2053</span></a><span class="sd">            ```python</span>
</span><span id="Store.get_stats-2054"><a href="#Store.get_stats-2054"><span class="linenos">2054</span></a><span class="sd">            # Called from ReceiveVehicleArrival after delivery</span>
</span><span id="Store.get_stats-2055"><a href="#Store.get_stats-2055"><span class="linenos">2055</span></a><span class="sd">            order = pending_deliveries[orderid]</span>
</span><span id="Store.get_stats-2056"><a href="#Store.get_stats-2056"><span class="linenos">2056</span></a><span class="sd">            eta = 120  # From vehicle message</span>
</span><span id="Store.get_stats-2057"><a href="#Store.get_stats-2057"><span class="linenos">2057</span></a><span class="sd">            store.get_stats(order, eta, &quot;delivered&quot;, msg.sender)</span>
</span><span id="Store.get_stats-2058"><a href="#Store.get_stats-2058"><span class="linenos">2058</span></a><span class="sd">            # CSV row appended with all order metrics</span>
</span><span id="Store.get_stats-2059"><a href="#Store.get_stats-2059"><span class="linenos">2059</span></a><span class="sd">            ```</span>
</span><span id="Store.get_stats-2060"><a href="#Store.get_stats-2060"><span class="linenos">2060</span></a><span class="sd">        </span>
</span><span id="Store.get_stats-2061"><a href="#Store.get_stats-2061"><span class="linenos">2061</span></a><span class="sd">        Note:</span>
</span><span id="Store.get_stats-2062"><a href="#Store.get_stats-2062"><span class="linenos">2062</span></a><span class="sd">            Statistics are append-only. For new simulation runs, manually delete or</span>
</span><span id="Store.get_stats-2063"><a href="#Store.get_stats-2063"><span class="linenos">2063</span></a><span class="sd">            rename the CSV file to avoid mixing data from different experiments.</span>
</span><span id="Store.get_stats-2064"><a href="#Store.get_stats-2064"><span class="linenos">2064</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.get_stats-2065"><a href="#Store.get_stats-2065"><span class="linenos">2065</span></a>        <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="Store.get_stats-2066"><a href="#Store.get_stats-2066"><span class="linenos">2066</span></a>        
</span><span id="Store.get_stats-2067"><a href="#Store.get_stats-2067"><span class="linenos">2067</span></a>        <span class="n">order_stats</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Store.get_stats-2068"><a href="#Store.get_stats-2068"><span class="linenos">2068</span></a>            <span class="s2">&quot;order_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span>
</span><span id="Store.get_stats-2069"><a href="#Store.get_stats-2069"><span class="linenos">2069</span></a>            <span class="s2">&quot;store_jid&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Store.get_stats-2070"><a href="#Store.get_stats-2070"><span class="linenos">2070</span></a>            <span class="s2">&quot;vehicle_jid&quot;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Store.get_stats-2071"><a href="#Store.get_stats-2071"><span class="linenos">2071</span></a>            <span class="s2">&quot;origin_warehouse&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Store.get_stats-2072"><a href="#Store.get_stats-2072"><span class="linenos">2072</span></a>            <span class="s2">&quot;product&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="p">,</span>
</span><span id="Store.get_stats-2073"><a href="#Store.get_stats-2073"><span class="linenos">2073</span></a>            <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="Store.get_stats-2074"><a href="#Store.get_stats-2074"><span class="linenos">2074</span></a>            <span class="s2">&quot;ETA&quot;</span><span class="p">:</span> <span class="n">eta</span> <span class="k">if</span> <span class="n">eta</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Store.get_stats-2075"><a href="#Store.get_stats-2075"><span class="linenos">2075</span></a>            <span class="s2">&quot;time_to_delivery&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_timings</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">],</span>
</span><span id="Store.get_stats-2076"><a href="#Store.get_stats-2076"><span class="linenos">2076</span></a>            <span class="s2">&quot;current_tick&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_tick</span><span class="p">,</span>
</span><span id="Store.get_stats-2077"><a href="#Store.get_stats-2077"><span class="linenos">2077</span></a>            <span class="s2">&quot;final_state&quot;</span><span class="p">:</span> <span class="n">state</span>  <span class="c1"># pending, delivered, failed</span>
</span><span id="Store.get_stats-2078"><a href="#Store.get_stats-2078"><span class="linenos">2078</span></a>        <span class="p">}</span>
</span><span id="Store.get_stats-2079"><a href="#Store.get_stats-2079"><span class="linenos">2079</span></a>        
</span><span id="Store.get_stats-2080"><a href="#Store.get_stats-2080"><span class="linenos">2080</span></a>        <span class="c1"># Build full file path</span>
</span><span id="Store.get_stats-2081"><a href="#Store.get_stats-2081"><span class="linenos">2081</span></a>        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_filename</span><span class="p">)</span>
</span><span id="Store.get_stats-2082"><a href="#Store.get_stats-2082"><span class="linenos">2082</span></a>        
</span><span id="Store.get_stats-2083"><a href="#Store.get_stats-2083"><span class="linenos">2083</span></a>        <span class="c1"># Check if file exists to determine if we need to write headers</span>
</span><span id="Store.get_stats-2084"><a href="#Store.get_stats-2084"><span class="linenos">2084</span></a>        <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
</span><span id="Store.get_stats-2085"><a href="#Store.get_stats-2085"><span class="linenos">2085</span></a>        
</span><span id="Store.get_stats-2086"><a href="#Store.get_stats-2086"><span class="linenos">2086</span></a>        <span class="c1"># Write to CSV</span>
</span><span id="Store.get_stats-2087"><a href="#Store.get_stats-2087"><span class="linenos">2087</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Store.get_stats-2088"><a href="#Store.get_stats-2088"><span class="linenos">2088</span></a>            <span class="c1"># Create directory if it doesn&#39;t exist</span>
</span><span id="Store.get_stats-2089"><a href="#Store.get_stats-2089"><span class="linenos">2089</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Store.get_stats-2090"><a href="#Store.get_stats-2090"><span class="linenos">2090</span></a>            
</span><span id="Store.get_stats-2091"><a href="#Store.get_stats-2091"><span class="linenos">2091</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">:</span> <span class="n">open_mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>
</span><span id="Store.get_stats-2092"><a href="#Store.get_stats-2092"><span class="linenos">2092</span></a>            <span class="k">else</span><span class="p">:</span> <span class="n">open_mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
</span><span id="Store.get_stats-2093"><a href="#Store.get_stats-2093"><span class="linenos">2093</span></a>            
</span><span id="Store.get_stats-2094"><a href="#Store.get_stats-2094"><span class="linenos">2094</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">open_mode</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="Store.get_stats-2095"><a href="#Store.get_stats-2095"><span class="linenos">2095</span></a>                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">order_stats</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Store.get_stats-2096"><a href="#Store.get_stats-2096"><span class="linenos">2096</span></a>                
</span><span id="Store.get_stats-2097"><a href="#Store.get_stats-2097"><span class="linenos">2097</span></a>                <span class="c1"># Write header only if file is new</span>
</span><span id="Store.get_stats-2098"><a href="#Store.get_stats-2098"><span class="linenos">2098</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">:</span>
</span><span id="Store.get_stats-2099"><a href="#Store.get_stats-2099"><span class="linenos">2099</span></a>                    <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
</span><span id="Store.get_stats-2100"><a href="#Store.get_stats-2100"><span class="linenos">2100</span></a>                
</span><span id="Store.get_stats-2101"><a href="#Store.get_stats-2101"><span class="linenos">2101</span></a>                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_stats</span><span class="p">)</span>
</span><span id="Store.get_stats-2102"><a href="#Store.get_stats-2102"><span class="linenos">2102</span></a>            
</span><span id="Store.get_stats-2103"><a href="#Store.get_stats-2103"><span class="linenos">2103</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.get_stats-2104"><a href="#Store.get_stats-2104"><span class="linenos">2104</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Stats saved to </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2"> for order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.get_stats-2105"><a href="#Store.get_stats-2105"><span class="linenos">2105</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Store.get_stats-2106"><a href="#Store.get_stats-2106"><span class="linenos">2106</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR saving stats: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        
</span></pre></div>


            <div class="docstring"><p>Record order statistics to CSV file for post-simulation analysis.</p>

<p>This method captures comprehensive metrics about each order, including timing,
participants, and outcome. Statistics are appended to a CSV file for later
analysis of supply chain performance, bottlenecks, and optimization opportunities.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>order (Order):</strong>  The order object containing product, quantity, and IDs.</li>
<li><strong>eta (int):</strong>  Estimated time of arrival or delivery time in simulation ticks.</li>
<li><strong>state (str):</strong>  Final state of the order. Possible values:
<ul>
<li>"delivered": Successfully completed</li>
<li>"pending": Awaiting delivery</li>
<li>"failed": Order failed (not currently used)</li>
</ul></li>
<li><strong>vehicle (str):</strong>  JID of the vehicle that handled the delivery.</li>
</ul>

<h6 id="statistics-captured">Statistics Captured:</h6>

<blockquote>
  <ul>
  <li>order_id: Unique request identifier</li>
  <li>store_jid: This store's identifier (without @domain)</li>
  <li>vehicle_jid: Delivering vehicle's identifier (without @domain)</li>
  <li>origin_warehouse: Warehouse that fulfilled order (without @domain)</li>
  <li>product: Product name</li>
  <li>quantity: Amount ordered/delivered</li>
  <li>ETA: Estimated time of arrival from vehicle</li>
  <li>time_to_delivery: Total ticks from confirmation to delivery</li>
  <li>current_tick: Simulation time when stats recorded</li>
  <li>final_state: Outcome indicator (delivered/pending/failed)</li>
  </ul>
</blockquote>

<h6 id="csv-file-format">CSV File Format:</h6>

<blockquote>
  <ul>
  <li>Location: stats/store_stats.csv</li>
  <li>Encoding: UTF-8</li>
  <li>Headers: Written automatically on first write</li>
  <li>Mode: Append (preserves previous records)</li>
  </ul>
</blockquote>

<p>Time-to-Delivery Calculation:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">time_to_delivery</span> <span class="o">=</span> <span class="n">current_tick</span> <span class="o">-</span> <span class="n">order_timings</span><span class="p">[</span><span class="n">orderid</span><span class="p">]</span>
<span class="c1"># order_timings[orderid] set during SendStoreConfirmation</span>
<span class="c1"># Measures: Confirmation -&gt; Delivery complete</span>
</code></pre>
</div>
</code></pre>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Creates stats/ directory if it doesn't exist</li>
  <li>Creates or appends to store_stats.csv</li>
  <li>Prints confirmation if verbose mode enabled</li>
  <li>Prints error if file operation fails</li>
  </ul>
</blockquote>

<h6 id="error-handling">Error Handling:</h6>

<blockquote>
  <ul>
  <li>Wraps file operations in try-except</li>
  <li>Catches all exceptions (broad handling for robustness)</li>
  <li>Prints error message with exception details</li>
  <li>Does not crash agent on statistics failure</li>
  </ul>
</blockquote>

<h6 id="example-csv-output">Example CSV Output:</h6>

<blockquote>
<pre><code>order_id,store_jid,vehicle_jid,origin_warehouse,product,quantity,ETA,time_to_delivery,current_tick,final_state
1001000000,store1,vehicle1,warehouse2,electronics,50,120,125,345,delivered
1001000001,store1,vehicle2,warehouse1,food,30,80,85,430,delivered
</code></pre>
</blockquote>

<h6 id="performance-metrics-enabled">Performance Metrics Enabled:</h6>

<blockquote>
  <ul>
  <li>Average delivery time per product</li>
  <li>Warehouse performance comparison</li>
  <li>Vehicle efficiency analysis</li>
  <li>Bottleneck identification</li>
  <li>Demand pattern analysis</li>
  </ul>
</blockquote>

<h6 id="example-usage">Example Usage:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># Called from ReceiveVehicleArrival after delivery</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">pending_deliveries</span><span class="p">[</span><span class="n">orderid</span><span class="p">]</span>
<span class="n">eta</span> <span class="o">=</span> <span class="mi">120</span>  <span class="c1"># From vehicle message</span>
<span class="n">store</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="s2">&quot;delivered&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
<span class="c1"># CSV row appended with all order metrics</span>
</code></pre>
  </div>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Statistics are append-only. For new simulation runs, manually delete or
  rename the CSV file to avoid mixing data from different experiments.</p>
</blockquote>
</div>


                            </div>
                            <div id="Store.print_stock" class="classattr">
                                        <input id="Store.print_stock-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">print_stock</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Store.print_stock-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.print_stock"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.print_stock-2108"><a href="#Store.print_stock-2108"><span class="linenos">2108</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_stock</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store.print_stock-2109"><a href="#Store.print_stock-2109"><span class="linenos">2109</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.print_stock-2110"><a href="#Store.print_stock-2110"><span class="linenos">2110</span></a><span class="sd">        Print the current stock inventory to console.</span>
</span><span id="Store.print_stock-2111"><a href="#Store.print_stock-2111"><span class="linenos">2111</span></a><span class="sd">        </span>
</span><span id="Store.print_stock-2112"><a href="#Store.print_stock-2112"><span class="linenos">2112</span></a><span class="sd">        This helper method provides a human-readable display of the store&#39;s current</span>
</span><span id="Store.print_stock-2113"><a href="#Store.print_stock-2113"><span class="linenos">2113</span></a><span class="sd">        inventory, showing all products and their quantities. Used after deliveries</span>
</span><span id="Store.print_stock-2114"><a href="#Store.print_stock-2114"><span class="linenos">2114</span></a><span class="sd">        to provide visibility into stock levels.</span>
</span><span id="Store.print_stock-2115"><a href="#Store.print_stock-2115"><span class="linenos">2115</span></a><span class="sd">        </span>
</span><span id="Store.print_stock-2116"><a href="#Store.print_stock-2116"><span class="linenos">2116</span></a><span class="sd">        Output Format:</span>
</span><span id="Store.print_stock-2117"><a href="#Store.print_stock-2117"><span class="linenos">2117</span></a><span class="sd">            If stock is empty:</span>
</span><span id="Store.print_stock-2118"><a href="#Store.print_stock-2118"><span class="linenos">2118</span></a><span class="sd">                &quot;{jid}&gt; Stock is empty&quot;</span>
</span><span id="Store.print_stock-2119"><a href="#Store.print_stock-2119"><span class="linenos">2119</span></a><span class="sd">            </span>
</span><span id="Store.print_stock-2120"><a href="#Store.print_stock-2120"><span class="linenos">2120</span></a><span class="sd">            If stock has items:</span>
</span><span id="Store.print_stock-2121"><a href="#Store.print_stock-2121"><span class="linenos">2121</span></a><span class="sd">                &quot;{jid}&gt; Current stock:&quot;</span>
</span><span id="Store.print_stock-2122"><a href="#Store.print_stock-2122"><span class="linenos">2122</span></a><span class="sd">                &quot;  - product1: quantity1 units&quot;</span>
</span><span id="Store.print_stock-2123"><a href="#Store.print_stock-2123"><span class="linenos">2123</span></a><span class="sd">                &quot;  - product2: quantity2 units&quot;</span>
</span><span id="Store.print_stock-2124"><a href="#Store.print_stock-2124"><span class="linenos">2124</span></a><span class="sd">                ...</span>
</span><span id="Store.print_stock-2125"><a href="#Store.print_stock-2125"><span class="linenos">2125</span></a><span class="sd">        </span>
</span><span id="Store.print_stock-2126"><a href="#Store.print_stock-2126"><span class="linenos">2126</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store.print_stock-2127"><a href="#Store.print_stock-2127"><span class="linenos">2127</span></a><span class="sd">            - Prints to standard output (console)</span>
</span><span id="Store.print_stock-2128"><a href="#Store.print_stock-2128"><span class="linenos">2128</span></a><span class="sd">            - Always visible (not affected by verbose setting)</span>
</span><span id="Store.print_stock-2129"><a href="#Store.print_stock-2129"><span class="linenos">2129</span></a><span class="sd">        </span>
</span><span id="Store.print_stock-2130"><a href="#Store.print_stock-2130"><span class="linenos">2130</span></a><span class="sd">        Example Output:</span>
</span><span id="Store.print_stock-2131"><a href="#Store.print_stock-2131"><span class="linenos">2131</span></a><span class="sd">            ```</span>
</span><span id="Store.print_stock-2132"><a href="#Store.print_stock-2132"><span class="linenos">2132</span></a><span class="sd">            store1@localhost&gt; Current stock:</span>
</span><span id="Store.print_stock-2133"><a href="#Store.print_stock-2133"><span class="linenos">2133</span></a><span class="sd">              - electronics: 250 units</span>
</span><span id="Store.print_stock-2134"><a href="#Store.print_stock-2134"><span class="linenos">2134</span></a><span class="sd">              - food: 100 units</span>
</span><span id="Store.print_stock-2135"><a href="#Store.print_stock-2135"><span class="linenos">2135</span></a><span class="sd">              - clothing: 75 units</span>
</span><span id="Store.print_stock-2136"><a href="#Store.print_stock-2136"><span class="linenos">2136</span></a><span class="sd">            ```</span>
</span><span id="Store.print_stock-2137"><a href="#Store.print_stock-2137"><span class="linenos">2137</span></a><span class="sd">        </span>
</span><span id="Store.print_stock-2138"><a href="#Store.print_stock-2138"><span class="linenos">2138</span></a><span class="sd">        Note:</span>
</span><span id="Store.print_stock-2139"><a href="#Store.print_stock-2139"><span class="linenos">2139</span></a><span class="sd">            This method is called after every successful delivery to provide</span>
</span><span id="Store.print_stock-2140"><a href="#Store.print_stock-2140"><span class="linenos">2140</span></a><span class="sd">            immediate feedback about inventory changes.</span>
</span><span id="Store.print_stock-2141"><a href="#Store.print_stock-2141"><span class="linenos">2141</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.print_stock-2142"><a href="#Store.print_stock-2142"><span class="linenos">2142</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="Store.print_stock-2143"><a href="#Store.print_stock-2143"><span class="linenos">2143</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Stock is empty&quot;</span><span class="p">)</span>
</span><span id="Store.print_stock-2144"><a href="#Store.print_stock-2144"><span class="linenos">2144</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Store.print_stock-2145"><a href="#Store.print_stock-2145"><span class="linenos">2145</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Current stock:&quot;</span><span class="p">)</span>
</span><span id="Store.print_stock-2146"><a href="#Store.print_stock-2146"><span class="linenos">2146</span></a>            <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Store.print_stock-2147"><a href="#Store.print_stock-2147"><span class="linenos">2147</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Print the current stock inventory to console.</p>

<p>This helper method provides a human-readable display of the store's current
inventory, showing all products and their quantities. Used after deliveries
to provide visibility into stock levels.</p>

<h6 id="output-format">Output Format:</h6>

<blockquote>
  <p>If stock is empty:
      "{jid}&gt; Stock is empty"</p>
  
  <p>If stock has items:
      "{jid}&gt; Current stock:"
      "  - product1: quantity1 units"
      "  - product2: quantity2 units"
      ...</p>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Prints to standard output (console)</li>
  <li>Always visible (not affected by verbose setting)</li>
  </ul>
</blockquote>

<h6 id="example-output">Example Output:</h6>

<blockquote>
<pre><code>store1@localhost&gt; Current stock:
  - electronics: 250 units
  - food: 100 units
  - clothing: 75 units
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This method is called after every successful delivery to provide
  immediate feedback about inventory changes.</p>
</blockquote>
</div>


                            </div>
                            <div id="Store.node_id" class="classattr">
                                <div class="attr variable">
            <span class="name">node_id</span>

        
    </div>
    <a class="headerlink" href="#Store.node_id"></a>
    
    

                            </div>
                            <div id="Store.map" class="classattr">
                                <div class="attr variable">
            <span class="name">map</span><span class="annotation">: world.graph.Graph</span>

        
    </div>
    <a class="headerlink" href="#Store.map"></a>
    
    

                            </div>
                            <div id="Store.contact_list" class="classattr">
                                <div class="attr variable">
            <span class="name">contact_list</span>

        
    </div>
    <a class="headerlink" href="#Store.contact_list"></a>
    
    

                            </div>
                            <div id="Store.verbose" class="classattr">
                                <div class="attr variable">
            <span class="name">verbose</span>

        
    </div>
    <a class="headerlink" href="#Store.verbose"></a>
    
    

                            </div>
                            <div id="Store.id_base" class="classattr">
                                <div class="attr variable">
            <span class="name">id_base</span>

        
    </div>
    <a class="headerlink" href="#Store.id_base"></a>
    
    

                            </div>
                            <div id="Store.pending_deliveries" class="classattr">
                                <div class="attr variable">
            <span class="name">pending_deliveries</span><span class="annotation">: dict[str, <a href="veiculos/veiculos.html#Order">veiculos.veiculos.Order</a>]</span>

        
    </div>
    <a class="headerlink" href="#Store.pending_deliveries"></a>
    
    

                            </div>
                            <div id="Store.order_timings" class="classattr">
                                <div class="attr variable">
            <span class="name">order_timings</span><span class="annotation">: dict[str, int]</span>

        
    </div>
    <a class="headerlink" href="#Store.order_timings"></a>
    
    

                            </div>
                            <div id="Store.current_tick" class="classattr">
                                <div class="attr variable">
            <span class="name">current_tick</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#Store.current_tick"></a>
    
    

                            </div>
                            <div id="Store.stats_path" class="classattr">
                                <div class="attr variable">
            <span class="name">stats_path</span>

        
    </div>
    <a class="headerlink" href="#Store.stats_path"></a>
    
    

                            </div>
                            <div id="Store.stats_filename" class="classattr">
                                <div class="attr variable">
            <span class="name">stats_filename</span>

        
    </div>
    <a class="headerlink" href="#Store.stats_filename"></a>
    
    

                            </div>
                            <div id="Store.product_list" class="classattr">
                                <div class="attr variable">
            <span class="name">product_list</span>

        
    </div>
    <a class="headerlink" href="#Store.product_list"></a>
    
    

                            </div>
                            <div id="Store.buy_prob" class="classattr">
                                <div class="attr variable">
            <span class="name">buy_prob</span>

        
    </div>
    <a class="headerlink" href="#Store.buy_prob"></a>
    
    

                            </div>
                            <div id="Store.max_buy_quantity" class="classattr">
                                <div class="attr variable">
            <span class="name">max_buy_quantity</span>

        
    </div>
    <a class="headerlink" href="#Store.max_buy_quantity"></a>
    
    

                            </div>
                            <div id="Store.setup" class="classattr">
                                        <input id="Store.setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Store.setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.setup-2257"><a href="#Store.setup-2257"><span class="linenos">2257</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.setup-2258"><a href="#Store.setup-2258"><span class="linenos">2258</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.setup-2259"><a href="#Store.setup-2259"><span class="linenos">2259</span></a><span class="sd">        Setup method called automatically by SPADE when agent starts.</span>
</span><span id="Store.setup-2260"><a href="#Store.setup-2260"><span class="linenos">2260</span></a><span class="sd">        </span>
</span><span id="Store.setup-2261"><a href="#Store.setup-2261"><span class="linenos">2261</span></a><span class="sd">        This method initializes the agent&#39;s operational state and registers all</span>
</span><span id="Store.setup-2262"><a href="#Store.setup-2262"><span class="linenos">2262</span></a><span class="sd">        behaviours with appropriate message templates. It completes the agent</span>
</span><span id="Store.setup-2263"><a href="#Store.setup-2263"><span class="linenos">2263</span></a><span class="sd">        initialization process started in __init__, preparing the store for</span>
</span><span id="Store.setup-2264"><a href="#Store.setup-2264"><span class="linenos">2264</span></a><span class="sd">        active participation in the supply chain simulation.</span>
</span><span id="Store.setup-2265"><a href="#Store.setup-2265"><span class="linenos">2265</span></a><span class="sd">        </span>
</span><span id="Store.setup-2266"><a href="#Store.setup-2266"><span class="linenos">2266</span></a><span class="sd">        Initialization Steps:</span>
</span><span id="Store.setup-2267"><a href="#Store.setup-2267"><span class="linenos">2267</span></a><span class="sd">            1. Configure presence management (auto-approve subscriptions)</span>
</span><span id="Store.setup-2268"><a href="#Store.setup-2268"><span class="linenos">2268</span></a><span class="sd">            2. Subscribe to all warehouses in contact list</span>
</span><span id="Store.setup-2269"><a href="#Store.setup-2269"><span class="linenos">2269</span></a><span class="sd">            3. Initialize runtime state variables (stock, counters, queues)</span>
</span><span id="Store.setup-2270"><a href="#Store.setup-2270"><span class="linenos">2270</span></a><span class="sd">            4. Register BuyProduct behaviour (periodic purchasing)</span>
</span><span id="Store.setup-2271"><a href="#Store.setup-2271"><span class="linenos">2271</span></a><span class="sd">            5. Register ReceiveTimeDelta behaviour (time synchronization)</span>
</span><span id="Store.setup-2272"><a href="#Store.setup-2272"><span class="linenos">2272</span></a><span class="sd">            6. Register RetryPreviousBuy behaviour (failed request retry)</span>
</span><span id="Store.setup-2273"><a href="#Store.setup-2273"><span class="linenos">2273</span></a><span class="sd">            7. Register ReceiveVehicleArrival behaviour (delivery reception)</span>
</span><span id="Store.setup-2274"><a href="#Store.setup-2274"><span class="linenos">2274</span></a><span class="sd">        </span>
</span><span id="Store.setup-2275"><a href="#Store.setup-2275"><span class="linenos">2275</span></a><span class="sd">        Presence Configuration:</span>
</span><span id="Store.setup-2276"><a href="#Store.setup-2276"><span class="linenos">2276</span></a><span class="sd">            - presence.approve_all = True: Auto-accept all subscription requests</span>
</span><span id="Store.setup-2277"><a href="#Store.setup-2277"><span class="linenos">2277</span></a><span class="sd">            - Subscribes to each warehouse in contact_list</span>
</span><span id="Store.setup-2278"><a href="#Store.setup-2278"><span class="linenos">2278</span></a><span class="sd">            - Enables bidirectional communication with warehouses</span>
</span><span id="Store.setup-2279"><a href="#Store.setup-2279"><span class="linenos">2279</span></a><span class="sd">        </span>
</span><span id="Store.setup-2280"><a href="#Store.setup-2280"><span class="linenos">2280</span></a><span class="sd">        State Initialization:</span>
</span><span id="Store.setup-2281"><a href="#Store.setup-2281"><span class="linenos">2281</span></a><span class="sd">            - stock: Empty dict (populated by deliveries)</span>
</span><span id="Store.setup-2282"><a href="#Store.setup-2282"><span class="linenos">2282</span></a><span class="sd">            - current_buy_request: None (set during purchase attempts)</span>
</span><span id="Store.setup-2283"><a href="#Store.setup-2283"><span class="linenos">2283</span></a><span class="sd">            - failed_requests: Empty FIFO queue (populated by failed negotiations)</span>
</span><span id="Store.setup-2284"><a href="#Store.setup-2284"><span class="linenos">2284</span></a><span class="sd">            - request_counter: 0 (incremented for each purchase request)</span>
</span><span id="Store.setup-2285"><a href="#Store.setup-2285"><span class="linenos">2285</span></a><span class="sd">        </span>
</span><span id="Store.setup-2286"><a href="#Store.setup-2286"><span class="linenos">2286</span></a><span class="sd">        Behaviour Registration:</span>
</span><span id="Store.setup-2287"><a href="#Store.setup-2287"><span class="linenos">2287</span></a><span class="sd">        </span>
</span><span id="Store.setup-2288"><a href="#Store.setup-2288"><span class="linenos">2288</span></a><span class="sd">            1. **BuyProduct** (PeriodicBehaviour):</span>
</span><span id="Store.setup-2289"><a href="#Store.setup-2289"><span class="linenos">2289</span></a><span class="sd">                - No template filter (self-triggered by period)</span>
</span><span id="Store.setup-2290"><a href="#Store.setup-2290"><span class="linenos">2290</span></a><span class="sd">                - Period: config.STORE_BUY_FREQUENCY seconds</span>
</span><span id="Store.setup-2291"><a href="#Store.setup-2291"><span class="linenos">2291</span></a><span class="sd">                - Purpose: Initiate FIPA Contract Net Protocol for purchases</span>
</span><span id="Store.setup-2292"><a href="#Store.setup-2292"><span class="linenos">2292</span></a><span class="sd">            </span>
</span><span id="Store.setup-2293"><a href="#Store.setup-2293"><span class="linenos">2293</span></a><span class="sd">            2. **ReceiveTimeDelta** (CyclicBehaviour):</span>
</span><span id="Store.setup-2294"><a href="#Store.setup-2294"><span class="linenos">2294</span></a><span class="sd">                - Template: performative=&quot;inform&quot;</span>
</span><span id="Store.setup-2295"><a href="#Store.setup-2295"><span class="linenos">2295</span></a><span class="sd">                - Purpose: Receive time updates and traffic data from world agent</span>
</span><span id="Store.setup-2296"><a href="#Store.setup-2296"><span class="linenos">2296</span></a><span class="sd">                - Continuous operation</span>
</span><span id="Store.setup-2297"><a href="#Store.setup-2297"><span class="linenos">2297</span></a><span class="sd">            </span>
</span><span id="Store.setup-2298"><a href="#Store.setup-2298"><span class="linenos">2298</span></a><span class="sd">            3. **RetryPreviousBuy** (PeriodicBehaviour):</span>
</span><span id="Store.setup-2299"><a href="#Store.setup-2299"><span class="linenos">2299</span></a><span class="sd">                - No template filter (self-triggered)</span>
</span><span id="Store.setup-2300"><a href="#Store.setup-2300"><span class="linenos">2300</span></a><span class="sd">                - Period: 5 seconds</span>
</span><span id="Store.setup-2301"><a href="#Store.setup-2301"><span class="linenos">2301</span></a><span class="sd">                - Purpose: Retry failed purchase requests</span>
</span><span id="Store.setup-2302"><a href="#Store.setup-2302"><span class="linenos">2302</span></a><span class="sd">            </span>
</span><span id="Store.setup-2303"><a href="#Store.setup-2303"><span class="linenos">2303</span></a><span class="sd">            4. **ReceiveVehicleArrival** (CyclicBehaviour):</span>
</span><span id="Store.setup-2304"><a href="#Store.setup-2304"><span class="linenos">2304</span></a><span class="sd">                - Template: performative=&quot;vehicle-delivery&quot;</span>
</span><span id="Store.setup-2305"><a href="#Store.setup-2305"><span class="linenos">2305</span></a><span class="sd">                - Purpose: Receive delivery notifications and update stock</span>
</span><span id="Store.setup-2306"><a href="#Store.setup-2306"><span class="linenos">2306</span></a><span class="sd">                - Continuous operation</span>
</span><span id="Store.setup-2307"><a href="#Store.setup-2307"><span class="linenos">2307</span></a><span class="sd">        </span>
</span><span id="Store.setup-2308"><a href="#Store.setup-2308"><span class="linenos">2308</span></a><span class="sd">        Template Filtering:</span>
</span><span id="Store.setup-2309"><a href="#Store.setup-2309"><span class="linenos">2309</span></a><span class="sd">            Templates ensure behaviours only receive relevant messages:</span>
</span><span id="Store.setup-2310"><a href="#Store.setup-2310"><span class="linenos">2310</span></a><span class="sd">            - ReceiveTimeDelta: Only &quot;inform&quot; messages (from world agent)</span>
</span><span id="Store.setup-2311"><a href="#Store.setup-2311"><span class="linenos">2311</span></a><span class="sd">            - ReceiveVehicleArrival: Only &quot;vehicle-delivery&quot; messages (from vehicles)</span>
</span><span id="Store.setup-2312"><a href="#Store.setup-2312"><span class="linenos">2312</span></a><span class="sd">            - BuyProduct/RetryPreviousBuy: No template (time-triggered, not message-triggered)</span>
</span><span id="Store.setup-2313"><a href="#Store.setup-2313"><span class="linenos">2313</span></a><span class="sd">        </span>
</span><span id="Store.setup-2314"><a href="#Store.setup-2314"><span class="linenos">2314</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store.setup-2315"><a href="#Store.setup-2315"><span class="linenos">2315</span></a><span class="sd">            - Sends presence subscription requests to all warehouses</span>
</span><span id="Store.setup-2316"><a href="#Store.setup-2316"><span class="linenos">2316</span></a><span class="sd">            - Adds four behaviours to agent&#39;s behaviour queue</span>
</span><span id="Store.setup-2317"><a href="#Store.setup-2317"><span class="linenos">2317</span></a><span class="sd">            - Prints subscription confirmations if verbose mode enabled</span>
</span><span id="Store.setup-2318"><a href="#Store.setup-2318"><span class="linenos">2318</span></a><span class="sd">        </span>
</span><span id="Store.setup-2319"><a href="#Store.setup-2319"><span class="linenos">2319</span></a><span class="sd">        Returns:</span>
</span><span id="Store.setup-2320"><a href="#Store.setup-2320"><span class="linenos">2320</span></a><span class="sd">            None. Completes when all behaviours are registered and agent is operational.</span>
</span><span id="Store.setup-2321"><a href="#Store.setup-2321"><span class="linenos">2321</span></a><span class="sd">        </span>
</span><span id="Store.setup-2322"><a href="#Store.setup-2322"><span class="linenos">2322</span></a><span class="sd">        Example Flow:</span>
</span><span id="Store.setup-2323"><a href="#Store.setup-2323"><span class="linenos">2323</span></a><span class="sd">            ```</span>
</span><span id="Store.setup-2324"><a href="#Store.setup-2324"><span class="linenos">2324</span></a><span class="sd">            Agent Start:</span>
</span><span id="Store.setup-2325"><a href="#Store.setup-2325"><span class="linenos">2325</span></a><span class="sd">                1. SPADE calls setup()</span>
</span><span id="Store.setup-2326"><a href="#Store.setup-2326"><span class="linenos">2326</span></a><span class="sd">                2. Subscribe to warehouse1, warehouse2</span>
</span><span id="Store.setup-2327"><a href="#Store.setup-2327"><span class="linenos">2327</span></a><span class="sd">                3. Initialize stock = {}</span>
</span><span id="Store.setup-2328"><a href="#Store.setup-2328"><span class="linenos">2328</span></a><span class="sd">                4. Register BuyProduct (will start after 5s)</span>
</span><span id="Store.setup-2329"><a href="#Store.setup-2329"><span class="linenos">2329</span></a><span class="sd">                5. Register ReceiveTimeDelta (active immediately)</span>
</span><span id="Store.setup-2330"><a href="#Store.setup-2330"><span class="linenos">2330</span></a><span class="sd">                6. Register RetryPreviousBuy (checks every 5s)</span>
</span><span id="Store.setup-2331"><a href="#Store.setup-2331"><span class="linenos">2331</span></a><span class="sd">                7. Register ReceiveVehicleArrival (active immediately)</span>
</span><span id="Store.setup-2332"><a href="#Store.setup-2332"><span class="linenos">2332</span></a><span class="sd">                8. Agent ready for operation</span>
</span><span id="Store.setup-2333"><a href="#Store.setup-2333"><span class="linenos">2333</span></a><span class="sd">            ```</span>
</span><span id="Store.setup-2334"><a href="#Store.setup-2334"><span class="linenos">2334</span></a><span class="sd">        </span>
</span><span id="Store.setup-2335"><a href="#Store.setup-2335"><span class="linenos">2335</span></a><span class="sd">        Note:</span>
</span><span id="Store.setup-2336"><a href="#Store.setup-2336"><span class="linenos">2336</span></a><span class="sd">            This method is asynchronous and is automatically called by SPADE&#39;s</span>
</span><span id="Store.setup-2337"><a href="#Store.setup-2337"><span class="linenos">2337</span></a><span class="sd">            agent lifecycle management. Do not call this method manually.</span>
</span><span id="Store.setup-2338"><a href="#Store.setup-2338"><span class="linenos">2338</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.setup-2339"><a href="#Store.setup-2339"><span class="linenos">2339</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">approve_all</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Store.setup-2340"><a href="#Store.setup-2340"><span class="linenos">2340</span></a>        <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_list</span><span class="p">:</span>
</span><span id="Store.setup-2341"><a href="#Store.setup-2341"><span class="linenos">2341</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
</span><span id="Store.setup-2342"><a href="#Store.setup-2342"><span class="linenos">2342</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.setup-2343"><a href="#Store.setup-2343"><span class="linenos">2343</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent subscription request to </span><span class="si">{</span><span class="n">contact</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.setup-2344"><a href="#Store.setup-2344"><span class="linenos">2344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stock</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Store.setup-2345"><a href="#Store.setup-2345"><span class="linenos">2345</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Store.setup-2346"><a href="#Store.setup-2346"><span class="linenos">2346</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failed_requests</span> <span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span><span id="Store.setup-2347"><a href="#Store.setup-2347"><span class="linenos">2347</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Store.setup-2348"><a href="#Store.setup-2348"><span class="linenos">2348</span></a>
</span><span id="Store.setup-2349"><a href="#Store.setup-2349"><span class="linenos">2349</span></a>        <span class="c1"># BuyProduct behaviour initialization</span>
</span><span id="Store.setup-2350"><a href="#Store.setup-2350"><span class="linenos">2350</span></a>        <span class="n">buy_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BuyProduct</span><span class="p">()</span>
</span><span id="Store.setup-2351"><a href="#Store.setup-2351"><span class="linenos">2351</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">buy_behav</span><span class="p">)</span>
</span><span id="Store.setup-2352"><a href="#Store.setup-2352"><span class="linenos">2352</span></a>
</span><span id="Store.setup-2353"><a href="#Store.setup-2353"><span class="linenos">2353</span></a>        <span class="c1"># Time delta behaviour</span>
</span><span id="Store.setup-2354"><a href="#Store.setup-2354"><span class="linenos">2354</span></a>        <span class="n">time_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveTimeDelta</span><span class="p">()</span>
</span><span id="Store.setup-2355"><a href="#Store.setup-2355"><span class="linenos">2355</span></a>        <span class="n">time_template</span> <span class="p">:</span> <span class="n">Template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Store.setup-2356"><a href="#Store.setup-2356"><span class="linenos">2356</span></a>        <span class="n">time_template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="Store.setup-2357"><a href="#Store.setup-2357"><span class="linenos">2357</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">time_behav</span><span class="p">,</span> <span class="n">time_template</span><span class="p">)</span>
</span><span id="Store.setup-2358"><a href="#Store.setup-2358"><span class="linenos">2358</span></a>        
</span><span id="Store.setup-2359"><a href="#Store.setup-2359"><span class="linenos">2359</span></a>        <span class="c1"># Buy retrying is not bound by ticks</span>
</span><span id="Store.setup-2360"><a href="#Store.setup-2360"><span class="linenos">2360</span></a>        <span class="n">retry_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RetryPreviousBuy</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="Store.setup-2361"><a href="#Store.setup-2361"><span class="linenos">2361</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">retry_behav</span><span class="p">)</span>
</span><span id="Store.setup-2362"><a href="#Store.setup-2362"><span class="linenos">2362</span></a>        
</span><span id="Store.setup-2363"><a href="#Store.setup-2363"><span class="linenos">2363</span></a>        <span class="c1"># Vehicle arrival behaviour</span>
</span><span id="Store.setup-2364"><a href="#Store.setup-2364"><span class="linenos">2364</span></a>        <span class="n">vehicle_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveVehicleArrival</span><span class="p">()</span>
</span><span id="Store.setup-2365"><a href="#Store.setup-2365"><span class="linenos">2365</span></a>        <span class="n">delivery_temp</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Store.setup-2366"><a href="#Store.setup-2366"><span class="linenos">2366</span></a>        <span class="n">delivery_temp</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">)</span>
</span><span id="Store.setup-2367"><a href="#Store.setup-2367"><span class="linenos">2367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">vehicle_behav</span><span class="p">,</span> <span class="n">delivery_temp</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Setup method called automatically by SPADE when agent starts.</p>

<p>This method initializes the agent's operational state and registers all
behaviours with appropriate message templates. It completes the agent
initialization process started in __init__, preparing the store for
active participation in the supply chain simulation.</p>

<h6 id="initialization-steps">Initialization Steps:</h6>

<blockquote>
  <ol>
  <li>Configure presence management (auto-approve subscriptions)</li>
  <li>Subscribe to all warehouses in contact list</li>
  <li>Initialize runtime state variables (stock, counters, queues)</li>
  <li>Register BuyProduct behaviour (periodic purchasing)</li>
  <li>Register ReceiveTimeDelta behaviour (time synchronization)</li>
  <li>Register RetryPreviousBuy behaviour (failed request retry)</li>
  <li>Register ReceiveVehicleArrival behaviour (delivery reception)</li>
  </ol>
</blockquote>

<h6 id="presence-configuration">Presence Configuration:</h6>

<blockquote>
  <ul>
  <li>presence.approve_all = True: Auto-accept all subscription requests</li>
  <li>Subscribes to each warehouse in contact_list</li>
  <li>Enables bidirectional communication with warehouses</li>
  </ul>
</blockquote>

<h6 id="state-initialization">State Initialization:</h6>

<blockquote>
  <ul>
  <li>stock: Empty dict (populated by deliveries)</li>
  <li>current_buy_request: None (set during purchase attempts)</li>
  <li>failed_requests: Empty FIFO queue (populated by failed negotiations)</li>
  <li>request_counter: 0 (incremented for each purchase request)</li>
  </ul>
</blockquote>

<h6 id="behaviour-registration">Behaviour Registration:</h6>

<blockquote>
  <ol>
  <li><p><strong>BuyProduct</strong> (PeriodicBehaviour):</p>
  
  <ul>
  <li>No template filter (self-triggered by period)</li>
  <li>Period: config.STORE_BUY_FREQUENCY seconds</li>
  <li>Purpose: Initiate FIPA Contract Net Protocol for purchases</li>
  </ul></li>
  <li><p><strong>ReceiveTimeDelta</strong> (CyclicBehaviour):</p>
  
  <ul>
  <li>Template: performative="inform"</li>
  <li>Purpose: Receive time updates and traffic data from world agent</li>
  <li>Continuous operation</li>
  </ul></li>
  <li><p><strong>RetryPreviousBuy</strong> (PeriodicBehaviour):</p>
  
  <ul>
  <li>No template filter (self-triggered)</li>
  <li>Period: 5 seconds</li>
  <li>Purpose: Retry failed purchase requests</li>
  </ul></li>
  <li><p><strong>ReceiveVehicleArrival</strong> (CyclicBehaviour):</p>
  
  <ul>
  <li>Template: performative="vehicle-delivery"</li>
  <li>Purpose: Receive delivery notifications and update stock</li>
  <li>Continuous operation</li>
  </ul></li>
  </ol>
</blockquote>

<h6 id="template-filtering">Template Filtering:</h6>

<blockquote>
  <p>Templates ensure behaviours only receive relevant messages:</p>
  
  <ul>
  <li>ReceiveTimeDelta: Only "inform" messages (from world agent)</li>
  <li>ReceiveVehicleArrival: Only "vehicle-delivery" messages (from vehicles)</li>
  <li>BuyProduct/RetryPreviousBuy: No template (time-triggered, not message-triggered)</li>
  </ul>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Sends presence subscription requests to all warehouses</li>
  <li>Adds four behaviours to agent's behaviour queue</li>
  <li>Prints subscription confirmations if verbose mode enabled</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Completes when all behaviours are registered and agent is operational.</p>
</blockquote>

<h6 id="example-flow">Example Flow:</h6>

<blockquote>
<pre><code>Agent Start:
    1. SPADE calls setup()
    2. Subscribe to warehouse1, warehouse2
    3. Initialize stock = {}
    4. Register BuyProduct (will start after 5s)
    5. Register ReceiveTimeDelta (active immediately)
    6. Register RetryPreviousBuy (checks every 5s)
    7. Register ReceiveVehicleArrival (active immediately)
    8. Agent ready for operation
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This method is asynchronous and is automatically called by SPADE's
  agent lifecycle management. Do not call this method manually.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Store.BuyProduct">
                            <input id="Store.BuyProduct-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Store.BuyProduct</span><wbr>(<span class="base">spade.behaviour.PeriodicBehaviour</span>):

                <label class="view-source-button" for="Store.BuyProduct-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.BuyProduct"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.BuyProduct-169"><a href="#Store.BuyProduct-169"><span class="linenos">169</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">BuyProduct</span><span class="p">(</span><span class="n">PeriodicBehaviour</span><span class="p">):</span>
</span><span id="Store.BuyProduct-170"><a href="#Store.BuyProduct-170"><span class="linenos">170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.BuyProduct-171"><a href="#Store.BuyProduct-171"><span class="linenos">171</span></a><span class="sd">        Periodic behaviour that initiates product purchase requests to warehouses.</span>
</span><span id="Store.BuyProduct-172"><a href="#Store.BuyProduct-172"><span class="linenos">172</span></a><span class="sd">        </span>
</span><span id="Store.BuyProduct-173"><a href="#Store.BuyProduct-173"><span class="linenos">173</span></a><span class="sd">        This behaviour implements the initiation phase of the FIPA Contract Net Protocol.</span>
</span><span id="Store.BuyProduct-174"><a href="#Store.BuyProduct-174"><span class="linenos">174</span></a><span class="sd">        It sends a Call for Proposals (CFP) to all available warehouses, requesting quotes</span>
</span><span id="Store.BuyProduct-175"><a href="#Store.BuyProduct-175"><span class="linenos">175</span></a><span class="sd">        for a specific product and quantity. The behaviour executes periodically but only</span>
</span><span id="Store.BuyProduct-176"><a href="#Store.BuyProduct-176"><span class="linenos">176</span></a><span class="sd">        proceeds with a purchase based on a configured probability threshold.</span>
</span><span id="Store.BuyProduct-177"><a href="#Store.BuyProduct-177"><span class="linenos">177</span></a><span class="sd">        </span>
</span><span id="Store.BuyProduct-178"><a href="#Store.BuyProduct-178"><span class="linenos">178</span></a><span class="sd">        FIPA Protocol Phase: **Call for Proposals (CFP)**</span>
</span><span id="Store.BuyProduct-179"><a href="#Store.BuyProduct-179"><span class="linenos">179</span></a><span class="sd">            - Role: Initiator (Store agent)</span>
</span><span id="Store.BuyProduct-180"><a href="#Store.BuyProduct-180"><span class="linenos">180</span></a><span class="sd">            - Participants: All warehouses in contact list</span>
</span><span id="Store.BuyProduct-181"><a href="#Store.BuyProduct-181"><span class="linenos">181</span></a><span class="sd">            - Message type: `store-buy` (FIPA CFP equivalent)</span>
</span><span id="Store.BuyProduct-182"><a href="#Store.BuyProduct-182"><span class="linenos">182</span></a><span class="sd">            - Protocol: FIPA Contract Net Protocol</span>
</span><span id="Store.BuyProduct-183"><a href="#Store.BuyProduct-183"><span class="linenos">183</span></a><span class="sd">        </span>
</span><span id="Store.BuyProduct-184"><a href="#Store.BuyProduct-184"><span class="linenos">184</span></a><span class="sd">        The behaviour uses randomization to select products and quantities for each purchase,</span>
</span><span id="Store.BuyProduct-185"><a href="#Store.BuyProduct-185"><span class="linenos">185</span></a><span class="sd">        ensuring varied and realistic purchasing patterns. It then delegates response collection</span>
</span><span id="Store.BuyProduct-186"><a href="#Store.BuyProduct-186"><span class="linenos">186</span></a><span class="sd">        and warehouse selection to the CollectWarehouseResponses coordinator behaviour.</span>
</span><span id="Store.BuyProduct-187"><a href="#Store.BuyProduct-187"><span class="linenos">187</span></a><span class="sd">        </span>
</span><span id="Store.BuyProduct-188"><a href="#Store.BuyProduct-188"><span class="linenos">188</span></a><span class="sd">        Attributes:</span>
</span><span id="Store.BuyProduct-189"><a href="#Store.BuyProduct-189"><span class="linenos">189</span></a><span class="sd">            quantity (Optional[int]): Fixed quantity to purchase. If None, randomizes each run</span>
</span><span id="Store.BuyProduct-190"><a href="#Store.BuyProduct-190"><span class="linenos">190</span></a><span class="sd">                between 1 and max_buy_quantity.</span>
</span><span id="Store.BuyProduct-191"><a href="#Store.BuyProduct-191"><span class="linenos">191</span></a><span class="sd">            product (Optional[str]): Fixed product to purchase. If None, randomly selects from</span>
</span><span id="Store.BuyProduct-192"><a href="#Store.BuyProduct-192"><span class="linenos">192</span></a><span class="sd">                config.PRODUCTS each run.</span>
</span><span id="Store.BuyProduct-193"><a href="#Store.BuyProduct-193"><span class="linenos">193</span></a><span class="sd">            period (float): Time interval between executions in seconds (from config).</span>
</span><span id="Store.BuyProduct-194"><a href="#Store.BuyProduct-194"><span class="linenos">194</span></a><span class="sd">            start_at (datetime): Timestamp when the behaviour should first execute.</span>
</span><span id="Store.BuyProduct-195"><a href="#Store.BuyProduct-195"><span class="linenos">195</span></a><span class="sd">        </span>
</span><span id="Store.BuyProduct-196"><a href="#Store.BuyProduct-196"><span class="linenos">196</span></a><span class="sd">        Message Format (FIPA CFP):</span>
</span><span id="Store.BuyProduct-197"><a href="#Store.BuyProduct-197"><span class="linenos">197</span></a><span class="sd">            Metadata:</span>
</span><span id="Store.BuyProduct-198"><a href="#Store.BuyProduct-198"><span class="linenos">198</span></a><span class="sd">                - performative: &quot;store-buy&quot; (FIPA CFP)</span>
</span><span id="Store.BuyProduct-199"><a href="#Store.BuyProduct-199"><span class="linenos">199</span></a><span class="sd">                - store_id: Store&#39;s JID</span>
</span><span id="Store.BuyProduct-200"><a href="#Store.BuyProduct-200"><span class="linenos">200</span></a><span class="sd">                - node_id: Store&#39;s graph node ID</span>
</span><span id="Store.BuyProduct-201"><a href="#Store.BuyProduct-201"><span class="linenos">201</span></a><span class="sd">                - request_id: Unique request ID using hierarchical encoding</span>
</span><span id="Store.BuyProduct-202"><a href="#Store.BuyProduct-202"><span class="linenos">202</span></a><span class="sd">            Body:</span>
</span><span id="Store.BuyProduct-203"><a href="#Store.BuyProduct-203"><span class="linenos">203</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.BuyProduct-204"><a href="#Store.BuyProduct-204"><span class="linenos">204</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="Store.BuyProduct-205"><a href="#Store.BuyProduct-205"><span class="linenos">205</span></a><span class="sd">        </span>
</span><span id="Store.BuyProduct-206"><a href="#Store.BuyProduct-206"><span class="linenos">206</span></a><span class="sd">        Workflow:</span>
</span><span id="Store.BuyProduct-207"><a href="#Store.BuyProduct-207"><span class="linenos">207</span></a><span class="sd">            1. Roll random number (1-100) to determine if purchase should occur</span>
</span><span id="Store.BuyProduct-208"><a href="#Store.BuyProduct-208"><span class="linenos">208</span></a><span class="sd">            2. Compare roll against buy_prob threshold; skip if roll fails</span>
</span><span id="Store.BuyProduct-209"><a href="#Store.BuyProduct-209"><span class="linenos">209</span></a><span class="sd">            3. Randomize or use fixed quantity and product</span>
</span><span id="Store.BuyProduct-210"><a href="#Store.BuyProduct-210"><span class="linenos">210</span></a><span class="sd">            4. Generate unique request_id using ID encoding: id_base + request_counter</span>
</span><span id="Store.BuyProduct-211"><a href="#Store.BuyProduct-211"><span class="linenos">211</span></a><span class="sd">            5. Broadcast CFP to all warehouses in contact list</span>
</span><span id="Store.BuyProduct-212"><a href="#Store.BuyProduct-212"><span class="linenos">212</span></a><span class="sd">            6. Launch CollectWarehouseResponses to handle FIPA negotiation protocol</span>
</span><span id="Store.BuyProduct-213"><a href="#Store.BuyProduct-213"><span class="linenos">213</span></a><span class="sd">            7. Wait for negotiation to complete</span>
</span><span id="Store.BuyProduct-214"><a href="#Store.BuyProduct-214"><span class="linenos">214</span></a><span class="sd">        </span>
</span><span id="Store.BuyProduct-215"><a href="#Store.BuyProduct-215"><span class="linenos">215</span></a><span class="sd">        Notes:</span>
</span><span id="Store.BuyProduct-216"><a href="#Store.BuyProduct-216"><span class="linenos">216</span></a><span class="sd">            - Uses local variables (not self.quantity/self.product) to ensure proper</span>
</span><span id="Store.BuyProduct-217"><a href="#Store.BuyProduct-217"><span class="linenos">217</span></a><span class="sd">              randomization on each execution cycle.</span>
</span><span id="Store.BuyProduct-218"><a href="#Store.BuyProduct-218"><span class="linenos">218</span></a><span class="sd">            - Each execution generates a new request_id to avoid conflicts.</span>
</span><span id="Store.BuyProduct-219"><a href="#Store.BuyProduct-219"><span class="linenos">219</span></a><span class="sd">            - Waits for CollectWarehouseResponses to complete before finishing.</span>
</span><span id="Store.BuyProduct-220"><a href="#Store.BuyProduct-220"><span class="linenos">220</span></a><span class="sd">            - Probability mechanism prevents constant purchasing, simulating realistic demand.</span>
</span><span id="Store.BuyProduct-221"><a href="#Store.BuyProduct-221"><span class="linenos">221</span></a><span class="sd">        </span>
</span><span id="Store.BuyProduct-222"><a href="#Store.BuyProduct-222"><span class="linenos">222</span></a><span class="sd">        Example:</span>
</span><span id="Store.BuyProduct-223"><a href="#Store.BuyProduct-223"><span class="linenos">223</span></a><span class="sd">            ```python</span>
</span><span id="Store.BuyProduct-224"><a href="#Store.BuyProduct-224"><span class="linenos">224</span></a><span class="sd">            # Random purchases from config product list</span>
</span><span id="Store.BuyProduct-225"><a href="#Store.BuyProduct-225"><span class="linenos">225</span></a><span class="sd">            buy_behav = store.BuyProduct()</span>
</span><span id="Store.BuyProduct-226"><a href="#Store.BuyProduct-226"><span class="linenos">226</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct-227"><a href="#Store.BuyProduct-227"><span class="linenos">227</span></a><span class="sd">            # Fixed product and quantity for testing</span>
</span><span id="Store.BuyProduct-228"><a href="#Store.BuyProduct-228"><span class="linenos">228</span></a><span class="sd">            buy_behav = store.BuyProduct(quantity=100, product=&quot;electronics&quot;)</span>
</span><span id="Store.BuyProduct-229"><a href="#Store.BuyProduct-229"><span class="linenos">229</span></a><span class="sd">            ```</span>
</span><span id="Store.BuyProduct-230"><a href="#Store.BuyProduct-230"><span class="linenos">230</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.BuyProduct-231"><a href="#Store.BuyProduct-231"><span class="linenos">231</span></a>
</span><span id="Store.BuyProduct-232"><a href="#Store.BuyProduct-232"><span class="linenos">232</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Store.BuyProduct-233"><a href="#Store.BuyProduct-233"><span class="linenos">233</span></a>                     <span class="n">quantity</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Store.BuyProduct-234"><a href="#Store.BuyProduct-234"><span class="linenos">234</span></a>                     <span class="n">product</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Store.BuyProduct-235"><a href="#Store.BuyProduct-235"><span class="linenos">235</span></a>                     <span class="n">period</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">STORE_BUY_FREQUENCY</span><span class="p">,</span>
</span><span id="Store.BuyProduct-236"><a href="#Store.BuyProduct-236"><span class="linenos">236</span></a>                     <span class="n">start_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)):</span>
</span><span id="Store.BuyProduct-237"><a href="#Store.BuyProduct-237"><span class="linenos">237</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.BuyProduct-238"><a href="#Store.BuyProduct-238"><span class="linenos">238</span></a><span class="sd">            Initialize the BuyProduct periodic behaviour.</span>
</span><span id="Store.BuyProduct-239"><a href="#Store.BuyProduct-239"><span class="linenos">239</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct-240"><a href="#Store.BuyProduct-240"><span class="linenos">240</span></a><span class="sd">            Args:</span>
</span><span id="Store.BuyProduct-241"><a href="#Store.BuyProduct-241"><span class="linenos">241</span></a><span class="sd">                quantity (Optional[int], optional): Fixed quantity to purchase each period.</span>
</span><span id="Store.BuyProduct-242"><a href="#Store.BuyProduct-242"><span class="linenos">242</span></a><span class="sd">                    If None, quantity is randomized between 1 and max_buy_quantity each run.</span>
</span><span id="Store.BuyProduct-243"><a href="#Store.BuyProduct-243"><span class="linenos">243</span></a><span class="sd">                    Defaults to None for varied purchasing patterns.</span>
</span><span id="Store.BuyProduct-244"><a href="#Store.BuyProduct-244"><span class="linenos">244</span></a><span class="sd">                product (Optional[str], optional): Fixed product name to purchase each period.</span>
</span><span id="Store.BuyProduct-245"><a href="#Store.BuyProduct-245"><span class="linenos">245</span></a><span class="sd">                    If None, product is randomly selected from config.PRODUCTS each run.</span>
</span><span id="Store.BuyProduct-246"><a href="#Store.BuyProduct-246"><span class="linenos">246</span></a><span class="sd">                    Defaults to None for varied product selection.</span>
</span><span id="Store.BuyProduct-247"><a href="#Store.BuyProduct-247"><span class="linenos">247</span></a><span class="sd">                period (float, optional): Time interval between executions in seconds.</span>
</span><span id="Store.BuyProduct-248"><a href="#Store.BuyProduct-248"><span class="linenos">248</span></a><span class="sd">                    Controls how frequently purchase attempts are made.</span>
</span><span id="Store.BuyProduct-249"><a href="#Store.BuyProduct-249"><span class="linenos">249</span></a><span class="sd">                    Defaults to config.STORE_BUY_FREQUENCY.</span>
</span><span id="Store.BuyProduct-250"><a href="#Store.BuyProduct-250"><span class="linenos">250</span></a><span class="sd">                start_at (datetime, optional): Timestamp when behaviour should first execute.</span>
</span><span id="Store.BuyProduct-251"><a href="#Store.BuyProduct-251"><span class="linenos">251</span></a><span class="sd">                    Allows delayed start for synchronized simulation initialization.</span>
</span><span id="Store.BuyProduct-252"><a href="#Store.BuyProduct-252"><span class="linenos">252</span></a><span class="sd">                    Defaults to 5 seconds from initialization time.</span>
</span><span id="Store.BuyProduct-253"><a href="#Store.BuyProduct-253"><span class="linenos">253</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct-254"><a href="#Store.BuyProduct-254"><span class="linenos">254</span></a><span class="sd">            Note:</span>
</span><span id="Store.BuyProduct-255"><a href="#Store.BuyProduct-255"><span class="linenos">255</span></a><span class="sd">                Using None for quantity and product (default) creates varied purchasing</span>
</span><span id="Store.BuyProduct-256"><a href="#Store.BuyProduct-256"><span class="linenos">256</span></a><span class="sd">                patterns that simulate realistic retail demand, while fixed values create</span>
</span><span id="Store.BuyProduct-257"><a href="#Store.BuyProduct-257"><span class="linenos">257</span></a><span class="sd">                predictable repeated orders useful for testing specific scenarios.</span>
</span><span id="Store.BuyProduct-258"><a href="#Store.BuyProduct-258"><span class="linenos">258</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.BuyProduct-259"><a href="#Store.BuyProduct-259"><span class="linenos">259</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">start_at</span><span class="o">=</span><span class="n">start_at</span><span class="p">)</span>
</span><span id="Store.BuyProduct-260"><a href="#Store.BuyProduct-260"><span class="linenos">260</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Store.BuyProduct-261"><a href="#Store.BuyProduct-261"><span class="linenos">261</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="Store.BuyProduct-262"><a href="#Store.BuyProduct-262"><span class="linenos">262</span></a>        
</span><span id="Store.BuyProduct-263"><a href="#Store.BuyProduct-263"><span class="linenos">263</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.BuyProduct-264"><a href="#Store.BuyProduct-264"><span class="linenos">264</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.BuyProduct-265"><a href="#Store.BuyProduct-265"><span class="linenos">265</span></a><span class="sd">            Execute one cycle of the purchase request behaviour.</span>
</span><span id="Store.BuyProduct-266"><a href="#Store.BuyProduct-266"><span class="linenos">266</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct-267"><a href="#Store.BuyProduct-267"><span class="linenos">267</span></a><span class="sd">            This method implements the probabilistic purchase initiation logic and</span>
</span><span id="Store.BuyProduct-268"><a href="#Store.BuyProduct-268"><span class="linenos">268</span></a><span class="sd">            broadcasts FIPA CFP messages to all warehouses. It uses randomization for</span>
</span><span id="Store.BuyProduct-269"><a href="#Store.BuyProduct-269"><span class="linenos">269</span></a><span class="sd">            both the purchase decision (based on buy_prob) and the product/quantity</span>
</span><span id="Store.BuyProduct-270"><a href="#Store.BuyProduct-270"><span class="linenos">270</span></a><span class="sd">            selection (unless fixed values were provided in __init__).</span>
</span><span id="Store.BuyProduct-271"><a href="#Store.BuyProduct-271"><span class="linenos">271</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct-272"><a href="#Store.BuyProduct-272"><span class="linenos">272</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Store.BuyProduct-273"><a href="#Store.BuyProduct-273"><span class="linenos">273</span></a><span class="sd">                - **Phase**: Call for Proposals (CFP) - Initiation</span>
</span><span id="Store.BuyProduct-274"><a href="#Store.BuyProduct-274"><span class="linenos">274</span></a><span class="sd">                - **Role**: Initiator</span>
</span><span id="Store.BuyProduct-275"><a href="#Store.BuyProduct-275"><span class="linenos">275</span></a><span class="sd">                - **Performative**: store-buy (FIPA CFP)</span>
</span><span id="Store.BuyProduct-276"><a href="#Store.BuyProduct-276"><span class="linenos">276</span></a><span class="sd">                - **Content**: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.BuyProduct-277"><a href="#Store.BuyProduct-277"><span class="linenos">277</span></a><span class="sd">                - **Receivers**: All warehouses in contact list (broadcast)</span>
</span><span id="Store.BuyProduct-278"><a href="#Store.BuyProduct-278"><span class="linenos">278</span></a><span class="sd">                - **Protocol**: FIPA Contract Net Protocol</span>
</span><span id="Store.BuyProduct-279"><a href="#Store.BuyProduct-279"><span class="linenos">279</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct-280"><a href="#Store.BuyProduct-280"><span class="linenos">280</span></a><span class="sd">            The method generates a unique request_id using the Store&#39;s hierarchical ID</span>
</span><span id="Store.BuyProduct-281"><a href="#Store.BuyProduct-281"><span class="linenos">281</span></a><span class="sd">            encoding system before broadcasting to ensure all responses can be properly</span>
</span><span id="Store.BuyProduct-282"><a href="#Store.BuyProduct-282"><span class="linenos">282</span></a><span class="sd">            matched to this specific request.</span>
</span><span id="Store.BuyProduct-283"><a href="#Store.BuyProduct-283"><span class="linenos">283</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct-284"><a href="#Store.BuyProduct-284"><span class="linenos">284</span></a><span class="sd">            Workflow:</span>
</span><span id="Store.BuyProduct-285"><a href="#Store.BuyProduct-285"><span class="linenos">285</span></a><span class="sd">                1. **Probability Check**: Roll random number (1-100) for purchase decision</span>
</span><span id="Store.BuyProduct-286"><a href="#Store.BuyProduct-286"><span class="linenos">286</span></a><span class="sd">                2. **Threshold Comparison**: Compare roll against buy_prob * 100</span>
</span><span id="Store.BuyProduct-287"><a href="#Store.BuyProduct-287"><span class="linenos">287</span></a><span class="sd">                3. **Early Return**: If roll fails, abort and wait for next period</span>
</span><span id="Store.BuyProduct-288"><a href="#Store.BuyProduct-288"><span class="linenos">288</span></a><span class="sd">                4. **Randomization**: Generate or use fixed quantity and product</span>
</span><span id="Store.BuyProduct-289"><a href="#Store.BuyProduct-289"><span class="linenos">289</span></a><span class="sd">                5. **ID Generation**: Create unique request_id from id_base + request_counter</span>
</span><span id="Store.BuyProduct-290"><a href="#Store.BuyProduct-290"><span class="linenos">290</span></a><span class="sd">                6. **CFP Broadcast**: Send store-buy message to all warehouses</span>
</span><span id="Store.BuyProduct-291"><a href="#Store.BuyProduct-291"><span class="linenos">291</span></a><span class="sd">                7. **Coordinator Launch**: Start CollectWarehouseResponses for negotiation</span>
</span><span id="Store.BuyProduct-292"><a href="#Store.BuyProduct-292"><span class="linenos">292</span></a><span class="sd">                8. **Synchronization**: Wait for coordinator to complete FIPA protocol</span>
</span><span id="Store.BuyProduct-293"><a href="#Store.BuyProduct-293"><span class="linenos">293</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct-294"><a href="#Store.BuyProduct-294"><span class="linenos">294</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.BuyProduct-295"><a href="#Store.BuyProduct-295"><span class="linenos">295</span></a><span class="sd">                - Increments agent.request_counter (ensures unique IDs)</span>
</span><span id="Store.BuyProduct-296"><a href="#Store.BuyProduct-296"><span class="linenos">296</span></a><span class="sd">                - Updates agent.current_buy_request with last sent message</span>
</span><span id="Store.BuyProduct-297"><a href="#Store.BuyProduct-297"><span class="linenos">297</span></a><span class="sd">                - Adds CollectWarehouseResponses behaviour to agent</span>
</span><span id="Store.BuyProduct-298"><a href="#Store.BuyProduct-298"><span class="linenos">298</span></a><span class="sd">                - May print debug information if verbose mode is enabled</span>
</span><span id="Store.BuyProduct-299"><a href="#Store.BuyProduct-299"><span class="linenos">299</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct-300"><a href="#Store.BuyProduct-300"><span class="linenos">300</span></a><span class="sd">            Returns:</span>
</span><span id="Store.BuyProduct-301"><a href="#Store.BuyProduct-301"><span class="linenos">301</span></a><span class="sd">                None. Completes when CollectWarehouseResponses finishes the negotiation</span>
</span><span id="Store.BuyProduct-302"><a href="#Store.BuyProduct-302"><span class="linenos">302</span></a><span class="sd">                process and a warehouse is selected (or request fails).</span>
</span><span id="Store.BuyProduct-303"><a href="#Store.BuyProduct-303"><span class="linenos">303</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct-304"><a href="#Store.BuyProduct-304"><span class="linenos">304</span></a><span class="sd">            Note:</span>
</span><span id="Store.BuyProduct-305"><a href="#Store.BuyProduct-305"><span class="linenos">305</span></a><span class="sd">                Uses local variables (quantity, product) instead of instance variables</span>
</span><span id="Store.BuyProduct-306"><a href="#Store.BuyProduct-306"><span class="linenos">306</span></a><span class="sd">                to ensure proper randomization on each execution. This prevents the bug</span>
</span><span id="Store.BuyProduct-307"><a href="#Store.BuyProduct-307"><span class="linenos">307</span></a><span class="sd">                where the same product/quantity would be used repeatedly.</span>
</span><span id="Store.BuyProduct-308"><a href="#Store.BuyProduct-308"><span class="linenos">308</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.BuyProduct-309"><a href="#Store.BuyProduct-309"><span class="linenos">309</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.BuyProduct-310"><a href="#Store.BuyProduct-310"><span class="linenos">310</span></a>            
</span><span id="Store.BuyProduct-311"><a href="#Store.BuyProduct-311"><span class="linenos">311</span></a>            <span class="n">roll</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
</span><span id="Store.BuyProduct-312"><a href="#Store.BuyProduct-312"><span class="linenos">312</span></a>            <span class="c1"># Decide whether to buy this turn based on probability</span>
</span><span id="Store.BuyProduct-313"><a href="#Store.BuyProduct-313"><span class="linenos">313</span></a>            <span class="k">if</span> <span class="n">roll</span> <span class="o">&gt;</span> <span class="n">agent</span><span class="o">.</span><span class="n">buy_prob</span> <span class="o">*</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="Store.BuyProduct-314"><a href="#Store.BuyProduct-314"><span class="linenos">314</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.BuyProduct-315"><a href="#Store.BuyProduct-315"><span class="linenos">315</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Decided NOT to buy this turn (roll=</span><span class="si">{</span><span class="n">roll</span><span class="si">}</span><span class="s2"> &gt; buy_prob=</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">buy_prob</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Store.BuyProduct-316"><a href="#Store.BuyProduct-316"><span class="linenos">316</span></a>                <span class="k">return</span>
</span><span id="Store.BuyProduct-317"><a href="#Store.BuyProduct-317"><span class="linenos">317</span></a>            <span class="k">else</span><span class="p">:</span> <span class="k">pass</span>
</span><span id="Store.BuyProduct-318"><a href="#Store.BuyProduct-318"><span class="linenos">318</span></a>            
</span><span id="Store.BuyProduct-319"><a href="#Store.BuyProduct-319"><span class="linenos">319</span></a>            <span class="c1"># Randomize quantity and product for each purchase</span>
</span><span id="Store.BuyProduct-320"><a href="#Store.BuyProduct-320"><span class="linenos">320</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="Store.BuyProduct-321"><a href="#Store.BuyProduct-321"><span class="linenos">321</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">max_buy_quantity</span><span class="p">)</span>
</span><span id="Store.BuyProduct-322"><a href="#Store.BuyProduct-322"><span class="linenos">322</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Store.BuyProduct-323"><a href="#Store.BuyProduct-323"><span class="linenos">323</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="Store.BuyProduct-324"><a href="#Store.BuyProduct-324"><span class="linenos">324</span></a>                
</span><span id="Store.BuyProduct-325"><a href="#Store.BuyProduct-325"><span class="linenos">325</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store.BuyProduct-326"><a href="#Store.BuyProduct-326"><span class="linenos">326</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">product_list</span><span class="p">)</span>
</span><span id="Store.BuyProduct-327"><a href="#Store.BuyProduct-327"><span class="linenos">327</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Store.BuyProduct-328"><a href="#Store.BuyProduct-328"><span class="linenos">328</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span>
</span><span id="Store.BuyProduct-329"><a href="#Store.BuyProduct-329"><span class="linenos">329</span></a>                
</span><span id="Store.BuyProduct-330"><a href="#Store.BuyProduct-330"><span class="linenos">330</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Preparing to buy </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.BuyProduct-331"><a href="#Store.BuyProduct-331"><span class="linenos">331</span></a>            
</span><span id="Store.BuyProduct-332"><a href="#Store.BuyProduct-332"><span class="linenos">332</span></a>            <span class="n">contacts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Store.BuyProduct-333"><a href="#Store.BuyProduct-333"><span class="linenos">333</span></a>            
</span><span id="Store.BuyProduct-334"><a href="#Store.BuyProduct-334"><span class="linenos">334</span></a>            <span class="c1"># Get request_id before sending - use ID encoding</span>
</span><span id="Store.BuyProduct-335"><a href="#Store.BuyProduct-335"><span class="linenos">335</span></a>            <span class="n">request_id_for_template</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">id_base</span> <span class="o">+</span> <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span>
</span><span id="Store.BuyProduct-336"><a href="#Store.BuyProduct-336"><span class="linenos">336</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Store.BuyProduct-337"><a href="#Store.BuyProduct-337"><span class="linenos">337</span></a>            
</span><span id="Store.BuyProduct-338"><a href="#Store.BuyProduct-338"><span class="linenos">338</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will store the last sent message for current_buy_request</span>
</span><span id="Store.BuyProduct-339"><a href="#Store.BuyProduct-339"><span class="linenos">339</span></a>            <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">:</span>
</span><span id="Store.BuyProduct-340"><a href="#Store.BuyProduct-340"><span class="linenos">340</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">contact</span><span class="p">)</span>
</span><span id="Store.BuyProduct-341"><a href="#Store.BuyProduct-341"><span class="linenos">341</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-buy&quot;</span><span class="p">)</span>
</span><span id="Store.BuyProduct-342"><a href="#Store.BuyProduct-342"><span class="linenos">342</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store.BuyProduct-343"><a href="#Store.BuyProduct-343"><span class="linenos">343</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Store.BuyProduct-344"><a href="#Store.BuyProduct-344"><span class="linenos">344</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id_for_template</span><span class="p">))</span>
</span><span id="Store.BuyProduct-345"><a href="#Store.BuyProduct-345"><span class="linenos">345</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Store.BuyProduct-346"><a href="#Store.BuyProduct-346"><span class="linenos">346</span></a>                
</span><span id="Store.BuyProduct-347"><a href="#Store.BuyProduct-347"><span class="linenos">347</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.BuyProduct-348"><a href="#Store.BuyProduct-348"><span class="linenos">348</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent request (id=</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;request_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="Store.BuyProduct-349"><a href="#Store.BuyProduct-349"><span class="linenos">349</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.BuyProduct-350"><a href="#Store.BuyProduct-350"><span class="linenos">350</span></a>                
</span><span id="Store.BuyProduct-351"><a href="#Store.BuyProduct-351"><span class="linenos">351</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.BuyProduct-352"><a href="#Store.BuyProduct-352"><span class="linenos">352</span></a>            
</span><span id="Store.BuyProduct-353"><a href="#Store.BuyProduct-353"><span class="linenos">353</span></a>            <span class="c1"># Store the last message (or could store all if needed)</span>
</span><span id="Store.BuyProduct-354"><a href="#Store.BuyProduct-354"><span class="linenos">354</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Store.BuyProduct-355"><a href="#Store.BuyProduct-355"><span class="linenos">355</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="Store.BuyProduct-356"><a href="#Store.BuyProduct-356"><span class="linenos">356</span></a>        
</span><span id="Store.BuyProduct-357"><a href="#Store.BuyProduct-357"><span class="linenos">357</span></a>                <span class="c1"># Collect responses from all warehouses</span>
</span><span id="Store.BuyProduct-358"><a href="#Store.BuyProduct-358"><span class="linenos">358</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectWarehouseResponses</span><span class="p">(</span>
</span><span id="Store.BuyProduct-359"><a href="#Store.BuyProduct-359"><span class="linenos">359</span></a>                    <span class="n">msg</span><span class="p">,</span> 
</span><span id="Store.BuyProduct-360"><a href="#Store.BuyProduct-360"><span class="linenos">360</span></a>                    <span class="n">request_id_for_template</span><span class="p">,</span> 
</span><span id="Store.BuyProduct-361"><a href="#Store.BuyProduct-361"><span class="linenos">361</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">contacts</span><span class="p">),</span>
</span><span id="Store.BuyProduct-362"><a href="#Store.BuyProduct-362"><span class="linenos">362</span></a>                    <span class="n">quantity</span><span class="p">,</span>
</span><span id="Store.BuyProduct-363"><a href="#Store.BuyProduct-363"><span class="linenos">363</span></a>                    <span class="n">product</span>
</span><span id="Store.BuyProduct-364"><a href="#Store.BuyProduct-364"><span class="linenos">364</span></a>                <span class="p">)</span>
</span><span id="Store.BuyProduct-365"><a href="#Store.BuyProduct-365"><span class="linenos">365</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Store.BuyProduct-366"><a href="#Store.BuyProduct-366"><span class="linenos">366</span></a>                
</span><span id="Store.BuyProduct-367"><a href="#Store.BuyProduct-367"><span class="linenos">367</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Periodic behaviour that initiates product purchase requests to warehouses.</p>

<p>This behaviour implements the initiation phase of the FIPA Contract Net Protocol.
It sends a Call for Proposals (CFP) to all available warehouses, requesting quotes
for a specific product and quantity. The behaviour executes periodically but only
proceeds with a purchase based on a configured probability threshold.</p>

<p>FIPA Protocol Phase: <strong>Call for Proposals (CFP)</strong>
    - Role: Initiator (Store agent)
    - Participants: All warehouses in contact list
    - Message type: <code>store-buy</code> (FIPA CFP equivalent)
    - Protocol: FIPA Contract Net Protocol</p>

<p>The behaviour uses randomization to select products and quantities for each purchase,
ensuring varied and realistic purchasing patterns. It then delegates response collection
and warehouse selection to the CollectWarehouseResponses coordinator behaviour.</p>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>quantity (Optional[int]):</strong>  Fixed quantity to purchase. If None, randomizes each run
between 1 and max_buy_quantity.</li>
<li><strong>product (Optional[str]):</strong>  Fixed product to purchase. If None, randomly selects from
config.PRODUCTS each run.</li>
<li><strong>period (float):</strong>  Time interval between executions in seconds (from config).</li>
<li><strong>start_at (datetime):</strong>  Timestamp when the behaviour should first execute.</li>
</ul>

<p>Message Format (FIPA CFP):
    Metadata:
        - performative: "store-buy" (FIPA CFP)
        - store_id: Store's JID
        - node_id: Store's graph node ID
        - request_id: Unique request ID using hierarchical encoding
    Body:
        - Format: "{quantity} {product}"
        - Example: "50 electronics"</p>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li>Roll random number (1-100) to determine if purchase should occur</li>
  <li>Compare roll against buy_prob threshold; skip if roll fails</li>
  <li>Randomize or use fixed quantity and product</li>
  <li>Generate unique request_id using ID encoding: id_base + request_counter</li>
  <li>Broadcast CFP to all warehouses in contact list</li>
  <li>Launch CollectWarehouseResponses to handle FIPA negotiation protocol</li>
  <li>Wait for negotiation to complete</li>
  </ol>
</blockquote>

<h6 id="notes">Notes:</h6>

<blockquote>
  <ul>
  <li>Uses local variables (not self.quantity/self.product) to ensure proper
  randomization on each execution cycle.</li>
  <li>Each execution generates a new request_id to avoid conflicts.</li>
  <li>Waits for CollectWarehouseResponses to complete before finishing.</li>
  <li>Probability mechanism prevents constant purchasing, simulating realistic demand.</li>
  </ul>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># Random purchases from config product list</span>
<span class="n">buy_behav</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">BuyProduct</span><span class="p">()</span>

<span class="c1"># Fixed product and quantity for testing</span>
<span class="n">buy_behav</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">BuyProduct</span><span class="p">(</span><span class="n">quantity</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">product</span><span class="o">=</span><span class="s2">&quot;electronics&quot;</span><span class="p">)</span>
</code></pre>
  </div>
</blockquote>
</div>


                            <div id="Store.BuyProduct.__init__" class="classattr">
                                        <input id="Store.BuyProduct.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Store.BuyProduct</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">quantity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">product</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">period</span><span class="o">=</span><span class="mi">5</span>,</span><span class="param">	<span class="n">start_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">911273</span><span class="p">)</span></span>)</span>

                <label class="view-source-button" for="Store.BuyProduct.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.BuyProduct.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.BuyProduct.__init__-232"><a href="#Store.BuyProduct.__init__-232"><span class="linenos">232</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="Store.BuyProduct.__init__-233"><a href="#Store.BuyProduct.__init__-233"><span class="linenos">233</span></a>                     <span class="n">quantity</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Store.BuyProduct.__init__-234"><a href="#Store.BuyProduct.__init__-234"><span class="linenos">234</span></a>                     <span class="n">product</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Store.BuyProduct.__init__-235"><a href="#Store.BuyProduct.__init__-235"><span class="linenos">235</span></a>                     <span class="n">period</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">STORE_BUY_FREQUENCY</span><span class="p">,</span>
</span><span id="Store.BuyProduct.__init__-236"><a href="#Store.BuyProduct.__init__-236"><span class="linenos">236</span></a>                     <span class="n">start_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)):</span>
</span><span id="Store.BuyProduct.__init__-237"><a href="#Store.BuyProduct.__init__-237"><span class="linenos">237</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.BuyProduct.__init__-238"><a href="#Store.BuyProduct.__init__-238"><span class="linenos">238</span></a><span class="sd">            Initialize the BuyProduct periodic behaviour.</span>
</span><span id="Store.BuyProduct.__init__-239"><a href="#Store.BuyProduct.__init__-239"><span class="linenos">239</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct.__init__-240"><a href="#Store.BuyProduct.__init__-240"><span class="linenos">240</span></a><span class="sd">            Args:</span>
</span><span id="Store.BuyProduct.__init__-241"><a href="#Store.BuyProduct.__init__-241"><span class="linenos">241</span></a><span class="sd">                quantity (Optional[int], optional): Fixed quantity to purchase each period.</span>
</span><span id="Store.BuyProduct.__init__-242"><a href="#Store.BuyProduct.__init__-242"><span class="linenos">242</span></a><span class="sd">                    If None, quantity is randomized between 1 and max_buy_quantity each run.</span>
</span><span id="Store.BuyProduct.__init__-243"><a href="#Store.BuyProduct.__init__-243"><span class="linenos">243</span></a><span class="sd">                    Defaults to None for varied purchasing patterns.</span>
</span><span id="Store.BuyProduct.__init__-244"><a href="#Store.BuyProduct.__init__-244"><span class="linenos">244</span></a><span class="sd">                product (Optional[str], optional): Fixed product name to purchase each period.</span>
</span><span id="Store.BuyProduct.__init__-245"><a href="#Store.BuyProduct.__init__-245"><span class="linenos">245</span></a><span class="sd">                    If None, product is randomly selected from config.PRODUCTS each run.</span>
</span><span id="Store.BuyProduct.__init__-246"><a href="#Store.BuyProduct.__init__-246"><span class="linenos">246</span></a><span class="sd">                    Defaults to None for varied product selection.</span>
</span><span id="Store.BuyProduct.__init__-247"><a href="#Store.BuyProduct.__init__-247"><span class="linenos">247</span></a><span class="sd">                period (float, optional): Time interval between executions in seconds.</span>
</span><span id="Store.BuyProduct.__init__-248"><a href="#Store.BuyProduct.__init__-248"><span class="linenos">248</span></a><span class="sd">                    Controls how frequently purchase attempts are made.</span>
</span><span id="Store.BuyProduct.__init__-249"><a href="#Store.BuyProduct.__init__-249"><span class="linenos">249</span></a><span class="sd">                    Defaults to config.STORE_BUY_FREQUENCY.</span>
</span><span id="Store.BuyProduct.__init__-250"><a href="#Store.BuyProduct.__init__-250"><span class="linenos">250</span></a><span class="sd">                start_at (datetime, optional): Timestamp when behaviour should first execute.</span>
</span><span id="Store.BuyProduct.__init__-251"><a href="#Store.BuyProduct.__init__-251"><span class="linenos">251</span></a><span class="sd">                    Allows delayed start for synchronized simulation initialization.</span>
</span><span id="Store.BuyProduct.__init__-252"><a href="#Store.BuyProduct.__init__-252"><span class="linenos">252</span></a><span class="sd">                    Defaults to 5 seconds from initialization time.</span>
</span><span id="Store.BuyProduct.__init__-253"><a href="#Store.BuyProduct.__init__-253"><span class="linenos">253</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct.__init__-254"><a href="#Store.BuyProduct.__init__-254"><span class="linenos">254</span></a><span class="sd">            Note:</span>
</span><span id="Store.BuyProduct.__init__-255"><a href="#Store.BuyProduct.__init__-255"><span class="linenos">255</span></a><span class="sd">                Using None for quantity and product (default) creates varied purchasing</span>
</span><span id="Store.BuyProduct.__init__-256"><a href="#Store.BuyProduct.__init__-256"><span class="linenos">256</span></a><span class="sd">                patterns that simulate realistic retail demand, while fixed values create</span>
</span><span id="Store.BuyProduct.__init__-257"><a href="#Store.BuyProduct.__init__-257"><span class="linenos">257</span></a><span class="sd">                predictable repeated orders useful for testing specific scenarios.</span>
</span><span id="Store.BuyProduct.__init__-258"><a href="#Store.BuyProduct.__init__-258"><span class="linenos">258</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.BuyProduct.__init__-259"><a href="#Store.BuyProduct.__init__-259"><span class="linenos">259</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">start_at</span><span class="o">=</span><span class="n">start_at</span><span class="p">)</span>
</span><span id="Store.BuyProduct.__init__-260"><a href="#Store.BuyProduct.__init__-260"><span class="linenos">260</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Store.BuyProduct.__init__-261"><a href="#Store.BuyProduct.__init__-261"><span class="linenos">261</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the BuyProduct periodic behaviour.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>quantity (Optional[int], optional):</strong>  Fixed quantity to purchase each period.
If None, quantity is randomized between 1 and max_buy_quantity each run.
Defaults to None for varied purchasing patterns.</li>
<li><strong>product (Optional[str], optional):</strong>  Fixed product name to purchase each period.
If None, product is randomly selected from config.PRODUCTS each run.
Defaults to None for varied product selection.</li>
<li><strong>period (float, optional):</strong>  Time interval between executions in seconds.
Controls how frequently purchase attempts are made.
Defaults to config.STORE_BUY_FREQUENCY.</li>
<li><strong>start_at (datetime, optional):</strong>  Timestamp when behaviour should first execute.
Allows delayed start for synchronized simulation initialization.
Defaults to 5 seconds from initialization time.</li>
</ul>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Using None for quantity and product (default) creates varied purchasing
  patterns that simulate realistic retail demand, while fixed values create
  predictable repeated orders useful for testing specific scenarios.</p>
</blockquote>
</div>


                            </div>
                            <div id="Store.BuyProduct.quantity" class="classattr">
                                <div class="attr variable">
            <span class="name">quantity</span>

        
    </div>
    <a class="headerlink" href="#Store.BuyProduct.quantity"></a>
    
    

                            </div>
                            <div id="Store.BuyProduct.product" class="classattr">
                                <div class="attr variable">
            <span class="name">product</span>

        
    </div>
    <a class="headerlink" href="#Store.BuyProduct.product"></a>
    
    

                            </div>
                            <div id="Store.BuyProduct.run" class="classattr">
                                        <input id="Store.BuyProduct.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Store.BuyProduct.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.BuyProduct.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.BuyProduct.run-263"><a href="#Store.BuyProduct.run-263"><span class="linenos">263</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.BuyProduct.run-264"><a href="#Store.BuyProduct.run-264"><span class="linenos">264</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.BuyProduct.run-265"><a href="#Store.BuyProduct.run-265"><span class="linenos">265</span></a><span class="sd">            Execute one cycle of the purchase request behaviour.</span>
</span><span id="Store.BuyProduct.run-266"><a href="#Store.BuyProduct.run-266"><span class="linenos">266</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct.run-267"><a href="#Store.BuyProduct.run-267"><span class="linenos">267</span></a><span class="sd">            This method implements the probabilistic purchase initiation logic and</span>
</span><span id="Store.BuyProduct.run-268"><a href="#Store.BuyProduct.run-268"><span class="linenos">268</span></a><span class="sd">            broadcasts FIPA CFP messages to all warehouses. It uses randomization for</span>
</span><span id="Store.BuyProduct.run-269"><a href="#Store.BuyProduct.run-269"><span class="linenos">269</span></a><span class="sd">            both the purchase decision (based on buy_prob) and the product/quantity</span>
</span><span id="Store.BuyProduct.run-270"><a href="#Store.BuyProduct.run-270"><span class="linenos">270</span></a><span class="sd">            selection (unless fixed values were provided in __init__).</span>
</span><span id="Store.BuyProduct.run-271"><a href="#Store.BuyProduct.run-271"><span class="linenos">271</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct.run-272"><a href="#Store.BuyProduct.run-272"><span class="linenos">272</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Store.BuyProduct.run-273"><a href="#Store.BuyProduct.run-273"><span class="linenos">273</span></a><span class="sd">                - **Phase**: Call for Proposals (CFP) - Initiation</span>
</span><span id="Store.BuyProduct.run-274"><a href="#Store.BuyProduct.run-274"><span class="linenos">274</span></a><span class="sd">                - **Role**: Initiator</span>
</span><span id="Store.BuyProduct.run-275"><a href="#Store.BuyProduct.run-275"><span class="linenos">275</span></a><span class="sd">                - **Performative**: store-buy (FIPA CFP)</span>
</span><span id="Store.BuyProduct.run-276"><a href="#Store.BuyProduct.run-276"><span class="linenos">276</span></a><span class="sd">                - **Content**: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.BuyProduct.run-277"><a href="#Store.BuyProduct.run-277"><span class="linenos">277</span></a><span class="sd">                - **Receivers**: All warehouses in contact list (broadcast)</span>
</span><span id="Store.BuyProduct.run-278"><a href="#Store.BuyProduct.run-278"><span class="linenos">278</span></a><span class="sd">                - **Protocol**: FIPA Contract Net Protocol</span>
</span><span id="Store.BuyProduct.run-279"><a href="#Store.BuyProduct.run-279"><span class="linenos">279</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct.run-280"><a href="#Store.BuyProduct.run-280"><span class="linenos">280</span></a><span class="sd">            The method generates a unique request_id using the Store&#39;s hierarchical ID</span>
</span><span id="Store.BuyProduct.run-281"><a href="#Store.BuyProduct.run-281"><span class="linenos">281</span></a><span class="sd">            encoding system before broadcasting to ensure all responses can be properly</span>
</span><span id="Store.BuyProduct.run-282"><a href="#Store.BuyProduct.run-282"><span class="linenos">282</span></a><span class="sd">            matched to this specific request.</span>
</span><span id="Store.BuyProduct.run-283"><a href="#Store.BuyProduct.run-283"><span class="linenos">283</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct.run-284"><a href="#Store.BuyProduct.run-284"><span class="linenos">284</span></a><span class="sd">            Workflow:</span>
</span><span id="Store.BuyProduct.run-285"><a href="#Store.BuyProduct.run-285"><span class="linenos">285</span></a><span class="sd">                1. **Probability Check**: Roll random number (1-100) for purchase decision</span>
</span><span id="Store.BuyProduct.run-286"><a href="#Store.BuyProduct.run-286"><span class="linenos">286</span></a><span class="sd">                2. **Threshold Comparison**: Compare roll against buy_prob * 100</span>
</span><span id="Store.BuyProduct.run-287"><a href="#Store.BuyProduct.run-287"><span class="linenos">287</span></a><span class="sd">                3. **Early Return**: If roll fails, abort and wait for next period</span>
</span><span id="Store.BuyProduct.run-288"><a href="#Store.BuyProduct.run-288"><span class="linenos">288</span></a><span class="sd">                4. **Randomization**: Generate or use fixed quantity and product</span>
</span><span id="Store.BuyProduct.run-289"><a href="#Store.BuyProduct.run-289"><span class="linenos">289</span></a><span class="sd">                5. **ID Generation**: Create unique request_id from id_base + request_counter</span>
</span><span id="Store.BuyProduct.run-290"><a href="#Store.BuyProduct.run-290"><span class="linenos">290</span></a><span class="sd">                6. **CFP Broadcast**: Send store-buy message to all warehouses</span>
</span><span id="Store.BuyProduct.run-291"><a href="#Store.BuyProduct.run-291"><span class="linenos">291</span></a><span class="sd">                7. **Coordinator Launch**: Start CollectWarehouseResponses for negotiation</span>
</span><span id="Store.BuyProduct.run-292"><a href="#Store.BuyProduct.run-292"><span class="linenos">292</span></a><span class="sd">                8. **Synchronization**: Wait for coordinator to complete FIPA protocol</span>
</span><span id="Store.BuyProduct.run-293"><a href="#Store.BuyProduct.run-293"><span class="linenos">293</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct.run-294"><a href="#Store.BuyProduct.run-294"><span class="linenos">294</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.BuyProduct.run-295"><a href="#Store.BuyProduct.run-295"><span class="linenos">295</span></a><span class="sd">                - Increments agent.request_counter (ensures unique IDs)</span>
</span><span id="Store.BuyProduct.run-296"><a href="#Store.BuyProduct.run-296"><span class="linenos">296</span></a><span class="sd">                - Updates agent.current_buy_request with last sent message</span>
</span><span id="Store.BuyProduct.run-297"><a href="#Store.BuyProduct.run-297"><span class="linenos">297</span></a><span class="sd">                - Adds CollectWarehouseResponses behaviour to agent</span>
</span><span id="Store.BuyProduct.run-298"><a href="#Store.BuyProduct.run-298"><span class="linenos">298</span></a><span class="sd">                - May print debug information if verbose mode is enabled</span>
</span><span id="Store.BuyProduct.run-299"><a href="#Store.BuyProduct.run-299"><span class="linenos">299</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct.run-300"><a href="#Store.BuyProduct.run-300"><span class="linenos">300</span></a><span class="sd">            Returns:</span>
</span><span id="Store.BuyProduct.run-301"><a href="#Store.BuyProduct.run-301"><span class="linenos">301</span></a><span class="sd">                None. Completes when CollectWarehouseResponses finishes the negotiation</span>
</span><span id="Store.BuyProduct.run-302"><a href="#Store.BuyProduct.run-302"><span class="linenos">302</span></a><span class="sd">                process and a warehouse is selected (or request fails).</span>
</span><span id="Store.BuyProduct.run-303"><a href="#Store.BuyProduct.run-303"><span class="linenos">303</span></a><span class="sd">            </span>
</span><span id="Store.BuyProduct.run-304"><a href="#Store.BuyProduct.run-304"><span class="linenos">304</span></a><span class="sd">            Note:</span>
</span><span id="Store.BuyProduct.run-305"><a href="#Store.BuyProduct.run-305"><span class="linenos">305</span></a><span class="sd">                Uses local variables (quantity, product) instead of instance variables</span>
</span><span id="Store.BuyProduct.run-306"><a href="#Store.BuyProduct.run-306"><span class="linenos">306</span></a><span class="sd">                to ensure proper randomization on each execution. This prevents the bug</span>
</span><span id="Store.BuyProduct.run-307"><a href="#Store.BuyProduct.run-307"><span class="linenos">307</span></a><span class="sd">                where the same product/quantity would be used repeatedly.</span>
</span><span id="Store.BuyProduct.run-308"><a href="#Store.BuyProduct.run-308"><span class="linenos">308</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.BuyProduct.run-309"><a href="#Store.BuyProduct.run-309"><span class="linenos">309</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.BuyProduct.run-310"><a href="#Store.BuyProduct.run-310"><span class="linenos">310</span></a>            
</span><span id="Store.BuyProduct.run-311"><a href="#Store.BuyProduct.run-311"><span class="linenos">311</span></a>            <span class="n">roll</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
</span><span id="Store.BuyProduct.run-312"><a href="#Store.BuyProduct.run-312"><span class="linenos">312</span></a>            <span class="c1"># Decide whether to buy this turn based on probability</span>
</span><span id="Store.BuyProduct.run-313"><a href="#Store.BuyProduct.run-313"><span class="linenos">313</span></a>            <span class="k">if</span> <span class="n">roll</span> <span class="o">&gt;</span> <span class="n">agent</span><span class="o">.</span><span class="n">buy_prob</span> <span class="o">*</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="Store.BuyProduct.run-314"><a href="#Store.BuyProduct.run-314"><span class="linenos">314</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.BuyProduct.run-315"><a href="#Store.BuyProduct.run-315"><span class="linenos">315</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Decided NOT to buy this turn (roll=</span><span class="si">{</span><span class="n">roll</span><span class="si">}</span><span class="s2"> &gt; buy_prob=</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">buy_prob</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Store.BuyProduct.run-316"><a href="#Store.BuyProduct.run-316"><span class="linenos">316</span></a>                <span class="k">return</span>
</span><span id="Store.BuyProduct.run-317"><a href="#Store.BuyProduct.run-317"><span class="linenos">317</span></a>            <span class="k">else</span><span class="p">:</span> <span class="k">pass</span>
</span><span id="Store.BuyProduct.run-318"><a href="#Store.BuyProduct.run-318"><span class="linenos">318</span></a>            
</span><span id="Store.BuyProduct.run-319"><a href="#Store.BuyProduct.run-319"><span class="linenos">319</span></a>            <span class="c1"># Randomize quantity and product for each purchase</span>
</span><span id="Store.BuyProduct.run-320"><a href="#Store.BuyProduct.run-320"><span class="linenos">320</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="Store.BuyProduct.run-321"><a href="#Store.BuyProduct.run-321"><span class="linenos">321</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">max_buy_quantity</span><span class="p">)</span>
</span><span id="Store.BuyProduct.run-322"><a href="#Store.BuyProduct.run-322"><span class="linenos">322</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Store.BuyProduct.run-323"><a href="#Store.BuyProduct.run-323"><span class="linenos">323</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="Store.BuyProduct.run-324"><a href="#Store.BuyProduct.run-324"><span class="linenos">324</span></a>                
</span><span id="Store.BuyProduct.run-325"><a href="#Store.BuyProduct.run-325"><span class="linenos">325</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store.BuyProduct.run-326"><a href="#Store.BuyProduct.run-326"><span class="linenos">326</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">product_list</span><span class="p">)</span>
</span><span id="Store.BuyProduct.run-327"><a href="#Store.BuyProduct.run-327"><span class="linenos">327</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Store.BuyProduct.run-328"><a href="#Store.BuyProduct.run-328"><span class="linenos">328</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span>
</span><span id="Store.BuyProduct.run-329"><a href="#Store.BuyProduct.run-329"><span class="linenos">329</span></a>                
</span><span id="Store.BuyProduct.run-330"><a href="#Store.BuyProduct.run-330"><span class="linenos">330</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Preparing to buy </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.BuyProduct.run-331"><a href="#Store.BuyProduct.run-331"><span class="linenos">331</span></a>            
</span><span id="Store.BuyProduct.run-332"><a href="#Store.BuyProduct.run-332"><span class="linenos">332</span></a>            <span class="n">contacts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Store.BuyProduct.run-333"><a href="#Store.BuyProduct.run-333"><span class="linenos">333</span></a>            
</span><span id="Store.BuyProduct.run-334"><a href="#Store.BuyProduct.run-334"><span class="linenos">334</span></a>            <span class="c1"># Get request_id before sending - use ID encoding</span>
</span><span id="Store.BuyProduct.run-335"><a href="#Store.BuyProduct.run-335"><span class="linenos">335</span></a>            <span class="n">request_id_for_template</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">id_base</span> <span class="o">+</span> <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span>
</span><span id="Store.BuyProduct.run-336"><a href="#Store.BuyProduct.run-336"><span class="linenos">336</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Store.BuyProduct.run-337"><a href="#Store.BuyProduct.run-337"><span class="linenos">337</span></a>            
</span><span id="Store.BuyProduct.run-338"><a href="#Store.BuyProduct.run-338"><span class="linenos">338</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will store the last sent message for current_buy_request</span>
</span><span id="Store.BuyProduct.run-339"><a href="#Store.BuyProduct.run-339"><span class="linenos">339</span></a>            <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">:</span>
</span><span id="Store.BuyProduct.run-340"><a href="#Store.BuyProduct.run-340"><span class="linenos">340</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">contact</span><span class="p">)</span>
</span><span id="Store.BuyProduct.run-341"><a href="#Store.BuyProduct.run-341"><span class="linenos">341</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-buy&quot;</span><span class="p">)</span>
</span><span id="Store.BuyProduct.run-342"><a href="#Store.BuyProduct.run-342"><span class="linenos">342</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store.BuyProduct.run-343"><a href="#Store.BuyProduct.run-343"><span class="linenos">343</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Store.BuyProduct.run-344"><a href="#Store.BuyProduct.run-344"><span class="linenos">344</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id_for_template</span><span class="p">))</span>
</span><span id="Store.BuyProduct.run-345"><a href="#Store.BuyProduct.run-345"><span class="linenos">345</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Store.BuyProduct.run-346"><a href="#Store.BuyProduct.run-346"><span class="linenos">346</span></a>                
</span><span id="Store.BuyProduct.run-347"><a href="#Store.BuyProduct.run-347"><span class="linenos">347</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.BuyProduct.run-348"><a href="#Store.BuyProduct.run-348"><span class="linenos">348</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent request (id=</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;request_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="Store.BuyProduct.run-349"><a href="#Store.BuyProduct.run-349"><span class="linenos">349</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.BuyProduct.run-350"><a href="#Store.BuyProduct.run-350"><span class="linenos">350</span></a>                
</span><span id="Store.BuyProduct.run-351"><a href="#Store.BuyProduct.run-351"><span class="linenos">351</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.BuyProduct.run-352"><a href="#Store.BuyProduct.run-352"><span class="linenos">352</span></a>            
</span><span id="Store.BuyProduct.run-353"><a href="#Store.BuyProduct.run-353"><span class="linenos">353</span></a>            <span class="c1"># Store the last message (or could store all if needed)</span>
</span><span id="Store.BuyProduct.run-354"><a href="#Store.BuyProduct.run-354"><span class="linenos">354</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Store.BuyProduct.run-355"><a href="#Store.BuyProduct.run-355"><span class="linenos">355</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="Store.BuyProduct.run-356"><a href="#Store.BuyProduct.run-356"><span class="linenos">356</span></a>        
</span><span id="Store.BuyProduct.run-357"><a href="#Store.BuyProduct.run-357"><span class="linenos">357</span></a>                <span class="c1"># Collect responses from all warehouses</span>
</span><span id="Store.BuyProduct.run-358"><a href="#Store.BuyProduct.run-358"><span class="linenos">358</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectWarehouseResponses</span><span class="p">(</span>
</span><span id="Store.BuyProduct.run-359"><a href="#Store.BuyProduct.run-359"><span class="linenos">359</span></a>                    <span class="n">msg</span><span class="p">,</span> 
</span><span id="Store.BuyProduct.run-360"><a href="#Store.BuyProduct.run-360"><span class="linenos">360</span></a>                    <span class="n">request_id_for_template</span><span class="p">,</span> 
</span><span id="Store.BuyProduct.run-361"><a href="#Store.BuyProduct.run-361"><span class="linenos">361</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">contacts</span><span class="p">),</span>
</span><span id="Store.BuyProduct.run-362"><a href="#Store.BuyProduct.run-362"><span class="linenos">362</span></a>                    <span class="n">quantity</span><span class="p">,</span>
</span><span id="Store.BuyProduct.run-363"><a href="#Store.BuyProduct.run-363"><span class="linenos">363</span></a>                    <span class="n">product</span>
</span><span id="Store.BuyProduct.run-364"><a href="#Store.BuyProduct.run-364"><span class="linenos">364</span></a>                <span class="p">)</span>
</span><span id="Store.BuyProduct.run-365"><a href="#Store.BuyProduct.run-365"><span class="linenos">365</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Store.BuyProduct.run-366"><a href="#Store.BuyProduct.run-366"><span class="linenos">366</span></a>                
</span><span id="Store.BuyProduct.run-367"><a href="#Store.BuyProduct.run-367"><span class="linenos">367</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Execute one cycle of the purchase request behaviour.</p>

<p>This method implements the probabilistic purchase initiation logic and
broadcasts FIPA CFP messages to all warehouses. It uses randomization for
both the purchase decision (based on buy_prob) and the product/quantity
selection (unless fixed values were provided in __init__).</p>

<h6 id="fipa-protocol-implementation">FIPA Protocol Implementation:</h6>

<blockquote>
  <ul>
  <li><strong>Phase</strong>: Call for Proposals (CFP) - Initiation</li>
  <li><strong>Role</strong>: Initiator</li>
  <li><strong>Performative</strong>: store-buy (FIPA CFP)</li>
  <li><strong>Content</strong>: "{quantity} {product}"</li>
  <li><strong>Receivers</strong>: All warehouses in contact list (broadcast)</li>
  <li><strong>Protocol</strong>: FIPA Contract Net Protocol</li>
  </ul>
</blockquote>

<p>The method generates a unique request_id using the Store's hierarchical ID
encoding system before broadcasting to ensure all responses can be properly
matched to this specific request.</p>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Probability Check</strong>: Roll random number (1-100) for purchase decision</li>
  <li><strong>Threshold Comparison</strong>: Compare roll against buy_prob * 100</li>
  <li><strong>Early Return</strong>: If roll fails, abort and wait for next period</li>
  <li><strong>Randomization</strong>: Generate or use fixed quantity and product</li>
  <li><strong>ID Generation</strong>: Create unique request_id from id_base + request_counter</li>
  <li><strong>CFP Broadcast</strong>: Send store-buy message to all warehouses</li>
  <li><strong>Coordinator Launch</strong>: Start CollectWarehouseResponses for negotiation</li>
  <li><strong>Synchronization</strong>: Wait for coordinator to complete FIPA protocol</li>
  </ol>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Increments agent.request_counter (ensures unique IDs)</li>
  <li>Updates agent.current_buy_request with last sent message</li>
  <li>Adds CollectWarehouseResponses behaviour to agent</li>
  <li>May print debug information if verbose mode is enabled</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Completes when CollectWarehouseResponses finishes the negotiation
  process and a warehouse is selected (or request fails).</p>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Uses local variables (quantity, product) instead of instance variables
  to ensure proper randomization on each execution. This prevents the bug
  where the same product/quantity would be used repeatedly.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Store.CollectWarehouseResponses">
                            <input id="Store.CollectWarehouseResponses-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Store.CollectWarehouseResponses</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Store.CollectWarehouseResponses-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.CollectWarehouseResponses"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.CollectWarehouseResponses-369"><a href="#Store.CollectWarehouseResponses-369"><span class="linenos">369</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">CollectWarehouseResponses</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Store.CollectWarehouseResponses-370"><a href="#Store.CollectWarehouseResponses-370"><span class="linenos">370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.CollectWarehouseResponses-371"><a href="#Store.CollectWarehouseResponses-371"><span class="linenos">371</span></a><span class="sd">        Coordinator behaviour for FIPA Contract Net Protocol implementation.</span>
</span><span id="Store.CollectWarehouseResponses-372"><a href="#Store.CollectWarehouseResponses-372"><span class="linenos">372</span></a><span class="sd">        </span>
</span><span id="Store.CollectWarehouseResponses-373"><a href="#Store.CollectWarehouseResponses-373"><span class="linenos">373</span></a><span class="sd">        This behaviour orchestrates the proposal collection, evaluation, and award phases</span>
</span><span id="Store.CollectWarehouseResponses-374"><a href="#Store.CollectWarehouseResponses-374"><span class="linenos">374</span></a><span class="sd">        of the FIPA Contract Net Protocol. It acts as the coordinator (initiator) that</span>
</span><span id="Store.CollectWarehouseResponses-375"><a href="#Store.CollectWarehouseResponses-375"><span class="linenos">375</span></a><span class="sd">        manages the negotiation process with multiple warehouses, collects their responses,</span>
</span><span id="Store.CollectWarehouseResponses-376"><a href="#Store.CollectWarehouseResponses-376"><span class="linenos">376</span></a><span class="sd">        and selects the best proposal based on a distance-based scoring function.</span>
</span><span id="Store.CollectWarehouseResponses-377"><a href="#Store.CollectWarehouseResponses-377"><span class="linenos">377</span></a><span class="sd">        </span>
</span><span id="Store.CollectWarehouseResponses-378"><a href="#Store.CollectWarehouseResponses-378"><span class="linenos">378</span></a><span class="sd">        FIPA Protocol Phases Implemented:</span>
</span><span id="Store.CollectWarehouseResponses-379"><a href="#Store.CollectWarehouseResponses-379"><span class="linenos">379</span></a><span class="sd">            1. **Proposal Reception**: Collects warehouse responses (propose/refuse)</span>
</span><span id="Store.CollectWarehouseResponses-380"><a href="#Store.CollectWarehouseResponses-380"><span class="linenos">380</span></a><span class="sd">            2. **Proposal Evaluation**: Scores each acceptance using Dijkstra pathfinding</span>
</span><span id="Store.CollectWarehouseResponses-381"><a href="#Store.CollectWarehouseResponses-381"><span class="linenos">381</span></a><span class="sd">            3. **Award Decision**: Sends accept-proposal to winner, reject-proposal to losers</span>
</span><span id="Store.CollectWarehouseResponses-382"><a href="#Store.CollectWarehouseResponses-382"><span class="linenos">382</span></a><span class="sd">        </span>
</span><span id="Store.CollectWarehouseResponses-383"><a href="#Store.CollectWarehouseResponses-383"><span class="linenos">383</span></a><span class="sd">        The behaviour uses a coordinator/worker pattern:</span>
</span><span id="Store.CollectWarehouseResponses-384"><a href="#Store.CollectWarehouseResponses-384"><span class="linenos">384</span></a><span class="sd">            - **Coordinator** (this class): Manages overall protocol flow, evaluates proposals</span>
</span><span id="Store.CollectWarehouseResponses-385"><a href="#Store.CollectWarehouseResponses-385"><span class="linenos">385</span></a><span class="sd">            - **Worker** (ReceiveAllResponses): Handles actual message reception</span>
</span><span id="Store.CollectWarehouseResponses-386"><a href="#Store.CollectWarehouseResponses-386"><span class="linenos">386</span></a><span class="sd">        </span>
</span><span id="Store.CollectWarehouseResponses-387"><a href="#Store.CollectWarehouseResponses-387"><span class="linenos">387</span></a><span class="sd">        Scoring Algorithm:</span>
</span><span id="Store.CollectWarehouseResponses-388"><a href="#Store.CollectWarehouseResponses-388"><span class="linenos">388</span></a><span class="sd">            Uses Dijkstra pathfinding to calculate delivery time from each warehouse to store.</span>
</span><span id="Store.CollectWarehouseResponses-389"><a href="#Store.CollectWarehouseResponses-389"><span class="linenos">389</span></a><span class="sd">            - Formula: score = delivery_time (from warehouse to store)</span>
</span><span id="Store.CollectWarehouseResponses-390"><a href="#Store.CollectWarehouseResponses-390"><span class="linenos">390</span></a><span class="sd">            - Lower score = better choice (shorter delivery time)</span>
</span><span id="Store.CollectWarehouseResponses-391"><a href="#Store.CollectWarehouseResponses-391"><span class="linenos">391</span></a><span class="sd">            - Tie-breaking: First warehouse with minimum score wins</span>
</span><span id="Store.CollectWarehouseResponses-392"><a href="#Store.CollectWarehouseResponses-392"><span class="linenos">392</span></a><span class="sd">        </span>
</span><span id="Store.CollectWarehouseResponses-393"><a href="#Store.CollectWarehouseResponses-393"><span class="linenos">393</span></a><span class="sd">        FIPA Contract Net Protocol Flow:</span>
</span><span id="Store.CollectWarehouseResponses-394"><a href="#Store.CollectWarehouseResponses-394"><span class="linenos">394</span></a><span class="sd">            1. **Setup**: Create template matching request_id and store_id</span>
</span><span id="Store.CollectWarehouseResponses-395"><a href="#Store.CollectWarehouseResponses-395"><span class="linenos">395</span></a><span class="sd">            2. **Collection**: Launch ReceiveAllResponses worker to gather proposals</span>
</span><span id="Store.CollectWarehouseResponses-396"><a href="#Store.CollectWarehouseResponses-396"><span class="linenos">396</span></a><span class="sd">            3. **Wait**: Synchronize on worker completion (timeout: 5 seconds)</span>
</span><span id="Store.CollectWarehouseResponses-397"><a href="#Store.CollectWarehouseResponses-397"><span class="linenos">397</span></a><span class="sd">            4. **Evaluation**: Calculate scores for all acceptances</span>
</span><span id="Store.CollectWarehouseResponses-398"><a href="#Store.CollectWarehouseResponses-398"><span class="linenos">398</span></a><span class="sd">            5. **Selection**: Choose warehouse with minimum score</span>
</span><span id="Store.CollectWarehouseResponses-399"><a href="#Store.CollectWarehouseResponses-399"><span class="linenos">399</span></a><span class="sd">            6. **Award**: Send store-confirm to winner (FIPA accept-proposal)</span>
</span><span id="Store.CollectWarehouseResponses-400"><a href="#Store.CollectWarehouseResponses-400"><span class="linenos">400</span></a><span class="sd">            7. **Rejection**: Send store-deny to losers (FIPA reject-proposal)</span>
</span><span id="Store.CollectWarehouseResponses-401"><a href="#Store.CollectWarehouseResponses-401"><span class="linenos">401</span></a><span class="sd">            8. **Failure Handling**: Enqueue for retry if no acceptances received</span>
</span><span id="Store.CollectWarehouseResponses-402"><a href="#Store.CollectWarehouseResponses-402"><span class="linenos">402</span></a><span class="sd">        </span>
</span><span id="Store.CollectWarehouseResponses-403"><a href="#Store.CollectWarehouseResponses-403"><span class="linenos">403</span></a><span class="sd">        Attributes:</span>
</span><span id="Store.CollectWarehouseResponses-404"><a href="#Store.CollectWarehouseResponses-404"><span class="linenos">404</span></a><span class="sd">            request_id (int): Unique identifier for this purchase request from ID encoding.</span>
</span><span id="Store.CollectWarehouseResponses-405"><a href="#Store.CollectWarehouseResponses-405"><span class="linenos">405</span></a><span class="sd">            buy_msg (str): Original purchase message body (&quot;{quantity} {product}&quot;).</span>
</span><span id="Store.CollectWarehouseResponses-406"><a href="#Store.CollectWarehouseResponses-406"><span class="linenos">406</span></a><span class="sd">            num_warehouses (int): Expected number of warehouse responses for timeout logic.</span>
</span><span id="Store.CollectWarehouseResponses-407"><a href="#Store.CollectWarehouseResponses-407"><span class="linenos">407</span></a><span class="sd">            quantity (int): Quantity of product being purchased.</span>
</span><span id="Store.CollectWarehouseResponses-408"><a href="#Store.CollectWarehouseResponses-408"><span class="linenos">408</span></a><span class="sd">            product (str): Name of product being purchased.</span>
</span><span id="Store.CollectWarehouseResponses-409"><a href="#Store.CollectWarehouseResponses-409"><span class="linenos">409</span></a><span class="sd">            acceptances (list[tuple[str, Message]]): Warehouses that proposed.</span>
</span><span id="Store.CollectWarehouseResponses-410"><a href="#Store.CollectWarehouseResponses-410"><span class="linenos">410</span></a><span class="sd">                Format: [(warehouse_jid, acceptance_msg), ...]</span>
</span><span id="Store.CollectWarehouseResponses-411"><a href="#Store.CollectWarehouseResponses-411"><span class="linenos">411</span></a><span class="sd">            rejections (list[tuple[str, Message, str]]): Warehouses that refused.</span>
</span><span id="Store.CollectWarehouseResponses-412"><a href="#Store.CollectWarehouseResponses-412"><span class="linenos">412</span></a><span class="sd">                Format: [(warehouse_jid, rejection_msg, reason), ...]</span>
</span><span id="Store.CollectWarehouseResponses-413"><a href="#Store.CollectWarehouseResponses-413"><span class="linenos">413</span></a><span class="sd">        </span>
</span><span id="Store.CollectWarehouseResponses-414"><a href="#Store.CollectWarehouseResponses-414"><span class="linenos">414</span></a><span class="sd">        Failure Handling:</span>
</span><span id="Store.CollectWarehouseResponses-415"><a href="#Store.CollectWarehouseResponses-415"><span class="linenos">415</span></a><span class="sd">            - If no warehouses accept: Request added to failed_requests queue</span>
</span><span id="Store.CollectWarehouseResponses-416"><a href="#Store.CollectWarehouseResponses-416"><span class="linenos">416</span></a><span class="sd">            - RetryPreviousBuy behaviour will automatically retry with same request_id</span>
</span><span id="Store.CollectWarehouseResponses-417"><a href="#Store.CollectWarehouseResponses-417"><span class="linenos">417</span></a><span class="sd">            - Failed requests maintain original request_id for tracking</span>
</span><span id="Store.CollectWarehouseResponses-418"><a href="#Store.CollectWarehouseResponses-418"><span class="linenos">418</span></a><span class="sd">        </span>
</span><span id="Store.CollectWarehouseResponses-419"><a href="#Store.CollectWarehouseResponses-419"><span class="linenos">419</span></a><span class="sd">        Example Workflow:</span>
</span><span id="Store.CollectWarehouseResponses-420"><a href="#Store.CollectWarehouseResponses-420"><span class="linenos">420</span></a><span class="sd">            ```</span>
</span><span id="Store.CollectWarehouseResponses-421"><a href="#Store.CollectWarehouseResponses-421"><span class="linenos">421</span></a><span class="sd">            CFP Sent: &quot;50 electronics&quot; (request_id=1001000000)</span>
</span><span id="Store.CollectWarehouseResponses-422"><a href="#Store.CollectWarehouseResponses-422"><span class="linenos">422</span></a><span class="sd">            Responses Received:</span>
</span><span id="Store.CollectWarehouseResponses-423"><a href="#Store.CollectWarehouseResponses-423"><span class="linenos">423</span></a><span class="sd">                - warehouse1: propose (distance=100, score=100)</span>
</span><span id="Store.CollectWarehouseResponses-424"><a href="#Store.CollectWarehouseResponses-424"><span class="linenos">424</span></a><span class="sd">                - warehouse2: propose (distance=50, score=50) &lt;- WINNER</span>
</span><span id="Store.CollectWarehouseResponses-425"><a href="#Store.CollectWarehouseResponses-425"><span class="linenos">425</span></a><span class="sd">                - warehouse3: refuse (reason: out_of_stock)</span>
</span><span id="Store.CollectWarehouseResponses-426"><a href="#Store.CollectWarehouseResponses-426"><span class="linenos">426</span></a><span class="sd">            Actions Taken:</span>
</span><span id="Store.CollectWarehouseResponses-427"><a href="#Store.CollectWarehouseResponses-427"><span class="linenos">427</span></a><span class="sd">                - Send accept-proposal to warehouse2</span>
</span><span id="Store.CollectWarehouseResponses-428"><a href="#Store.CollectWarehouseResponses-428"><span class="linenos">428</span></a><span class="sd">                - Send reject-proposal to warehouse1</span>
</span><span id="Store.CollectWarehouseResponses-429"><a href="#Store.CollectWarehouseResponses-429"><span class="linenos">429</span></a><span class="sd">                - warehouse3 already refused, no action needed</span>
</span><span id="Store.CollectWarehouseResponses-430"><a href="#Store.CollectWarehouseResponses-430"><span class="linenos">430</span></a><span class="sd">            ```</span>
</span><span id="Store.CollectWarehouseResponses-431"><a href="#Store.CollectWarehouseResponses-431"><span class="linenos">431</span></a><span class="sd">        </span>
</span><span id="Store.CollectWarehouseResponses-432"><a href="#Store.CollectWarehouseResponses-432"><span class="linenos">432</span></a><span class="sd">        Note:</span>
</span><span id="Store.CollectWarehouseResponses-433"><a href="#Store.CollectWarehouseResponses-433"><span class="linenos">433</span></a><span class="sd">            This coordinator behaviour is essential for implementing the FIPA Contract Net</span>
</span><span id="Store.CollectWarehouseResponses-434"><a href="#Store.CollectWarehouseResponses-434"><span class="linenos">434</span></a><span class="sd">            Protocol correctly, separating concerns between message collection (worker) and</span>
</span><span id="Store.CollectWarehouseResponses-435"><a href="#Store.CollectWarehouseResponses-435"><span class="linenos">435</span></a><span class="sd">            decision-making (coordinator).</span>
</span><span id="Store.CollectWarehouseResponses-436"><a href="#Store.CollectWarehouseResponses-436"><span class="linenos">436</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.CollectWarehouseResponses-437"><a href="#Store.CollectWarehouseResponses-437"><span class="linenos">437</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_warehouses</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">quantity</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">product</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Store.CollectWarehouseResponses-438"><a href="#Store.CollectWarehouseResponses-438"><span class="linenos">438</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.CollectWarehouseResponses-439"><a href="#Store.CollectWarehouseResponses-439"><span class="linenos">439</span></a><span class="sd">            Initialize the CollectWarehouseResponses coordinator behaviour.</span>
</span><span id="Store.CollectWarehouseResponses-440"><a href="#Store.CollectWarehouseResponses-440"><span class="linenos">440</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-441"><a href="#Store.CollectWarehouseResponses-441"><span class="linenos">441</span></a><span class="sd">            Args:</span>
</span><span id="Store.CollectWarehouseResponses-442"><a href="#Store.CollectWarehouseResponses-442"><span class="linenos">442</span></a><span class="sd">                msg (Message): Original purchase request message sent to warehouses.</span>
</span><span id="Store.CollectWarehouseResponses-443"><a href="#Store.CollectWarehouseResponses-443"><span class="linenos">443</span></a><span class="sd">                    Stored as reference for reconstructing failed requests if needed.</span>
</span><span id="Store.CollectWarehouseResponses-444"><a href="#Store.CollectWarehouseResponses-444"><span class="linenos">444</span></a><span class="sd">                request_id (int): Unique request identifier from hierarchical ID encoding system.</span>
</span><span id="Store.CollectWarehouseResponses-445"><a href="#Store.CollectWarehouseResponses-445"><span class="linenos">445</span></a><span class="sd">                    Used to match incoming responses to this specific CFP.</span>
</span><span id="Store.CollectWarehouseResponses-446"><a href="#Store.CollectWarehouseResponses-446"><span class="linenos">446</span></a><span class="sd">                num_warehouses (int): Expected number of warehouse responses.</span>
</span><span id="Store.CollectWarehouseResponses-447"><a href="#Store.CollectWarehouseResponses-447"><span class="linenos">447</span></a><span class="sd">                    Used to determine when all proposals have been received (or timeout).</span>
</span><span id="Store.CollectWarehouseResponses-448"><a href="#Store.CollectWarehouseResponses-448"><span class="linenos">448</span></a><span class="sd">                quantity (int): Quantity of product being purchased.</span>
</span><span id="Store.CollectWarehouseResponses-449"><a href="#Store.CollectWarehouseResponses-449"><span class="linenos">449</span></a><span class="sd">                    Needed for order processing and statistics tracking.</span>
</span><span id="Store.CollectWarehouseResponses-450"><a href="#Store.CollectWarehouseResponses-450"><span class="linenos">450</span></a><span class="sd">                product (str): Name of product being purchased.</span>
</span><span id="Store.CollectWarehouseResponses-451"><a href="#Store.CollectWarehouseResponses-451"><span class="linenos">451</span></a><span class="sd">                    Needed for order processing and statistics tracking.</span>
</span><span id="Store.CollectWarehouseResponses-452"><a href="#Store.CollectWarehouseResponses-452"><span class="linenos">452</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-453"><a href="#Store.CollectWarehouseResponses-453"><span class="linenos">453</span></a><span class="sd">            Note:</span>
</span><span id="Store.CollectWarehouseResponses-454"><a href="#Store.CollectWarehouseResponses-454"><span class="linenos">454</span></a><span class="sd">                Initializes empty acceptances and rejections lists that will be</span>
</span><span id="Store.CollectWarehouseResponses-455"><a href="#Store.CollectWarehouseResponses-455"><span class="linenos">455</span></a><span class="sd">                populated by the ReceiveAllResponses worker behaviour through</span>
</span><span id="Store.CollectWarehouseResponses-456"><a href="#Store.CollectWarehouseResponses-456"><span class="linenos">456</span></a><span class="sd">                shared reference (list objects are mutable).</span>
</span><span id="Store.CollectWarehouseResponses-457"><a href="#Store.CollectWarehouseResponses-457"><span class="linenos">457</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.CollectWarehouseResponses-458"><a href="#Store.CollectWarehouseResponses-458"><span class="linenos">458</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Store.CollectWarehouseResponses-459"><a href="#Store.CollectWarehouseResponses-459"><span class="linenos">459</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Store.CollectWarehouseResponses-460"><a href="#Store.CollectWarehouseResponses-460"><span class="linenos">460</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">buy_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="Store.CollectWarehouseResponses-461"><a href="#Store.CollectWarehouseResponses-461"><span class="linenos">461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span> <span class="o">=</span> <span class="n">num_warehouses</span>
</span><span id="Store.CollectWarehouseResponses-462"><a href="#Store.CollectWarehouseResponses-462"><span class="linenos">462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Store.CollectWarehouseResponses-463"><a href="#Store.CollectWarehouseResponses-463"><span class="linenos">463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="Store.CollectWarehouseResponses-464"><a href="#Store.CollectWarehouseResponses-464"><span class="linenos">464</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of (warehouse_jid, msg)</span>
</span><span id="Store.CollectWarehouseResponses-465"><a href="#Store.CollectWarehouseResponses-465"><span class="linenos">465</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># List of (warehouse_jid, msg, reason)</span>
</span><span id="Store.CollectWarehouseResponses-466"><a href="#Store.CollectWarehouseResponses-466"><span class="linenos">466</span></a>            
</span><span id="Store.CollectWarehouseResponses-467"><a href="#Store.CollectWarehouseResponses-467"><span class="linenos">467</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.CollectWarehouseResponses-468"><a href="#Store.CollectWarehouseResponses-468"><span class="linenos">468</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.CollectWarehouseResponses-469"><a href="#Store.CollectWarehouseResponses-469"><span class="linenos">469</span></a><span class="sd">            Execute the warehouse proposal collection and evaluation process.</span>
</span><span id="Store.CollectWarehouseResponses-470"><a href="#Store.CollectWarehouseResponses-470"><span class="linenos">470</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-471"><a href="#Store.CollectWarehouseResponses-471"><span class="linenos">471</span></a><span class="sd">            This method coordinates the entire FIPA Contract Net Protocol workflow</span>
</span><span id="Store.CollectWarehouseResponses-472"><a href="#Store.CollectWarehouseResponses-472"><span class="linenos">472</span></a><span class="sd">            for warehouse selection. It sets up message filtering, launches the worker</span>
</span><span id="Store.CollectWarehouseResponses-473"><a href="#Store.CollectWarehouseResponses-473"><span class="linenos">473</span></a><span class="sd">            behaviour for response collection, evaluates all proposals using a scoring</span>
</span><span id="Store.CollectWarehouseResponses-474"><a href="#Store.CollectWarehouseResponses-474"><span class="linenos">474</span></a><span class="sd">            algorithm, and sends confirmations/rejections to participants according to</span>
</span><span id="Store.CollectWarehouseResponses-475"><a href="#Store.CollectWarehouseResponses-475"><span class="linenos">475</span></a><span class="sd">            the FIPA protocol specification.</span>
</span><span id="Store.CollectWarehouseResponses-476"><a href="#Store.CollectWarehouseResponses-476"><span class="linenos">476</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-477"><a href="#Store.CollectWarehouseResponses-477"><span class="linenos">477</span></a><span class="sd">            FIPA Contract Net Protocol Implementation:</span>
</span><span id="Store.CollectWarehouseResponses-478"><a href="#Store.CollectWarehouseResponses-478"><span class="linenos">478</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-479"><a href="#Store.CollectWarehouseResponses-479"><span class="linenos">479</span></a><span class="sd">            1. **Setup Phase** (FIPA: Preparation):</span>
</span><span id="Store.CollectWarehouseResponses-480"><a href="#Store.CollectWarehouseResponses-480"><span class="linenos">480</span></a><span class="sd">                - Creates template matching request_id and store_id metadata</span>
</span><span id="Store.CollectWarehouseResponses-481"><a href="#Store.CollectWarehouseResponses-481"><span class="linenos">481</span></a><span class="sd">                - Allows both warehouse-accept (propose) and warehouse-reject (refuse)</span>
</span><span id="Store.CollectWarehouseResponses-482"><a href="#Store.CollectWarehouseResponses-482"><span class="linenos">482</span></a><span class="sd">                - Ensures only responses for THIS specific request are collected</span>
</span><span id="Store.CollectWarehouseResponses-483"><a href="#Store.CollectWarehouseResponses-483"><span class="linenos">483</span></a><span class="sd">                - Prevents cross-contamination between concurrent requests</span>
</span><span id="Store.CollectWarehouseResponses-484"><a href="#Store.CollectWarehouseResponses-484"><span class="linenos">484</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-485"><a href="#Store.CollectWarehouseResponses-485"><span class="linenos">485</span></a><span class="sd">            2. **Collection Phase** (FIPA: Proposal Reception):</span>
</span><span id="Store.CollectWarehouseResponses-486"><a href="#Store.CollectWarehouseResponses-486"><span class="linenos">486</span></a><span class="sd">                - Delegates to ReceiveAllResponses worker behaviour</span>
</span><span id="Store.CollectWarehouseResponses-487"><a href="#Store.CollectWarehouseResponses-487"><span class="linenos">487</span></a><span class="sd">                - Worker populates acceptances (proposals) and rejections (refusals) lists</span>
</span><span id="Store.CollectWarehouseResponses-488"><a href="#Store.CollectWarehouseResponses-488"><span class="linenos">488</span></a><span class="sd">                - Implements timeout mechanism (5 seconds total)</span>
</span><span id="Store.CollectWarehouseResponses-489"><a href="#Store.CollectWarehouseResponses-489"><span class="linenos">489</span></a><span class="sd">                - Handles partial responses gracefully (some warehouses may not respond)</span>
</span><span id="Store.CollectWarehouseResponses-490"><a href="#Store.CollectWarehouseResponses-490"><span class="linenos">490</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-491"><a href="#Store.CollectWarehouseResponses-491"><span class="linenos">491</span></a><span class="sd">            3. **Evaluation Phase** (FIPA: Proposal Evaluation):</span>
</span><span id="Store.CollectWarehouseResponses-492"><a href="#Store.CollectWarehouseResponses-492"><span class="linenos">492</span></a><span class="sd">                - Calculates score for each acceptance using calculate_warehouse_score()</span>
</span><span id="Store.CollectWarehouseResponses-493"><a href="#Store.CollectWarehouseResponses-493"><span class="linenos">493</span></a><span class="sd">                - Score based on Dijkstra pathfinding: delivery_time from warehouse to store</span>
</span><span id="Store.CollectWarehouseResponses-494"><a href="#Store.CollectWarehouseResponses-494"><span class="linenos">494</span></a><span class="sd">                - Selects warehouse with lowest score (shortest delivery time)</span>
</span><span id="Store.CollectWarehouseResponses-495"><a href="#Store.CollectWarehouseResponses-495"><span class="linenos">495</span></a><span class="sd">                - Implements best-proposal selection strategy from FIPA specification</span>
</span><span id="Store.CollectWarehouseResponses-496"><a href="#Store.CollectWarehouseResponses-496"><span class="linenos">496</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-497"><a href="#Store.CollectWarehouseResponses-497"><span class="linenos">497</span></a><span class="sd">            4. **Award Phase** (FIPA: Result Notification):</span>
</span><span id="Store.CollectWarehouseResponses-498"><a href="#Store.CollectWarehouseResponses-498"><span class="linenos">498</span></a><span class="sd">                - Sends store-confirm to winner (FIPA accept-proposal performative)</span>
</span><span id="Store.CollectWarehouseResponses-499"><a href="#Store.CollectWarehouseResponses-499"><span class="linenos">499</span></a><span class="sd">                - Sends store-deny to all other acceptors (FIPA reject-proposal performative)</span>
</span><span id="Store.CollectWarehouseResponses-500"><a href="#Store.CollectWarehouseResponses-500"><span class="linenos">500</span></a><span class="sd">                - Rejected participants (warehouse-reject) are not contacted again</span>
</span><span id="Store.CollectWarehouseResponses-501"><a href="#Store.CollectWarehouseResponses-501"><span class="linenos">501</span></a><span class="sd">                - Winner proceeds to order confirmation and vehicle assignment</span>
</span><span id="Store.CollectWarehouseResponses-502"><a href="#Store.CollectWarehouseResponses-502"><span class="linenos">502</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-503"><a href="#Store.CollectWarehouseResponses-503"><span class="linenos">503</span></a><span class="sd">            5. **Failure Handling**:</span>
</span><span id="Store.CollectWarehouseResponses-504"><a href="#Store.CollectWarehouseResponses-504"><span class="linenos">504</span></a><span class="sd">                - If no acceptances received: Adds request to failed_requests queue</span>
</span><span id="Store.CollectWarehouseResponses-505"><a href="#Store.CollectWarehouseResponses-505"><span class="linenos">505</span></a><span class="sd">                - Failed requests automatically retried by RetryPreviousBuy behaviour</span>
</span><span id="Store.CollectWarehouseResponses-506"><a href="#Store.CollectWarehouseResponses-506"><span class="linenos">506</span></a><span class="sd">                - Maintains same request_id for tracking across retry attempts</span>
</span><span id="Store.CollectWarehouseResponses-507"><a href="#Store.CollectWarehouseResponses-507"><span class="linenos">507</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-508"><a href="#Store.CollectWarehouseResponses-508"><span class="linenos">508</span></a><span class="sd">            Template Configuration:</span>
</span><span id="Store.CollectWarehouseResponses-509"><a href="#Store.CollectWarehouseResponses-509"><span class="linenos">509</span></a><span class="sd">                - **Matches**: store_id (this store) AND request_id (this specific request)</span>
</span><span id="Store.CollectWarehouseResponses-510"><a href="#Store.CollectWarehouseResponses-510"><span class="linenos">510</span></a><span class="sd">                - **Accepts**: Both warehouse-accept AND warehouse-reject performatives</span>
</span><span id="Store.CollectWarehouseResponses-511"><a href="#Store.CollectWarehouseResponses-511"><span class="linenos">511</span></a><span class="sd">                - **Purpose**: Filters responses to avoid conflicts with concurrent requests</span>
</span><span id="Store.CollectWarehouseResponses-512"><a href="#Store.CollectWarehouseResponses-512"><span class="linenos">512</span></a><span class="sd">                - **Design**: Intentionally doesn&#39;t filter by performative to collect all responses</span>
</span><span id="Store.CollectWarehouseResponses-513"><a href="#Store.CollectWarehouseResponses-513"><span class="linenos">513</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-514"><a href="#Store.CollectWarehouseResponses-514"><span class="linenos">514</span></a><span class="sd">            Scoring Process (Distance-Based Selection):</span>
</span><span id="Store.CollectWarehouseResponses-515"><a href="#Store.CollectWarehouseResponses-515"><span class="linenos">515</span></a><span class="sd">                For each warehouse that sent propose (warehouse-accept):</span>
</span><span id="Store.CollectWarehouseResponses-516"><a href="#Store.CollectWarehouseResponses-516"><span class="linenos">516</span></a><span class="sd">                1. Extract warehouse node_id from message metadata</span>
</span><span id="Store.CollectWarehouseResponses-517"><a href="#Store.CollectWarehouseResponses-517"><span class="linenos">517</span></a><span class="sd">                2. Use Dijkstra algorithm: calculate (path, fuel, time) warehouse -&gt; store</span>
</span><span id="Store.CollectWarehouseResponses-518"><a href="#Store.CollectWarehouseResponses-518"><span class="linenos">518</span></a><span class="sd">                3. Score = delivery time (lower is better)</span>
</span><span id="Store.CollectWarehouseResponses-519"><a href="#Store.CollectWarehouseResponses-519"><span class="linenos">519</span></a><span class="sd">                4. Select warehouse with minimum score</span>
</span><span id="Store.CollectWarehouseResponses-520"><a href="#Store.CollectWarehouseResponses-520"><span class="linenos">520</span></a><span class="sd">                5. Tie-breaking: First warehouse with minimum score wins</span>
</span><span id="Store.CollectWarehouseResponses-521"><a href="#Store.CollectWarehouseResponses-521"><span class="linenos">521</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-522"><a href="#Store.CollectWarehouseResponses-522"><span class="linenos">522</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.CollectWarehouseResponses-523"><a href="#Store.CollectWarehouseResponses-523"><span class="linenos">523</span></a><span class="sd">                - Adds ReceiveAllResponses worker behaviour to agent (with template)</span>
</span><span id="Store.CollectWarehouseResponses-524"><a href="#Store.CollectWarehouseResponses-524"><span class="linenos">524</span></a><span class="sd">                - Adds SendStoreConfirmation behaviour for winner</span>
</span><span id="Store.CollectWarehouseResponses-525"><a href="#Store.CollectWarehouseResponses-525"><span class="linenos">525</span></a><span class="sd">                - Adds SendStoreDenial behaviour for each non-winner</span>
</span><span id="Store.CollectWarehouseResponses-526"><a href="#Store.CollectWarehouseResponses-526"><span class="linenos">526</span></a><span class="sd">                - May enqueue failed request to failed_requests queue</span>
</span><span id="Store.CollectWarehouseResponses-527"><a href="#Store.CollectWarehouseResponses-527"><span class="linenos">527</span></a><span class="sd">                - Prints evaluation details if verbose mode enabled</span>
</span><span id="Store.CollectWarehouseResponses-528"><a href="#Store.CollectWarehouseResponses-528"><span class="linenos">528</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-529"><a href="#Store.CollectWarehouseResponses-529"><span class="linenos">529</span></a><span class="sd">            Returns:</span>
</span><span id="Store.CollectWarehouseResponses-530"><a href="#Store.CollectWarehouseResponses-530"><span class="linenos">530</span></a><span class="sd">                None. Completes when all confirmations/denials are sent, or when</span>
</span><span id="Store.CollectWarehouseResponses-531"><a href="#Store.CollectWarehouseResponses-531"><span class="linenos">531</span></a><span class="sd">                failed request is enqueued for retry.</span>
</span><span id="Store.CollectWarehouseResponses-532"><a href="#Store.CollectWarehouseResponses-532"><span class="linenos">532</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-533"><a href="#Store.CollectWarehouseResponses-533"><span class="linenos">533</span></a><span class="sd">            Example Execution:</span>
</span><span id="Store.CollectWarehouseResponses-534"><a href="#Store.CollectWarehouseResponses-534"><span class="linenos">534</span></a><span class="sd">                ```</span>
</span><span id="Store.CollectWarehouseResponses-535"><a href="#Store.CollectWarehouseResponses-535"><span class="linenos">535</span></a><span class="sd">                CFP: &quot;50 electronics&quot; to 3 warehouses</span>
</span><span id="Store.CollectWarehouseResponses-536"><a href="#Store.CollectWarehouseResponses-536"><span class="linenos">536</span></a><span class="sd">                Responses:</span>
</span><span id="Store.CollectWarehouseResponses-537"><a href="#Store.CollectWarehouseResponses-537"><span class="linenos">537</span></a><span class="sd">                    - warehouse1: accept (node_id=10, distance=150, score=150)</span>
</span><span id="Store.CollectWarehouseResponses-538"><a href="#Store.CollectWarehouseResponses-538"><span class="linenos">538</span></a><span class="sd">                    - warehouse2: accept (node_id=5, distance=80, score=80) &lt;- WINNER</span>
</span><span id="Store.CollectWarehouseResponses-539"><a href="#Store.CollectWarehouseResponses-539"><span class="linenos">539</span></a><span class="sd">                    - warehouse3: reject (reason=out_of_stock)</span>
</span><span id="Store.CollectWarehouseResponses-540"><a href="#Store.CollectWarehouseResponses-540"><span class="linenos">540</span></a><span class="sd">                Actions:</span>
</span><span id="Store.CollectWarehouseResponses-541"><a href="#Store.CollectWarehouseResponses-541"><span class="linenos">541</span></a><span class="sd">                    - SendStoreConfirmation(warehouse2) -&gt; accept-proposal</span>
</span><span id="Store.CollectWarehouseResponses-542"><a href="#Store.CollectWarehouseResponses-542"><span class="linenos">542</span></a><span class="sd">                    - SendStoreDenial(warehouse1) -&gt; reject-proposal</span>
</span><span id="Store.CollectWarehouseResponses-543"><a href="#Store.CollectWarehouseResponses-543"><span class="linenos">543</span></a><span class="sd">                    - No action for warehouse3 (already refused)</span>
</span><span id="Store.CollectWarehouseResponses-544"><a href="#Store.CollectWarehouseResponses-544"><span class="linenos">544</span></a><span class="sd">                Result: Order placed with warehouse2</span>
</span><span id="Store.CollectWarehouseResponses-545"><a href="#Store.CollectWarehouseResponses-545"><span class="linenos">545</span></a><span class="sd">                ```</span>
</span><span id="Store.CollectWarehouseResponses-546"><a href="#Store.CollectWarehouseResponses-546"><span class="linenos">546</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses-547"><a href="#Store.CollectWarehouseResponses-547"><span class="linenos">547</span></a><span class="sd">            Note:</span>
</span><span id="Store.CollectWarehouseResponses-548"><a href="#Store.CollectWarehouseResponses-548"><span class="linenos">548</span></a><span class="sd">                This method implements the core decision-making logic of the FIPA Contract</span>
</span><span id="Store.CollectWarehouseResponses-549"><a href="#Store.CollectWarehouseResponses-549"><span class="linenos">549</span></a><span class="sd">                Net Protocol, transforming raw proposals into a concrete purchase order with</span>
</span><span id="Store.CollectWarehouseResponses-550"><a href="#Store.CollectWarehouseResponses-550"><span class="linenos">550</span></a><span class="sd">                the optimal warehouse.</span>
</span><span id="Store.CollectWarehouseResponses-551"><a href="#Store.CollectWarehouseResponses-551"><span class="linenos">551</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.CollectWarehouseResponses-552"><a href="#Store.CollectWarehouseResponses-552"><span class="linenos">552</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.CollectWarehouseResponses-553"><a href="#Store.CollectWarehouseResponses-553"><span class="linenos">553</span></a>            
</span><span id="Store.CollectWarehouseResponses-554"><a href="#Store.CollectWarehouseResponses-554"><span class="linenos">554</span></a>            <span class="c1"># Setup template that accepts BOTH warehouse-accept AND warehouse-reject</span>
</span><span id="Store.CollectWarehouseResponses-555"><a href="#Store.CollectWarehouseResponses-555"><span class="linenos">555</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Store.CollectWarehouseResponses-556"><a href="#Store.CollectWarehouseResponses-556"><span class="linenos">556</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store.CollectWarehouseResponses-557"><a href="#Store.CollectWarehouseResponses-557"><span class="linenos">557</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store.CollectWarehouseResponses-558"><a href="#Store.CollectWarehouseResponses-558"><span class="linenos">558</span></a>            <span class="c1"># Don&#39;t filter by performative - we want both accept and reject</span>
</span><span id="Store.CollectWarehouseResponses-559"><a href="#Store.CollectWarehouseResponses-559"><span class="linenos">559</span></a>            
</span><span id="Store.CollectWarehouseResponses-560"><a href="#Store.CollectWarehouseResponses-560"><span class="linenos">560</span></a>            <span class="c1"># Create a combined behaviour to listen for both</span>
</span><span id="Store.CollectWarehouseResponses-561"><a href="#Store.CollectWarehouseResponses-561"><span class="linenos">561</span></a>            <span class="n">combined_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ReceiveAllResponses</span><span class="p">(</span>
</span><span id="Store.CollectWarehouseResponses-562"><a href="#Store.CollectWarehouseResponses-562"><span class="linenos">562</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span id="Store.CollectWarehouseResponses-563"><a href="#Store.CollectWarehouseResponses-563"><span class="linenos">563</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span><span class="p">,</span>
</span><span id="Store.CollectWarehouseResponses-564"><a href="#Store.CollectWarehouseResponses-564"><span class="linenos">564</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">,</span>
</span><span id="Store.CollectWarehouseResponses-565"><a href="#Store.CollectWarehouseResponses-565"><span class="linenos">565</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span>
</span><span id="Store.CollectWarehouseResponses-566"><a href="#Store.CollectWarehouseResponses-566"><span class="linenos">566</span></a>            <span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-567"><a href="#Store.CollectWarehouseResponses-567"><span class="linenos">567</span></a>            
</span><span id="Store.CollectWarehouseResponses-568"><a href="#Store.CollectWarehouseResponses-568"><span class="linenos">568</span></a>            <span class="c1"># Add with template that matches both performatives</span>
</span><span id="Store.CollectWarehouseResponses-569"><a href="#Store.CollectWarehouseResponses-569"><span class="linenos">569</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">combined_behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-570"><a href="#Store.CollectWarehouseResponses-570"><span class="linenos">570</span></a>            
</span><span id="Store.CollectWarehouseResponses-571"><a href="#Store.CollectWarehouseResponses-571"><span class="linenos">571</span></a>            <span class="c1"># Wait for collection to complete</span>
</span><span id="Store.CollectWarehouseResponses-572"><a href="#Store.CollectWarehouseResponses-572"><span class="linenos">572</span></a>            <span class="k">await</span> <span class="n">combined_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Store.CollectWarehouseResponses-573"><a href="#Store.CollectWarehouseResponses-573"><span class="linenos">573</span></a>            
</span><span id="Store.CollectWarehouseResponses-574"><a href="#Store.CollectWarehouseResponses-574"><span class="linenos">574</span></a>            <span class="c1"># Now evaluate and choose best warehouse</span>
</span><span id="Store.CollectWarehouseResponses-575"><a href="#Store.CollectWarehouseResponses-575"><span class="linenos">575</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses-576"><a href="#Store.CollectWarehouseResponses-576"><span class="linenos">576</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses-577"><a href="#Store.CollectWarehouseResponses-577"><span class="linenos">577</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> acceptance(s) and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejection(s)&quot;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-578"><a href="#Store.CollectWarehouseResponses-578"><span class="linenos">578</span></a>                
</span><span id="Store.CollectWarehouseResponses-579"><a href="#Store.CollectWarehouseResponses-579"><span class="linenos">579</span></a>                <span class="c1"># Calculate scores for each warehouse that accepted</span>
</span><span id="Store.CollectWarehouseResponses-580"><a href="#Store.CollectWarehouseResponses-580"><span class="linenos">580</span></a>                <span class="n">best_warehouse</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Store.CollectWarehouseResponses-581"><a href="#Store.CollectWarehouseResponses-581"><span class="linenos">581</span></a>                <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-582"><a href="#Store.CollectWarehouseResponses-582"><span class="linenos">582</span></a>                
</span><span id="Store.CollectWarehouseResponses-583"><a href="#Store.CollectWarehouseResponses-583"><span class="linenos">583</span></a>                
</span><span id="Store.CollectWarehouseResponses-584"><a href="#Store.CollectWarehouseResponses-584"><span class="linenos">584</span></a>                <span class="k">for</span> <span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses-585"><a href="#Store.CollectWarehouseResponses-585"><span class="linenos">585</span></a>                    <span class="n">score</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">calculate_warehouse_score</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-586"><a href="#Store.CollectWarehouseResponses-586"><span class="linenos">586</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses-587"><a href="#Store.CollectWarehouseResponses-587"><span class="linenos">587</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Warehouse </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2"> score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-588"><a href="#Store.CollectWarehouseResponses-588"><span class="linenos">588</span></a>                    
</span><span id="Store.CollectWarehouseResponses-589"><a href="#Store.CollectWarehouseResponses-589"><span class="linenos">589</span></a>                    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">best_score</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses-590"><a href="#Store.CollectWarehouseResponses-590"><span class="linenos">590</span></a>                        <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
</span><span id="Store.CollectWarehouseResponses-591"><a href="#Store.CollectWarehouseResponses-591"><span class="linenos">591</span></a>                        <span class="n">best_warehouse</span> <span class="o">=</span> <span class="p">(</span><span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-592"><a href="#Store.CollectWarehouseResponses-592"><span class="linenos">592</span></a>                
</span><span id="Store.CollectWarehouseResponses-593"><a href="#Store.CollectWarehouseResponses-593"><span class="linenos">593</span></a>                <span class="k">if</span> <span class="n">best_warehouse</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses-594"><a href="#Store.CollectWarehouseResponses-594"><span class="linenos">594</span></a>                    <span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="o">=</span> <span class="n">best_warehouse</span>
</span><span id="Store.CollectWarehouseResponses-595"><a href="#Store.CollectWarehouseResponses-595"><span class="linenos">595</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses-596"><a href="#Store.CollectWarehouseResponses-596"><span class="linenos">596</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Selected warehouse </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2"> with score </span><span class="si">{</span><span class="n">best_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-597"><a href="#Store.CollectWarehouseResponses-597"><span class="linenos">597</span></a>                    
</span><span id="Store.CollectWarehouseResponses-598"><a href="#Store.CollectWarehouseResponses-598"><span class="linenos">598</span></a>                    <span class="c1"># Send confirmation to the chosen warehouse</span>
</span><span id="Store.CollectWarehouseResponses-599"><a href="#Store.CollectWarehouseResponses-599"><span class="linenos">599</span></a>                    <span class="n">confirm_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendStoreConfirmation</span><span class="p">(</span><span class="n">accept_msg</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-600"><a href="#Store.CollectWarehouseResponses-600"><span class="linenos">600</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">confirm_behav</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-601"><a href="#Store.CollectWarehouseResponses-601"><span class="linenos">601</span></a>                    <span class="k">await</span> <span class="n">confirm_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Store.CollectWarehouseResponses-602"><a href="#Store.CollectWarehouseResponses-602"><span class="linenos">602</span></a>                    
</span><span id="Store.CollectWarehouseResponses-603"><a href="#Store.CollectWarehouseResponses-603"><span class="linenos">603</span></a>                    <span class="c1"># Send denial to other warehouses that accepted but weren&#39;t chosen</span>
</span><span id="Store.CollectWarehouseResponses-604"><a href="#Store.CollectWarehouseResponses-604"><span class="linenos">604</span></a>                    <span class="k">for</span> <span class="n">other_warehouse_jid</span><span class="p">,</span> <span class="n">other_msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses-605"><a href="#Store.CollectWarehouseResponses-605"><span class="linenos">605</span></a>                        <span class="k">if</span> <span class="n">other_warehouse_jid</span> <span class="o">!=</span> <span class="n">warehouse_jid</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses-606"><a href="#Store.CollectWarehouseResponses-606"><span class="linenos">606</span></a>                            <span class="n">deny_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendStoreDenial</span><span class="p">(</span><span class="n">other_msg</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-607"><a href="#Store.CollectWarehouseResponses-607"><span class="linenos">607</span></a>                            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">deny_behav</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-608"><a href="#Store.CollectWarehouseResponses-608"><span class="linenos">608</span></a>                            <span class="k">await</span> <span class="n">deny_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Store.CollectWarehouseResponses-609"><a href="#Store.CollectWarehouseResponses-609"><span class="linenos">609</span></a>                            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses-610"><a href="#Store.CollectWarehouseResponses-610"><span class="linenos">610</span></a>                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent denial to </span><span class="si">{</span><span class="n">other_warehouse_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-611"><a href="#Store.CollectWarehouseResponses-611"><span class="linenos">611</span></a>                    
</span><span id="Store.CollectWarehouseResponses-612"><a href="#Store.CollectWarehouseResponses-612"><span class="linenos">612</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses-613"><a href="#Store.CollectWarehouseResponses-613"><span class="linenos">613</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses-614"><a href="#Store.CollectWarehouseResponses-614"><span class="linenos">614</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No acceptances received. All warehouses rejected or timed out.&quot;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-615"><a href="#Store.CollectWarehouseResponses-615"><span class="linenos">615</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Request saved in self.failed_requests&quot;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-616"><a href="#Store.CollectWarehouseResponses-616"><span class="linenos">616</span></a>                
</span><span id="Store.CollectWarehouseResponses-617"><a href="#Store.CollectWarehouseResponses-617"><span class="linenos">617</span></a>                <span class="c1"># Add to failed requests</span>
</span><span id="Store.CollectWarehouseResponses-618"><a href="#Store.CollectWarehouseResponses-618"><span class="linenos">618</span></a>                <span class="n">failed_msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span><span class="o">.</span><span class="n">to</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-619"><a href="#Store.CollectWarehouseResponses-619"><span class="linenos">619</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">set_buy_metadata</span><span class="p">(</span><span class="n">failed_msg</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses-620"><a href="#Store.CollectWarehouseResponses-620"><span class="linenos">620</span></a>                <span class="n">failed_msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store.CollectWarehouseResponses-621"><a href="#Store.CollectWarehouseResponses-621"><span class="linenos">621</span></a>                <span class="n">failed_msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_msg</span>
</span><span id="Store.CollectWarehouseResponses-622"><a href="#Store.CollectWarehouseResponses-622"><span class="linenos">622</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">failed_msg</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Coordinator behaviour for FIPA Contract Net Protocol implementation.</p>

<p>This behaviour orchestrates the proposal collection, evaluation, and award phases
of the FIPA Contract Net Protocol. It acts as the coordinator (initiator) that
manages the negotiation process with multiple warehouses, collects their responses,
and selects the best proposal based on a distance-based scoring function.</p>

<h6 id="fipa-protocol-phases-implemented">FIPA Protocol Phases Implemented:</h6>

<blockquote>
  <ol>
  <li><strong>Proposal Reception</strong>: Collects warehouse responses (propose/refuse)</li>
  <li><strong>Proposal Evaluation</strong>: Scores each acceptance using Dijkstra pathfinding</li>
  <li><strong>Award Decision</strong>: Sends accept-proposal to winner, reject-proposal to losers</li>
  </ol>
</blockquote>

<p>The behaviour uses a coordinator/worker pattern:
    - <strong>Coordinator</strong> (this class): Manages overall protocol flow, evaluates proposals
    - <strong>Worker</strong> (ReceiveAllResponses): Handles actual message reception</p>

<h6 id="scoring-algorithm">Scoring Algorithm:</h6>

<blockquote>
  <p>Uses Dijkstra pathfinding to calculate delivery time from each warehouse to store.</p>
  
  <ul>
  <li>Formula: score = delivery_time (from warehouse to store)</li>
  <li>Lower score = better choice (shorter delivery time)</li>
  <li>Tie-breaking: First warehouse with minimum score wins</li>
  </ul>
</blockquote>

<h6 id="fipa-contract-net-protocol-flow">FIPA Contract Net Protocol Flow:</h6>

<blockquote>
  <ol>
  <li><strong>Setup</strong>: Create template matching request_id and store_id</li>
  <li><strong>Collection</strong>: Launch ReceiveAllResponses worker to gather proposals</li>
  <li><strong>Wait</strong>: Synchronize on worker completion (timeout: 5 seconds)</li>
  <li><strong>Evaluation</strong>: Calculate scores for all acceptances</li>
  <li><strong>Selection</strong>: Choose warehouse with minimum score</li>
  <li><strong>Award</strong>: Send store-confirm to winner (FIPA accept-proposal)</li>
  <li><strong>Rejection</strong>: Send store-deny to losers (FIPA reject-proposal)</li>
  <li><strong>Failure Handling</strong>: Enqueue for retry if no acceptances received</li>
  </ol>
</blockquote>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>request_id (int):</strong>  Unique identifier for this purchase request from ID encoding.</li>
<li><strong>buy_msg (str):</strong>  Original purchase message body ("{quantity} {product}").</li>
<li><strong>num_warehouses (int):</strong>  Expected number of warehouse responses for timeout logic.</li>
<li><strong>quantity (int):</strong>  Quantity of product being purchased.</li>
<li><strong>product (str):</strong>  Name of product being purchased.</li>
<li><strong>acceptances (list[tuple[str, Message]]):</strong>  Warehouses that proposed.
Format: [(warehouse_jid, acceptance_msg), ...]</li>
<li><strong>rejections (list[tuple[str, Message, str]]):</strong>  Warehouses that refused.
Format: [(warehouse_jid, rejection_msg, reason), ...]</li>
</ul>

<h6 id="failure-handling">Failure Handling:</h6>

<blockquote>
  <ul>
  <li>If no warehouses accept: Request added to failed_requests queue</li>
  <li>RetryPreviousBuy behaviour will automatically retry with same request_id</li>
  <li>Failed requests maintain original request_id for tracking</li>
  </ul>
</blockquote>

<h6 id="example-workflow">Example Workflow:</h6>

<blockquote>
<pre><code>CFP Sent: "50 electronics" (request_id=1001000000)
Responses Received:
    - warehouse1: propose (distance=100, score=100)
    - warehouse2: propose (distance=50, score=50) &lt;- WINNER
    - warehouse3: refuse (reason: out_of_stock)
Actions Taken:
    - Send accept-proposal to warehouse2
    - Send reject-proposal to warehouse1
    - warehouse3 already refused, no action needed
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This coordinator behaviour is essential for implementing the FIPA Contract Net
  Protocol correctly, separating concerns between message collection (worker) and
  decision-making (coordinator).</p>
</blockquote>
</div>


                            <div id="Store.CollectWarehouseResponses.__init__" class="classattr">
                                        <input id="Store.CollectWarehouseResponses.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Store.CollectWarehouseResponses</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span>,</span><span class="param">	<span class="n">request_id</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">num_warehouses</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">product</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="Store.CollectWarehouseResponses.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.CollectWarehouseResponses.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.CollectWarehouseResponses.__init__-437"><a href="#Store.CollectWarehouseResponses.__init__-437"><span class="linenos">437</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_warehouses</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">quantity</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">product</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Store.CollectWarehouseResponses.__init__-438"><a href="#Store.CollectWarehouseResponses.__init__-438"><span class="linenos">438</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.CollectWarehouseResponses.__init__-439"><a href="#Store.CollectWarehouseResponses.__init__-439"><span class="linenos">439</span></a><span class="sd">            Initialize the CollectWarehouseResponses coordinator behaviour.</span>
</span><span id="Store.CollectWarehouseResponses.__init__-440"><a href="#Store.CollectWarehouseResponses.__init__-440"><span class="linenos">440</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.__init__-441"><a href="#Store.CollectWarehouseResponses.__init__-441"><span class="linenos">441</span></a><span class="sd">            Args:</span>
</span><span id="Store.CollectWarehouseResponses.__init__-442"><a href="#Store.CollectWarehouseResponses.__init__-442"><span class="linenos">442</span></a><span class="sd">                msg (Message): Original purchase request message sent to warehouses.</span>
</span><span id="Store.CollectWarehouseResponses.__init__-443"><a href="#Store.CollectWarehouseResponses.__init__-443"><span class="linenos">443</span></a><span class="sd">                    Stored as reference for reconstructing failed requests if needed.</span>
</span><span id="Store.CollectWarehouseResponses.__init__-444"><a href="#Store.CollectWarehouseResponses.__init__-444"><span class="linenos">444</span></a><span class="sd">                request_id (int): Unique request identifier from hierarchical ID encoding system.</span>
</span><span id="Store.CollectWarehouseResponses.__init__-445"><a href="#Store.CollectWarehouseResponses.__init__-445"><span class="linenos">445</span></a><span class="sd">                    Used to match incoming responses to this specific CFP.</span>
</span><span id="Store.CollectWarehouseResponses.__init__-446"><a href="#Store.CollectWarehouseResponses.__init__-446"><span class="linenos">446</span></a><span class="sd">                num_warehouses (int): Expected number of warehouse responses.</span>
</span><span id="Store.CollectWarehouseResponses.__init__-447"><a href="#Store.CollectWarehouseResponses.__init__-447"><span class="linenos">447</span></a><span class="sd">                    Used to determine when all proposals have been received (or timeout).</span>
</span><span id="Store.CollectWarehouseResponses.__init__-448"><a href="#Store.CollectWarehouseResponses.__init__-448"><span class="linenos">448</span></a><span class="sd">                quantity (int): Quantity of product being purchased.</span>
</span><span id="Store.CollectWarehouseResponses.__init__-449"><a href="#Store.CollectWarehouseResponses.__init__-449"><span class="linenos">449</span></a><span class="sd">                    Needed for order processing and statistics tracking.</span>
</span><span id="Store.CollectWarehouseResponses.__init__-450"><a href="#Store.CollectWarehouseResponses.__init__-450"><span class="linenos">450</span></a><span class="sd">                product (str): Name of product being purchased.</span>
</span><span id="Store.CollectWarehouseResponses.__init__-451"><a href="#Store.CollectWarehouseResponses.__init__-451"><span class="linenos">451</span></a><span class="sd">                    Needed for order processing and statistics tracking.</span>
</span><span id="Store.CollectWarehouseResponses.__init__-452"><a href="#Store.CollectWarehouseResponses.__init__-452"><span class="linenos">452</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.__init__-453"><a href="#Store.CollectWarehouseResponses.__init__-453"><span class="linenos">453</span></a><span class="sd">            Note:</span>
</span><span id="Store.CollectWarehouseResponses.__init__-454"><a href="#Store.CollectWarehouseResponses.__init__-454"><span class="linenos">454</span></a><span class="sd">                Initializes empty acceptances and rejections lists that will be</span>
</span><span id="Store.CollectWarehouseResponses.__init__-455"><a href="#Store.CollectWarehouseResponses.__init__-455"><span class="linenos">455</span></a><span class="sd">                populated by the ReceiveAllResponses worker behaviour through</span>
</span><span id="Store.CollectWarehouseResponses.__init__-456"><a href="#Store.CollectWarehouseResponses.__init__-456"><span class="linenos">456</span></a><span class="sd">                shared reference (list objects are mutable).</span>
</span><span id="Store.CollectWarehouseResponses.__init__-457"><a href="#Store.CollectWarehouseResponses.__init__-457"><span class="linenos">457</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.CollectWarehouseResponses.__init__-458"><a href="#Store.CollectWarehouseResponses.__init__-458"><span class="linenos">458</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Store.CollectWarehouseResponses.__init__-459"><a href="#Store.CollectWarehouseResponses.__init__-459"><span class="linenos">459</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Store.CollectWarehouseResponses.__init__-460"><a href="#Store.CollectWarehouseResponses.__init__-460"><span class="linenos">460</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">buy_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="Store.CollectWarehouseResponses.__init__-461"><a href="#Store.CollectWarehouseResponses.__init__-461"><span class="linenos">461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span> <span class="o">=</span> <span class="n">num_warehouses</span>
</span><span id="Store.CollectWarehouseResponses.__init__-462"><a href="#Store.CollectWarehouseResponses.__init__-462"><span class="linenos">462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Store.CollectWarehouseResponses.__init__-463"><a href="#Store.CollectWarehouseResponses.__init__-463"><span class="linenos">463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="Store.CollectWarehouseResponses.__init__-464"><a href="#Store.CollectWarehouseResponses.__init__-464"><span class="linenos">464</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of (warehouse_jid, msg)</span>
</span><span id="Store.CollectWarehouseResponses.__init__-465"><a href="#Store.CollectWarehouseResponses.__init__-465"><span class="linenos">465</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># List of (warehouse_jid, msg, reason)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the CollectWarehouseResponses coordinator behaviour.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>msg (Message):</strong>  Original purchase request message sent to warehouses.
Stored as reference for reconstructing failed requests if needed.</li>
<li><strong>request_id (int):</strong>  Unique request identifier from hierarchical ID encoding system.
Used to match incoming responses to this specific CFP.</li>
<li><strong>num_warehouses (int):</strong>  Expected number of warehouse responses.
Used to determine when all proposals have been received (or timeout).</li>
<li><strong>quantity (int):</strong>  Quantity of product being purchased.
Needed for order processing and statistics tracking.</li>
<li><strong>product (str):</strong>  Name of product being purchased.
Needed for order processing and statistics tracking.</li>
</ul>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Initializes empty acceptances and rejections lists that will be
  populated by the ReceiveAllResponses worker behaviour through
  shared reference (list objects are mutable).</p>
</blockquote>
</div>


                            </div>
                            <div id="Store.CollectWarehouseResponses.request_id" class="classattr">
                                <div class="attr variable">
            <span class="name">request_id</span>

        
    </div>
    <a class="headerlink" href="#Store.CollectWarehouseResponses.request_id"></a>
    
    

                            </div>
                            <div id="Store.CollectWarehouseResponses.buy_msg" class="classattr">
                                <div class="attr variable">
            <span class="name">buy_msg</span>

        
    </div>
    <a class="headerlink" href="#Store.CollectWarehouseResponses.buy_msg"></a>
    
    

                            </div>
                            <div id="Store.CollectWarehouseResponses.num_warehouses" class="classattr">
                                <div class="attr variable">
            <span class="name">num_warehouses</span>

        
    </div>
    <a class="headerlink" href="#Store.CollectWarehouseResponses.num_warehouses"></a>
    
    

                            </div>
                            <div id="Store.CollectWarehouseResponses.quantity" class="classattr">
                                <div class="attr variable">
            <span class="name">quantity</span>

        
    </div>
    <a class="headerlink" href="#Store.CollectWarehouseResponses.quantity"></a>
    
    

                            </div>
                            <div id="Store.CollectWarehouseResponses.product" class="classattr">
                                <div class="attr variable">
            <span class="name">product</span>

        
    </div>
    <a class="headerlink" href="#Store.CollectWarehouseResponses.product"></a>
    
    

                            </div>
                            <div id="Store.CollectWarehouseResponses.acceptances" class="classattr">
                                <div class="attr variable">
            <span class="name">acceptances</span>

        
    </div>
    <a class="headerlink" href="#Store.CollectWarehouseResponses.acceptances"></a>
    
    

                            </div>
                            <div id="Store.CollectWarehouseResponses.rejections" class="classattr">
                                <div class="attr variable">
            <span class="name">rejections</span>

        
    </div>
    <a class="headerlink" href="#Store.CollectWarehouseResponses.rejections"></a>
    
    

                            </div>
                            <div id="Store.CollectWarehouseResponses.run" class="classattr">
                                        <input id="Store.CollectWarehouseResponses.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Store.CollectWarehouseResponses.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.CollectWarehouseResponses.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.CollectWarehouseResponses.run-467"><a href="#Store.CollectWarehouseResponses.run-467"><span class="linenos">467</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.CollectWarehouseResponses.run-468"><a href="#Store.CollectWarehouseResponses.run-468"><span class="linenos">468</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.CollectWarehouseResponses.run-469"><a href="#Store.CollectWarehouseResponses.run-469"><span class="linenos">469</span></a><span class="sd">            Execute the warehouse proposal collection and evaluation process.</span>
</span><span id="Store.CollectWarehouseResponses.run-470"><a href="#Store.CollectWarehouseResponses.run-470"><span class="linenos">470</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-471"><a href="#Store.CollectWarehouseResponses.run-471"><span class="linenos">471</span></a><span class="sd">            This method coordinates the entire FIPA Contract Net Protocol workflow</span>
</span><span id="Store.CollectWarehouseResponses.run-472"><a href="#Store.CollectWarehouseResponses.run-472"><span class="linenos">472</span></a><span class="sd">            for warehouse selection. It sets up message filtering, launches the worker</span>
</span><span id="Store.CollectWarehouseResponses.run-473"><a href="#Store.CollectWarehouseResponses.run-473"><span class="linenos">473</span></a><span class="sd">            behaviour for response collection, evaluates all proposals using a scoring</span>
</span><span id="Store.CollectWarehouseResponses.run-474"><a href="#Store.CollectWarehouseResponses.run-474"><span class="linenos">474</span></a><span class="sd">            algorithm, and sends confirmations/rejections to participants according to</span>
</span><span id="Store.CollectWarehouseResponses.run-475"><a href="#Store.CollectWarehouseResponses.run-475"><span class="linenos">475</span></a><span class="sd">            the FIPA protocol specification.</span>
</span><span id="Store.CollectWarehouseResponses.run-476"><a href="#Store.CollectWarehouseResponses.run-476"><span class="linenos">476</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-477"><a href="#Store.CollectWarehouseResponses.run-477"><span class="linenos">477</span></a><span class="sd">            FIPA Contract Net Protocol Implementation:</span>
</span><span id="Store.CollectWarehouseResponses.run-478"><a href="#Store.CollectWarehouseResponses.run-478"><span class="linenos">478</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-479"><a href="#Store.CollectWarehouseResponses.run-479"><span class="linenos">479</span></a><span class="sd">            1. **Setup Phase** (FIPA: Preparation):</span>
</span><span id="Store.CollectWarehouseResponses.run-480"><a href="#Store.CollectWarehouseResponses.run-480"><span class="linenos">480</span></a><span class="sd">                - Creates template matching request_id and store_id metadata</span>
</span><span id="Store.CollectWarehouseResponses.run-481"><a href="#Store.CollectWarehouseResponses.run-481"><span class="linenos">481</span></a><span class="sd">                - Allows both warehouse-accept (propose) and warehouse-reject (refuse)</span>
</span><span id="Store.CollectWarehouseResponses.run-482"><a href="#Store.CollectWarehouseResponses.run-482"><span class="linenos">482</span></a><span class="sd">                - Ensures only responses for THIS specific request are collected</span>
</span><span id="Store.CollectWarehouseResponses.run-483"><a href="#Store.CollectWarehouseResponses.run-483"><span class="linenos">483</span></a><span class="sd">                - Prevents cross-contamination between concurrent requests</span>
</span><span id="Store.CollectWarehouseResponses.run-484"><a href="#Store.CollectWarehouseResponses.run-484"><span class="linenos">484</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-485"><a href="#Store.CollectWarehouseResponses.run-485"><span class="linenos">485</span></a><span class="sd">            2. **Collection Phase** (FIPA: Proposal Reception):</span>
</span><span id="Store.CollectWarehouseResponses.run-486"><a href="#Store.CollectWarehouseResponses.run-486"><span class="linenos">486</span></a><span class="sd">                - Delegates to ReceiveAllResponses worker behaviour</span>
</span><span id="Store.CollectWarehouseResponses.run-487"><a href="#Store.CollectWarehouseResponses.run-487"><span class="linenos">487</span></a><span class="sd">                - Worker populates acceptances (proposals) and rejections (refusals) lists</span>
</span><span id="Store.CollectWarehouseResponses.run-488"><a href="#Store.CollectWarehouseResponses.run-488"><span class="linenos">488</span></a><span class="sd">                - Implements timeout mechanism (5 seconds total)</span>
</span><span id="Store.CollectWarehouseResponses.run-489"><a href="#Store.CollectWarehouseResponses.run-489"><span class="linenos">489</span></a><span class="sd">                - Handles partial responses gracefully (some warehouses may not respond)</span>
</span><span id="Store.CollectWarehouseResponses.run-490"><a href="#Store.CollectWarehouseResponses.run-490"><span class="linenos">490</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-491"><a href="#Store.CollectWarehouseResponses.run-491"><span class="linenos">491</span></a><span class="sd">            3. **Evaluation Phase** (FIPA: Proposal Evaluation):</span>
</span><span id="Store.CollectWarehouseResponses.run-492"><a href="#Store.CollectWarehouseResponses.run-492"><span class="linenos">492</span></a><span class="sd">                - Calculates score for each acceptance using calculate_warehouse_score()</span>
</span><span id="Store.CollectWarehouseResponses.run-493"><a href="#Store.CollectWarehouseResponses.run-493"><span class="linenos">493</span></a><span class="sd">                - Score based on Dijkstra pathfinding: delivery_time from warehouse to store</span>
</span><span id="Store.CollectWarehouseResponses.run-494"><a href="#Store.CollectWarehouseResponses.run-494"><span class="linenos">494</span></a><span class="sd">                - Selects warehouse with lowest score (shortest delivery time)</span>
</span><span id="Store.CollectWarehouseResponses.run-495"><a href="#Store.CollectWarehouseResponses.run-495"><span class="linenos">495</span></a><span class="sd">                - Implements best-proposal selection strategy from FIPA specification</span>
</span><span id="Store.CollectWarehouseResponses.run-496"><a href="#Store.CollectWarehouseResponses.run-496"><span class="linenos">496</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-497"><a href="#Store.CollectWarehouseResponses.run-497"><span class="linenos">497</span></a><span class="sd">            4. **Award Phase** (FIPA: Result Notification):</span>
</span><span id="Store.CollectWarehouseResponses.run-498"><a href="#Store.CollectWarehouseResponses.run-498"><span class="linenos">498</span></a><span class="sd">                - Sends store-confirm to winner (FIPA accept-proposal performative)</span>
</span><span id="Store.CollectWarehouseResponses.run-499"><a href="#Store.CollectWarehouseResponses.run-499"><span class="linenos">499</span></a><span class="sd">                - Sends store-deny to all other acceptors (FIPA reject-proposal performative)</span>
</span><span id="Store.CollectWarehouseResponses.run-500"><a href="#Store.CollectWarehouseResponses.run-500"><span class="linenos">500</span></a><span class="sd">                - Rejected participants (warehouse-reject) are not contacted again</span>
</span><span id="Store.CollectWarehouseResponses.run-501"><a href="#Store.CollectWarehouseResponses.run-501"><span class="linenos">501</span></a><span class="sd">                - Winner proceeds to order confirmation and vehicle assignment</span>
</span><span id="Store.CollectWarehouseResponses.run-502"><a href="#Store.CollectWarehouseResponses.run-502"><span class="linenos">502</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-503"><a href="#Store.CollectWarehouseResponses.run-503"><span class="linenos">503</span></a><span class="sd">            5. **Failure Handling**:</span>
</span><span id="Store.CollectWarehouseResponses.run-504"><a href="#Store.CollectWarehouseResponses.run-504"><span class="linenos">504</span></a><span class="sd">                - If no acceptances received: Adds request to failed_requests queue</span>
</span><span id="Store.CollectWarehouseResponses.run-505"><a href="#Store.CollectWarehouseResponses.run-505"><span class="linenos">505</span></a><span class="sd">                - Failed requests automatically retried by RetryPreviousBuy behaviour</span>
</span><span id="Store.CollectWarehouseResponses.run-506"><a href="#Store.CollectWarehouseResponses.run-506"><span class="linenos">506</span></a><span class="sd">                - Maintains same request_id for tracking across retry attempts</span>
</span><span id="Store.CollectWarehouseResponses.run-507"><a href="#Store.CollectWarehouseResponses.run-507"><span class="linenos">507</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-508"><a href="#Store.CollectWarehouseResponses.run-508"><span class="linenos">508</span></a><span class="sd">            Template Configuration:</span>
</span><span id="Store.CollectWarehouseResponses.run-509"><a href="#Store.CollectWarehouseResponses.run-509"><span class="linenos">509</span></a><span class="sd">                - **Matches**: store_id (this store) AND request_id (this specific request)</span>
</span><span id="Store.CollectWarehouseResponses.run-510"><a href="#Store.CollectWarehouseResponses.run-510"><span class="linenos">510</span></a><span class="sd">                - **Accepts**: Both warehouse-accept AND warehouse-reject performatives</span>
</span><span id="Store.CollectWarehouseResponses.run-511"><a href="#Store.CollectWarehouseResponses.run-511"><span class="linenos">511</span></a><span class="sd">                - **Purpose**: Filters responses to avoid conflicts with concurrent requests</span>
</span><span id="Store.CollectWarehouseResponses.run-512"><a href="#Store.CollectWarehouseResponses.run-512"><span class="linenos">512</span></a><span class="sd">                - **Design**: Intentionally doesn&#39;t filter by performative to collect all responses</span>
</span><span id="Store.CollectWarehouseResponses.run-513"><a href="#Store.CollectWarehouseResponses.run-513"><span class="linenos">513</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-514"><a href="#Store.CollectWarehouseResponses.run-514"><span class="linenos">514</span></a><span class="sd">            Scoring Process (Distance-Based Selection):</span>
</span><span id="Store.CollectWarehouseResponses.run-515"><a href="#Store.CollectWarehouseResponses.run-515"><span class="linenos">515</span></a><span class="sd">                For each warehouse that sent propose (warehouse-accept):</span>
</span><span id="Store.CollectWarehouseResponses.run-516"><a href="#Store.CollectWarehouseResponses.run-516"><span class="linenos">516</span></a><span class="sd">                1. Extract warehouse node_id from message metadata</span>
</span><span id="Store.CollectWarehouseResponses.run-517"><a href="#Store.CollectWarehouseResponses.run-517"><span class="linenos">517</span></a><span class="sd">                2. Use Dijkstra algorithm: calculate (path, fuel, time) warehouse -&gt; store</span>
</span><span id="Store.CollectWarehouseResponses.run-518"><a href="#Store.CollectWarehouseResponses.run-518"><span class="linenos">518</span></a><span class="sd">                3. Score = delivery time (lower is better)</span>
</span><span id="Store.CollectWarehouseResponses.run-519"><a href="#Store.CollectWarehouseResponses.run-519"><span class="linenos">519</span></a><span class="sd">                4. Select warehouse with minimum score</span>
</span><span id="Store.CollectWarehouseResponses.run-520"><a href="#Store.CollectWarehouseResponses.run-520"><span class="linenos">520</span></a><span class="sd">                5. Tie-breaking: First warehouse with minimum score wins</span>
</span><span id="Store.CollectWarehouseResponses.run-521"><a href="#Store.CollectWarehouseResponses.run-521"><span class="linenos">521</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-522"><a href="#Store.CollectWarehouseResponses.run-522"><span class="linenos">522</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.CollectWarehouseResponses.run-523"><a href="#Store.CollectWarehouseResponses.run-523"><span class="linenos">523</span></a><span class="sd">                - Adds ReceiveAllResponses worker behaviour to agent (with template)</span>
</span><span id="Store.CollectWarehouseResponses.run-524"><a href="#Store.CollectWarehouseResponses.run-524"><span class="linenos">524</span></a><span class="sd">                - Adds SendStoreConfirmation behaviour for winner</span>
</span><span id="Store.CollectWarehouseResponses.run-525"><a href="#Store.CollectWarehouseResponses.run-525"><span class="linenos">525</span></a><span class="sd">                - Adds SendStoreDenial behaviour for each non-winner</span>
</span><span id="Store.CollectWarehouseResponses.run-526"><a href="#Store.CollectWarehouseResponses.run-526"><span class="linenos">526</span></a><span class="sd">                - May enqueue failed request to failed_requests queue</span>
</span><span id="Store.CollectWarehouseResponses.run-527"><a href="#Store.CollectWarehouseResponses.run-527"><span class="linenos">527</span></a><span class="sd">                - Prints evaluation details if verbose mode enabled</span>
</span><span id="Store.CollectWarehouseResponses.run-528"><a href="#Store.CollectWarehouseResponses.run-528"><span class="linenos">528</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-529"><a href="#Store.CollectWarehouseResponses.run-529"><span class="linenos">529</span></a><span class="sd">            Returns:</span>
</span><span id="Store.CollectWarehouseResponses.run-530"><a href="#Store.CollectWarehouseResponses.run-530"><span class="linenos">530</span></a><span class="sd">                None. Completes when all confirmations/denials are sent, or when</span>
</span><span id="Store.CollectWarehouseResponses.run-531"><a href="#Store.CollectWarehouseResponses.run-531"><span class="linenos">531</span></a><span class="sd">                failed request is enqueued for retry.</span>
</span><span id="Store.CollectWarehouseResponses.run-532"><a href="#Store.CollectWarehouseResponses.run-532"><span class="linenos">532</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-533"><a href="#Store.CollectWarehouseResponses.run-533"><span class="linenos">533</span></a><span class="sd">            Example Execution:</span>
</span><span id="Store.CollectWarehouseResponses.run-534"><a href="#Store.CollectWarehouseResponses.run-534"><span class="linenos">534</span></a><span class="sd">                ```</span>
</span><span id="Store.CollectWarehouseResponses.run-535"><a href="#Store.CollectWarehouseResponses.run-535"><span class="linenos">535</span></a><span class="sd">                CFP: &quot;50 electronics&quot; to 3 warehouses</span>
</span><span id="Store.CollectWarehouseResponses.run-536"><a href="#Store.CollectWarehouseResponses.run-536"><span class="linenos">536</span></a><span class="sd">                Responses:</span>
</span><span id="Store.CollectWarehouseResponses.run-537"><a href="#Store.CollectWarehouseResponses.run-537"><span class="linenos">537</span></a><span class="sd">                    - warehouse1: accept (node_id=10, distance=150, score=150)</span>
</span><span id="Store.CollectWarehouseResponses.run-538"><a href="#Store.CollectWarehouseResponses.run-538"><span class="linenos">538</span></a><span class="sd">                    - warehouse2: accept (node_id=5, distance=80, score=80) &lt;- WINNER</span>
</span><span id="Store.CollectWarehouseResponses.run-539"><a href="#Store.CollectWarehouseResponses.run-539"><span class="linenos">539</span></a><span class="sd">                    - warehouse3: reject (reason=out_of_stock)</span>
</span><span id="Store.CollectWarehouseResponses.run-540"><a href="#Store.CollectWarehouseResponses.run-540"><span class="linenos">540</span></a><span class="sd">                Actions:</span>
</span><span id="Store.CollectWarehouseResponses.run-541"><a href="#Store.CollectWarehouseResponses.run-541"><span class="linenos">541</span></a><span class="sd">                    - SendStoreConfirmation(warehouse2) -&gt; accept-proposal</span>
</span><span id="Store.CollectWarehouseResponses.run-542"><a href="#Store.CollectWarehouseResponses.run-542"><span class="linenos">542</span></a><span class="sd">                    - SendStoreDenial(warehouse1) -&gt; reject-proposal</span>
</span><span id="Store.CollectWarehouseResponses.run-543"><a href="#Store.CollectWarehouseResponses.run-543"><span class="linenos">543</span></a><span class="sd">                    - No action for warehouse3 (already refused)</span>
</span><span id="Store.CollectWarehouseResponses.run-544"><a href="#Store.CollectWarehouseResponses.run-544"><span class="linenos">544</span></a><span class="sd">                Result: Order placed with warehouse2</span>
</span><span id="Store.CollectWarehouseResponses.run-545"><a href="#Store.CollectWarehouseResponses.run-545"><span class="linenos">545</span></a><span class="sd">                ```</span>
</span><span id="Store.CollectWarehouseResponses.run-546"><a href="#Store.CollectWarehouseResponses.run-546"><span class="linenos">546</span></a><span class="sd">            </span>
</span><span id="Store.CollectWarehouseResponses.run-547"><a href="#Store.CollectWarehouseResponses.run-547"><span class="linenos">547</span></a><span class="sd">            Note:</span>
</span><span id="Store.CollectWarehouseResponses.run-548"><a href="#Store.CollectWarehouseResponses.run-548"><span class="linenos">548</span></a><span class="sd">                This method implements the core decision-making logic of the FIPA Contract</span>
</span><span id="Store.CollectWarehouseResponses.run-549"><a href="#Store.CollectWarehouseResponses.run-549"><span class="linenos">549</span></a><span class="sd">                Net Protocol, transforming raw proposals into a concrete purchase order with</span>
</span><span id="Store.CollectWarehouseResponses.run-550"><a href="#Store.CollectWarehouseResponses.run-550"><span class="linenos">550</span></a><span class="sd">                the optimal warehouse.</span>
</span><span id="Store.CollectWarehouseResponses.run-551"><a href="#Store.CollectWarehouseResponses.run-551"><span class="linenos">551</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.CollectWarehouseResponses.run-552"><a href="#Store.CollectWarehouseResponses.run-552"><span class="linenos">552</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.CollectWarehouseResponses.run-553"><a href="#Store.CollectWarehouseResponses.run-553"><span class="linenos">553</span></a>            
</span><span id="Store.CollectWarehouseResponses.run-554"><a href="#Store.CollectWarehouseResponses.run-554"><span class="linenos">554</span></a>            <span class="c1"># Setup template that accepts BOTH warehouse-accept AND warehouse-reject</span>
</span><span id="Store.CollectWarehouseResponses.run-555"><a href="#Store.CollectWarehouseResponses.run-555"><span class="linenos">555</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Store.CollectWarehouseResponses.run-556"><a href="#Store.CollectWarehouseResponses.run-556"><span class="linenos">556</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store.CollectWarehouseResponses.run-557"><a href="#Store.CollectWarehouseResponses.run-557"><span class="linenos">557</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store.CollectWarehouseResponses.run-558"><a href="#Store.CollectWarehouseResponses.run-558"><span class="linenos">558</span></a>            <span class="c1"># Don&#39;t filter by performative - we want both accept and reject</span>
</span><span id="Store.CollectWarehouseResponses.run-559"><a href="#Store.CollectWarehouseResponses.run-559"><span class="linenos">559</span></a>            
</span><span id="Store.CollectWarehouseResponses.run-560"><a href="#Store.CollectWarehouseResponses.run-560"><span class="linenos">560</span></a>            <span class="c1"># Create a combined behaviour to listen for both</span>
</span><span id="Store.CollectWarehouseResponses.run-561"><a href="#Store.CollectWarehouseResponses.run-561"><span class="linenos">561</span></a>            <span class="n">combined_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ReceiveAllResponses</span><span class="p">(</span>
</span><span id="Store.CollectWarehouseResponses.run-562"><a href="#Store.CollectWarehouseResponses.run-562"><span class="linenos">562</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span id="Store.CollectWarehouseResponses.run-563"><a href="#Store.CollectWarehouseResponses.run-563"><span class="linenos">563</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span><span class="p">,</span>
</span><span id="Store.CollectWarehouseResponses.run-564"><a href="#Store.CollectWarehouseResponses.run-564"><span class="linenos">564</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">,</span>
</span><span id="Store.CollectWarehouseResponses.run-565"><a href="#Store.CollectWarehouseResponses.run-565"><span class="linenos">565</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span>
</span><span id="Store.CollectWarehouseResponses.run-566"><a href="#Store.CollectWarehouseResponses.run-566"><span class="linenos">566</span></a>            <span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-567"><a href="#Store.CollectWarehouseResponses.run-567"><span class="linenos">567</span></a>            
</span><span id="Store.CollectWarehouseResponses.run-568"><a href="#Store.CollectWarehouseResponses.run-568"><span class="linenos">568</span></a>            <span class="c1"># Add with template that matches both performatives</span>
</span><span id="Store.CollectWarehouseResponses.run-569"><a href="#Store.CollectWarehouseResponses.run-569"><span class="linenos">569</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">combined_behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-570"><a href="#Store.CollectWarehouseResponses.run-570"><span class="linenos">570</span></a>            
</span><span id="Store.CollectWarehouseResponses.run-571"><a href="#Store.CollectWarehouseResponses.run-571"><span class="linenos">571</span></a>            <span class="c1"># Wait for collection to complete</span>
</span><span id="Store.CollectWarehouseResponses.run-572"><a href="#Store.CollectWarehouseResponses.run-572"><span class="linenos">572</span></a>            <span class="k">await</span> <span class="n">combined_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Store.CollectWarehouseResponses.run-573"><a href="#Store.CollectWarehouseResponses.run-573"><span class="linenos">573</span></a>            
</span><span id="Store.CollectWarehouseResponses.run-574"><a href="#Store.CollectWarehouseResponses.run-574"><span class="linenos">574</span></a>            <span class="c1"># Now evaluate and choose best warehouse</span>
</span><span id="Store.CollectWarehouseResponses.run-575"><a href="#Store.CollectWarehouseResponses.run-575"><span class="linenos">575</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses.run-576"><a href="#Store.CollectWarehouseResponses.run-576"><span class="linenos">576</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses.run-577"><a href="#Store.CollectWarehouseResponses.run-577"><span class="linenos">577</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> acceptance(s) and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejection(s)&quot;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-578"><a href="#Store.CollectWarehouseResponses.run-578"><span class="linenos">578</span></a>                
</span><span id="Store.CollectWarehouseResponses.run-579"><a href="#Store.CollectWarehouseResponses.run-579"><span class="linenos">579</span></a>                <span class="c1"># Calculate scores for each warehouse that accepted</span>
</span><span id="Store.CollectWarehouseResponses.run-580"><a href="#Store.CollectWarehouseResponses.run-580"><span class="linenos">580</span></a>                <span class="n">best_warehouse</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Store.CollectWarehouseResponses.run-581"><a href="#Store.CollectWarehouseResponses.run-581"><span class="linenos">581</span></a>                <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-582"><a href="#Store.CollectWarehouseResponses.run-582"><span class="linenos">582</span></a>                
</span><span id="Store.CollectWarehouseResponses.run-583"><a href="#Store.CollectWarehouseResponses.run-583"><span class="linenos">583</span></a>                
</span><span id="Store.CollectWarehouseResponses.run-584"><a href="#Store.CollectWarehouseResponses.run-584"><span class="linenos">584</span></a>                <span class="k">for</span> <span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses.run-585"><a href="#Store.CollectWarehouseResponses.run-585"><span class="linenos">585</span></a>                    <span class="n">score</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">calculate_warehouse_score</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-586"><a href="#Store.CollectWarehouseResponses.run-586"><span class="linenos">586</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses.run-587"><a href="#Store.CollectWarehouseResponses.run-587"><span class="linenos">587</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Warehouse </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2"> score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-588"><a href="#Store.CollectWarehouseResponses.run-588"><span class="linenos">588</span></a>                    
</span><span id="Store.CollectWarehouseResponses.run-589"><a href="#Store.CollectWarehouseResponses.run-589"><span class="linenos">589</span></a>                    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">best_score</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses.run-590"><a href="#Store.CollectWarehouseResponses.run-590"><span class="linenos">590</span></a>                        <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
</span><span id="Store.CollectWarehouseResponses.run-591"><a href="#Store.CollectWarehouseResponses.run-591"><span class="linenos">591</span></a>                        <span class="n">best_warehouse</span> <span class="o">=</span> <span class="p">(</span><span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-592"><a href="#Store.CollectWarehouseResponses.run-592"><span class="linenos">592</span></a>                
</span><span id="Store.CollectWarehouseResponses.run-593"><a href="#Store.CollectWarehouseResponses.run-593"><span class="linenos">593</span></a>                <span class="k">if</span> <span class="n">best_warehouse</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses.run-594"><a href="#Store.CollectWarehouseResponses.run-594"><span class="linenos">594</span></a>                    <span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="o">=</span> <span class="n">best_warehouse</span>
</span><span id="Store.CollectWarehouseResponses.run-595"><a href="#Store.CollectWarehouseResponses.run-595"><span class="linenos">595</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses.run-596"><a href="#Store.CollectWarehouseResponses.run-596"><span class="linenos">596</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Selected warehouse </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2"> with score </span><span class="si">{</span><span class="n">best_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-597"><a href="#Store.CollectWarehouseResponses.run-597"><span class="linenos">597</span></a>                    
</span><span id="Store.CollectWarehouseResponses.run-598"><a href="#Store.CollectWarehouseResponses.run-598"><span class="linenos">598</span></a>                    <span class="c1"># Send confirmation to the chosen warehouse</span>
</span><span id="Store.CollectWarehouseResponses.run-599"><a href="#Store.CollectWarehouseResponses.run-599"><span class="linenos">599</span></a>                    <span class="n">confirm_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendStoreConfirmation</span><span class="p">(</span><span class="n">accept_msg</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-600"><a href="#Store.CollectWarehouseResponses.run-600"><span class="linenos">600</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">confirm_behav</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-601"><a href="#Store.CollectWarehouseResponses.run-601"><span class="linenos">601</span></a>                    <span class="k">await</span> <span class="n">confirm_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Store.CollectWarehouseResponses.run-602"><a href="#Store.CollectWarehouseResponses.run-602"><span class="linenos">602</span></a>                    
</span><span id="Store.CollectWarehouseResponses.run-603"><a href="#Store.CollectWarehouseResponses.run-603"><span class="linenos">603</span></a>                    <span class="c1"># Send denial to other warehouses that accepted but weren&#39;t chosen</span>
</span><span id="Store.CollectWarehouseResponses.run-604"><a href="#Store.CollectWarehouseResponses.run-604"><span class="linenos">604</span></a>                    <span class="k">for</span> <span class="n">other_warehouse_jid</span><span class="p">,</span> <span class="n">other_msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses.run-605"><a href="#Store.CollectWarehouseResponses.run-605"><span class="linenos">605</span></a>                        <span class="k">if</span> <span class="n">other_warehouse_jid</span> <span class="o">!=</span> <span class="n">warehouse_jid</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses.run-606"><a href="#Store.CollectWarehouseResponses.run-606"><span class="linenos">606</span></a>                            <span class="n">deny_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendStoreDenial</span><span class="p">(</span><span class="n">other_msg</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-607"><a href="#Store.CollectWarehouseResponses.run-607"><span class="linenos">607</span></a>                            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">deny_behav</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-608"><a href="#Store.CollectWarehouseResponses.run-608"><span class="linenos">608</span></a>                            <span class="k">await</span> <span class="n">deny_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Store.CollectWarehouseResponses.run-609"><a href="#Store.CollectWarehouseResponses.run-609"><span class="linenos">609</span></a>                            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses.run-610"><a href="#Store.CollectWarehouseResponses.run-610"><span class="linenos">610</span></a>                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent denial to </span><span class="si">{</span><span class="n">other_warehouse_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-611"><a href="#Store.CollectWarehouseResponses.run-611"><span class="linenos">611</span></a>                    
</span><span id="Store.CollectWarehouseResponses.run-612"><a href="#Store.CollectWarehouseResponses.run-612"><span class="linenos">612</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses.run-613"><a href="#Store.CollectWarehouseResponses.run-613"><span class="linenos">613</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.CollectWarehouseResponses.run-614"><a href="#Store.CollectWarehouseResponses.run-614"><span class="linenos">614</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No acceptances received. All warehouses rejected or timed out.&quot;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-615"><a href="#Store.CollectWarehouseResponses.run-615"><span class="linenos">615</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Request saved in self.failed_requests&quot;</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-616"><a href="#Store.CollectWarehouseResponses.run-616"><span class="linenos">616</span></a>                
</span><span id="Store.CollectWarehouseResponses.run-617"><a href="#Store.CollectWarehouseResponses.run-617"><span class="linenos">617</span></a>                <span class="c1"># Add to failed requests</span>
</span><span id="Store.CollectWarehouseResponses.run-618"><a href="#Store.CollectWarehouseResponses.run-618"><span class="linenos">618</span></a>                <span class="n">failed_msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span><span class="o">.</span><span class="n">to</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-619"><a href="#Store.CollectWarehouseResponses.run-619"><span class="linenos">619</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">set_buy_metadata</span><span class="p">(</span><span class="n">failed_msg</span><span class="p">)</span>
</span><span id="Store.CollectWarehouseResponses.run-620"><a href="#Store.CollectWarehouseResponses.run-620"><span class="linenos">620</span></a>                <span class="n">failed_msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store.CollectWarehouseResponses.run-621"><a href="#Store.CollectWarehouseResponses.run-621"><span class="linenos">621</span></a>                <span class="n">failed_msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_msg</span>
</span><span id="Store.CollectWarehouseResponses.run-622"><a href="#Store.CollectWarehouseResponses.run-622"><span class="linenos">622</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">failed_msg</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Execute the warehouse proposal collection and evaluation process.</p>

<p>This method coordinates the entire FIPA Contract Net Protocol workflow
for warehouse selection. It sets up message filtering, launches the worker
behaviour for response collection, evaluates all proposals using a scoring
algorithm, and sends confirmations/rejections to participants according to
the FIPA protocol specification.</p>

<p>FIPA Contract Net Protocol Implementation:</p>

<ol>
<li><p><strong>Setup Phase</strong> (FIPA: Preparation):</p>

<ul>
<li>Creates template matching request_id and store_id metadata</li>
<li>Allows both warehouse-accept (propose) and warehouse-reject (refuse)</li>
<li>Ensures only responses for THIS specific request are collected</li>
<li>Prevents cross-contamination between concurrent requests</li>
</ul></li>
<li><p><strong>Collection Phase</strong> (FIPA: Proposal Reception):</p>

<ul>
<li>Delegates to ReceiveAllResponses worker behaviour</li>
<li>Worker populates acceptances (proposals) and rejections (refusals) lists</li>
<li>Implements timeout mechanism (5 seconds total)</li>
<li>Handles partial responses gracefully (some warehouses may not respond)</li>
</ul></li>
<li><p><strong>Evaluation Phase</strong> (FIPA: Proposal Evaluation):</p>

<ul>
<li>Calculates score for each acceptance using calculate_warehouse_score()</li>
<li>Score based on Dijkstra pathfinding: delivery_time from warehouse to store</li>
<li>Selects warehouse with lowest score (shortest delivery time)</li>
<li>Implements best-proposal selection strategy from FIPA specification</li>
</ul></li>
<li><p><strong>Award Phase</strong> (FIPA: Result Notification):</p>

<ul>
<li>Sends store-confirm to winner (FIPA accept-proposal performative)</li>
<li>Sends store-deny to all other acceptors (FIPA reject-proposal performative)</li>
<li>Rejected participants (warehouse-reject) are not contacted again</li>
<li>Winner proceeds to order confirmation and vehicle assignment</li>
</ul></li>
<li><p><strong>Failure Handling</strong>:</p>

<ul>
<li>If no acceptances received: Adds request to failed_requests queue</li>
<li>Failed requests automatically retried by RetryPreviousBuy behaviour</li>
<li>Maintains same request_id for tracking across retry attempts</li>
</ul></li>
</ol>

<h6 id="template-configuration">Template Configuration:</h6>

<blockquote>
  <ul>
  <li><strong>Matches</strong>: store_id (this store) AND request_id (this specific request)</li>
  <li><strong>Accepts</strong>: Both warehouse-accept AND warehouse-reject performatives</li>
  <li><strong>Purpose</strong>: Filters responses to avoid conflicts with concurrent requests</li>
  <li><strong>Design</strong>: Intentionally doesn't filter by performative to collect all responses</li>
  </ul>
</blockquote>

<p>Scoring Process (Distance-Based Selection):
    For each warehouse that sent propose (warehouse-accept):
    1. Extract warehouse node_id from message metadata
    2. Use Dijkstra algorithm: calculate (path, fuel, time) warehouse -> store
    3. Score = delivery time (lower is better)
    4. Select warehouse with minimum score
    5. Tie-breaking: First warehouse with minimum score wins</p>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Adds ReceiveAllResponses worker behaviour to agent (with template)</li>
  <li>Adds SendStoreConfirmation behaviour for winner</li>
  <li>Adds SendStoreDenial behaviour for each non-winner</li>
  <li>May enqueue failed request to failed_requests queue</li>
  <li>Prints evaluation details if verbose mode enabled</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Completes when all confirmations/denials are sent, or when
  failed request is enqueued for retry.</p>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
<pre><code>CFP: "50 electronics" to 3 warehouses
Responses:
    - warehouse1: accept (node_id=10, distance=150, score=150)
    - warehouse2: accept (node_id=5, distance=80, score=80) &lt;- WINNER
    - warehouse3: reject (reason=out_of_stock)
Actions:
    - SendStoreConfirmation(warehouse2) -&gt; accept-proposal
    - SendStoreDenial(warehouse1) -&gt; reject-proposal
    - No action for warehouse3 (already refused)
Result: Order placed with warehouse2
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This method implements the core decision-making logic of the FIPA Contract
  Net Protocol, transforming raw proposals into a concrete purchase order with
  the optimal warehouse.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Store.ReceiveAllResponses">
                            <input id="Store.ReceiveAllResponses-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Store.ReceiveAllResponses</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Store.ReceiveAllResponses-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.ReceiveAllResponses"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.ReceiveAllResponses-624"><a href="#Store.ReceiveAllResponses-624"><span class="linenos">624</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveAllResponses</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Store.ReceiveAllResponses-625"><a href="#Store.ReceiveAllResponses-625"><span class="linenos">625</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.ReceiveAllResponses-626"><a href="#Store.ReceiveAllResponses-626"><span class="linenos">626</span></a><span class="sd">        Worker behaviour for collecting warehouse responses in FIPA Contract Net Protocol.</span>
</span><span id="Store.ReceiveAllResponses-627"><a href="#Store.ReceiveAllResponses-627"><span class="linenos">627</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveAllResponses-628"><a href="#Store.ReceiveAllResponses-628"><span class="linenos">628</span></a><span class="sd">        This behaviour acts as the worker component in a coordinator/worker pattern,</span>
</span><span id="Store.ReceiveAllResponses-629"><a href="#Store.ReceiveAllResponses-629"><span class="linenos">629</span></a><span class="sd">        handling the actual message reception during the proposal collection phase of</span>
</span><span id="Store.ReceiveAllResponses-630"><a href="#Store.ReceiveAllResponses-630"><span class="linenos">630</span></a><span class="sd">        the FIPA Contract Net Protocol. It listens for both proposals (warehouse-accept)</span>
</span><span id="Store.ReceiveAllResponses-631"><a href="#Store.ReceiveAllResponses-631"><span class="linenos">631</span></a><span class="sd">        and refusals (warehouse-reject) from warehouses, populating shared lists that</span>
</span><span id="Store.ReceiveAllResponses-632"><a href="#Store.ReceiveAllResponses-632"><span class="linenos">632</span></a><span class="sd">        the coordinator (CollectWarehouseResponses) will evaluate.</span>
</span><span id="Store.ReceiveAllResponses-633"><a href="#Store.ReceiveAllResponses-633"><span class="linenos">633</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveAllResponses-634"><a href="#Store.ReceiveAllResponses-634"><span class="linenos">634</span></a><span class="sd">        FIPA Protocol Phase: **Proposal Reception**</span>
</span><span id="Store.ReceiveAllResponses-635"><a href="#Store.ReceiveAllResponses-635"><span class="linenos">635</span></a><span class="sd">            - Role: Participant response collector (worker)</span>
</span><span id="Store.ReceiveAllResponses-636"><a href="#Store.ReceiveAllResponses-636"><span class="linenos">636</span></a><span class="sd">            - Coordinator: CollectWarehouseResponses</span>
</span><span id="Store.ReceiveAllResponses-637"><a href="#Store.ReceiveAllResponses-637"><span class="linenos">637</span></a><span class="sd">            - Expected messages: warehouse-accept (propose) and warehouse-reject (refuse)</span>
</span><span id="Store.ReceiveAllResponses-638"><a href="#Store.ReceiveAllResponses-638"><span class="linenos">638</span></a><span class="sd">            - Timeout: 5 seconds total for all responses</span>
</span><span id="Store.ReceiveAllResponses-639"><a href="#Store.ReceiveAllResponses-639"><span class="linenos">639</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveAllResponses-640"><a href="#Store.ReceiveAllResponses-640"><span class="linenos">640</span></a><span class="sd">        The behaviour implements a timeout mechanism to handle scenarios where some</span>
</span><span id="Store.ReceiveAllResponses-641"><a href="#Store.ReceiveAllResponses-641"><span class="linenos">641</span></a><span class="sd">        warehouses may be slow to respond or unavailable. It collects responses until</span>
</span><span id="Store.ReceiveAllResponses-642"><a href="#Store.ReceiveAllResponses-642"><span class="linenos">642</span></a><span class="sd">        either all expected warehouses respond or the timeout expires.</span>
</span><span id="Store.ReceiveAllResponses-643"><a href="#Store.ReceiveAllResponses-643"><span class="linenos">643</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveAllResponses-644"><a href="#Store.ReceiveAllResponses-644"><span class="linenos">644</span></a><span class="sd">        Attributes:</span>
</span><span id="Store.ReceiveAllResponses-645"><a href="#Store.ReceiveAllResponses-645"><span class="linenos">645</span></a><span class="sd">            request_id (int): Unique request identifier for filtering messages.</span>
</span><span id="Store.ReceiveAllResponses-646"><a href="#Store.ReceiveAllResponses-646"><span class="linenos">646</span></a><span class="sd">                Ensures only responses for this specific CFP are processed.</span>
</span><span id="Store.ReceiveAllResponses-647"><a href="#Store.ReceiveAllResponses-647"><span class="linenos">647</span></a><span class="sd">            num_warehouses (int): Expected number of warehouse responses.</span>
</span><span id="Store.ReceiveAllResponses-648"><a href="#Store.ReceiveAllResponses-648"><span class="linenos">648</span></a><span class="sd">                Used to determine when collection is complete.</span>
</span><span id="Store.ReceiveAllResponses-649"><a href="#Store.ReceiveAllResponses-649"><span class="linenos">649</span></a><span class="sd">            acceptances (list[tuple[str, Message]]): Shared list with coordinator.</span>
</span><span id="Store.ReceiveAllResponses-650"><a href="#Store.ReceiveAllResponses-650"><span class="linenos">650</span></a><span class="sd">                Populated with (warehouse_jid, message) for each propose.</span>
</span><span id="Store.ReceiveAllResponses-651"><a href="#Store.ReceiveAllResponses-651"><span class="linenos">651</span></a><span class="sd">            rejections (list[tuple[str, Message, str]]): Shared list with coordinator.</span>
</span><span id="Store.ReceiveAllResponses-652"><a href="#Store.ReceiveAllResponses-652"><span class="linenos">652</span></a><span class="sd">                Populated with (warehouse_jid, message, reason) for each refuse.</span>
</span><span id="Store.ReceiveAllResponses-653"><a href="#Store.ReceiveAllResponses-653"><span class="linenos">653</span></a><span class="sd">            responses_received (int): Counter tracking received responses.</span>
</span><span id="Store.ReceiveAllResponses-654"><a href="#Store.ReceiveAllResponses-654"><span class="linenos">654</span></a><span class="sd">                Incremented for both accepts and rejects.</span>
</span><span id="Store.ReceiveAllResponses-655"><a href="#Store.ReceiveAllResponses-655"><span class="linenos">655</span></a><span class="sd">            timeout (int): Maximum seconds to wait for all responses (default: 5).</span>
</span><span id="Store.ReceiveAllResponses-656"><a href="#Store.ReceiveAllResponses-656"><span class="linenos">656</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveAllResponses-657"><a href="#Store.ReceiveAllResponses-657"><span class="linenos">657</span></a><span class="sd">        Message Processing:</span>
</span><span id="Store.ReceiveAllResponses-658"><a href="#Store.ReceiveAllResponses-658"><span class="linenos">658</span></a><span class="sd">            - **warehouse-accept** (FIPA propose):</span>
</span><span id="Store.ReceiveAllResponses-659"><a href="#Store.ReceiveAllResponses-659"><span class="linenos">659</span></a><span class="sd">                Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.ReceiveAllResponses-660"><a href="#Store.ReceiveAllResponses-660"><span class="linenos">660</span></a><span class="sd">                Action: Append (warehouse_jid, msg) to acceptances</span>
</span><span id="Store.ReceiveAllResponses-661"><a href="#Store.ReceiveAllResponses-661"><span class="linenos">661</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-662"><a href="#Store.ReceiveAllResponses-662"><span class="linenos">662</span></a><span class="sd">            - **warehouse-reject** (FIPA refuse):</span>
</span><span id="Store.ReceiveAllResponses-663"><a href="#Store.ReceiveAllResponses-663"><span class="linenos">663</span></a><span class="sd">                Body format: &quot;{quantity} {product} {reason}&quot;</span>
</span><span id="Store.ReceiveAllResponses-664"><a href="#Store.ReceiveAllResponses-664"><span class="linenos">664</span></a><span class="sd">                Action: Append (warehouse_jid, msg, reason) to rejections</span>
</span><span id="Store.ReceiveAllResponses-665"><a href="#Store.ReceiveAllResponses-665"><span class="linenos">665</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveAllResponses-666"><a href="#Store.ReceiveAllResponses-666"><span class="linenos">666</span></a><span class="sd">        Timeout Logic:</span>
</span><span id="Store.ReceiveAllResponses-667"><a href="#Store.ReceiveAllResponses-667"><span class="linenos">667</span></a><span class="sd">            - Tracks elapsed time from start</span>
</span><span id="Store.ReceiveAllResponses-668"><a href="#Store.ReceiveAllResponses-668"><span class="linenos">668</span></a><span class="sd">            - Calculates remaining_timeout for each receive() call</span>
</span><span id="Store.ReceiveAllResponses-669"><a href="#Store.ReceiveAllResponses-669"><span class="linenos">669</span></a><span class="sd">            - Breaks early if remaining_timeout &lt;= 0</span>
</span><span id="Store.ReceiveAllResponses-670"><a href="#Store.ReceiveAllResponses-670"><span class="linenos">670</span></a><span class="sd">            - Allows partial responses (fewer than num_warehouses)</span>
</span><span id="Store.ReceiveAllResponses-671"><a href="#Store.ReceiveAllResponses-671"><span class="linenos">671</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveAllResponses-672"><a href="#Store.ReceiveAllResponses-672"><span class="linenos">672</span></a><span class="sd">        Example Execution:</span>
</span><span id="Store.ReceiveAllResponses-673"><a href="#Store.ReceiveAllResponses-673"><span class="linenos">673</span></a><span class="sd">            ```</span>
</span><span id="Store.ReceiveAllResponses-674"><a href="#Store.ReceiveAllResponses-674"><span class="linenos">674</span></a><span class="sd">            Expected: 3 warehouses</span>
</span><span id="Store.ReceiveAllResponses-675"><a href="#Store.ReceiveAllResponses-675"><span class="linenos">675</span></a><span class="sd">            Timeline:</span>
</span><span id="Store.ReceiveAllResponses-676"><a href="#Store.ReceiveAllResponses-676"><span class="linenos">676</span></a><span class="sd">                t=0.5s: warehouse1 -&gt; accept (1/3 received)</span>
</span><span id="Store.ReceiveAllResponses-677"><a href="#Store.ReceiveAllResponses-677"><span class="linenos">677</span></a><span class="sd">                t=1.2s: warehouse2 -&gt; reject (2/3 received)</span>
</span><span id="Store.ReceiveAllResponses-678"><a href="#Store.ReceiveAllResponses-678"><span class="linenos">678</span></a><span class="sd">                t=5.0s: timeout reached (warehouse3 no response)</span>
</span><span id="Store.ReceiveAllResponses-679"><a href="#Store.ReceiveAllResponses-679"><span class="linenos">679</span></a><span class="sd">            Result:</span>
</span><span id="Store.ReceiveAllResponses-680"><a href="#Store.ReceiveAllResponses-680"><span class="linenos">680</span></a><span class="sd">                acceptances = [(warehouse1, msg1)]</span>
</span><span id="Store.ReceiveAllResponses-681"><a href="#Store.ReceiveAllResponses-681"><span class="linenos">681</span></a><span class="sd">                rejections = [(warehouse2, msg2, &quot;out_of_stock&quot;)]</span>
</span><span id="Store.ReceiveAllResponses-682"><a href="#Store.ReceiveAllResponses-682"><span class="linenos">682</span></a><span class="sd">                responses_received = 2</span>
</span><span id="Store.ReceiveAllResponses-683"><a href="#Store.ReceiveAllResponses-683"><span class="linenos">683</span></a><span class="sd">            ```</span>
</span><span id="Store.ReceiveAllResponses-684"><a href="#Store.ReceiveAllResponses-684"><span class="linenos">684</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveAllResponses-685"><a href="#Store.ReceiveAllResponses-685"><span class="linenos">685</span></a><span class="sd">        Note:</span>
</span><span id="Store.ReceiveAllResponses-686"><a href="#Store.ReceiveAllResponses-686"><span class="linenos">686</span></a><span class="sd">            This worker behaviour uses shared list references (not copies) to communicate</span>
</span><span id="Store.ReceiveAllResponses-687"><a href="#Store.ReceiveAllResponses-687"><span class="linenos">687</span></a><span class="sd">            with the coordinator, following the coordinator/worker pattern for efficient</span>
</span><span id="Store.ReceiveAllResponses-688"><a href="#Store.ReceiveAllResponses-688"><span class="linenos">688</span></a><span class="sd">            data sharing between behaviours.</span>
</span><span id="Store.ReceiveAllResponses-689"><a href="#Store.ReceiveAllResponses-689"><span class="linenos">689</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.ReceiveAllResponses-690"><a href="#Store.ReceiveAllResponses-690"><span class="linenos">690</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_warehouses</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">acceptances</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">rejections</span> <span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Store.ReceiveAllResponses-691"><a href="#Store.ReceiveAllResponses-691"><span class="linenos">691</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.ReceiveAllResponses-692"><a href="#Store.ReceiveAllResponses-692"><span class="linenos">692</span></a><span class="sd">            Initialize the ReceiveAllResponses worker behaviour.</span>
</span><span id="Store.ReceiveAllResponses-693"><a href="#Store.ReceiveAllResponses-693"><span class="linenos">693</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-694"><a href="#Store.ReceiveAllResponses-694"><span class="linenos">694</span></a><span class="sd">            Args:</span>
</span><span id="Store.ReceiveAllResponses-695"><a href="#Store.ReceiveAllResponses-695"><span class="linenos">695</span></a><span class="sd">                request_id (int): Unique request identifier from ID encoding system.</span>
</span><span id="Store.ReceiveAllResponses-696"><a href="#Store.ReceiveAllResponses-696"><span class="linenos">696</span></a><span class="sd">                    Used to filter incoming messages to only this CFP&#39;s responses.</span>
</span><span id="Store.ReceiveAllResponses-697"><a href="#Store.ReceiveAllResponses-697"><span class="linenos">697</span></a><span class="sd">                num_warehouses (int): Expected number of warehouse responses.</span>
</span><span id="Store.ReceiveAllResponses-698"><a href="#Store.ReceiveAllResponses-698"><span class="linenos">698</span></a><span class="sd">                    Used to determine when all responses received (early termination).</span>
</span><span id="Store.ReceiveAllResponses-699"><a href="#Store.ReceiveAllResponses-699"><span class="linenos">699</span></a><span class="sd">                acceptances (list[tuple[str, Message]]): Shared list reference with coordinator.</span>
</span><span id="Store.ReceiveAllResponses-700"><a href="#Store.ReceiveAllResponses-700"><span class="linenos">700</span></a><span class="sd">                    Worker appends (warehouse_jid, msg) for each warehouse-accept received.</span>
</span><span id="Store.ReceiveAllResponses-701"><a href="#Store.ReceiveAllResponses-701"><span class="linenos">701</span></a><span class="sd">                    Modifications visible to coordinator through shared reference.</span>
</span><span id="Store.ReceiveAllResponses-702"><a href="#Store.ReceiveAllResponses-702"><span class="linenos">702</span></a><span class="sd">                rejections (list[tuple[str, Message, str]]): Shared list reference with coordinator.</span>
</span><span id="Store.ReceiveAllResponses-703"><a href="#Store.ReceiveAllResponses-703"><span class="linenos">703</span></a><span class="sd">                    Worker appends (warehouse_jid, msg, reason) for each warehouse-reject.</span>
</span><span id="Store.ReceiveAllResponses-704"><a href="#Store.ReceiveAllResponses-704"><span class="linenos">704</span></a><span class="sd">                    Modifications visible to coordinator through shared reference.</span>
</span><span id="Store.ReceiveAllResponses-705"><a href="#Store.ReceiveAllResponses-705"><span class="linenos">705</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-706"><a href="#Store.ReceiveAllResponses-706"><span class="linenos">706</span></a><span class="sd">            Note:</span>
</span><span id="Store.ReceiveAllResponses-707"><a href="#Store.ReceiveAllResponses-707"><span class="linenos">707</span></a><span class="sd">                Lists are shared by reference (mutable), enabling communication between</span>
</span><span id="Store.ReceiveAllResponses-708"><a href="#Store.ReceiveAllResponses-708"><span class="linenos">708</span></a><span class="sd">                worker and coordinator without explicit return values. This is a common</span>
</span><span id="Store.ReceiveAllResponses-709"><a href="#Store.ReceiveAllResponses-709"><span class="linenos">709</span></a><span class="sd">                pattern in concurrent programming with SPADE behaviours.</span>
</span><span id="Store.ReceiveAllResponses-710"><a href="#Store.ReceiveAllResponses-710"><span class="linenos">710</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.ReceiveAllResponses-711"><a href="#Store.ReceiveAllResponses-711"><span class="linenos">711</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Store.ReceiveAllResponses-712"><a href="#Store.ReceiveAllResponses-712"><span class="linenos">712</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Store.ReceiveAllResponses-713"><a href="#Store.ReceiveAllResponses-713"><span class="linenos">713</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span> <span class="o">=</span> <span class="n">num_warehouses</span>
</span><span id="Store.ReceiveAllResponses-714"><a href="#Store.ReceiveAllResponses-714"><span class="linenos">714</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="n">acceptances</span>  <span class="c1"># Shared list</span>
</span><span id="Store.ReceiveAllResponses-715"><a href="#Store.ReceiveAllResponses-715"><span class="linenos">715</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="n">rejections</span>    <span class="c1"># Shared list</span>
</span><span id="Store.ReceiveAllResponses-716"><a href="#Store.ReceiveAllResponses-716"><span class="linenos">716</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Store.ReceiveAllResponses-717"><a href="#Store.ReceiveAllResponses-717"><span class="linenos">717</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds to wait for all responses</span>
</span><span id="Store.ReceiveAllResponses-718"><a href="#Store.ReceiveAllResponses-718"><span class="linenos">718</span></a>            
</span><span id="Store.ReceiveAllResponses-719"><a href="#Store.ReceiveAllResponses-719"><span class="linenos">719</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.ReceiveAllResponses-720"><a href="#Store.ReceiveAllResponses-720"><span class="linenos">720</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.ReceiveAllResponses-721"><a href="#Store.ReceiveAllResponses-721"><span class="linenos">721</span></a><span class="sd">            Execute the message collection loop for warehouse responses.</span>
</span><span id="Store.ReceiveAllResponses-722"><a href="#Store.ReceiveAllResponses-722"><span class="linenos">722</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-723"><a href="#Store.ReceiveAllResponses-723"><span class="linenos">723</span></a><span class="sd">            This method implements the core collection logic for the FIPA Contract Net</span>
</span><span id="Store.ReceiveAllResponses-724"><a href="#Store.ReceiveAllResponses-724"><span class="linenos">724</span></a><span class="sd">            Protocol proposal reception phase. It continuously receives messages from</span>
</span><span id="Store.ReceiveAllResponses-725"><a href="#Store.ReceiveAllResponses-725"><span class="linenos">725</span></a><span class="sd">            warehouses until either all expected responses arrive or a timeout occurs,</span>
</span><span id="Store.ReceiveAllResponses-726"><a href="#Store.ReceiveAllResponses-726"><span class="linenos">726</span></a><span class="sd">            properly categorizing each response as either a proposal or refusal.</span>
</span><span id="Store.ReceiveAllResponses-727"><a href="#Store.ReceiveAllResponses-727"><span class="linenos">727</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-728"><a href="#Store.ReceiveAllResponses-728"><span class="linenos">728</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Store.ReceiveAllResponses-729"><a href="#Store.ReceiveAllResponses-729"><span class="linenos">729</span></a><span class="sd">                - **Phase**: Proposal Reception (collecting propose/refuse messages)</span>
</span><span id="Store.ReceiveAllResponses-730"><a href="#Store.ReceiveAllResponses-730"><span class="linenos">730</span></a><span class="sd">                - **Role**: Worker (collects data for coordinator evaluation)</span>
</span><span id="Store.ReceiveAllResponses-731"><a href="#Store.ReceiveAllResponses-731"><span class="linenos">731</span></a><span class="sd">                - **Timeout**: 5 seconds total (not per message)</span>
</span><span id="Store.ReceiveAllResponses-732"><a href="#Store.ReceiveAllResponses-732"><span class="linenos">732</span></a><span class="sd">                - **Partial Completion**: Accepts fewer responses than expected</span>
</span><span id="Store.ReceiveAllResponses-733"><a href="#Store.ReceiveAllResponses-733"><span class="linenos">733</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-734"><a href="#Store.ReceiveAllResponses-734"><span class="linenos">734</span></a><span class="sd">            Algorithm:</span>
</span><span id="Store.ReceiveAllResponses-735"><a href="#Store.ReceiveAllResponses-735"><span class="linenos">735</span></a><span class="sd">                1. **Initialization**: Record start time for timeout calculation</span>
</span><span id="Store.ReceiveAllResponses-736"><a href="#Store.ReceiveAllResponses-736"><span class="linenos">736</span></a><span class="sd">                2. **Collection Loop**: While responses_received &lt; num_warehouses:</span>
</span><span id="Store.ReceiveAllResponses-737"><a href="#Store.ReceiveAllResponses-737"><span class="linenos">737</span></a><span class="sd">                    a. Calculate remaining timeout based on elapsed time</span>
</span><span id="Store.ReceiveAllResponses-738"><a href="#Store.ReceiveAllResponses-738"><span class="linenos">738</span></a><span class="sd">                    b. Check for timeout expiration (remaining_timeout &lt;= 0)</span>
</span><span id="Store.ReceiveAllResponses-739"><a href="#Store.ReceiveAllResponses-739"><span class="linenos">739</span></a><span class="sd">                    c. Receive message with dynamically calculated timeout</span>
</span><span id="Store.ReceiveAllResponses-740"><a href="#Store.ReceiveAllResponses-740"><span class="linenos">740</span></a><span class="sd">                    d. Parse message: extract performative, sender, and body</span>
</span><span id="Store.ReceiveAllResponses-741"><a href="#Store.ReceiveAllResponses-741"><span class="linenos">741</span></a><span class="sd">                    e. Categorize as acceptance or rejection</span>
</span><span id="Store.ReceiveAllResponses-742"><a href="#Store.ReceiveAllResponses-742"><span class="linenos">742</span></a><span class="sd">                    f. Append to appropriate shared list</span>
</span><span id="Store.ReceiveAllResponses-743"><a href="#Store.ReceiveAllResponses-743"><span class="linenos">743</span></a><span class="sd">                    g. Increment responses_received counter</span>
</span><span id="Store.ReceiveAllResponses-744"><a href="#Store.ReceiveAllResponses-744"><span class="linenos">744</span></a><span class="sd">                3. **Termination**: Break on timeout or no more messages</span>
</span><span id="Store.ReceiveAllResponses-745"><a href="#Store.ReceiveAllResponses-745"><span class="linenos">745</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-746"><a href="#Store.ReceiveAllResponses-746"><span class="linenos">746</span></a><span class="sd">            Message Processing:</span>
</span><span id="Store.ReceiveAllResponses-747"><a href="#Store.ReceiveAllResponses-747"><span class="linenos">747</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-748"><a href="#Store.ReceiveAllResponses-748"><span class="linenos">748</span></a><span class="sd">                **warehouse-accept** (FIPA propose):</span>
</span><span id="Store.ReceiveAllResponses-749"><a href="#Store.ReceiveAllResponses-749"><span class="linenos">749</span></a><span class="sd">                    - Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.ReceiveAllResponses-750"><a href="#Store.ReceiveAllResponses-750"><span class="linenos">750</span></a><span class="sd">                    - Parsing: Split on space, extract quantity (int) and product (str)</span>
</span><span id="Store.ReceiveAllResponses-751"><a href="#Store.ReceiveAllResponses-751"><span class="linenos">751</span></a><span class="sd">                    - Action: Append (warehouse_jid, msg) to acceptances list</span>
</span><span id="Store.ReceiveAllResponses-752"><a href="#Store.ReceiveAllResponses-752"><span class="linenos">752</span></a><span class="sd">                    - Meaning: Warehouse agrees to fulfill order</span>
</span><span id="Store.ReceiveAllResponses-753"><a href="#Store.ReceiveAllResponses-753"><span class="linenos">753</span></a><span class="sd">                </span>
</span><span id="Store.ReceiveAllResponses-754"><a href="#Store.ReceiveAllResponses-754"><span class="linenos">754</span></a><span class="sd">                **warehouse-reject** (FIPA refuse):</span>
</span><span id="Store.ReceiveAllResponses-755"><a href="#Store.ReceiveAllResponses-755"><span class="linenos">755</span></a><span class="sd">                    - Body format: &quot;{quantity} {product} {reason}&quot;</span>
</span><span id="Store.ReceiveAllResponses-756"><a href="#Store.ReceiveAllResponses-756"><span class="linenos">756</span></a><span class="sd">                    - Parsing: Split on space, extract quantity, product, and optional reason</span>
</span><span id="Store.ReceiveAllResponses-757"><a href="#Store.ReceiveAllResponses-757"><span class="linenos">757</span></a><span class="sd">                    - Action: Append (warehouse_jid, msg, reason) to rejections list</span>
</span><span id="Store.ReceiveAllResponses-758"><a href="#Store.ReceiveAllResponses-758"><span class="linenos">758</span></a><span class="sd">                    - Default reason: &quot;unknown&quot; if not provided</span>
</span><span id="Store.ReceiveAllResponses-759"><a href="#Store.ReceiveAllResponses-759"><span class="linenos">759</span></a><span class="sd">                    - Meaning: Warehouse cannot or will not fulfill order</span>
</span><span id="Store.ReceiveAllResponses-760"><a href="#Store.ReceiveAllResponses-760"><span class="linenos">760</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-761"><a href="#Store.ReceiveAllResponses-761"><span class="linenos">761</span></a><span class="sd">            Timeout Mechanism:</span>
</span><span id="Store.ReceiveAllResponses-762"><a href="#Store.ReceiveAllResponses-762"><span class="linenos">762</span></a><span class="sd">                - **Total Timeout**: 5 seconds from method start</span>
</span><span id="Store.ReceiveAllResponses-763"><a href="#Store.ReceiveAllResponses-763"><span class="linenos">763</span></a><span class="sd">                - **Dynamic Calculation**: remaining_timeout = total_timeout - elapsed_time</span>
</span><span id="Store.ReceiveAllResponses-764"><a href="#Store.ReceiveAllResponses-764"><span class="linenos">764</span></a><span class="sd">                - **Per-Message Timeout**: Each receive() uses remaining_timeout</span>
</span><span id="Store.ReceiveAllResponses-765"><a href="#Store.ReceiveAllResponses-765"><span class="linenos">765</span></a><span class="sd">                - **Early Termination**: Breaks immediately if remaining_timeout &lt;= 0</span>
</span><span id="Store.ReceiveAllResponses-766"><a href="#Store.ReceiveAllResponses-766"><span class="linenos">766</span></a><span class="sd">                - **Graceful Handling**: Allows partial responses without error</span>
</span><span id="Store.ReceiveAllResponses-767"><a href="#Store.ReceiveAllResponses-767"><span class="linenos">767</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-768"><a href="#Store.ReceiveAllResponses-768"><span class="linenos">768</span></a><span class="sd">            Example Execution Timeline:</span>
</span><span id="Store.ReceiveAllResponses-769"><a href="#Store.ReceiveAllResponses-769"><span class="linenos">769</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveAllResponses-770"><a href="#Store.ReceiveAllResponses-770"><span class="linenos">770</span></a><span class="sd">                t=0.0s: Start collection (expecting 3 responses)</span>
</span><span id="Store.ReceiveAllResponses-771"><a href="#Store.ReceiveAllResponses-771"><span class="linenos">771</span></a><span class="sd">                t=0.3s: Receive warehouse1 accept -&gt; acceptances.append()</span>
</span><span id="Store.ReceiveAllResponses-772"><a href="#Store.ReceiveAllResponses-772"><span class="linenos">772</span></a><span class="sd">                t=0.8s: Receive warehouse2 reject -&gt; rejections.append()</span>
</span><span id="Store.ReceiveAllResponses-773"><a href="#Store.ReceiveAllResponses-773"><span class="linenos">773</span></a><span class="sd">                t=5.0s: Timeout reached (warehouse3 silent)</span>
</span><span id="Store.ReceiveAllResponses-774"><a href="#Store.ReceiveAllResponses-774"><span class="linenos">774</span></a><span class="sd">                Result: 2/3 responses collected</span>
</span><span id="Store.ReceiveAllResponses-775"><a href="#Store.ReceiveAllResponses-775"><span class="linenos">775</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveAllResponses-776"><a href="#Store.ReceiveAllResponses-776"><span class="linenos">776</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-777"><a href="#Store.ReceiveAllResponses-777"><span class="linenos">777</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.ReceiveAllResponses-778"><a href="#Store.ReceiveAllResponses-778"><span class="linenos">778</span></a><span class="sd">                - Populates self.acceptances shared list with proposals</span>
</span><span id="Store.ReceiveAllResponses-779"><a href="#Store.ReceiveAllResponses-779"><span class="linenos">779</span></a><span class="sd">                - Populates self.rejections shared list with refusals</span>
</span><span id="Store.ReceiveAllResponses-780"><a href="#Store.ReceiveAllResponses-780"><span class="linenos">780</span></a><span class="sd">                - Increments self.responses_received counter</span>
</span><span id="Store.ReceiveAllResponses-781"><a href="#Store.ReceiveAllResponses-781"><span class="linenos">781</span></a><span class="sd">                - Prints debug information if verbose mode enabled</span>
</span><span id="Store.ReceiveAllResponses-782"><a href="#Store.ReceiveAllResponses-782"><span class="linenos">782</span></a><span class="sd">                - May terminate early due to timeout</span>
</span><span id="Store.ReceiveAllResponses-783"><a href="#Store.ReceiveAllResponses-783"><span class="linenos">783</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-784"><a href="#Store.ReceiveAllResponses-784"><span class="linenos">784</span></a><span class="sd">            Returns:</span>
</span><span id="Store.ReceiveAllResponses-785"><a href="#Store.ReceiveAllResponses-785"><span class="linenos">785</span></a><span class="sd">                None. Results communicated through shared list references.</span>
</span><span id="Store.ReceiveAllResponses-786"><a href="#Store.ReceiveAllResponses-786"><span class="linenos">786</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses-787"><a href="#Store.ReceiveAllResponses-787"><span class="linenos">787</span></a><span class="sd">            Note:</span>
</span><span id="Store.ReceiveAllResponses-788"><a href="#Store.ReceiveAllResponses-788"><span class="linenos">788</span></a><span class="sd">                The timeout is global (not per-message), ensuring the entire collection</span>
</span><span id="Store.ReceiveAllResponses-789"><a href="#Store.ReceiveAllResponses-789"><span class="linenos">789</span></a><span class="sd">                process completes within 5 seconds regardless of warehouse count. This</span>
</span><span id="Store.ReceiveAllResponses-790"><a href="#Store.ReceiveAllResponses-790"><span class="linenos">790</span></a><span class="sd">                prevents indefinite waiting when warehouses are unresponsive.</span>
</span><span id="Store.ReceiveAllResponses-791"><a href="#Store.ReceiveAllResponses-791"><span class="linenos">791</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.ReceiveAllResponses-792"><a href="#Store.ReceiveAllResponses-792"><span class="linenos">792</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.ReceiveAllResponses-793"><a href="#Store.ReceiveAllResponses-793"><span class="linenos">793</span></a>            
</span><span id="Store.ReceiveAllResponses-794"><a href="#Store.ReceiveAllResponses-794"><span class="linenos">794</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="Store.ReceiveAllResponses-795"><a href="#Store.ReceiveAllResponses-795"><span class="linenos">795</span></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="Store.ReceiveAllResponses-796"><a href="#Store.ReceiveAllResponses-796"><span class="linenos">796</span></a>            
</span><span id="Store.ReceiveAllResponses-797"><a href="#Store.ReceiveAllResponses-797"><span class="linenos">797</span></a>            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses-798"><a href="#Store.ReceiveAllResponses-798"><span class="linenos">798</span></a>                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="Store.ReceiveAllResponses-799"><a href="#Store.ReceiveAllResponses-799"><span class="linenos">799</span></a>                <span class="n">remaining_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">-</span> <span class="n">elapsed</span>
</span><span id="Store.ReceiveAllResponses-800"><a href="#Store.ReceiveAllResponses-800"><span class="linenos">800</span></a>                
</span><span id="Store.ReceiveAllResponses-801"><a href="#Store.ReceiveAllResponses-801"><span class="linenos">801</span></a>                <span class="k">if</span> <span class="n">remaining_timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses-802"><a href="#Store.ReceiveAllResponses-802"><span class="linenos">802</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses-803"><a href="#Store.ReceiveAllResponses-803"><span class="linenos">803</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Timeout: Only received </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span><span class="si">}</span><span class="s2"> responses&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses-804"><a href="#Store.ReceiveAllResponses-804"><span class="linenos">804</span></a>                    <span class="k">break</span>
</span><span id="Store.ReceiveAllResponses-805"><a href="#Store.ReceiveAllResponses-805"><span class="linenos">805</span></a>                
</span><span id="Store.ReceiveAllResponses-806"><a href="#Store.ReceiveAllResponses-806"><span class="linenos">806</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">remaining_timeout</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses-807"><a href="#Store.ReceiveAllResponses-807"><span class="linenos">807</span></a>                
</span><span id="Store.ReceiveAllResponses-808"><a href="#Store.ReceiveAllResponses-808"><span class="linenos">808</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses-809"><a href="#Store.ReceiveAllResponses-809"><span class="linenos">809</span></a>                    <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses-810"><a href="#Store.ReceiveAllResponses-810"><span class="linenos">810</span></a>                    <span class="n">warehouse_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses-811"><a href="#Store.ReceiveAllResponses-811"><span class="linenos">811</span></a>                    
</span><span id="Store.ReceiveAllResponses-812"><a href="#Store.ReceiveAllResponses-812"><span class="linenos">812</span></a>                    <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;warehouse-accept&quot;</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses-813"><a href="#Store.ReceiveAllResponses-813"><span class="linenos">813</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses-814"><a href="#Store.ReceiveAllResponses-814"><span class="linenos">814</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store.ReceiveAllResponses-815"><a href="#Store.ReceiveAllResponses-815"><span class="linenos">815</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store.ReceiveAllResponses-816"><a href="#Store.ReceiveAllResponses-816"><span class="linenos">816</span></a>                        
</span><span id="Store.ReceiveAllResponses-817"><a href="#Store.ReceiveAllResponses-817"><span class="linenos">817</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses-818"><a href="#Store.ReceiveAllResponses-818"><span class="linenos">818</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received acceptance from </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses-819"><a href="#Store.ReceiveAllResponses-819"><span class="linenos">819</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
</span><span id="Store.ReceiveAllResponses-820"><a href="#Store.ReceiveAllResponses-820"><span class="linenos">820</span></a>                        
</span><span id="Store.ReceiveAllResponses-821"><a href="#Store.ReceiveAllResponses-821"><span class="linenos">821</span></a>                    <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;warehouse-reject&quot;</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses-822"><a href="#Store.ReceiveAllResponses-822"><span class="linenos">822</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses-823"><a href="#Store.ReceiveAllResponses-823"><span class="linenos">823</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store.ReceiveAllResponses-824"><a href="#Store.ReceiveAllResponses-824"><span class="linenos">824</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store.ReceiveAllResponses-825"><a href="#Store.ReceiveAllResponses-825"><span class="linenos">825</span></a>                        <span class="n">reason</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
</span><span id="Store.ReceiveAllResponses-826"><a href="#Store.ReceiveAllResponses-826"><span class="linenos">826</span></a>                        
</span><span id="Store.ReceiveAllResponses-827"><a href="#Store.ReceiveAllResponses-827"><span class="linenos">827</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses-828"><a href="#Store.ReceiveAllResponses-828"><span class="linenos">828</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received rejection from </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> (reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses-829"><a href="#Store.ReceiveAllResponses-829"><span class="linenos">829</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
</span><span id="Store.ReceiveAllResponses-830"><a href="#Store.ReceiveAllResponses-830"><span class="linenos">830</span></a>                    
</span><span id="Store.ReceiveAllResponses-831"><a href="#Store.ReceiveAllResponses-831"><span class="linenos">831</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Store.ReceiveAllResponses-832"><a href="#Store.ReceiveAllResponses-832"><span class="linenos">832</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses-833"><a href="#Store.ReceiveAllResponses-833"><span class="linenos">833</span></a>                    <span class="c1"># No more messages, timeout</span>
</span><span id="Store.ReceiveAllResponses-834"><a href="#Store.ReceiveAllResponses-834"><span class="linenos">834</span></a>                    <span class="k">break</span>
</span><span id="Store.ReceiveAllResponses-835"><a href="#Store.ReceiveAllResponses-835"><span class="linenos">835</span></a>            
</span><span id="Store.ReceiveAllResponses-836"><a href="#Store.ReceiveAllResponses-836"><span class="linenos">836</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses-837"><a href="#Store.ReceiveAllResponses-837"><span class="linenos">837</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Finished collecting responses: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> accepts, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejects&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Worker behaviour for collecting warehouse responses in FIPA Contract Net Protocol.</p>

<p>This behaviour acts as the worker component in a coordinator/worker pattern,
handling the actual message reception during the proposal collection phase of
the FIPA Contract Net Protocol. It listens for both proposals (warehouse-accept)
and refusals (warehouse-reject) from warehouses, populating shared lists that
the coordinator (CollectWarehouseResponses) will evaluate.</p>

<p>FIPA Protocol Phase: <strong>Proposal Reception</strong>
    - Role: Participant response collector (worker)
    - Coordinator: CollectWarehouseResponses
    - Expected messages: warehouse-accept (propose) and warehouse-reject (refuse)
    - Timeout: 5 seconds total for all responses</p>

<p>The behaviour implements a timeout mechanism to handle scenarios where some
warehouses may be slow to respond or unavailable. It collects responses until
either all expected warehouses respond or the timeout expires.</p>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>request_id (int):</strong>  Unique request identifier for filtering messages.
Ensures only responses for this specific CFP are processed.</li>
<li><strong>num_warehouses (int):</strong>  Expected number of warehouse responses.
Used to determine when collection is complete.</li>
<li><strong>acceptances (list[tuple[str, Message]]):</strong>  Shared list with coordinator.
Populated with (warehouse_jid, message) for each propose.</li>
<li><strong>rejections (list[tuple[str, Message, str]]):</strong>  Shared list with coordinator.
Populated with (warehouse_jid, message, reason) for each refuse.</li>
<li><strong>responses_received (int):</strong>  Counter tracking received responses.
Incremented for both accepts and rejects.</li>
<li><strong>timeout (int):</strong>  Maximum seconds to wait for all responses (default: 5).</li>
</ul>

<h6 id="message-processing">Message Processing:</h6>

<blockquote>
  <ul>
  <li><p><strong>warehouse-accept</strong> (FIPA propose):
  Body format: "{quantity} {product}"
  Action: Append (warehouse_jid, msg) to acceptances</p></li>
  <li><p><strong>warehouse-reject</strong> (FIPA refuse):
  Body format: "{quantity} {product} {reason}"
  Action: Append (warehouse_jid, msg, reason) to rejections</p></li>
  </ul>
</blockquote>

<h6 id="timeout-logic">Timeout Logic:</h6>

<blockquote>
  <ul>
  <li>Tracks elapsed time from start</li>
  <li>Calculates remaining_timeout for each receive() call</li>
  <li>Breaks early if remaining_timeout &lt;= 0</li>
  <li>Allows partial responses (fewer than num_warehouses)</li>
  </ul>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
<pre><code>Expected: 3 warehouses
Timeline:
    t=0.5s: warehouse1 -&gt; accept (1/3 received)
    t=1.2s: warehouse2 -&gt; reject (2/3 received)
    t=5.0s: timeout reached (warehouse3 no response)
Result:
    acceptances = [(warehouse1, msg1)]
    rejections = [(warehouse2, msg2, "out_of_stock")]
    responses_received = 2
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This worker behaviour uses shared list references (not copies) to communicate
  with the coordinator, following the coordinator/worker pattern for efficient
  data sharing between behaviours.</p>
</blockquote>
</div>


                            <div id="Store.ReceiveAllResponses.__init__" class="classattr">
                                        <input id="Store.ReceiveAllResponses.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Store.ReceiveAllResponses</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">request_id</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">num_warehouses</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">acceptances</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">rejections</span><span class="p">:</span> <span class="nb">list</span></span>)</span>

                <label class="view-source-button" for="Store.ReceiveAllResponses.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.ReceiveAllResponses.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.ReceiveAllResponses.__init__-690"><a href="#Store.ReceiveAllResponses.__init__-690"><span class="linenos">690</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_warehouses</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">acceptances</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">rejections</span> <span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Store.ReceiveAllResponses.__init__-691"><a href="#Store.ReceiveAllResponses.__init__-691"><span class="linenos">691</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.ReceiveAllResponses.__init__-692"><a href="#Store.ReceiveAllResponses.__init__-692"><span class="linenos">692</span></a><span class="sd">            Initialize the ReceiveAllResponses worker behaviour.</span>
</span><span id="Store.ReceiveAllResponses.__init__-693"><a href="#Store.ReceiveAllResponses.__init__-693"><span class="linenos">693</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses.__init__-694"><a href="#Store.ReceiveAllResponses.__init__-694"><span class="linenos">694</span></a><span class="sd">            Args:</span>
</span><span id="Store.ReceiveAllResponses.__init__-695"><a href="#Store.ReceiveAllResponses.__init__-695"><span class="linenos">695</span></a><span class="sd">                request_id (int): Unique request identifier from ID encoding system.</span>
</span><span id="Store.ReceiveAllResponses.__init__-696"><a href="#Store.ReceiveAllResponses.__init__-696"><span class="linenos">696</span></a><span class="sd">                    Used to filter incoming messages to only this CFP&#39;s responses.</span>
</span><span id="Store.ReceiveAllResponses.__init__-697"><a href="#Store.ReceiveAllResponses.__init__-697"><span class="linenos">697</span></a><span class="sd">                num_warehouses (int): Expected number of warehouse responses.</span>
</span><span id="Store.ReceiveAllResponses.__init__-698"><a href="#Store.ReceiveAllResponses.__init__-698"><span class="linenos">698</span></a><span class="sd">                    Used to determine when all responses received (early termination).</span>
</span><span id="Store.ReceiveAllResponses.__init__-699"><a href="#Store.ReceiveAllResponses.__init__-699"><span class="linenos">699</span></a><span class="sd">                acceptances (list[tuple[str, Message]]): Shared list reference with coordinator.</span>
</span><span id="Store.ReceiveAllResponses.__init__-700"><a href="#Store.ReceiveAllResponses.__init__-700"><span class="linenos">700</span></a><span class="sd">                    Worker appends (warehouse_jid, msg) for each warehouse-accept received.</span>
</span><span id="Store.ReceiveAllResponses.__init__-701"><a href="#Store.ReceiveAllResponses.__init__-701"><span class="linenos">701</span></a><span class="sd">                    Modifications visible to coordinator through shared reference.</span>
</span><span id="Store.ReceiveAllResponses.__init__-702"><a href="#Store.ReceiveAllResponses.__init__-702"><span class="linenos">702</span></a><span class="sd">                rejections (list[tuple[str, Message, str]]): Shared list reference with coordinator.</span>
</span><span id="Store.ReceiveAllResponses.__init__-703"><a href="#Store.ReceiveAllResponses.__init__-703"><span class="linenos">703</span></a><span class="sd">                    Worker appends (warehouse_jid, msg, reason) for each warehouse-reject.</span>
</span><span id="Store.ReceiveAllResponses.__init__-704"><a href="#Store.ReceiveAllResponses.__init__-704"><span class="linenos">704</span></a><span class="sd">                    Modifications visible to coordinator through shared reference.</span>
</span><span id="Store.ReceiveAllResponses.__init__-705"><a href="#Store.ReceiveAllResponses.__init__-705"><span class="linenos">705</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses.__init__-706"><a href="#Store.ReceiveAllResponses.__init__-706"><span class="linenos">706</span></a><span class="sd">            Note:</span>
</span><span id="Store.ReceiveAllResponses.__init__-707"><a href="#Store.ReceiveAllResponses.__init__-707"><span class="linenos">707</span></a><span class="sd">                Lists are shared by reference (mutable), enabling communication between</span>
</span><span id="Store.ReceiveAllResponses.__init__-708"><a href="#Store.ReceiveAllResponses.__init__-708"><span class="linenos">708</span></a><span class="sd">                worker and coordinator without explicit return values. This is a common</span>
</span><span id="Store.ReceiveAllResponses.__init__-709"><a href="#Store.ReceiveAllResponses.__init__-709"><span class="linenos">709</span></a><span class="sd">                pattern in concurrent programming with SPADE behaviours.</span>
</span><span id="Store.ReceiveAllResponses.__init__-710"><a href="#Store.ReceiveAllResponses.__init__-710"><span class="linenos">710</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.ReceiveAllResponses.__init__-711"><a href="#Store.ReceiveAllResponses.__init__-711"><span class="linenos">711</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Store.ReceiveAllResponses.__init__-712"><a href="#Store.ReceiveAllResponses.__init__-712"><span class="linenos">712</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Store.ReceiveAllResponses.__init__-713"><a href="#Store.ReceiveAllResponses.__init__-713"><span class="linenos">713</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span> <span class="o">=</span> <span class="n">num_warehouses</span>
</span><span id="Store.ReceiveAllResponses.__init__-714"><a href="#Store.ReceiveAllResponses.__init__-714"><span class="linenos">714</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="n">acceptances</span>  <span class="c1"># Shared list</span>
</span><span id="Store.ReceiveAllResponses.__init__-715"><a href="#Store.ReceiveAllResponses.__init__-715"><span class="linenos">715</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="n">rejections</span>    <span class="c1"># Shared list</span>
</span><span id="Store.ReceiveAllResponses.__init__-716"><a href="#Store.ReceiveAllResponses.__init__-716"><span class="linenos">716</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Store.ReceiveAllResponses.__init__-717"><a href="#Store.ReceiveAllResponses.__init__-717"><span class="linenos">717</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds to wait for all responses</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the ReceiveAllResponses worker behaviour.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>request_id (int):</strong>  Unique request identifier from ID encoding system.
Used to filter incoming messages to only this CFP's responses.</li>
<li><strong>num_warehouses (int):</strong>  Expected number of warehouse responses.
Used to determine when all responses received (early termination).</li>
<li><strong>acceptances (list[tuple[str, Message]]):</strong>  Shared list reference with coordinator.
Worker appends (warehouse_jid, msg) for each warehouse-accept received.
Modifications visible to coordinator through shared reference.</li>
<li><strong>rejections (list[tuple[str, Message, str]]):</strong>  Shared list reference with coordinator.
Worker appends (warehouse_jid, msg, reason) for each warehouse-reject.
Modifications visible to coordinator through shared reference.</li>
</ul>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Lists are shared by reference (mutable), enabling communication between
  worker and coordinator without explicit return values. This is a common
  pattern in concurrent programming with SPADE behaviours.</p>
</blockquote>
</div>


                            </div>
                            <div id="Store.ReceiveAllResponses.request_id" class="classattr">
                                <div class="attr variable">
            <span class="name">request_id</span>

        
    </div>
    <a class="headerlink" href="#Store.ReceiveAllResponses.request_id"></a>
    
    

                            </div>
                            <div id="Store.ReceiveAllResponses.num_warehouses" class="classattr">
                                <div class="attr variable">
            <span class="name">num_warehouses</span>

        
    </div>
    <a class="headerlink" href="#Store.ReceiveAllResponses.num_warehouses"></a>
    
    

                            </div>
                            <div id="Store.ReceiveAllResponses.acceptances" class="classattr">
                                <div class="attr variable">
            <span class="name">acceptances</span>

        
    </div>
    <a class="headerlink" href="#Store.ReceiveAllResponses.acceptances"></a>
    
    

                            </div>
                            <div id="Store.ReceiveAllResponses.rejections" class="classattr">
                                <div class="attr variable">
            <span class="name">rejections</span>

        
    </div>
    <a class="headerlink" href="#Store.ReceiveAllResponses.rejections"></a>
    
    

                            </div>
                            <div id="Store.ReceiveAllResponses.responses_received" class="classattr">
                                <div class="attr variable">
            <span class="name">responses_received</span>

        
    </div>
    <a class="headerlink" href="#Store.ReceiveAllResponses.responses_received"></a>
    
    

                            </div>
                            <div id="Store.ReceiveAllResponses.timeout" class="classattr">
                                <div class="attr variable">
            <span class="name">timeout</span>

        
    </div>
    <a class="headerlink" href="#Store.ReceiveAllResponses.timeout"></a>
    
    

                            </div>
                            <div id="Store.ReceiveAllResponses.run" class="classattr">
                                        <input id="Store.ReceiveAllResponses.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Store.ReceiveAllResponses.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.ReceiveAllResponses.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.ReceiveAllResponses.run-719"><a href="#Store.ReceiveAllResponses.run-719"><span class="linenos">719</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.ReceiveAllResponses.run-720"><a href="#Store.ReceiveAllResponses.run-720"><span class="linenos">720</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.ReceiveAllResponses.run-721"><a href="#Store.ReceiveAllResponses.run-721"><span class="linenos">721</span></a><span class="sd">            Execute the message collection loop for warehouse responses.</span>
</span><span id="Store.ReceiveAllResponses.run-722"><a href="#Store.ReceiveAllResponses.run-722"><span class="linenos">722</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses.run-723"><a href="#Store.ReceiveAllResponses.run-723"><span class="linenos">723</span></a><span class="sd">            This method implements the core collection logic for the FIPA Contract Net</span>
</span><span id="Store.ReceiveAllResponses.run-724"><a href="#Store.ReceiveAllResponses.run-724"><span class="linenos">724</span></a><span class="sd">            Protocol proposal reception phase. It continuously receives messages from</span>
</span><span id="Store.ReceiveAllResponses.run-725"><a href="#Store.ReceiveAllResponses.run-725"><span class="linenos">725</span></a><span class="sd">            warehouses until either all expected responses arrive or a timeout occurs,</span>
</span><span id="Store.ReceiveAllResponses.run-726"><a href="#Store.ReceiveAllResponses.run-726"><span class="linenos">726</span></a><span class="sd">            properly categorizing each response as either a proposal or refusal.</span>
</span><span id="Store.ReceiveAllResponses.run-727"><a href="#Store.ReceiveAllResponses.run-727"><span class="linenos">727</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses.run-728"><a href="#Store.ReceiveAllResponses.run-728"><span class="linenos">728</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Store.ReceiveAllResponses.run-729"><a href="#Store.ReceiveAllResponses.run-729"><span class="linenos">729</span></a><span class="sd">                - **Phase**: Proposal Reception (collecting propose/refuse messages)</span>
</span><span id="Store.ReceiveAllResponses.run-730"><a href="#Store.ReceiveAllResponses.run-730"><span class="linenos">730</span></a><span class="sd">                - **Role**: Worker (collects data for coordinator evaluation)</span>
</span><span id="Store.ReceiveAllResponses.run-731"><a href="#Store.ReceiveAllResponses.run-731"><span class="linenos">731</span></a><span class="sd">                - **Timeout**: 5 seconds total (not per message)</span>
</span><span id="Store.ReceiveAllResponses.run-732"><a href="#Store.ReceiveAllResponses.run-732"><span class="linenos">732</span></a><span class="sd">                - **Partial Completion**: Accepts fewer responses than expected</span>
</span><span id="Store.ReceiveAllResponses.run-733"><a href="#Store.ReceiveAllResponses.run-733"><span class="linenos">733</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses.run-734"><a href="#Store.ReceiveAllResponses.run-734"><span class="linenos">734</span></a><span class="sd">            Algorithm:</span>
</span><span id="Store.ReceiveAllResponses.run-735"><a href="#Store.ReceiveAllResponses.run-735"><span class="linenos">735</span></a><span class="sd">                1. **Initialization**: Record start time for timeout calculation</span>
</span><span id="Store.ReceiveAllResponses.run-736"><a href="#Store.ReceiveAllResponses.run-736"><span class="linenos">736</span></a><span class="sd">                2. **Collection Loop**: While responses_received &lt; num_warehouses:</span>
</span><span id="Store.ReceiveAllResponses.run-737"><a href="#Store.ReceiveAllResponses.run-737"><span class="linenos">737</span></a><span class="sd">                    a. Calculate remaining timeout based on elapsed time</span>
</span><span id="Store.ReceiveAllResponses.run-738"><a href="#Store.ReceiveAllResponses.run-738"><span class="linenos">738</span></a><span class="sd">                    b. Check for timeout expiration (remaining_timeout &lt;= 0)</span>
</span><span id="Store.ReceiveAllResponses.run-739"><a href="#Store.ReceiveAllResponses.run-739"><span class="linenos">739</span></a><span class="sd">                    c. Receive message with dynamically calculated timeout</span>
</span><span id="Store.ReceiveAllResponses.run-740"><a href="#Store.ReceiveAllResponses.run-740"><span class="linenos">740</span></a><span class="sd">                    d. Parse message: extract performative, sender, and body</span>
</span><span id="Store.ReceiveAllResponses.run-741"><a href="#Store.ReceiveAllResponses.run-741"><span class="linenos">741</span></a><span class="sd">                    e. Categorize as acceptance or rejection</span>
</span><span id="Store.ReceiveAllResponses.run-742"><a href="#Store.ReceiveAllResponses.run-742"><span class="linenos">742</span></a><span class="sd">                    f. Append to appropriate shared list</span>
</span><span id="Store.ReceiveAllResponses.run-743"><a href="#Store.ReceiveAllResponses.run-743"><span class="linenos">743</span></a><span class="sd">                    g. Increment responses_received counter</span>
</span><span id="Store.ReceiveAllResponses.run-744"><a href="#Store.ReceiveAllResponses.run-744"><span class="linenos">744</span></a><span class="sd">                3. **Termination**: Break on timeout or no more messages</span>
</span><span id="Store.ReceiveAllResponses.run-745"><a href="#Store.ReceiveAllResponses.run-745"><span class="linenos">745</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses.run-746"><a href="#Store.ReceiveAllResponses.run-746"><span class="linenos">746</span></a><span class="sd">            Message Processing:</span>
</span><span id="Store.ReceiveAllResponses.run-747"><a href="#Store.ReceiveAllResponses.run-747"><span class="linenos">747</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses.run-748"><a href="#Store.ReceiveAllResponses.run-748"><span class="linenos">748</span></a><span class="sd">                **warehouse-accept** (FIPA propose):</span>
</span><span id="Store.ReceiveAllResponses.run-749"><a href="#Store.ReceiveAllResponses.run-749"><span class="linenos">749</span></a><span class="sd">                    - Body format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.ReceiveAllResponses.run-750"><a href="#Store.ReceiveAllResponses.run-750"><span class="linenos">750</span></a><span class="sd">                    - Parsing: Split on space, extract quantity (int) and product (str)</span>
</span><span id="Store.ReceiveAllResponses.run-751"><a href="#Store.ReceiveAllResponses.run-751"><span class="linenos">751</span></a><span class="sd">                    - Action: Append (warehouse_jid, msg) to acceptances list</span>
</span><span id="Store.ReceiveAllResponses.run-752"><a href="#Store.ReceiveAllResponses.run-752"><span class="linenos">752</span></a><span class="sd">                    - Meaning: Warehouse agrees to fulfill order</span>
</span><span id="Store.ReceiveAllResponses.run-753"><a href="#Store.ReceiveAllResponses.run-753"><span class="linenos">753</span></a><span class="sd">                </span>
</span><span id="Store.ReceiveAllResponses.run-754"><a href="#Store.ReceiveAllResponses.run-754"><span class="linenos">754</span></a><span class="sd">                **warehouse-reject** (FIPA refuse):</span>
</span><span id="Store.ReceiveAllResponses.run-755"><a href="#Store.ReceiveAllResponses.run-755"><span class="linenos">755</span></a><span class="sd">                    - Body format: &quot;{quantity} {product} {reason}&quot;</span>
</span><span id="Store.ReceiveAllResponses.run-756"><a href="#Store.ReceiveAllResponses.run-756"><span class="linenos">756</span></a><span class="sd">                    - Parsing: Split on space, extract quantity, product, and optional reason</span>
</span><span id="Store.ReceiveAllResponses.run-757"><a href="#Store.ReceiveAllResponses.run-757"><span class="linenos">757</span></a><span class="sd">                    - Action: Append (warehouse_jid, msg, reason) to rejections list</span>
</span><span id="Store.ReceiveAllResponses.run-758"><a href="#Store.ReceiveAllResponses.run-758"><span class="linenos">758</span></a><span class="sd">                    - Default reason: &quot;unknown&quot; if not provided</span>
</span><span id="Store.ReceiveAllResponses.run-759"><a href="#Store.ReceiveAllResponses.run-759"><span class="linenos">759</span></a><span class="sd">                    - Meaning: Warehouse cannot or will not fulfill order</span>
</span><span id="Store.ReceiveAllResponses.run-760"><a href="#Store.ReceiveAllResponses.run-760"><span class="linenos">760</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses.run-761"><a href="#Store.ReceiveAllResponses.run-761"><span class="linenos">761</span></a><span class="sd">            Timeout Mechanism:</span>
</span><span id="Store.ReceiveAllResponses.run-762"><a href="#Store.ReceiveAllResponses.run-762"><span class="linenos">762</span></a><span class="sd">                - **Total Timeout**: 5 seconds from method start</span>
</span><span id="Store.ReceiveAllResponses.run-763"><a href="#Store.ReceiveAllResponses.run-763"><span class="linenos">763</span></a><span class="sd">                - **Dynamic Calculation**: remaining_timeout = total_timeout - elapsed_time</span>
</span><span id="Store.ReceiveAllResponses.run-764"><a href="#Store.ReceiveAllResponses.run-764"><span class="linenos">764</span></a><span class="sd">                - **Per-Message Timeout**: Each receive() uses remaining_timeout</span>
</span><span id="Store.ReceiveAllResponses.run-765"><a href="#Store.ReceiveAllResponses.run-765"><span class="linenos">765</span></a><span class="sd">                - **Early Termination**: Breaks immediately if remaining_timeout &lt;= 0</span>
</span><span id="Store.ReceiveAllResponses.run-766"><a href="#Store.ReceiveAllResponses.run-766"><span class="linenos">766</span></a><span class="sd">                - **Graceful Handling**: Allows partial responses without error</span>
</span><span id="Store.ReceiveAllResponses.run-767"><a href="#Store.ReceiveAllResponses.run-767"><span class="linenos">767</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses.run-768"><a href="#Store.ReceiveAllResponses.run-768"><span class="linenos">768</span></a><span class="sd">            Example Execution Timeline:</span>
</span><span id="Store.ReceiveAllResponses.run-769"><a href="#Store.ReceiveAllResponses.run-769"><span class="linenos">769</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveAllResponses.run-770"><a href="#Store.ReceiveAllResponses.run-770"><span class="linenos">770</span></a><span class="sd">                t=0.0s: Start collection (expecting 3 responses)</span>
</span><span id="Store.ReceiveAllResponses.run-771"><a href="#Store.ReceiveAllResponses.run-771"><span class="linenos">771</span></a><span class="sd">                t=0.3s: Receive warehouse1 accept -&gt; acceptances.append()</span>
</span><span id="Store.ReceiveAllResponses.run-772"><a href="#Store.ReceiveAllResponses.run-772"><span class="linenos">772</span></a><span class="sd">                t=0.8s: Receive warehouse2 reject -&gt; rejections.append()</span>
</span><span id="Store.ReceiveAllResponses.run-773"><a href="#Store.ReceiveAllResponses.run-773"><span class="linenos">773</span></a><span class="sd">                t=5.0s: Timeout reached (warehouse3 silent)</span>
</span><span id="Store.ReceiveAllResponses.run-774"><a href="#Store.ReceiveAllResponses.run-774"><span class="linenos">774</span></a><span class="sd">                Result: 2/3 responses collected</span>
</span><span id="Store.ReceiveAllResponses.run-775"><a href="#Store.ReceiveAllResponses.run-775"><span class="linenos">775</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveAllResponses.run-776"><a href="#Store.ReceiveAllResponses.run-776"><span class="linenos">776</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses.run-777"><a href="#Store.ReceiveAllResponses.run-777"><span class="linenos">777</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.ReceiveAllResponses.run-778"><a href="#Store.ReceiveAllResponses.run-778"><span class="linenos">778</span></a><span class="sd">                - Populates self.acceptances shared list with proposals</span>
</span><span id="Store.ReceiveAllResponses.run-779"><a href="#Store.ReceiveAllResponses.run-779"><span class="linenos">779</span></a><span class="sd">                - Populates self.rejections shared list with refusals</span>
</span><span id="Store.ReceiveAllResponses.run-780"><a href="#Store.ReceiveAllResponses.run-780"><span class="linenos">780</span></a><span class="sd">                - Increments self.responses_received counter</span>
</span><span id="Store.ReceiveAllResponses.run-781"><a href="#Store.ReceiveAllResponses.run-781"><span class="linenos">781</span></a><span class="sd">                - Prints debug information if verbose mode enabled</span>
</span><span id="Store.ReceiveAllResponses.run-782"><a href="#Store.ReceiveAllResponses.run-782"><span class="linenos">782</span></a><span class="sd">                - May terminate early due to timeout</span>
</span><span id="Store.ReceiveAllResponses.run-783"><a href="#Store.ReceiveAllResponses.run-783"><span class="linenos">783</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses.run-784"><a href="#Store.ReceiveAllResponses.run-784"><span class="linenos">784</span></a><span class="sd">            Returns:</span>
</span><span id="Store.ReceiveAllResponses.run-785"><a href="#Store.ReceiveAllResponses.run-785"><span class="linenos">785</span></a><span class="sd">                None. Results communicated through shared list references.</span>
</span><span id="Store.ReceiveAllResponses.run-786"><a href="#Store.ReceiveAllResponses.run-786"><span class="linenos">786</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveAllResponses.run-787"><a href="#Store.ReceiveAllResponses.run-787"><span class="linenos">787</span></a><span class="sd">            Note:</span>
</span><span id="Store.ReceiveAllResponses.run-788"><a href="#Store.ReceiveAllResponses.run-788"><span class="linenos">788</span></a><span class="sd">                The timeout is global (not per-message), ensuring the entire collection</span>
</span><span id="Store.ReceiveAllResponses.run-789"><a href="#Store.ReceiveAllResponses.run-789"><span class="linenos">789</span></a><span class="sd">                process completes within 5 seconds regardless of warehouse count. This</span>
</span><span id="Store.ReceiveAllResponses.run-790"><a href="#Store.ReceiveAllResponses.run-790"><span class="linenos">790</span></a><span class="sd">                prevents indefinite waiting when warehouses are unresponsive.</span>
</span><span id="Store.ReceiveAllResponses.run-791"><a href="#Store.ReceiveAllResponses.run-791"><span class="linenos">791</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.ReceiveAllResponses.run-792"><a href="#Store.ReceiveAllResponses.run-792"><span class="linenos">792</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.ReceiveAllResponses.run-793"><a href="#Store.ReceiveAllResponses.run-793"><span class="linenos">793</span></a>            
</span><span id="Store.ReceiveAllResponses.run-794"><a href="#Store.ReceiveAllResponses.run-794"><span class="linenos">794</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="Store.ReceiveAllResponses.run-795"><a href="#Store.ReceiveAllResponses.run-795"><span class="linenos">795</span></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="Store.ReceiveAllResponses.run-796"><a href="#Store.ReceiveAllResponses.run-796"><span class="linenos">796</span></a>            
</span><span id="Store.ReceiveAllResponses.run-797"><a href="#Store.ReceiveAllResponses.run-797"><span class="linenos">797</span></a>            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses.run-798"><a href="#Store.ReceiveAllResponses.run-798"><span class="linenos">798</span></a>                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="Store.ReceiveAllResponses.run-799"><a href="#Store.ReceiveAllResponses.run-799"><span class="linenos">799</span></a>                <span class="n">remaining_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">-</span> <span class="n">elapsed</span>
</span><span id="Store.ReceiveAllResponses.run-800"><a href="#Store.ReceiveAllResponses.run-800"><span class="linenos">800</span></a>                
</span><span id="Store.ReceiveAllResponses.run-801"><a href="#Store.ReceiveAllResponses.run-801"><span class="linenos">801</span></a>                <span class="k">if</span> <span class="n">remaining_timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses.run-802"><a href="#Store.ReceiveAllResponses.run-802"><span class="linenos">802</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses.run-803"><a href="#Store.ReceiveAllResponses.run-803"><span class="linenos">803</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Timeout: Only received </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_warehouses</span><span class="si">}</span><span class="s2"> responses&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses.run-804"><a href="#Store.ReceiveAllResponses.run-804"><span class="linenos">804</span></a>                    <span class="k">break</span>
</span><span id="Store.ReceiveAllResponses.run-805"><a href="#Store.ReceiveAllResponses.run-805"><span class="linenos">805</span></a>                
</span><span id="Store.ReceiveAllResponses.run-806"><a href="#Store.ReceiveAllResponses.run-806"><span class="linenos">806</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">remaining_timeout</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses.run-807"><a href="#Store.ReceiveAllResponses.run-807"><span class="linenos">807</span></a>                
</span><span id="Store.ReceiveAllResponses.run-808"><a href="#Store.ReceiveAllResponses.run-808"><span class="linenos">808</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses.run-809"><a href="#Store.ReceiveAllResponses.run-809"><span class="linenos">809</span></a>                    <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses.run-810"><a href="#Store.ReceiveAllResponses.run-810"><span class="linenos">810</span></a>                    <span class="n">warehouse_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses.run-811"><a href="#Store.ReceiveAllResponses.run-811"><span class="linenos">811</span></a>                    
</span><span id="Store.ReceiveAllResponses.run-812"><a href="#Store.ReceiveAllResponses.run-812"><span class="linenos">812</span></a>                    <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;warehouse-accept&quot;</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses.run-813"><a href="#Store.ReceiveAllResponses.run-813"><span class="linenos">813</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses.run-814"><a href="#Store.ReceiveAllResponses.run-814"><span class="linenos">814</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store.ReceiveAllResponses.run-815"><a href="#Store.ReceiveAllResponses.run-815"><span class="linenos">815</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store.ReceiveAllResponses.run-816"><a href="#Store.ReceiveAllResponses.run-816"><span class="linenos">816</span></a>                        
</span><span id="Store.ReceiveAllResponses.run-817"><a href="#Store.ReceiveAllResponses.run-817"><span class="linenos">817</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses.run-818"><a href="#Store.ReceiveAllResponses.run-818"><span class="linenos">818</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received acceptance from </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses.run-819"><a href="#Store.ReceiveAllResponses.run-819"><span class="linenos">819</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
</span><span id="Store.ReceiveAllResponses.run-820"><a href="#Store.ReceiveAllResponses.run-820"><span class="linenos">820</span></a>                        
</span><span id="Store.ReceiveAllResponses.run-821"><a href="#Store.ReceiveAllResponses.run-821"><span class="linenos">821</span></a>                    <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;warehouse-reject&quot;</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses.run-822"><a href="#Store.ReceiveAllResponses.run-822"><span class="linenos">822</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses.run-823"><a href="#Store.ReceiveAllResponses.run-823"><span class="linenos">823</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store.ReceiveAllResponses.run-824"><a href="#Store.ReceiveAllResponses.run-824"><span class="linenos">824</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store.ReceiveAllResponses.run-825"><a href="#Store.ReceiveAllResponses.run-825"><span class="linenos">825</span></a>                        <span class="n">reason</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
</span><span id="Store.ReceiveAllResponses.run-826"><a href="#Store.ReceiveAllResponses.run-826"><span class="linenos">826</span></a>                        
</span><span id="Store.ReceiveAllResponses.run-827"><a href="#Store.ReceiveAllResponses.run-827"><span class="linenos">827</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses.run-828"><a href="#Store.ReceiveAllResponses.run-828"><span class="linenos">828</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received rejection from </span><span class="si">{</span><span class="n">warehouse_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> (reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveAllResponses.run-829"><a href="#Store.ReceiveAllResponses.run-829"><span class="linenos">829</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">warehouse_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
</span><span id="Store.ReceiveAllResponses.run-830"><a href="#Store.ReceiveAllResponses.run-830"><span class="linenos">830</span></a>                    
</span><span id="Store.ReceiveAllResponses.run-831"><a href="#Store.ReceiveAllResponses.run-831"><span class="linenos">831</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Store.ReceiveAllResponses.run-832"><a href="#Store.ReceiveAllResponses.run-832"><span class="linenos">832</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses.run-833"><a href="#Store.ReceiveAllResponses.run-833"><span class="linenos">833</span></a>                    <span class="c1"># No more messages, timeout</span>
</span><span id="Store.ReceiveAllResponses.run-834"><a href="#Store.ReceiveAllResponses.run-834"><span class="linenos">834</span></a>                    <span class="k">break</span>
</span><span id="Store.ReceiveAllResponses.run-835"><a href="#Store.ReceiveAllResponses.run-835"><span class="linenos">835</span></a>            
</span><span id="Store.ReceiveAllResponses.run-836"><a href="#Store.ReceiveAllResponses.run-836"><span class="linenos">836</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.ReceiveAllResponses.run-837"><a href="#Store.ReceiveAllResponses.run-837"><span class="linenos">837</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Finished collecting responses: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> accepts, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejects&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Execute the message collection loop for warehouse responses.</p>

<p>This method implements the core collection logic for the FIPA Contract Net
Protocol proposal reception phase. It continuously receives messages from
warehouses until either all expected responses arrive or a timeout occurs,
properly categorizing each response as either a proposal or refusal.</p>

<h6 id="fipa-protocol-implementation">FIPA Protocol Implementation:</h6>

<blockquote>
  <ul>
  <li><strong>Phase</strong>: Proposal Reception (collecting propose/refuse messages)</li>
  <li><strong>Role</strong>: Worker (collects data for coordinator evaluation)</li>
  <li><strong>Timeout</strong>: 5 seconds total (not per message)</li>
  <li><strong>Partial Completion</strong>: Accepts fewer responses than expected</li>
  </ul>
</blockquote>

<h6 id="algorithm">Algorithm:</h6>

<blockquote>
  <ol>
  <li><strong>Initialization</strong>: Record start time for timeout calculation</li>
  <li><strong>Collection Loop</strong>: While responses_received &lt; num_warehouses:
  a. Calculate remaining timeout based on elapsed time
  b. Check for timeout expiration (remaining_timeout &lt;= 0)
  c. Receive message with dynamically calculated timeout
  d. Parse message: extract performative, sender, and body
  e. Categorize as acceptance or rejection
  f. Append to appropriate shared list
  g. Increment responses_received counter</li>
  <li><strong>Termination</strong>: Break on timeout or no more messages</li>
  </ol>
</blockquote>

<h6 id="message-processing">Message Processing:</h6>

<blockquote>
  <p><strong>warehouse-accept</strong> (FIPA propose):
      - Body format: "{quantity} {product}"
      - Parsing: Split on space, extract quantity (int) and product (str)
      - Action: Append (warehouse_jid, msg) to acceptances list
      - Meaning: Warehouse agrees to fulfill order</p>
  
  <p><strong>warehouse-reject</strong> (FIPA refuse):
      - Body format: "{quantity} {product} {reason}"
      - Parsing: Split on space, extract quantity, product, and optional reason
      - Action: Append (warehouse_jid, msg, reason) to rejections list
      - Default reason: "unknown" if not provided
      - Meaning: Warehouse cannot or will not fulfill order</p>
</blockquote>

<h6 id="timeout-mechanism">Timeout Mechanism:</h6>

<blockquote>
  <ul>
  <li><strong>Total Timeout</strong>: 5 seconds from method start</li>
  <li><strong>Dynamic Calculation</strong>: remaining_timeout = total_timeout - elapsed_time</li>
  <li><strong>Per-Message Timeout</strong>: Each receive() uses remaining_timeout</li>
  <li><strong>Early Termination</strong>: Breaks immediately if remaining_timeout &lt;= 0</li>
  <li><strong>Graceful Handling</strong>: Allows partial responses without error</li>
  </ul>
</blockquote>

<h6 id="example-execution-timeline">Example Execution Timeline:</h6>

<blockquote>
<pre><code>t=0.0s: Start collection (expecting 3 responses)
t=0.3s: Receive warehouse1 accept -&gt; acceptances.append()
t=0.8s: Receive warehouse2 reject -&gt; rejections.append()
t=5.0s: Timeout reached (warehouse3 silent)
Result: 2/3 responses collected
</code></pre>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Populates self.acceptances shared list with proposals</li>
  <li>Populates self.rejections shared list with refusals</li>
  <li>Increments self.responses_received counter</li>
  <li>Prints debug information if verbose mode enabled</li>
  <li>May terminate early due to timeout</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Results communicated through shared list references.</p>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>The timeout is global (not per-message), ensuring the entire collection
  process completes within 5 seconds regardless of warehouse count. This
  prevents indefinite waiting when warehouses are unresponsive.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Store.SendStoreConfirmation">
                            <input id="Store.SendStoreConfirmation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Store.SendStoreConfirmation</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Store.SendStoreConfirmation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.SendStoreConfirmation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.SendStoreConfirmation-839"><a href="#Store.SendStoreConfirmation-839"><span class="linenos"> 839</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SendStoreConfirmation</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Store.SendStoreConfirmation-840"><a href="#Store.SendStoreConfirmation-840"><span class="linenos"> 840</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.SendStoreConfirmation-841"><a href="#Store.SendStoreConfirmation-841"><span class="linenos"> 841</span></a><span class="sd">        Behaviour to send confirmation to the selected warehouse (FIPA accept-proposal).</span>
</span><span id="Store.SendStoreConfirmation-842"><a href="#Store.SendStoreConfirmation-842"><span class="linenos"> 842</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreConfirmation-843"><a href="#Store.SendStoreConfirmation-843"><span class="linenos"> 843</span></a><span class="sd">        This behaviour implements the award notification phase of the FIPA Contract Net</span>
</span><span id="Store.SendStoreConfirmation-844"><a href="#Store.SendStoreConfirmation-844"><span class="linenos"> 844</span></a><span class="sd">        Protocol, informing the winning warehouse that its proposal has been accepted.</span>
</span><span id="Store.SendStoreConfirmation-845"><a href="#Store.SendStoreConfirmation-845"><span class="linenos"> 845</span></a><span class="sd">        It sends the FIPA accept-proposal message and registers the order as pending</span>
</span><span id="Store.SendStoreConfirmation-846"><a href="#Store.SendStoreConfirmation-846"><span class="linenos"> 846</span></a><span class="sd">        delivery, waiting for a vehicle to transport the goods.</span>
</span><span id="Store.SendStoreConfirmation-847"><a href="#Store.SendStoreConfirmation-847"><span class="linenos"> 847</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreConfirmation-848"><a href="#Store.SendStoreConfirmation-848"><span class="linenos"> 848</span></a><span class="sd">        FIPA Protocol Phase: **Result Notification - Award**</span>
</span><span id="Store.SendStoreConfirmation-849"><a href="#Store.SendStoreConfirmation-849"><span class="linenos"> 849</span></a><span class="sd">            - Performative: store-confirm (FIPA accept-proposal)</span>
</span><span id="Store.SendStoreConfirmation-850"><a href="#Store.SendStoreConfirmation-850"><span class="linenos"> 850</span></a><span class="sd">            - Recipient: Selected warehouse (winner of proposal evaluation)</span>
</span><span id="Store.SendStoreConfirmation-851"><a href="#Store.SendStoreConfirmation-851"><span class="linenos"> 851</span></a><span class="sd">            - Purpose: Officially award the contract to the best proposal</span>
</span><span id="Store.SendStoreConfirmation-852"><a href="#Store.SendStoreConfirmation-852"><span class="linenos"> 852</span></a><span class="sd">            - Protocol: FIPA Contract Net Protocol</span>
</span><span id="Store.SendStoreConfirmation-853"><a href="#Store.SendStoreConfirmation-853"><span class="linenos"> 853</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreConfirmation-854"><a href="#Store.SendStoreConfirmation-854"><span class="linenos"> 854</span></a><span class="sd">        This behaviour does NOT update stock immediately. Stock updates occur only when</span>
</span><span id="Store.SendStoreConfirmation-855"><a href="#Store.SendStoreConfirmation-855"><span class="linenos"> 855</span></a><span class="sd">        the vehicle delivers the products (upon receiving vehicle-delivery message).</span>
</span><span id="Store.SendStoreConfirmation-856"><a href="#Store.SendStoreConfirmation-856"><span class="linenos"> 856</span></a><span class="sd">        This design accurately models real-world supply chains where confirmation precedes</span>
</span><span id="Store.SendStoreConfirmation-857"><a href="#Store.SendStoreConfirmation-857"><span class="linenos"> 857</span></a><span class="sd">        actual inventory arrival.</span>
</span><span id="Store.SendStoreConfirmation-858"><a href="#Store.SendStoreConfirmation-858"><span class="linenos"> 858</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreConfirmation-859"><a href="#Store.SendStoreConfirmation-859"><span class="linenos"> 859</span></a><span class="sd">        Attributes:</span>
</span><span id="Store.SendStoreConfirmation-860"><a href="#Store.SendStoreConfirmation-860"><span class="linenos"> 860</span></a><span class="sd">            dest (str): Warehouse JID (winner&#39;s address).</span>
</span><span id="Store.SendStoreConfirmation-861"><a href="#Store.SendStoreConfirmation-861"><span class="linenos"> 861</span></a><span class="sd">            request_id (str): Unique request identifier from original CFP.</span>
</span><span id="Store.SendStoreConfirmation-862"><a href="#Store.SendStoreConfirmation-862"><span class="linenos"> 862</span></a><span class="sd">            quantity (int): Quantity of product in the confirmed order.</span>
</span><span id="Store.SendStoreConfirmation-863"><a href="#Store.SendStoreConfirmation-863"><span class="linenos"> 863</span></a><span class="sd">            product (str): Name of product in the confirmed order.</span>
</span><span id="Store.SendStoreConfirmation-864"><a href="#Store.SendStoreConfirmation-864"><span class="linenos"> 864</span></a><span class="sd">            msg (Message): Original warehouse-accept message (for Order conversion).</span>
</span><span id="Store.SendStoreConfirmation-865"><a href="#Store.SendStoreConfirmation-865"><span class="linenos"> 865</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreConfirmation-866"><a href="#Store.SendStoreConfirmation-866"><span class="linenos"> 866</span></a><span class="sd">        Message Format (FIPA accept-proposal):</span>
</span><span id="Store.SendStoreConfirmation-867"><a href="#Store.SendStoreConfirmation-867"><span class="linenos"> 867</span></a><span class="sd">            Metadata:</span>
</span><span id="Store.SendStoreConfirmation-868"><a href="#Store.SendStoreConfirmation-868"><span class="linenos"> 868</span></a><span class="sd">                - performative: &quot;store-confirm&quot; (FIPA accept-proposal)</span>
</span><span id="Store.SendStoreConfirmation-869"><a href="#Store.SendStoreConfirmation-869"><span class="linenos"> 869</span></a><span class="sd">                - warehouse_id: Destination warehouse JID</span>
</span><span id="Store.SendStoreConfirmation-870"><a href="#Store.SendStoreConfirmation-870"><span class="linenos"> 870</span></a><span class="sd">                - store_id: This store&#39;s JID</span>
</span><span id="Store.SendStoreConfirmation-871"><a href="#Store.SendStoreConfirmation-871"><span class="linenos"> 871</span></a><span class="sd">                - node_id: This store&#39;s graph location</span>
</span><span id="Store.SendStoreConfirmation-872"><a href="#Store.SendStoreConfirmation-872"><span class="linenos"> 872</span></a><span class="sd">                - request_id: Original CFP request identifier</span>
</span><span id="Store.SendStoreConfirmation-873"><a href="#Store.SendStoreConfirmation-873"><span class="linenos"> 873</span></a><span class="sd">            Body:</span>
</span><span id="Store.SendStoreConfirmation-874"><a href="#Store.SendStoreConfirmation-874"><span class="linenos"> 874</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.SendStoreConfirmation-875"><a href="#Store.SendStoreConfirmation-875"><span class="linenos"> 875</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="Store.SendStoreConfirmation-876"><a href="#Store.SendStoreConfirmation-876"><span class="linenos"> 876</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreConfirmation-877"><a href="#Store.SendStoreConfirmation-877"><span class="linenos"> 877</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store.SendStoreConfirmation-878"><a href="#Store.SendStoreConfirmation-878"><span class="linenos"> 878</span></a><span class="sd">            - Converts message to Order object using message_to_order()</span>
</span><span id="Store.SendStoreConfirmation-879"><a href="#Store.SendStoreConfirmation-879"><span class="linenos"> 879</span></a><span class="sd">            - Adds order to agent.pending_deliveries dict (key: order_id)</span>
</span><span id="Store.SendStoreConfirmation-880"><a href="#Store.SendStoreConfirmation-880"><span class="linenos"> 880</span></a><span class="sd">            - Records confirmation timestamp in agent.order_timings (for statistics)</span>
</span><span id="Store.SendStoreConfirmation-881"><a href="#Store.SendStoreConfirmation-881"><span class="linenos"> 881</span></a><span class="sd">            - Sends store-confirm message to warehouse</span>
</span><span id="Store.SendStoreConfirmation-882"><a href="#Store.SendStoreConfirmation-882"><span class="linenos"> 882</span></a><span class="sd">            - Prints confirmation details (always visible, not verbose-only)</span>
</span><span id="Store.SendStoreConfirmation-883"><a href="#Store.SendStoreConfirmation-883"><span class="linenos"> 883</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreConfirmation-884"><a href="#Store.SendStoreConfirmation-884"><span class="linenos"> 884</span></a><span class="sd">        Workflow:</span>
</span><span id="Store.SendStoreConfirmation-885"><a href="#Store.SendStoreConfirmation-885"><span class="linenos"> 885</span></a><span class="sd">            1. Convert warehouse-accept message to Order object</span>
</span><span id="Store.SendStoreConfirmation-886"><a href="#Store.SendStoreConfirmation-886"><span class="linenos"> 886</span></a><span class="sd">            2. Register order in pending_deliveries (awaiting vehicle)</span>
</span><span id="Store.SendStoreConfirmation-887"><a href="#Store.SendStoreConfirmation-887"><span class="linenos"> 887</span></a><span class="sd">            3. Record current tick in order_timings (for time-to-delivery calculation)</span>
</span><span id="Store.SendStoreConfirmation-888"><a href="#Store.SendStoreConfirmation-888"><span class="linenos"> 888</span></a><span class="sd">            4. Construct store-confirm message with proper metadata</span>
</span><span id="Store.SendStoreConfirmation-889"><a href="#Store.SendStoreConfirmation-889"><span class="linenos"> 889</span></a><span class="sd">            5. Send confirmation to warehouse</span>
</span><span id="Store.SendStoreConfirmation-890"><a href="#Store.SendStoreConfirmation-890"><span class="linenos"> 890</span></a><span class="sd">            6. Print success message with order details</span>
</span><span id="Store.SendStoreConfirmation-891"><a href="#Store.SendStoreConfirmation-891"><span class="linenos"> 891</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreConfirmation-892"><a href="#Store.SendStoreConfirmation-892"><span class="linenos"> 892</span></a><span class="sd">        Example:</span>
</span><span id="Store.SendStoreConfirmation-893"><a href="#Store.SendStoreConfirmation-893"><span class="linenos"> 893</span></a><span class="sd">            ```</span>
</span><span id="Store.SendStoreConfirmation-894"><a href="#Store.SendStoreConfirmation-894"><span class="linenos"> 894</span></a><span class="sd">            Warehouse: warehouse2@localhost</span>
</span><span id="Store.SendStoreConfirmation-895"><a href="#Store.SendStoreConfirmation-895"><span class="linenos"> 895</span></a><span class="sd">            Request: &quot;50 electronics&quot; (ID: 1001000000)</span>
</span><span id="Store.SendStoreConfirmation-896"><a href="#Store.SendStoreConfirmation-896"><span class="linenos"> 896</span></a><span class="sd">            Action: Send store-confirm to warehouse2</span>
</span><span id="Store.SendStoreConfirmation-897"><a href="#Store.SendStoreConfirmation-897"><span class="linenos"> 897</span></a><span class="sd">            Result: Order 1001000000 pending delivery</span>
</span><span id="Store.SendStoreConfirmation-898"><a href="#Store.SendStoreConfirmation-898"><span class="linenos"> 898</span></a><span class="sd">            Print: &quot;Successfully bought 50 xelectronics from warehouse2...&quot;</span>
</span><span id="Store.SendStoreConfirmation-899"><a href="#Store.SendStoreConfirmation-899"><span class="linenos"> 899</span></a><span class="sd">            ```</span>
</span><span id="Store.SendStoreConfirmation-900"><a href="#Store.SendStoreConfirmation-900"><span class="linenos"> 900</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreConfirmation-901"><a href="#Store.SendStoreConfirmation-901"><span class="linenos"> 901</span></a><span class="sd">        Note:</span>
</span><span id="Store.SendStoreConfirmation-902"><a href="#Store.SendStoreConfirmation-902"><span class="linenos"> 902</span></a><span class="sd">            The confirmation message triggers the warehouse to assign a vehicle for</span>
</span><span id="Store.SendStoreConfirmation-903"><a href="#Store.SendStoreConfirmation-903"><span class="linenos"> 903</span></a><span class="sd">            delivery. The store then waits for vehicle-delivery message to update stock.</span>
</span><span id="Store.SendStoreConfirmation-904"><a href="#Store.SendStoreConfirmation-904"><span class="linenos"> 904</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.SendStoreConfirmation-905"><a href="#Store.SendStoreConfirmation-905"><span class="linenos"> 905</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Store.SendStoreConfirmation-906"><a href="#Store.SendStoreConfirmation-906"><span class="linenos"> 906</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.SendStoreConfirmation-907"><a href="#Store.SendStoreConfirmation-907"><span class="linenos"> 907</span></a><span class="sd">            Initialize the SendStoreConfirmation behaviour.</span>
</span><span id="Store.SendStoreConfirmation-908"><a href="#Store.SendStoreConfirmation-908"><span class="linenos"> 908</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation-909"><a href="#Store.SendStoreConfirmation-909"><span class="linenos"> 909</span></a><span class="sd">            Args:</span>
</span><span id="Store.SendStoreConfirmation-910"><a href="#Store.SendStoreConfirmation-910"><span class="linenos"> 910</span></a><span class="sd">                msg (Message): The warehouse-accept message from the winning warehouse.</span>
</span><span id="Store.SendStoreConfirmation-911"><a href="#Store.SendStoreConfirmation-911"><span class="linenos"> 911</span></a><span class="sd">                    Contains all necessary information: sender, request_id, quantity, product.</span>
</span><span id="Store.SendStoreConfirmation-912"><a href="#Store.SendStoreConfirmation-912"><span class="linenos"> 912</span></a><span class="sd">                    Used to construct the confirmation message and create Order object.</span>
</span><span id="Store.SendStoreConfirmation-913"><a href="#Store.SendStoreConfirmation-913"><span class="linenos"> 913</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation-914"><a href="#Store.SendStoreConfirmation-914"><span class="linenos"> 914</span></a><span class="sd">            Note:</span>
</span><span id="Store.SendStoreConfirmation-915"><a href="#Store.SendStoreConfirmation-915"><span class="linenos"> 915</span></a><span class="sd">                Extracts and stores all relevant fields from the message for use in run().</span>
</span><span id="Store.SendStoreConfirmation-916"><a href="#Store.SendStoreConfirmation-916"><span class="linenos"> 916</span></a><span class="sd">                The original message is preserved for Order object conversion.</span>
</span><span id="Store.SendStoreConfirmation-917"><a href="#Store.SendStoreConfirmation-917"><span class="linenos"> 917</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.SendStoreConfirmation-918"><a href="#Store.SendStoreConfirmation-918"><span class="linenos"> 918</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Store.SendStoreConfirmation-919"><a href="#Store.SendStoreConfirmation-919"><span class="linenos"> 919</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Store.SendStoreConfirmation-920"><a href="#Store.SendStoreConfirmation-920"><span class="linenos"> 920</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation-921"><a href="#Store.SendStoreConfirmation-921"><span class="linenos"> 921</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation-922"><a href="#Store.SendStoreConfirmation-922"><span class="linenos"> 922</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store.SendStoreConfirmation-923"><a href="#Store.SendStoreConfirmation-923"><span class="linenos"> 923</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store.SendStoreConfirmation-924"><a href="#Store.SendStoreConfirmation-924"><span class="linenos"> 924</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="Store.SendStoreConfirmation-925"><a href="#Store.SendStoreConfirmation-925"><span class="linenos"> 925</span></a>            
</span><span id="Store.SendStoreConfirmation-926"><a href="#Store.SendStoreConfirmation-926"><span class="linenos"> 926</span></a>        
</span><span id="Store.SendStoreConfirmation-927"><a href="#Store.SendStoreConfirmation-927"><span class="linenos"> 927</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.SendStoreConfirmation-928"><a href="#Store.SendStoreConfirmation-928"><span class="linenos"> 928</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.SendStoreConfirmation-929"><a href="#Store.SendStoreConfirmation-929"><span class="linenos"> 929</span></a><span class="sd">            Execute the confirmation sending process (FIPA accept-proposal).</span>
</span><span id="Store.SendStoreConfirmation-930"><a href="#Store.SendStoreConfirmation-930"><span class="linenos"> 930</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation-931"><a href="#Store.SendStoreConfirmation-931"><span class="linenos"> 931</span></a><span class="sd">            This method sends the FIPA accept-proposal message to the winning warehouse,</span>
</span><span id="Store.SendStoreConfirmation-932"><a href="#Store.SendStoreConfirmation-932"><span class="linenos"> 932</span></a><span class="sd">            registers the order as pending delivery, and records timing information for</span>
</span><span id="Store.SendStoreConfirmation-933"><a href="#Store.SendStoreConfirmation-933"><span class="linenos"> 933</span></a><span class="sd">            statistics. It implements the award notification phase of the FIPA Contract</span>
</span><span id="Store.SendStoreConfirmation-934"><a href="#Store.SendStoreConfirmation-934"><span class="linenos"> 934</span></a><span class="sd">            Net Protocol.</span>
</span><span id="Store.SendStoreConfirmation-935"><a href="#Store.SendStoreConfirmation-935"><span class="linenos"> 935</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation-936"><a href="#Store.SendStoreConfirmation-936"><span class="linenos"> 936</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Store.SendStoreConfirmation-937"><a href="#Store.SendStoreConfirmation-937"><span class="linenos"> 937</span></a><span class="sd">                - **Phase**: Result Notification - Award</span>
</span><span id="Store.SendStoreConfirmation-938"><a href="#Store.SendStoreConfirmation-938"><span class="linenos"> 938</span></a><span class="sd">                - **Performative**: store-confirm (FIPA accept-proposal)</span>
</span><span id="Store.SendStoreConfirmation-939"><a href="#Store.SendStoreConfirmation-939"><span class="linenos"> 939</span></a><span class="sd">                - **Meaning**: &quot;Your proposal is accepted, prepare the order&quot;</span>
</span><span id="Store.SendStoreConfirmation-940"><a href="#Store.SendStoreConfirmation-940"><span class="linenos"> 940</span></a><span class="sd">                - **Expected Response**: Warehouse assigns vehicle for delivery</span>
</span><span id="Store.SendStoreConfirmation-941"><a href="#Store.SendStoreConfirmation-941"><span class="linenos"> 941</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation-942"><a href="#Store.SendStoreConfirmation-942"><span class="linenos"> 942</span></a><span class="sd">            Important Design Decision:</span>
</span><span id="Store.SendStoreConfirmation-943"><a href="#Store.SendStoreConfirmation-943"><span class="linenos"> 943</span></a><span class="sd">                Stock is NOT updated immediately upon confirmation. Stock updates occur</span>
</span><span id="Store.SendStoreConfirmation-944"><a href="#Store.SendStoreConfirmation-944"><span class="linenos"> 944</span></a><span class="sd">                only when the vehicle delivers the products (vehicle-delivery message).</span>
</span><span id="Store.SendStoreConfirmation-945"><a href="#Store.SendStoreConfirmation-945"><span class="linenos"> 945</span></a><span class="sd">                This accurately models real-world logistics where confirmation  possession.</span>
</span><span id="Store.SendStoreConfirmation-946"><a href="#Store.SendStoreConfirmation-946"><span class="linenos"> 946</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation-947"><a href="#Store.SendStoreConfirmation-947"><span class="linenos"> 947</span></a><span class="sd">            Workflow:</span>
</span><span id="Store.SendStoreConfirmation-948"><a href="#Store.SendStoreConfirmation-948"><span class="linenos"> 948</span></a><span class="sd">                1. **Order Conversion**: Convert warehouse-accept message to Order object</span>
</span><span id="Store.SendStoreConfirmation-949"><a href="#Store.SendStoreConfirmation-949"><span class="linenos"> 949</span></a><span class="sd">                    - Extracts: product, quantity, orderid, sender, receiver, locations</span>
</span><span id="Store.SendStoreConfirmation-950"><a href="#Store.SendStoreConfirmation-950"><span class="linenos"> 950</span></a><span class="sd">                    - Uses message_to_order() helper method</span>
</span><span id="Store.SendStoreConfirmation-951"><a href="#Store.SendStoreConfirmation-951"><span class="linenos"> 951</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreConfirmation-952"><a href="#Store.SendStoreConfirmation-952"><span class="linenos"> 952</span></a><span class="sd">                2. **Order Registration**: Add to pending_deliveries dict</span>
</span><span id="Store.SendStoreConfirmation-953"><a href="#Store.SendStoreConfirmation-953"><span class="linenos"> 953</span></a><span class="sd">                    - Key: order.orderid (unique request ID)</span>
</span><span id="Store.SendStoreConfirmation-954"><a href="#Store.SendStoreConfirmation-954"><span class="linenos"> 954</span></a><span class="sd">                    - Value: Order object with full details</span>
</span><span id="Store.SendStoreConfirmation-955"><a href="#Store.SendStoreConfirmation-955"><span class="linenos"> 955</span></a><span class="sd">                    - Purpose: Track orders awaiting vehicle delivery</span>
</span><span id="Store.SendStoreConfirmation-956"><a href="#Store.SendStoreConfirmation-956"><span class="linenos"> 956</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreConfirmation-957"><a href="#Store.SendStoreConfirmation-957"><span class="linenos"> 957</span></a><span class="sd">                3. **Timing Record**: Store current tick in order_timings</span>
</span><span id="Store.SendStoreConfirmation-958"><a href="#Store.SendStoreConfirmation-958"><span class="linenos"> 958</span></a><span class="sd">                    - Key: order.orderid</span>
</span><span id="Store.SendStoreConfirmation-959"><a href="#Store.SendStoreConfirmation-959"><span class="linenos"> 959</span></a><span class="sd">                    - Value: agent.current_tick (simulation time)</span>
</span><span id="Store.SendStoreConfirmation-960"><a href="#Store.SendStoreConfirmation-960"><span class="linenos"> 960</span></a><span class="sd">                    - Purpose: Calculate time-to-delivery for statistics</span>
</span><span id="Store.SendStoreConfirmation-961"><a href="#Store.SendStoreConfirmation-961"><span class="linenos"> 961</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreConfirmation-962"><a href="#Store.SendStoreConfirmation-962"><span class="linenos"> 962</span></a><span class="sd">                4. **Message Construction**: Build store-confirm message</span>
</span><span id="Store.SendStoreConfirmation-963"><a href="#Store.SendStoreConfirmation-963"><span class="linenos"> 963</span></a><span class="sd">                    - Performative: store-confirm (FIPA accept-proposal)</span>
</span><span id="Store.SendStoreConfirmation-964"><a href="#Store.SendStoreConfirmation-964"><span class="linenos"> 964</span></a><span class="sd">                    - Metadata: warehouse_id, store_id, node_id, request_id</span>
</span><span id="Store.SendStoreConfirmation-965"><a href="#Store.SendStoreConfirmation-965"><span class="linenos"> 965</span></a><span class="sd">                    - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.SendStoreConfirmation-966"><a href="#Store.SendStoreConfirmation-966"><span class="linenos"> 966</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreConfirmation-967"><a href="#Store.SendStoreConfirmation-967"><span class="linenos"> 967</span></a><span class="sd">                5. **Message Transmission**: Send confirmation to warehouse</span>
</span><span id="Store.SendStoreConfirmation-968"><a href="#Store.SendStoreConfirmation-968"><span class="linenos"> 968</span></a><span class="sd">                    - Triggers warehouse to assign vehicle</span>
</span><span id="Store.SendStoreConfirmation-969"><a href="#Store.SendStoreConfirmation-969"><span class="linenos"> 969</span></a><span class="sd">                    - Initiates delivery logistics process</span>
</span><span id="Store.SendStoreConfirmation-970"><a href="#Store.SendStoreConfirmation-970"><span class="linenos"> 970</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreConfirmation-971"><a href="#Store.SendStoreConfirmation-971"><span class="linenos"> 971</span></a><span class="sd">                6. **Status Logging**: Print confirmation details</span>
</span><span id="Store.SendStoreConfirmation-972"><a href="#Store.SendStoreConfirmation-972"><span class="linenos"> 972</span></a><span class="sd">                    - Verbose message: Confirmation sent details</span>
</span><span id="Store.SendStoreConfirmation-973"><a href="#Store.SendStoreConfirmation-973"><span class="linenos"> 973</span></a><span class="sd">                    - Essential message: Order success with order ID</span>
</span><span id="Store.SendStoreConfirmation-974"><a href="#Store.SendStoreConfirmation-974"><span class="linenos"> 974</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation-975"><a href="#Store.SendStoreConfirmation-975"><span class="linenos"> 975</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.SendStoreConfirmation-976"><a href="#Store.SendStoreConfirmation-976"><span class="linenos"> 976</span></a><span class="sd">                - Modifies agent.pending_deliveries (adds order)</span>
</span><span id="Store.SendStoreConfirmation-977"><a href="#Store.SendStoreConfirmation-977"><span class="linenos"> 977</span></a><span class="sd">                - Modifies agent.order_timings (records timestamp)</span>
</span><span id="Store.SendStoreConfirmation-978"><a href="#Store.SendStoreConfirmation-978"><span class="linenos"> 978</span></a><span class="sd">                - Sends SPADE message to warehouse</span>
</span><span id="Store.SendStoreConfirmation-979"><a href="#Store.SendStoreConfirmation-979"><span class="linenos"> 979</span></a><span class="sd">                - Prints status information to console</span>
</span><span id="Store.SendStoreConfirmation-980"><a href="#Store.SendStoreConfirmation-980"><span class="linenos"> 980</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation-981"><a href="#Store.SendStoreConfirmation-981"><span class="linenos"> 981</span></a><span class="sd">            Returns:</span>
</span><span id="Store.SendStoreConfirmation-982"><a href="#Store.SendStoreConfirmation-982"><span class="linenos"> 982</span></a><span class="sd">                None. Completes when confirmation message is sent.</span>
</span><span id="Store.SendStoreConfirmation-983"><a href="#Store.SendStoreConfirmation-983"><span class="linenos"> 983</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation-984"><a href="#Store.SendStoreConfirmation-984"><span class="linenos"> 984</span></a><span class="sd">            Example Execution:</span>
</span><span id="Store.SendStoreConfirmation-985"><a href="#Store.SendStoreConfirmation-985"><span class="linenos"> 985</span></a><span class="sd">                ```</span>
</span><span id="Store.SendStoreConfirmation-986"><a href="#Store.SendStoreConfirmation-986"><span class="linenos"> 986</span></a><span class="sd">                Input: warehouse-accept from warehouse2</span>
</span><span id="Store.SendStoreConfirmation-987"><a href="#Store.SendStoreConfirmation-987"><span class="linenos"> 987</span></a><span class="sd">                    Body: &quot;50 electronics&quot;</span>
</span><span id="Store.SendStoreConfirmation-988"><a href="#Store.SendStoreConfirmation-988"><span class="linenos"> 988</span></a><span class="sd">                    request_id: 1001000000</span>
</span><span id="Store.SendStoreConfirmation-989"><a href="#Store.SendStoreConfirmation-989"><span class="linenos"> 989</span></a><span class="sd">                Processing:</span>
</span><span id="Store.SendStoreConfirmation-990"><a href="#Store.SendStoreConfirmation-990"><span class="linenos"> 990</span></a><span class="sd">                    - Create Order(orderid=1001000000, quantity=50, product=&quot;electronics&quot;)</span>
</span><span id="Store.SendStoreConfirmation-991"><a href="#Store.SendStoreConfirmation-991"><span class="linenos"> 991</span></a><span class="sd">                    - pending_deliveries[1001000000] = Order(...)</span>
</span><span id="Store.SendStoreConfirmation-992"><a href="#Store.SendStoreConfirmation-992"><span class="linenos"> 992</span></a><span class="sd">                    - order_timings[1001000000] = 42 (current tick)</span>
</span><span id="Store.SendStoreConfirmation-993"><a href="#Store.SendStoreConfirmation-993"><span class="linenos"> 993</span></a><span class="sd">                Output:</span>
</span><span id="Store.SendStoreConfirmation-994"><a href="#Store.SendStoreConfirmation-994"><span class="linenos"> 994</span></a><span class="sd">                    - Send store-confirm to warehouse2</span>
</span><span id="Store.SendStoreConfirmation-995"><a href="#Store.SendStoreConfirmation-995"><span class="linenos"> 995</span></a><span class="sd">                    - Print: &quot;Successfully bought 50 xelectronics from warehouse2 under order id 1001000000&quot;</span>
</span><span id="Store.SendStoreConfirmation-996"><a href="#Store.SendStoreConfirmation-996"><span class="linenos"> 996</span></a><span class="sd">                ```</span>
</span><span id="Store.SendStoreConfirmation-997"><a href="#Store.SendStoreConfirmation-997"><span class="linenos"> 997</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation-998"><a href="#Store.SendStoreConfirmation-998"><span class="linenos"> 998</span></a><span class="sd">            Note:</span>
</span><span id="Store.SendStoreConfirmation-999"><a href="#Store.SendStoreConfirmation-999"><span class="linenos"> 999</span></a><span class="sd">                The order remains in pending_deliveries until ReceiveVehicleArrival</span>
</span><span id="Store.SendStoreConfirmation-1000"><a href="#Store.SendStoreConfirmation-1000"><span class="linenos">1000</span></a><span class="sd">                processes the vehicle-delivery message and updates stock. This maintains</span>
</span><span id="Store.SendStoreConfirmation-1001"><a href="#Store.SendStoreConfirmation-1001"><span class="linenos">1001</span></a><span class="sd">                separation between contract award and physical delivery.</span>
</span><span id="Store.SendStoreConfirmation-1002"><a href="#Store.SendStoreConfirmation-1002"><span class="linenos">1002</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.SendStoreConfirmation-1003"><a href="#Store.SendStoreConfirmation-1003"><span class="linenos">1003</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.SendStoreConfirmation-1004"><a href="#Store.SendStoreConfirmation-1004"><span class="linenos">1004</span></a>            
</span><span id="Store.SendStoreConfirmation-1005"><a href="#Store.SendStoreConfirmation-1005"><span class="linenos">1005</span></a>            <span class="c1"># Don&#39;t update stock here - wait for vehicle delivery</span>
</span><span id="Store.SendStoreConfirmation-1006"><a href="#Store.SendStoreConfirmation-1006"><span class="linenos">1006</span></a>            <span class="c1"># Stock will be updated when vehicle-delivery message is received</span>
</span><span id="Store.SendStoreConfirmation-1007"><a href="#Store.SendStoreConfirmation-1007"><span class="linenos">1007</span></a>            <span class="n">order</span> <span class="p">:</span> <span class="n">Order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">message_to_order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation-1008"><a href="#Store.SendStoreConfirmation-1008"><span class="linenos">1008</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
</span><span id="Store.SendStoreConfirmation-1009"><a href="#Store.SendStoreConfirmation-1009"><span class="linenos">1009</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">order_timings</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">current_tick</span>
</span><span id="Store.SendStoreConfirmation-1010"><a href="#Store.SendStoreConfirmation-1010"><span class="linenos">1010</span></a>            
</span><span id="Store.SendStoreConfirmation-1011"><a href="#Store.SendStoreConfirmation-1011"><span class="linenos">1011</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation-1012"><a href="#Store.SendStoreConfirmation-1012"><span class="linenos">1012</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-confirm&quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation-1013"><a href="#Store.SendStoreConfirmation-1013"><span class="linenos">1013</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="Store.SendStoreConfirmation-1014"><a href="#Store.SendStoreConfirmation-1014"><span class="linenos">1014</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store.SendStoreConfirmation-1015"><a href="#Store.SendStoreConfirmation-1015"><span class="linenos">1015</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Store.SendStoreConfirmation-1016"><a href="#Store.SendStoreConfirmation-1016"><span class="linenos">1016</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store.SendStoreConfirmation-1017"><a href="#Store.SendStoreConfirmation-1017"><span class="linenos">1017</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Store.SendStoreConfirmation-1018"><a href="#Store.SendStoreConfirmation-1018"><span class="linenos">1018</span></a>            
</span><span id="Store.SendStoreConfirmation-1019"><a href="#Store.SendStoreConfirmation-1019"><span class="linenos">1019</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation-1020"><a href="#Store.SendStoreConfirmation-1020"><span class="linenos">1020</span></a>            
</span><span id="Store.SendStoreConfirmation-1021"><a href="#Store.SendStoreConfirmation-1021"><span class="linenos">1021</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.SendStoreConfirmation-1022"><a href="#Store.SendStoreConfirmation-1022"><span class="linenos">1022</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Confirmation sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation-1023"><a href="#Store.SendStoreConfirmation-1023"><span class="linenos">1023</span></a>            
</span><span id="Store.SendStoreConfirmation-1024"><a href="#Store.SendStoreConfirmation-1024"><span class="linenos">1024</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Successully bought </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> under order id </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Behaviour to send confirmation to the selected warehouse (FIPA accept-proposal).</p>

<p>This behaviour implements the award notification phase of the FIPA Contract Net
Protocol, informing the winning warehouse that its proposal has been accepted.
It sends the FIPA accept-proposal message and registers the order as pending
delivery, waiting for a vehicle to transport the goods.</p>

<p>FIPA Protocol Phase: <strong>Result Notification - Award</strong>
    - Performative: store-confirm (FIPA accept-proposal)
    - Recipient: Selected warehouse (winner of proposal evaluation)
    - Purpose: Officially award the contract to the best proposal
    - Protocol: FIPA Contract Net Protocol</p>

<p>This behaviour does NOT update stock immediately. Stock updates occur only when
the vehicle delivers the products (upon receiving vehicle-delivery message).
This design accurately models real-world supply chains where confirmation precedes
actual inventory arrival.</p>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>dest (str):</strong>  Warehouse JID (winner's address).</li>
<li><strong>request_id (str):</strong>  Unique request identifier from original CFP.</li>
<li><strong>quantity (int):</strong>  Quantity of product in the confirmed order.</li>
<li><strong>product (str):</strong>  Name of product in the confirmed order.</li>
<li><strong>msg (Message):</strong>  Original warehouse-accept message (for Order conversion).</li>
</ul>

<p>Message Format (FIPA accept-proposal):
    Metadata:
        - performative: "store-confirm" (FIPA accept-proposal)
        - warehouse_id: Destination warehouse JID
        - store_id: This store's JID
        - node_id: This store's graph location
        - request_id: Original CFP request identifier
    Body:
        - Format: "{quantity} {product}"
        - Example: "50 electronics"</p>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Converts message to Order object using message_to_order()</li>
  <li>Adds order to agent.pending_deliveries dict (key: order_id)</li>
  <li>Records confirmation timestamp in agent.order_timings (for statistics)</li>
  <li>Sends store-confirm message to warehouse</li>
  <li>Prints confirmation details (always visible, not verbose-only)</li>
  </ul>
</blockquote>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li>Convert warehouse-accept message to Order object</li>
  <li>Register order in pending_deliveries (awaiting vehicle)</li>
  <li>Record current tick in order_timings (for time-to-delivery calculation)</li>
  <li>Construct store-confirm message with proper metadata</li>
  <li>Send confirmation to warehouse</li>
  <li>Print success message with order details</li>
  </ol>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
<pre><code>Warehouse: warehouse2@localhost
Request: "50 electronics" (ID: 1001000000)
Action: Send store-confirm to warehouse2
Result: Order 1001000000 pending delivery
Print: "Successfully bought 50 xelectronics from warehouse2..."
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>The confirmation message triggers the warehouse to assign a vehicle for
  delivery. The store then waits for vehicle-delivery message to update stock.</p>
</blockquote>
</div>


                            <div id="Store.SendStoreConfirmation.__init__" class="classattr">
                                        <input id="Store.SendStoreConfirmation.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Store.SendStoreConfirmation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span></span>)</span>

                <label class="view-source-button" for="Store.SendStoreConfirmation.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.SendStoreConfirmation.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.SendStoreConfirmation.__init__-905"><a href="#Store.SendStoreConfirmation.__init__-905"><span class="linenos">905</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Store.SendStoreConfirmation.__init__-906"><a href="#Store.SendStoreConfirmation.__init__-906"><span class="linenos">906</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.SendStoreConfirmation.__init__-907"><a href="#Store.SendStoreConfirmation.__init__-907"><span class="linenos">907</span></a><span class="sd">            Initialize the SendStoreConfirmation behaviour.</span>
</span><span id="Store.SendStoreConfirmation.__init__-908"><a href="#Store.SendStoreConfirmation.__init__-908"><span class="linenos">908</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation.__init__-909"><a href="#Store.SendStoreConfirmation.__init__-909"><span class="linenos">909</span></a><span class="sd">            Args:</span>
</span><span id="Store.SendStoreConfirmation.__init__-910"><a href="#Store.SendStoreConfirmation.__init__-910"><span class="linenos">910</span></a><span class="sd">                msg (Message): The warehouse-accept message from the winning warehouse.</span>
</span><span id="Store.SendStoreConfirmation.__init__-911"><a href="#Store.SendStoreConfirmation.__init__-911"><span class="linenos">911</span></a><span class="sd">                    Contains all necessary information: sender, request_id, quantity, product.</span>
</span><span id="Store.SendStoreConfirmation.__init__-912"><a href="#Store.SendStoreConfirmation.__init__-912"><span class="linenos">912</span></a><span class="sd">                    Used to construct the confirmation message and create Order object.</span>
</span><span id="Store.SendStoreConfirmation.__init__-913"><a href="#Store.SendStoreConfirmation.__init__-913"><span class="linenos">913</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation.__init__-914"><a href="#Store.SendStoreConfirmation.__init__-914"><span class="linenos">914</span></a><span class="sd">            Note:</span>
</span><span id="Store.SendStoreConfirmation.__init__-915"><a href="#Store.SendStoreConfirmation.__init__-915"><span class="linenos">915</span></a><span class="sd">                Extracts and stores all relevant fields from the message for use in run().</span>
</span><span id="Store.SendStoreConfirmation.__init__-916"><a href="#Store.SendStoreConfirmation.__init__-916"><span class="linenos">916</span></a><span class="sd">                The original message is preserved for Order object conversion.</span>
</span><span id="Store.SendStoreConfirmation.__init__-917"><a href="#Store.SendStoreConfirmation.__init__-917"><span class="linenos">917</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.SendStoreConfirmation.__init__-918"><a href="#Store.SendStoreConfirmation.__init__-918"><span class="linenos">918</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Store.SendStoreConfirmation.__init__-919"><a href="#Store.SendStoreConfirmation.__init__-919"><span class="linenos">919</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Store.SendStoreConfirmation.__init__-920"><a href="#Store.SendStoreConfirmation.__init__-920"><span class="linenos">920</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation.__init__-921"><a href="#Store.SendStoreConfirmation.__init__-921"><span class="linenos">921</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation.__init__-922"><a href="#Store.SendStoreConfirmation.__init__-922"><span class="linenos">922</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store.SendStoreConfirmation.__init__-923"><a href="#Store.SendStoreConfirmation.__init__-923"><span class="linenos">923</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store.SendStoreConfirmation.__init__-924"><a href="#Store.SendStoreConfirmation.__init__-924"><span class="linenos">924</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">msg</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the SendStoreConfirmation behaviour.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>msg (Message):</strong>  The warehouse-accept message from the winning warehouse.
Contains all necessary information: sender, request_id, quantity, product.
Used to construct the confirmation message and create Order object.</li>
</ul>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Extracts and stores all relevant fields from the message for use in run().
  The original message is preserved for Order object conversion.</p>
</blockquote>
</div>


                            </div>
                            <div id="Store.SendStoreConfirmation.dest" class="classattr">
                                <div class="attr variable">
            <span class="name">dest</span>

        
    </div>
    <a class="headerlink" href="#Store.SendStoreConfirmation.dest"></a>
    
    

                            </div>
                            <div id="Store.SendStoreConfirmation.request_id" class="classattr">
                                <div class="attr variable">
            <span class="name">request_id</span>

        
    </div>
    <a class="headerlink" href="#Store.SendStoreConfirmation.request_id"></a>
    
    

                            </div>
                            <div id="Store.SendStoreConfirmation.quantity" class="classattr">
                                <div class="attr variable">
            <span class="name">quantity</span>

        
    </div>
    <a class="headerlink" href="#Store.SendStoreConfirmation.quantity"></a>
    
    

                            </div>
                            <div id="Store.SendStoreConfirmation.product" class="classattr">
                                <div class="attr variable">
            <span class="name">product</span>

        
    </div>
    <a class="headerlink" href="#Store.SendStoreConfirmation.product"></a>
    
    

                            </div>
                            <div id="Store.SendStoreConfirmation.msg" class="classattr">
                                <div class="attr variable">
            <span class="name">msg</span><span class="annotation">: spade.message.Message</span>

        
    </div>
    <a class="headerlink" href="#Store.SendStoreConfirmation.msg"></a>
    
    

                            </div>
                            <div id="Store.SendStoreConfirmation.run" class="classattr">
                                        <input id="Store.SendStoreConfirmation.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Store.SendStoreConfirmation.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.SendStoreConfirmation.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.SendStoreConfirmation.run-927"><a href="#Store.SendStoreConfirmation.run-927"><span class="linenos"> 927</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.SendStoreConfirmation.run-928"><a href="#Store.SendStoreConfirmation.run-928"><span class="linenos"> 928</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.SendStoreConfirmation.run-929"><a href="#Store.SendStoreConfirmation.run-929"><span class="linenos"> 929</span></a><span class="sd">            Execute the confirmation sending process (FIPA accept-proposal).</span>
</span><span id="Store.SendStoreConfirmation.run-930"><a href="#Store.SendStoreConfirmation.run-930"><span class="linenos"> 930</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation.run-931"><a href="#Store.SendStoreConfirmation.run-931"><span class="linenos"> 931</span></a><span class="sd">            This method sends the FIPA accept-proposal message to the winning warehouse,</span>
</span><span id="Store.SendStoreConfirmation.run-932"><a href="#Store.SendStoreConfirmation.run-932"><span class="linenos"> 932</span></a><span class="sd">            registers the order as pending delivery, and records timing information for</span>
</span><span id="Store.SendStoreConfirmation.run-933"><a href="#Store.SendStoreConfirmation.run-933"><span class="linenos"> 933</span></a><span class="sd">            statistics. It implements the award notification phase of the FIPA Contract</span>
</span><span id="Store.SendStoreConfirmation.run-934"><a href="#Store.SendStoreConfirmation.run-934"><span class="linenos"> 934</span></a><span class="sd">            Net Protocol.</span>
</span><span id="Store.SendStoreConfirmation.run-935"><a href="#Store.SendStoreConfirmation.run-935"><span class="linenos"> 935</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation.run-936"><a href="#Store.SendStoreConfirmation.run-936"><span class="linenos"> 936</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Store.SendStoreConfirmation.run-937"><a href="#Store.SendStoreConfirmation.run-937"><span class="linenos"> 937</span></a><span class="sd">                - **Phase**: Result Notification - Award</span>
</span><span id="Store.SendStoreConfirmation.run-938"><a href="#Store.SendStoreConfirmation.run-938"><span class="linenos"> 938</span></a><span class="sd">                - **Performative**: store-confirm (FIPA accept-proposal)</span>
</span><span id="Store.SendStoreConfirmation.run-939"><a href="#Store.SendStoreConfirmation.run-939"><span class="linenos"> 939</span></a><span class="sd">                - **Meaning**: &quot;Your proposal is accepted, prepare the order&quot;</span>
</span><span id="Store.SendStoreConfirmation.run-940"><a href="#Store.SendStoreConfirmation.run-940"><span class="linenos"> 940</span></a><span class="sd">                - **Expected Response**: Warehouse assigns vehicle for delivery</span>
</span><span id="Store.SendStoreConfirmation.run-941"><a href="#Store.SendStoreConfirmation.run-941"><span class="linenos"> 941</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation.run-942"><a href="#Store.SendStoreConfirmation.run-942"><span class="linenos"> 942</span></a><span class="sd">            Important Design Decision:</span>
</span><span id="Store.SendStoreConfirmation.run-943"><a href="#Store.SendStoreConfirmation.run-943"><span class="linenos"> 943</span></a><span class="sd">                Stock is NOT updated immediately upon confirmation. Stock updates occur</span>
</span><span id="Store.SendStoreConfirmation.run-944"><a href="#Store.SendStoreConfirmation.run-944"><span class="linenos"> 944</span></a><span class="sd">                only when the vehicle delivers the products (vehicle-delivery message).</span>
</span><span id="Store.SendStoreConfirmation.run-945"><a href="#Store.SendStoreConfirmation.run-945"><span class="linenos"> 945</span></a><span class="sd">                This accurately models real-world logistics where confirmation  possession.</span>
</span><span id="Store.SendStoreConfirmation.run-946"><a href="#Store.SendStoreConfirmation.run-946"><span class="linenos"> 946</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation.run-947"><a href="#Store.SendStoreConfirmation.run-947"><span class="linenos"> 947</span></a><span class="sd">            Workflow:</span>
</span><span id="Store.SendStoreConfirmation.run-948"><a href="#Store.SendStoreConfirmation.run-948"><span class="linenos"> 948</span></a><span class="sd">                1. **Order Conversion**: Convert warehouse-accept message to Order object</span>
</span><span id="Store.SendStoreConfirmation.run-949"><a href="#Store.SendStoreConfirmation.run-949"><span class="linenos"> 949</span></a><span class="sd">                    - Extracts: product, quantity, orderid, sender, receiver, locations</span>
</span><span id="Store.SendStoreConfirmation.run-950"><a href="#Store.SendStoreConfirmation.run-950"><span class="linenos"> 950</span></a><span class="sd">                    - Uses message_to_order() helper method</span>
</span><span id="Store.SendStoreConfirmation.run-951"><a href="#Store.SendStoreConfirmation.run-951"><span class="linenos"> 951</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreConfirmation.run-952"><a href="#Store.SendStoreConfirmation.run-952"><span class="linenos"> 952</span></a><span class="sd">                2. **Order Registration**: Add to pending_deliveries dict</span>
</span><span id="Store.SendStoreConfirmation.run-953"><a href="#Store.SendStoreConfirmation.run-953"><span class="linenos"> 953</span></a><span class="sd">                    - Key: order.orderid (unique request ID)</span>
</span><span id="Store.SendStoreConfirmation.run-954"><a href="#Store.SendStoreConfirmation.run-954"><span class="linenos"> 954</span></a><span class="sd">                    - Value: Order object with full details</span>
</span><span id="Store.SendStoreConfirmation.run-955"><a href="#Store.SendStoreConfirmation.run-955"><span class="linenos"> 955</span></a><span class="sd">                    - Purpose: Track orders awaiting vehicle delivery</span>
</span><span id="Store.SendStoreConfirmation.run-956"><a href="#Store.SendStoreConfirmation.run-956"><span class="linenos"> 956</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreConfirmation.run-957"><a href="#Store.SendStoreConfirmation.run-957"><span class="linenos"> 957</span></a><span class="sd">                3. **Timing Record**: Store current tick in order_timings</span>
</span><span id="Store.SendStoreConfirmation.run-958"><a href="#Store.SendStoreConfirmation.run-958"><span class="linenos"> 958</span></a><span class="sd">                    - Key: order.orderid</span>
</span><span id="Store.SendStoreConfirmation.run-959"><a href="#Store.SendStoreConfirmation.run-959"><span class="linenos"> 959</span></a><span class="sd">                    - Value: agent.current_tick (simulation time)</span>
</span><span id="Store.SendStoreConfirmation.run-960"><a href="#Store.SendStoreConfirmation.run-960"><span class="linenos"> 960</span></a><span class="sd">                    - Purpose: Calculate time-to-delivery for statistics</span>
</span><span id="Store.SendStoreConfirmation.run-961"><a href="#Store.SendStoreConfirmation.run-961"><span class="linenos"> 961</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreConfirmation.run-962"><a href="#Store.SendStoreConfirmation.run-962"><span class="linenos"> 962</span></a><span class="sd">                4. **Message Construction**: Build store-confirm message</span>
</span><span id="Store.SendStoreConfirmation.run-963"><a href="#Store.SendStoreConfirmation.run-963"><span class="linenos"> 963</span></a><span class="sd">                    - Performative: store-confirm (FIPA accept-proposal)</span>
</span><span id="Store.SendStoreConfirmation.run-964"><a href="#Store.SendStoreConfirmation.run-964"><span class="linenos"> 964</span></a><span class="sd">                    - Metadata: warehouse_id, store_id, node_id, request_id</span>
</span><span id="Store.SendStoreConfirmation.run-965"><a href="#Store.SendStoreConfirmation.run-965"><span class="linenos"> 965</span></a><span class="sd">                    - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.SendStoreConfirmation.run-966"><a href="#Store.SendStoreConfirmation.run-966"><span class="linenos"> 966</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreConfirmation.run-967"><a href="#Store.SendStoreConfirmation.run-967"><span class="linenos"> 967</span></a><span class="sd">                5. **Message Transmission**: Send confirmation to warehouse</span>
</span><span id="Store.SendStoreConfirmation.run-968"><a href="#Store.SendStoreConfirmation.run-968"><span class="linenos"> 968</span></a><span class="sd">                    - Triggers warehouse to assign vehicle</span>
</span><span id="Store.SendStoreConfirmation.run-969"><a href="#Store.SendStoreConfirmation.run-969"><span class="linenos"> 969</span></a><span class="sd">                    - Initiates delivery logistics process</span>
</span><span id="Store.SendStoreConfirmation.run-970"><a href="#Store.SendStoreConfirmation.run-970"><span class="linenos"> 970</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreConfirmation.run-971"><a href="#Store.SendStoreConfirmation.run-971"><span class="linenos"> 971</span></a><span class="sd">                6. **Status Logging**: Print confirmation details</span>
</span><span id="Store.SendStoreConfirmation.run-972"><a href="#Store.SendStoreConfirmation.run-972"><span class="linenos"> 972</span></a><span class="sd">                    - Verbose message: Confirmation sent details</span>
</span><span id="Store.SendStoreConfirmation.run-973"><a href="#Store.SendStoreConfirmation.run-973"><span class="linenos"> 973</span></a><span class="sd">                    - Essential message: Order success with order ID</span>
</span><span id="Store.SendStoreConfirmation.run-974"><a href="#Store.SendStoreConfirmation.run-974"><span class="linenos"> 974</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation.run-975"><a href="#Store.SendStoreConfirmation.run-975"><span class="linenos"> 975</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.SendStoreConfirmation.run-976"><a href="#Store.SendStoreConfirmation.run-976"><span class="linenos"> 976</span></a><span class="sd">                - Modifies agent.pending_deliveries (adds order)</span>
</span><span id="Store.SendStoreConfirmation.run-977"><a href="#Store.SendStoreConfirmation.run-977"><span class="linenos"> 977</span></a><span class="sd">                - Modifies agent.order_timings (records timestamp)</span>
</span><span id="Store.SendStoreConfirmation.run-978"><a href="#Store.SendStoreConfirmation.run-978"><span class="linenos"> 978</span></a><span class="sd">                - Sends SPADE message to warehouse</span>
</span><span id="Store.SendStoreConfirmation.run-979"><a href="#Store.SendStoreConfirmation.run-979"><span class="linenos"> 979</span></a><span class="sd">                - Prints status information to console</span>
</span><span id="Store.SendStoreConfirmation.run-980"><a href="#Store.SendStoreConfirmation.run-980"><span class="linenos"> 980</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation.run-981"><a href="#Store.SendStoreConfirmation.run-981"><span class="linenos"> 981</span></a><span class="sd">            Returns:</span>
</span><span id="Store.SendStoreConfirmation.run-982"><a href="#Store.SendStoreConfirmation.run-982"><span class="linenos"> 982</span></a><span class="sd">                None. Completes when confirmation message is sent.</span>
</span><span id="Store.SendStoreConfirmation.run-983"><a href="#Store.SendStoreConfirmation.run-983"><span class="linenos"> 983</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation.run-984"><a href="#Store.SendStoreConfirmation.run-984"><span class="linenos"> 984</span></a><span class="sd">            Example Execution:</span>
</span><span id="Store.SendStoreConfirmation.run-985"><a href="#Store.SendStoreConfirmation.run-985"><span class="linenos"> 985</span></a><span class="sd">                ```</span>
</span><span id="Store.SendStoreConfirmation.run-986"><a href="#Store.SendStoreConfirmation.run-986"><span class="linenos"> 986</span></a><span class="sd">                Input: warehouse-accept from warehouse2</span>
</span><span id="Store.SendStoreConfirmation.run-987"><a href="#Store.SendStoreConfirmation.run-987"><span class="linenos"> 987</span></a><span class="sd">                    Body: &quot;50 electronics&quot;</span>
</span><span id="Store.SendStoreConfirmation.run-988"><a href="#Store.SendStoreConfirmation.run-988"><span class="linenos"> 988</span></a><span class="sd">                    request_id: 1001000000</span>
</span><span id="Store.SendStoreConfirmation.run-989"><a href="#Store.SendStoreConfirmation.run-989"><span class="linenos"> 989</span></a><span class="sd">                Processing:</span>
</span><span id="Store.SendStoreConfirmation.run-990"><a href="#Store.SendStoreConfirmation.run-990"><span class="linenos"> 990</span></a><span class="sd">                    - Create Order(orderid=1001000000, quantity=50, product=&quot;electronics&quot;)</span>
</span><span id="Store.SendStoreConfirmation.run-991"><a href="#Store.SendStoreConfirmation.run-991"><span class="linenos"> 991</span></a><span class="sd">                    - pending_deliveries[1001000000] = Order(...)</span>
</span><span id="Store.SendStoreConfirmation.run-992"><a href="#Store.SendStoreConfirmation.run-992"><span class="linenos"> 992</span></a><span class="sd">                    - order_timings[1001000000] = 42 (current tick)</span>
</span><span id="Store.SendStoreConfirmation.run-993"><a href="#Store.SendStoreConfirmation.run-993"><span class="linenos"> 993</span></a><span class="sd">                Output:</span>
</span><span id="Store.SendStoreConfirmation.run-994"><a href="#Store.SendStoreConfirmation.run-994"><span class="linenos"> 994</span></a><span class="sd">                    - Send store-confirm to warehouse2</span>
</span><span id="Store.SendStoreConfirmation.run-995"><a href="#Store.SendStoreConfirmation.run-995"><span class="linenos"> 995</span></a><span class="sd">                    - Print: &quot;Successfully bought 50 xelectronics from warehouse2 under order id 1001000000&quot;</span>
</span><span id="Store.SendStoreConfirmation.run-996"><a href="#Store.SendStoreConfirmation.run-996"><span class="linenos"> 996</span></a><span class="sd">                ```</span>
</span><span id="Store.SendStoreConfirmation.run-997"><a href="#Store.SendStoreConfirmation.run-997"><span class="linenos"> 997</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreConfirmation.run-998"><a href="#Store.SendStoreConfirmation.run-998"><span class="linenos"> 998</span></a><span class="sd">            Note:</span>
</span><span id="Store.SendStoreConfirmation.run-999"><a href="#Store.SendStoreConfirmation.run-999"><span class="linenos"> 999</span></a><span class="sd">                The order remains in pending_deliveries until ReceiveVehicleArrival</span>
</span><span id="Store.SendStoreConfirmation.run-1000"><a href="#Store.SendStoreConfirmation.run-1000"><span class="linenos">1000</span></a><span class="sd">                processes the vehicle-delivery message and updates stock. This maintains</span>
</span><span id="Store.SendStoreConfirmation.run-1001"><a href="#Store.SendStoreConfirmation.run-1001"><span class="linenos">1001</span></a><span class="sd">                separation between contract award and physical delivery.</span>
</span><span id="Store.SendStoreConfirmation.run-1002"><a href="#Store.SendStoreConfirmation.run-1002"><span class="linenos">1002</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.SendStoreConfirmation.run-1003"><a href="#Store.SendStoreConfirmation.run-1003"><span class="linenos">1003</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.SendStoreConfirmation.run-1004"><a href="#Store.SendStoreConfirmation.run-1004"><span class="linenos">1004</span></a>            
</span><span id="Store.SendStoreConfirmation.run-1005"><a href="#Store.SendStoreConfirmation.run-1005"><span class="linenos">1005</span></a>            <span class="c1"># Don&#39;t update stock here - wait for vehicle delivery</span>
</span><span id="Store.SendStoreConfirmation.run-1006"><a href="#Store.SendStoreConfirmation.run-1006"><span class="linenos">1006</span></a>            <span class="c1"># Stock will be updated when vehicle-delivery message is received</span>
</span><span id="Store.SendStoreConfirmation.run-1007"><a href="#Store.SendStoreConfirmation.run-1007"><span class="linenos">1007</span></a>            <span class="n">order</span> <span class="p">:</span> <span class="n">Order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">message_to_order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation.run-1008"><a href="#Store.SendStoreConfirmation.run-1008"><span class="linenos">1008</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
</span><span id="Store.SendStoreConfirmation.run-1009"><a href="#Store.SendStoreConfirmation.run-1009"><span class="linenos">1009</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">order_timings</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">current_tick</span>
</span><span id="Store.SendStoreConfirmation.run-1010"><a href="#Store.SendStoreConfirmation.run-1010"><span class="linenos">1010</span></a>            
</span><span id="Store.SendStoreConfirmation.run-1011"><a href="#Store.SendStoreConfirmation.run-1011"><span class="linenos">1011</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation.run-1012"><a href="#Store.SendStoreConfirmation.run-1012"><span class="linenos">1012</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-confirm&quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation.run-1013"><a href="#Store.SendStoreConfirmation.run-1013"><span class="linenos">1013</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="Store.SendStoreConfirmation.run-1014"><a href="#Store.SendStoreConfirmation.run-1014"><span class="linenos">1014</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store.SendStoreConfirmation.run-1015"><a href="#Store.SendStoreConfirmation.run-1015"><span class="linenos">1015</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Store.SendStoreConfirmation.run-1016"><a href="#Store.SendStoreConfirmation.run-1016"><span class="linenos">1016</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store.SendStoreConfirmation.run-1017"><a href="#Store.SendStoreConfirmation.run-1017"><span class="linenos">1017</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Store.SendStoreConfirmation.run-1018"><a href="#Store.SendStoreConfirmation.run-1018"><span class="linenos">1018</span></a>            
</span><span id="Store.SendStoreConfirmation.run-1019"><a href="#Store.SendStoreConfirmation.run-1019"><span class="linenos">1019</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation.run-1020"><a href="#Store.SendStoreConfirmation.run-1020"><span class="linenos">1020</span></a>            
</span><span id="Store.SendStoreConfirmation.run-1021"><a href="#Store.SendStoreConfirmation.run-1021"><span class="linenos">1021</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.SendStoreConfirmation.run-1022"><a href="#Store.SendStoreConfirmation.run-1022"><span class="linenos">1022</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Confirmation sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreConfirmation.run-1023"><a href="#Store.SendStoreConfirmation.run-1023"><span class="linenos">1023</span></a>            
</span><span id="Store.SendStoreConfirmation.run-1024"><a href="#Store.SendStoreConfirmation.run-1024"><span class="linenos">1024</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Successully bought </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> under order id </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Execute the confirmation sending process (FIPA accept-proposal).</p>

<p>This method sends the FIPA accept-proposal message to the winning warehouse,
registers the order as pending delivery, and records timing information for
statistics. It implements the award notification phase of the FIPA Contract
Net Protocol.</p>

<h6 id="fipa-protocol-implementation">FIPA Protocol Implementation:</h6>

<blockquote>
  <ul>
  <li><strong>Phase</strong>: Result Notification - Award</li>
  <li><strong>Performative</strong>: store-confirm (FIPA accept-proposal)</li>
  <li><strong>Meaning</strong>: "Your proposal is accepted, prepare the order"</li>
  <li><strong>Expected Response</strong>: Warehouse assigns vehicle for delivery</li>
  </ul>
</blockquote>

<h6 id="important-design-decision">Important Design Decision:</h6>

<blockquote>
  <p>Stock is NOT updated immediately upon confirmation. Stock updates occur
  only when the vehicle delivers the products (vehicle-delivery message).
  This accurately models real-world logistics where confirmation  possession.</p>
</blockquote>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><p><strong>Order Conversion</strong>: Convert warehouse-accept message to Order object</p>
  
  <ul>
  <li>Extracts: product, quantity, orderid, sender, receiver, locations</li>
  <li>Uses message_to_order() helper method</li>
  </ul></li>
  <li><p><strong>Order Registration</strong>: Add to pending_deliveries dict</p>
  
  <ul>
  <li>Key: order.orderid (unique request ID)</li>
  <li>Value: Order object with full details</li>
  <li>Purpose: Track orders awaiting vehicle delivery</li>
  </ul></li>
  <li><p><strong>Timing Record</strong>: Store current tick in order_timings</p>
  
  <ul>
  <li>Key: order.orderid</li>
  <li>Value: agent.current_tick (simulation time)</li>
  <li>Purpose: Calculate time-to-delivery for statistics</li>
  </ul></li>
  <li><p><strong>Message Construction</strong>: Build store-confirm message</p>
  
  <ul>
  <li>Performative: store-confirm (FIPA accept-proposal)</li>
  <li>Metadata: warehouse_id, store_id, node_id, request_id</li>
  <li>Body: "{quantity} {product}"</li>
  </ul></li>
  <li><p><strong>Message Transmission</strong>: Send confirmation to warehouse</p>
  
  <ul>
  <li>Triggers warehouse to assign vehicle</li>
  <li>Initiates delivery logistics process</li>
  </ul></li>
  <li><p><strong>Status Logging</strong>: Print confirmation details</p>
  
  <ul>
  <li>Verbose message: Confirmation sent details</li>
  <li>Essential message: Order success with order ID</li>
  </ul></li>
  </ol>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Modifies agent.pending_deliveries (adds order)</li>
  <li>Modifies agent.order_timings (records timestamp)</li>
  <li>Sends SPADE message to warehouse</li>
  <li>Prints status information to console</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Completes when confirmation message is sent.</p>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
<pre><code>Input: warehouse-accept from warehouse2
    Body: "50 electronics"
    request_id: 1001000000
Processing:
    - Create Order(orderid=1001000000, quantity=50, product="electronics")
    - pending_deliveries[1001000000] = Order(...)
    - order_timings[1001000000] = 42 (current tick)
Output:
    - Send store-confirm to warehouse2
    - Print: "Successfully bought 50 xelectronics from warehouse2 under order id 1001000000"
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>The order remains in pending_deliveries until ReceiveVehicleArrival
  processes the vehicle-delivery message and updates stock. This maintains
  separation between contract award and physical delivery.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Store.SendStoreDenial">
                            <input id="Store.SendStoreDenial-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Store.SendStoreDenial</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Store.SendStoreDenial-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.SendStoreDenial"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.SendStoreDenial-1026"><a href="#Store.SendStoreDenial-1026"><span class="linenos">1026</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SendStoreDenial</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Store.SendStoreDenial-1027"><a href="#Store.SendStoreDenial-1027"><span class="linenos">1027</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.SendStoreDenial-1028"><a href="#Store.SendStoreDenial-1028"><span class="linenos">1028</span></a><span class="sd">        Behaviour to send rejection to non-selected warehouses (FIPA reject-proposal).</span>
</span><span id="Store.SendStoreDenial-1029"><a href="#Store.SendStoreDenial-1029"><span class="linenos">1029</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreDenial-1030"><a href="#Store.SendStoreDenial-1030"><span class="linenos">1030</span></a><span class="sd">        This behaviour implements the rejection notification phase of the FIPA Contract</span>
</span><span id="Store.SendStoreDenial-1031"><a href="#Store.SendStoreDenial-1031"><span class="linenos">1031</span></a><span class="sd">        Net Protocol, informing warehouses that submitted proposals that their bids were</span>
</span><span id="Store.SendStoreDenial-1032"><a href="#Store.SendStoreDenial-1032"><span class="linenos">1032</span></a><span class="sd">        not selected. This is an essential part of the protocol, providing feedback to</span>
</span><span id="Store.SendStoreDenial-1033"><a href="#Store.SendStoreDenial-1033"><span class="linenos">1033</span></a><span class="sd">        all participants about the outcome of the negotiation.</span>
</span><span id="Store.SendStoreDenial-1034"><a href="#Store.SendStoreDenial-1034"><span class="linenos">1034</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreDenial-1035"><a href="#Store.SendStoreDenial-1035"><span class="linenos">1035</span></a><span class="sd">        FIPA Protocol Phase: **Result Notification - Rejection**</span>
</span><span id="Store.SendStoreDenial-1036"><a href="#Store.SendStoreDenial-1036"><span class="linenos">1036</span></a><span class="sd">            - Performative: store-deny (FIPA reject-proposal)</span>
</span><span id="Store.SendStoreDenial-1037"><a href="#Store.SendStoreDenial-1037"><span class="linenos">1037</span></a><span class="sd">            - Recipients: Warehouses that proposed but were not selected</span>
</span><span id="Store.SendStoreDenial-1038"><a href="#Store.SendStoreDenial-1038"><span class="linenos">1038</span></a><span class="sd">            - Purpose: Inform participants their proposal was rejected</span>
</span><span id="Store.SendStoreDenial-1039"><a href="#Store.SendStoreDenial-1039"><span class="linenos">1039</span></a><span class="sd">            - Protocol: FIPA Contract Net Protocol</span>
</span><span id="Store.SendStoreDenial-1040"><a href="#Store.SendStoreDenial-1040"><span class="linenos">1040</span></a><span class="sd">            - Note: Warehouses that refused (warehouse-reject) do NOT receive this</span>
</span><span id="Store.SendStoreDenial-1041"><a href="#Store.SendStoreDenial-1041"><span class="linenos">1041</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreDenial-1042"><a href="#Store.SendStoreDenial-1042"><span class="linenos">1042</span></a><span class="sd">        This message allows warehouses to release any resources they may have reserved</span>
</span><span id="Store.SendStoreDenial-1043"><a href="#Store.SendStoreDenial-1043"><span class="linenos">1043</span></a><span class="sd">        for this order and update their internal state accordingly.</span>
</span><span id="Store.SendStoreDenial-1044"><a href="#Store.SendStoreDenial-1044"><span class="linenos">1044</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreDenial-1045"><a href="#Store.SendStoreDenial-1045"><span class="linenos">1045</span></a><span class="sd">        Attributes:</span>
</span><span id="Store.SendStoreDenial-1046"><a href="#Store.SendStoreDenial-1046"><span class="linenos">1046</span></a><span class="sd">            dest (str): Warehouse JID (non-selected participant&#39;s address).</span>
</span><span id="Store.SendStoreDenial-1047"><a href="#Store.SendStoreDenial-1047"><span class="linenos">1047</span></a><span class="sd">            request_id (str): Unique request identifier from original CFP.</span>
</span><span id="Store.SendStoreDenial-1048"><a href="#Store.SendStoreDenial-1048"><span class="linenos">1048</span></a><span class="sd">            quantity (int): Quantity of product in the rejected order.</span>
</span><span id="Store.SendStoreDenial-1049"><a href="#Store.SendStoreDenial-1049"><span class="linenos">1049</span></a><span class="sd">            product (str): Name of product in the rejected order.</span>
</span><span id="Store.SendStoreDenial-1050"><a href="#Store.SendStoreDenial-1050"><span class="linenos">1050</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreDenial-1051"><a href="#Store.SendStoreDenial-1051"><span class="linenos">1051</span></a><span class="sd">        Message Format (FIPA reject-proposal):</span>
</span><span id="Store.SendStoreDenial-1052"><a href="#Store.SendStoreDenial-1052"><span class="linenos">1052</span></a><span class="sd">            Metadata:</span>
</span><span id="Store.SendStoreDenial-1053"><a href="#Store.SendStoreDenial-1053"><span class="linenos">1053</span></a><span class="sd">                - performative: &quot;store-deny&quot; (FIPA reject-proposal)</span>
</span><span id="Store.SendStoreDenial-1054"><a href="#Store.SendStoreDenial-1054"><span class="linenos">1054</span></a><span class="sd">                - warehouse_id: Destination warehouse JID</span>
</span><span id="Store.SendStoreDenial-1055"><a href="#Store.SendStoreDenial-1055"><span class="linenos">1055</span></a><span class="sd">                - store_id: This store&#39;s JID</span>
</span><span id="Store.SendStoreDenial-1056"><a href="#Store.SendStoreDenial-1056"><span class="linenos">1056</span></a><span class="sd">                - node_id: This store&#39;s graph location</span>
</span><span id="Store.SendStoreDenial-1057"><a href="#Store.SendStoreDenial-1057"><span class="linenos">1057</span></a><span class="sd">                - request_id: Original CFP request identifier</span>
</span><span id="Store.SendStoreDenial-1058"><a href="#Store.SendStoreDenial-1058"><span class="linenos">1058</span></a><span class="sd">            Body:</span>
</span><span id="Store.SendStoreDenial-1059"><a href="#Store.SendStoreDenial-1059"><span class="linenos">1059</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.SendStoreDenial-1060"><a href="#Store.SendStoreDenial-1060"><span class="linenos">1060</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="Store.SendStoreDenial-1061"><a href="#Store.SendStoreDenial-1061"><span class="linenos">1061</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreDenial-1062"><a href="#Store.SendStoreDenial-1062"><span class="linenos">1062</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store.SendStoreDenial-1063"><a href="#Store.SendStoreDenial-1063"><span class="linenos">1063</span></a><span class="sd">            - Sends store-deny message to warehouse</span>
</span><span id="Store.SendStoreDenial-1064"><a href="#Store.SendStoreDenial-1064"><span class="linenos">1064</span></a><span class="sd">            - Prints denial confirmation (verbose mode only)</span>
</span><span id="Store.SendStoreDenial-1065"><a href="#Store.SendStoreDenial-1065"><span class="linenos">1065</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreDenial-1066"><a href="#Store.SendStoreDenial-1066"><span class="linenos">1066</span></a><span class="sd">        Example:</span>
</span><span id="Store.SendStoreDenial-1067"><a href="#Store.SendStoreDenial-1067"><span class="linenos">1067</span></a><span class="sd">            ```</span>
</span><span id="Store.SendStoreDenial-1068"><a href="#Store.SendStoreDenial-1068"><span class="linenos">1068</span></a><span class="sd">            Scenario: 3 warehouses proposed, warehouse2 won</span>
</span><span id="Store.SendStoreDenial-1069"><a href="#Store.SendStoreDenial-1069"><span class="linenos">1069</span></a><span class="sd">            Recipients: warehouse1, warehouse3 (both receive store-deny)</span>
</span><span id="Store.SendStoreDenial-1070"><a href="#Store.SendStoreDenial-1070"><span class="linenos">1070</span></a><span class="sd">            Message: &quot;50 electronics&quot;</span>
</span><span id="Store.SendStoreDenial-1071"><a href="#Store.SendStoreDenial-1071"><span class="linenos">1071</span></a><span class="sd">            Result: warehouse1 and warehouse3 know they were not selected</span>
</span><span id="Store.SendStoreDenial-1072"><a href="#Store.SendStoreDenial-1072"><span class="linenos">1072</span></a><span class="sd">            ```</span>
</span><span id="Store.SendStoreDenial-1073"><a href="#Store.SendStoreDenial-1073"><span class="linenos">1073</span></a><span class="sd">        </span>
</span><span id="Store.SendStoreDenial-1074"><a href="#Store.SendStoreDenial-1074"><span class="linenos">1074</span></a><span class="sd">        Note:</span>
</span><span id="Store.SendStoreDenial-1075"><a href="#Store.SendStoreDenial-1075"><span class="linenos">1075</span></a><span class="sd">            This notification is important for warehouses to maintain accurate internal</span>
</span><span id="Store.SendStoreDenial-1076"><a href="#Store.SendStoreDenial-1076"><span class="linenos">1076</span></a><span class="sd">            state and avoid waiting indefinitely for a confirmation that will never come.</span>
</span><span id="Store.SendStoreDenial-1077"><a href="#Store.SendStoreDenial-1077"><span class="linenos">1077</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.SendStoreDenial-1078"><a href="#Store.SendStoreDenial-1078"><span class="linenos">1078</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Store.SendStoreDenial-1079"><a href="#Store.SendStoreDenial-1079"><span class="linenos">1079</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.SendStoreDenial-1080"><a href="#Store.SendStoreDenial-1080"><span class="linenos">1080</span></a><span class="sd">            Initialize the SendStoreDenial behaviour.</span>
</span><span id="Store.SendStoreDenial-1081"><a href="#Store.SendStoreDenial-1081"><span class="linenos">1081</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial-1082"><a href="#Store.SendStoreDenial-1082"><span class="linenos">1082</span></a><span class="sd">            Args:</span>
</span><span id="Store.SendStoreDenial-1083"><a href="#Store.SendStoreDenial-1083"><span class="linenos">1083</span></a><span class="sd">                msg (Message): The warehouse-accept message from the non-selected warehouse.</span>
</span><span id="Store.SendStoreDenial-1084"><a href="#Store.SendStoreDenial-1084"><span class="linenos">1084</span></a><span class="sd">                    Contains sender information and order details needed for rejection message.</span>
</span><span id="Store.SendStoreDenial-1085"><a href="#Store.SendStoreDenial-1085"><span class="linenos">1085</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial-1086"><a href="#Store.SendStoreDenial-1086"><span class="linenos">1086</span></a><span class="sd">            Note:</span>
</span><span id="Store.SendStoreDenial-1087"><a href="#Store.SendStoreDenial-1087"><span class="linenos">1087</span></a><span class="sd">                Extracts only the essential fields needed to construct the rejection.</span>
</span><span id="Store.SendStoreDenial-1088"><a href="#Store.SendStoreDenial-1088"><span class="linenos">1088</span></a><span class="sd">                Unlike SendStoreConfirmation, this doesn&#39;t need to create an Order object.</span>
</span><span id="Store.SendStoreDenial-1089"><a href="#Store.SendStoreDenial-1089"><span class="linenos">1089</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.SendStoreDenial-1090"><a href="#Store.SendStoreDenial-1090"><span class="linenos">1090</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Store.SendStoreDenial-1091"><a href="#Store.SendStoreDenial-1091"><span class="linenos">1091</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Store.SendStoreDenial-1092"><a href="#Store.SendStoreDenial-1092"><span class="linenos">1092</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreDenial-1093"><a href="#Store.SendStoreDenial-1093"><span class="linenos">1093</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreDenial-1094"><a href="#Store.SendStoreDenial-1094"><span class="linenos">1094</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store.SendStoreDenial-1095"><a href="#Store.SendStoreDenial-1095"><span class="linenos">1095</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store.SendStoreDenial-1096"><a href="#Store.SendStoreDenial-1096"><span class="linenos">1096</span></a>        
</span><span id="Store.SendStoreDenial-1097"><a href="#Store.SendStoreDenial-1097"><span class="linenos">1097</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.SendStoreDenial-1098"><a href="#Store.SendStoreDenial-1098"><span class="linenos">1098</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.SendStoreDenial-1099"><a href="#Store.SendStoreDenial-1099"><span class="linenos">1099</span></a><span class="sd">            Execute the rejection sending process (FIPA reject-proposal).</span>
</span><span id="Store.SendStoreDenial-1100"><a href="#Store.SendStoreDenial-1100"><span class="linenos">1100</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial-1101"><a href="#Store.SendStoreDenial-1101"><span class="linenos">1101</span></a><span class="sd">            This method sends the FIPA reject-proposal message to non-selected warehouses,</span>
</span><span id="Store.SendStoreDenial-1102"><a href="#Store.SendStoreDenial-1102"><span class="linenos">1102</span></a><span class="sd">            completing the result notification phase of the FIPA Contract Net Protocol.</span>
</span><span id="Store.SendStoreDenial-1103"><a href="#Store.SendStoreDenial-1103"><span class="linenos">1103</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial-1104"><a href="#Store.SendStoreDenial-1104"><span class="linenos">1104</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Store.SendStoreDenial-1105"><a href="#Store.SendStoreDenial-1105"><span class="linenos">1105</span></a><span class="sd">                - **Phase**: Result Notification - Rejection</span>
</span><span id="Store.SendStoreDenial-1106"><a href="#Store.SendStoreDenial-1106"><span class="linenos">1106</span></a><span class="sd">                - **Performative**: store-deny (FIPA reject-proposal)</span>
</span><span id="Store.SendStoreDenial-1107"><a href="#Store.SendStoreDenial-1107"><span class="linenos">1107</span></a><span class="sd">                - **Meaning**: &quot;Your proposal was not selected&quot;</span>
</span><span id="Store.SendStoreDenial-1108"><a href="#Store.SendStoreDenial-1108"><span class="linenos">1108</span></a><span class="sd">                - **Expected Response**: Warehouse releases resources, updates state</span>
</span><span id="Store.SendStoreDenial-1109"><a href="#Store.SendStoreDenial-1109"><span class="linenos">1109</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial-1110"><a href="#Store.SendStoreDenial-1110"><span class="linenos">1110</span></a><span class="sd">            Workflow:</span>
</span><span id="Store.SendStoreDenial-1111"><a href="#Store.SendStoreDenial-1111"><span class="linenos">1111</span></a><span class="sd">                1. **Message Construction**: Build store-deny message</span>
</span><span id="Store.SendStoreDenial-1112"><a href="#Store.SendStoreDenial-1112"><span class="linenos">1112</span></a><span class="sd">                    - Performative: store-deny (FIPA reject-proposal)</span>
</span><span id="Store.SendStoreDenial-1113"><a href="#Store.SendStoreDenial-1113"><span class="linenos">1113</span></a><span class="sd">                    - Metadata: warehouse_id, store_id, node_id, request_id</span>
</span><span id="Store.SendStoreDenial-1114"><a href="#Store.SendStoreDenial-1114"><span class="linenos">1114</span></a><span class="sd">                    - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.SendStoreDenial-1115"><a href="#Store.SendStoreDenial-1115"><span class="linenos">1115</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreDenial-1116"><a href="#Store.SendStoreDenial-1116"><span class="linenos">1116</span></a><span class="sd">                2. **Message Transmission**: Send rejection to warehouse</span>
</span><span id="Store.SendStoreDenial-1117"><a href="#Store.SendStoreDenial-1117"><span class="linenos">1117</span></a><span class="sd">                    - Notifies warehouse of negative outcome</span>
</span><span id="Store.SendStoreDenial-1118"><a href="#Store.SendStoreDenial-1118"><span class="linenos">1118</span></a><span class="sd">                    - Allows warehouse to handle rejection gracefully</span>
</span><span id="Store.SendStoreDenial-1119"><a href="#Store.SendStoreDenial-1119"><span class="linenos">1119</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreDenial-1120"><a href="#Store.SendStoreDenial-1120"><span class="linenos">1120</span></a><span class="sd">                3. **Status Logging**: Print denial confirmation (verbose only)</span>
</span><span id="Store.SendStoreDenial-1121"><a href="#Store.SendStoreDenial-1121"><span class="linenos">1121</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial-1122"><a href="#Store.SendStoreDenial-1122"><span class="linenos">1122</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.SendStoreDenial-1123"><a href="#Store.SendStoreDenial-1123"><span class="linenos">1123</span></a><span class="sd">                - Sends SPADE message to warehouse</span>
</span><span id="Store.SendStoreDenial-1124"><a href="#Store.SendStoreDenial-1124"><span class="linenos">1124</span></a><span class="sd">                - Prints status information if verbose mode enabled</span>
</span><span id="Store.SendStoreDenial-1125"><a href="#Store.SendStoreDenial-1125"><span class="linenos">1125</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial-1126"><a href="#Store.SendStoreDenial-1126"><span class="linenos">1126</span></a><span class="sd">            Returns:</span>
</span><span id="Store.SendStoreDenial-1127"><a href="#Store.SendStoreDenial-1127"><span class="linenos">1127</span></a><span class="sd">                None. Completes when rejection message is sent.</span>
</span><span id="Store.SendStoreDenial-1128"><a href="#Store.SendStoreDenial-1128"><span class="linenos">1128</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial-1129"><a href="#Store.SendStoreDenial-1129"><span class="linenos">1129</span></a><span class="sd">            Example Execution:</span>
</span><span id="Store.SendStoreDenial-1130"><a href="#Store.SendStoreDenial-1130"><span class="linenos">1130</span></a><span class="sd">                ```</span>
</span><span id="Store.SendStoreDenial-1131"><a href="#Store.SendStoreDenial-1131"><span class="linenos">1131</span></a><span class="sd">                Input: warehouse-accept from warehouse1 (not selected)</span>
</span><span id="Store.SendStoreDenial-1132"><a href="#Store.SendStoreDenial-1132"><span class="linenos">1132</span></a><span class="sd">                    Body: &quot;50 electronics&quot;</span>
</span><span id="Store.SendStoreDenial-1133"><a href="#Store.SendStoreDenial-1133"><span class="linenos">1133</span></a><span class="sd">                    request_id: 1001000000</span>
</span><span id="Store.SendStoreDenial-1134"><a href="#Store.SendStoreDenial-1134"><span class="linenos">1134</span></a><span class="sd">                Processing:</span>
</span><span id="Store.SendStoreDenial-1135"><a href="#Store.SendStoreDenial-1135"><span class="linenos">1135</span></a><span class="sd">                    - Create store-deny message</span>
</span><span id="Store.SendStoreDenial-1136"><a href="#Store.SendStoreDenial-1136"><span class="linenos">1136</span></a><span class="sd">                    - Set metadata and body</span>
</span><span id="Store.SendStoreDenial-1137"><a href="#Store.SendStoreDenial-1137"><span class="linenos">1137</span></a><span class="sd">                Output:</span>
</span><span id="Store.SendStoreDenial-1138"><a href="#Store.SendStoreDenial-1138"><span class="linenos">1138</span></a><span class="sd">                    - Send store-deny to warehouse1</span>
</span><span id="Store.SendStoreDenial-1139"><a href="#Store.SendStoreDenial-1139"><span class="linenos">1139</span></a><span class="sd">                    - Print (if verbose): &quot;Denial sent to warehouse1 for request: 50 electronics&quot;</span>
</span><span id="Store.SendStoreDenial-1140"><a href="#Store.SendStoreDenial-1140"><span class="linenos">1140</span></a><span class="sd">                ```</span>
</span><span id="Store.SendStoreDenial-1141"><a href="#Store.SendStoreDenial-1141"><span class="linenos">1141</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.SendStoreDenial-1142"><a href="#Store.SendStoreDenial-1142"><span class="linenos">1142</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.SendStoreDenial-1143"><a href="#Store.SendStoreDenial-1143"><span class="linenos">1143</span></a>            
</span><span id="Store.SendStoreDenial-1144"><a href="#Store.SendStoreDenial-1144"><span class="linenos">1144</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="Store.SendStoreDenial-1145"><a href="#Store.SendStoreDenial-1145"><span class="linenos">1145</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-deny&quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreDenial-1146"><a href="#Store.SendStoreDenial-1146"><span class="linenos">1146</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="Store.SendStoreDenial-1147"><a href="#Store.SendStoreDenial-1147"><span class="linenos">1147</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store.SendStoreDenial-1148"><a href="#Store.SendStoreDenial-1148"><span class="linenos">1148</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Store.SendStoreDenial-1149"><a href="#Store.SendStoreDenial-1149"><span class="linenos">1149</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store.SendStoreDenial-1150"><a href="#Store.SendStoreDenial-1150"><span class="linenos">1150</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Store.SendStoreDenial-1151"><a href="#Store.SendStoreDenial-1151"><span class="linenos">1151</span></a>            
</span><span id="Store.SendStoreDenial-1152"><a href="#Store.SendStoreDenial-1152"><span class="linenos">1152</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.SendStoreDenial-1153"><a href="#Store.SendStoreDenial-1153"><span class="linenos">1153</span></a>            
</span><span id="Store.SendStoreDenial-1154"><a href="#Store.SendStoreDenial-1154"><span class="linenos">1154</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.SendStoreDenial-1155"><a href="#Store.SendStoreDenial-1155"><span class="linenos">1155</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Denial sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Behaviour to send rejection to non-selected warehouses (FIPA reject-proposal).</p>

<p>This behaviour implements the rejection notification phase of the FIPA Contract
Net Protocol, informing warehouses that submitted proposals that their bids were
not selected. This is an essential part of the protocol, providing feedback to
all participants about the outcome of the negotiation.</p>

<p>FIPA Protocol Phase: <strong>Result Notification - Rejection</strong>
    - Performative: store-deny (FIPA reject-proposal)
    - Recipients: Warehouses that proposed but were not selected
    - Purpose: Inform participants their proposal was rejected
    - Protocol: FIPA Contract Net Protocol
    - Note: Warehouses that refused (warehouse-reject) do NOT receive this</p>

<p>This message allows warehouses to release any resources they may have reserved
for this order and update their internal state accordingly.</p>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>dest (str):</strong>  Warehouse JID (non-selected participant's address).</li>
<li><strong>request_id (str):</strong>  Unique request identifier from original CFP.</li>
<li><strong>quantity (int):</strong>  Quantity of product in the rejected order.</li>
<li><strong>product (str):</strong>  Name of product in the rejected order.</li>
</ul>

<p>Message Format (FIPA reject-proposal):
    Metadata:
        - performative: "store-deny" (FIPA reject-proposal)
        - warehouse_id: Destination warehouse JID
        - store_id: This store's JID
        - node_id: This store's graph location
        - request_id: Original CFP request identifier
    Body:
        - Format: "{quantity} {product}"
        - Example: "50 electronics"</p>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Sends store-deny message to warehouse</li>
  <li>Prints denial confirmation (verbose mode only)</li>
  </ul>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
<pre><code>Scenario: 3 warehouses proposed, warehouse2 won
Recipients: warehouse1, warehouse3 (both receive store-deny)
Message: "50 electronics"
Result: warehouse1 and warehouse3 know they were not selected
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This notification is important for warehouses to maintain accurate internal
  state and avoid waiting indefinitely for a confirmation that will never come.</p>
</blockquote>
</div>


                            <div id="Store.SendStoreDenial.__init__" class="classattr">
                                        <input id="Store.SendStoreDenial.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Store.SendStoreDenial</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span></span>)</span>

                <label class="view-source-button" for="Store.SendStoreDenial.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.SendStoreDenial.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.SendStoreDenial.__init__-1078"><a href="#Store.SendStoreDenial.__init__-1078"><span class="linenos">1078</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Store.SendStoreDenial.__init__-1079"><a href="#Store.SendStoreDenial.__init__-1079"><span class="linenos">1079</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.SendStoreDenial.__init__-1080"><a href="#Store.SendStoreDenial.__init__-1080"><span class="linenos">1080</span></a><span class="sd">            Initialize the SendStoreDenial behaviour.</span>
</span><span id="Store.SendStoreDenial.__init__-1081"><a href="#Store.SendStoreDenial.__init__-1081"><span class="linenos">1081</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial.__init__-1082"><a href="#Store.SendStoreDenial.__init__-1082"><span class="linenos">1082</span></a><span class="sd">            Args:</span>
</span><span id="Store.SendStoreDenial.__init__-1083"><a href="#Store.SendStoreDenial.__init__-1083"><span class="linenos">1083</span></a><span class="sd">                msg (Message): The warehouse-accept message from the non-selected warehouse.</span>
</span><span id="Store.SendStoreDenial.__init__-1084"><a href="#Store.SendStoreDenial.__init__-1084"><span class="linenos">1084</span></a><span class="sd">                    Contains sender information and order details needed for rejection message.</span>
</span><span id="Store.SendStoreDenial.__init__-1085"><a href="#Store.SendStoreDenial.__init__-1085"><span class="linenos">1085</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial.__init__-1086"><a href="#Store.SendStoreDenial.__init__-1086"><span class="linenos">1086</span></a><span class="sd">            Note:</span>
</span><span id="Store.SendStoreDenial.__init__-1087"><a href="#Store.SendStoreDenial.__init__-1087"><span class="linenos">1087</span></a><span class="sd">                Extracts only the essential fields needed to construct the rejection.</span>
</span><span id="Store.SendStoreDenial.__init__-1088"><a href="#Store.SendStoreDenial.__init__-1088"><span class="linenos">1088</span></a><span class="sd">                Unlike SendStoreConfirmation, this doesn&#39;t need to create an Order object.</span>
</span><span id="Store.SendStoreDenial.__init__-1089"><a href="#Store.SendStoreDenial.__init__-1089"><span class="linenos">1089</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.SendStoreDenial.__init__-1090"><a href="#Store.SendStoreDenial.__init__-1090"><span class="linenos">1090</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Store.SendStoreDenial.__init__-1091"><a href="#Store.SendStoreDenial.__init__-1091"><span class="linenos">1091</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Store.SendStoreDenial.__init__-1092"><a href="#Store.SendStoreDenial.__init__-1092"><span class="linenos">1092</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreDenial.__init__-1093"><a href="#Store.SendStoreDenial.__init__-1093"><span class="linenos">1093</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreDenial.__init__-1094"><a href="#Store.SendStoreDenial.__init__-1094"><span class="linenos">1094</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store.SendStoreDenial.__init__-1095"><a href="#Store.SendStoreDenial.__init__-1095"><span class="linenos">1095</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the SendStoreDenial behaviour.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>msg (Message):</strong>  The warehouse-accept message from the non-selected warehouse.
Contains sender information and order details needed for rejection message.</li>
</ul>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Extracts only the essential fields needed to construct the rejection.
  Unlike SendStoreConfirmation, this doesn't need to create an Order object.</p>
</blockquote>
</div>


                            </div>
                            <div id="Store.SendStoreDenial.dest" class="classattr">
                                <div class="attr variable">
            <span class="name">dest</span>

        
    </div>
    <a class="headerlink" href="#Store.SendStoreDenial.dest"></a>
    
    

                            </div>
                            <div id="Store.SendStoreDenial.request_id" class="classattr">
                                <div class="attr variable">
            <span class="name">request_id</span>

        
    </div>
    <a class="headerlink" href="#Store.SendStoreDenial.request_id"></a>
    
    

                            </div>
                            <div id="Store.SendStoreDenial.quantity" class="classattr">
                                <div class="attr variable">
            <span class="name">quantity</span>

        
    </div>
    <a class="headerlink" href="#Store.SendStoreDenial.quantity"></a>
    
    

                            </div>
                            <div id="Store.SendStoreDenial.product" class="classattr">
                                <div class="attr variable">
            <span class="name">product</span>

        
    </div>
    <a class="headerlink" href="#Store.SendStoreDenial.product"></a>
    
    

                            </div>
                            <div id="Store.SendStoreDenial.run" class="classattr">
                                        <input id="Store.SendStoreDenial.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Store.SendStoreDenial.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.SendStoreDenial.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.SendStoreDenial.run-1097"><a href="#Store.SendStoreDenial.run-1097"><span class="linenos">1097</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.SendStoreDenial.run-1098"><a href="#Store.SendStoreDenial.run-1098"><span class="linenos">1098</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.SendStoreDenial.run-1099"><a href="#Store.SendStoreDenial.run-1099"><span class="linenos">1099</span></a><span class="sd">            Execute the rejection sending process (FIPA reject-proposal).</span>
</span><span id="Store.SendStoreDenial.run-1100"><a href="#Store.SendStoreDenial.run-1100"><span class="linenos">1100</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial.run-1101"><a href="#Store.SendStoreDenial.run-1101"><span class="linenos">1101</span></a><span class="sd">            This method sends the FIPA reject-proposal message to non-selected warehouses,</span>
</span><span id="Store.SendStoreDenial.run-1102"><a href="#Store.SendStoreDenial.run-1102"><span class="linenos">1102</span></a><span class="sd">            completing the result notification phase of the FIPA Contract Net Protocol.</span>
</span><span id="Store.SendStoreDenial.run-1103"><a href="#Store.SendStoreDenial.run-1103"><span class="linenos">1103</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial.run-1104"><a href="#Store.SendStoreDenial.run-1104"><span class="linenos">1104</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Store.SendStoreDenial.run-1105"><a href="#Store.SendStoreDenial.run-1105"><span class="linenos">1105</span></a><span class="sd">                - **Phase**: Result Notification - Rejection</span>
</span><span id="Store.SendStoreDenial.run-1106"><a href="#Store.SendStoreDenial.run-1106"><span class="linenos">1106</span></a><span class="sd">                - **Performative**: store-deny (FIPA reject-proposal)</span>
</span><span id="Store.SendStoreDenial.run-1107"><a href="#Store.SendStoreDenial.run-1107"><span class="linenos">1107</span></a><span class="sd">                - **Meaning**: &quot;Your proposal was not selected&quot;</span>
</span><span id="Store.SendStoreDenial.run-1108"><a href="#Store.SendStoreDenial.run-1108"><span class="linenos">1108</span></a><span class="sd">                - **Expected Response**: Warehouse releases resources, updates state</span>
</span><span id="Store.SendStoreDenial.run-1109"><a href="#Store.SendStoreDenial.run-1109"><span class="linenos">1109</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial.run-1110"><a href="#Store.SendStoreDenial.run-1110"><span class="linenos">1110</span></a><span class="sd">            Workflow:</span>
</span><span id="Store.SendStoreDenial.run-1111"><a href="#Store.SendStoreDenial.run-1111"><span class="linenos">1111</span></a><span class="sd">                1. **Message Construction**: Build store-deny message</span>
</span><span id="Store.SendStoreDenial.run-1112"><a href="#Store.SendStoreDenial.run-1112"><span class="linenos">1112</span></a><span class="sd">                    - Performative: store-deny (FIPA reject-proposal)</span>
</span><span id="Store.SendStoreDenial.run-1113"><a href="#Store.SendStoreDenial.run-1113"><span class="linenos">1113</span></a><span class="sd">                    - Metadata: warehouse_id, store_id, node_id, request_id</span>
</span><span id="Store.SendStoreDenial.run-1114"><a href="#Store.SendStoreDenial.run-1114"><span class="linenos">1114</span></a><span class="sd">                    - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="Store.SendStoreDenial.run-1115"><a href="#Store.SendStoreDenial.run-1115"><span class="linenos">1115</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreDenial.run-1116"><a href="#Store.SendStoreDenial.run-1116"><span class="linenos">1116</span></a><span class="sd">                2. **Message Transmission**: Send rejection to warehouse</span>
</span><span id="Store.SendStoreDenial.run-1117"><a href="#Store.SendStoreDenial.run-1117"><span class="linenos">1117</span></a><span class="sd">                    - Notifies warehouse of negative outcome</span>
</span><span id="Store.SendStoreDenial.run-1118"><a href="#Store.SendStoreDenial.run-1118"><span class="linenos">1118</span></a><span class="sd">                    - Allows warehouse to handle rejection gracefully</span>
</span><span id="Store.SendStoreDenial.run-1119"><a href="#Store.SendStoreDenial.run-1119"><span class="linenos">1119</span></a><span class="sd">                </span>
</span><span id="Store.SendStoreDenial.run-1120"><a href="#Store.SendStoreDenial.run-1120"><span class="linenos">1120</span></a><span class="sd">                3. **Status Logging**: Print denial confirmation (verbose only)</span>
</span><span id="Store.SendStoreDenial.run-1121"><a href="#Store.SendStoreDenial.run-1121"><span class="linenos">1121</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial.run-1122"><a href="#Store.SendStoreDenial.run-1122"><span class="linenos">1122</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.SendStoreDenial.run-1123"><a href="#Store.SendStoreDenial.run-1123"><span class="linenos">1123</span></a><span class="sd">                - Sends SPADE message to warehouse</span>
</span><span id="Store.SendStoreDenial.run-1124"><a href="#Store.SendStoreDenial.run-1124"><span class="linenos">1124</span></a><span class="sd">                - Prints status information if verbose mode enabled</span>
</span><span id="Store.SendStoreDenial.run-1125"><a href="#Store.SendStoreDenial.run-1125"><span class="linenos">1125</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial.run-1126"><a href="#Store.SendStoreDenial.run-1126"><span class="linenos">1126</span></a><span class="sd">            Returns:</span>
</span><span id="Store.SendStoreDenial.run-1127"><a href="#Store.SendStoreDenial.run-1127"><span class="linenos">1127</span></a><span class="sd">                None. Completes when rejection message is sent.</span>
</span><span id="Store.SendStoreDenial.run-1128"><a href="#Store.SendStoreDenial.run-1128"><span class="linenos">1128</span></a><span class="sd">            </span>
</span><span id="Store.SendStoreDenial.run-1129"><a href="#Store.SendStoreDenial.run-1129"><span class="linenos">1129</span></a><span class="sd">            Example Execution:</span>
</span><span id="Store.SendStoreDenial.run-1130"><a href="#Store.SendStoreDenial.run-1130"><span class="linenos">1130</span></a><span class="sd">                ```</span>
</span><span id="Store.SendStoreDenial.run-1131"><a href="#Store.SendStoreDenial.run-1131"><span class="linenos">1131</span></a><span class="sd">                Input: warehouse-accept from warehouse1 (not selected)</span>
</span><span id="Store.SendStoreDenial.run-1132"><a href="#Store.SendStoreDenial.run-1132"><span class="linenos">1132</span></a><span class="sd">                    Body: &quot;50 electronics&quot;</span>
</span><span id="Store.SendStoreDenial.run-1133"><a href="#Store.SendStoreDenial.run-1133"><span class="linenos">1133</span></a><span class="sd">                    request_id: 1001000000</span>
</span><span id="Store.SendStoreDenial.run-1134"><a href="#Store.SendStoreDenial.run-1134"><span class="linenos">1134</span></a><span class="sd">                Processing:</span>
</span><span id="Store.SendStoreDenial.run-1135"><a href="#Store.SendStoreDenial.run-1135"><span class="linenos">1135</span></a><span class="sd">                    - Create store-deny message</span>
</span><span id="Store.SendStoreDenial.run-1136"><a href="#Store.SendStoreDenial.run-1136"><span class="linenos">1136</span></a><span class="sd">                    - Set metadata and body</span>
</span><span id="Store.SendStoreDenial.run-1137"><a href="#Store.SendStoreDenial.run-1137"><span class="linenos">1137</span></a><span class="sd">                Output:</span>
</span><span id="Store.SendStoreDenial.run-1138"><a href="#Store.SendStoreDenial.run-1138"><span class="linenos">1138</span></a><span class="sd">                    - Send store-deny to warehouse1</span>
</span><span id="Store.SendStoreDenial.run-1139"><a href="#Store.SendStoreDenial.run-1139"><span class="linenos">1139</span></a><span class="sd">                    - Print (if verbose): &quot;Denial sent to warehouse1 for request: 50 electronics&quot;</span>
</span><span id="Store.SendStoreDenial.run-1140"><a href="#Store.SendStoreDenial.run-1140"><span class="linenos">1140</span></a><span class="sd">                ```</span>
</span><span id="Store.SendStoreDenial.run-1141"><a href="#Store.SendStoreDenial.run-1141"><span class="linenos">1141</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.SendStoreDenial.run-1142"><a href="#Store.SendStoreDenial.run-1142"><span class="linenos">1142</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.SendStoreDenial.run-1143"><a href="#Store.SendStoreDenial.run-1143"><span class="linenos">1143</span></a>            
</span><span id="Store.SendStoreDenial.run-1144"><a href="#Store.SendStoreDenial.run-1144"><span class="linenos">1144</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="Store.SendStoreDenial.run-1145"><a href="#Store.SendStoreDenial.run-1145"><span class="linenos">1145</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-deny&quot;</span><span class="p">)</span>
</span><span id="Store.SendStoreDenial.run-1146"><a href="#Store.SendStoreDenial.run-1146"><span class="linenos">1146</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="Store.SendStoreDenial.run-1147"><a href="#Store.SendStoreDenial.run-1147"><span class="linenos">1147</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Store.SendStoreDenial.run-1148"><a href="#Store.SendStoreDenial.run-1148"><span class="linenos">1148</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Store.SendStoreDenial.run-1149"><a href="#Store.SendStoreDenial.run-1149"><span class="linenos">1149</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store.SendStoreDenial.run-1150"><a href="#Store.SendStoreDenial.run-1150"><span class="linenos">1150</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Store.SendStoreDenial.run-1151"><a href="#Store.SendStoreDenial.run-1151"><span class="linenos">1151</span></a>            
</span><span id="Store.SendStoreDenial.run-1152"><a href="#Store.SendStoreDenial.run-1152"><span class="linenos">1152</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.SendStoreDenial.run-1153"><a href="#Store.SendStoreDenial.run-1153"><span class="linenos">1153</span></a>            
</span><span id="Store.SendStoreDenial.run-1154"><a href="#Store.SendStoreDenial.run-1154"><span class="linenos">1154</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.SendStoreDenial.run-1155"><a href="#Store.SendStoreDenial.run-1155"><span class="linenos">1155</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Denial sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Execute the rejection sending process (FIPA reject-proposal).</p>

<p>This method sends the FIPA reject-proposal message to non-selected warehouses,
completing the result notification phase of the FIPA Contract Net Protocol.</p>

<h6 id="fipa-protocol-implementation">FIPA Protocol Implementation:</h6>

<blockquote>
  <ul>
  <li><strong>Phase</strong>: Result Notification - Rejection</li>
  <li><strong>Performative</strong>: store-deny (FIPA reject-proposal)</li>
  <li><strong>Meaning</strong>: "Your proposal was not selected"</li>
  <li><strong>Expected Response</strong>: Warehouse releases resources, updates state</li>
  </ul>
</blockquote>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><p><strong>Message Construction</strong>: Build store-deny message</p>
  
  <ul>
  <li>Performative: store-deny (FIPA reject-proposal)</li>
  <li>Metadata: warehouse_id, store_id, node_id, request_id</li>
  <li>Body: "{quantity} {product}"</li>
  </ul></li>
  <li><p><strong>Message Transmission</strong>: Send rejection to warehouse</p>
  
  <ul>
  <li>Notifies warehouse of negative outcome</li>
  <li>Allows warehouse to handle rejection gracefully</li>
  </ul></li>
  <li><p><strong>Status Logging</strong>: Print denial confirmation (verbose only)</p></li>
  </ol>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Sends SPADE message to warehouse</li>
  <li>Prints status information if verbose mode enabled</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Completes when rejection message is sent.</p>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
<pre><code>Input: warehouse-accept from warehouse1 (not selected)
    Body: "50 electronics"
    request_id: 1001000000
Processing:
    - Create store-deny message
    - Set metadata and body
Output:
    - Send store-deny to warehouse1
    - Print (if verbose): "Denial sent to warehouse1 for request: 50 electronics"
</code></pre>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Store.RetryPreviousBuy">
                            <input id="Store.RetryPreviousBuy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Store.RetryPreviousBuy</span><wbr>(<span class="base">spade.behaviour.PeriodicBehaviour</span>):

                <label class="view-source-button" for="Store.RetryPreviousBuy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.RetryPreviousBuy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.RetryPreviousBuy-1157"><a href="#Store.RetryPreviousBuy-1157"><span class="linenos">1157</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">RetryPreviousBuy</span><span class="p">(</span><span class="n">PeriodicBehaviour</span><span class="p">):</span>
</span><span id="Store.RetryPreviousBuy-1158"><a href="#Store.RetryPreviousBuy-1158"><span class="linenos">1158</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.RetryPreviousBuy-1159"><a href="#Store.RetryPreviousBuy-1159"><span class="linenos">1159</span></a><span class="sd">        Periodic behaviour that retries failed purchase requests.</span>
</span><span id="Store.RetryPreviousBuy-1160"><a href="#Store.RetryPreviousBuy-1160"><span class="linenos">1160</span></a><span class="sd">        </span>
</span><span id="Store.RetryPreviousBuy-1161"><a href="#Store.RetryPreviousBuy-1161"><span class="linenos">1161</span></a><span class="sd">        This behaviour implements automatic retry logic for purchase requests that failed</span>
</span><span id="Store.RetryPreviousBuy-1162"><a href="#Store.RetryPreviousBuy-1162"><span class="linenos">1162</span></a><span class="sd">        due to all warehouses rejecting or timing out. It periodically checks the</span>
</span><span id="Store.RetryPreviousBuy-1163"><a href="#Store.RetryPreviousBuy-1163"><span class="linenos">1163</span></a><span class="sd">        failed_requests queue and re-initiates the FIPA Contract Net Protocol for any</span>
</span><span id="Store.RetryPreviousBuy-1164"><a href="#Store.RetryPreviousBuy-1164"><span class="linenos">1164</span></a><span class="sd">        pending failed requests.</span>
</span><span id="Store.RetryPreviousBuy-1165"><a href="#Store.RetryPreviousBuy-1165"><span class="linenos">1165</span></a><span class="sd">        </span>
</span><span id="Store.RetryPreviousBuy-1166"><a href="#Store.RetryPreviousBuy-1166"><span class="linenos">1166</span></a><span class="sd">        Failure Scenarios:</span>
</span><span id="Store.RetryPreviousBuy-1167"><a href="#Store.RetryPreviousBuy-1167"><span class="linenos">1167</span></a><span class="sd">            - All warehouses sent warehouse-reject (refuse)</span>
</span><span id="Store.RetryPreviousBuy-1168"><a href="#Store.RetryPreviousBuy-1168"><span class="linenos">1168</span></a><span class="sd">            - All warehouses timed out (no response)</span>
</span><span id="Store.RetryPreviousBuy-1169"><a href="#Store.RetryPreviousBuy-1169"><span class="linenos">1169</span></a><span class="sd">            - Mix of rejects and timeouts with zero acceptances</span>
</span><span id="Store.RetryPreviousBuy-1170"><a href="#Store.RetryPreviousBuy-1170"><span class="linenos">1170</span></a><span class="sd">        </span>
</span><span id="Store.RetryPreviousBuy-1171"><a href="#Store.RetryPreviousBuy-1171"><span class="linenos">1171</span></a><span class="sd">        The behaviour maintains the original request_id for tracking and statistics,</span>
</span><span id="Store.RetryPreviousBuy-1172"><a href="#Store.RetryPreviousBuy-1172"><span class="linenos">1172</span></a><span class="sd">        allowing correlation between original attempt and retry attempts in logs.</span>
</span><span id="Store.RetryPreviousBuy-1173"><a href="#Store.RetryPreviousBuy-1173"><span class="linenos">1173</span></a><span class="sd">        </span>
</span><span id="Store.RetryPreviousBuy-1174"><a href="#Store.RetryPreviousBuy-1174"><span class="linenos">1174</span></a><span class="sd">        Attributes:</span>
</span><span id="Store.RetryPreviousBuy-1175"><a href="#Store.RetryPreviousBuy-1175"><span class="linenos">1175</span></a><span class="sd">            Inherited from PeriodicBehaviour:</span>
</span><span id="Store.RetryPreviousBuy-1176"><a href="#Store.RetryPreviousBuy-1176"><span class="linenos">1176</span></a><span class="sd">                - period (float): Time between retry attempts (default: 5 seconds)</span>
</span><span id="Store.RetryPreviousBuy-1177"><a href="#Store.RetryPreviousBuy-1177"><span class="linenos">1177</span></a><span class="sd">                - Executes continuously while agent is running</span>
</span><span id="Store.RetryPreviousBuy-1178"><a href="#Store.RetryPreviousBuy-1178"><span class="linenos">1178</span></a><span class="sd">        </span>
</span><span id="Store.RetryPreviousBuy-1179"><a href="#Store.RetryPreviousBuy-1179"><span class="linenos">1179</span></a><span class="sd">        Retry Logic:</span>
</span><span id="Store.RetryPreviousBuy-1180"><a href="#Store.RetryPreviousBuy-1180"><span class="linenos">1180</span></a><span class="sd">            - Checks failed_requests queue (FIFO)</span>
</span><span id="Store.RetryPreviousBuy-1181"><a href="#Store.RetryPreviousBuy-1181"><span class="linenos">1181</span></a><span class="sd">            - Dequeues one request per execution</span>
</span><span id="Store.RetryPreviousBuy-1182"><a href="#Store.RetryPreviousBuy-1182"><span class="linenos">1182</span></a><span class="sd">            - Preserves original request_id (no new ID generated)</span>
</span><span id="Store.RetryPreviousBuy-1183"><a href="#Store.RetryPreviousBuy-1183"><span class="linenos">1183</span></a><span class="sd">            - Re-broadcasts CFP to all warehouses</span>
</span><span id="Store.RetryPreviousBuy-1184"><a href="#Store.RetryPreviousBuy-1184"><span class="linenos">1184</span></a><span class="sd">            - Launches CollectWarehouseResponses coordinator</span>
</span><span id="Store.RetryPreviousBuy-1185"><a href="#Store.RetryPreviousBuy-1185"><span class="linenos">1185</span></a><span class="sd">        </span>
</span><span id="Store.RetryPreviousBuy-1186"><a href="#Store.RetryPreviousBuy-1186"><span class="linenos">1186</span></a><span class="sd">        FIPA Protocol:</span>
</span><span id="Store.RetryPreviousBuy-1187"><a href="#Store.RetryPreviousBuy-1187"><span class="linenos">1187</span></a><span class="sd">            Restarts the entire FIPA Contract Net Protocol:</span>
</span><span id="Store.RetryPreviousBuy-1188"><a href="#Store.RetryPreviousBuy-1188"><span class="linenos">1188</span></a><span class="sd">            1. Call for Proposals (CFP) - re-broadcast with same request_id</span>
</span><span id="Store.RetryPreviousBuy-1189"><a href="#Store.RetryPreviousBuy-1189"><span class="linenos">1189</span></a><span class="sd">            2. Proposal Reception - collect new responses</span>
</span><span id="Store.RetryPreviousBuy-1190"><a href="#Store.RetryPreviousBuy-1190"><span class="linenos">1190</span></a><span class="sd">            3. Proposal Evaluation - score and select best warehouse</span>
</span><span id="Store.RetryPreviousBuy-1191"><a href="#Store.RetryPreviousBuy-1191"><span class="linenos">1191</span></a><span class="sd">            4. Result Notification - confirm winner, deny losers</span>
</span><span id="Store.RetryPreviousBuy-1192"><a href="#Store.RetryPreviousBuy-1192"><span class="linenos">1192</span></a><span class="sd">        </span>
</span><span id="Store.RetryPreviousBuy-1193"><a href="#Store.RetryPreviousBuy-1193"><span class="linenos">1193</span></a><span class="sd">        Workflow:</span>
</span><span id="Store.RetryPreviousBuy-1194"><a href="#Store.RetryPreviousBuy-1194"><span class="linenos">1194</span></a><span class="sd">            1. **Queue Check**: Test if failed_requests queue is empty</span>
</span><span id="Store.RetryPreviousBuy-1195"><a href="#Store.RetryPreviousBuy-1195"><span class="linenos">1195</span></a><span class="sd">            2. **Dequeue**: Get oldest failed request from queue</span>
</span><span id="Store.RetryPreviousBuy-1196"><a href="#Store.RetryPreviousBuy-1196"><span class="linenos">1196</span></a><span class="sd">            3. **Parse**: Extract request_id, quantity, product from message</span>
</span><span id="Store.RetryPreviousBuy-1197"><a href="#Store.RetryPreviousBuy-1197"><span class="linenos">1197</span></a><span class="sd">            4. **Re-broadcast**: Send store-buy to all warehouses (same request_id)</span>
</span><span id="Store.RetryPreviousBuy-1198"><a href="#Store.RetryPreviousBuy-1198"><span class="linenos">1198</span></a><span class="sd">            5. **Coordinate**: Launch CollectWarehouseResponses for this retry</span>
</span><span id="Store.RetryPreviousBuy-1199"><a href="#Store.RetryPreviousBuy-1199"><span class="linenos">1199</span></a><span class="sd">            6. **Synchronize**: Wait for coordinator to complete</span>
</span><span id="Store.RetryPreviousBuy-1200"><a href="#Store.RetryPreviousBuy-1200"><span class="linenos">1200</span></a><span class="sd">            7. **Repeat**: Next period, check queue again</span>
</span><span id="Store.RetryPreviousBuy-1201"><a href="#Store.RetryPreviousBuy-1201"><span class="linenos">1201</span></a><span class="sd">        </span>
</span><span id="Store.RetryPreviousBuy-1202"><a href="#Store.RetryPreviousBuy-1202"><span class="linenos">1202</span></a><span class="sd">        Example Execution:</span>
</span><span id="Store.RetryPreviousBuy-1203"><a href="#Store.RetryPreviousBuy-1203"><span class="linenos">1203</span></a><span class="sd">            ```</span>
</span><span id="Store.RetryPreviousBuy-1204"><a href="#Store.RetryPreviousBuy-1204"><span class="linenos">1204</span></a><span class="sd">            Initial Attempt (t=10s):</span>
</span><span id="Store.RetryPreviousBuy-1205"><a href="#Store.RetryPreviousBuy-1205"><span class="linenos">1205</span></a><span class="sd">                - Request &quot;50 electronics&quot; (ID: 1001000000)</span>
</span><span id="Store.RetryPreviousBuy-1206"><a href="#Store.RetryPreviousBuy-1206"><span class="linenos">1206</span></a><span class="sd">                - All warehouses reject or timeout</span>
</span><span id="Store.RetryPreviousBuy-1207"><a href="#Store.RetryPreviousBuy-1207"><span class="linenos">1207</span></a><span class="sd">                - Added to failed_requests queue</span>
</span><span id="Store.RetryPreviousBuy-1208"><a href="#Store.RetryPreviousBuy-1208"><span class="linenos">1208</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy-1209"><a href="#Store.RetryPreviousBuy-1209"><span class="linenos">1209</span></a><span class="sd">            Retry Attempt (t=15s):</span>
</span><span id="Store.RetryPreviousBuy-1210"><a href="#Store.RetryPreviousBuy-1210"><span class="linenos">1210</span></a><span class="sd">                - Dequeue request 1001000000</span>
</span><span id="Store.RetryPreviousBuy-1211"><a href="#Store.RetryPreviousBuy-1211"><span class="linenos">1211</span></a><span class="sd">                - Re-broadcast to all warehouses (same ID)</span>
</span><span id="Store.RetryPreviousBuy-1212"><a href="#Store.RetryPreviousBuy-1212"><span class="linenos">1212</span></a><span class="sd">                - New responses: warehouse2 accepts</span>
</span><span id="Store.RetryPreviousBuy-1213"><a href="#Store.RetryPreviousBuy-1213"><span class="linenos">1213</span></a><span class="sd">                - Success: Order placed with warehouse2</span>
</span><span id="Store.RetryPreviousBuy-1214"><a href="#Store.RetryPreviousBuy-1214"><span class="linenos">1214</span></a><span class="sd">            ```</span>
</span><span id="Store.RetryPreviousBuy-1215"><a href="#Store.RetryPreviousBuy-1215"><span class="linenos">1215</span></a><span class="sd">        </span>
</span><span id="Store.RetryPreviousBuy-1216"><a href="#Store.RetryPreviousBuy-1216"><span class="linenos">1216</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store.RetryPreviousBuy-1217"><a href="#Store.RetryPreviousBuy-1217"><span class="linenos">1217</span></a><span class="sd">            - Dequeues from agent.failed_requests</span>
</span><span id="Store.RetryPreviousBuy-1218"><a href="#Store.RetryPreviousBuy-1218"><span class="linenos">1218</span></a><span class="sd">            - Sends store-buy messages to all warehouses</span>
</span><span id="Store.RetryPreviousBuy-1219"><a href="#Store.RetryPreviousBuy-1219"><span class="linenos">1219</span></a><span class="sd">            - Adds CollectWarehouseResponses behaviour</span>
</span><span id="Store.RetryPreviousBuy-1220"><a href="#Store.RetryPreviousBuy-1220"><span class="linenos">1220</span></a><span class="sd">            - Prints retry information if verbose mode enabled</span>
</span><span id="Store.RetryPreviousBuy-1221"><a href="#Store.RetryPreviousBuy-1221"><span class="linenos">1221</span></a><span class="sd">        </span>
</span><span id="Store.RetryPreviousBuy-1222"><a href="#Store.RetryPreviousBuy-1222"><span class="linenos">1222</span></a><span class="sd">        Notes:</span>
</span><span id="Store.RetryPreviousBuy-1223"><a href="#Store.RetryPreviousBuy-1223"><span class="linenos">1223</span></a><span class="sd">            - Retries use the SAME request_id as original attempt</span>
</span><span id="Store.RetryPreviousBuy-1224"><a href="#Store.RetryPreviousBuy-1224"><span class="linenos">1224</span></a><span class="sd">            - No limit on retry attempts (will retry until success)</span>
</span><span id="Store.RetryPreviousBuy-1225"><a href="#Store.RetryPreviousBuy-1225"><span class="linenos">1225</span></a><span class="sd">            - Failed retries are re-enqueued by CollectWarehouseResponses</span>
</span><span id="Store.RetryPreviousBuy-1226"><a href="#Store.RetryPreviousBuy-1226"><span class="linenos">1226</span></a><span class="sd">            - Period of 5 seconds prevents overwhelming warehouses</span>
</span><span id="Store.RetryPreviousBuy-1227"><a href="#Store.RetryPreviousBuy-1227"><span class="linenos">1227</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.RetryPreviousBuy-1228"><a href="#Store.RetryPreviousBuy-1228"><span class="linenos">1228</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.RetryPreviousBuy-1229"><a href="#Store.RetryPreviousBuy-1229"><span class="linenos">1229</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.RetryPreviousBuy-1230"><a href="#Store.RetryPreviousBuy-1230"><span class="linenos">1230</span></a><span class="sd">            Execute one retry cycle for failed purchase requests.</span>
</span><span id="Store.RetryPreviousBuy-1231"><a href="#Store.RetryPreviousBuy-1231"><span class="linenos">1231</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy-1232"><a href="#Store.RetryPreviousBuy-1232"><span class="linenos">1232</span></a><span class="sd">            This method checks the failed_requests queue and, if not empty, dequeues</span>
</span><span id="Store.RetryPreviousBuy-1233"><a href="#Store.RetryPreviousBuy-1233"><span class="linenos">1233</span></a><span class="sd">            one request and re-initiates the FIPA Contract Net Protocol with the same</span>
</span><span id="Store.RetryPreviousBuy-1234"><a href="#Store.RetryPreviousBuy-1234"><span class="linenos">1234</span></a><span class="sd">            request_id. This maintains traceability across retry attempts.</span>
</span><span id="Store.RetryPreviousBuy-1235"><a href="#Store.RetryPreviousBuy-1235"><span class="linenos">1235</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy-1236"><a href="#Store.RetryPreviousBuy-1236"><span class="linenos">1236</span></a><span class="sd">            Workflow:</span>
</span><span id="Store.RetryPreviousBuy-1237"><a href="#Store.RetryPreviousBuy-1237"><span class="linenos">1237</span></a><span class="sd">                1. **Queue Check**: If failed_requests is empty, do nothing</span>
</span><span id="Store.RetryPreviousBuy-1238"><a href="#Store.RetryPreviousBuy-1238"><span class="linenos">1238</span></a><span class="sd">                2. **Dequeue Request**: Get oldest failed request (FIFO order)</span>
</span><span id="Store.RetryPreviousBuy-1239"><a href="#Store.RetryPreviousBuy-1239"><span class="linenos">1239</span></a><span class="sd">                3. **Extract Data**: Parse request_id, quantity, product from message</span>
</span><span id="Store.RetryPreviousBuy-1240"><a href="#Store.RetryPreviousBuy-1240"><span class="linenos">1240</span></a><span class="sd">                4. **Count Participants**: Get number of warehouses for response tracking</span>
</span><span id="Store.RetryPreviousBuy-1241"><a href="#Store.RetryPreviousBuy-1241"><span class="linenos">1241</span></a><span class="sd">                5. **Rebuild Messages**: Create new store-buy messages for each warehouse</span>
</span><span id="Store.RetryPreviousBuy-1242"><a href="#Store.RetryPreviousBuy-1242"><span class="linenos">1242</span></a><span class="sd">                6. **Broadcast CFP**: Send retry request to all warehouses</span>
</span><span id="Store.RetryPreviousBuy-1243"><a href="#Store.RetryPreviousBuy-1243"><span class="linenos">1243</span></a><span class="sd">                7. **Launch Coordinator**: Start CollectWarehouseResponses with same request_id</span>
</span><span id="Store.RetryPreviousBuy-1244"><a href="#Store.RetryPreviousBuy-1244"><span class="linenos">1244</span></a><span class="sd">                8. **Wait**: Synchronize on coordinator completion</span>
</span><span id="Store.RetryPreviousBuy-1245"><a href="#Store.RetryPreviousBuy-1245"><span class="linenos">1245</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy-1246"><a href="#Store.RetryPreviousBuy-1246"><span class="linenos">1246</span></a><span class="sd">            Request ID Preservation:</span>
</span><span id="Store.RetryPreviousBuy-1247"><a href="#Store.RetryPreviousBuy-1247"><span class="linenos">1247</span></a><span class="sd">                The original request_id is preserved across retries, enabling:</span>
</span><span id="Store.RetryPreviousBuy-1248"><a href="#Store.RetryPreviousBuy-1248"><span class="linenos">1248</span></a><span class="sd">                - Statistics tracking (correlate original and retries)</span>
</span><span id="Store.RetryPreviousBuy-1249"><a href="#Store.RetryPreviousBuy-1249"><span class="linenos">1249</span></a><span class="sd">                - Debugging (trace request lifecycle)</span>
</span><span id="Store.RetryPreviousBuy-1250"><a href="#Store.RetryPreviousBuy-1250"><span class="linenos">1250</span></a><span class="sd">                - Avoiding duplicate processing (warehouses can detect retries)</span>
</span><span id="Store.RetryPreviousBuy-1251"><a href="#Store.RetryPreviousBuy-1251"><span class="linenos">1251</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy-1252"><a href="#Store.RetryPreviousBuy-1252"><span class="linenos">1252</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.RetryPreviousBuy-1253"><a href="#Store.RetryPreviousBuy-1253"><span class="linenos">1253</span></a><span class="sd">                - Removes one message from agent.failed_requests queue</span>
</span><span id="Store.RetryPreviousBuy-1254"><a href="#Store.RetryPreviousBuy-1254"><span class="linenos">1254</span></a><span class="sd">                - Sends multiple store-buy messages (one per warehouse)</span>
</span><span id="Store.RetryPreviousBuy-1255"><a href="#Store.RetryPreviousBuy-1255"><span class="linenos">1255</span></a><span class="sd">                - Adds CollectWarehouseResponses behaviour to agent</span>
</span><span id="Store.RetryPreviousBuy-1256"><a href="#Store.RetryPreviousBuy-1256"><span class="linenos">1256</span></a><span class="sd">                - Prints retry notifications if verbose mode enabled</span>
</span><span id="Store.RetryPreviousBuy-1257"><a href="#Store.RetryPreviousBuy-1257"><span class="linenos">1257</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy-1258"><a href="#Store.RetryPreviousBuy-1258"><span class="linenos">1258</span></a><span class="sd">            Returns:</span>
</span><span id="Store.RetryPreviousBuy-1259"><a href="#Store.RetryPreviousBuy-1259"><span class="linenos">1259</span></a><span class="sd">                None. Completes when coordinator finishes negotiation, or immediately</span>
</span><span id="Store.RetryPreviousBuy-1260"><a href="#Store.RetryPreviousBuy-1260"><span class="linenos">1260</span></a><span class="sd">                if queue is empty.</span>
</span><span id="Store.RetryPreviousBuy-1261"><a href="#Store.RetryPreviousBuy-1261"><span class="linenos">1261</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy-1262"><a href="#Store.RetryPreviousBuy-1262"><span class="linenos">1262</span></a><span class="sd">            Example Execution:</span>
</span><span id="Store.RetryPreviousBuy-1263"><a href="#Store.RetryPreviousBuy-1263"><span class="linenos">1263</span></a><span class="sd">                ```</span>
</span><span id="Store.RetryPreviousBuy-1264"><a href="#Store.RetryPreviousBuy-1264"><span class="linenos">1264</span></a><span class="sd">                Queue State: [Request(ID=1001000000, &quot;50 electronics&quot;)]</span>
</span><span id="Store.RetryPreviousBuy-1265"><a href="#Store.RetryPreviousBuy-1265"><span class="linenos">1265</span></a><span class="sd">                Processing:</span>
</span><span id="Store.RetryPreviousBuy-1266"><a href="#Store.RetryPreviousBuy-1266"><span class="linenos">1266</span></a><span class="sd">                    - Dequeue: Request 1001000000</span>
</span><span id="Store.RetryPreviousBuy-1267"><a href="#Store.RetryPreviousBuy-1267"><span class="linenos">1267</span></a><span class="sd">                    - Parse: quantity=50, product=&quot;electronics&quot;</span>
</span><span id="Store.RetryPreviousBuy-1268"><a href="#Store.RetryPreviousBuy-1268"><span class="linenos">1268</span></a><span class="sd">                    - Broadcast: Send to warehouse1, warehouse2, warehouse3</span>
</span><span id="Store.RetryPreviousBuy-1269"><a href="#Store.RetryPreviousBuy-1269"><span class="linenos">1269</span></a><span class="sd">                    - Coordinate: Launch CollectWarehouseResponses(1001000000, ...)</span>
</span><span id="Store.RetryPreviousBuy-1270"><a href="#Store.RetryPreviousBuy-1270"><span class="linenos">1270</span></a><span class="sd">                    - Wait: Until new responses collected and evaluated</span>
</span><span id="Store.RetryPreviousBuy-1271"><a href="#Store.RetryPreviousBuy-1271"><span class="linenos">1271</span></a><span class="sd">                Result:</span>
</span><span id="Store.RetryPreviousBuy-1272"><a href="#Store.RetryPreviousBuy-1272"><span class="linenos">1272</span></a><span class="sd">                    - If success: Order placed</span>
</span><span id="Store.RetryPreviousBuy-1273"><a href="#Store.RetryPreviousBuy-1273"><span class="linenos">1273</span></a><span class="sd">                    - If failure: Re-enqueued for next retry cycle</span>
</span><span id="Store.RetryPreviousBuy-1274"><a href="#Store.RetryPreviousBuy-1274"><span class="linenos">1274</span></a><span class="sd">                ```</span>
</span><span id="Store.RetryPreviousBuy-1275"><a href="#Store.RetryPreviousBuy-1275"><span class="linenos">1275</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy-1276"><a href="#Store.RetryPreviousBuy-1276"><span class="linenos">1276</span></a><span class="sd">            Note:</span>
</span><span id="Store.RetryPreviousBuy-1277"><a href="#Store.RetryPreviousBuy-1277"><span class="linenos">1277</span></a><span class="sd">                This method processes only ONE request per execution cycle (period=5s).</span>
</span><span id="Store.RetryPreviousBuy-1278"><a href="#Store.RetryPreviousBuy-1278"><span class="linenos">1278</span></a><span class="sd">                This prevents flooding warehouses with retry requests and allows</span>
</span><span id="Store.RetryPreviousBuy-1279"><a href="#Store.RetryPreviousBuy-1279"><span class="linenos">1279</span></a><span class="sd">                gradual processing of the failed_requests backlog.</span>
</span><span id="Store.RetryPreviousBuy-1280"><a href="#Store.RetryPreviousBuy-1280"><span class="linenos">1280</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.RetryPreviousBuy-1281"><a href="#Store.RetryPreviousBuy-1281"><span class="linenos">1281</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.RetryPreviousBuy-1282"><a href="#Store.RetryPreviousBuy-1282"><span class="linenos">1282</span></a>            
</span><span id="Store.RetryPreviousBuy-1283"><a href="#Store.RetryPreviousBuy-1283"><span class="linenos">1283</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="Store.RetryPreviousBuy-1284"><a href="#Store.RetryPreviousBuy-1284"><span class="linenos">1284</span></a>                <span class="n">request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="Store.RetryPreviousBuy-1285"><a href="#Store.RetryPreviousBuy-1285"><span class="linenos">1285</span></a>                <span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy-1286"><a href="#Store.RetryPreviousBuy-1286"><span class="linenos">1286</span></a>                <span class="n">parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy-1287"><a href="#Store.RetryPreviousBuy-1287"><span class="linenos">1287</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store.RetryPreviousBuy-1288"><a href="#Store.RetryPreviousBuy-1288"><span class="linenos">1288</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store.RetryPreviousBuy-1289"><a href="#Store.RetryPreviousBuy-1289"><span class="linenos">1289</span></a>                
</span><span id="Store.RetryPreviousBuy-1290"><a href="#Store.RetryPreviousBuy-1290"><span class="linenos">1290</span></a>                <span class="n">contacts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Store.RetryPreviousBuy-1291"><a href="#Store.RetryPreviousBuy-1291"><span class="linenos">1291</span></a>                <span class="n">num_warehouses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contacts</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy-1292"><a href="#Store.RetryPreviousBuy-1292"><span class="linenos">1292</span></a>                
</span><span id="Store.RetryPreviousBuy-1293"><a href="#Store.RetryPreviousBuy-1293"><span class="linenos">1293</span></a>                <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">:</span>
</span><span id="Store.RetryPreviousBuy-1294"><a href="#Store.RetryPreviousBuy-1294"><span class="linenos">1294</span></a>                    <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">contact</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy-1295"><a href="#Store.RetryPreviousBuy-1295"><span class="linenos">1295</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">set_buy_metadata</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy-1296"><a href="#Store.RetryPreviousBuy-1296"><span class="linenos">1296</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Store.RetryPreviousBuy-1297"><a href="#Store.RetryPreviousBuy-1297"><span class="linenos">1297</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store.RetryPreviousBuy-1298"><a href="#Store.RetryPreviousBuy-1298"><span class="linenos">1298</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
</span><span id="Store.RetryPreviousBuy-1299"><a href="#Store.RetryPreviousBuy-1299"><span class="linenos">1299</span></a>
</span><span id="Store.RetryPreviousBuy-1300"><a href="#Store.RetryPreviousBuy-1300"><span class="linenos">1300</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.RetryPreviousBuy-1301"><a href="#Store.RetryPreviousBuy-1301"><span class="linenos">1301</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Retrying request (id=</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="Store.RetryPreviousBuy-1302"><a href="#Store.RetryPreviousBuy-1302"><span class="linenos">1302</span></a>                              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy-1303"><a href="#Store.RetryPreviousBuy-1303"><span class="linenos">1303</span></a>
</span><span id="Store.RetryPreviousBuy-1304"><a href="#Store.RetryPreviousBuy-1304"><span class="linenos">1304</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy-1305"><a href="#Store.RetryPreviousBuy-1305"><span class="linenos">1305</span></a>
</span><span id="Store.RetryPreviousBuy-1306"><a href="#Store.RetryPreviousBuy-1306"><span class="linenos">1306</span></a>                <span class="c1"># Use CollectWarehouseResponses instead</span>
</span><span id="Store.RetryPreviousBuy-1307"><a href="#Store.RetryPreviousBuy-1307"><span class="linenos">1307</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectWarehouseResponses</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">num_warehouses</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy-1308"><a href="#Store.RetryPreviousBuy-1308"><span class="linenos">1308</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy-1309"><a href="#Store.RetryPreviousBuy-1309"><span class="linenos">1309</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Periodic behaviour that retries failed purchase requests.</p>

<p>This behaviour implements automatic retry logic for purchase requests that failed
due to all warehouses rejecting or timing out. It periodically checks the
failed_requests queue and re-initiates the FIPA Contract Net Protocol for any
pending failed requests.</p>

<h6 id="failure-scenarios">Failure Scenarios:</h6>

<blockquote>
  <ul>
  <li>All warehouses sent warehouse-reject (refuse)</li>
  <li>All warehouses timed out (no response)</li>
  <li>Mix of rejects and timeouts with zero acceptances</li>
  </ul>
</blockquote>

<p>The behaviour maintains the original request_id for tracking and statistics,
allowing correlation between original attempt and retry attempts in logs.</p>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>Inherited from PeriodicBehaviour:</strong>  - period (float): Time between retry attempts (default: 5 seconds)
<ul>
<li>Executes continuously while agent is running</li>
</ul></li>
</ul>

<h6 id="retry-logic">Retry Logic:</h6>

<blockquote>
  <ul>
  <li>Checks failed_requests queue (FIFO)</li>
  <li>Dequeues one request per execution</li>
  <li>Preserves original request_id (no new ID generated)</li>
  <li>Re-broadcasts CFP to all warehouses</li>
  <li>Launches CollectWarehouseResponses coordinator</li>
  </ul>
</blockquote>

<h6 id="fipa-protocol">FIPA Protocol:</h6>

<blockquote>
  <p>Restarts the entire FIPA Contract Net Protocol:</p>
  
  <ol>
  <li>Call for Proposals (CFP) - re-broadcast with same request_id</li>
  <li>Proposal Reception - collect new responses</li>
  <li>Proposal Evaluation - score and select best warehouse</li>
  <li>Result Notification - confirm winner, deny losers</li>
  </ol>
</blockquote>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Queue Check</strong>: Test if failed_requests queue is empty</li>
  <li><strong>Dequeue</strong>: Get oldest failed request from queue</li>
  <li><strong>Parse</strong>: Extract request_id, quantity, product from message</li>
  <li><strong>Re-broadcast</strong>: Send store-buy to all warehouses (same request_id)</li>
  <li><strong>Coordinate</strong>: Launch CollectWarehouseResponses for this retry</li>
  <li><strong>Synchronize</strong>: Wait for coordinator to complete</li>
  <li><strong>Repeat</strong>: Next period, check queue again</li>
  </ol>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
<pre><code>Initial Attempt (t=10s):
    - Request "50 electronics" (ID: 1001000000)
    - All warehouses reject or timeout
    - Added to failed_requests queue

Retry Attempt (t=15s):
    - Dequeue request 1001000000
    - Re-broadcast to all warehouses (same ID)
    - New responses: warehouse2 accepts
    - Success: Order placed with warehouse2
</code></pre>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Dequeues from agent.failed_requests</li>
  <li>Sends store-buy messages to all warehouses</li>
  <li>Adds CollectWarehouseResponses behaviour</li>
  <li>Prints retry information if verbose mode enabled</li>
  </ul>
</blockquote>

<h6 id="notes">Notes:</h6>

<blockquote>
  <ul>
  <li>Retries use the SAME request_id as original attempt</li>
  <li>No limit on retry attempts (will retry until success)</li>
  <li>Failed retries are re-enqueued by CollectWarehouseResponses</li>
  <li>Period of 5 seconds prevents overwhelming warehouses</li>
  </ul>
</blockquote>
</div>


                            <div id="Store.RetryPreviousBuy.run" class="classattr">
                                        <input id="Store.RetryPreviousBuy.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Store.RetryPreviousBuy.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.RetryPreviousBuy.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.RetryPreviousBuy.run-1228"><a href="#Store.RetryPreviousBuy.run-1228"><span class="linenos">1228</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.RetryPreviousBuy.run-1229"><a href="#Store.RetryPreviousBuy.run-1229"><span class="linenos">1229</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.RetryPreviousBuy.run-1230"><a href="#Store.RetryPreviousBuy.run-1230"><span class="linenos">1230</span></a><span class="sd">            Execute one retry cycle for failed purchase requests.</span>
</span><span id="Store.RetryPreviousBuy.run-1231"><a href="#Store.RetryPreviousBuy.run-1231"><span class="linenos">1231</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy.run-1232"><a href="#Store.RetryPreviousBuy.run-1232"><span class="linenos">1232</span></a><span class="sd">            This method checks the failed_requests queue and, if not empty, dequeues</span>
</span><span id="Store.RetryPreviousBuy.run-1233"><a href="#Store.RetryPreviousBuy.run-1233"><span class="linenos">1233</span></a><span class="sd">            one request and re-initiates the FIPA Contract Net Protocol with the same</span>
</span><span id="Store.RetryPreviousBuy.run-1234"><a href="#Store.RetryPreviousBuy.run-1234"><span class="linenos">1234</span></a><span class="sd">            request_id. This maintains traceability across retry attempts.</span>
</span><span id="Store.RetryPreviousBuy.run-1235"><a href="#Store.RetryPreviousBuy.run-1235"><span class="linenos">1235</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy.run-1236"><a href="#Store.RetryPreviousBuy.run-1236"><span class="linenos">1236</span></a><span class="sd">            Workflow:</span>
</span><span id="Store.RetryPreviousBuy.run-1237"><a href="#Store.RetryPreviousBuy.run-1237"><span class="linenos">1237</span></a><span class="sd">                1. **Queue Check**: If failed_requests is empty, do nothing</span>
</span><span id="Store.RetryPreviousBuy.run-1238"><a href="#Store.RetryPreviousBuy.run-1238"><span class="linenos">1238</span></a><span class="sd">                2. **Dequeue Request**: Get oldest failed request (FIFO order)</span>
</span><span id="Store.RetryPreviousBuy.run-1239"><a href="#Store.RetryPreviousBuy.run-1239"><span class="linenos">1239</span></a><span class="sd">                3. **Extract Data**: Parse request_id, quantity, product from message</span>
</span><span id="Store.RetryPreviousBuy.run-1240"><a href="#Store.RetryPreviousBuy.run-1240"><span class="linenos">1240</span></a><span class="sd">                4. **Count Participants**: Get number of warehouses for response tracking</span>
</span><span id="Store.RetryPreviousBuy.run-1241"><a href="#Store.RetryPreviousBuy.run-1241"><span class="linenos">1241</span></a><span class="sd">                5. **Rebuild Messages**: Create new store-buy messages for each warehouse</span>
</span><span id="Store.RetryPreviousBuy.run-1242"><a href="#Store.RetryPreviousBuy.run-1242"><span class="linenos">1242</span></a><span class="sd">                6. **Broadcast CFP**: Send retry request to all warehouses</span>
</span><span id="Store.RetryPreviousBuy.run-1243"><a href="#Store.RetryPreviousBuy.run-1243"><span class="linenos">1243</span></a><span class="sd">                7. **Launch Coordinator**: Start CollectWarehouseResponses with same request_id</span>
</span><span id="Store.RetryPreviousBuy.run-1244"><a href="#Store.RetryPreviousBuy.run-1244"><span class="linenos">1244</span></a><span class="sd">                8. **Wait**: Synchronize on coordinator completion</span>
</span><span id="Store.RetryPreviousBuy.run-1245"><a href="#Store.RetryPreviousBuy.run-1245"><span class="linenos">1245</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy.run-1246"><a href="#Store.RetryPreviousBuy.run-1246"><span class="linenos">1246</span></a><span class="sd">            Request ID Preservation:</span>
</span><span id="Store.RetryPreviousBuy.run-1247"><a href="#Store.RetryPreviousBuy.run-1247"><span class="linenos">1247</span></a><span class="sd">                The original request_id is preserved across retries, enabling:</span>
</span><span id="Store.RetryPreviousBuy.run-1248"><a href="#Store.RetryPreviousBuy.run-1248"><span class="linenos">1248</span></a><span class="sd">                - Statistics tracking (correlate original and retries)</span>
</span><span id="Store.RetryPreviousBuy.run-1249"><a href="#Store.RetryPreviousBuy.run-1249"><span class="linenos">1249</span></a><span class="sd">                - Debugging (trace request lifecycle)</span>
</span><span id="Store.RetryPreviousBuy.run-1250"><a href="#Store.RetryPreviousBuy.run-1250"><span class="linenos">1250</span></a><span class="sd">                - Avoiding duplicate processing (warehouses can detect retries)</span>
</span><span id="Store.RetryPreviousBuy.run-1251"><a href="#Store.RetryPreviousBuy.run-1251"><span class="linenos">1251</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy.run-1252"><a href="#Store.RetryPreviousBuy.run-1252"><span class="linenos">1252</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.RetryPreviousBuy.run-1253"><a href="#Store.RetryPreviousBuy.run-1253"><span class="linenos">1253</span></a><span class="sd">                - Removes one message from agent.failed_requests queue</span>
</span><span id="Store.RetryPreviousBuy.run-1254"><a href="#Store.RetryPreviousBuy.run-1254"><span class="linenos">1254</span></a><span class="sd">                - Sends multiple store-buy messages (one per warehouse)</span>
</span><span id="Store.RetryPreviousBuy.run-1255"><a href="#Store.RetryPreviousBuy.run-1255"><span class="linenos">1255</span></a><span class="sd">                - Adds CollectWarehouseResponses behaviour to agent</span>
</span><span id="Store.RetryPreviousBuy.run-1256"><a href="#Store.RetryPreviousBuy.run-1256"><span class="linenos">1256</span></a><span class="sd">                - Prints retry notifications if verbose mode enabled</span>
</span><span id="Store.RetryPreviousBuy.run-1257"><a href="#Store.RetryPreviousBuy.run-1257"><span class="linenos">1257</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy.run-1258"><a href="#Store.RetryPreviousBuy.run-1258"><span class="linenos">1258</span></a><span class="sd">            Returns:</span>
</span><span id="Store.RetryPreviousBuy.run-1259"><a href="#Store.RetryPreviousBuy.run-1259"><span class="linenos">1259</span></a><span class="sd">                None. Completes when coordinator finishes negotiation, or immediately</span>
</span><span id="Store.RetryPreviousBuy.run-1260"><a href="#Store.RetryPreviousBuy.run-1260"><span class="linenos">1260</span></a><span class="sd">                if queue is empty.</span>
</span><span id="Store.RetryPreviousBuy.run-1261"><a href="#Store.RetryPreviousBuy.run-1261"><span class="linenos">1261</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy.run-1262"><a href="#Store.RetryPreviousBuy.run-1262"><span class="linenos">1262</span></a><span class="sd">            Example Execution:</span>
</span><span id="Store.RetryPreviousBuy.run-1263"><a href="#Store.RetryPreviousBuy.run-1263"><span class="linenos">1263</span></a><span class="sd">                ```</span>
</span><span id="Store.RetryPreviousBuy.run-1264"><a href="#Store.RetryPreviousBuy.run-1264"><span class="linenos">1264</span></a><span class="sd">                Queue State: [Request(ID=1001000000, &quot;50 electronics&quot;)]</span>
</span><span id="Store.RetryPreviousBuy.run-1265"><a href="#Store.RetryPreviousBuy.run-1265"><span class="linenos">1265</span></a><span class="sd">                Processing:</span>
</span><span id="Store.RetryPreviousBuy.run-1266"><a href="#Store.RetryPreviousBuy.run-1266"><span class="linenos">1266</span></a><span class="sd">                    - Dequeue: Request 1001000000</span>
</span><span id="Store.RetryPreviousBuy.run-1267"><a href="#Store.RetryPreviousBuy.run-1267"><span class="linenos">1267</span></a><span class="sd">                    - Parse: quantity=50, product=&quot;electronics&quot;</span>
</span><span id="Store.RetryPreviousBuy.run-1268"><a href="#Store.RetryPreviousBuy.run-1268"><span class="linenos">1268</span></a><span class="sd">                    - Broadcast: Send to warehouse1, warehouse2, warehouse3</span>
</span><span id="Store.RetryPreviousBuy.run-1269"><a href="#Store.RetryPreviousBuy.run-1269"><span class="linenos">1269</span></a><span class="sd">                    - Coordinate: Launch CollectWarehouseResponses(1001000000, ...)</span>
</span><span id="Store.RetryPreviousBuy.run-1270"><a href="#Store.RetryPreviousBuy.run-1270"><span class="linenos">1270</span></a><span class="sd">                    - Wait: Until new responses collected and evaluated</span>
</span><span id="Store.RetryPreviousBuy.run-1271"><a href="#Store.RetryPreviousBuy.run-1271"><span class="linenos">1271</span></a><span class="sd">                Result:</span>
</span><span id="Store.RetryPreviousBuy.run-1272"><a href="#Store.RetryPreviousBuy.run-1272"><span class="linenos">1272</span></a><span class="sd">                    - If success: Order placed</span>
</span><span id="Store.RetryPreviousBuy.run-1273"><a href="#Store.RetryPreviousBuy.run-1273"><span class="linenos">1273</span></a><span class="sd">                    - If failure: Re-enqueued for next retry cycle</span>
</span><span id="Store.RetryPreviousBuy.run-1274"><a href="#Store.RetryPreviousBuy.run-1274"><span class="linenos">1274</span></a><span class="sd">                ```</span>
</span><span id="Store.RetryPreviousBuy.run-1275"><a href="#Store.RetryPreviousBuy.run-1275"><span class="linenos">1275</span></a><span class="sd">            </span>
</span><span id="Store.RetryPreviousBuy.run-1276"><a href="#Store.RetryPreviousBuy.run-1276"><span class="linenos">1276</span></a><span class="sd">            Note:</span>
</span><span id="Store.RetryPreviousBuy.run-1277"><a href="#Store.RetryPreviousBuy.run-1277"><span class="linenos">1277</span></a><span class="sd">                This method processes only ONE request per execution cycle (period=5s).</span>
</span><span id="Store.RetryPreviousBuy.run-1278"><a href="#Store.RetryPreviousBuy.run-1278"><span class="linenos">1278</span></a><span class="sd">                This prevents flooding warehouses with retry requests and allows</span>
</span><span id="Store.RetryPreviousBuy.run-1279"><a href="#Store.RetryPreviousBuy.run-1279"><span class="linenos">1279</span></a><span class="sd">                gradual processing of the failed_requests backlog.</span>
</span><span id="Store.RetryPreviousBuy.run-1280"><a href="#Store.RetryPreviousBuy.run-1280"><span class="linenos">1280</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.RetryPreviousBuy.run-1281"><a href="#Store.RetryPreviousBuy.run-1281"><span class="linenos">1281</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.RetryPreviousBuy.run-1282"><a href="#Store.RetryPreviousBuy.run-1282"><span class="linenos">1282</span></a>            
</span><span id="Store.RetryPreviousBuy.run-1283"><a href="#Store.RetryPreviousBuy.run-1283"><span class="linenos">1283</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="Store.RetryPreviousBuy.run-1284"><a href="#Store.RetryPreviousBuy.run-1284"><span class="linenos">1284</span></a>                <span class="n">request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="Store.RetryPreviousBuy.run-1285"><a href="#Store.RetryPreviousBuy.run-1285"><span class="linenos">1285</span></a>                <span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy.run-1286"><a href="#Store.RetryPreviousBuy.run-1286"><span class="linenos">1286</span></a>                <span class="n">parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy.run-1287"><a href="#Store.RetryPreviousBuy.run-1287"><span class="linenos">1287</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Store.RetryPreviousBuy.run-1288"><a href="#Store.RetryPreviousBuy.run-1288"><span class="linenos">1288</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Store.RetryPreviousBuy.run-1289"><a href="#Store.RetryPreviousBuy.run-1289"><span class="linenos">1289</span></a>                
</span><span id="Store.RetryPreviousBuy.run-1290"><a href="#Store.RetryPreviousBuy.run-1290"><span class="linenos">1290</span></a>                <span class="n">contacts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Store.RetryPreviousBuy.run-1291"><a href="#Store.RetryPreviousBuy.run-1291"><span class="linenos">1291</span></a>                <span class="n">num_warehouses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contacts</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy.run-1292"><a href="#Store.RetryPreviousBuy.run-1292"><span class="linenos">1292</span></a>                
</span><span id="Store.RetryPreviousBuy.run-1293"><a href="#Store.RetryPreviousBuy.run-1293"><span class="linenos">1293</span></a>                <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">:</span>
</span><span id="Store.RetryPreviousBuy.run-1294"><a href="#Store.RetryPreviousBuy.run-1294"><span class="linenos">1294</span></a>                    <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">contact</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy.run-1295"><a href="#Store.RetryPreviousBuy.run-1295"><span class="linenos">1295</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">set_buy_metadata</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy.run-1296"><a href="#Store.RetryPreviousBuy.run-1296"><span class="linenos">1296</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Store.RetryPreviousBuy.run-1297"><a href="#Store.RetryPreviousBuy.run-1297"><span class="linenos">1297</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Store.RetryPreviousBuy.run-1298"><a href="#Store.RetryPreviousBuy.run-1298"><span class="linenos">1298</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
</span><span id="Store.RetryPreviousBuy.run-1299"><a href="#Store.RetryPreviousBuy.run-1299"><span class="linenos">1299</span></a>
</span><span id="Store.RetryPreviousBuy.run-1300"><a href="#Store.RetryPreviousBuy.run-1300"><span class="linenos">1300</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Store.RetryPreviousBuy.run-1301"><a href="#Store.RetryPreviousBuy.run-1301"><span class="linenos">1301</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Retrying request (id=</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="Store.RetryPreviousBuy.run-1302"><a href="#Store.RetryPreviousBuy.run-1302"><span class="linenos">1302</span></a>                              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy.run-1303"><a href="#Store.RetryPreviousBuy.run-1303"><span class="linenos">1303</span></a>
</span><span id="Store.RetryPreviousBuy.run-1304"><a href="#Store.RetryPreviousBuy.run-1304"><span class="linenos">1304</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy.run-1305"><a href="#Store.RetryPreviousBuy.run-1305"><span class="linenos">1305</span></a>
</span><span id="Store.RetryPreviousBuy.run-1306"><a href="#Store.RetryPreviousBuy.run-1306"><span class="linenos">1306</span></a>                <span class="c1"># Use CollectWarehouseResponses instead</span>
</span><span id="Store.RetryPreviousBuy.run-1307"><a href="#Store.RetryPreviousBuy.run-1307"><span class="linenos">1307</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectWarehouseResponses</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">num_warehouses</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy.run-1308"><a href="#Store.RetryPreviousBuy.run-1308"><span class="linenos">1308</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Store.RetryPreviousBuy.run-1309"><a href="#Store.RetryPreviousBuy.run-1309"><span class="linenos">1309</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Execute one retry cycle for failed purchase requests.</p>

<p>This method checks the failed_requests queue and, if not empty, dequeues
one request and re-initiates the FIPA Contract Net Protocol with the same
request_id. This maintains traceability across retry attempts.</p>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Queue Check</strong>: If failed_requests is empty, do nothing</li>
  <li><strong>Dequeue Request</strong>: Get oldest failed request (FIFO order)</li>
  <li><strong>Extract Data</strong>: Parse request_id, quantity, product from message</li>
  <li><strong>Count Participants</strong>: Get number of warehouses for response tracking</li>
  <li><strong>Rebuild Messages</strong>: Create new store-buy messages for each warehouse</li>
  <li><strong>Broadcast CFP</strong>: Send retry request to all warehouses</li>
  <li><strong>Launch Coordinator</strong>: Start CollectWarehouseResponses with same request_id</li>
  <li><strong>Wait</strong>: Synchronize on coordinator completion</li>
  </ol>
</blockquote>

<h6 id="request-id-preservation">Request ID Preservation:</h6>

<blockquote>
  <p>The original request_id is preserved across retries, enabling:</p>
  
  <ul>
  <li>Statistics tracking (correlate original and retries)</li>
  <li>Debugging (trace request lifecycle)</li>
  <li>Avoiding duplicate processing (warehouses can detect retries)</li>
  </ul>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Removes one message from agent.failed_requests queue</li>
  <li>Sends multiple store-buy messages (one per warehouse)</li>
  <li>Adds CollectWarehouseResponses behaviour to agent</li>
  <li>Prints retry notifications if verbose mode enabled</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Completes when coordinator finishes negotiation, or immediately
  if queue is empty.</p>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
<pre><code>Queue State: [Request(ID=1001000000, "50 electronics")]
Processing:
    - Dequeue: Request 1001000000
    - Parse: quantity=50, product="electronics"
    - Broadcast: Send to warehouse1, warehouse2, warehouse3
    - Coordinate: Launch CollectWarehouseResponses(1001000000, ...)
    - Wait: Until new responses collected and evaluated
Result:
    - If success: Order placed
    - If failure: Re-enqueued for next retry cycle
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This method processes only ONE request per execution cycle (period=5s).
  This prevents flooding warehouses with retry requests and allows
  gradual processing of the failed_requests backlog.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Store.ReceiveTimeDelta">
                            <input id="Store.ReceiveTimeDelta-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Store.ReceiveTimeDelta</span><wbr>(<span class="base">spade.behaviour.CyclicBehaviour</span>):

                <label class="view-source-button" for="Store.ReceiveTimeDelta-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.ReceiveTimeDelta"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.ReceiveTimeDelta-1311"><a href="#Store.ReceiveTimeDelta-1311"><span class="linenos">1311</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveTimeDelta</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="Store.ReceiveTimeDelta-1312"><a href="#Store.ReceiveTimeDelta-1312"><span class="linenos">1312</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.ReceiveTimeDelta-1313"><a href="#Store.ReceiveTimeDelta-1313"><span class="linenos">1313</span></a><span class="sd">        Cyclic behaviour that processes simulation time updates and traffic information.</span>
</span><span id="Store.ReceiveTimeDelta-1314"><a href="#Store.ReceiveTimeDelta-1314"><span class="linenos">1314</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveTimeDelta-1315"><a href="#Store.ReceiveTimeDelta-1315"><span class="linenos">1315</span></a><span class="sd">        This behaviour listens for time synchronization messages from the world agent,</span>
</span><span id="Store.ReceiveTimeDelta-1316"><a href="#Store.ReceiveTimeDelta-1316"><span class="linenos">1316</span></a><span class="sd">        updating the store&#39;s internal clock and applying dynamic traffic changes to the</span>
</span><span id="Store.ReceiveTimeDelta-1317"><a href="#Store.ReceiveTimeDelta-1317"><span class="linenos">1317</span></a><span class="sd">        graph. It implements an event-driven architecture where the world agent controls</span>
</span><span id="Store.ReceiveTimeDelta-1318"><a href="#Store.ReceiveTimeDelta-1318"><span class="linenos">1318</span></a><span class="sd">        simulation time progression.</span>
</span><span id="Store.ReceiveTimeDelta-1319"><a href="#Store.ReceiveTimeDelta-1319"><span class="linenos">1319</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveTimeDelta-1320"><a href="#Store.ReceiveTimeDelta-1320"><span class="linenos">1320</span></a><span class="sd">        Message Types Processed:</span>
</span><span id="Store.ReceiveTimeDelta-1321"><a href="#Store.ReceiveTimeDelta-1321"><span class="linenos">1321</span></a><span class="sd">            1. **Time Updates** (all messages):</span>
</span><span id="Store.ReceiveTimeDelta-1322"><a href="#Store.ReceiveTimeDelta-1322"><span class="linenos">1322</span></a><span class="sd">                - Updates agent.current_tick with time delta</span>
</span><span id="Store.ReceiveTimeDelta-1323"><a href="#Store.ReceiveTimeDelta-1323"><span class="linenos">1323</span></a><span class="sd">                - Synchronizes store with global simulation time</span>
</span><span id="Store.ReceiveTimeDelta-1324"><a href="#Store.ReceiveTimeDelta-1324"><span class="linenos">1324</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta-1325"><a href="#Store.ReceiveTimeDelta-1325"><span class="linenos">1325</span></a><span class="sd">            2. **Traffic Updates** (type=&quot;Transit&quot;):</span>
</span><span id="Store.ReceiveTimeDelta-1326"><a href="#Store.ReceiveTimeDelta-1326"><span class="linenos">1326</span></a><span class="sd">                - Applies dynamic edge weight changes to graph</span>
</span><span id="Store.ReceiveTimeDelta-1327"><a href="#Store.ReceiveTimeDelta-1327"><span class="linenos">1327</span></a><span class="sd">                - Updates fuel consumption values for routes</span>
</span><span id="Store.ReceiveTimeDelta-1328"><a href="#Store.ReceiveTimeDelta-1328"><span class="linenos">1328</span></a><span class="sd">                - Reflects real-time traffic conditions</span>
</span><span id="Store.ReceiveTimeDelta-1329"><a href="#Store.ReceiveTimeDelta-1329"><span class="linenos">1329</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveTimeDelta-1330"><a href="#Store.ReceiveTimeDelta-1330"><span class="linenos">1330</span></a><span class="sd">        Message Format:</span>
</span><span id="Store.ReceiveTimeDelta-1331"><a href="#Store.ReceiveTimeDelta-1331"><span class="linenos">1331</span></a><span class="sd">            Metadata:</span>
</span><span id="Store.ReceiveTimeDelta-1332"><a href="#Store.ReceiveTimeDelta-1332"><span class="linenos">1332</span></a><span class="sd">                - performative: &quot;inform&quot;</span>
</span><span id="Store.ReceiveTimeDelta-1333"><a href="#Store.ReceiveTimeDelta-1333"><span class="linenos">1333</span></a><span class="sd">            Body (JSON):</span>
</span><span id="Store.ReceiveTimeDelta-1334"><a href="#Store.ReceiveTimeDelta-1334"><span class="linenos">1334</span></a><span class="sd">                ```json</span>
</span><span id="Store.ReceiveTimeDelta-1335"><a href="#Store.ReceiveTimeDelta-1335"><span class="linenos">1335</span></a><span class="sd">                {</span>
</span><span id="Store.ReceiveTimeDelta-1336"><a href="#Store.ReceiveTimeDelta-1336"><span class="linenos">1336</span></a><span class="sd">                    &quot;type&quot;: &quot;Transit&quot;,  // or other types</span>
</span><span id="Store.ReceiveTimeDelta-1337"><a href="#Store.ReceiveTimeDelta-1337"><span class="linenos">1337</span></a><span class="sd">                    &quot;time&quot;: 5,          // delta in ticks</span>
</span><span id="Store.ReceiveTimeDelta-1338"><a href="#Store.ReceiveTimeDelta-1338"><span class="linenos">1338</span></a><span class="sd">                    &quot;data&quot;: {</span>
</span><span id="Store.ReceiveTimeDelta-1339"><a href="#Store.ReceiveTimeDelta-1339"><span class="linenos">1339</span></a><span class="sd">                        &quot;edges&quot;: [</span>
</span><span id="Store.ReceiveTimeDelta-1340"><a href="#Store.ReceiveTimeDelta-1340"><span class="linenos">1340</span></a><span class="sd">                            {</span>
</span><span id="Store.ReceiveTimeDelta-1341"><a href="#Store.ReceiveTimeDelta-1341"><span class="linenos">1341</span></a><span class="sd">                                &quot;node1&quot;: 1,</span>
</span><span id="Store.ReceiveTimeDelta-1342"><a href="#Store.ReceiveTimeDelta-1342"><span class="linenos">1342</span></a><span class="sd">                                &quot;node2&quot;: 2,</span>
</span><span id="Store.ReceiveTimeDelta-1343"><a href="#Store.ReceiveTimeDelta-1343"><span class="linenos">1343</span></a><span class="sd">                                &quot;weight&quot;: 150,</span>
</span><span id="Store.ReceiveTimeDelta-1344"><a href="#Store.ReceiveTimeDelta-1344"><span class="linenos">1344</span></a><span class="sd">                                &quot;fuel_consumption&quot;: 12.5</span>
</span><span id="Store.ReceiveTimeDelta-1345"><a href="#Store.ReceiveTimeDelta-1345"><span class="linenos">1345</span></a><span class="sd">                            },</span>
</span><span id="Store.ReceiveTimeDelta-1346"><a href="#Store.ReceiveTimeDelta-1346"><span class="linenos">1346</span></a><span class="sd">                            ...</span>
</span><span id="Store.ReceiveTimeDelta-1347"><a href="#Store.ReceiveTimeDelta-1347"><span class="linenos">1347</span></a><span class="sd">                        ]</span>
</span><span id="Store.ReceiveTimeDelta-1348"><a href="#Store.ReceiveTimeDelta-1348"><span class="linenos">1348</span></a><span class="sd">                    }</span>
</span><span id="Store.ReceiveTimeDelta-1349"><a href="#Store.ReceiveTimeDelta-1349"><span class="linenos">1349</span></a><span class="sd">                }</span>
</span><span id="Store.ReceiveTimeDelta-1350"><a href="#Store.ReceiveTimeDelta-1350"><span class="linenos">1350</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveTimeDelta-1351"><a href="#Store.ReceiveTimeDelta-1351"><span class="linenos">1351</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveTimeDelta-1352"><a href="#Store.ReceiveTimeDelta-1352"><span class="linenos">1352</span></a><span class="sd">        Attributes:</span>
</span><span id="Store.ReceiveTimeDelta-1353"><a href="#Store.ReceiveTimeDelta-1353"><span class="linenos">1353</span></a><span class="sd">            Inherits from CyclicBehaviour:</span>
</span><span id="Store.ReceiveTimeDelta-1354"><a href="#Store.ReceiveTimeDelta-1354"><span class="linenos">1354</span></a><span class="sd">                - Runs continuously in infinite loop</span>
</span><span id="Store.ReceiveTimeDelta-1355"><a href="#Store.ReceiveTimeDelta-1355"><span class="linenos">1355</span></a><span class="sd">                - Processes one message per cycle</span>
</span><span id="Store.ReceiveTimeDelta-1356"><a href="#Store.ReceiveTimeDelta-1356"><span class="linenos">1356</span></a><span class="sd">                - 20-second timeout per receive attempt</span>
</span><span id="Store.ReceiveTimeDelta-1357"><a href="#Store.ReceiveTimeDelta-1357"><span class="linenos">1357</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveTimeDelta-1358"><a href="#Store.ReceiveTimeDelta-1358"><span class="linenos">1358</span></a><span class="sd">        Workflow:</span>
</span><span id="Store.ReceiveTimeDelta-1359"><a href="#Store.ReceiveTimeDelta-1359"><span class="linenos">1359</span></a><span class="sd">            1. **Receive Message**: Wait up to 20 seconds for inform message</span>
</span><span id="Store.ReceiveTimeDelta-1360"><a href="#Store.ReceiveTimeDelta-1360"><span class="linenos">1360</span></a><span class="sd">            2. **Parse JSON**: Extract type, time delta, and data</span>
</span><span id="Store.ReceiveTimeDelta-1361"><a href="#Store.ReceiveTimeDelta-1361"><span class="linenos">1361</span></a><span class="sd">            3. **Update Time**: Increment current_tick by delta</span>
</span><span id="Store.ReceiveTimeDelta-1362"><a href="#Store.ReceiveTimeDelta-1362"><span class="linenos">1362</span></a><span class="sd">            4. **Check Type**: If type is &quot;Transit&quot;, process traffic updates</span>
</span><span id="Store.ReceiveTimeDelta-1363"><a href="#Store.ReceiveTimeDelta-1363"><span class="linenos">1363</span></a><span class="sd">            5. **Update Graph**: Apply edge weight changes using update_graph()</span>
</span><span id="Store.ReceiveTimeDelta-1364"><a href="#Store.ReceiveTimeDelta-1364"><span class="linenos">1364</span></a><span class="sd">            6. **Repeat**: Return to step 1 (cyclic behaviour)</span>
</span><span id="Store.ReceiveTimeDelta-1365"><a href="#Store.ReceiveTimeDelta-1365"><span class="linenos">1365</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveTimeDelta-1366"><a href="#Store.ReceiveTimeDelta-1366"><span class="linenos">1366</span></a><span class="sd">        Traffic Update Process:</span>
</span><span id="Store.ReceiveTimeDelta-1367"><a href="#Store.ReceiveTimeDelta-1367"><span class="linenos">1367</span></a><span class="sd">            When type=&quot;Transit&quot;:</span>
</span><span id="Store.ReceiveTimeDelta-1368"><a href="#Store.ReceiveTimeDelta-1368"><span class="linenos">1368</span></a><span class="sd">                - Extract edges array from data field</span>
</span><span id="Store.ReceiveTimeDelta-1369"><a href="#Store.ReceiveTimeDelta-1369"><span class="linenos">1369</span></a><span class="sd">                - For each edge: update weight and fuel_consumption</span>
</span><span id="Store.ReceiveTimeDelta-1370"><a href="#Store.ReceiveTimeDelta-1370"><span class="linenos">1370</span></a><span class="sd">                - Uses update_graph() helper method</span>
</span><span id="Store.ReceiveTimeDelta-1371"><a href="#Store.ReceiveTimeDelta-1371"><span class="linenos">1371</span></a><span class="sd">                - Affects pathfinding calculations in warehouse selection</span>
</span><span id="Store.ReceiveTimeDelta-1372"><a href="#Store.ReceiveTimeDelta-1372"><span class="linenos">1372</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveTimeDelta-1373"><a href="#Store.ReceiveTimeDelta-1373"><span class="linenos">1373</span></a><span class="sd">        Example Execution:</span>
</span><span id="Store.ReceiveTimeDelta-1374"><a href="#Store.ReceiveTimeDelta-1374"><span class="linenos">1374</span></a><span class="sd">            ```</span>
</span><span id="Store.ReceiveTimeDelta-1375"><a href="#Store.ReceiveTimeDelta-1375"><span class="linenos">1375</span></a><span class="sd">            Message Received:</span>
</span><span id="Store.ReceiveTimeDelta-1376"><a href="#Store.ReceiveTimeDelta-1376"><span class="linenos">1376</span></a><span class="sd">                {</span>
</span><span id="Store.ReceiveTimeDelta-1377"><a href="#Store.ReceiveTimeDelta-1377"><span class="linenos">1377</span></a><span class="sd">                    &quot;type&quot;: &quot;Transit&quot;,</span>
</span><span id="Store.ReceiveTimeDelta-1378"><a href="#Store.ReceiveTimeDelta-1378"><span class="linenos">1378</span></a><span class="sd">                    &quot;time&quot;: 3,</span>
</span><span id="Store.ReceiveTimeDelta-1379"><a href="#Store.ReceiveTimeDelta-1379"><span class="linenos">1379</span></a><span class="sd">                    &quot;data&quot;: {</span>
</span><span id="Store.ReceiveTimeDelta-1380"><a href="#Store.ReceiveTimeDelta-1380"><span class="linenos">1380</span></a><span class="sd">                        &quot;edges&quot;: [</span>
</span><span id="Store.ReceiveTimeDelta-1381"><a href="#Store.ReceiveTimeDelta-1381"><span class="linenos">1381</span></a><span class="sd">                            {&quot;node1&quot;: 5, &quot;node2&quot;: 10, &quot;weight&quot;: 200, &quot;fuel_consumption&quot;: 15.0}</span>
</span><span id="Store.ReceiveTimeDelta-1382"><a href="#Store.ReceiveTimeDelta-1382"><span class="linenos">1382</span></a><span class="sd">                        ]</span>
</span><span id="Store.ReceiveTimeDelta-1383"><a href="#Store.ReceiveTimeDelta-1383"><span class="linenos">1383</span></a><span class="sd">                    }</span>
</span><span id="Store.ReceiveTimeDelta-1384"><a href="#Store.ReceiveTimeDelta-1384"><span class="linenos">1384</span></a><span class="sd">                }</span>
</span><span id="Store.ReceiveTimeDelta-1385"><a href="#Store.ReceiveTimeDelta-1385"><span class="linenos">1385</span></a><span class="sd">            Processing:</span>
</span><span id="Store.ReceiveTimeDelta-1386"><a href="#Store.ReceiveTimeDelta-1386"><span class="linenos">1386</span></a><span class="sd">                - current_tick: 42 -&gt; 45 (increment by 3)</span>
</span><span id="Store.ReceiveTimeDelta-1387"><a href="#Store.ReceiveTimeDelta-1387"><span class="linenos">1387</span></a><span class="sd">                - Update edge (5, 10): weight=200, fuel=15.0</span>
</span><span id="Store.ReceiveTimeDelta-1388"><a href="#Store.ReceiveTimeDelta-1388"><span class="linenos">1388</span></a><span class="sd">                - Next warehouse selection uses new weights</span>
</span><span id="Store.ReceiveTimeDelta-1389"><a href="#Store.ReceiveTimeDelta-1389"><span class="linenos">1389</span></a><span class="sd">            ```</span>
</span><span id="Store.ReceiveTimeDelta-1390"><a href="#Store.ReceiveTimeDelta-1390"><span class="linenos">1390</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveTimeDelta-1391"><a href="#Store.ReceiveTimeDelta-1391"><span class="linenos">1391</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store.ReceiveTimeDelta-1392"><a href="#Store.ReceiveTimeDelta-1392"><span class="linenos">1392</span></a><span class="sd">            - Increments agent.current_tick (time synchronization)</span>
</span><span id="Store.ReceiveTimeDelta-1393"><a href="#Store.ReceiveTimeDelta-1393"><span class="linenos">1393</span></a><span class="sd">            - Modifies agent.map edge weights (traffic updates)</span>
</span><span id="Store.ReceiveTimeDelta-1394"><a href="#Store.ReceiveTimeDelta-1394"><span class="linenos">1394</span></a><span class="sd">            - Affects future pathfinding and warehouse scoring</span>
</span><span id="Store.ReceiveTimeDelta-1395"><a href="#Store.ReceiveTimeDelta-1395"><span class="linenos">1395</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveTimeDelta-1396"><a href="#Store.ReceiveTimeDelta-1396"><span class="linenos">1396</span></a><span class="sd">        Returns:</span>
</span><span id="Store.ReceiveTimeDelta-1397"><a href="#Store.ReceiveTimeDelta-1397"><span class="linenos">1397</span></a><span class="sd">            Never returns (cyclic behaviour runs until agent stops).</span>
</span><span id="Store.ReceiveTimeDelta-1398"><a href="#Store.ReceiveTimeDelta-1398"><span class="linenos">1398</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveTimeDelta-1399"><a href="#Store.ReceiveTimeDelta-1399"><span class="linenos">1399</span></a><span class="sd">        Note:</span>
</span><span id="Store.ReceiveTimeDelta-1400"><a href="#Store.ReceiveTimeDelta-1400"><span class="linenos">1400</span></a><span class="sd">            The 20-second timeout prevents indefinite blocking if world agent stops</span>
</span><span id="Store.ReceiveTimeDelta-1401"><a href="#Store.ReceiveTimeDelta-1401"><span class="linenos">1401</span></a><span class="sd">            sending updates. This is a safety mechanism for graceful degradation.</span>
</span><span id="Store.ReceiveTimeDelta-1402"><a href="#Store.ReceiveTimeDelta-1402"><span class="linenos">1402</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.ReceiveTimeDelta-1403"><a href="#Store.ReceiveTimeDelta-1403"><span class="linenos">1403</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.ReceiveTimeDelta-1404"><a href="#Store.ReceiveTimeDelta-1404"><span class="linenos">1404</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.ReceiveTimeDelta-1405"><a href="#Store.ReceiveTimeDelta-1405"><span class="linenos">1405</span></a><span class="sd">            Execute one cycle of time delta reception and processing.</span>
</span><span id="Store.ReceiveTimeDelta-1406"><a href="#Store.ReceiveTimeDelta-1406"><span class="linenos">1406</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta-1407"><a href="#Store.ReceiveTimeDelta-1407"><span class="linenos">1407</span></a><span class="sd">            This method receives one time synchronization message, updates the store&#39;s</span>
</span><span id="Store.ReceiveTimeDelta-1408"><a href="#Store.ReceiveTimeDelta-1408"><span class="linenos">1408</span></a><span class="sd">            internal clock, and applies any traffic updates to the graph if present.</span>
</span><span id="Store.ReceiveTimeDelta-1409"><a href="#Store.ReceiveTimeDelta-1409"><span class="linenos">1409</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta-1410"><a href="#Store.ReceiveTimeDelta-1410"><span class="linenos">1410</span></a><span class="sd">            Workflow:</span>
</span><span id="Store.ReceiveTimeDelta-1411"><a href="#Store.ReceiveTimeDelta-1411"><span class="linenos">1411</span></a><span class="sd">                1. **Receive**: Wait up to 20 seconds for inform message</span>
</span><span id="Store.ReceiveTimeDelta-1412"><a href="#Store.ReceiveTimeDelta-1412"><span class="linenos">1412</span></a><span class="sd">                2. **Validation**: Check if message received (not None)</span>
</span><span id="Store.ReceiveTimeDelta-1413"><a href="#Store.ReceiveTimeDelta-1413"><span class="linenos">1413</span></a><span class="sd">                3. **Parse**: Deserialize JSON body</span>
</span><span id="Store.ReceiveTimeDelta-1414"><a href="#Store.ReceiveTimeDelta-1414"><span class="linenos">1414</span></a><span class="sd">                4. **Extract**: Get type, time delta from JSON</span>
</span><span id="Store.ReceiveTimeDelta-1415"><a href="#Store.ReceiveTimeDelta-1415"><span class="linenos">1415</span></a><span class="sd">                5. **Sync Time**: Add delta to current_tick</span>
</span><span id="Store.ReceiveTimeDelta-1416"><a href="#Store.ReceiveTimeDelta-1416"><span class="linenos">1416</span></a><span class="sd">                6. **Check Type**: Test if type is &quot;Transit&quot; (case-insensitive)</span>
</span><span id="Store.ReceiveTimeDelta-1417"><a href="#Store.ReceiveTimeDelta-1417"><span class="linenos">1417</span></a><span class="sd">                7. **Update Graph**: If Transit, apply edge changes via update_graph()</span>
</span><span id="Store.ReceiveTimeDelta-1418"><a href="#Store.ReceiveTimeDelta-1418"><span class="linenos">1418</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta-1419"><a href="#Store.ReceiveTimeDelta-1419"><span class="linenos">1419</span></a><span class="sd">            Time Synchronization:</span>
</span><span id="Store.ReceiveTimeDelta-1420"><a href="#Store.ReceiveTimeDelta-1420"><span class="linenos">1420</span></a><span class="sd">                Every message (regardless of type) causes time advancement:</span>
</span><span id="Store.ReceiveTimeDelta-1421"><a href="#Store.ReceiveTimeDelta-1421"><span class="linenos">1421</span></a><span class="sd">                - current_tick += delta</span>
</span><span id="Store.ReceiveTimeDelta-1422"><a href="#Store.ReceiveTimeDelta-1422"><span class="linenos">1422</span></a><span class="sd">                - Keeps store synchronized with global simulation time</span>
</span><span id="Store.ReceiveTimeDelta-1423"><a href="#Store.ReceiveTimeDelta-1423"><span class="linenos">1423</span></a><span class="sd">                - Used for order timing statistics</span>
</span><span id="Store.ReceiveTimeDelta-1424"><a href="#Store.ReceiveTimeDelta-1424"><span class="linenos">1424</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta-1425"><a href="#Store.ReceiveTimeDelta-1425"><span class="linenos">1425</span></a><span class="sd">            Traffic Updates:</span>
</span><span id="Store.ReceiveTimeDelta-1426"><a href="#Store.ReceiveTimeDelta-1426"><span class="linenos">1426</span></a><span class="sd">                Only Transit messages include graph updates:</span>
</span><span id="Store.ReceiveTimeDelta-1427"><a href="#Store.ReceiveTimeDelta-1427"><span class="linenos">1427</span></a><span class="sd">                - data.edges contains array of edge changes</span>
</span><span id="Store.ReceiveTimeDelta-1428"><a href="#Store.ReceiveTimeDelta-1428"><span class="linenos">1428</span></a><span class="sd">                - Each edge: node1, node2, new weight, fuel_consumption</span>
</span><span id="Store.ReceiveTimeDelta-1429"><a href="#Store.ReceiveTimeDelta-1429"><span class="linenos">1429</span></a><span class="sd">                - Calls update_graph() to apply changes atomically</span>
</span><span id="Store.ReceiveTimeDelta-1430"><a href="#Store.ReceiveTimeDelta-1430"><span class="linenos">1430</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta-1431"><a href="#Store.ReceiveTimeDelta-1431"><span class="linenos">1431</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.ReceiveTimeDelta-1432"><a href="#Store.ReceiveTimeDelta-1432"><span class="linenos">1432</span></a><span class="sd">                - Always increments agent.current_tick</span>
</span><span id="Store.ReceiveTimeDelta-1433"><a href="#Store.ReceiveTimeDelta-1433"><span class="linenos">1433</span></a><span class="sd">                - Conditionally modifies agent.map (if Transit message)</span>
</span><span id="Store.ReceiveTimeDelta-1434"><a href="#Store.ReceiveTimeDelta-1434"><span class="linenos">1434</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta-1435"><a href="#Store.ReceiveTimeDelta-1435"><span class="linenos">1435</span></a><span class="sd">            Returns:</span>
</span><span id="Store.ReceiveTimeDelta-1436"><a href="#Store.ReceiveTimeDelta-1436"><span class="linenos">1436</span></a><span class="sd">                None. Continues to next cycle after processing one message.</span>
</span><span id="Store.ReceiveTimeDelta-1437"><a href="#Store.ReceiveTimeDelta-1437"><span class="linenos">1437</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta-1438"><a href="#Store.ReceiveTimeDelta-1438"><span class="linenos">1438</span></a><span class="sd">            Example:</span>
</span><span id="Store.ReceiveTimeDelta-1439"><a href="#Store.ReceiveTimeDelta-1439"><span class="linenos">1439</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveTimeDelta-1440"><a href="#Store.ReceiveTimeDelta-1440"><span class="linenos">1440</span></a><span class="sd">                Input: {&quot;type&quot;: &quot;Transit&quot;, &quot;time&quot;: 2, &quot;data&quot;: {&quot;edges&quot;: [...]}}</span>
</span><span id="Store.ReceiveTimeDelta-1441"><a href="#Store.ReceiveTimeDelta-1441"><span class="linenos">1441</span></a><span class="sd">                Effect:</span>
</span><span id="Store.ReceiveTimeDelta-1442"><a href="#Store.ReceiveTimeDelta-1442"><span class="linenos">1442</span></a><span class="sd">                    - current_tick: 100 -&gt; 102</span>
</span><span id="Store.ReceiveTimeDelta-1443"><a href="#Store.ReceiveTimeDelta-1443"><span class="linenos">1443</span></a><span class="sd">                    - Graph edges updated with new weights</span>
</span><span id="Store.ReceiveTimeDelta-1444"><a href="#Store.ReceiveTimeDelta-1444"><span class="linenos">1444</span></a><span class="sd">                Next Cycle: Wait for next message</span>
</span><span id="Store.ReceiveTimeDelta-1445"><a href="#Store.ReceiveTimeDelta-1445"><span class="linenos">1445</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveTimeDelta-1446"><a href="#Store.ReceiveTimeDelta-1446"><span class="linenos">1446</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.ReceiveTimeDelta-1447"><a href="#Store.ReceiveTimeDelta-1447"><span class="linenos">1447</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.ReceiveTimeDelta-1448"><a href="#Store.ReceiveTimeDelta-1448"><span class="linenos">1448</span></a>            
</span><span id="Store.ReceiveTimeDelta-1449"><a href="#Store.ReceiveTimeDelta-1449"><span class="linenos">1449</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Store.ReceiveTimeDelta-1450"><a href="#Store.ReceiveTimeDelta-1450"><span class="linenos">1450</span></a>            
</span><span id="Store.ReceiveTimeDelta-1451"><a href="#Store.ReceiveTimeDelta-1451"><span class="linenos">1451</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store.ReceiveTimeDelta-1452"><a href="#Store.ReceiveTimeDelta-1452"><span class="linenos">1452</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Store.ReceiveTimeDelta-1453"><a href="#Store.ReceiveTimeDelta-1453"><span class="linenos">1453</span></a>                
</span><span id="Store.ReceiveTimeDelta-1454"><a href="#Store.ReceiveTimeDelta-1454"><span class="linenos">1454</span></a>                <span class="nb">type</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="Store.ReceiveTimeDelta-1455"><a href="#Store.ReceiveTimeDelta-1455"><span class="linenos">1455</span></a>                <span class="n">delta</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
</span><span id="Store.ReceiveTimeDelta-1456"><a href="#Store.ReceiveTimeDelta-1456"><span class="linenos">1456</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="Store.ReceiveTimeDelta-1457"><a href="#Store.ReceiveTimeDelta-1457"><span class="linenos">1457</span></a>                
</span><span id="Store.ReceiveTimeDelta-1458"><a href="#Store.ReceiveTimeDelta-1458"><span class="linenos">1458</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;transit&quot;</span><span class="p">:</span>
</span><span id="Store.ReceiveTimeDelta-1459"><a href="#Store.ReceiveTimeDelta-1459"><span class="linenos">1459</span></a>                    <span class="n">map_updates</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="Store.ReceiveTimeDelta-1460"><a href="#Store.ReceiveTimeDelta-1460"><span class="linenos">1460</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">update_graph</span><span class="p">(</span><span class="n">map_updates</span><span class="p">)</span>         
</span></pre></div>


            <div class="docstring"><p>Cyclic behaviour that processes simulation time updates and traffic information.</p>

<p>This behaviour listens for time synchronization messages from the world agent,
updating the store's internal clock and applying dynamic traffic changes to the
graph. It implements an event-driven architecture where the world agent controls
simulation time progression.</p>

<h6 id="message-types-processed">Message Types Processed:</h6>

<blockquote>
  <ol>
  <li><p><strong>Time Updates</strong> (all messages):</p>
  
  <ul>
  <li>Updates agent.current_tick with time delta</li>
  <li>Synchronizes store with global simulation time</li>
  </ul></li>
  <li><p><strong>Traffic Updates</strong> (type="Transit"):</p>
  
  <ul>
  <li>Applies dynamic edge weight changes to graph</li>
  <li>Updates fuel consumption values for routes</li>
  <li>Reflects real-time traffic conditions</li>
  </ul></li>
  </ol>
</blockquote>

<h6 id="message-format">Message Format:</h6>

<blockquote>
  <p>Metadata:
      - performative: "inform"
  Body (JSON):</p>
  
  <p><div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Transit&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// or other types</span>
<span class="w">    </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">          </span><span class="c1">// delta in ticks</span>
<span class="w">    </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;edges&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;node1&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;node2&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;weight&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">150</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;fuel_consumption&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">12.5</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="err">...</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div></p>
</blockquote>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>Inherits from CyclicBehaviour:</strong>  - Runs continuously in infinite loop
<ul>
<li>Processes one message per cycle</li>
<li>20-second timeout per receive attempt</li>
</ul></li>
</ul>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Receive Message</strong>: Wait up to 20 seconds for inform message</li>
  <li><strong>Parse JSON</strong>: Extract type, time delta, and data</li>
  <li><strong>Update Time</strong>: Increment current_tick by delta</li>
  <li><strong>Check Type</strong>: If type is "Transit", process traffic updates</li>
  <li><strong>Update Graph</strong>: Apply edge weight changes using update_graph()</li>
  <li><strong>Repeat</strong>: Return to step 1 (cyclic behaviour)</li>
  </ol>
</blockquote>

<h6 id="traffic-update-process">Traffic Update Process:</h6>

<blockquote>
  <p>When type="Transit":
      - Extract edges array from data field
      - For each edge: update weight and fuel_consumption
      - Uses update_graph() helper method
      - Affects pathfinding calculations in warehouse selection</p>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
<pre><code>Message Received:
    {
        "type": "Transit",
        "time": 3,
        "data": {
            "edges": [
                {"node1": 5, "node2": 10, "weight": 200, "fuel_consumption": 15.0}
            ]
        }
    }
Processing:
    - current_tick: 42 -&gt; 45 (increment by 3)
    - Update edge (5, 10): weight=200, fuel=15.0
    - Next warehouse selection uses new weights
</code></pre>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Increments agent.current_tick (time synchronization)</li>
  <li>Modifies agent.map edge weights (traffic updates)</li>
  <li>Affects future pathfinding and warehouse scoring</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Never returns (cyclic behaviour runs until agent stops).</p>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>The 20-second timeout prevents indefinite blocking if world agent stops
  sending updates. This is a safety mechanism for graceful degradation.</p>
</blockquote>
</div>


                            <div id="Store.ReceiveTimeDelta.run" class="classattr">
                                        <input id="Store.ReceiveTimeDelta.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Store.ReceiveTimeDelta.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.ReceiveTimeDelta.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.ReceiveTimeDelta.run-1403"><a href="#Store.ReceiveTimeDelta.run-1403"><span class="linenos">1403</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.ReceiveTimeDelta.run-1404"><a href="#Store.ReceiveTimeDelta.run-1404"><span class="linenos">1404</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.ReceiveTimeDelta.run-1405"><a href="#Store.ReceiveTimeDelta.run-1405"><span class="linenos">1405</span></a><span class="sd">            Execute one cycle of time delta reception and processing.</span>
</span><span id="Store.ReceiveTimeDelta.run-1406"><a href="#Store.ReceiveTimeDelta.run-1406"><span class="linenos">1406</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta.run-1407"><a href="#Store.ReceiveTimeDelta.run-1407"><span class="linenos">1407</span></a><span class="sd">            This method receives one time synchronization message, updates the store&#39;s</span>
</span><span id="Store.ReceiveTimeDelta.run-1408"><a href="#Store.ReceiveTimeDelta.run-1408"><span class="linenos">1408</span></a><span class="sd">            internal clock, and applies any traffic updates to the graph if present.</span>
</span><span id="Store.ReceiveTimeDelta.run-1409"><a href="#Store.ReceiveTimeDelta.run-1409"><span class="linenos">1409</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta.run-1410"><a href="#Store.ReceiveTimeDelta.run-1410"><span class="linenos">1410</span></a><span class="sd">            Workflow:</span>
</span><span id="Store.ReceiveTimeDelta.run-1411"><a href="#Store.ReceiveTimeDelta.run-1411"><span class="linenos">1411</span></a><span class="sd">                1. **Receive**: Wait up to 20 seconds for inform message</span>
</span><span id="Store.ReceiveTimeDelta.run-1412"><a href="#Store.ReceiveTimeDelta.run-1412"><span class="linenos">1412</span></a><span class="sd">                2. **Validation**: Check if message received (not None)</span>
</span><span id="Store.ReceiveTimeDelta.run-1413"><a href="#Store.ReceiveTimeDelta.run-1413"><span class="linenos">1413</span></a><span class="sd">                3. **Parse**: Deserialize JSON body</span>
</span><span id="Store.ReceiveTimeDelta.run-1414"><a href="#Store.ReceiveTimeDelta.run-1414"><span class="linenos">1414</span></a><span class="sd">                4. **Extract**: Get type, time delta from JSON</span>
</span><span id="Store.ReceiveTimeDelta.run-1415"><a href="#Store.ReceiveTimeDelta.run-1415"><span class="linenos">1415</span></a><span class="sd">                5. **Sync Time**: Add delta to current_tick</span>
</span><span id="Store.ReceiveTimeDelta.run-1416"><a href="#Store.ReceiveTimeDelta.run-1416"><span class="linenos">1416</span></a><span class="sd">                6. **Check Type**: Test if type is &quot;Transit&quot; (case-insensitive)</span>
</span><span id="Store.ReceiveTimeDelta.run-1417"><a href="#Store.ReceiveTimeDelta.run-1417"><span class="linenos">1417</span></a><span class="sd">                7. **Update Graph**: If Transit, apply edge changes via update_graph()</span>
</span><span id="Store.ReceiveTimeDelta.run-1418"><a href="#Store.ReceiveTimeDelta.run-1418"><span class="linenos">1418</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta.run-1419"><a href="#Store.ReceiveTimeDelta.run-1419"><span class="linenos">1419</span></a><span class="sd">            Time Synchronization:</span>
</span><span id="Store.ReceiveTimeDelta.run-1420"><a href="#Store.ReceiveTimeDelta.run-1420"><span class="linenos">1420</span></a><span class="sd">                Every message (regardless of type) causes time advancement:</span>
</span><span id="Store.ReceiveTimeDelta.run-1421"><a href="#Store.ReceiveTimeDelta.run-1421"><span class="linenos">1421</span></a><span class="sd">                - current_tick += delta</span>
</span><span id="Store.ReceiveTimeDelta.run-1422"><a href="#Store.ReceiveTimeDelta.run-1422"><span class="linenos">1422</span></a><span class="sd">                - Keeps store synchronized with global simulation time</span>
</span><span id="Store.ReceiveTimeDelta.run-1423"><a href="#Store.ReceiveTimeDelta.run-1423"><span class="linenos">1423</span></a><span class="sd">                - Used for order timing statistics</span>
</span><span id="Store.ReceiveTimeDelta.run-1424"><a href="#Store.ReceiveTimeDelta.run-1424"><span class="linenos">1424</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta.run-1425"><a href="#Store.ReceiveTimeDelta.run-1425"><span class="linenos">1425</span></a><span class="sd">            Traffic Updates:</span>
</span><span id="Store.ReceiveTimeDelta.run-1426"><a href="#Store.ReceiveTimeDelta.run-1426"><span class="linenos">1426</span></a><span class="sd">                Only Transit messages include graph updates:</span>
</span><span id="Store.ReceiveTimeDelta.run-1427"><a href="#Store.ReceiveTimeDelta.run-1427"><span class="linenos">1427</span></a><span class="sd">                - data.edges contains array of edge changes</span>
</span><span id="Store.ReceiveTimeDelta.run-1428"><a href="#Store.ReceiveTimeDelta.run-1428"><span class="linenos">1428</span></a><span class="sd">                - Each edge: node1, node2, new weight, fuel_consumption</span>
</span><span id="Store.ReceiveTimeDelta.run-1429"><a href="#Store.ReceiveTimeDelta.run-1429"><span class="linenos">1429</span></a><span class="sd">                - Calls update_graph() to apply changes atomically</span>
</span><span id="Store.ReceiveTimeDelta.run-1430"><a href="#Store.ReceiveTimeDelta.run-1430"><span class="linenos">1430</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta.run-1431"><a href="#Store.ReceiveTimeDelta.run-1431"><span class="linenos">1431</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.ReceiveTimeDelta.run-1432"><a href="#Store.ReceiveTimeDelta.run-1432"><span class="linenos">1432</span></a><span class="sd">                - Always increments agent.current_tick</span>
</span><span id="Store.ReceiveTimeDelta.run-1433"><a href="#Store.ReceiveTimeDelta.run-1433"><span class="linenos">1433</span></a><span class="sd">                - Conditionally modifies agent.map (if Transit message)</span>
</span><span id="Store.ReceiveTimeDelta.run-1434"><a href="#Store.ReceiveTimeDelta.run-1434"><span class="linenos">1434</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta.run-1435"><a href="#Store.ReceiveTimeDelta.run-1435"><span class="linenos">1435</span></a><span class="sd">            Returns:</span>
</span><span id="Store.ReceiveTimeDelta.run-1436"><a href="#Store.ReceiveTimeDelta.run-1436"><span class="linenos">1436</span></a><span class="sd">                None. Continues to next cycle after processing one message.</span>
</span><span id="Store.ReceiveTimeDelta.run-1437"><a href="#Store.ReceiveTimeDelta.run-1437"><span class="linenos">1437</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveTimeDelta.run-1438"><a href="#Store.ReceiveTimeDelta.run-1438"><span class="linenos">1438</span></a><span class="sd">            Example:</span>
</span><span id="Store.ReceiveTimeDelta.run-1439"><a href="#Store.ReceiveTimeDelta.run-1439"><span class="linenos">1439</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveTimeDelta.run-1440"><a href="#Store.ReceiveTimeDelta.run-1440"><span class="linenos">1440</span></a><span class="sd">                Input: {&quot;type&quot;: &quot;Transit&quot;, &quot;time&quot;: 2, &quot;data&quot;: {&quot;edges&quot;: [...]}}</span>
</span><span id="Store.ReceiveTimeDelta.run-1441"><a href="#Store.ReceiveTimeDelta.run-1441"><span class="linenos">1441</span></a><span class="sd">                Effect:</span>
</span><span id="Store.ReceiveTimeDelta.run-1442"><a href="#Store.ReceiveTimeDelta.run-1442"><span class="linenos">1442</span></a><span class="sd">                    - current_tick: 100 -&gt; 102</span>
</span><span id="Store.ReceiveTimeDelta.run-1443"><a href="#Store.ReceiveTimeDelta.run-1443"><span class="linenos">1443</span></a><span class="sd">                    - Graph edges updated with new weights</span>
</span><span id="Store.ReceiveTimeDelta.run-1444"><a href="#Store.ReceiveTimeDelta.run-1444"><span class="linenos">1444</span></a><span class="sd">                Next Cycle: Wait for next message</span>
</span><span id="Store.ReceiveTimeDelta.run-1445"><a href="#Store.ReceiveTimeDelta.run-1445"><span class="linenos">1445</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveTimeDelta.run-1446"><a href="#Store.ReceiveTimeDelta.run-1446"><span class="linenos">1446</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.ReceiveTimeDelta.run-1447"><a href="#Store.ReceiveTimeDelta.run-1447"><span class="linenos">1447</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.ReceiveTimeDelta.run-1448"><a href="#Store.ReceiveTimeDelta.run-1448"><span class="linenos">1448</span></a>            
</span><span id="Store.ReceiveTimeDelta.run-1449"><a href="#Store.ReceiveTimeDelta.run-1449"><span class="linenos">1449</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Store.ReceiveTimeDelta.run-1450"><a href="#Store.ReceiveTimeDelta.run-1450"><span class="linenos">1450</span></a>            
</span><span id="Store.ReceiveTimeDelta.run-1451"><a href="#Store.ReceiveTimeDelta.run-1451"><span class="linenos">1451</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Store.ReceiveTimeDelta.run-1452"><a href="#Store.ReceiveTimeDelta.run-1452"><span class="linenos">1452</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Store.ReceiveTimeDelta.run-1453"><a href="#Store.ReceiveTimeDelta.run-1453"><span class="linenos">1453</span></a>                
</span><span id="Store.ReceiveTimeDelta.run-1454"><a href="#Store.ReceiveTimeDelta.run-1454"><span class="linenos">1454</span></a>                <span class="nb">type</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="Store.ReceiveTimeDelta.run-1455"><a href="#Store.ReceiveTimeDelta.run-1455"><span class="linenos">1455</span></a>                <span class="n">delta</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
</span><span id="Store.ReceiveTimeDelta.run-1456"><a href="#Store.ReceiveTimeDelta.run-1456"><span class="linenos">1456</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="Store.ReceiveTimeDelta.run-1457"><a href="#Store.ReceiveTimeDelta.run-1457"><span class="linenos">1457</span></a>                
</span><span id="Store.ReceiveTimeDelta.run-1458"><a href="#Store.ReceiveTimeDelta.run-1458"><span class="linenos">1458</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;transit&quot;</span><span class="p">:</span>
</span><span id="Store.ReceiveTimeDelta.run-1459"><a href="#Store.ReceiveTimeDelta.run-1459"><span class="linenos">1459</span></a>                    <span class="n">map_updates</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="Store.ReceiveTimeDelta.run-1460"><a href="#Store.ReceiveTimeDelta.run-1460"><span class="linenos">1460</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">update_graph</span><span class="p">(</span><span class="n">map_updates</span><span class="p">)</span>         
</span></pre></div>


            <div class="docstring"><p>Execute one cycle of time delta reception and processing.</p>

<p>This method receives one time synchronization message, updates the store's
internal clock, and applies any traffic updates to the graph if present.</p>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Receive</strong>: Wait up to 20 seconds for inform message</li>
  <li><strong>Validation</strong>: Check if message received (not None)</li>
  <li><strong>Parse</strong>: Deserialize JSON body</li>
  <li><strong>Extract</strong>: Get type, time delta from JSON</li>
  <li><strong>Sync Time</strong>: Add delta to current_tick</li>
  <li><strong>Check Type</strong>: Test if type is "Transit" (case-insensitive)</li>
  <li><strong>Update Graph</strong>: If Transit, apply edge changes via update_graph()</li>
  </ol>
</blockquote>

<h6 id="time-synchronization">Time Synchronization:</h6>

<blockquote>
  <p>Every message (regardless of type) causes time advancement:</p>
  
  <ul>
  <li>current_tick += delta</li>
  <li>Keeps store synchronized with global simulation time</li>
  <li>Used for order timing statistics</li>
  </ul>
</blockquote>

<h6 id="traffic-updates">Traffic Updates:</h6>

<blockquote>
  <p>Only Transit messages include graph updates:</p>
  
  <ul>
  <li>data.edges contains array of edge changes</li>
  <li>Each edge: node1, node2, new weight, fuel_consumption</li>
  <li>Calls update_graph() to apply changes atomically</li>
  </ul>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Always increments agent.current_tick</li>
  <li>Conditionally modifies agent.map (if Transit message)</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Continues to next cycle after processing one message.</p>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
<pre><code>Input: {"type": "Transit", "time": 2, "data": {"edges": [...]}}
Effect:
    - current_tick: 100 -&gt; 102
    - Graph edges updated with new weights
Next Cycle: Wait for next message
</code></pre>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Store.ReceiveVehicleArrival">
                            <input id="Store.ReceiveVehicleArrival-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Store.ReceiveVehicleArrival</span><wbr>(<span class="base">spade.behaviour.CyclicBehaviour</span>):

                <label class="view-source-button" for="Store.ReceiveVehicleArrival-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.ReceiveVehicleArrival"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.ReceiveVehicleArrival-1462"><a href="#Store.ReceiveVehicleArrival-1462"><span class="linenos">1462</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveVehicleArrival</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="Store.ReceiveVehicleArrival-1463"><a href="#Store.ReceiveVehicleArrival-1463"><span class="linenos">1463</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.ReceiveVehicleArrival-1464"><a href="#Store.ReceiveVehicleArrival-1464"><span class="linenos">1464</span></a><span class="sd">        Cyclic behaviour that handles vehicle delivery notifications.</span>
</span><span id="Store.ReceiveVehicleArrival-1465"><a href="#Store.ReceiveVehicleArrival-1465"><span class="linenos">1465</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1466"><a href="#Store.ReceiveVehicleArrival-1466"><span class="linenos">1466</span></a><span class="sd">        This behaviour processes delivery completion messages from vehicle agents,</span>
</span><span id="Store.ReceiveVehicleArrival-1467"><a href="#Store.ReceiveVehicleArrival-1467"><span class="linenos">1467</span></a><span class="sd">        updating inventory when products arrive at the store. It represents the final</span>
</span><span id="Store.ReceiveVehicleArrival-1468"><a href="#Store.ReceiveVehicleArrival-1468"><span class="linenos">1468</span></a><span class="sd">        step in the supply chain: physical delivery and stock replenishment.</span>
</span><span id="Store.ReceiveVehicleArrival-1469"><a href="#Store.ReceiveVehicleArrival-1469"><span class="linenos">1469</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1470"><a href="#Store.ReceiveVehicleArrival-1470"><span class="linenos">1470</span></a><span class="sd">        Message Types Accepted:</span>
</span><span id="Store.ReceiveVehicleArrival-1471"><a href="#Store.ReceiveVehicleArrival-1471"><span class="linenos">1471</span></a><span class="sd">            - **vehicle-delivery**: Vehicle completed delivery to store (primary)</span>
</span><span id="Store.ReceiveVehicleArrival-1472"><a href="#Store.ReceiveVehicleArrival-1472"><span class="linenos">1472</span></a><span class="sd">            - **vehicle-pickup**: Vehicle picked up goods from warehouse (informational)</span>
</span><span id="Store.ReceiveVehicleArrival-1473"><a href="#Store.ReceiveVehicleArrival-1473"><span class="linenos">1473</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1474"><a href="#Store.ReceiveVehicleArrival-1474"><span class="linenos">1474</span></a><span class="sd">        The behaviour is filtered by template to only receive vehicle-delivery messages,</span>
</span><span id="Store.ReceiveVehicleArrival-1475"><a href="#Store.ReceiveVehicleArrival-1475"><span class="linenos">1475</span></a><span class="sd">        but includes validation as a safety mechanism.</span>
</span><span id="Store.ReceiveVehicleArrival-1476"><a href="#Store.ReceiveVehicleArrival-1476"><span class="linenos">1476</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1477"><a href="#Store.ReceiveVehicleArrival-1477"><span class="linenos">1477</span></a><span class="sd">        Message Format:</span>
</span><span id="Store.ReceiveVehicleArrival-1478"><a href="#Store.ReceiveVehicleArrival-1478"><span class="linenos">1478</span></a><span class="sd">            Metadata:</span>
</span><span id="Store.ReceiveVehicleArrival-1479"><a href="#Store.ReceiveVehicleArrival-1479"><span class="linenos">1479</span></a><span class="sd">                - performative: &quot;vehicle-delivery&quot;</span>
</span><span id="Store.ReceiveVehicleArrival-1480"><a href="#Store.ReceiveVehicleArrival-1480"><span class="linenos">1480</span></a><span class="sd">                - sender: Vehicle JID</span>
</span><span id="Store.ReceiveVehicleArrival-1481"><a href="#Store.ReceiveVehicleArrival-1481"><span class="linenos">1481</span></a><span class="sd">            Body (JSON):</span>
</span><span id="Store.ReceiveVehicleArrival-1482"><a href="#Store.ReceiveVehicleArrival-1482"><span class="linenos">1482</span></a><span class="sd">                ```json</span>
</span><span id="Store.ReceiveVehicleArrival-1483"><a href="#Store.ReceiveVehicleArrival-1483"><span class="linenos">1483</span></a><span class="sd">                {</span>
</span><span id="Store.ReceiveVehicleArrival-1484"><a href="#Store.ReceiveVehicleArrival-1484"><span class="linenos">1484</span></a><span class="sd">                    &quot;orderid&quot;: 1001000000,  // Unique order identifier</span>
</span><span id="Store.ReceiveVehicleArrival-1485"><a href="#Store.ReceiveVehicleArrival-1485"><span class="linenos">1485</span></a><span class="sd">                    &quot;time&quot;: 150             // ETA or delivery time</span>
</span><span id="Store.ReceiveVehicleArrival-1486"><a href="#Store.ReceiveVehicleArrival-1486"><span class="linenos">1486</span></a><span class="sd">                }</span>
</span><span id="Store.ReceiveVehicleArrival-1487"><a href="#Store.ReceiveVehicleArrival-1487"><span class="linenos">1487</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveVehicleArrival-1488"><a href="#Store.ReceiveVehicleArrival-1488"><span class="linenos">1488</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1489"><a href="#Store.ReceiveVehicleArrival-1489"><span class="linenos">1489</span></a><span class="sd">        Attributes:</span>
</span><span id="Store.ReceiveVehicleArrival-1490"><a href="#Store.ReceiveVehicleArrival-1490"><span class="linenos">1490</span></a><span class="sd">            Inherits from CyclicBehaviour:</span>
</span><span id="Store.ReceiveVehicleArrival-1491"><a href="#Store.ReceiveVehicleArrival-1491"><span class="linenos">1491</span></a><span class="sd">                - Runs continuously in infinite loop</span>
</span><span id="Store.ReceiveVehicleArrival-1492"><a href="#Store.ReceiveVehicleArrival-1492"><span class="linenos">1492</span></a><span class="sd">                - Processes one message per cycle</span>
</span><span id="Store.ReceiveVehicleArrival-1493"><a href="#Store.ReceiveVehicleArrival-1493"><span class="linenos">1493</span></a><span class="sd">                - 20-second timeout per receive attempt</span>
</span><span id="Store.ReceiveVehicleArrival-1494"><a href="#Store.ReceiveVehicleArrival-1494"><span class="linenos">1494</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1495"><a href="#Store.ReceiveVehicleArrival-1495"><span class="linenos">1495</span></a><span class="sd">        Workflow:</span>
</span><span id="Store.ReceiveVehicleArrival-1496"><a href="#Store.ReceiveVehicleArrival-1496"><span class="linenos">1496</span></a><span class="sd">            1. **Receive Message**: Wait up to 20 seconds for vehicle-delivery</span>
</span><span id="Store.ReceiveVehicleArrival-1497"><a href="#Store.ReceiveVehicleArrival-1497"><span class="linenos">1497</span></a><span class="sd">            2. **Validate Performative**: Verify it&#39;s vehicle-delivery (should be filtered)</span>
</span><span id="Store.ReceiveVehicleArrival-1498"><a href="#Store.ReceiveVehicleArrival-1498"><span class="linenos">1498</span></a><span class="sd">            3. **Parse JSON**: Extract orderid and time (ETA)</span>
</span><span id="Store.ReceiveVehicleArrival-1499"><a href="#Store.ReceiveVehicleArrival-1499"><span class="linenos">1499</span></a><span class="sd">            4. **Lookup Order**: Find order in pending_deliveries by orderid</span>
</span><span id="Store.ReceiveVehicleArrival-1500"><a href="#Store.ReceiveVehicleArrival-1500"><span class="linenos">1500</span></a><span class="sd">            5. **Update Stock**: Add delivered quantity to inventory</span>
</span><span id="Store.ReceiveVehicleArrival-1501"><a href="#Store.ReceiveVehicleArrival-1501"><span class="linenos">1501</span></a><span class="sd">            6. **Remove Pending**: Delete order from pending_deliveries</span>
</span><span id="Store.ReceiveVehicleArrival-1502"><a href="#Store.ReceiveVehicleArrival-1502"><span class="linenos">1502</span></a><span class="sd">            7. **Record Statistics**: Save delivery data to CSV</span>
</span><span id="Store.ReceiveVehicleArrival-1503"><a href="#Store.ReceiveVehicleArrival-1503"><span class="linenos">1503</span></a><span class="sd">            8. **Log Delivery**: Print confirmation and current stock</span>
</span><span id="Store.ReceiveVehicleArrival-1504"><a href="#Store.ReceiveVehicleArrival-1504"><span class="linenos">1504</span></a><span class="sd">            9. **Repeat**: Return to step 1 (cyclic behaviour)</span>
</span><span id="Store.ReceiveVehicleArrival-1505"><a href="#Store.ReceiveVehicleArrival-1505"><span class="linenos">1505</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1506"><a href="#Store.ReceiveVehicleArrival-1506"><span class="linenos">1506</span></a><span class="sd">        Stock Update Logic:</span>
</span><span id="Store.ReceiveVehicleArrival-1507"><a href="#Store.ReceiveVehicleArrival-1507"><span class="linenos">1507</span></a><span class="sd">            ```python</span>
</span><span id="Store.ReceiveVehicleArrival-1508"><a href="#Store.ReceiveVehicleArrival-1508"><span class="linenos">1508</span></a><span class="sd">            if product in stock:</span>
</span><span id="Store.ReceiveVehicleArrival-1509"><a href="#Store.ReceiveVehicleArrival-1509"><span class="linenos">1509</span></a><span class="sd">                stock[product] += quantity  # Increment existing</span>
</span><span id="Store.ReceiveVehicleArrival-1510"><a href="#Store.ReceiveVehicleArrival-1510"><span class="linenos">1510</span></a><span class="sd">            else:</span>
</span><span id="Store.ReceiveVehicleArrival-1511"><a href="#Store.ReceiveVehicleArrival-1511"><span class="linenos">1511</span></a><span class="sd">                stock[product] = quantity   # Create new entry</span>
</span><span id="Store.ReceiveVehicleArrival-1512"><a href="#Store.ReceiveVehicleArrival-1512"><span class="linenos">1512</span></a><span class="sd">            ```</span>
</span><span id="Store.ReceiveVehicleArrival-1513"><a href="#Store.ReceiveVehicleArrival-1513"><span class="linenos">1513</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1514"><a href="#Store.ReceiveVehicleArrival-1514"><span class="linenos">1514</span></a><span class="sd">        Statistics Recorded:</span>
</span><span id="Store.ReceiveVehicleArrival-1515"><a href="#Store.ReceiveVehicleArrival-1515"><span class="linenos">1515</span></a><span class="sd">            - order_id: Unique identifier</span>
</span><span id="Store.ReceiveVehicleArrival-1516"><a href="#Store.ReceiveVehicleArrival-1516"><span class="linenos">1516</span></a><span class="sd">            - store_jid: This store&#39;s identifier</span>
</span><span id="Store.ReceiveVehicleArrival-1517"><a href="#Store.ReceiveVehicleArrival-1517"><span class="linenos">1517</span></a><span class="sd">            - vehicle_jid: Delivering vehicle identifier</span>
</span><span id="Store.ReceiveVehicleArrival-1518"><a href="#Store.ReceiveVehicleArrival-1518"><span class="linenos">1518</span></a><span class="sd">            - origin_warehouse: Warehouse that fulfilled order</span>
</span><span id="Store.ReceiveVehicleArrival-1519"><a href="#Store.ReceiveVehicleArrival-1519"><span class="linenos">1519</span></a><span class="sd">            - product: Product name</span>
</span><span id="Store.ReceiveVehicleArrival-1520"><a href="#Store.ReceiveVehicleArrival-1520"><span class="linenos">1520</span></a><span class="sd">            - quantity: Amount delivered</span>
</span><span id="Store.ReceiveVehicleArrival-1521"><a href="#Store.ReceiveVehicleArrival-1521"><span class="linenos">1521</span></a><span class="sd">            - ETA: Estimated time of arrival</span>
</span><span id="Store.ReceiveVehicleArrival-1522"><a href="#Store.ReceiveVehicleArrival-1522"><span class="linenos">1522</span></a><span class="sd">            - time_to_delivery: Ticks from confirmation to delivery</span>
</span><span id="Store.ReceiveVehicleArrival-1523"><a href="#Store.ReceiveVehicleArrival-1523"><span class="linenos">1523</span></a><span class="sd">            - current_tick: Current simulation time</span>
</span><span id="Store.ReceiveVehicleArrival-1524"><a href="#Store.ReceiveVehicleArrival-1524"><span class="linenos">1524</span></a><span class="sd">            - final_state: &quot;delivered&quot; (success indicator)</span>
</span><span id="Store.ReceiveVehicleArrival-1525"><a href="#Store.ReceiveVehicleArrival-1525"><span class="linenos">1525</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1526"><a href="#Store.ReceiveVehicleArrival-1526"><span class="linenos">1526</span></a><span class="sd">        Error Handling:</span>
</span><span id="Store.ReceiveVehicleArrival-1527"><a href="#Store.ReceiveVehicleArrival-1527"><span class="linenos">1527</span></a><span class="sd">            - **Wrong Performative**: Prints ERROR and returns early</span>
</span><span id="Store.ReceiveVehicleArrival-1528"><a href="#Store.ReceiveVehicleArrival-1528"><span class="linenos">1528</span></a><span class="sd">            - **JSON Parse Failure**: Catches JSONDecodeError, prints ERROR</span>
</span><span id="Store.ReceiveVehicleArrival-1529"><a href="#Store.ReceiveVehicleArrival-1529"><span class="linenos">1529</span></a><span class="sd">            - **Missing Order ID**: Catches KeyError, prints ERROR</span>
</span><span id="Store.ReceiveVehicleArrival-1530"><a href="#Store.ReceiveVehicleArrival-1530"><span class="linenos">1530</span></a><span class="sd">            - Graceful degradation: Does not crash agent on malformed messages</span>
</span><span id="Store.ReceiveVehicleArrival-1531"><a href="#Store.ReceiveVehicleArrival-1531"><span class="linenos">1531</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1532"><a href="#Store.ReceiveVehicleArrival-1532"><span class="linenos">1532</span></a><span class="sd">        Example Execution:</span>
</span><span id="Store.ReceiveVehicleArrival-1533"><a href="#Store.ReceiveVehicleArrival-1533"><span class="linenos">1533</span></a><span class="sd">            ```</span>
</span><span id="Store.ReceiveVehicleArrival-1534"><a href="#Store.ReceiveVehicleArrival-1534"><span class="linenos">1534</span></a><span class="sd">            Message Received:</span>
</span><span id="Store.ReceiveVehicleArrival-1535"><a href="#Store.ReceiveVehicleArrival-1535"><span class="linenos">1535</span></a><span class="sd">                {</span>
</span><span id="Store.ReceiveVehicleArrival-1536"><a href="#Store.ReceiveVehicleArrival-1536"><span class="linenos">1536</span></a><span class="sd">                    &quot;orderid&quot;: 1001000000,</span>
</span><span id="Store.ReceiveVehicleArrival-1537"><a href="#Store.ReceiveVehicleArrival-1537"><span class="linenos">1537</span></a><span class="sd">                    &quot;time&quot;: 120</span>
</span><span id="Store.ReceiveVehicleArrival-1538"><a href="#Store.ReceiveVehicleArrival-1538"><span class="linenos">1538</span></a><span class="sd">                }</span>
</span><span id="Store.ReceiveVehicleArrival-1539"><a href="#Store.ReceiveVehicleArrival-1539"><span class="linenos">1539</span></a><span class="sd">            Processing:</span>
</span><span id="Store.ReceiveVehicleArrival-1540"><a href="#Store.ReceiveVehicleArrival-1540"><span class="linenos">1540</span></a><span class="sd">                - Find Order: product=&quot;electronics&quot;, quantity=50</span>
</span><span id="Store.ReceiveVehicleArrival-1541"><a href="#Store.ReceiveVehicleArrival-1541"><span class="linenos">1541</span></a><span class="sd">                - Update Stock: electronics: 200 -&gt; 250</span>
</span><span id="Store.ReceiveVehicleArrival-1542"><a href="#Store.ReceiveVehicleArrival-1542"><span class="linenos">1542</span></a><span class="sd">                - Remove: pending_deliveries[1001000000] deleted</span>
</span><span id="Store.ReceiveVehicleArrival-1543"><a href="#Store.ReceiveVehicleArrival-1543"><span class="linenos">1543</span></a><span class="sd">                - Record Stats: CSV entry with all details</span>
</span><span id="Store.ReceiveVehicleArrival-1544"><a href="#Store.ReceiveVehicleArrival-1544"><span class="linenos">1544</span></a><span class="sd">                - Print: &quot;Vehicle vehicle1@localhost delivered 50 units of electronics&quot;</span>
</span><span id="Store.ReceiveVehicleArrival-1545"><a href="#Store.ReceiveVehicleArrival-1545"><span class="linenos">1545</span></a><span class="sd">                - Print: Current stock display</span>
</span><span id="Store.ReceiveVehicleArrival-1546"><a href="#Store.ReceiveVehicleArrival-1546"><span class="linenos">1546</span></a><span class="sd">            ```</span>
</span><span id="Store.ReceiveVehicleArrival-1547"><a href="#Store.ReceiveVehicleArrival-1547"><span class="linenos">1547</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1548"><a href="#Store.ReceiveVehicleArrival-1548"><span class="linenos">1548</span></a><span class="sd">        Side Effects:</span>
</span><span id="Store.ReceiveVehicleArrival-1549"><a href="#Store.ReceiveVehicleArrival-1549"><span class="linenos">1549</span></a><span class="sd">            - Modifies agent.stock (inventory increase)</span>
</span><span id="Store.ReceiveVehicleArrival-1550"><a href="#Store.ReceiveVehicleArrival-1550"><span class="linenos">1550</span></a><span class="sd">            - Removes order from agent.pending_deliveries</span>
</span><span id="Store.ReceiveVehicleArrival-1551"><a href="#Store.ReceiveVehicleArrival-1551"><span class="linenos">1551</span></a><span class="sd">            - Writes statistics to CSV file</span>
</span><span id="Store.ReceiveVehicleArrival-1552"><a href="#Store.ReceiveVehicleArrival-1552"><span class="linenos">1552</span></a><span class="sd">            - Prints delivery confirmation and stock status</span>
</span><span id="Store.ReceiveVehicleArrival-1553"><a href="#Store.ReceiveVehicleArrival-1553"><span class="linenos">1553</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1554"><a href="#Store.ReceiveVehicleArrival-1554"><span class="linenos">1554</span></a><span class="sd">        Returns:</span>
</span><span id="Store.ReceiveVehicleArrival-1555"><a href="#Store.ReceiveVehicleArrival-1555"><span class="linenos">1555</span></a><span class="sd">            Never returns (cyclic behaviour runs until agent stops).</span>
</span><span id="Store.ReceiveVehicleArrival-1556"><a href="#Store.ReceiveVehicleArrival-1556"><span class="linenos">1556</span></a><span class="sd">        </span>
</span><span id="Store.ReceiveVehicleArrival-1557"><a href="#Store.ReceiveVehicleArrival-1557"><span class="linenos">1557</span></a><span class="sd">        Note:</span>
</span><span id="Store.ReceiveVehicleArrival-1558"><a href="#Store.ReceiveVehicleArrival-1558"><span class="linenos">1558</span></a><span class="sd">            This is the ONLY place where stock is updated. Confirmations do NOT update</span>
</span><span id="Store.ReceiveVehicleArrival-1559"><a href="#Store.ReceiveVehicleArrival-1559"><span class="linenos">1559</span></a><span class="sd">            stock - only physical delivery does. This accurately models real-world</span>
</span><span id="Store.ReceiveVehicleArrival-1560"><a href="#Store.ReceiveVehicleArrival-1560"><span class="linenos">1560</span></a><span class="sd">            inventory management where confirmation  possession.</span>
</span><span id="Store.ReceiveVehicleArrival-1561"><a href="#Store.ReceiveVehicleArrival-1561"><span class="linenos">1561</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Store.ReceiveVehicleArrival-1562"><a href="#Store.ReceiveVehicleArrival-1562"><span class="linenos">1562</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.ReceiveVehicleArrival-1563"><a href="#Store.ReceiveVehicleArrival-1563"><span class="linenos">1563</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.ReceiveVehicleArrival-1564"><a href="#Store.ReceiveVehicleArrival-1564"><span class="linenos">1564</span></a><span class="sd">            Execute one cycle of vehicle delivery message processing.</span>
</span><span id="Store.ReceiveVehicleArrival-1565"><a href="#Store.ReceiveVehicleArrival-1565"><span class="linenos">1565</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival-1566"><a href="#Store.ReceiveVehicleArrival-1566"><span class="linenos">1566</span></a><span class="sd">            This method receives one delivery notification, updates inventory, records</span>
</span><span id="Store.ReceiveVehicleArrival-1567"><a href="#Store.ReceiveVehicleArrival-1567"><span class="linenos">1567</span></a><span class="sd">            statistics, and prepares for the next delivery message.</span>
</span><span id="Store.ReceiveVehicleArrival-1568"><a href="#Store.ReceiveVehicleArrival-1568"><span class="linenos">1568</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival-1569"><a href="#Store.ReceiveVehicleArrival-1569"><span class="linenos">1569</span></a><span class="sd">            Workflow:</span>
</span><span id="Store.ReceiveVehicleArrival-1570"><a href="#Store.ReceiveVehicleArrival-1570"><span class="linenos">1570</span></a><span class="sd">                1. **Receive**: Wait up to 20 seconds for message</span>
</span><span id="Store.ReceiveVehicleArrival-1571"><a href="#Store.ReceiveVehicleArrival-1571"><span class="linenos">1571</span></a><span class="sd">                2. **Validation**: Check performative is vehicle-delivery</span>
</span><span id="Store.ReceiveVehicleArrival-1572"><a href="#Store.ReceiveVehicleArrival-1572"><span class="linenos">1572</span></a><span class="sd">                3. **Parsing**: Deserialize JSON and extract orderid, time</span>
</span><span id="Store.ReceiveVehicleArrival-1573"><a href="#Store.ReceiveVehicleArrival-1573"><span class="linenos">1573</span></a><span class="sd">                4. **Order Lookup**: Find order in pending_deliveries</span>
</span><span id="Store.ReceiveVehicleArrival-1574"><a href="#Store.ReceiveVehicleArrival-1574"><span class="linenos">1574</span></a><span class="sd">                5. **Stock Update**: Add quantity to inventory (create or increment)</span>
</span><span id="Store.ReceiveVehicleArrival-1575"><a href="#Store.ReceiveVehicleArrival-1575"><span class="linenos">1575</span></a><span class="sd">                6. **Cleanup**: Remove order from pending_deliveries</span>
</span><span id="Store.ReceiveVehicleArrival-1576"><a href="#Store.ReceiveVehicleArrival-1576"><span class="linenos">1576</span></a><span class="sd">                7. **Statistics**: Record delivery details to CSV</span>
</span><span id="Store.ReceiveVehicleArrival-1577"><a href="#Store.ReceiveVehicleArrival-1577"><span class="linenos">1577</span></a><span class="sd">                8. **Logging**: Print delivery confirmation and stock display</span>
</span><span id="Store.ReceiveVehicleArrival-1578"><a href="#Store.ReceiveVehicleArrival-1578"><span class="linenos">1578</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival-1579"><a href="#Store.ReceiveVehicleArrival-1579"><span class="linenos">1579</span></a><span class="sd">            Error Handling:</span>
</span><span id="Store.ReceiveVehicleArrival-1580"><a href="#Store.ReceiveVehicleArrival-1580"><span class="linenos">1580</span></a><span class="sd">                Three validation layers:</span>
</span><span id="Store.ReceiveVehicleArrival-1581"><a href="#Store.ReceiveVehicleArrival-1581"><span class="linenos">1581</span></a><span class="sd">                1. Template filter (should only receive vehicle-delivery)</span>
</span><span id="Store.ReceiveVehicleArrival-1582"><a href="#Store.ReceiveVehicleArrival-1582"><span class="linenos">1582</span></a><span class="sd">                2. Performative check (safety validation)</span>
</span><span id="Store.ReceiveVehicleArrival-1583"><a href="#Store.ReceiveVehicleArrival-1583"><span class="linenos">1583</span></a><span class="sd">                3. Try-except for JSON parsing and order lookup</span>
</span><span id="Store.ReceiveVehicleArrival-1584"><a href="#Store.ReceiveVehicleArrival-1584"><span class="linenos">1584</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival-1585"><a href="#Store.ReceiveVehicleArrival-1585"><span class="linenos">1585</span></a><span class="sd">            Stock Update Details:</span>
</span><span id="Store.ReceiveVehicleArrival-1586"><a href="#Store.ReceiveVehicleArrival-1586"><span class="linenos">1586</span></a><span class="sd">                - Retrieves product and quantity from pending order</span>
</span><span id="Store.ReceiveVehicleArrival-1587"><a href="#Store.ReceiveVehicleArrival-1587"><span class="linenos">1587</span></a><span class="sd">                - If product exists: stock[product] += quantity</span>
</span><span id="Store.ReceiveVehicleArrival-1588"><a href="#Store.ReceiveVehicleArrival-1588"><span class="linenos">1588</span></a><span class="sd">                - If product new: stock[product] = quantity</span>
</span><span id="Store.ReceiveVehicleArrival-1589"><a href="#Store.ReceiveVehicleArrival-1589"><span class="linenos">1589</span></a><span class="sd">                - Thread-safe (single-threaded SPADE execution)</span>
</span><span id="Store.ReceiveVehicleArrival-1590"><a href="#Store.ReceiveVehicleArrival-1590"><span class="linenos">1590</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival-1591"><a href="#Store.ReceiveVehicleArrival-1591"><span class="linenos">1591</span></a><span class="sd">            Statistics Recording:</span>
</span><span id="Store.ReceiveVehicleArrival-1592"><a href="#Store.ReceiveVehicleArrival-1592"><span class="linenos">1592</span></a><span class="sd">                Calls get_stats() with:</span>
</span><span id="Store.ReceiveVehicleArrival-1593"><a href="#Store.ReceiveVehicleArrival-1593"><span class="linenos">1593</span></a><span class="sd">                - order: Order object with all details</span>
</span><span id="Store.ReceiveVehicleArrival-1594"><a href="#Store.ReceiveVehicleArrival-1594"><span class="linenos">1594</span></a><span class="sd">                - eta: Estimated time from message</span>
</span><span id="Store.ReceiveVehicleArrival-1595"><a href="#Store.ReceiveVehicleArrival-1595"><span class="linenos">1595</span></a><span class="sd">                - state: &quot;delivered&quot; (success indicator)</span>
</span><span id="Store.ReceiveVehicleArrival-1596"><a href="#Store.ReceiveVehicleArrival-1596"><span class="linenos">1596</span></a><span class="sd">                - vehicle: Vehicle JID from message sender</span>
</span><span id="Store.ReceiveVehicleArrival-1597"><a href="#Store.ReceiveVehicleArrival-1597"><span class="linenos">1597</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival-1598"><a href="#Store.ReceiveVehicleArrival-1598"><span class="linenos">1598</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.ReceiveVehicleArrival-1599"><a href="#Store.ReceiveVehicleArrival-1599"><span class="linenos">1599</span></a><span class="sd">                - Increments stock for delivered product</span>
</span><span id="Store.ReceiveVehicleArrival-1600"><a href="#Store.ReceiveVehicleArrival-1600"><span class="linenos">1600</span></a><span class="sd">                - Removes order from pending_deliveries dict</span>
</span><span id="Store.ReceiveVehicleArrival-1601"><a href="#Store.ReceiveVehicleArrival-1601"><span class="linenos">1601</span></a><span class="sd">                - Appends row to store_stats.csv</span>
</span><span id="Store.ReceiveVehicleArrival-1602"><a href="#Store.ReceiveVehicleArrival-1602"><span class="linenos">1602</span></a><span class="sd">                - Prints to console (always visible, not verbose-only)</span>
</span><span id="Store.ReceiveVehicleArrival-1603"><a href="#Store.ReceiveVehicleArrival-1603"><span class="linenos">1603</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival-1604"><a href="#Store.ReceiveVehicleArrival-1604"><span class="linenos">1604</span></a><span class="sd">            Returns:</span>
</span><span id="Store.ReceiveVehicleArrival-1605"><a href="#Store.ReceiveVehicleArrival-1605"><span class="linenos">1605</span></a><span class="sd">                None. Continues to next cycle after processing one delivery.</span>
</span><span id="Store.ReceiveVehicleArrival-1606"><a href="#Store.ReceiveVehicleArrival-1606"><span class="linenos">1606</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival-1607"><a href="#Store.ReceiveVehicleArrival-1607"><span class="linenos">1607</span></a><span class="sd">            Example:</span>
</span><span id="Store.ReceiveVehicleArrival-1608"><a href="#Store.ReceiveVehicleArrival-1608"><span class="linenos">1608</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveVehicleArrival-1609"><a href="#Store.ReceiveVehicleArrival-1609"><span class="linenos">1609</span></a><span class="sd">                Input: vehicle-delivery from vehicle1</span>
</span><span id="Store.ReceiveVehicleArrival-1610"><a href="#Store.ReceiveVehicleArrival-1610"><span class="linenos">1610</span></a><span class="sd">                    Body: {&quot;orderid&quot;: 1001000000, &quot;time&quot;: 120}</span>
</span><span id="Store.ReceiveVehicleArrival-1611"><a href="#Store.ReceiveVehicleArrival-1611"><span class="linenos">1611</span></a><span class="sd">                Pending Order: Order(product=&quot;electronics&quot;, quantity=50, ...)</span>
</span><span id="Store.ReceiveVehicleArrival-1612"><a href="#Store.ReceiveVehicleArrival-1612"><span class="linenos">1612</span></a><span class="sd">                Processing:</span>
</span><span id="Store.ReceiveVehicleArrival-1613"><a href="#Store.ReceiveVehicleArrival-1613"><span class="linenos">1613</span></a><span class="sd">                    - Stock before: {&quot;electronics&quot;: 200, &quot;food&quot;: 100}</span>
</span><span id="Store.ReceiveVehicleArrival-1614"><a href="#Store.ReceiveVehicleArrival-1614"><span class="linenos">1614</span></a><span class="sd">                    - Update: electronics += 50</span>
</span><span id="Store.ReceiveVehicleArrival-1615"><a href="#Store.ReceiveVehicleArrival-1615"><span class="linenos">1615</span></a><span class="sd">                    - Stock after: {&quot;electronics&quot;: 250, &quot;food&quot;: 100}</span>
</span><span id="Store.ReceiveVehicleArrival-1616"><a href="#Store.ReceiveVehicleArrival-1616"><span class="linenos">1616</span></a><span class="sd">                    - Remove from pending_deliveries</span>
</span><span id="Store.ReceiveVehicleArrival-1617"><a href="#Store.ReceiveVehicleArrival-1617"><span class="linenos">1617</span></a><span class="sd">                    - Write CSV row</span>
</span><span id="Store.ReceiveVehicleArrival-1618"><a href="#Store.ReceiveVehicleArrival-1618"><span class="linenos">1618</span></a><span class="sd">                Output:</span>
</span><span id="Store.ReceiveVehicleArrival-1619"><a href="#Store.ReceiveVehicleArrival-1619"><span class="linenos">1619</span></a><span class="sd">                    Print: &quot;Vehicle vehicle1@localhost delivered 50 units of electronics&quot;</span>
</span><span id="Store.ReceiveVehicleArrival-1620"><a href="#Store.ReceiveVehicleArrival-1620"><span class="linenos">1620</span></a><span class="sd">                    Print: &quot;Current stock: electronics: 250 units, food: 100 units&quot;</span>
</span><span id="Store.ReceiveVehicleArrival-1621"><a href="#Store.ReceiveVehicleArrival-1621"><span class="linenos">1621</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveVehicleArrival-1622"><a href="#Store.ReceiveVehicleArrival-1622"><span class="linenos">1622</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.ReceiveVehicleArrival-1623"><a href="#Store.ReceiveVehicleArrival-1623"><span class="linenos">1623</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.ReceiveVehicleArrival-1624"><a href="#Store.ReceiveVehicleArrival-1624"><span class="linenos">1624</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival-1625"><a href="#Store.ReceiveVehicleArrival-1625"><span class="linenos">1625</span></a>            
</span><span id="Store.ReceiveVehicleArrival-1626"><a href="#Store.ReceiveVehicleArrival-1626"><span class="linenos">1626</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Store.ReceiveVehicleArrival-1627"><a href="#Store.ReceiveVehicleArrival-1627"><span class="linenos">1627</span></a>                <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival-1628"><a href="#Store.ReceiveVehicleArrival-1628"><span class="linenos">1628</span></a>                
</span><span id="Store.ReceiveVehicleArrival-1629"><a href="#Store.ReceiveVehicleArrival-1629"><span class="linenos">1629</span></a>                <span class="c1"># Double-check (should already be filtered by templates)</span>
</span><span id="Store.ReceiveVehicleArrival-1630"><a href="#Store.ReceiveVehicleArrival-1630"><span class="linenos">1630</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">]:</span>
</span><span id="Store.ReceiveVehicleArrival-1631"><a href="#Store.ReceiveVehicleArrival-1631"><span class="linenos">1631</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Received unexpected performative &#39;</span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival-1632"><a href="#Store.ReceiveVehicleArrival-1632"><span class="linenos">1632</span></a>                    <span class="k">return</span>
</span><span id="Store.ReceiveVehicleArrival-1633"><a href="#Store.ReceiveVehicleArrival-1633"><span class="linenos">1633</span></a>                
</span><span id="Store.ReceiveVehicleArrival-1634"><a href="#Store.ReceiveVehicleArrival-1634"><span class="linenos">1634</span></a>                <span class="c1"># Parse message body</span>
</span><span id="Store.ReceiveVehicleArrival-1635"><a href="#Store.ReceiveVehicleArrival-1635"><span class="linenos">1635</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Store.ReceiveVehicleArrival-1636"><a href="#Store.ReceiveVehicleArrival-1636"><span class="linenos">1636</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival-1637"><a href="#Store.ReceiveVehicleArrival-1637"><span class="linenos">1637</span></a>                    <span class="n">orderid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">]</span>
</span><span id="Store.ReceiveVehicleArrival-1638"><a href="#Store.ReceiveVehicleArrival-1638"><span class="linenos">1638</span></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">orderid</span><span class="p">]</span>
</span><span id="Store.ReceiveVehicleArrival-1639"><a href="#Store.ReceiveVehicleArrival-1639"><span class="linenos">1639</span></a>                    <span class="n">eta</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>          
</span><span id="Store.ReceiveVehicleArrival-1640"><a href="#Store.ReceiveVehicleArrival-1640"><span class="linenos">1640</span></a>                <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Store.ReceiveVehicleArrival-1641"><a href="#Store.ReceiveVehicleArrival-1641"><span class="linenos">1641</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Failed to parse vehicle message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival-1642"><a href="#Store.ReceiveVehicleArrival-1642"><span class="linenos">1642</span></a>                    <span class="k">return</span>
</span><span id="Store.ReceiveVehicleArrival-1643"><a href="#Store.ReceiveVehicleArrival-1643"><span class="linenos">1643</span></a>
</span><span id="Store.ReceiveVehicleArrival-1644"><a href="#Store.ReceiveVehicleArrival-1644"><span class="linenos">1644</span></a>                <span class="c1"># Vehicle is delivering supplies from supplier</span>
</span><span id="Store.ReceiveVehicleArrival-1645"><a href="#Store.ReceiveVehicleArrival-1645"><span class="linenos">1645</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span>
</span><span id="Store.ReceiveVehicleArrival-1646"><a href="#Store.ReceiveVehicleArrival-1646"><span class="linenos">1646</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="Store.ReceiveVehicleArrival-1647"><a href="#Store.ReceiveVehicleArrival-1647"><span class="linenos">1647</span></a>                
</span><span id="Store.ReceiveVehicleArrival-1648"><a href="#Store.ReceiveVehicleArrival-1648"><span class="linenos">1648</span></a>                <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="Store.ReceiveVehicleArrival-1649"><a href="#Store.ReceiveVehicleArrival-1649"><span class="linenos">1649</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="Store.ReceiveVehicleArrival-1650"><a href="#Store.ReceiveVehicleArrival-1650"><span class="linenos">1650</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Store.ReceiveVehicleArrival-1651"><a href="#Store.ReceiveVehicleArrival-1651"><span class="linenos">1651</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Store.ReceiveVehicleArrival-1652"><a href="#Store.ReceiveVehicleArrival-1652"><span class="linenos">1652</span></a>                <span class="k">del</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span>
</span><span id="Store.ReceiveVehicleArrival-1653"><a href="#Store.ReceiveVehicleArrival-1653"><span class="linenos">1653</span></a>                
</span><span id="Store.ReceiveVehicleArrival-1654"><a href="#Store.ReceiveVehicleArrival-1654"><span class="linenos">1654</span></a>                <span class="c1"># Save order stats</span>
</span><span id="Store.ReceiveVehicleArrival-1655"><a href="#Store.ReceiveVehicleArrival-1655"><span class="linenos">1655</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span><span class="s2">&quot;delivered&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival-1656"><a href="#Store.ReceiveVehicleArrival-1656"><span class="linenos">1656</span></a>                
</span><span id="Store.ReceiveVehicleArrival-1657"><a href="#Store.ReceiveVehicleArrival-1657"><span class="linenos">1657</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> delivered </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival-1658"><a href="#Store.ReceiveVehicleArrival-1658"><span class="linenos">1658</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>    
</span></pre></div>


            <div class="docstring"><p>Cyclic behaviour that handles vehicle delivery notifications.</p>

<p>This behaviour processes delivery completion messages from vehicle agents,
updating inventory when products arrive at the store. It represents the final
step in the supply chain: physical delivery and stock replenishment.</p>

<h6 id="message-types-accepted">Message Types Accepted:</h6>

<blockquote>
  <ul>
  <li><strong>vehicle-delivery</strong>: Vehicle completed delivery to store (primary)</li>
  <li><strong>vehicle-pickup</strong>: Vehicle picked up goods from warehouse (informational)</li>
  </ul>
</blockquote>

<p>The behaviour is filtered by template to only receive vehicle-delivery messages,
but includes validation as a safety mechanism.</p>

<h6 id="message-format">Message Format:</h6>

<blockquote>
  <p>Metadata:
      - performative: "vehicle-delivery"
      - sender: Vehicle JID
  Body (JSON):</p>
  
  <p><div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;orderid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1001000000</span><span class="p">,</span><span class="w">  </span><span class="c1">// Unique order identifier</span>
<span class="w">    </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">150</span><span class="w">             </span><span class="c1">// ETA or delivery time</span>
<span class="p">}</span>
</code></pre>
</div></p>
</blockquote>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>Inherits from CyclicBehaviour:</strong>  - Runs continuously in infinite loop
<ul>
<li>Processes one message per cycle</li>
<li>20-second timeout per receive attempt</li>
</ul></li>
</ul>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Receive Message</strong>: Wait up to 20 seconds for vehicle-delivery</li>
  <li><strong>Validate Performative</strong>: Verify it's vehicle-delivery (should be filtered)</li>
  <li><strong>Parse JSON</strong>: Extract orderid and time (ETA)</li>
  <li><strong>Lookup Order</strong>: Find order in pending_deliveries by orderid</li>
  <li><strong>Update Stock</strong>: Add delivered quantity to inventory</li>
  <li><strong>Remove Pending</strong>: Delete order from pending_deliveries</li>
  <li><strong>Record Statistics</strong>: Save delivery data to CSV</li>
  <li><strong>Log Delivery</strong>: Print confirmation and current stock</li>
  <li><strong>Repeat</strong>: Return to step 1 (cyclic behaviour)</li>
  </ol>
</blockquote>

<h6 id="stock-update-logic">Stock Update Logic:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">stock</span><span class="p">:</span>
    <span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>  <span class="c1"># Increment existing</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span>   <span class="c1"># Create new entry</span>
</code></pre>
  </div>
</blockquote>

<h6 id="statistics-recorded">Statistics Recorded:</h6>

<blockquote>
  <ul>
  <li>order_id: Unique identifier</li>
  <li>store_jid: This store's identifier</li>
  <li>vehicle_jid: Delivering vehicle identifier</li>
  <li>origin_warehouse: Warehouse that fulfilled order</li>
  <li>product: Product name</li>
  <li>quantity: Amount delivered</li>
  <li>ETA: Estimated time of arrival</li>
  <li>time_to_delivery: Ticks from confirmation to delivery</li>
  <li>current_tick: Current simulation time</li>
  <li>final_state: "delivered" (success indicator)</li>
  </ul>
</blockquote>

<h6 id="error-handling">Error Handling:</h6>

<blockquote>
  <ul>
  <li><strong>Wrong Performative</strong>: Prints ERROR and returns early</li>
  <li><strong>JSON Parse Failure</strong>: Catches JSONDecodeError, prints ERROR</li>
  <li><strong>Missing Order ID</strong>: Catches KeyError, prints ERROR</li>
  <li>Graceful degradation: Does not crash agent on malformed messages</li>
  </ul>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
<pre><code>Message Received:
    {
        "orderid": 1001000000,
        "time": 120
    }
Processing:
    - Find Order: product="electronics", quantity=50
    - Update Stock: electronics: 200 -&gt; 250
    - Remove: pending_deliveries[1001000000] deleted
    - Record Stats: CSV entry with all details
    - Print: "Vehicle vehicle1@localhost delivered 50 units of electronics"
    - Print: Current stock display
</code></pre>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Modifies agent.stock (inventory increase)</li>
  <li>Removes order from agent.pending_deliveries</li>
  <li>Writes statistics to CSV file</li>
  <li>Prints delivery confirmation and stock status</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Never returns (cyclic behaviour runs until agent stops).</p>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This is the ONLY place where stock is updated. Confirmations do NOT update
  stock - only physical delivery does. This accurately models real-world
  inventory management where confirmation  possession.</p>
</blockquote>
</div>


                            <div id="Store.ReceiveVehicleArrival.run" class="classattr">
                                        <input id="Store.ReceiveVehicleArrival.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Store.ReceiveVehicleArrival.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Store.ReceiveVehicleArrival.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Store.ReceiveVehicleArrival.run-1562"><a href="#Store.ReceiveVehicleArrival.run-1562"><span class="linenos">1562</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Store.ReceiveVehicleArrival.run-1563"><a href="#Store.ReceiveVehicleArrival.run-1563"><span class="linenos">1563</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Store.ReceiveVehicleArrival.run-1564"><a href="#Store.ReceiveVehicleArrival.run-1564"><span class="linenos">1564</span></a><span class="sd">            Execute one cycle of vehicle delivery message processing.</span>
</span><span id="Store.ReceiveVehicleArrival.run-1565"><a href="#Store.ReceiveVehicleArrival.run-1565"><span class="linenos">1565</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival.run-1566"><a href="#Store.ReceiveVehicleArrival.run-1566"><span class="linenos">1566</span></a><span class="sd">            This method receives one delivery notification, updates inventory, records</span>
</span><span id="Store.ReceiveVehicleArrival.run-1567"><a href="#Store.ReceiveVehicleArrival.run-1567"><span class="linenos">1567</span></a><span class="sd">            statistics, and prepares for the next delivery message.</span>
</span><span id="Store.ReceiveVehicleArrival.run-1568"><a href="#Store.ReceiveVehicleArrival.run-1568"><span class="linenos">1568</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival.run-1569"><a href="#Store.ReceiveVehicleArrival.run-1569"><span class="linenos">1569</span></a><span class="sd">            Workflow:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1570"><a href="#Store.ReceiveVehicleArrival.run-1570"><span class="linenos">1570</span></a><span class="sd">                1. **Receive**: Wait up to 20 seconds for message</span>
</span><span id="Store.ReceiveVehicleArrival.run-1571"><a href="#Store.ReceiveVehicleArrival.run-1571"><span class="linenos">1571</span></a><span class="sd">                2. **Validation**: Check performative is vehicle-delivery</span>
</span><span id="Store.ReceiveVehicleArrival.run-1572"><a href="#Store.ReceiveVehicleArrival.run-1572"><span class="linenos">1572</span></a><span class="sd">                3. **Parsing**: Deserialize JSON and extract orderid, time</span>
</span><span id="Store.ReceiveVehicleArrival.run-1573"><a href="#Store.ReceiveVehicleArrival.run-1573"><span class="linenos">1573</span></a><span class="sd">                4. **Order Lookup**: Find order in pending_deliveries</span>
</span><span id="Store.ReceiveVehicleArrival.run-1574"><a href="#Store.ReceiveVehicleArrival.run-1574"><span class="linenos">1574</span></a><span class="sd">                5. **Stock Update**: Add quantity to inventory (create or increment)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1575"><a href="#Store.ReceiveVehicleArrival.run-1575"><span class="linenos">1575</span></a><span class="sd">                6. **Cleanup**: Remove order from pending_deliveries</span>
</span><span id="Store.ReceiveVehicleArrival.run-1576"><a href="#Store.ReceiveVehicleArrival.run-1576"><span class="linenos">1576</span></a><span class="sd">                7. **Statistics**: Record delivery details to CSV</span>
</span><span id="Store.ReceiveVehicleArrival.run-1577"><a href="#Store.ReceiveVehicleArrival.run-1577"><span class="linenos">1577</span></a><span class="sd">                8. **Logging**: Print delivery confirmation and stock display</span>
</span><span id="Store.ReceiveVehicleArrival.run-1578"><a href="#Store.ReceiveVehicleArrival.run-1578"><span class="linenos">1578</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival.run-1579"><a href="#Store.ReceiveVehicleArrival.run-1579"><span class="linenos">1579</span></a><span class="sd">            Error Handling:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1580"><a href="#Store.ReceiveVehicleArrival.run-1580"><span class="linenos">1580</span></a><span class="sd">                Three validation layers:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1581"><a href="#Store.ReceiveVehicleArrival.run-1581"><span class="linenos">1581</span></a><span class="sd">                1. Template filter (should only receive vehicle-delivery)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1582"><a href="#Store.ReceiveVehicleArrival.run-1582"><span class="linenos">1582</span></a><span class="sd">                2. Performative check (safety validation)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1583"><a href="#Store.ReceiveVehicleArrival.run-1583"><span class="linenos">1583</span></a><span class="sd">                3. Try-except for JSON parsing and order lookup</span>
</span><span id="Store.ReceiveVehicleArrival.run-1584"><a href="#Store.ReceiveVehicleArrival.run-1584"><span class="linenos">1584</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival.run-1585"><a href="#Store.ReceiveVehicleArrival.run-1585"><span class="linenos">1585</span></a><span class="sd">            Stock Update Details:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1586"><a href="#Store.ReceiveVehicleArrival.run-1586"><span class="linenos">1586</span></a><span class="sd">                - Retrieves product and quantity from pending order</span>
</span><span id="Store.ReceiveVehicleArrival.run-1587"><a href="#Store.ReceiveVehicleArrival.run-1587"><span class="linenos">1587</span></a><span class="sd">                - If product exists: stock[product] += quantity</span>
</span><span id="Store.ReceiveVehicleArrival.run-1588"><a href="#Store.ReceiveVehicleArrival.run-1588"><span class="linenos">1588</span></a><span class="sd">                - If product new: stock[product] = quantity</span>
</span><span id="Store.ReceiveVehicleArrival.run-1589"><a href="#Store.ReceiveVehicleArrival.run-1589"><span class="linenos">1589</span></a><span class="sd">                - Thread-safe (single-threaded SPADE execution)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1590"><a href="#Store.ReceiveVehicleArrival.run-1590"><span class="linenos">1590</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival.run-1591"><a href="#Store.ReceiveVehicleArrival.run-1591"><span class="linenos">1591</span></a><span class="sd">            Statistics Recording:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1592"><a href="#Store.ReceiveVehicleArrival.run-1592"><span class="linenos">1592</span></a><span class="sd">                Calls get_stats() with:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1593"><a href="#Store.ReceiveVehicleArrival.run-1593"><span class="linenos">1593</span></a><span class="sd">                - order: Order object with all details</span>
</span><span id="Store.ReceiveVehicleArrival.run-1594"><a href="#Store.ReceiveVehicleArrival.run-1594"><span class="linenos">1594</span></a><span class="sd">                - eta: Estimated time from message</span>
</span><span id="Store.ReceiveVehicleArrival.run-1595"><a href="#Store.ReceiveVehicleArrival.run-1595"><span class="linenos">1595</span></a><span class="sd">                - state: &quot;delivered&quot; (success indicator)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1596"><a href="#Store.ReceiveVehicleArrival.run-1596"><span class="linenos">1596</span></a><span class="sd">                - vehicle: Vehicle JID from message sender</span>
</span><span id="Store.ReceiveVehicleArrival.run-1597"><a href="#Store.ReceiveVehicleArrival.run-1597"><span class="linenos">1597</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival.run-1598"><a href="#Store.ReceiveVehicleArrival.run-1598"><span class="linenos">1598</span></a><span class="sd">            Side Effects:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1599"><a href="#Store.ReceiveVehicleArrival.run-1599"><span class="linenos">1599</span></a><span class="sd">                - Increments stock for delivered product</span>
</span><span id="Store.ReceiveVehicleArrival.run-1600"><a href="#Store.ReceiveVehicleArrival.run-1600"><span class="linenos">1600</span></a><span class="sd">                - Removes order from pending_deliveries dict</span>
</span><span id="Store.ReceiveVehicleArrival.run-1601"><a href="#Store.ReceiveVehicleArrival.run-1601"><span class="linenos">1601</span></a><span class="sd">                - Appends row to store_stats.csv</span>
</span><span id="Store.ReceiveVehicleArrival.run-1602"><a href="#Store.ReceiveVehicleArrival.run-1602"><span class="linenos">1602</span></a><span class="sd">                - Prints to console (always visible, not verbose-only)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1603"><a href="#Store.ReceiveVehicleArrival.run-1603"><span class="linenos">1603</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival.run-1604"><a href="#Store.ReceiveVehicleArrival.run-1604"><span class="linenos">1604</span></a><span class="sd">            Returns:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1605"><a href="#Store.ReceiveVehicleArrival.run-1605"><span class="linenos">1605</span></a><span class="sd">                None. Continues to next cycle after processing one delivery.</span>
</span><span id="Store.ReceiveVehicleArrival.run-1606"><a href="#Store.ReceiveVehicleArrival.run-1606"><span class="linenos">1606</span></a><span class="sd">            </span>
</span><span id="Store.ReceiveVehicleArrival.run-1607"><a href="#Store.ReceiveVehicleArrival.run-1607"><span class="linenos">1607</span></a><span class="sd">            Example:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1608"><a href="#Store.ReceiveVehicleArrival.run-1608"><span class="linenos">1608</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveVehicleArrival.run-1609"><a href="#Store.ReceiveVehicleArrival.run-1609"><span class="linenos">1609</span></a><span class="sd">                Input: vehicle-delivery from vehicle1</span>
</span><span id="Store.ReceiveVehicleArrival.run-1610"><a href="#Store.ReceiveVehicleArrival.run-1610"><span class="linenos">1610</span></a><span class="sd">                    Body: {&quot;orderid&quot;: 1001000000, &quot;time&quot;: 120}</span>
</span><span id="Store.ReceiveVehicleArrival.run-1611"><a href="#Store.ReceiveVehicleArrival.run-1611"><span class="linenos">1611</span></a><span class="sd">                Pending Order: Order(product=&quot;electronics&quot;, quantity=50, ...)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1612"><a href="#Store.ReceiveVehicleArrival.run-1612"><span class="linenos">1612</span></a><span class="sd">                Processing:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1613"><a href="#Store.ReceiveVehicleArrival.run-1613"><span class="linenos">1613</span></a><span class="sd">                    - Stock before: {&quot;electronics&quot;: 200, &quot;food&quot;: 100}</span>
</span><span id="Store.ReceiveVehicleArrival.run-1614"><a href="#Store.ReceiveVehicleArrival.run-1614"><span class="linenos">1614</span></a><span class="sd">                    - Update: electronics += 50</span>
</span><span id="Store.ReceiveVehicleArrival.run-1615"><a href="#Store.ReceiveVehicleArrival.run-1615"><span class="linenos">1615</span></a><span class="sd">                    - Stock after: {&quot;electronics&quot;: 250, &quot;food&quot;: 100}</span>
</span><span id="Store.ReceiveVehicleArrival.run-1616"><a href="#Store.ReceiveVehicleArrival.run-1616"><span class="linenos">1616</span></a><span class="sd">                    - Remove from pending_deliveries</span>
</span><span id="Store.ReceiveVehicleArrival.run-1617"><a href="#Store.ReceiveVehicleArrival.run-1617"><span class="linenos">1617</span></a><span class="sd">                    - Write CSV row</span>
</span><span id="Store.ReceiveVehicleArrival.run-1618"><a href="#Store.ReceiveVehicleArrival.run-1618"><span class="linenos">1618</span></a><span class="sd">                Output:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1619"><a href="#Store.ReceiveVehicleArrival.run-1619"><span class="linenos">1619</span></a><span class="sd">                    Print: &quot;Vehicle vehicle1@localhost delivered 50 units of electronics&quot;</span>
</span><span id="Store.ReceiveVehicleArrival.run-1620"><a href="#Store.ReceiveVehicleArrival.run-1620"><span class="linenos">1620</span></a><span class="sd">                    Print: &quot;Current stock: electronics: 250 units, food: 100 units&quot;</span>
</span><span id="Store.ReceiveVehicleArrival.run-1621"><a href="#Store.ReceiveVehicleArrival.run-1621"><span class="linenos">1621</span></a><span class="sd">                ```</span>
</span><span id="Store.ReceiveVehicleArrival.run-1622"><a href="#Store.ReceiveVehicleArrival.run-1622"><span class="linenos">1622</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Store.ReceiveVehicleArrival.run-1623"><a href="#Store.ReceiveVehicleArrival.run-1623"><span class="linenos">1623</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Store.ReceiveVehicleArrival.run-1624"><a href="#Store.ReceiveVehicleArrival.run-1624"><span class="linenos">1624</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1625"><a href="#Store.ReceiveVehicleArrival.run-1625"><span class="linenos">1625</span></a>            
</span><span id="Store.ReceiveVehicleArrival.run-1626"><a href="#Store.ReceiveVehicleArrival.run-1626"><span class="linenos">1626</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1627"><a href="#Store.ReceiveVehicleArrival.run-1627"><span class="linenos">1627</span></a>                <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1628"><a href="#Store.ReceiveVehicleArrival.run-1628"><span class="linenos">1628</span></a>                
</span><span id="Store.ReceiveVehicleArrival.run-1629"><a href="#Store.ReceiveVehicleArrival.run-1629"><span class="linenos">1629</span></a>                <span class="c1"># Double-check (should already be filtered by templates)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1630"><a href="#Store.ReceiveVehicleArrival.run-1630"><span class="linenos">1630</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">]:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1631"><a href="#Store.ReceiveVehicleArrival.run-1631"><span class="linenos">1631</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Received unexpected performative &#39;</span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1632"><a href="#Store.ReceiveVehicleArrival.run-1632"><span class="linenos">1632</span></a>                    <span class="k">return</span>
</span><span id="Store.ReceiveVehicleArrival.run-1633"><a href="#Store.ReceiveVehicleArrival.run-1633"><span class="linenos">1633</span></a>                
</span><span id="Store.ReceiveVehicleArrival.run-1634"><a href="#Store.ReceiveVehicleArrival.run-1634"><span class="linenos">1634</span></a>                <span class="c1"># Parse message body</span>
</span><span id="Store.ReceiveVehicleArrival.run-1635"><a href="#Store.ReceiveVehicleArrival.run-1635"><span class="linenos">1635</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1636"><a href="#Store.ReceiveVehicleArrival.run-1636"><span class="linenos">1636</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1637"><a href="#Store.ReceiveVehicleArrival.run-1637"><span class="linenos">1637</span></a>                    <span class="n">orderid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">]</span>
</span><span id="Store.ReceiveVehicleArrival.run-1638"><a href="#Store.ReceiveVehicleArrival.run-1638"><span class="linenos">1638</span></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">orderid</span><span class="p">]</span>
</span><span id="Store.ReceiveVehicleArrival.run-1639"><a href="#Store.ReceiveVehicleArrival.run-1639"><span class="linenos">1639</span></a>                    <span class="n">eta</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>          
</span><span id="Store.ReceiveVehicleArrival.run-1640"><a href="#Store.ReceiveVehicleArrival.run-1640"><span class="linenos">1640</span></a>                <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1641"><a href="#Store.ReceiveVehicleArrival.run-1641"><span class="linenos">1641</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Failed to parse vehicle message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1642"><a href="#Store.ReceiveVehicleArrival.run-1642"><span class="linenos">1642</span></a>                    <span class="k">return</span>
</span><span id="Store.ReceiveVehicleArrival.run-1643"><a href="#Store.ReceiveVehicleArrival.run-1643"><span class="linenos">1643</span></a>
</span><span id="Store.ReceiveVehicleArrival.run-1644"><a href="#Store.ReceiveVehicleArrival.run-1644"><span class="linenos">1644</span></a>                <span class="c1"># Vehicle is delivering supplies from supplier</span>
</span><span id="Store.ReceiveVehicleArrival.run-1645"><a href="#Store.ReceiveVehicleArrival.run-1645"><span class="linenos">1645</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span>
</span><span id="Store.ReceiveVehicleArrival.run-1646"><a href="#Store.ReceiveVehicleArrival.run-1646"><span class="linenos">1646</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="Store.ReceiveVehicleArrival.run-1647"><a href="#Store.ReceiveVehicleArrival.run-1647"><span class="linenos">1647</span></a>                
</span><span id="Store.ReceiveVehicleArrival.run-1648"><a href="#Store.ReceiveVehicleArrival.run-1648"><span class="linenos">1648</span></a>                <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1649"><a href="#Store.ReceiveVehicleArrival.run-1649"><span class="linenos">1649</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="Store.ReceiveVehicleArrival.run-1650"><a href="#Store.ReceiveVehicleArrival.run-1650"><span class="linenos">1650</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Store.ReceiveVehicleArrival.run-1651"><a href="#Store.ReceiveVehicleArrival.run-1651"><span class="linenos">1651</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Store.ReceiveVehicleArrival.run-1652"><a href="#Store.ReceiveVehicleArrival.run-1652"><span class="linenos">1652</span></a>                <span class="k">del</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span>
</span><span id="Store.ReceiveVehicleArrival.run-1653"><a href="#Store.ReceiveVehicleArrival.run-1653"><span class="linenos">1653</span></a>                
</span><span id="Store.ReceiveVehicleArrival.run-1654"><a href="#Store.ReceiveVehicleArrival.run-1654"><span class="linenos">1654</span></a>                <span class="c1"># Save order stats</span>
</span><span id="Store.ReceiveVehicleArrival.run-1655"><a href="#Store.ReceiveVehicleArrival.run-1655"><span class="linenos">1655</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span><span class="s2">&quot;delivered&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1656"><a href="#Store.ReceiveVehicleArrival.run-1656"><span class="linenos">1656</span></a>                
</span><span id="Store.ReceiveVehicleArrival.run-1657"><a href="#Store.ReceiveVehicleArrival.run-1657"><span class="linenos">1657</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> delivered </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Store.ReceiveVehicleArrival.run-1658"><a href="#Store.ReceiveVehicleArrival.run-1658"><span class="linenos">1658</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>    
</span></pre></div>


            <div class="docstring"><p>Execute one cycle of vehicle delivery message processing.</p>

<p>This method receives one delivery notification, updates inventory, records
statistics, and prepares for the next delivery message.</p>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Receive</strong>: Wait up to 20 seconds for message</li>
  <li><strong>Validation</strong>: Check performative is vehicle-delivery</li>
  <li><strong>Parsing</strong>: Deserialize JSON and extract orderid, time</li>
  <li><strong>Order Lookup</strong>: Find order in pending_deliveries</li>
  <li><strong>Stock Update</strong>: Add quantity to inventory (create or increment)</li>
  <li><strong>Cleanup</strong>: Remove order from pending_deliveries</li>
  <li><strong>Statistics</strong>: Record delivery details to CSV</li>
  <li><strong>Logging</strong>: Print delivery confirmation and stock display</li>
  </ol>
</blockquote>

<h6 id="error-handling">Error Handling:</h6>

<blockquote>
  <p>Three validation layers:</p>
  
  <ol>
  <li>Template filter (should only receive vehicle-delivery)</li>
  <li>Performative check (safety validation)</li>
  <li>Try-except for JSON parsing and order lookup</li>
  </ol>
</blockquote>

<h6 id="stock-update-details">Stock Update Details:</h6>

<blockquote>
  <ul>
  <li>Retrieves product and quantity from pending order</li>
  <li>If product exists: stock[product] += quantity</li>
  <li>If product new: stock[product] = quantity</li>
  <li>Thread-safe (single-threaded SPADE execution)</li>
  </ul>
</blockquote>

<h6 id="statistics-recording">Statistics Recording:</h6>

<blockquote>
  <p>Calls get_stats() with:</p>
  
  <ul>
  <li>order: Order object with all details</li>
  <li>eta: Estimated time from message</li>
  <li>state: "delivered" (success indicator)</li>
  <li>vehicle: Vehicle JID from message sender</li>
  </ul>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Increments stock for delivered product</li>
  <li>Removes order from pending_deliveries dict</li>
  <li>Appends row to store_stats.csv</li>
  <li>Prints to console (always visible, not verbose-only)</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Continues to next cycle after processing one delivery.</p>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
<pre><code>Input: vehicle-delivery from vehicle1
    Body: {"orderid": 1001000000, "time": 120}
Pending Order: Order(product="electronics", quantity=50, ...)
Processing:
    - Stock before: {"electronics": 200, "food": 100}
    - Update: electronics += 50
    - Stock after: {"electronics": 250, "food": 100}
    - Remove from pending_deliveries
    - Write CSV row
Output:
    Print: "Vehicle vehicle1@localhost delivered 50 units of electronics"
    Print: "Current stock: electronics: 250 units, food: 100 units"
</code></pre>
</blockquote>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>