<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>warehouse API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="index.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;
                Module Index
            </a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Warehouse">Warehouse</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Warehouse.__init__">Warehouse</a>
                        </li>
                        <li>
                                <a class="class" href="#Warehouse.ReceiveBuyRequest">Warehouse.ReceiveBuyRequest</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.ReceiveBuyRequest.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.AcceptBuyRequest">Warehouse.AcceptBuyRequest</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.AcceptBuyRequest.__init__">AcceptBuyRequest</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.AcceptBuyRequest.request_id">request_id</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.AcceptBuyRequest.quant">quant</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.AcceptBuyRequest.product">product</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.AcceptBuyRequest.sender">sender</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.AcceptBuyRequest.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.RejectBuyRequest">Warehouse.RejectBuyRequest</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.RejectBuyRequest.__init__">RejectBuyRequest</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.RejectBuyRequest.request_id">request_id</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.RejectBuyRequest.quant">quant</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.RejectBuyRequest.product">product</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.RejectBuyRequest.sender">sender</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.RejectBuyRequest.reason">reason</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.RejectBuyRequest.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.ReceiveConfirmationOrDenial">Warehouse.ReceiveConfirmationOrDenial</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.ReceiveConfirmationOrDenial.__init__">ReceiveConfirmationOrDenial</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.ReceiveConfirmationOrDenial.accepted_id">accepted_id</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.ReceiveConfirmationOrDenial.accepted_quantity">accepted_quantity</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.ReceiveConfirmationOrDenial.accepted_product">accepted_product</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.ReceiveConfirmationOrDenial.sender_jid">sender_jid</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.ReceiveConfirmationOrDenial.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.AssignVehicle">Warehouse.AssignVehicle</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.AssignVehicle.__init__">AssignVehicle</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.AssignVehicle.request_id">request_id</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts">populate_vehicles_from_contacts</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.AssignVehicle.create_presence_info_message">create_presence_info_message</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.AssignVehicle.create_call_for_proposal_message">create_call_for_proposal_message</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.AssignVehicle.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.ReceivePresenceInfo">Warehouse.ReceivePresenceInfo</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.ReceivePresenceInfo.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.ReceiveVehicleProposals">Warehouse.ReceiveVehicleProposals</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.ReceiveVehicleProposals.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.ChooseBestVehicle">Warehouse.ChooseBestVehicle</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.ChooseBestVehicle.__init__">ChooseBestVehicle</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.ChooseBestVehicle.request_id">request_id</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.ChooseBestVehicle.n_sent_messages">n_sent_messages</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.ChooseBestVehicle.get_best_vehicle">get_best_vehicle</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.ChooseBestVehicle.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.BuyMaterial">Warehouse.BuyMaterial</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.BuyMaterial.__init__">BuyMaterial</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.BuyMaterial.quantity">quantity</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.BuyMaterial.product">product</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.BuyMaterial.populate_suppliers_from_contacts">populate_suppliers_from_contacts</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.BuyMaterial.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.CollectSupplierResponses">Warehouse.CollectSupplierResponses</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.CollectSupplierResponses.__init__">CollectSupplierResponses</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.CollectSupplierResponses.request_id">request_id</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.CollectSupplierResponses.buy_msg">buy_msg</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.CollectSupplierResponses.num_suppliers">num_suppliers</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.CollectSupplierResponses.quantity">quantity</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.CollectSupplierResponses.product">product</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.CollectSupplierResponses.acceptances">acceptances</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.CollectSupplierResponses.rejections">rejections</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.CollectSupplierResponses.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.ReceiveAllSupplierResponses">Warehouse.ReceiveAllSupplierResponses</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.ReceiveAllSupplierResponses.__init__">ReceiveAllSupplierResponses</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.ReceiveAllSupplierResponses.request_id">request_id</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.ReceiveAllSupplierResponses.num_suppliers">num_suppliers</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.ReceiveAllSupplierResponses.acceptances">acceptances</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.ReceiveAllSupplierResponses.rejections">rejections</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.ReceiveAllSupplierResponses.responses_received">responses_received</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.ReceiveAllSupplierResponses.timeout">timeout</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.ReceiveAllSupplierResponses.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.SendWarehouseConfirmation">Warehouse.SendWarehouseConfirmation</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.SendWarehouseConfirmation.__init__">SendWarehouseConfirmation</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.SendWarehouseConfirmation.dest">dest</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.SendWarehouseConfirmation.request_id">request_id</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.SendWarehouseConfirmation.quantity">quantity</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.SendWarehouseConfirmation.product">product</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.SendWarehouseConfirmation.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.SendWarehouseDenial">Warehouse.SendWarehouseDenial</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.SendWarehouseDenial.__init__">SendWarehouseDenial</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.SendWarehouseDenial.dest">dest</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.SendWarehouseDenial.request_id">request_id</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.SendWarehouseDenial.quantity">quantity</a>
                                    </li>
                                    <li>
                                            <a class="variable" href="#Warehouse.SendWarehouseDenial.product">product</a>
                                    </li>
                                    <li>
                                            <a class="function" href="#Warehouse.SendWarehouseDenial.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.RetryPreviousBuy">Warehouse.RetryPreviousBuy</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.RetryPreviousBuy.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.HandleResupply">Warehouse.HandleResupply</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.HandleResupply.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.ReceiveVehicleArrival">Warehouse.ReceiveVehicleArrival</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.ReceiveVehicleArrival.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="class" href="#Warehouse.ReceiveTimeDelta">Warehouse.ReceiveTimeDelta</a>
                                        <ul class="memberlist">
                                    <li>
                                            <a class="function" href="#Warehouse.ReceiveTimeDelta.run">run</a>
                                    </li>
                            </ul>

                        </li>
                        <li>
                                <a class="function" href="#Warehouse.calculate_supplier_score">calculate_supplier_score</a>
                        </li>
                        <li>
                                <a class="function" href="#Warehouse.message_to_order">message_to_order</a>
                        </li>
                        <li>
                                <a class="function" href="#Warehouse.set_buy_metadata">set_buy_metadata</a>
                        </li>
                        <li>
                                <a class="function" href="#Warehouse.update_graph">update_graph</a>
                        </li>
                        <li>
                                <a class="function" href="#Warehouse.print_stock">print_stock</a>
                        </li>
                        <li>
                                <a class="function" href="#Warehouse.dict_to_order">dict_to_order</a>
                        </li>
                        <li>
                                <a class="variable" href="#Warehouse.node_id">node_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#Warehouse.map">map</a>
                        </li>
                        <li>
                                <a class="variable" href="#Warehouse.contact_list">contact_list</a>
                        </li>
                        <li>
                                <a class="variable" href="#Warehouse.verbose">verbose</a>
                        </li>
                        <li>
                                <a class="variable" href="#Warehouse.id_base">id_base</a>
                        </li>
                        <li>
                                <a class="variable" href="#Warehouse.pending_deliveries">pending_deliveries</a>
                        </li>
                        <li>
                                <a class="variable" href="#Warehouse.vehicle_proposals">vehicle_proposals</a>
                        </li>
                        <li>
                                <a class="variable" href="#Warehouse.vehicles">vehicles</a>
                        </li>
                        <li>
                                <a class="variable" href="#Warehouse.suppliers">suppliers</a>
                        </li>
                        <li>
                                <a class="variable" href="#Warehouse.request_counter">request_counter</a>
                        </li>
                        <li>
                                <a class="function" href="#Warehouse.setup">setup</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
warehouse    </h1>

                        <div class="docstring"><p>Warehouse Agent Module for Supply Chain Optimization System.</p>

<p>This module implements the Warehouse agent, which serves as an intermediary in the supply
chain between stores and suppliers. The Warehouse manages inventory, accepts orders from
stores, purchases materials from suppliers, and coordinates vehicle delivery logistics.</p>

<p>The module implements dual FIPA Contract Net Protocol roles:</p>

<ol>
<li><strong>Participant</strong> (with Stores): Responds to store purchase requests</li>
<li><strong>Initiator</strong> (with Suppliers): Initiates purchase requests for restocking</li>
</ol>

<h6 id="typical-usage-example">Typical usage example:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">world.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">Graph</span>

<span class="c1"># Initialize graph and warehouse agent</span>
<span class="n">map_graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
<span class="n">warehouse</span> <span class="o">=</span> <span class="n">Warehouse</span><span class="p">(</span>
    <span class="n">jid</span><span class="o">=</span><span class="s2">&quot;warehouse1@localhost&quot;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s2">&quot;warehouse_password&quot;</span><span class="p">,</span>
    <span class="nb">map</span><span class="o">=</span><span class="n">map_graph</span><span class="p">,</span>
    <span class="n">node_id</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">contact_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;store1@localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;supplier1@localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle1@localhost&quot;</span><span class="p">],</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">await</span> <span class="n">warehouse</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre>
  </div>
</blockquote>
</div>

                        <input id="mod-warehouse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-warehouse-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="sd">Warehouse Agent Module for Supply Chain Optimization System.</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="sd">This module implements the Warehouse agent, which serves as an intermediary in the supply</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="sd">chain between stores and suppliers. The Warehouse manages inventory, accepts orders from</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="sd">stores, purchases materials from suppliers, and coordinates vehicle delivery logistics.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="sd">The module implements dual FIPA Contract Net Protocol roles:</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="sd">1. **Participant** (with Stores): Responds to store purchase requests</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="sd">2. **Initiator** (with Suppliers): Initiates purchase requests for restocking</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="sd">Typical usage example:</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">    ```python</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="sd">    from world.graph import Graph</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="sd">    </span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="sd">    # Initialize graph and warehouse agent</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">    map_graph = Graph()</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">    warehouse = Warehouse(</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">        jid=&quot;warehouse1@localhost&quot;,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">        password=&quot;warehouse_password&quot;,</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">        map=map_graph,</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">        node_id=10,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">        contact_list=[&quot;store1@localhost&quot;, &quot;supplier1@localhost&quot;, &quot;vehicle1@localhost&quot;],</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="sd">        verbose=True</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="sd">    )</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="sd">    await warehouse.start()</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="sd">    ```</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">spade</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.behaviour</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneShotBehaviour</span><span class="p">,</span> <span class="n">CyclicBehaviour</span><span class="p">,</span> <span class="n">PeriodicBehaviour</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">Message</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">Template</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">spade.presence</span><span class="w"> </span><span class="kn">import</span> <span class="n">PresenceShow</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">world.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">Edge</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">veiculos.veiculos</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="c1"># Export only the Warehouse class at module level</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Warehouse&#39;</span><span class="p">]</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="c1"># Hide auxiliary functions, internal members, and behaviour __init__ methods from pdoc sidebar</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="n">__pdoc__</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>    <span class="c1"># Hide auxiliary functions</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>    <span class="s1">&#39;Warehouse.calculate_supplier_score&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>    <span class="s1">&#39;Warehouse.message_to_order&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>    <span class="s1">&#39;Warehouse.set_buy_metadata&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>    <span class="s1">&#39;Warehouse.update_graph&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>    <span class="s1">&#39;Warehouse.print_stock&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>    <span class="s1">&#39;Warehouse.dict_to_order&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>    <span class="c1"># Hide internal class variables</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>    <span class="s1">&#39;Warehouse.id_counter&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>    <span class="s1">&#39;Warehouse.id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>    <span class="s1">&#39;Warehouse.graph&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>    <span class="s1">&#39;Warehouse.stock&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>    <span class="s1">&#39;Warehouse.stores&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>    <span class="s1">&#39;Warehouse.suppliers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>    <span class="s1">&#39;Warehouse.orders&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>    <span class="s1">&#39;Warehouse.orders_lock&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>    <span class="s1">&#39;Warehouse.vehicles&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>    <span class="s1">&#39;Warehouse.available_vehicles&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>    <span class="s1">&#39;Warehouse.vehicles_lock&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>    <span class="s1">&#39;Warehouse.vehicles_in_transit&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>    <span class="s1">&#39;Warehouse.total_cost&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>    <span class="s1">&#39;Warehouse.total_time&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>    <span class="s1">&#39;Warehouse.world_agent&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>    <span class="c1"># Hide behaviour __init__ methods (show only run)</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>    <span class="s1">&#39;Warehouse.ReceiveBuyRequest.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>    <span class="s1">&#39;Warehouse.AcceptBuyRequest.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>    <span class="s1">&#39;Warehouse.RejectBuyRequest.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>    <span class="s1">&#39;Warehouse.ReceiveConfirmationOrDenial.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>    <span class="s1">&#39;Warehouse.AssignVehicle.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>    <span class="s1">&#39;Warehouse.ReceivePresenceInfo.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>    <span class="s1">&#39;Warehouse.ReceiveVehicleProposals.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>    <span class="s1">&#39;Warehouse.ChooseBestVehicle.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>    <span class="s1">&#39;Warehouse.BuyMaterial.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>    <span class="s1">&#39;Warehouse.CollectSupplierResponses.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>    <span class="s1">&#39;Warehouse.ReceiveAllSupplierResponses.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>    <span class="s1">&#39;Warehouse.SendWarehouseConfirmation.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>    <span class="s1">&#39;Warehouse.SendWarehouseDenial.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>    <span class="s1">&#39;Warehouse.RetryPreviousBuy.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>    <span class="s1">&#39;Warehouse.HandleResupply.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>    <span class="s1">&#39;Warehouse.ReceiveVehicleArrival.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>    <span class="s1">&#39;Warehouse.ReceiveTimeDelta.__init__&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>    <span class="c1"># Hide behaviour instance variables (Store interaction)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>    <span class="s1">&#39;Warehouse.ReceiveBuyRequest.request_id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>    <span class="s1">&#39;Warehouse.ReceiveBuyRequest.store_jid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>    <span class="s1">&#39;Warehouse.AcceptBuyRequest.dest&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>    <span class="s1">&#39;Warehouse.AcceptBuyRequest.request_id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>    <span class="s1">&#39;Warehouse.AcceptBuyRequest.quantity&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>    <span class="s1">&#39;Warehouse.AcceptBuyRequest.product&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>    <span class="s1">&#39;Warehouse.AcceptBuyRequest.price&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>    <span class="s1">&#39;Warehouse.AcceptBuyRequest.arrival_time&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>    <span class="s1">&#39;Warehouse.RejectBuyRequest.dest&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>    <span class="s1">&#39;Warehouse.RejectBuyRequest.request_id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>    <span class="s1">&#39;Warehouse.ReceiveConfirmationOrDenial.request_id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>    <span class="s1">&#39;Warehouse.ReceiveConfirmationOrDenial.store_jid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>    <span class="c1"># Hide behaviour instance variables (Supplier interaction)</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>    <span class="s1">&#39;Warehouse.BuyMaterial.quantity&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>    <span class="s1">&#39;Warehouse.BuyMaterial.product&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>    <span class="s1">&#39;Warehouse.CollectSupplierResponses.request_id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>    <span class="s1">&#39;Warehouse.CollectSupplierResponses.buy_msg&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>    <span class="s1">&#39;Warehouse.CollectSupplierResponses.num_suppliers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>    <span class="s1">&#39;Warehouse.CollectSupplierResponses.quantity&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>    <span class="s1">&#39;Warehouse.CollectSupplierResponses.product&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>    <span class="s1">&#39;Warehouse.CollectSupplierResponses.acceptances&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>    <span class="s1">&#39;Warehouse.CollectSupplierResponses.rejections&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>    <span class="s1">&#39;Warehouse.ReceiveAllSupplierResponses.request_id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>    <span class="s1">&#39;Warehouse.ReceiveAllSupplierResponses.num_suppliers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>    <span class="s1">&#39;Warehouse.ReceiveAllSupplierResponses.acceptances&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>    <span class="s1">&#39;Warehouse.ReceiveAllSupplierResponses.rejections&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>    <span class="s1">&#39;Warehouse.ReceiveAllSupplierResponses.responses_received&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>    <span class="s1">&#39;Warehouse.ReceiveAllSupplierResponses.timeout&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>    <span class="s1">&#39;Warehouse.SendWarehouseConfirmation.dest&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>    <span class="s1">&#39;Warehouse.SendWarehouseConfirmation.request_id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>    <span class="s1">&#39;Warehouse.SendWarehouseDenial.dest&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>    <span class="s1">&#39;Warehouse.SendWarehouseDenial.request_id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>    <span class="c1"># Hide behaviour instance variables (Vehicle coordination)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>    <span class="s1">&#39;Warehouse.ReceiveTimeDelta.order_id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>    <span class="s1">&#39;Warehouse.ReceiveTimeDelta.time_delta&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>    <span class="s1">&#39;Warehouse.ReceiveVehicleArrival.order_id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="p">}</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Warehouse</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">    Warehouse Agent for Supply Chain Management System.</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">    </span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">    The Warehouse agent acts as a critical intermediary in the supply chain, managing</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="sd">    inventory, fulfilling store orders, and coordinating with suppliers and vehicles.</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">    It implements dual FIPA Contract Net Protocol roles, acting as both participant</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="sd">    and initiator depending on the interaction context.</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">    </span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">    FIPA Contract Net Protocol - Dual Role Implementation:</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">    </span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">    1. **As Participant (with Stores)**:</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">        - **Proposal Phase**: Receives store-buy CFP from stores</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">        - **Proposal Submission**: Sends warehouse-accept (propose) or warehouse-reject (refuse)</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">        - **Result Reception**: Receives store-confirm (accept-proposal) or store-deny (reject-proposal)</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">        - **Execution**: Assigns vehicles for confirmed orders</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">    </span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">    2. **As Initiator (with Suppliers)**:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">        - **CFP Phase**: Sends warehouse-buy CFP to suppliers for restocking</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">        - **Proposal Collection**: Receives supplier-accept (propose) or supplier-reject (refuse)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd">        - **Evaluation**: Scores suppliers based on delivery time</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd">        - **Award**: Sends warehouse-confirm (accept-proposal) or warehouse-deny (reject-proposal)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">    </span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">    Stock Management Strategy:</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">        The warehouse uses a three-tier stock system:</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">        1. **Available Stock** (self.stock): Products available for new orders</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="sd">        2. **Locked Stock** (self.locked_stock): Reserved for pending negotiations</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">        3. **Pending Deliveries** (self.pending_deliveries): Confirmed orders awaiting pickup</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a><span class="sd">    </span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="sd">    ID Encoding System:</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">        Similar to Store agent, uses hierarchical encoding:</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">        - Formula: `agent_type * 100_000_000 + instance_id * 1_000_000 + request_counter`</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">        - Agent type code for Warehouse: 2</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">        - Example: warehouse1&#39;s first request = 2_001_000_000</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="sd">    </span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a><span class="sd">    Attributes:</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="sd">        jid (str): Jabber ID of the warehouse agent (e.g., &quot;warehouse1@localhost&quot;).</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a><span class="sd">        node_id (int): Graph node ID representing the warehouse&#39;s physical location.</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="sd">        map (Graph): Reference to the world graph for pathfinding calculations.</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="sd">        contact_list (list[str]): JIDs for stores, suppliers, and vehicles.</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="sd">        verbose (bool): Flag to control debug output verbosity.</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">        id_base (int): Base value for generating unique request IDs.</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">        stock (dict[str, int]): Available inventory (not locked or pending).</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">        locked_stock (dict[str, int]): Stock reserved during store negotiations.</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a><span class="sd">        current_capacity (dict[str, int]): Remaining capacity per product.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a><span class="sd">        pending_deliveries (dict[int, Order]): Confirmed orders awaiting vehicle pickup.</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a><span class="sd">        vehicle_proposals (dict[int, dict[str, tuple[bool, int]]]): Vehicle delivery proposals.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="sd">            Format: {order_id: {vehicle_jid: (can_fit, delivery_time)}}</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a><span class="sd">        vehicles (list[str]): List of vehicle JIDs discovered from contacts.</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">        suppliers (list[str]): List of supplier JIDs discovered from contacts.</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="sd">        request_counter (int): Monotonic counter for unique request IDs.</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">        current_buy_request (Message): Most recent supplier purchase request.</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">        failed_requests (queue.Queue): Queue of failed supplier requests for retry.</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">        presence_infos (dict[str, str]): Vehicle presence status cache.</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="sd">        current_tick (int): Current simulation time, synchronized by world agent.</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="sd">    </span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">    Behaviours:</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">        Store Interaction:</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a><span class="sd">            - ReceiveBuyRequest: Processes store purchase requests (FIPA participant)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a><span class="sd">            - AcceptBuyRequest: Sends proposal to store (FIPA propose)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="sd">            - RejectBuyRequest: Sends refusal to store (FIPA refuse)</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a><span class="sd">            - ReceiveConfirmationOrDenial: Handles store&#39;s award/rejection</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="sd">            - AssignVehicle: Coordinates vehicle assignment for deliveries</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">            - ReceivePresenceInfo: Checks vehicle availability</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">            - ReceiveVehicleProposals: Collects vehicle delivery proposals</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">            - ChooseBestVehicle: Selects optimal vehicle using scoring algorithm</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">        </span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">        Supplier Interaction:</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">            - BuyMaterial: Initiates purchase requests to suppliers (FIPA initiator)</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">            - CollectSupplierResponses: Coordinator for supplier negotiation</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">            - ReceiveAllSupplierResponses: Worker collecting supplier responses</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">            - SendWarehouseConfirmation: Awards contract to supplier (FIPA accept-proposal)</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">            - SendWarehouseDenial: Rejects supplier proposals (FIPA reject-proposal)</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">            - RetryPreviousBuy: Retries failed supplier requests</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="sd">            - HandleResupply: Monitors stock and triggers restocking</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">        </span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="sd">        Vehicle &amp; Time Management:</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="sd">            - ReceiveVehicleArrival: Handles vehicle pickup and delivery notifications</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a><span class="sd">            - ReceiveTimeDelta: Synchronizes time and applies traffic updates</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a><span class="sd">    </span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="sd">    Message Protocols:</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a><span class="sd">        Incoming from Stores:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a><span class="sd">            - store-buy: Purchase request (FIPA CFP)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a><span class="sd">            - store-confirm: Order confirmation (FIPA accept-proposal)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a><span class="sd">            - store-deny: Order rejection (FIPA reject-proposal)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a><span class="sd">        </span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a><span class="sd">        Outgoing to Stores:</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a><span class="sd">            - warehouse-accept: Order proposal (FIPA propose)</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a><span class="sd">            - warehouse-reject: Order refusal (FIPA refuse)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a><span class="sd">        </span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a><span class="sd">        Outgoing to Suppliers:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="sd">            - warehouse-buy: Purchase request (FIPA CFP)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="sd">            - warehouse-confirm: Supplier confirmation (FIPA accept-proposal)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a><span class="sd">            - warehouse-deny: Supplier rejection (FIPA reject-proposal)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">        </span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">        Incoming from Suppliers:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">            - supplier-accept: Material proposal (FIPA propose)</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="sd">            - supplier-reject: Material refusal (FIPA refuse)</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a><span class="sd">        </span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="sd">        Vehicle Communication:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="sd">            - order-proposal: Request vehicle delivery quote</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="sd">            - vehicle-proposal: Vehicle delivery proposal</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a><span class="sd">            - order-confirmation: Confirm vehicle assignment</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a><span class="sd">            - vehicle-pickup: Vehicle picks up order</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a><span class="sd">            - vehicle-delivery: Vehicle delivers supplies</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a><span class="sd">            - presence-info: Request vehicle availability</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a><span class="sd">            - presence-response: Vehicle availability status</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a><span class="sd">    </span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a><span class="sd">    Example:</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a><span class="sd">        ```python</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a><span class="sd">        warehouse = Warehouse(</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a><span class="sd">            jid=&quot;warehouse1@localhost&quot;,</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a><span class="sd">            password=&quot;password&quot;,</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a><span class="sd">            map=world_graph,</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a><span class="sd">            node_id=10,</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a><span class="sd">            contact_list=[&quot;store1@localhost&quot;, &quot;supplier1@localhost&quot;, &quot;vehicle1@localhost&quot;],</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a><span class="sd">            verbose=True</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a><span class="sd">        )</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a><span class="sd">        await warehouse.start()</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a><span class="sd">        ```</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a><span class="sd">    </span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a><span class="sd">    Note:</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a><span class="sd">        The warehouse automatically restocks when inventory falls below</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a><span class="sd">        config.WAREHOUSE_RESUPPLY_THRESHOLD, maintaining operational capacity.</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>    
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>    <span class="c1">#           WAREHOUSE &lt;-&gt; STORE</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>    
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveBuyRequest</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a><span class="sd">        Cyclic behaviour that processes incoming purchase requests from stores.</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a><span class="sd">        </span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="sd">        This behaviour implements the proposal phase of the FIPA Contract Net Protocol</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="sd">        where the warehouse acts as a **Participant**. It receives CFP messages from</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="sd">        stores, evaluates inventory availability, and responds with either a proposal</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">        (warehouse-accept) or refusal (warehouse-reject).</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a><span class="sd">        </span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">        FIPA Protocol Phase: **Proposal Phase - Participant Role**</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">            - Role: Participant (Warehouse responding to Store&#39;s CFP)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="sd">            - Receives: store-buy messages (FIPA CFP)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">            - Evaluates: Stock availability vs requested quantity</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">            - Responds: warehouse-accept (propose) or warehouse-reject (refuse)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">        </span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">        Stock Locking Mechanism:</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">            When accepting a request, stock is immediately moved from available to locked:</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">            - Prevents overselling (race condition protection)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">            - Reserved during negotiation (awaiting confirmation)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">            - Released if store sends denial or timeout occurs</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">            - Transferred to pending_deliveries if store confirms</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">        </span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">        Decision Logic:</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">            Accept if: (product in stock) AND (stock[product] &gt;= quantity)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">            Reject if: Product unavailable OR insufficient quantity</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a><span class="sd">        </span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="sd">        Message Format (store-buy):</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">            Metadata:</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a><span class="sd">                - performative: &quot;store-buy&quot;</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a><span class="sd">                - request_id: Unique request identifier</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="sd">            Body:</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">        </span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="sd">        Workflow:</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a><span class="sd">            1. **Receive**: Wait up to 20 seconds for store-buy message</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a><span class="sd">            2. **Parse**: Extract request_id, quantity, product from message</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="sd">            3. **Evaluate**: Check if product exists and quantity available</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">            4. **Accept Path**:</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a><span class="sd">                a. Lock stock: stock[product] -= quantity</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="sd">                b. Update locked_stock: locked_stock[product] += quantity</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a><span class="sd">                c. Launch AcceptBuyRequest behaviour (send warehouse-accept)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a><span class="sd">            5. **Reject Path**:</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a><span class="sd">                a. Launch RejectBuyRequest behaviour with reason</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a><span class="sd">                b. No stock changes</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a><span class="sd">        </span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a><span class="sd">        Concurrency Handling:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a><span class="sd">            - Processes multiple requests concurrently (cyclic behaviour)</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="sd">            - Stock locking prevents double-allocation</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a><span class="sd">            - Each request launches independent OneShot behaviours</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a><span class="sd">        </span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a><span class="sd">        Example Execution:</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a><span class="sd">            ```</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a><span class="sd">            Request Received: &quot;50 electronics&quot; (request_id=1001000000)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="sd">            Stock Check: electronics: 100 available</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="sd">            Decision: ACCEPT</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="sd">            Actions:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a><span class="sd">                - stock[electronics]: 100 -&gt; 50</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a><span class="sd">                - locked_stock[electronics]: 0 -&gt; 50</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a><span class="sd">                - Launch AcceptBuyRequest</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a><span class="sd">                - Wait for store-confirm or store-deny</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a><span class="sd">            ```</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a><span class="sd">        </span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a><span class="sd">        Note:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a><span class="sd">            This behaviour never terminates (cyclic), continuously listening for</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">            store requests throughout the warehouse&#39;s lifecycle.</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>        
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Awaiting buy request...&quot;</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="sd">                Messages with metadata (&quot;performative&quot;, &quot;store-buy&quot;) have body</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a><span class="sd">                with the following format:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="sd">                </span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a><span class="sd">                &quot;product_quantity product_type&quot;</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">                </span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a><span class="sd">                request_id is in metadata[&quot;request_id&quot;]</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a><span class="sd">                &quot;&quot;&quot;</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>                <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>                <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>                <span class="n">quant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Got request </span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">quant</span><span class="si">}</span><span class="s2"> x</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>                
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">quant</span><span class="p">:</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>                    <span class="n">accept_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">AcceptBuyRequest</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Locking </span><span class="si">{</span><span class="n">quant</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quant</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>                    
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>                    <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quant</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Items locked at </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>                    
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">accept_behav</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>                    <span class="c1"># Reject the request - insufficient stock</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                    <span class="n">reject_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">RejectBuyRequest</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;insufficient_stock&quot;</span><span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">reject_behav</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Could not satisfy request. Rejection sent.&quot;</span><span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Did not get any buy requests in 20 seconds.&quot;</span><span class="p">)</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">AcceptBuyRequest</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">        Behaviour that sends proposal acceptance to store (FIPA propose).</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="sd">        </span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a><span class="sd">        This behaviour implements the proposal submission in the FIPA Contract Net</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="sd">        Protocol where the warehouse, acting as a participant, sends its proposal</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a><span class="sd">        to fulfill the store&#39;s request. It then sets up to receive the store&#39;s</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="sd">        decision (accept-proposal or reject-proposal).</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="sd">        </span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="sd">        FIPA Protocol Phase: **Proposal Submission - Participant Role**</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="sd">            - Role: Participant (Warehouse proposing to Store)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="sd">            - Sends: warehouse-accept (FIPA propose)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a><span class="sd">            - Purpose: &quot;I can fulfill your request&quot;</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a><span class="sd">            - Next Phase: Await store&#39;s award or rejection decision</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="sd">        </span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="sd">        Attributes:</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="sd">            request_id (int): Unique identifier for this request.</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a><span class="sd">            quant (int): Quantity of product being proposed.</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">            product (str): Name of product being proposed.</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a><span class="sd">            sender (str): Store JID that initiated the request.</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="sd">        </span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="sd">        Message Format (warehouse-accept):</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">            Metadata:</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="sd">                - performative: &quot;warehouse-accept&quot; (FIPA propose)</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="sd">                - store_id: Requesting store&#39;s JID</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">                - node_id: Warehouse&#39;s graph location</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a><span class="sd">                - request_id: Original request identifier</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="sd">            Body:</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="sd">        </span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="sd">        Workflow:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="sd">            1. **Send Proposal**: Construct and send warehouse-accept message</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">            2. **Setup Listener**: Create ReceiveConfirmationOrDenial behaviour</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">            3. **Configure Template**: Filter for this specific store and request</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">            4. **Register Behaviour**: Add listener with template to agent</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">            5. **Non-blocking**: Return immediately (don&#39;t wait for response)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">        </span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">        Template Configuration:</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a><span class="sd">            Filters messages to match:</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="sd">            - warehouse_id: This warehouse</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">            - store_id: Specific store that made request</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">            - request_id: This specific request</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">            </span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">            Accepts both performatives:</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="sd">            - store-confirm (FIPA accept-proposal)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a><span class="sd">            - store-deny (FIPA reject-proposal)</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">        </span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="sd">        Example:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">            ```</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="sd">            Input: Store request for &quot;50 electronics&quot;</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="sd">            Proposal Sent: warehouse-accept with body &quot;50 electronics&quot;</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="sd">            Listener Setup: ReceiveConfirmationOrDenial waiting for:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">                - store-confirm (unlock -&gt; pending delivery) OR</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="sd">                - store-deny (unlock -&gt; available stock)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a><span class="sd">            ```</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a><span class="sd">        </span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a><span class="sd">        Note:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a><span class="sd">            Stock remains locked until ReceiveConfirmationOrDenial processes</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a><span class="sd">            the store&#39;s decision or times out.</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a><span class="sd">            Initialize the AcceptBuyRequest behaviour.</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="sd">            </span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="sd">            Args:</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="sd">                msg (Message): The store-buy request message to accept.</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a><span class="sd">                    Contains request_id in metadata and &quot;{quantity} {product}&quot; in body.</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>        
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="sd">            Execute the proposal sending and confirmation listener setup.</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a><span class="sd">            </span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a><span class="sd">            This method sends the warehouse-accept (FIPA propose) message to the store</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="sd">            and immediately sets up a listener behaviour to await the store&#39;s decision.</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="sd">            The method returns quickly without blocking, allowing the warehouse to</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="sd">            continue processing other requests concurrently.</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a><span class="sd">            </span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="sd">                - **Phase**: Proposal Submission</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="sd">                - **Performative**: warehouse-accept (FIPA propose)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="sd">                - **Content**: &quot;{quantity} {product}&quot;</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">                - **Receiver**: Store that sent the CFP</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">                - **Next Step**: Await store&#39;s accept-proposal or reject-proposal</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a><span class="sd">            </span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">            Workflow:</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">                1. **Log Acceptance** (verbose): Print proposal details</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a><span class="sd">                2. **Construct Message**: Create warehouse-accept with all metadata</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="sd">                3. **Send Proposal**: Transmit to requesting store</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="sd">                4. **Create Listener**: Initialize ReceiveConfirmationOrDenial behaviour</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">                5. **Setup Template**: Configure filter for this specific negotiation</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a><span class="sd">                6. **Register Listener**: Add behaviour with template to agent</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">                7. **Return**: Don&#39;t block (listener runs independently)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="sd">            </span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">            Template Filtering:</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">                The template ensures the listener only receives messages for THIS</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">                specific negotiation by matching:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">                - store_id: The specific store&#39;s JID</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">                - request_id: This specific request&#39;s ID</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="sd">            </span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="sd">            Non-Blocking Design:</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="sd">                The commented-out `await confirm_deny_behav.join()` demonstrates</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">                that we intentionally DON&#39;T wait for confirmation here. This allows</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">                the warehouse to accept multiple store requests concurrently.</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">            </span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">            Side Effects:</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">                - Sends SPADE message to store</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="sd">                - Adds ReceiveConfirmationOrDenial behaviour to agent</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="sd">                - Prints debug information if verbose enabled</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="sd">            </span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="sd">            Returns:</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a><span class="sd">                None. Completes immediately after setting up the listener.</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a><span class="sd">            </span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a><span class="sd">            Example:</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a><span class="sd">                ```</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a><span class="sd">                Input: Request for &quot;50 electronics&quot; from store1</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a><span class="sd">                Actions:</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a><span class="sd">                    1. Send warehouse-accept to store1</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a><span class="sd">                    2. Setup listener with template matching:</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a><span class="sd">                       - warehouse_id=warehouse1@localhost</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a><span class="sd">                       - store_id=store1@localhost</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="sd">                       - request_id=1001000000</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a><span class="sd">                    3. Return (warehouse ready for next request)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a><span class="sd">                Listener waits independently for store&#39;s decision</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a><span class="sd">                ```</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>            
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Accepted a request from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">: &quot;</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>                    <span class="sa">f</span><span class="s2">&quot;id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>                    <span class="sa">f</span><span class="s2">&quot;quant=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>                    <span class="sa">f</span><span class="s2">&quot;product=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>                <span class="p">)</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>            
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>            
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-accept&quot;</span><span class="p">)</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">))</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>            
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>            
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>            <span class="c1"># Wait for either confirmation or denial</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>            <span class="n">confirm_deny_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ReceiveConfirmationOrDenial</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>            
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>            <span class="c1"># Template that matches BOTH store-confirm AND store-deny</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">))</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">confirm_deny_behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; AcceptBuyRequest finished, now waiting for confirmation or denial...&quot;</span><span class="p">)</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            <span class="c1"># Aguardar a confirmao ser recebida antes de terminar</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>            <span class="c1"># await confirm_deny_behav.join()</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>    
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">RejectBuyRequest</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a><span class="sd">        Behaviour that sends proposal refusal to store (FIPA refuse).</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a><span class="sd">        </span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a><span class="sd">        This behaviour implements the refusal response in the FIPA Contract Net Protocol</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a><span class="sd">        where the warehouse, acting as a participant, declines to fulfill the store&#39;s</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a><span class="sd">        request due to insufficient inventory or other constraints.</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a><span class="sd">        </span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a><span class="sd">        FIPA Protocol Phase: **Proposal Phase - Refusal**</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a><span class="sd">            - Role: Participant (Warehouse declining Store&#39;s CFP)</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a><span class="sd">            - Sends: warehouse-reject (FIPA refuse)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a><span class="sd">            - Purpose: &quot;I cannot fulfill your request&quot;</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a><span class="sd">            - Reason: Typically &quot;insufficient_stock&quot;</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a><span class="sd">            - Result: Store will try other warehouses</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a><span class="sd">        </span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a><span class="sd">        Attributes:</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a><span class="sd">            request_id (int): Unique identifier for this request.</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a><span class="sd">            quant (int): Requested quantity that cannot be fulfilled.</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a><span class="sd">            product (str): Requested product that is unavailable/insufficient.</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a><span class="sd">            sender (str): Store JID that initiated the request.</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a><span class="sd">            reason (str): Rejection reason (default: &quot;insufficient_stock&quot;).</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="sd">        </span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a><span class="sd">        Message Format (warehouse-reject):</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a><span class="sd">            Metadata:</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a><span class="sd">                - performative: &quot;warehouse-reject&quot; (FIPA refuse)</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="sd">                - store_id: Requesting store&#39;s JID</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a><span class="sd">                - node_id: Warehouse&#39;s graph location</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a><span class="sd">                - request_id: Original request identifier</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a><span class="sd">            Body:</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a><span class="sd">                - Format: &quot;{quantity} {product} {reason}&quot;</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a><span class="sd">                - Example: &quot;50 electronics insufficient_stock&quot;</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a><span class="sd">        </span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a><span class="sd">        Common Rejection Reasons:</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="sd">            - &quot;insufficient_stock&quot;: Not enough product available</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a><span class="sd">            - &quot;product_unavailable&quot;: Product not carried by this warehouse</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a><span class="sd">            - &quot;capacity_exceeded&quot;: Order too large for capacity constraints</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">        </span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="sd">        Example:</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="sd">            ```</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">            Request: &quot;100 electronics&quot; (only 50 available)</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="sd">            Decision: REJECT</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">            Message Sent: warehouse-reject</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">                Body: &quot;100 electronics insufficient_stock&quot;</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="sd">            Result: Stock unchanged, store tries other warehouses</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="sd">            ```</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">        </span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">        Note:</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a><span class="sd">            Unlike AcceptBuyRequest, this behaviour does NOT set up any listeners</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">            because no further interaction is expected after refusal.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">reason</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;insufficient_stock&quot;</span><span class="p">):</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="sd">            Initialize the RejectBuyRequest behaviour.</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">            </span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">            Args:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a><span class="sd">                msg (Message): The store-buy request message to reject.</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a><span class="sd">                reason (str, optional): Reason for rejection. Defaults to &quot;insufficient_stock&quot;.</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>            <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a><span class="sd">            Send warehouse-reject message to requesting store.</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a><span class="sd">            </span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a><span class="sd">                - Phase: Proposal Refusal</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="sd">                - Performative: warehouse-reject (FIPA refuse)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="sd">                - Direction: Warehouse  Store</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a><span class="sd">            </span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a><span class="sd">            Workflow:</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a><span class="sd">                1. **Log Rejection** (verbose): Print rejection details</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="sd">                2. **Construct Message**: Create warehouse-reject with metadata</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a><span class="sd">                3. **Include Reason**: Add rejection reason to message body</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">                4. **Send Refusal**: Transmit to requesting store</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a><span class="sd">                5. **Complete**: No further interaction (one-shot behaviour)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a><span class="sd">            </span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="sd">            Side Effects:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a><span class="sd">                - No stock changes (was never locked for insufficient stock)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a><span class="sd">                - No listeners created (conversation ends with refusal)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a><span class="sd">                - Store receives refusal and tries other warehouses</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a><span class="sd">                - Prints debug information if verbose enabled</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a><span class="sd">            </span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a><span class="sd">            Returns:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a><span class="sd">                None. Completes immediately after sending message.</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>            
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Rejected request from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">: &quot;</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>                    <span class="sa">f</span><span class="s2">&quot;id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>                    <span class="sa">f</span><span class="s2">&quot;quant=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>                    <span class="sa">f</span><span class="s2">&quot;product=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                    <span class="sa">f</span><span class="s2">&quot;reason=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>                <span class="p">)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>            
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-reject&quot;</span><span class="p">)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">))</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>            
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; RejectBuyRequest sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>           
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>    
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveConfirmationOrDenial</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a><span class="sd">        Behaviour that processes store&#39;s award or rejection decision (FIPA result notification).</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a><span class="sd">        </span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">        This behaviour implements the result notification reception in the FIPA Contract Net</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a><span class="sd">        Protocol where the warehouse, acting as a participant, receives the store&#39;s final</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="sd">        decision about whether its proposal was accepted or rejected.</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="sd">        </span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="sd">        FIPA Protocol Phase: **Result Notification Reception - Participant Role**</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a><span class="sd">            - Role: Participant (Warehouse receiving Store&#39;s decision)</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a><span class="sd">            - Receives: store-confirm (FIPA accept-proposal) or store-deny (FIPA reject-proposal)</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a><span class="sd">            - Actions:</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a><span class="sd">                - If confirm: Transfer locked stock to pending deliveries, assign vehicle</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a><span class="sd">                - If deny: Release locked stock back to available inventory</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a><span class="sd">                - If timeout: Release locked stock (store chose another warehouse)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a><span class="sd">        </span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a><span class="sd">        Stock State Transitions:</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="sd">        </span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a><span class="sd">            **On store-confirm (Award)**:</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="sd">                1. locked_stock[product] -= quantity (release lock)</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">                2. current_capacity[product] += quantity (update capacity tracking)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">                3. Create Order object from message</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a><span class="sd">                4. pending_deliveries[order_id] = order (await vehicle pickup)</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a><span class="sd">                5. Launch AssignVehicle behaviour</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="sd">            </span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">            **On store-deny or timeout (Rejection/Timeout)**:</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">                1. locked_stock[product] -= quantity (release lock)</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">                2. stock[product] += quantity (return to available)</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">                3. No further action needed</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">        </span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">        Attributes:</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">            accepted_id (int): Request ID for which we sent proposal.</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a><span class="sd">            accepted_quantity (int): Quantity that was proposed.</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="sd">            accepted_product (str): Product that was proposed.</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="sd">            sender_jid (str): Store JID that will send decision.</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a><span class="sd">        </span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a><span class="sd">        Timeout Mechanism:</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a><span class="sd">            - Wait time: 10 seconds</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a><span class="sd">            - Interpretation: Store chose another warehouse (implicit rejection)</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a><span class="sd">            - Action: Unlock stock automatically</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="sd">        </span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a><span class="sd">        Example Execution:</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a><span class="sd">        </span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="sd">            **Scenario 1: Store Confirms**</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a><span class="sd">            ```</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a><span class="sd">            Proposed: 50 electronics</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a><span class="sd">            Message Received: store-confirm &quot;50 electronics&quot;</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a><span class="sd">            Actions:</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a><span class="sd">                - locked_stock[electronics]: 50 -&gt; 0</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a><span class="sd">                - pending_deliveries[1001000000] = Order(...)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a><span class="sd">                - Launch AssignVehicle(1001000000)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a><span class="sd">                - Print: &quot;Order 1001000000 confirmed...&quot;</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="sd">            ```</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a><span class="sd">            </span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a><span class="sd">            **Scenario 2: Store Denies**</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a><span class="sd">            ```</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a><span class="sd">            Proposed: 50 electronics</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a><span class="sd">            Message Received: store-deny &quot;50 electronics&quot;</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="sd">            Actions:</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a><span class="sd">                - locked_stock[electronics]: 50 -&gt; 0</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="sd">                - stock[electronics]: 50 -&gt; 100</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="sd">                - Print: &quot;Store chose another warehouse&quot;</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="sd">            ```</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a><span class="sd">            </span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a><span class="sd">            **Scenario 3: Timeout**</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="sd">            ```</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a><span class="sd">            Proposed: 50 electronics</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a><span class="sd">            Message Received: None (10 second timeout)</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a><span class="sd">            Actions:</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a><span class="sd">                - locked_stock[electronics]: 50 -&gt; 0</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a><span class="sd">                - stock[electronics]: 50 -&gt; 100</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a><span class="sd">                - Print: &quot;No confirmation received, unlocking stock&quot;</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a><span class="sd">            ```</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="sd">        </span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="sd">        Note:</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">            This behaviour is automatically filtered by template to only receive</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a><span class="sd">            messages for the specific warehouse, store, and request_id combination.</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">sender_jid</span><span class="p">):</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="sd">            Initialize the ReceiveConfirmationOrDenial behaviour.</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="sd">            </span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">            Args:</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a><span class="sd">                accept_msg (Message): The warehouse-accept message we sent.</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="sd">                    Used to extract proposal details for stock unlocking if needed.</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">                sender_jid (str): JID of the store that will send the decision.</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accepted_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">accept_msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>            <span class="n">bod</span> <span class="o">=</span> <span class="n">accept_msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accepted_quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bod</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accepted_product</span> <span class="o">=</span> <span class="n">bod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sender_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sender_jid</span><span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Waiting for store confirmation or denial...&quot;</span><span class="p">)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>            
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>                <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>                
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>                <span class="c1"># Message with body format &quot;quantity product&quot;</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>                <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>                
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;store-confirm&quot;</span><span class="p">:</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>                    <span class="c1"># Store confirmed - update locked stock and add to pending orders</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quantity</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">current_capacity</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>                    
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>                    <span class="c1"># Create Order object from message</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                    <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">message_to_order</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                    
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>                    <span class="c1"># Add to pending_deliveries dict with order_id as key</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>                            
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>                    <span class="c1"># Essential print - order confirmed</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2"> confirmed: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> x</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>                    
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>                    <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">AssignVehicle</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">)</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>                    
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;store-deny&quot;</span><span class="p">:</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>                    <span class="c1"># Store denied (chose another warehouse) - unlock the stock</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Denial received! Store chose another warehouse.&quot;</span><span class="p">)</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Unlocking stock: </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> += </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>                    
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quantity</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>                    
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>                    
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Timeout: No confirmation or denial received in 10 seconds. Unlocking stock...&quot;</span><span class="p">)</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">accepted_product</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted_quantity</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">accepted_product</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted_quantity</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>            
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>    
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">AssignVehicle</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>        
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">populate_vehicles_from_contacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Populate vehicles list from presence contacts if empty&quot;&quot;&quot;</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>            
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>            <span class="c1"># Get all vehicles from presence contacts</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>            <span class="n">vehicles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;vehicle&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>            
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>            <span class="k">if</span> <span class="n">vehicles</span><span class="p">:</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="n">vehicles</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Discovered </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span><span class="si">}</span><span class="s2"> vehicle(s) from presence: </span><span class="si">{</span><span class="n">vehicles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  No vehicles found in presence contacts yet!&quot;</span><span class="p">)</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>            
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">create_presence_info_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>            
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">)</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;presence-info&quot;</span><span class="p">)</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>            <span class="k">return</span> <span class="n">msg</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>            
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">create_call_for_proposal_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>            
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">)</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;order-proposal&quot;</span><span class="p">)</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>            
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">]</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>            <span class="n">new_body</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>                <span class="s2">&quot;orderid&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>                <span class="s2">&quot;product&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="p">,</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>                <span class="s2">&quot;quantity&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>                <span class="s2">&quot;sender&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">receiver</span><span class="p">,</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>                <span class="s2">&quot;receiver&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>                <span class="s2">&quot;sender_location&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span><span class="p">,</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>                <span class="s2">&quot;receiver_location&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>            <span class="p">}</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>            
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_body</span><span class="p">)</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>            <span class="k">return</span> <span class="n">msg</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>            
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>            <span class="c1"># Populate vehicles from contacts</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            <span class="n">has_vehicles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populate_vehicles_from_contacts</span><span class="p">()</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>            
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_vehicles</span><span class="p">:</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  ERROR: No vehicles found in contacts!&quot;</span><span class="p">)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Make sure vehicles are started and have subscribed to this supplier.&quot;</span><span class="p">)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>                <span class="k">return</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>            
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Requesting vehicle proposals...&quot;</span><span class="p">)</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicles to contact: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">vehicles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>            
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>            <span class="c1"># Enviar mensagens de proposal a todos os veculos</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>            <span class="c1"># No verificamos presena - deixamos cada veculo decidir se pode aceitar</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>            <span class="n">n_available_vehicles</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>            <span class="n">n_sent_messages</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>            <span class="n">away_vehicles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>            <span class="k">for</span> <span class="n">vehicle_jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicles</span><span class="p">:</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>                
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_presence_info_message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>                
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">ReceivePresenceInfo</span><span class="p">()</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>                <span class="n">temp</span> <span class="p">:</span> <span class="n">Template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>                <span class="n">temp</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;presence-response&quot;</span><span class="p">)</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>                <span class="n">temp</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;vehicle_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle_jid</span><span class="p">))</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>                
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Presence info from </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>                
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="p">[</span><span class="n">vehicle_jid</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PresenceShow.CHAT&quot;</span><span class="p">:</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>                    <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_call_for_proposal_message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>                    <span class="n">n_available_vehicles</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>                    <span class="n">n_sent_messages</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Sent order proposal to </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>                
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>                <span class="k">elif</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="p">[</span><span class="n">vehicle_jid</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PresenceShow.AWAY&quot;</span> <span class="ow">and</span> <span class="n">n_available_vehicles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>                    <span class="n">away_vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Vehicle </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2"> is away.&quot;</span><span class="p">)</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>                    
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>            <span class="k">if</span> <span class="n">n_available_vehicles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  No AVAILABLE vehicles found. All vehicles are AWAY.&quot;</span><span class="p">)</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>                <span class="k">for</span> <span class="n">vehicle_jid</span> <span class="ow">in</span> <span class="n">away_vehicles</span><span class="p">:</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>                    <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_call_for_proposal_message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>                    
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>                    <span class="n">n_sent_messages</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Sent order proposal to </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>            
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Sent proposals to </span><span class="si">{</span><span class="n">n_sent_messages</span><span class="si">}</span><span class="s2"> vehicle(s)&quot;</span><span class="p">)</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>                    
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>            <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">ChooseBestVehicle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span> <span class="n">n_sent_messages</span><span class="p">)</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>            
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>            <span class="c1"># Waits for all vehicle proposals to be received</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>            <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>    
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceivePresenceInfo</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a><span class="sd">        Behaviour to receive presence information from vehicle agents.</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="sd">        </span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a><span class="sd">        This behaviour requests and collects availability status from vehicle agents,</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a><span class="sd">        which is used to determine which vehicles are available for delivery tasks.</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">        The presence information indicates whether a vehicle is busy, available, or</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a><span class="sd">        in another state.</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a><span class="sd">        </span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="sd">        The behaviour waits for a single response from a vehicle agent containing</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a><span class="sd">        its current presence status. This information is stored in the warehouse&#39;s</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="sd">        presence_infos dictionary for later use in vehicle selection.</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">        </span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a><span class="sd">        Workflow:</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="sd">            1. **Receive Message**: Wait up to 10 seconds for presence response</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="sd">            2. **Parse JSON**: Extract presence_show status from message body</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a><span class="sd">            3. **Store Information**: Save presence info indexed by vehicle_id</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a><span class="sd">            4. **Handle Timeout**: Print warning if no response received</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a><span class="sd">        </span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="sd">            - Updates agent.presence_infos dictionary with vehicle status</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a><span class="sd">            - Prints presence information if verbose mode enabled</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">        </span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="sd">        Returns:</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">            None. Completes after receiving one presence message or timing out.</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="sd">        </span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">        Example:</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a><span class="sd">            ```</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">            Message Received:</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">                Metadata: vehicle_id = &quot;vehicle1@localhost&quot;</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">                Body: {&quot;presence_show&quot;: &quot;available&quot;}</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">            Processing:</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">                - presence_infos[&quot;vehicle1@localhost&quot;] = &quot;available&quot;</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="sd">            Output:</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">                - Print: &quot;Received presence info response from vehicle1: available&quot;</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">            ```</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="sd">        </span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="sd">        Note:</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">            The 10-second timeout prevents indefinite blocking if a vehicle agent</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a><span class="sd">            is offline or unresponsive.</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>            
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>            
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>                <span class="n">presence_info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;presence_show&quot;</span><span class="p">]</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received presence info response from </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">:&quot;</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">presence_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;vehicle_id&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">presence_info</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No presence info response received from vehicle.&quot;</span><span class="p">)</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>    
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveVehicleProposals</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">        Cyclic behaviour that collects vehicle delivery proposals for orders.</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="sd">        </span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">        This behaviour implements the proposal collection phase of vehicle selection.</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a><span class="sd">        After the warehouse sends delivery requests to vehicles, this behaviour</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a><span class="sd">        continuously receives and stores vehicle proposals containing delivery capacity</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="sd">        and estimated delivery time information.</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a><span class="sd">        </span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a><span class="sd">        The behaviour runs in an infinite loop within each execution, collecting all</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a><span class="sd">        available proposals until a timeout occurs (no more proposals arriving). Each</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a><span class="sd">        proposal is indexed by order_id and vehicle_jid for later evaluation.</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a><span class="sd">        </span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a><span class="sd">        Proposal Data Structure:</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a><span class="sd">            ```python</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a><span class="sd">            vehicle_proposals = {</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a><span class="sd">                order_id: {</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a><span class="sd">                    &quot;vehicle1@localhost&quot;: (can_fit: bool, delivery_time: int),</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a><span class="sd">                    &quot;vehicle2@localhost&quot;: (can_fit: bool, delivery_time: int),</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="sd">                    ...</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a><span class="sd">                }</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="sd">            }</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="sd">            ```</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a><span class="sd">        </span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a><span class="sd">        Message Format:</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a><span class="sd">            Body (JSON):</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="sd">                ```json</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="sd">                {</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a><span class="sd">                    &quot;orderid&quot;: 2001000000,</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="sd">                    &quot;can_fit&quot;: true,</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="sd">                    &quot;delivery_time&quot;: 150</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a><span class="sd">                }</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a><span class="sd">                ```</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a><span class="sd">        </span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a><span class="sd">        Workflow:</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a><span class="sd">            1. **Receive Message**: Wait up to 5 seconds for vehicle proposal</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="sd">            2. **Parse Proposal**: Extract orderid, can_fit, delivery_time</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="sd">            3. **Initialize Storage**: Create order_id entry if doesn&#39;t exist</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a><span class="sd">            4. **Store Proposal**: Add vehicle proposal to vehicle_proposals dict</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a><span class="sd">            5. **Continue Loop**: Repeat until timeout (no more proposals)</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="sd">            6. **Exit**: Break loop when timeout indicates all proposals received</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a><span class="sd">        </span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="sd">            - Updates agent.vehicle_proposals dictionary with new proposals</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">            - Prints proposal details if verbose mode enabled</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a><span class="sd">            - Breaks loop after 5-second timeout</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a><span class="sd">        </span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a><span class="sd">        Returns:</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a><span class="sd">            None. Exits after collecting all available proposals.</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a><span class="sd">        </span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a><span class="sd">        Example Execution:</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a><span class="sd">            ```</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="sd">            Loop Iteration 1:</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="sd">                - Receive from vehicle1: can_fit=True, time=120</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">                - Store: vehicle_proposals[2001000000][&quot;vehicle1&quot;] = (True, 120)</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">            Loop Iteration 2:</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">                - Receive from vehicle2: can_fit=False, time=180</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">                - Store: vehicle_proposals[2001000000][&quot;vehicle2&quot;] = (False, 180)</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">            Loop Iteration 3:</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">                - Timeout after 5 seconds</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a><span class="sd">                - Break loop, all proposals collected</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="sd">            ```</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">        </span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">        Note:</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">            The 5-second timeout is optimized to collect multiple proposals quickly</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a><span class="sd">            while not waiting too long for vehicles that won&#39;t respond.</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>            
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>                
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received vehicle proposal from </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>                    
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>                    <span class="c1"># A proposta do veculo no  uma Order, so apenas dados da proposta</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>                    <span class="n">order_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">]</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>                    <span class="n">sender_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>                    <span class="n">can_fit</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;can_fit&quot;</span><span class="p">]</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>                    <span class="n">time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;delivery_time&quot;</span><span class="p">]</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>                    
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>                    <span class="c1"># Verificar se a entrada para este order_id existe, se no criar</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">:</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">order_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>                    
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">order_id</span><span class="p">)][</span><span class="n">sender_jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">can_fit</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">sender_jid</span><span class="si">}</span><span class="s2"> proposal: can_fit=</span><span class="si">{</span><span class="n">can_fit</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>  
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>                <span class="k">else</span><span class="p">:</span> 
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Timeout - no more proposals received&quot;</span><span class="p">)</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>                    <span class="k">break</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>                 
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ChooseBestVehicle</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a><span class="sd">        Behaviour that evaluates vehicle proposals and selects the optimal vehicle for delivery.</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a><span class="sd">        </span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a><span class="sd">        This behaviour implements the proposal evaluation and winner selection phase of</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a><span class="sd">        vehicle assignment. After collecting all vehicle proposals via ReceiveVehicleProposals,</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a><span class="sd">        this behaviour compares them based on capacity and delivery time, then notifies</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a><span class="sd">        the selected vehicle and rejects all others.</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a><span class="sd">        </span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a><span class="sd">        Selection Algorithm:</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a><span class="sd">            1. **Priority 1**: Filter vehicles that can fit the order (can_fit=True)</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a><span class="sd">            2. **Priority 2**: Among fitting vehicles, select one with minimum delivery_time</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a><span class="sd">            3. **Fallback**: If no vehicles can fit, select vehicle with minimum delivery_time anyway</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a><span class="sd">        </span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="sd">        Attributes:</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a><span class="sd">            request_id (int): Unique order identifier to find proposals.</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a><span class="sd">            n_sent_messages (int): Expected number of vehicle responses to wait for.</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a><span class="sd">        </span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a><span class="sd">        Workflow:</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a><span class="sd">            1. **Wait for Proposals**: Loop until n_sent_messages proposals received</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a><span class="sd">            2. **Evaluate Proposals**: Call get_best_vehicle() to select winner</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a><span class="sd">            3. **Send Confirmation**: Notify selected vehicle with order-confirmation</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a><span class="sd">            4. **Send Rejections**: Notify all other vehicles they were not selected</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a><span class="sd">        </span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a><span class="sd">        Message Format (Confirmation):</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a><span class="sd">            Metadata:</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a><span class="sd">                - performative: &quot;order-confirmation&quot;</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a><span class="sd">            Body (JSON):</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a><span class="sd">                ```json</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a><span class="sd">                {</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a><span class="sd">                    &quot;orderid&quot;: 2001000000,</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a><span class="sd">                    &quot;confirmed&quot;: true</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a><span class="sd">                }</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a><span class="sd">                ```</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a><span class="sd">        </span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a><span class="sd">        Message Format (Rejection):</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a><span class="sd">            Metadata:</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a><span class="sd">                - performative: &quot;order-confirmation&quot;</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a><span class="sd">            Body (JSON):</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a><span class="sd">                ```json</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a><span class="sd">                {</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a><span class="sd">                    &quot;orderid&quot;: 2001000000,</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a><span class="sd">                    &quot;confirmed&quot;: false</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a><span class="sd">                }</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a><span class="sd">                ```</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a><span class="sd">        </span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a><span class="sd">            - Reads from agent.vehicle_proposals dictionary</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a><span class="sd">            - Reads from agent.pending_deliveries for Order object</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a><span class="sd">            - Sends confirmation message to selected vehicle</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a><span class="sd">            - Sends rejection messages to non-selected vehicles</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a><span class="sd">            - Prints selection decision if verbose mode enabled</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a><span class="sd">        </span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a><span class="sd">        Returns:</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a><span class="sd">            None. Completes after sending all confirmation/rejection messages.</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a><span class="sd">        </span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a><span class="sd">        Example Execution:</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a><span class="sd">            ```</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="sd">            Proposals Received:</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a><span class="sd">                - vehicle1: (can_fit=True, time=120)</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="sd">                - vehicle2: (can_fit=True, time=150)</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="sd">                - vehicle3: (can_fit=False, time=100)</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a><span class="sd">            </span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a><span class="sd">            Evaluation:</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a><span class="sd">                - Filter: vehicle1, vehicle2 (can fit)</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a><span class="sd">                - Compare times: 120 &lt; 150</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a><span class="sd">                - Winner: vehicle1</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a><span class="sd">            </span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a><span class="sd">            Actions:</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a><span class="sd">                - Send confirmation to vehicle1 (confirmed=true)</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a><span class="sd">                - Send rejection to vehicle2 (confirmed=false)</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a><span class="sd">                - Send rejection to vehicle3 (confirmed=false)</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a><span class="sd">            </span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a><span class="sd">            Output:</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a><span class="sd">                - Print: &quot;Best vehicle selected: vehicle1@localhost&quot;</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a><span class="sd">            ```</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a><span class="sd">        </span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a><span class="sd">        Note:</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a><span class="sd">            The behaviour waits actively (1-second sleep intervals) until all expected</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a><span class="sd">            proposals arrive before making a decision. This ensures fair comparison</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a><span class="sd">            of all available vehicles.</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">n_sent_messages</span><span class="p">):</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span> <span class="o">=</span> <span class="n">n_sent_messages</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>        
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">get_best_vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proposals</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>            <span class="c1"># First filter vehicles that can fit the order</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>            <span class="n">can_fit_vehicles</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="ow">in</span> <span class="n">proposals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">fit</span><span class="p">}</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>            <span class="k">if</span> <span class="n">can_fit_vehicles</span><span class="p">:</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>                <span class="c1"># If there are vehicles that can fit, choose the one with lowest delivery time</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>                <span class="n">best_vehicle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">can_fit_vehicles</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>                <span class="k">return</span> <span class="n">best_vehicle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>                <span class="c1"># If no vehicles can fit, choose the one with lowest delivery time anyway</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>                <span class="k">if</span> <span class="n">proposals</span><span class="p">:</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>                    <span class="n">best_vehicle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">proposals</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>                    <span class="k">return</span> <span class="n">best_vehicle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>        
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Comparing vehicle proposals...&quot;</span><span class="p">)</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>            
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>            <span class="c1"># Verificar se a entrada para este order_id existe, se no criar</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">:</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>            
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>            <span class="n">proposals</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)]</span> <span class="c1"># vehicle_jid : (can_fit, time)</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>            
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span><span class="p">:</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Waiting for more proposals... &quot;</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>                          <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>                <span class="n">proposals</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)]</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>            
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>            
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Total proposals received: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>            <span class="n">best_vehicle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_best_vehicle</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>            
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>            <span class="k">if</span> <span class="n">best_vehicle</span><span class="p">:</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Best vehicle selected: </span><span class="si">{</span><span class="n">best_vehicle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>                
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>                <span class="c1"># Send confirmation to the selected vehicle</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">best_vehicle</span><span class="p">)</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;order-confirmation&quot;</span><span class="p">)</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>                
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>                <span class="n">order</span> <span class="p">:</span> <span class="n">Order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">]</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>                <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>                    <span class="s2">&quot;orderid&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>                    <span class="s2">&quot;confirmed&quot;</span> <span class="p">:</span> <span class="kc">True</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>                <span class="p">}</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>                
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Confirmation sent to </span><span class="si">{</span><span class="n">best_vehicle</span><span class="si">}</span><span class="s2"> for order </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>                
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>                <span class="c1"># Send rejection to all other vehicles</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>                <span class="n">rejected_vehicles</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">proposals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">jid</span> <span class="o">!=</span> <span class="n">best_vehicle</span><span class="p">]</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>                <span class="k">for</span> <span class="n">vehicle_jid</span> <span class="ow">in</span> <span class="n">rejected_vehicles</span><span class="p">:</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>                    <span class="n">reject_msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>                    <span class="n">reject_msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;order-confirmation&quot;</span><span class="p">)</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>                    
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>                    <span class="n">reject_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>                    <span class="s2">&quot;orderid&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>                    <span class="s2">&quot;confirmed&quot;</span> <span class="p">:</span> <span class="kc">False</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>                    <span class="p">}</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>                    
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>                    <span class="n">reject_msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">reject_data</span><span class="p">)</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">reject_msg</span><span class="p">)</span>                        
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>    
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>    <span class="c1">#         WAREHOUSE &lt;-&gt; SUPPLIER</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>        
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">BuyMaterial</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a><span class="sd">        Behaviour that initiates material purchase from suppliers (FIPA CFP - Initiator Role).</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a><span class="sd">        </span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a><span class="sd">        This behaviour implements the FIPA Contract Net Protocol with the warehouse acting</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a><span class="sd">        as the INITIATOR role. The warehouse broadcasts a Call For Proposals (CFP) to</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a><span class="sd">        suppliers to replenish inventory. This is the dual role mentioned in the class</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a><span class="sd">        docstring - the warehouse is a participant when dealing with stores but becomes</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">        an initiator when dealing with suppliers.</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a><span class="sd">        </span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">        FIPA Protocol: **Contract Net - Initiator Role**</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">            - Role: Initiator (Warehouse requesting materials from Suppliers)</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a><span class="sd">            - Sends: warehouse-buy (FIPA CFP) with quantity and product</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a><span class="sd">            - Receives: supplier-accept (FIPA propose) or supplier-reject (FIPA refuse)</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a><span class="sd">            - Selection: Choose best supplier based on price and availability</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a><span class="sd">            - Award: Send warehouse-confirm (FIPA accept-proposal) to winner</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a><span class="sd">        </span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a><span class="sd">        Dual FIPA Role Context:</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a><span class="sd">            - **As Participant** (Store  Warehouse): Warehouse responds to store CFPs</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a><span class="sd">            - **As Initiator** (Warehouse  Supplier): Warehouse sends CFPs to suppliers</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a><span class="sd">            </span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a><span class="sd">            This dual role makes the warehouse a critical intermediary in the supply chain,</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a><span class="sd">            translating downstream demand into upstream procurement.</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a><span class="sd">        </span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a><span class="sd">        Attributes:</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a><span class="sd">            quantity (int): Amount of material to purchase from suppliers.</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a><span class="sd">            product (str): Type of material/product needed for restocking.</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a><span class="sd">        </span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a><span class="sd">        Message Format (warehouse-buy):</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a><span class="sd">            Metadata:</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a><span class="sd">                - performative: &quot;warehouse-buy&quot; (FIPA CFP)</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a><span class="sd">                - request_id: Unique request identifier (ID encoding)</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a><span class="sd">            Body:</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a><span class="sd">                - Example: &quot;100 raw_materials&quot;</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a><span class="sd">        </span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a><span class="sd">        ID Encoding for Request:</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a><span class="sd">            Uses the warehouse&#39;s ID encoding scheme:</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a><span class="sd">            - request_id = warehouse.id_base + warehouse.request_counter</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a><span class="sd">            - Format: 1 (warehouse type) * 100_000_000 + instance * 1_000_000 + counter</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a><span class="sd">            - Example: 101000000 (warehouse 1, request 0)</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a><span class="sd">        </span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="sd">        Workflow:</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a><span class="sd">            1. **Populate Suppliers**: Auto-discover suppliers from presence contacts</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a><span class="sd">            2. **Generate Request ID**: Create unique ID for this procurement</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a><span class="sd">            3. **Broadcast CFP**: Send warehouse-buy to all available suppliers</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a><span class="sd">            4. **Set Metadata**: Store request for retry mechanism (current_buy_request)</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a><span class="sd">            5. **Launch Coordinator**: Start CollectSupplierResponses to gather proposals</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a><span class="sd">            6. **Non-blocking**: Return immediately (coordinator handles responses)</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a><span class="sd">        </span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a><span class="sd">        Coordinator/Worker Pattern:</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a><span class="sd">            - **Initiator (this)**: Sends CFP and launches coordinator</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a><span class="sd">            - **Coordinator**: CollectSupplierResponses (manages collection process)</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a><span class="sd">            - **Worker**: ReceiveAllSupplierResponses (collects individual proposals)</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a><span class="sd">            - **Decision**: SendWarehouseConfirmation (award) or SendWarehouseDenial (reject)</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a><span class="sd">        </span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a><span class="sd">        Supplier Discovery:</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a><span class="sd">            Automatically populates supplier list from presence contacts:</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a><span class="sd">            - Filters contacts for JIDs containing &quot;supplier&quot;</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a><span class="sd">            - Updates agent.suppliers list if empty</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a><span class="sd">            - Requires presence subscription to be active</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a><span class="sd">        </span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a><span class="sd">        Example Execution:</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a><span class="sd">        </span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a><span class="sd">            **Scenario 1: Normal Procurement**</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a><span class="sd">            ```</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a><span class="sd">            Trigger: stock[electronics] &lt; restock_threshold</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a><span class="sd">            Request: BuyMaterial(100, &quot;electronics&quot;)</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a><span class="sd">            </span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a><span class="sd">            Step 1: Populate suppliers</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a><span class="sd">                Discovered: [supplier1@localhost, supplier2@localhost]</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a><span class="sd">            </span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a><span class="sd">            Step 2: Generate ID</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a><span class="sd">                request_id: 101000000</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a><span class="sd">            </span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a><span class="sd">            Step 3: Broadcast CFP</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a><span class="sd">                To: supplier1, supplier2</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a><span class="sd">                Message: warehouse-buy &quot;100 electronics&quot;</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a><span class="sd">            </span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a><span class="sd">            Step 4: Launch coordinator</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a><span class="sd">                CollectSupplierResponses(101000000, 100, &quot;electronics&quot;)</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a><span class="sd">                Coordinator launches ReceiveAllSupplierResponses worker</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a><span class="sd">            </span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a><span class="sd">            Step 5: Wait for proposals (handled by coordinator)</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a><span class="sd">            ```</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a><span class="sd">            </span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a><span class="sd">            **Scenario 2: No Suppliers Available**</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a><span class="sd">            ```</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a><span class="sd">            Request: BuyMaterial(100, &quot;electronics&quot;)</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a><span class="sd">            Suppliers: [] (empty list, none in presence)</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a><span class="sd">            </span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a><span class="sd">            Result: ERROR logged, no messages sent</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a><span class="sd">            Action: Retry later when suppliers available</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a><span class="sd">            ```</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a><span class="sd">        </span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a><span class="sd">        Retry Mechanism:</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a><span class="sd">            Sets agent.current_buy_request with:</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a><span class="sd">            - quantity: Amount requested</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a><span class="sd">            - product: Product type</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="sd">            - request_id: Request identifier</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a><span class="sd">            </span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a><span class="sd">            Used by RetryPreviousBuy if procurement fails.</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a><span class="sd">        </span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a><span class="sd">        Note:</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a><span class="sd">            This behaviour implements the same FIPA protocol that stores use when</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a><span class="sd">            buying from warehouses, but with reversed roles. The message format and</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a><span class="sd">            workflow mirror the store-warehouse interaction.</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a><span class="sd">            Initialize the BuyMaterial behaviour.</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a><span class="sd">            </span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a><span class="sd">            Args:</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a><span class="sd">                quantity (int): Amount of material to purchase.</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a><span class="sd">                product (str): Type of material/product to procure.</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>        
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">populate_suppliers_from_contacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Populate suppliers list from presence contacts if empty&quot;&quot;&quot;</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;supplier&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Auto-populated suppliers from contacts: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>        
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>            
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>            <span class="c1"># Populate suppliers from contacts if list is empty</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">populate_suppliers_from_contacts</span><span class="p">()</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>            
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: No suppliers found in contacts!&quot;</span><span class="p">)</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>                <span class="k">return</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>            
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>            <span class="c1"># Get request_id before sending - use ID encoding</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>            <span class="n">request_id_for_template</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">id_base</span> <span class="o">+</span> <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>            
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will store the last sent message for current_buy_request</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>            <span class="c1"># Only send to suppliers, not all contacts</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>            <span class="k">for</span> <span class="n">supplier_jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">supplier_jid</span><span class="p">)</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-buy&quot;</span><span class="p">)</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id_for_template</span><span class="p">))</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>                
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent request (id=</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;request_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>                
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>            
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>            <span class="c1"># Store the last message (or could store all if needed)</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>        
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>                <span class="c1"># Collect responses from all suppliers</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectSupplierResponses</span><span class="p">(</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>                    <span class="n">msg</span><span class="p">,</span> 
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>                    <span class="n">request_id_for_template</span><span class="p">,</span> 
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">),</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">product</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>                <span class="p">)</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>                
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>    
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">CollectSupplierResponses</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a><span class="sd">        Coordinator behaviour that manages supplier proposal collection and evaluation.</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a><span class="sd">        </span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a><span class="sd">        Launches ReceiveAllSupplierResponses worker to collect proposals from all suppliers,</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a><span class="sd">        then evaluates responses and selects the best supplier based on delivery time.</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a><span class="sd">        Sends confirmation to winner and denials to others. Implements FIPA initiator role.</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_suppliers</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">quantity</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">product</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">buy_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span> <span class="o">=</span> <span class="n">num_suppliers</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of (supplier_jid, msg)</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># List of (supplier_jid, msg, reason)</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>            
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>            
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>            <span class="c1"># Setup template that accepts BOTH supplier-accept AND supplier-reject</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>            <span class="c1"># Don&#39;t filter by performative - we want both accept and reject</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>            
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Setting up to receive supplier responses for request_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>            
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>            <span class="c1"># Create a combined behaviour to listen for both</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>            <span class="n">combined_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ReceiveAllSupplierResponses</span><span class="p">(</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="p">,</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">,</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>            <span class="p">)</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>            
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>            <span class="c1"># Add with template that matches both performatives</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">combined_behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>            
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>            <span class="c1"># Wait for collection to complete</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>            <span class="k">await</span> <span class="n">combined_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>            
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>            <span class="c1"># Now evaluate and choose best supplier</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> acceptance(s) and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejection(s)&quot;</span><span class="p">)</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>                
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>                <span class="c1"># Calculate scores for each supplier that accepted</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>                <span class="n">best_supplier</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>                <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>                
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>                <span class="k">for</span> <span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>                    <span class="n">score</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">calculate_supplier_score</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Warehouse </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2"> score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>                    
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>                    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">best_score</span><span class="p">:</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>                        <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>                        <span class="n">best_supplier</span> <span class="o">=</span> <span class="p">(</span><span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>                
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>                <span class="k">if</span> <span class="n">best_supplier</span><span class="p">:</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>                    <span class="n">supplier_jid</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="o">=</span> <span class="n">best_supplier</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>                    <span class="c1"># Essential print - supplier selected</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Selected supplier </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>                    
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>                    <span class="c1"># Send confirmation to the chosen supplier</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>                    <span class="n">confirm_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendWarehouseConfirmation</span><span class="p">(</span><span class="n">accept_msg</span><span class="p">)</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">confirm_behav</span><span class="p">)</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>                    <span class="k">await</span> <span class="n">confirm_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>                    
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>                    <span class="c1"># Send denial to other suppliers that accepted but weren&#39;t chosen</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>                    <span class="k">for</span> <span class="n">other_supplier_jid</span><span class="p">,</span> <span class="n">other_msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>                        <span class="k">if</span> <span class="n">other_supplier_jid</span> <span class="o">!=</span> <span class="n">supplier_jid</span><span class="p">:</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>                            <span class="n">deny_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendWarehouseDenial</span><span class="p">(</span><span class="n">other_msg</span><span class="p">)</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>                            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">deny_behav</span><span class="p">)</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>                            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent denial to </span><span class="si">{</span><span class="n">other_supplier_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>                    
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No acceptances received. All suppliers rejected or timed out.&quot;</span><span class="p">)</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Request saved in self.failed_requests&quot;</span><span class="p">)</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>                
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>                <span class="c1"># Add to failed requests</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;current_buy_request&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span><span class="p">:</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span><span class="p">)</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveAllSupplierResponses</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a><span class="sd">        Worker behaviour that collects supplier-accept and supplier-reject responses.</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a><span class="sd">        </span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a><span class="sd">        Waits for responses from all suppliers (with timeout), categorizing them into</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a><span class="sd">        acceptances and rejections lists shared with CollectSupplierResponses coordinator.</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_suppliers</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">acceptances</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">rejections</span> <span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span> <span class="o">=</span> <span class="n">num_suppliers</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="n">acceptances</span>  <span class="c1"># Shared list</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="n">rejections</span>    <span class="c1"># Shared list</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds to wait for all responses</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>            
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>            
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ReceiveAllSupplierResponses starting - waiting for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="si">}</span><span class="s2"> responses (request_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>            
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>            
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="p">:</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>                <span class="n">remaining_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">-</span> <span class="n">elapsed</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>                
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>                <span class="k">if</span> <span class="n">remaining_timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Timeout: Only received </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="si">}</span><span class="s2"> responses&quot;</span><span class="p">)</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>                    <span class="k">break</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>                
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Waiting for supplier response... (timeout=</span><span class="si">{</span><span class="n">remaining_timeout</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">remaining_timeout</span><span class="p">)</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>                
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>                    <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>                    <span class="n">supplier_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>                    
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received message from </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2"> with performative=</span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>                    
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>                    <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;supplier-accept&quot;</span><span class="p">:</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>                        
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received acceptance from </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>                        
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>                    <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;supplier-reject&quot;</span><span class="p">:</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>                        <span class="n">reason</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>                        
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received rejection from </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> (reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; WARNING: Received unknown performative: </span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>                    
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>                    <span class="c1"># No more messages, timeout</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No message received in timeout window&quot;</span><span class="p">)</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>                    <span class="k">break</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>            
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Finished collecting responses: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> accepts, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejects&quot;</span><span class="p">)</span>               
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>    
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SendWarehouseConfirmation</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a><span class="sd">        Sends warehouse-confirm (FIPA accept-proposal) to selected supplier.</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a><span class="sd">        </span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a><span class="sd">        Awards the contract to the best supplier, updates stock immediately,</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a><span class="sd">        and notifies the supplier that their proposal was accepted.</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>            
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>        
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>            
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>           
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>            
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-confirm&quot;</span><span class="p">)</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;supplier_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>            
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>            
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Confirmation sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>    
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SendWarehouseDenial</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a><span class="sd">        Sends warehouse-deny (FIPA reject-proposal) to non-selected suppliers.</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a><span class="sd">        </span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a><span class="sd">        Notifies suppliers that their proposal was not accepted, allowing them</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a><span class="sd">        to release any resources they may have reserved.</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>        
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>            
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-deny&quot;</span><span class="p">)</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;supplier_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>            
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>            
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Denial sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>    
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">RetryPreviousBuy</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a><span class="sd">        Retries failed supplier purchase requests from the failed_requests queue.</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a><span class="sd">        </span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a><span class="sd">        Dequeues one failed request and re-initiates the FIPA Contract Net Protocol</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a><span class="sd">        with suppliers, reusing the same request_id for traceability.</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>            
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>                <span class="n">request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>                <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>                
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>                <span class="c1"># Parse quantity and product from request body</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>                <span class="n">parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>                
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>                <span class="c1"># Only send to suppliers, not all contacts</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>                <span class="n">num_suppliers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">)</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>                
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>                <span class="k">for</span> <span class="n">supplier_jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>                    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">supplier_jid</span><span class="p">)</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-buy&quot;</span><span class="p">)</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Retrying request (id=</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>                              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>                <span class="c1"># Use CollectSupplierResponses with all required parameters</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>                    <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectSupplierResponses</span><span class="p">(</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>                        <span class="n">msg</span><span class="p">,</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>                        <span class="n">request_id</span><span class="p">,</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>                        <span class="n">num_suppliers</span><span class="p">,</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>                        <span class="n">quantity</span><span class="p">,</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>                        <span class="n">product</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>                    <span class="p">)</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>                    <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a>    
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">HandleResupply</span><span class="p">(</span><span class="n">PeriodicBehaviour</span><span class="p">):</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a><span class="sd">        Periodic behaviour that monitors stock levels and triggers restocking.</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a><span class="sd">        </span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a><span class="sd">        Checks each product&#39;s stock against WAREHOUSE_RESUPPLY_THRESHOLD and</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a><span class="sd">        launches BuyMaterial behaviour when inventory falls below threshold.</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>            
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>            <span class="c1"># Check stock levels</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>            <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>                <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_RESUPPLY_THRESHOLD</span><span class="p">:</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>                    <span class="c1"># Need to restock this product</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>                    <span class="n">restock_amount</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span> <span class="o">-</span> <span class="n">amount</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>                    <span class="c1"># Essential print - warehouse restocking</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Restocking </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span><span class="si">}</span><span class="s2"> (buying </span><span class="si">{</span><span class="n">restock_amount</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>                    
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>                    <span class="n">buy_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">BuyMaterial</span><span class="p">(</span><span class="n">restock_amount</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">buy_behav</span><span class="p">)</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>                    
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>                    <span class="k">await</span> <span class="n">buy_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>    
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>    <span class="c1">#         COMMON / OTHER BEHAVIORS</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveVehicleArrival</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a><span class="sd">        Cyclic behaviour that processes vehicle pickup and delivery notifications.</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a><span class="sd">        </span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a><span class="sd">        Handles vehicle-pickup messages (vehicle collects order from warehouse) and</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a><span class="sd">        vehicle-delivery messages (vehicle delivers supplies from supplier), updating</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a><span class="sd">        pending_deliveries and stock accordingly.</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>            
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>                <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>                
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>                <span class="c1"># Double-check (should already be filtered by templates)</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">]:</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Received unexpected performative &#39;</span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>                    <span class="k">return</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>                
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>                <span class="c1"># Parse message body</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>                    <span class="n">orderid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">]</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">orderid</span><span class="p">]</span> 
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>                <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Failed to parse vehicle message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>                    <span class="k">return</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>                
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>                <span class="c1"># Handle based on performative</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">:</span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>                    <span class="c1"># Vehicle is picking up an order to deliver to store</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>                    <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">:</span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>                        <span class="k">del</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a>                        <span class="c1"># Essential print - vehicle pickup</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> picked up order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a>                            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2"> not found in pending orders!&quot;</span><span class="p">)</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a>                
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>                <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">:</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>                    <span class="c1"># Vehicle is delivering supplies from supplier</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>                    <span class="n">product</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>                    <span class="n">quantity</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>                    
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>                    <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a>                    
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> delivered </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>                            
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>    
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveTimeDelta</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a><span class="sd">        Cyclic behaviour that synchronizes simulation time and applies traffic updates.</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a><span class="sd">        </span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a><span class="sd">        Receives time delta messages from world agent, updates current_tick, and</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a><span class="sd">        applies dynamic graph edge weight changes for traffic simulation.</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>            
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>            
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a>                
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a>                <span class="nb">type</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a>                <span class="n">delta</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>                
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;arrival&quot;</span><span class="p">:</span>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>                    <span class="n">map_updates</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> 
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">update_graph</span><span class="p">(</span><span class="n">map_updates</span><span class="p">)</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>    
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a>    <span class="c1">#           AUXILARY FUNCTIONS</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>    
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_supplier_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a><span class="sd">        Calculate supplier score based on delivery time (used in FIPA supplier selection).</span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a><span class="sd">        </span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a><span class="sd">        This function evaluates supplier proposals in the FIPA Contract Net Protocol</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a><span class="sd">        by computing the estimated delivery time from supplier to warehouse using</span>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a><span class="sd">        Dijkstra&#39;s algorithm on the world graph. Lower scores indicate faster delivery.</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a><span class="sd">        </span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a><span class="sd">        FIPA Protocol Context:</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a><span class="sd">            - Phase: Proposal Evaluation (Initiator evaluating participants)</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a><span class="sd">            - Used by: CollectSupplierResponses and ReceiveAllSupplierResponses</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a><span class="sd">            - Purpose: Select best supplier from multiple proposals</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a><span class="sd">        </span>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a><span class="sd">        Scoring Algorithm:</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a><span class="sd">            1. Extract supplier&#39;s node_id from message metadata</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a><span class="sd">            2. Run Dijkstra&#39;s algorithm: supplier_node  warehouse_node</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a><span class="sd">            3. Return estimated travel time as score</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a><span class="sd">            4. Lower score = shorter delivery time = better supplier</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a><span class="sd">        </span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a><span class="sd">        Args:</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a><span class="sd">            accept_msg (Message): supplier-accept message containing:</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a><span class="sd">                - Metadata: &quot;node_id&quot; (supplier&#39;s graph location)</span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a><span class="sd">                - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a><span class="sd">        </span>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a><span class="sd">        Returns:</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a><span class="sd">            float: Estimated delivery time (seconds). Lower is better.</span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a><span class="sd">        </span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a><span class="sd">        Example:</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a><span class="sd">            ```</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a><span class="sd">            Warehouse at node 10</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a><span class="sd">            Supplier1 at node 5: delivery_time = 120s</span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a><span class="sd">            Supplier2 at node 8: delivery_time = 85s</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a><span class="sd">            </span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a><span class="sd">            calculate_supplier_score(supplier1_msg)  120.0</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a><span class="sd">            calculate_supplier_score(supplier2_msg)  85.0</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a><span class="sd">            </span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a><span class="sd">            Winner: Supplier2 (lower score)</span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a><span class="sd">            ```</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a><span class="sd">        </span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a><span class="sd">        Note:</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a><span class="sd">            Currently uses time as the scoring metric. Could be extended to use</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a><span class="sd">            fuel cost or a weighted combination of multiple factors.</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>        
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>        <span class="n">supplier_node_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">accept_msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">))</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>        <span class="n">path</span><span class="p">,</span> <span class="n">fuel</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">djikstra</span><span class="p">(</span><span class="n">supplier_node_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>        
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>        <span class="k">return</span> <span class="n">time</span>  <span class="c1"># Use time as score (could also use fuel)</span>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">message_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a><span class="sd">        Convert store-confirm message to Order object for delivery tracking.</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a><span class="sd">        </span>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a><span class="sd">        This helper function transforms a FIPA accept-proposal message from a store</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a><span class="sd">        into a structured Order object that can be stored in pending_deliveries</span>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a><span class="sd">        and assigned to vehicles for transportation.</span>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a><span class="sd">        </span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a><span class="sd">        FIPA Protocol Context:</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a><span class="sd">            - Triggered by: store-confirm message (FIPA accept-proposal)</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a><span class="sd">            - Used by: ReceiveConfirmationOrDenial behaviour</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a><span class="sd">            - Purpose: Create deliverable order from confirmed proposal</span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a><span class="sd">        </span>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a><span class="sd">        Message Parsing:</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a><span class="sd">            Body Format: &quot;{quantity} {product}&quot;</span>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a><span class="sd">            Example: &quot;50 electronics&quot;</span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a><span class="sd">            </span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a><span class="sd">            Metadata Extracted:</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a><span class="sd">                - request_id: Unique order identifier</span>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a><span class="sd">                - node_id: Store&#39;s graph location (delivery destination)</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a><span class="sd">        </span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a><span class="sd">        Args:</span>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a><span class="sd">            msg (Message): store-confirm message with:</span>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a><span class="sd">                - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a><span class="sd">                - Metadata: request_id, node_id</span>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a><span class="sd">                - Sender: Store JID</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a><span class="sd">        </span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a><span class="sd">        Returns:</span>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a><span class="sd">            Order: Structured order object with:</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a><span class="sd">                - product: Product type</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a><span class="sd">                - quantity: Amount to deliver</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a><span class="sd">                - orderid: Unique identifier</span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a><span class="sd">                - sender: Store JID (delivery destination)</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a><span class="sd">                - receiver: Warehouse JID (pickup location)</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a><span class="sd">                - sender_location: Store&#39;s graph node</span>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a><span class="sd">                - receiver_location: Warehouse&#39;s graph node</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a><span class="sd">        </span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a><span class="sd">        Order Object Structure:</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a><span class="sd">            The Order uses inverted semantics for delivery context:</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a><span class="sd">            - sender = Store (WHERE to deliver)</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a><span class="sd">            - receiver = Warehouse (WHERE to pickup)</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a><span class="sd">            - sender_location = Store node (delivery destination)</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a><span class="sd">            - receiver_location = Warehouse node (pickup origin)</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a><span class="sd">        </span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a><span class="sd">        Example:</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a><span class="sd">            ```</span>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a><span class="sd">            Input Message (store-confirm):</span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a><span class="sd">                Body: &quot;50 electronics&quot;</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a><span class="sd">                Metadata:</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a><span class="sd">                    - request_id: &quot;201000000&quot;</span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a><span class="sd">                    - node_id: &quot;15&quot;</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a><span class="sd">                Sender: &quot;store1@localhost&quot;</span>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a><span class="sd">            </span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a><span class="sd">            Warehouse: &quot;warehouse1@localhost&quot; at node 10</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a><span class="sd">            </span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a><span class="sd">            Output Order:</span>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a><span class="sd">                product: &quot;electronics&quot;</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a><span class="sd">                quantity: 50</span>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a><span class="sd">                orderid: 201000000</span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a><span class="sd">                sender: &quot;store1@localhost&quot;</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a><span class="sd">                receiver: &quot;warehouse1@localhost&quot;</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a><span class="sd">                sender_location: 15 (store node)</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a><span class="sd">                receiver_location: 10 (warehouse node)</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a><span class="sd">            ```</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a><span class="sd">        </span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a><span class="sd">        Integration:</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a><span class="sd">            Created Order is added to self.pending_deliveries[order_id]</span>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a><span class="sd">            and passed to AssignVehicle behaviour for transportation.</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a>        <span class="n">body</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a>        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a>        
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a>        <span class="n">order_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>        <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>  <span class="c1"># Store JID</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a>        <span class="n">receiver</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">)</span>  <span class="c1"># Warehouse JID</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a>        <span class="n">store_location</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">))</span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>        <span class="n">warehouse_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a>        
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a>            <span class="n">product</span><span class="o">=</span><span class="n">product</span><span class="p">,</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a>            <span class="n">orderid</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a>            <span class="n">sender</span><span class="o">=</span><span class="n">sender</span><span class="p">,</span>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a>            <span class="n">receiver</span><span class="o">=</span><span class="n">receiver</span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a>        <span class="p">)</span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a>        
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a>        <span class="c1"># Set locations</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span> <span class="o">=</span> <span class="n">store_location</span>  <span class="c1"># Store location</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span> <span class="o">=</span> <span class="n">warehouse_location</span>  <span class="c1"># Warehouse location</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a>        
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a>        <span class="k">return</span> <span class="n">order</span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a>        
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_buy_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-buy&quot;</span><span class="p">)</span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span><span class="p">))</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a>    
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traffic_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a>        <span class="k">for</span> <span class="n">edge_info</span> <span class="ow">in</span> <span class="n">traffic_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a>                <span class="n">node1_id</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node1&quot;</span><span class="p">)</span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a>                <span class="n">node2_id</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node2&quot;</span><span class="p">)</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a>                <span class="n">new_weight</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a>                
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a>                <span class="n">edge</span> <span class="p">:</span> <span class="n">Edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">node1_id</span><span class="p">,</span> <span class="n">node2_id</span><span class="p">)</span>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a>                <span class="k">if</span> <span class="n">edge</span><span class="p">:</span>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a>                    <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">new_weight</span>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_stock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a><span class="sd">        Print comprehensive warehouse inventory status (debugging utility).</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a><span class="sd">        </span>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a><span class="sd">        Displays the three-tier stock management system:</span>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a><span class="sd">        1. **Unlocked Stock**: Available for new orders</span>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a><span class="sd">        2. **Locked Stock**: Reserved during FIPA negotiations</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a><span class="sd">        3. **Pending Orders**: Confirmed deliveries awaiting vehicle pickup</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a><span class="sd">        </span>
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a><span class="sd">        Output Format:</span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a><span class="sd">            ==============================</span>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a><span class="sd">            Current warehouse1@localhost UNLOCKED stock:</span>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a><span class="sd">            electronics: 75/150</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a><span class="sd">            textiles: 120/150</span>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a><span class="sd">            food: 40/150</span>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a><span class="sd">            ------------------------------</span>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a><span class="sd">            Current warehouse1@localhost LOCKED stock:</span>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a><span class="sd">            electronics: 25/100</span>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a><span class="sd">            textiles: 0/120</span>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a><span class="sd">            ------------------------------</span>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a><span class="sd">            Current warehouse1@localhost PENDING ORDERS:</span>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a><span class="sd">            Order 201000000: 25xelectronics from store1@localhost to warehouse1@localhost</span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a><span class="sd">            Order 201000001: 50xtextiles from store2@localhost to warehouse1@localhost</span>
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a><span class="sd">            ==============================</span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a><span class="sd">        </span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a><span class="sd">        Stock Interpretation:</span>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a><span class="sd">            - Unlocked: X/MAX_CAPACITY</span>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a><span class="sd">            - Locked: X/Total_Available (stock + locked)</span>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a><span class="sd">            - Pending: Formatted as &quot;{order_id}: {quantity}x{product} from {sender} to {receiver}&quot;</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a><span class="sd">        </span>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a><span class="sd">        Use Cases:</span>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a><span class="sd">            - Debugging stock state transitions</span>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a><span class="sd">            - Verifying FIPA protocol effects on inventory</span>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a><span class="sd">            - Monitoring pending delivery queue</span>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a><span class="sd">            - Tracking resource availability</span>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a><span class="sd">        </span>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a><span class="sd">        Example Usage:</span>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a><span class="sd">            ```python</span>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a><span class="sd">            # After accepting store request</span>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a><span class="sd">            warehouse.locked_stock[product] = 50</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a><span class="sd">            warehouse.print_stock()  # Shows locked stock increased</span>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a><span class="sd">            </span>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a><span class="sd">            # After store confirmation</span>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a><span class="sd">            warehouse.pending_deliveries[order_id] = order</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a><span class="sd">            warehouse.print_stock()  # Shows new pending order</span>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a><span class="sd">            </span>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a><span class="sd">            # After vehicle pickup</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a><span class="sd">            del warehouse.pending_deliveries[order_id]</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a><span class="sd">            warehouse.print_stock()  # Shows order removed</span>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a><span class="sd">            ```</span>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a>        
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2"> UNLOCKED stock:&quot;</span><span class="p">)</span>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a>        <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a>        
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2"> LOCKED stock:&quot;</span><span class="p">)</span>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a>        <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked_stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a>                
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2"> PENDING ORDERS:&quot;</span><span class="p">)</span>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">:</span>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a>            <span class="k">for</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a>                      <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">receiver</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No pending orders&quot;</span><span class="p">)</span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a>        
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a>    
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dict_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>        <span class="n">order</span> <span class="o">=</span>  <span class="n">Order</span><span class="p">(</span>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a>            <span class="n">product</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span>
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">],</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a>            <span class="n">orderid</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">],</span>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a>            <span class="n">sender</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;sender&quot;</span><span class="p">],</span>
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a>            <span class="n">receiver</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;receiver&quot;</span><span class="p">]</span>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>        <span class="p">)</span>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sender_location&quot;</span><span class="p">)</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;receiver_location&quot;</span><span class="p">)</span>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a>        <span class="k">return</span> <span class="n">order</span>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a>    
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>    
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="nb">map</span> <span class="p">:</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">node_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">5222</span><span class="p">,</span> <span class="n">verify_security</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">contact_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a><span class="sd">        Initialize the Warehouse agent with connection parameters and world state.</span>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a><span class="sd">        </span>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a><span class="sd">        The constructor configures the warehouse&#39;s identity, location, and initial</span>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a><span class="sd">        state. It implements the ID encoding system for generating unique request</span>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a><span class="sd">        identifiers compatible with the FIPA Contract Net Protocol.</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a><span class="sd">        </span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a><span class="sd">        ID Encoding System:</span>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a><span class="sd">            Formula: `agent_type * 100_000_000 + instance_id * 1_000_000 + counter`</span>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a><span class="sd">            - Agent Type Code: 2 (for Warehouse agents)</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a><span class="sd">            - Instance ID: Extracted from JID (e.g., &quot;warehouse3&quot; -&gt; 3)</span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a><span class="sd">            - Base ID Calculation: `2 * 100_000_000 + instance_id * 1_000_000`</span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a><span class="sd">            </span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a><span class="sd">            Examples:</span>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a><span class="sd">                - warehouse1: base = 201_000_000 (first request: 201_000_000)</span>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a><span class="sd">                - warehouse2: base = 202_000_000 (first request: 202_000_000)</span>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a><span class="sd">                - warehouse5: base = 205_000_000 (first request: 205_000_000)</span>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a><span class="sd">            </span>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a><span class="sd">            This encoding allows agents to identify:</span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a><span class="sd">                1. What type of agent created the request (200M range = warehouse)</span>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a><span class="sd">                2. Which specific warehouse instance (next 1M range)</span>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a><span class="sd">                3. Which request in sequence (counter increments)</span>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a><span class="sd">        </span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a><span class="sd">        Args:</span>
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a><span class="sd">            jid (str): Jabber ID for XMPP communication (e.g., &quot;warehouse1@localhost&quot;).</span>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a><span class="sd">            password (str): Authentication password for XMPP server.</span>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a><span class="sd">            map (Graph): Reference to the world graph for pathfinding and locations.</span>
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a><span class="sd">            node_id (int): Graph node representing the warehouse&#39;s physical location.</span>
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a><span class="sd">            port (int, optional): XMPP server port. Defaults to 5222.</span>
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a><span class="sd">            verify_security (bool, optional): Enable SSL/TLS verification. Defaults to False.</span>
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a><span class="sd">            contact_list (list[str], optional): JIDs of stores, suppliers, vehicles for presence</span>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a><span class="sd">                subscription. Defaults to empty list.</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a><span class="sd">            verbose (bool, optional): Enable detailed debug logging. Defaults to False.</span>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a><span class="sd">        </span>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a><span class="sd">        Attributes Initialized:</span>
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a><span class="sd">            Core Identity:</span>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a><span class="sd">                - node_id: Warehouse location on graph</span>
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a><span class="sd">                - map: World graph reference</span>
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a><span class="sd">                - contact_list: Agents for presence subscription</span>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a><span class="sd">                - verbose: Debug output flag</span>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a><span class="sd">            </span>
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a><span class="sd">            ID Encoding:</span>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a><span class="sd">                - id_base: Base value for generating unique request IDs</span>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a><span class="sd">                - request_counter: Monotonic counter for requests</span>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a><span class="sd">            </span>
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a><span class="sd">            Order Management:</span>
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a><span class="sd">                - pending_deliveries: Dict mapping order_id -&gt; Order objects</span>
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a><span class="sd">                - vehicle_proposals: Dict mapping order_id -&gt; vehicle proposals</span>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a><span class="sd">            </span>
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a><span class="sd">            Contact Discovery:</span>
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a><span class="sd">                - vehicles: List of vehicle JIDs (populated during setup)</span>
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a><span class="sd">                - suppliers: List of supplier JIDs (populated during setup)</span>
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a><span class="sd">        </span>
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a><span class="sd">        Example:</span>
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a><span class="sd">            ```python</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a><span class="sd">            warehouse = Warehouse(</span>
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a><span class="sd">                jid=&quot;warehouse1@localhost&quot;,</span>
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a><span class="sd">                password=&quot;password123&quot;,</span>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a><span class="sd">                map=world_graph,</span>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a><span class="sd">                node_id=10,</span>
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a><span class="sd">                contact_list=[</span>
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a><span class="sd">                    &quot;store1@localhost&quot;,</span>
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a><span class="sd">                    &quot;store2@localhost&quot;,</span>
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a><span class="sd">                    &quot;supplier1@localhost&quot;,</span>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a><span class="sd">                    &quot;vehicle1@localhost&quot;</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a><span class="sd">                ],</span>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a><span class="sd">                verbose=True</span>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a><span class="sd">            )</span>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a><span class="sd">            # ID base calculated: 2 * 100_000_000 + 1 * 1_000_000 = 201_000_000</span>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a><span class="sd">            # First request ID will be: 201_000_000</span>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a><span class="sd">            # Second request ID will be: 201_000_001</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a><span class="sd">            ```</span>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a><span class="sd">        </span>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a><span class="sd">        Note:</span>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a><span class="sd">            The constructor only initializes essential attributes. Most warehouse</span>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a><span class="sd">            state (stock, locked_stock, behaviours) is configured in the setup()</span>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a><span class="sd">            method which runs after the agent connects to the XMPP server.</span>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">verify_security</span><span class="p">)</span>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node_id</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="p">:</span> <span class="n">Graph</span> <span class="o">=</span> <span class="nb">map</span>
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contact_list</span> <span class="o">=</span> <span class="n">contact_list</span>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a>        <span class="c1"># Extract instance number from JID for ID encoding (e.g., &quot;warehouse1@localhost&quot; -&gt; 1)</span>
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a>        <span class="n">jid_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a>        <span class="n">instance_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">,</span> <span class="n">jid_name</span><span class="p">)))</span>
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a>        <span class="c1"># Calculate ID base: Warehouse type code = 2</span>
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id_base</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">100_000_000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">instance_id</span> <span class="o">*</span> <span class="mi">1_000_000</span><span class="p">)</span>
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a>        
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a>        <span class="c1"># Initialize critical attributes early to avoid AttributeError</span>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pending_deliveries</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># order_id as key and Order object as value</span>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_proposals</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">suppliers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a>    
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a><span class="sd">        Configure warehouse state and register all FIPA protocol behaviours.</span>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a><span class="sd">        </span>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a><span class="sd">        This method is automatically called by SPADE after the agent successfully</span>
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a><span class="sd">        connects to the XMPP server. It initializes the warehouse&#39;s operational</span>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a><span class="sd">        state and registers all cyclic and periodic behaviours needed for the</span>
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a><span class="sd">        dual FIPA Contract Net Protocol implementation.</span>
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a><span class="sd">        </span>
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a><span class="sd">        Setup Process:</span>
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a><span class="sd">        </span>
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a><span class="sd">            **Phase 1: Presence Management**</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a><span class="sd">                - Enable auto-approval of presence subscriptions</span>
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a><span class="sd">                - Subscribe to all contacts (stores, suppliers, vehicles)</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a><span class="sd">                - Enables presence-based availability checking</span>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a><span class="sd">            </span>
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a><span class="sd">            **Phase 2: Stock Initialization**</span>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a><span class="sd">                - Randomize initial stock for each product</span>
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a><span class="sd">                - Range: [WAREHOUSE_RESUPPLY_THRESHOLD+1, WAREHOUSE_MAX_PRODUCT_CAPACITY]</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a><span class="sd">                - Calculate current_capacity per product</span>
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a><span class="sd">                - Initialize locked_stock dictionary (empty)</span>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a><span class="sd">            </span>
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a><span class="sd">            **Phase 3: State Initialization**</span>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a><span class="sd">                - current_tick: Simulation time (starts at 0)</span>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a><span class="sd">                - presence_infos: Vehicle availability cache</span>
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a><span class="sd">                - current_buy_request: Last supplier purchase request</span>
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a><span class="sd">                - failed_requests: Queue for retry mechanism</span>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a><span class="sd">            </span>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a><span class="sd">            **Phase 4: Contact Discovery**</span>
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a><span class="sd">                - Parse presence.contacts to identify vehicles and suppliers</span>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a><span class="sd">                - Filter by JID string matching (&quot;vehicle&quot;, &quot;supplier&quot;)</span>
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a><span class="sd">                - Populate vehicles and suppliers lists</span>
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a><span class="sd">            </span>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a><span class="sd">            **Phase 5: Behaviour Registration**</span>
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a><span class="sd">                1. ReceiveBuyRequest (Store Interaction - FIPA Participant)</span>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a><span class="sd">                2. HandleResupply (Inventory Management - Triggers FIPA Initiator)</span>
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a><span class="sd">                3. ReceiveVehicleArrival (Logistics Coordination)</span>
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a><span class="sd">                4. ReceiveTimeDelta (Time Synchronization)</span>
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a><span class="sd">        </span>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a><span class="sd">        Behaviour Registration Details:</span>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a><span class="sd">        </span>
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a><span class="sd">            **ReceiveBuyRequest** (CyclicBehaviour):</span>
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a><span class="sd">                - Template: performative = &quot;store-buy&quot;</span>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a><span class="sd">                - Purpose: Listen for store purchase requests (FIPA CFP)</span>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a><span class="sd">                - Role: FIPA Participant (responds to stores)</span>
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a><span class="sd">            </span>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a><span class="sd">            **HandleResupply** (PeriodicBehaviour):</span>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a><span class="sd">                - Period: 5 seconds</span>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a><span class="sd">                - Purpose: Monitor stock levels and trigger restocking</span>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a><span class="sd">                - Role: Launches BuyMaterial (FIPA Initiator with suppliers)</span>
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a><span class="sd">            </span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a><span class="sd">            **ReceiveVehicleArrival** (CyclicBehaviour):</span>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a><span class="sd">                - Template: performative = &quot;vehicle-pickup&quot; OR &quot;vehicle-delivery&quot;</span>
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a><span class="sd">                - Purpose: Handle vehicle logistics notifications</span>
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a><span class="sd">                - Actions:</span>
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a><span class="sd">                    - vehicle-pickup: Remove order from pending_deliveries</span>
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a><span class="sd">                    - vehicle-delivery: Add delivered materials to stock</span>
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a><span class="sd">            </span>
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a><span class="sd">            **ReceiveTimeDelta** (CyclicBehaviour):</span>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a><span class="sd">                - Template: performative = &quot;time-delta&quot;</span>
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a><span class="sd">                - Purpose: Synchronize simulation time with world agent</span>
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a><span class="sd">                - Actions: Update current_tick, apply traffic conditions</span>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a><span class="sd">        </span>
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a><span class="sd">        Stock Initialization Example:</span>
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a><span class="sd">            ```</span>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a><span class="sd">            Products: [electronics, textiles, food]</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a><span class="sd">            WAREHOUSE_MAX_PRODUCT_CAPACITY: 150</span>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a><span class="sd">            WAREHOUSE_RESUPPLY_THRESHOLD: 30</span>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a><span class="sd">            </span>
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a><span class="sd">            Initial Stock (randomized):</span>
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a><span class="sd">                electronics: 87  (available)</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a><span class="sd">                textiles:    45  (available)</span>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a><span class="sd">                food:        120 (available)</span>
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a><span class="sd">            </span>
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a><span class="sd">            Current Capacity (calculated):</span>
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a><span class="sd">                electronics: 150 - 87 = 63</span>
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a><span class="sd">                textiles:    150 - 45 = 105</span>
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a><span class="sd">                food:        150 - 120 = 30</span>
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a><span class="sd">            </span>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a><span class="sd">            Locked Stock (initialized empty):</span>
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a><span class="sd">                electronics: 0</span>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a><span class="sd">                textiles:    0</span>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a><span class="sd">                food:        0</span>
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a><span class="sd">            ```</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a><span class="sd">        </span>
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a><span class="sd">        Presence Subscription Example:</span>
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a><span class="sd">            ```</span>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a><span class="sd">            contact_list: [</span>
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a><span class="sd">                &quot;store1@localhost&quot;,</span>
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a><span class="sd">                &quot;store2@localhost&quot;,</span>
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a><span class="sd">                &quot;supplier1@localhost&quot;,</span>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a><span class="sd">                &quot;vehicle1@localhost&quot;,</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a><span class="sd">                &quot;vehicle2@localhost&quot;</span>
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a><span class="sd">            ]</span>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a><span class="sd">            </span>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a><span class="sd">            Actions:</span>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a><span class="sd">                1. Subscribe to all 5 contacts</span>
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a><span class="sd">                2. Parse contacts for types:</span>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a><span class="sd">                   - vehicles: [&quot;vehicle1@localhost&quot;, &quot;vehicle2@localhost&quot;]</span>
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a><span class="sd">                   - suppliers: [&quot;supplier1@localhost&quot;]</span>
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a><span class="sd">                3. Stores automatically discovered via presence system</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a><span class="sd">            ```</span>
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a><span class="sd">        </span>
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a><span class="sd">        Template Configuration:</span>
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a><span class="sd">            Templates use metadata filtering to route messages to correct behaviours:</span>
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a><span class="sd">            - ReceiveBuyRequest: performative=&quot;store-buy&quot;</span>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a><span class="sd">            - ReceiveVehicleArrival: performative in [&quot;vehicle-pickup&quot;, &quot;vehicle-delivery&quot;]</span>
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a><span class="sd">            - ReceiveTimeDelta: performative=&quot;time-delta&quot;</span>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a><span class="sd">        </span>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a><span class="sd">        Side Effects:</span>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a><span class="sd">            - Prints initial stock levels if verbose=True</span>
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a><span class="sd">            - Begins listening for store requests immediately</span>
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a><span class="sd">            - Starts periodic inventory monitoring</span>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a><span class="sd">            - Enables vehicle coordination capability</span>
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a><span class="sd">        </span>
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a><span class="sd">        Note:</span>
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a><span class="sd">            This method must complete before the warehouse can participate in any</span>
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a><span class="sd">            FIPA protocol interactions. All behaviours are registered but don&#39;t</span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a><span class="sd">            execute until the main agent event loop processes them.</span>
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">approve_all</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a>        <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_list</span><span class="p">:</span>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Subscribed to presence of </span><span class="si">{</span><span class="n">contact</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a>        <span class="c1"># Initialize stock and time</span>
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stock</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a>        
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a>        <span class="c1"># Set the starting stock randomly</span>
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a>        <span class="n">product_max</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a>        <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">PRODUCTS</span><span class="p">:</span>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_RESUPPLY_THRESHOLD</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a>                                              <span class="n">product_max</span><span class="p">)</span>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a>        
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_capacity</span> <span class="o">=</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">product_max</span> <span class="o">-</span> <span class="n">quant</span> <span class="k">for</span> <span class="n">prod</span><span class="p">,</span> <span class="n">quant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a>        
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a>        <span class="c1"># Dict with products as keys and the sum of requested items as values</span>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">locked_stock</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a>        
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a>        
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_infos</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failed_requests</span> <span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a>        
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a>        <span class="c1"># Identify vehicles from presence contacts</span>
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">suppliers</span>  <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a>        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a>            <span class="k">if</span> <span class="s2">&quot;vehicle&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle</span><span class="p">):</span>
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a>            <span class="k">if</span> <span class="s2">&quot;supplier&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle</span><span class="p">):</span>
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">suppliers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a>        
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a>        <span class="c1"># Run ReceiveBuyRequest behaviour</span>
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveBuyRequest</span><span class="p">()</span>
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-buy&quot;</span><span class="p">)</span>
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a>        
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a>        <span class="c1"># Run HandleResupply behaviour</span>
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HandleResupply</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a>        
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a>        <span class="c1"># Run ReceiveVehicleArrival behaviour for pickups</span>
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveVehicleArrival</span><span class="p">()</span>
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">)</span>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a>        
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a>        <span class="c1"># Run ReceiveVehicleProposals behaviour</span>
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a>        <span class="n">vehicle_proposal_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveVehicleProposals</span><span class="p">()</span>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a>        <span class="n">vehicle_proposal_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a>        <span class="n">vehicle_proposal_template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-proposal&quot;</span><span class="p">)</span>
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">vehicle_proposal_behav</span><span class="p">,</span> <span class="n">vehicle_proposal_template</span><span class="p">)</span>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a>        <span class="c1"># Run ReceiveVehicleArrival behaviour for deliveries</span>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveVehicleArrival</span><span class="p">()</span>
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">)</span>
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a>        
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a>        <span class="c1"># Run ReceiveTimeDelta</span>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveTimeDelta</span><span class="p">()</span>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="Warehouse">
                            <input id="Warehouse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse</span><wbr>(<span class="base">spade.agent.Agent</span>):

                <label class="view-source-button" for="Warehouse-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse-130"><a href="#Warehouse-130"><span class="linenos"> 130</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Warehouse</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
</span><span id="Warehouse-131"><a href="#Warehouse-131"><span class="linenos"> 131</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-132"><a href="#Warehouse-132"><span class="linenos"> 132</span></a><span class="sd">    Warehouse Agent for Supply Chain Management System.</span>
</span><span id="Warehouse-133"><a href="#Warehouse-133"><span class="linenos"> 133</span></a><span class="sd">    </span>
</span><span id="Warehouse-134"><a href="#Warehouse-134"><span class="linenos"> 134</span></a><span class="sd">    The Warehouse agent acts as a critical intermediary in the supply chain, managing</span>
</span><span id="Warehouse-135"><a href="#Warehouse-135"><span class="linenos"> 135</span></a><span class="sd">    inventory, fulfilling store orders, and coordinating with suppliers and vehicles.</span>
</span><span id="Warehouse-136"><a href="#Warehouse-136"><span class="linenos"> 136</span></a><span class="sd">    It implements dual FIPA Contract Net Protocol roles, acting as both participant</span>
</span><span id="Warehouse-137"><a href="#Warehouse-137"><span class="linenos"> 137</span></a><span class="sd">    and initiator depending on the interaction context.</span>
</span><span id="Warehouse-138"><a href="#Warehouse-138"><span class="linenos"> 138</span></a><span class="sd">    </span>
</span><span id="Warehouse-139"><a href="#Warehouse-139"><span class="linenos"> 139</span></a><span class="sd">    FIPA Contract Net Protocol - Dual Role Implementation:</span>
</span><span id="Warehouse-140"><a href="#Warehouse-140"><span class="linenos"> 140</span></a><span class="sd">    </span>
</span><span id="Warehouse-141"><a href="#Warehouse-141"><span class="linenos"> 141</span></a><span class="sd">    1. **As Participant (with Stores)**:</span>
</span><span id="Warehouse-142"><a href="#Warehouse-142"><span class="linenos"> 142</span></a><span class="sd">        - **Proposal Phase**: Receives store-buy CFP from stores</span>
</span><span id="Warehouse-143"><a href="#Warehouse-143"><span class="linenos"> 143</span></a><span class="sd">        - **Proposal Submission**: Sends warehouse-accept (propose) or warehouse-reject (refuse)</span>
</span><span id="Warehouse-144"><a href="#Warehouse-144"><span class="linenos"> 144</span></a><span class="sd">        - **Result Reception**: Receives store-confirm (accept-proposal) or store-deny (reject-proposal)</span>
</span><span id="Warehouse-145"><a href="#Warehouse-145"><span class="linenos"> 145</span></a><span class="sd">        - **Execution**: Assigns vehicles for confirmed orders</span>
</span><span id="Warehouse-146"><a href="#Warehouse-146"><span class="linenos"> 146</span></a><span class="sd">    </span>
</span><span id="Warehouse-147"><a href="#Warehouse-147"><span class="linenos"> 147</span></a><span class="sd">    2. **As Initiator (with Suppliers)**:</span>
</span><span id="Warehouse-148"><a href="#Warehouse-148"><span class="linenos"> 148</span></a><span class="sd">        - **CFP Phase**: Sends warehouse-buy CFP to suppliers for restocking</span>
</span><span id="Warehouse-149"><a href="#Warehouse-149"><span class="linenos"> 149</span></a><span class="sd">        - **Proposal Collection**: Receives supplier-accept (propose) or supplier-reject (refuse)</span>
</span><span id="Warehouse-150"><a href="#Warehouse-150"><span class="linenos"> 150</span></a><span class="sd">        - **Evaluation**: Scores suppliers based on delivery time</span>
</span><span id="Warehouse-151"><a href="#Warehouse-151"><span class="linenos"> 151</span></a><span class="sd">        - **Award**: Sends warehouse-confirm (accept-proposal) or warehouse-deny (reject-proposal)</span>
</span><span id="Warehouse-152"><a href="#Warehouse-152"><span class="linenos"> 152</span></a><span class="sd">    </span>
</span><span id="Warehouse-153"><a href="#Warehouse-153"><span class="linenos"> 153</span></a><span class="sd">    Stock Management Strategy:</span>
</span><span id="Warehouse-154"><a href="#Warehouse-154"><span class="linenos"> 154</span></a><span class="sd">        The warehouse uses a three-tier stock system:</span>
</span><span id="Warehouse-155"><a href="#Warehouse-155"><span class="linenos"> 155</span></a><span class="sd">        1. **Available Stock** (self.stock): Products available for new orders</span>
</span><span id="Warehouse-156"><a href="#Warehouse-156"><span class="linenos"> 156</span></a><span class="sd">        2. **Locked Stock** (self.locked_stock): Reserved for pending negotiations</span>
</span><span id="Warehouse-157"><a href="#Warehouse-157"><span class="linenos"> 157</span></a><span class="sd">        3. **Pending Deliveries** (self.pending_deliveries): Confirmed orders awaiting pickup</span>
</span><span id="Warehouse-158"><a href="#Warehouse-158"><span class="linenos"> 158</span></a><span class="sd">    </span>
</span><span id="Warehouse-159"><a href="#Warehouse-159"><span class="linenos"> 159</span></a><span class="sd">    ID Encoding System:</span>
</span><span id="Warehouse-160"><a href="#Warehouse-160"><span class="linenos"> 160</span></a><span class="sd">        Similar to Store agent, uses hierarchical encoding:</span>
</span><span id="Warehouse-161"><a href="#Warehouse-161"><span class="linenos"> 161</span></a><span class="sd">        - Formula: `agent_type * 100_000_000 + instance_id * 1_000_000 + request_counter`</span>
</span><span id="Warehouse-162"><a href="#Warehouse-162"><span class="linenos"> 162</span></a><span class="sd">        - Agent type code for Warehouse: 2</span>
</span><span id="Warehouse-163"><a href="#Warehouse-163"><span class="linenos"> 163</span></a><span class="sd">        - Example: warehouse1&#39;s first request = 2_001_000_000</span>
</span><span id="Warehouse-164"><a href="#Warehouse-164"><span class="linenos"> 164</span></a><span class="sd">    </span>
</span><span id="Warehouse-165"><a href="#Warehouse-165"><span class="linenos"> 165</span></a><span class="sd">    Attributes:</span>
</span><span id="Warehouse-166"><a href="#Warehouse-166"><span class="linenos"> 166</span></a><span class="sd">        jid (str): Jabber ID of the warehouse agent (e.g., &quot;warehouse1@localhost&quot;).</span>
</span><span id="Warehouse-167"><a href="#Warehouse-167"><span class="linenos"> 167</span></a><span class="sd">        node_id (int): Graph node ID representing the warehouse&#39;s physical location.</span>
</span><span id="Warehouse-168"><a href="#Warehouse-168"><span class="linenos"> 168</span></a><span class="sd">        map (Graph): Reference to the world graph for pathfinding calculations.</span>
</span><span id="Warehouse-169"><a href="#Warehouse-169"><span class="linenos"> 169</span></a><span class="sd">        contact_list (list[str]): JIDs for stores, suppliers, and vehicles.</span>
</span><span id="Warehouse-170"><a href="#Warehouse-170"><span class="linenos"> 170</span></a><span class="sd">        verbose (bool): Flag to control debug output verbosity.</span>
</span><span id="Warehouse-171"><a href="#Warehouse-171"><span class="linenos"> 171</span></a><span class="sd">        id_base (int): Base value for generating unique request IDs.</span>
</span><span id="Warehouse-172"><a href="#Warehouse-172"><span class="linenos"> 172</span></a><span class="sd">        stock (dict[str, int]): Available inventory (not locked or pending).</span>
</span><span id="Warehouse-173"><a href="#Warehouse-173"><span class="linenos"> 173</span></a><span class="sd">        locked_stock (dict[str, int]): Stock reserved during store negotiations.</span>
</span><span id="Warehouse-174"><a href="#Warehouse-174"><span class="linenos"> 174</span></a><span class="sd">        current_capacity (dict[str, int]): Remaining capacity per product.</span>
</span><span id="Warehouse-175"><a href="#Warehouse-175"><span class="linenos"> 175</span></a><span class="sd">        pending_deliveries (dict[int, Order]): Confirmed orders awaiting vehicle pickup.</span>
</span><span id="Warehouse-176"><a href="#Warehouse-176"><span class="linenos"> 176</span></a><span class="sd">        vehicle_proposals (dict[int, dict[str, tuple[bool, int]]]): Vehicle delivery proposals.</span>
</span><span id="Warehouse-177"><a href="#Warehouse-177"><span class="linenos"> 177</span></a><span class="sd">            Format: {order_id: {vehicle_jid: (can_fit, delivery_time)}}</span>
</span><span id="Warehouse-178"><a href="#Warehouse-178"><span class="linenos"> 178</span></a><span class="sd">        vehicles (list[str]): List of vehicle JIDs discovered from contacts.</span>
</span><span id="Warehouse-179"><a href="#Warehouse-179"><span class="linenos"> 179</span></a><span class="sd">        suppliers (list[str]): List of supplier JIDs discovered from contacts.</span>
</span><span id="Warehouse-180"><a href="#Warehouse-180"><span class="linenos"> 180</span></a><span class="sd">        request_counter (int): Monotonic counter for unique request IDs.</span>
</span><span id="Warehouse-181"><a href="#Warehouse-181"><span class="linenos"> 181</span></a><span class="sd">        current_buy_request (Message): Most recent supplier purchase request.</span>
</span><span id="Warehouse-182"><a href="#Warehouse-182"><span class="linenos"> 182</span></a><span class="sd">        failed_requests (queue.Queue): Queue of failed supplier requests for retry.</span>
</span><span id="Warehouse-183"><a href="#Warehouse-183"><span class="linenos"> 183</span></a><span class="sd">        presence_infos (dict[str, str]): Vehicle presence status cache.</span>
</span><span id="Warehouse-184"><a href="#Warehouse-184"><span class="linenos"> 184</span></a><span class="sd">        current_tick (int): Current simulation time, synchronized by world agent.</span>
</span><span id="Warehouse-185"><a href="#Warehouse-185"><span class="linenos"> 185</span></a><span class="sd">    </span>
</span><span id="Warehouse-186"><a href="#Warehouse-186"><span class="linenos"> 186</span></a><span class="sd">    Behaviours:</span>
</span><span id="Warehouse-187"><a href="#Warehouse-187"><span class="linenos"> 187</span></a><span class="sd">        Store Interaction:</span>
</span><span id="Warehouse-188"><a href="#Warehouse-188"><span class="linenos"> 188</span></a><span class="sd">            - ReceiveBuyRequest: Processes store purchase requests (FIPA participant)</span>
</span><span id="Warehouse-189"><a href="#Warehouse-189"><span class="linenos"> 189</span></a><span class="sd">            - AcceptBuyRequest: Sends proposal to store (FIPA propose)</span>
</span><span id="Warehouse-190"><a href="#Warehouse-190"><span class="linenos"> 190</span></a><span class="sd">            - RejectBuyRequest: Sends refusal to store (FIPA refuse)</span>
</span><span id="Warehouse-191"><a href="#Warehouse-191"><span class="linenos"> 191</span></a><span class="sd">            - ReceiveConfirmationOrDenial: Handles store&#39;s award/rejection</span>
</span><span id="Warehouse-192"><a href="#Warehouse-192"><span class="linenos"> 192</span></a><span class="sd">            - AssignVehicle: Coordinates vehicle assignment for deliveries</span>
</span><span id="Warehouse-193"><a href="#Warehouse-193"><span class="linenos"> 193</span></a><span class="sd">            - ReceivePresenceInfo: Checks vehicle availability</span>
</span><span id="Warehouse-194"><a href="#Warehouse-194"><span class="linenos"> 194</span></a><span class="sd">            - ReceiveVehicleProposals: Collects vehicle delivery proposals</span>
</span><span id="Warehouse-195"><a href="#Warehouse-195"><span class="linenos"> 195</span></a><span class="sd">            - ChooseBestVehicle: Selects optimal vehicle using scoring algorithm</span>
</span><span id="Warehouse-196"><a href="#Warehouse-196"><span class="linenos"> 196</span></a><span class="sd">        </span>
</span><span id="Warehouse-197"><a href="#Warehouse-197"><span class="linenos"> 197</span></a><span class="sd">        Supplier Interaction:</span>
</span><span id="Warehouse-198"><a href="#Warehouse-198"><span class="linenos"> 198</span></a><span class="sd">            - BuyMaterial: Initiates purchase requests to suppliers (FIPA initiator)</span>
</span><span id="Warehouse-199"><a href="#Warehouse-199"><span class="linenos"> 199</span></a><span class="sd">            - CollectSupplierResponses: Coordinator for supplier negotiation</span>
</span><span id="Warehouse-200"><a href="#Warehouse-200"><span class="linenos"> 200</span></a><span class="sd">            - ReceiveAllSupplierResponses: Worker collecting supplier responses</span>
</span><span id="Warehouse-201"><a href="#Warehouse-201"><span class="linenos"> 201</span></a><span class="sd">            - SendWarehouseConfirmation: Awards contract to supplier (FIPA accept-proposal)</span>
</span><span id="Warehouse-202"><a href="#Warehouse-202"><span class="linenos"> 202</span></a><span class="sd">            - SendWarehouseDenial: Rejects supplier proposals (FIPA reject-proposal)</span>
</span><span id="Warehouse-203"><a href="#Warehouse-203"><span class="linenos"> 203</span></a><span class="sd">            - RetryPreviousBuy: Retries failed supplier requests</span>
</span><span id="Warehouse-204"><a href="#Warehouse-204"><span class="linenos"> 204</span></a><span class="sd">            - HandleResupply: Monitors stock and triggers restocking</span>
</span><span id="Warehouse-205"><a href="#Warehouse-205"><span class="linenos"> 205</span></a><span class="sd">        </span>
</span><span id="Warehouse-206"><a href="#Warehouse-206"><span class="linenos"> 206</span></a><span class="sd">        Vehicle &amp; Time Management:</span>
</span><span id="Warehouse-207"><a href="#Warehouse-207"><span class="linenos"> 207</span></a><span class="sd">            - ReceiveVehicleArrival: Handles vehicle pickup and delivery notifications</span>
</span><span id="Warehouse-208"><a href="#Warehouse-208"><span class="linenos"> 208</span></a><span class="sd">            - ReceiveTimeDelta: Synchronizes time and applies traffic updates</span>
</span><span id="Warehouse-209"><a href="#Warehouse-209"><span class="linenos"> 209</span></a><span class="sd">    </span>
</span><span id="Warehouse-210"><a href="#Warehouse-210"><span class="linenos"> 210</span></a><span class="sd">    Message Protocols:</span>
</span><span id="Warehouse-211"><a href="#Warehouse-211"><span class="linenos"> 211</span></a><span class="sd">        Incoming from Stores:</span>
</span><span id="Warehouse-212"><a href="#Warehouse-212"><span class="linenos"> 212</span></a><span class="sd">            - store-buy: Purchase request (FIPA CFP)</span>
</span><span id="Warehouse-213"><a href="#Warehouse-213"><span class="linenos"> 213</span></a><span class="sd">            - store-confirm: Order confirmation (FIPA accept-proposal)</span>
</span><span id="Warehouse-214"><a href="#Warehouse-214"><span class="linenos"> 214</span></a><span class="sd">            - store-deny: Order rejection (FIPA reject-proposal)</span>
</span><span id="Warehouse-215"><a href="#Warehouse-215"><span class="linenos"> 215</span></a><span class="sd">        </span>
</span><span id="Warehouse-216"><a href="#Warehouse-216"><span class="linenos"> 216</span></a><span class="sd">        Outgoing to Stores:</span>
</span><span id="Warehouse-217"><a href="#Warehouse-217"><span class="linenos"> 217</span></a><span class="sd">            - warehouse-accept: Order proposal (FIPA propose)</span>
</span><span id="Warehouse-218"><a href="#Warehouse-218"><span class="linenos"> 218</span></a><span class="sd">            - warehouse-reject: Order refusal (FIPA refuse)</span>
</span><span id="Warehouse-219"><a href="#Warehouse-219"><span class="linenos"> 219</span></a><span class="sd">        </span>
</span><span id="Warehouse-220"><a href="#Warehouse-220"><span class="linenos"> 220</span></a><span class="sd">        Outgoing to Suppliers:</span>
</span><span id="Warehouse-221"><a href="#Warehouse-221"><span class="linenos"> 221</span></a><span class="sd">            - warehouse-buy: Purchase request (FIPA CFP)</span>
</span><span id="Warehouse-222"><a href="#Warehouse-222"><span class="linenos"> 222</span></a><span class="sd">            - warehouse-confirm: Supplier confirmation (FIPA accept-proposal)</span>
</span><span id="Warehouse-223"><a href="#Warehouse-223"><span class="linenos"> 223</span></a><span class="sd">            - warehouse-deny: Supplier rejection (FIPA reject-proposal)</span>
</span><span id="Warehouse-224"><a href="#Warehouse-224"><span class="linenos"> 224</span></a><span class="sd">        </span>
</span><span id="Warehouse-225"><a href="#Warehouse-225"><span class="linenos"> 225</span></a><span class="sd">        Incoming from Suppliers:</span>
</span><span id="Warehouse-226"><a href="#Warehouse-226"><span class="linenos"> 226</span></a><span class="sd">            - supplier-accept: Material proposal (FIPA propose)</span>
</span><span id="Warehouse-227"><a href="#Warehouse-227"><span class="linenos"> 227</span></a><span class="sd">            - supplier-reject: Material refusal (FIPA refuse)</span>
</span><span id="Warehouse-228"><a href="#Warehouse-228"><span class="linenos"> 228</span></a><span class="sd">        </span>
</span><span id="Warehouse-229"><a href="#Warehouse-229"><span class="linenos"> 229</span></a><span class="sd">        Vehicle Communication:</span>
</span><span id="Warehouse-230"><a href="#Warehouse-230"><span class="linenos"> 230</span></a><span class="sd">            - order-proposal: Request vehicle delivery quote</span>
</span><span id="Warehouse-231"><a href="#Warehouse-231"><span class="linenos"> 231</span></a><span class="sd">            - vehicle-proposal: Vehicle delivery proposal</span>
</span><span id="Warehouse-232"><a href="#Warehouse-232"><span class="linenos"> 232</span></a><span class="sd">            - order-confirmation: Confirm vehicle assignment</span>
</span><span id="Warehouse-233"><a href="#Warehouse-233"><span class="linenos"> 233</span></a><span class="sd">            - vehicle-pickup: Vehicle picks up order</span>
</span><span id="Warehouse-234"><a href="#Warehouse-234"><span class="linenos"> 234</span></a><span class="sd">            - vehicle-delivery: Vehicle delivers supplies</span>
</span><span id="Warehouse-235"><a href="#Warehouse-235"><span class="linenos"> 235</span></a><span class="sd">            - presence-info: Request vehicle availability</span>
</span><span id="Warehouse-236"><a href="#Warehouse-236"><span class="linenos"> 236</span></a><span class="sd">            - presence-response: Vehicle availability status</span>
</span><span id="Warehouse-237"><a href="#Warehouse-237"><span class="linenos"> 237</span></a><span class="sd">    </span>
</span><span id="Warehouse-238"><a href="#Warehouse-238"><span class="linenos"> 238</span></a><span class="sd">    Example:</span>
</span><span id="Warehouse-239"><a href="#Warehouse-239"><span class="linenos"> 239</span></a><span class="sd">        ```python</span>
</span><span id="Warehouse-240"><a href="#Warehouse-240"><span class="linenos"> 240</span></a><span class="sd">        warehouse = Warehouse(</span>
</span><span id="Warehouse-241"><a href="#Warehouse-241"><span class="linenos"> 241</span></a><span class="sd">            jid=&quot;warehouse1@localhost&quot;,</span>
</span><span id="Warehouse-242"><a href="#Warehouse-242"><span class="linenos"> 242</span></a><span class="sd">            password=&quot;password&quot;,</span>
</span><span id="Warehouse-243"><a href="#Warehouse-243"><span class="linenos"> 243</span></a><span class="sd">            map=world_graph,</span>
</span><span id="Warehouse-244"><a href="#Warehouse-244"><span class="linenos"> 244</span></a><span class="sd">            node_id=10,</span>
</span><span id="Warehouse-245"><a href="#Warehouse-245"><span class="linenos"> 245</span></a><span class="sd">            contact_list=[&quot;store1@localhost&quot;, &quot;supplier1@localhost&quot;, &quot;vehicle1@localhost&quot;],</span>
</span><span id="Warehouse-246"><a href="#Warehouse-246"><span class="linenos"> 246</span></a><span class="sd">            verbose=True</span>
</span><span id="Warehouse-247"><a href="#Warehouse-247"><span class="linenos"> 247</span></a><span class="sd">        )</span>
</span><span id="Warehouse-248"><a href="#Warehouse-248"><span class="linenos"> 248</span></a><span class="sd">        await warehouse.start()</span>
</span><span id="Warehouse-249"><a href="#Warehouse-249"><span class="linenos"> 249</span></a><span class="sd">        ```</span>
</span><span id="Warehouse-250"><a href="#Warehouse-250"><span class="linenos"> 250</span></a><span class="sd">    </span>
</span><span id="Warehouse-251"><a href="#Warehouse-251"><span class="linenos"> 251</span></a><span class="sd">    Note:</span>
</span><span id="Warehouse-252"><a href="#Warehouse-252"><span class="linenos"> 252</span></a><span class="sd">        The warehouse automatically restocks when inventory falls below</span>
</span><span id="Warehouse-253"><a href="#Warehouse-253"><span class="linenos"> 253</span></a><span class="sd">        config.WAREHOUSE_RESUPPLY_THRESHOLD, maintaining operational capacity.</span>
</span><span id="Warehouse-254"><a href="#Warehouse-254"><span class="linenos"> 254</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Warehouse-255"><a href="#Warehouse-255"><span class="linenos"> 255</span></a>    
</span><span id="Warehouse-256"><a href="#Warehouse-256"><span class="linenos"> 256</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Warehouse-257"><a href="#Warehouse-257"><span class="linenos"> 257</span></a>    <span class="c1">#           WAREHOUSE &lt;-&gt; STORE</span>
</span><span id="Warehouse-258"><a href="#Warehouse-258"><span class="linenos"> 258</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Warehouse-259"><a href="#Warehouse-259"><span class="linenos"> 259</span></a>    
</span><span id="Warehouse-260"><a href="#Warehouse-260"><span class="linenos"> 260</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveBuyRequest</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-261"><a href="#Warehouse-261"><span class="linenos"> 261</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-262"><a href="#Warehouse-262"><span class="linenos"> 262</span></a><span class="sd">        Cyclic behaviour that processes incoming purchase requests from stores.</span>
</span><span id="Warehouse-263"><a href="#Warehouse-263"><span class="linenos"> 263</span></a><span class="sd">        </span>
</span><span id="Warehouse-264"><a href="#Warehouse-264"><span class="linenos"> 264</span></a><span class="sd">        This behaviour implements the proposal phase of the FIPA Contract Net Protocol</span>
</span><span id="Warehouse-265"><a href="#Warehouse-265"><span class="linenos"> 265</span></a><span class="sd">        where the warehouse acts as a **Participant**. It receives CFP messages from</span>
</span><span id="Warehouse-266"><a href="#Warehouse-266"><span class="linenos"> 266</span></a><span class="sd">        stores, evaluates inventory availability, and responds with either a proposal</span>
</span><span id="Warehouse-267"><a href="#Warehouse-267"><span class="linenos"> 267</span></a><span class="sd">        (warehouse-accept) or refusal (warehouse-reject).</span>
</span><span id="Warehouse-268"><a href="#Warehouse-268"><span class="linenos"> 268</span></a><span class="sd">        </span>
</span><span id="Warehouse-269"><a href="#Warehouse-269"><span class="linenos"> 269</span></a><span class="sd">        FIPA Protocol Phase: **Proposal Phase - Participant Role**</span>
</span><span id="Warehouse-270"><a href="#Warehouse-270"><span class="linenos"> 270</span></a><span class="sd">            - Role: Participant (Warehouse responding to Store&#39;s CFP)</span>
</span><span id="Warehouse-271"><a href="#Warehouse-271"><span class="linenos"> 271</span></a><span class="sd">            - Receives: store-buy messages (FIPA CFP)</span>
</span><span id="Warehouse-272"><a href="#Warehouse-272"><span class="linenos"> 272</span></a><span class="sd">            - Evaluates: Stock availability vs requested quantity</span>
</span><span id="Warehouse-273"><a href="#Warehouse-273"><span class="linenos"> 273</span></a><span class="sd">            - Responds: warehouse-accept (propose) or warehouse-reject (refuse)</span>
</span><span id="Warehouse-274"><a href="#Warehouse-274"><span class="linenos"> 274</span></a><span class="sd">        </span>
</span><span id="Warehouse-275"><a href="#Warehouse-275"><span class="linenos"> 275</span></a><span class="sd">        Stock Locking Mechanism:</span>
</span><span id="Warehouse-276"><a href="#Warehouse-276"><span class="linenos"> 276</span></a><span class="sd">            When accepting a request, stock is immediately moved from available to locked:</span>
</span><span id="Warehouse-277"><a href="#Warehouse-277"><span class="linenos"> 277</span></a><span class="sd">            - Prevents overselling (race condition protection)</span>
</span><span id="Warehouse-278"><a href="#Warehouse-278"><span class="linenos"> 278</span></a><span class="sd">            - Reserved during negotiation (awaiting confirmation)</span>
</span><span id="Warehouse-279"><a href="#Warehouse-279"><span class="linenos"> 279</span></a><span class="sd">            - Released if store sends denial or timeout occurs</span>
</span><span id="Warehouse-280"><a href="#Warehouse-280"><span class="linenos"> 280</span></a><span class="sd">            - Transferred to pending_deliveries if store confirms</span>
</span><span id="Warehouse-281"><a href="#Warehouse-281"><span class="linenos"> 281</span></a><span class="sd">        </span>
</span><span id="Warehouse-282"><a href="#Warehouse-282"><span class="linenos"> 282</span></a><span class="sd">        Decision Logic:</span>
</span><span id="Warehouse-283"><a href="#Warehouse-283"><span class="linenos"> 283</span></a><span class="sd">            Accept if: (product in stock) AND (stock[product] &gt;= quantity)</span>
</span><span id="Warehouse-284"><a href="#Warehouse-284"><span class="linenos"> 284</span></a><span class="sd">            Reject if: Product unavailable OR insufficient quantity</span>
</span><span id="Warehouse-285"><a href="#Warehouse-285"><span class="linenos"> 285</span></a><span class="sd">        </span>
</span><span id="Warehouse-286"><a href="#Warehouse-286"><span class="linenos"> 286</span></a><span class="sd">        Message Format (store-buy):</span>
</span><span id="Warehouse-287"><a href="#Warehouse-287"><span class="linenos"> 287</span></a><span class="sd">            Metadata:</span>
</span><span id="Warehouse-288"><a href="#Warehouse-288"><span class="linenos"> 288</span></a><span class="sd">                - performative: &quot;store-buy&quot;</span>
</span><span id="Warehouse-289"><a href="#Warehouse-289"><span class="linenos"> 289</span></a><span class="sd">                - request_id: Unique request identifier</span>
</span><span id="Warehouse-290"><a href="#Warehouse-290"><span class="linenos"> 290</span></a><span class="sd">            Body:</span>
</span><span id="Warehouse-291"><a href="#Warehouse-291"><span class="linenos"> 291</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse-292"><a href="#Warehouse-292"><span class="linenos"> 292</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="Warehouse-293"><a href="#Warehouse-293"><span class="linenos"> 293</span></a><span class="sd">        </span>
</span><span id="Warehouse-294"><a href="#Warehouse-294"><span class="linenos"> 294</span></a><span class="sd">        Workflow:</span>
</span><span id="Warehouse-295"><a href="#Warehouse-295"><span class="linenos"> 295</span></a><span class="sd">            1. **Receive**: Wait up to 20 seconds for store-buy message</span>
</span><span id="Warehouse-296"><a href="#Warehouse-296"><span class="linenos"> 296</span></a><span class="sd">            2. **Parse**: Extract request_id, quantity, product from message</span>
</span><span id="Warehouse-297"><a href="#Warehouse-297"><span class="linenos"> 297</span></a><span class="sd">            3. **Evaluate**: Check if product exists and quantity available</span>
</span><span id="Warehouse-298"><a href="#Warehouse-298"><span class="linenos"> 298</span></a><span class="sd">            4. **Accept Path**:</span>
</span><span id="Warehouse-299"><a href="#Warehouse-299"><span class="linenos"> 299</span></a><span class="sd">                a. Lock stock: stock[product] -= quantity</span>
</span><span id="Warehouse-300"><a href="#Warehouse-300"><span class="linenos"> 300</span></a><span class="sd">                b. Update locked_stock: locked_stock[product] += quantity</span>
</span><span id="Warehouse-301"><a href="#Warehouse-301"><span class="linenos"> 301</span></a><span class="sd">                c. Launch AcceptBuyRequest behaviour (send warehouse-accept)</span>
</span><span id="Warehouse-302"><a href="#Warehouse-302"><span class="linenos"> 302</span></a><span class="sd">            5. **Reject Path**:</span>
</span><span id="Warehouse-303"><a href="#Warehouse-303"><span class="linenos"> 303</span></a><span class="sd">                a. Launch RejectBuyRequest behaviour with reason</span>
</span><span id="Warehouse-304"><a href="#Warehouse-304"><span class="linenos"> 304</span></a><span class="sd">                b. No stock changes</span>
</span><span id="Warehouse-305"><a href="#Warehouse-305"><span class="linenos"> 305</span></a><span class="sd">        </span>
</span><span id="Warehouse-306"><a href="#Warehouse-306"><span class="linenos"> 306</span></a><span class="sd">        Concurrency Handling:</span>
</span><span id="Warehouse-307"><a href="#Warehouse-307"><span class="linenos"> 307</span></a><span class="sd">            - Processes multiple requests concurrently (cyclic behaviour)</span>
</span><span id="Warehouse-308"><a href="#Warehouse-308"><span class="linenos"> 308</span></a><span class="sd">            - Stock locking prevents double-allocation</span>
</span><span id="Warehouse-309"><a href="#Warehouse-309"><span class="linenos"> 309</span></a><span class="sd">            - Each request launches independent OneShot behaviours</span>
</span><span id="Warehouse-310"><a href="#Warehouse-310"><span class="linenos"> 310</span></a><span class="sd">        </span>
</span><span id="Warehouse-311"><a href="#Warehouse-311"><span class="linenos"> 311</span></a><span class="sd">        Example Execution:</span>
</span><span id="Warehouse-312"><a href="#Warehouse-312"><span class="linenos"> 312</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-313"><a href="#Warehouse-313"><span class="linenos"> 313</span></a><span class="sd">            Request Received: &quot;50 electronics&quot; (request_id=1001000000)</span>
</span><span id="Warehouse-314"><a href="#Warehouse-314"><span class="linenos"> 314</span></a><span class="sd">            Stock Check: electronics: 100 available</span>
</span><span id="Warehouse-315"><a href="#Warehouse-315"><span class="linenos"> 315</span></a><span class="sd">            Decision: ACCEPT</span>
</span><span id="Warehouse-316"><a href="#Warehouse-316"><span class="linenos"> 316</span></a><span class="sd">            Actions:</span>
</span><span id="Warehouse-317"><a href="#Warehouse-317"><span class="linenos"> 317</span></a><span class="sd">                - stock[electronics]: 100 -&gt; 50</span>
</span><span id="Warehouse-318"><a href="#Warehouse-318"><span class="linenos"> 318</span></a><span class="sd">                - locked_stock[electronics]: 0 -&gt; 50</span>
</span><span id="Warehouse-319"><a href="#Warehouse-319"><span class="linenos"> 319</span></a><span class="sd">                - Launch AcceptBuyRequest</span>
</span><span id="Warehouse-320"><a href="#Warehouse-320"><span class="linenos"> 320</span></a><span class="sd">                - Wait for store-confirm or store-deny</span>
</span><span id="Warehouse-321"><a href="#Warehouse-321"><span class="linenos"> 321</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-322"><a href="#Warehouse-322"><span class="linenos"> 322</span></a><span class="sd">        </span>
</span><span id="Warehouse-323"><a href="#Warehouse-323"><span class="linenos"> 323</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse-324"><a href="#Warehouse-324"><span class="linenos"> 324</span></a><span class="sd">            This behaviour never terminates (cyclic), continuously listening for</span>
</span><span id="Warehouse-325"><a href="#Warehouse-325"><span class="linenos"> 325</span></a><span class="sd">            store requests throughout the warehouse&#39;s lifecycle.</span>
</span><span id="Warehouse-326"><a href="#Warehouse-326"><span class="linenos"> 326</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-327"><a href="#Warehouse-327"><span class="linenos"> 327</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-328"><a href="#Warehouse-328"><span class="linenos"> 328</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-329"><a href="#Warehouse-329"><span class="linenos"> 329</span></a>        
</span><span id="Warehouse-330"><a href="#Warehouse-330"><span class="linenos"> 330</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-331"><a href="#Warehouse-331"><span class="linenos"> 331</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Awaiting buy request...&quot;</span><span class="p">)</span>
</span><span id="Warehouse-332"><a href="#Warehouse-332"><span class="linenos"> 332</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Warehouse-333"><a href="#Warehouse-333"><span class="linenos"> 333</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Warehouse-334"><a href="#Warehouse-334"><span class="linenos"> 334</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-335"><a href="#Warehouse-335"><span class="linenos"> 335</span></a><span class="sd">                Messages with metadata (&quot;performative&quot;, &quot;store-buy&quot;) have body</span>
</span><span id="Warehouse-336"><a href="#Warehouse-336"><span class="linenos"> 336</span></a><span class="sd">                with the following format:</span>
</span><span id="Warehouse-337"><a href="#Warehouse-337"><span class="linenos"> 337</span></a><span class="sd">                </span>
</span><span id="Warehouse-338"><a href="#Warehouse-338"><span class="linenos"> 338</span></a><span class="sd">                &quot;product_quantity product_type&quot;</span>
</span><span id="Warehouse-339"><a href="#Warehouse-339"><span class="linenos"> 339</span></a><span class="sd">                </span>
</span><span id="Warehouse-340"><a href="#Warehouse-340"><span class="linenos"> 340</span></a><span class="sd">                request_id is in metadata[&quot;request_id&quot;]</span>
</span><span id="Warehouse-341"><a href="#Warehouse-341"><span class="linenos"> 341</span></a><span class="sd">                &quot;&quot;&quot;</span>
</span><span id="Warehouse-342"><a href="#Warehouse-342"><span class="linenos"> 342</span></a>                <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse-343"><a href="#Warehouse-343"><span class="linenos"> 343</span></a>                <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse-344"><a href="#Warehouse-344"><span class="linenos"> 344</span></a>                <span class="n">quant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse-345"><a href="#Warehouse-345"><span class="linenos"> 345</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse-346"><a href="#Warehouse-346"><span class="linenos"> 346</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Got request </span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">quant</span><span class="si">}</span><span class="s2"> x</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-347"><a href="#Warehouse-347"><span class="linenos"> 347</span></a>                
</span><span id="Warehouse-348"><a href="#Warehouse-348"><span class="linenos"> 348</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">quant</span><span class="p">:</span>
</span><span id="Warehouse-349"><a href="#Warehouse-349"><span class="linenos"> 349</span></a>                    <span class="n">accept_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">AcceptBuyRequest</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-350"><a href="#Warehouse-350"><span class="linenos"> 350</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-351"><a href="#Warehouse-351"><span class="linenos"> 351</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Locking </span><span class="si">{</span><span class="n">quant</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="Warehouse-352"><a href="#Warehouse-352"><span class="linenos"> 352</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quant</span>
</span><span id="Warehouse-353"><a href="#Warehouse-353"><span class="linenos"> 353</span></a>                    
</span><span id="Warehouse-354"><a href="#Warehouse-354"><span class="linenos"> 354</span></a>                    <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">:</span>
</span><span id="Warehouse-355"><a href="#Warehouse-355"><span class="linenos"> 355</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quant</span>
</span><span id="Warehouse-356"><a href="#Warehouse-356"><span class="linenos"> 356</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant</span>
</span><span id="Warehouse-357"><a href="#Warehouse-357"><span class="linenos"> 357</span></a>
</span><span id="Warehouse-358"><a href="#Warehouse-358"><span class="linenos"> 358</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-359"><a href="#Warehouse-359"><span class="linenos"> 359</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Items locked at </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="Warehouse-360"><a href="#Warehouse-360"><span class="linenos"> 360</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="Warehouse-361"><a href="#Warehouse-361"><span class="linenos"> 361</span></a>                    
</span><span id="Warehouse-362"><a href="#Warehouse-362"><span class="linenos"> 362</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">accept_behav</span><span class="p">)</span>
</span><span id="Warehouse-363"><a href="#Warehouse-363"><span class="linenos"> 363</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-364"><a href="#Warehouse-364"><span class="linenos"> 364</span></a>                    <span class="c1"># Reject the request - insufficient stock</span>
</span><span id="Warehouse-365"><a href="#Warehouse-365"><span class="linenos"> 365</span></a>                    <span class="n">reject_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">RejectBuyRequest</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;insufficient_stock&quot;</span><span class="p">)</span>
</span><span id="Warehouse-366"><a href="#Warehouse-366"><span class="linenos"> 366</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">reject_behav</span><span class="p">)</span>
</span><span id="Warehouse-367"><a href="#Warehouse-367"><span class="linenos"> 367</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-368"><a href="#Warehouse-368"><span class="linenos"> 368</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Could not satisfy request. Rejection sent.&quot;</span><span class="p">)</span>
</span><span id="Warehouse-369"><a href="#Warehouse-369"><span class="linenos"> 369</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-370"><a href="#Warehouse-370"><span class="linenos"> 370</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-371"><a href="#Warehouse-371"><span class="linenos"> 371</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Did not get any buy requests in 20 seconds.&quot;</span><span class="p">)</span>
</span><span id="Warehouse-372"><a href="#Warehouse-372"><span class="linenos"> 372</span></a>
</span><span id="Warehouse-373"><a href="#Warehouse-373"><span class="linenos"> 373</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">AcceptBuyRequest</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-374"><a href="#Warehouse-374"><span class="linenos"> 374</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-375"><a href="#Warehouse-375"><span class="linenos"> 375</span></a><span class="sd">        Behaviour that sends proposal acceptance to store (FIPA propose).</span>
</span><span id="Warehouse-376"><a href="#Warehouse-376"><span class="linenos"> 376</span></a><span class="sd">        </span>
</span><span id="Warehouse-377"><a href="#Warehouse-377"><span class="linenos"> 377</span></a><span class="sd">        This behaviour implements the proposal submission in the FIPA Contract Net</span>
</span><span id="Warehouse-378"><a href="#Warehouse-378"><span class="linenos"> 378</span></a><span class="sd">        Protocol where the warehouse, acting as a participant, sends its proposal</span>
</span><span id="Warehouse-379"><a href="#Warehouse-379"><span class="linenos"> 379</span></a><span class="sd">        to fulfill the store&#39;s request. It then sets up to receive the store&#39;s</span>
</span><span id="Warehouse-380"><a href="#Warehouse-380"><span class="linenos"> 380</span></a><span class="sd">        decision (accept-proposal or reject-proposal).</span>
</span><span id="Warehouse-381"><a href="#Warehouse-381"><span class="linenos"> 381</span></a><span class="sd">        </span>
</span><span id="Warehouse-382"><a href="#Warehouse-382"><span class="linenos"> 382</span></a><span class="sd">        FIPA Protocol Phase: **Proposal Submission - Participant Role**</span>
</span><span id="Warehouse-383"><a href="#Warehouse-383"><span class="linenos"> 383</span></a><span class="sd">            - Role: Participant (Warehouse proposing to Store)</span>
</span><span id="Warehouse-384"><a href="#Warehouse-384"><span class="linenos"> 384</span></a><span class="sd">            - Sends: warehouse-accept (FIPA propose)</span>
</span><span id="Warehouse-385"><a href="#Warehouse-385"><span class="linenos"> 385</span></a><span class="sd">            - Purpose: &quot;I can fulfill your request&quot;</span>
</span><span id="Warehouse-386"><a href="#Warehouse-386"><span class="linenos"> 386</span></a><span class="sd">            - Next Phase: Await store&#39;s award or rejection decision</span>
</span><span id="Warehouse-387"><a href="#Warehouse-387"><span class="linenos"> 387</span></a><span class="sd">        </span>
</span><span id="Warehouse-388"><a href="#Warehouse-388"><span class="linenos"> 388</span></a><span class="sd">        Attributes:</span>
</span><span id="Warehouse-389"><a href="#Warehouse-389"><span class="linenos"> 389</span></a><span class="sd">            request_id (int): Unique identifier for this request.</span>
</span><span id="Warehouse-390"><a href="#Warehouse-390"><span class="linenos"> 390</span></a><span class="sd">            quant (int): Quantity of product being proposed.</span>
</span><span id="Warehouse-391"><a href="#Warehouse-391"><span class="linenos"> 391</span></a><span class="sd">            product (str): Name of product being proposed.</span>
</span><span id="Warehouse-392"><a href="#Warehouse-392"><span class="linenos"> 392</span></a><span class="sd">            sender (str): Store JID that initiated the request.</span>
</span><span id="Warehouse-393"><a href="#Warehouse-393"><span class="linenos"> 393</span></a><span class="sd">        </span>
</span><span id="Warehouse-394"><a href="#Warehouse-394"><span class="linenos"> 394</span></a><span class="sd">        Message Format (warehouse-accept):</span>
</span><span id="Warehouse-395"><a href="#Warehouse-395"><span class="linenos"> 395</span></a><span class="sd">            Metadata:</span>
</span><span id="Warehouse-396"><a href="#Warehouse-396"><span class="linenos"> 396</span></a><span class="sd">                - performative: &quot;warehouse-accept&quot; (FIPA propose)</span>
</span><span id="Warehouse-397"><a href="#Warehouse-397"><span class="linenos"> 397</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="Warehouse-398"><a href="#Warehouse-398"><span class="linenos"> 398</span></a><span class="sd">                - store_id: Requesting store&#39;s JID</span>
</span><span id="Warehouse-399"><a href="#Warehouse-399"><span class="linenos"> 399</span></a><span class="sd">                - node_id: Warehouse&#39;s graph location</span>
</span><span id="Warehouse-400"><a href="#Warehouse-400"><span class="linenos"> 400</span></a><span class="sd">                - request_id: Original request identifier</span>
</span><span id="Warehouse-401"><a href="#Warehouse-401"><span class="linenos"> 401</span></a><span class="sd">            Body:</span>
</span><span id="Warehouse-402"><a href="#Warehouse-402"><span class="linenos"> 402</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse-403"><a href="#Warehouse-403"><span class="linenos"> 403</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="Warehouse-404"><a href="#Warehouse-404"><span class="linenos"> 404</span></a><span class="sd">        </span>
</span><span id="Warehouse-405"><a href="#Warehouse-405"><span class="linenos"> 405</span></a><span class="sd">        Workflow:</span>
</span><span id="Warehouse-406"><a href="#Warehouse-406"><span class="linenos"> 406</span></a><span class="sd">            1. **Send Proposal**: Construct and send warehouse-accept message</span>
</span><span id="Warehouse-407"><a href="#Warehouse-407"><span class="linenos"> 407</span></a><span class="sd">            2. **Setup Listener**: Create ReceiveConfirmationOrDenial behaviour</span>
</span><span id="Warehouse-408"><a href="#Warehouse-408"><span class="linenos"> 408</span></a><span class="sd">            3. **Configure Template**: Filter for this specific store and request</span>
</span><span id="Warehouse-409"><a href="#Warehouse-409"><span class="linenos"> 409</span></a><span class="sd">            4. **Register Behaviour**: Add listener with template to agent</span>
</span><span id="Warehouse-410"><a href="#Warehouse-410"><span class="linenos"> 410</span></a><span class="sd">            5. **Non-blocking**: Return immediately (don&#39;t wait for response)</span>
</span><span id="Warehouse-411"><a href="#Warehouse-411"><span class="linenos"> 411</span></a><span class="sd">        </span>
</span><span id="Warehouse-412"><a href="#Warehouse-412"><span class="linenos"> 412</span></a><span class="sd">        Template Configuration:</span>
</span><span id="Warehouse-413"><a href="#Warehouse-413"><span class="linenos"> 413</span></a><span class="sd">            Filters messages to match:</span>
</span><span id="Warehouse-414"><a href="#Warehouse-414"><span class="linenos"> 414</span></a><span class="sd">            - warehouse_id: This warehouse</span>
</span><span id="Warehouse-415"><a href="#Warehouse-415"><span class="linenos"> 415</span></a><span class="sd">            - store_id: Specific store that made request</span>
</span><span id="Warehouse-416"><a href="#Warehouse-416"><span class="linenos"> 416</span></a><span class="sd">            - request_id: This specific request</span>
</span><span id="Warehouse-417"><a href="#Warehouse-417"><span class="linenos"> 417</span></a><span class="sd">            </span>
</span><span id="Warehouse-418"><a href="#Warehouse-418"><span class="linenos"> 418</span></a><span class="sd">            Accepts both performatives:</span>
</span><span id="Warehouse-419"><a href="#Warehouse-419"><span class="linenos"> 419</span></a><span class="sd">            - store-confirm (FIPA accept-proposal)</span>
</span><span id="Warehouse-420"><a href="#Warehouse-420"><span class="linenos"> 420</span></a><span class="sd">            - store-deny (FIPA reject-proposal)</span>
</span><span id="Warehouse-421"><a href="#Warehouse-421"><span class="linenos"> 421</span></a><span class="sd">        </span>
</span><span id="Warehouse-422"><a href="#Warehouse-422"><span class="linenos"> 422</span></a><span class="sd">        Example:</span>
</span><span id="Warehouse-423"><a href="#Warehouse-423"><span class="linenos"> 423</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-424"><a href="#Warehouse-424"><span class="linenos"> 424</span></a><span class="sd">            Input: Store request for &quot;50 electronics&quot;</span>
</span><span id="Warehouse-425"><a href="#Warehouse-425"><span class="linenos"> 425</span></a><span class="sd">            Proposal Sent: warehouse-accept with body &quot;50 electronics&quot;</span>
</span><span id="Warehouse-426"><a href="#Warehouse-426"><span class="linenos"> 426</span></a><span class="sd">            Listener Setup: ReceiveConfirmationOrDenial waiting for:</span>
</span><span id="Warehouse-427"><a href="#Warehouse-427"><span class="linenos"> 427</span></a><span class="sd">                - store-confirm (unlock -&gt; pending delivery) OR</span>
</span><span id="Warehouse-428"><a href="#Warehouse-428"><span class="linenos"> 428</span></a><span class="sd">                - store-deny (unlock -&gt; available stock)</span>
</span><span id="Warehouse-429"><a href="#Warehouse-429"><span class="linenos"> 429</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-430"><a href="#Warehouse-430"><span class="linenos"> 430</span></a><span class="sd">        </span>
</span><span id="Warehouse-431"><a href="#Warehouse-431"><span class="linenos"> 431</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse-432"><a href="#Warehouse-432"><span class="linenos"> 432</span></a><span class="sd">            Stock remains locked until ReceiveConfirmationOrDenial processes</span>
</span><span id="Warehouse-433"><a href="#Warehouse-433"><span class="linenos"> 433</span></a><span class="sd">            the store&#39;s decision or times out.</span>
</span><span id="Warehouse-434"><a href="#Warehouse-434"><span class="linenos"> 434</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-435"><a href="#Warehouse-435"><span class="linenos"> 435</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Warehouse-436"><a href="#Warehouse-436"><span class="linenos"> 436</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-437"><a href="#Warehouse-437"><span class="linenos"> 437</span></a><span class="sd">            Initialize the AcceptBuyRequest behaviour.</span>
</span><span id="Warehouse-438"><a href="#Warehouse-438"><span class="linenos"> 438</span></a><span class="sd">            </span>
</span><span id="Warehouse-439"><a href="#Warehouse-439"><span class="linenos"> 439</span></a><span class="sd">            Args:</span>
</span><span id="Warehouse-440"><a href="#Warehouse-440"><span class="linenos"> 440</span></a><span class="sd">                msg (Message): The store-buy request message to accept.</span>
</span><span id="Warehouse-441"><a href="#Warehouse-441"><span class="linenos"> 441</span></a><span class="sd">                    Contains request_id in metadata and &quot;{quantity} {product}&quot; in body.</span>
</span><span id="Warehouse-442"><a href="#Warehouse-442"><span class="linenos"> 442</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse-443"><a href="#Warehouse-443"><span class="linenos"> 443</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse-444"><a href="#Warehouse-444"><span class="linenos"> 444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse-445"><a href="#Warehouse-445"><span class="linenos"> 445</span></a>            <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse-446"><a href="#Warehouse-446"><span class="linenos"> 446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse-447"><a href="#Warehouse-447"><span class="linenos"> 447</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse-448"><a href="#Warehouse-448"><span class="linenos"> 448</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Warehouse-449"><a href="#Warehouse-449"><span class="linenos"> 449</span></a>        
</span><span id="Warehouse-450"><a href="#Warehouse-450"><span class="linenos"> 450</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-451"><a href="#Warehouse-451"><span class="linenos"> 451</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-452"><a href="#Warehouse-452"><span class="linenos"> 452</span></a><span class="sd">            Execute the proposal sending and confirmation listener setup.</span>
</span><span id="Warehouse-453"><a href="#Warehouse-453"><span class="linenos"> 453</span></a><span class="sd">            </span>
</span><span id="Warehouse-454"><a href="#Warehouse-454"><span class="linenos"> 454</span></a><span class="sd">            This method sends the warehouse-accept (FIPA propose) message to the store</span>
</span><span id="Warehouse-455"><a href="#Warehouse-455"><span class="linenos"> 455</span></a><span class="sd">            and immediately sets up a listener behaviour to await the store&#39;s decision.</span>
</span><span id="Warehouse-456"><a href="#Warehouse-456"><span class="linenos"> 456</span></a><span class="sd">            The method returns quickly without blocking, allowing the warehouse to</span>
</span><span id="Warehouse-457"><a href="#Warehouse-457"><span class="linenos"> 457</span></a><span class="sd">            continue processing other requests concurrently.</span>
</span><span id="Warehouse-458"><a href="#Warehouse-458"><span class="linenos"> 458</span></a><span class="sd">            </span>
</span><span id="Warehouse-459"><a href="#Warehouse-459"><span class="linenos"> 459</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Warehouse-460"><a href="#Warehouse-460"><span class="linenos"> 460</span></a><span class="sd">                - **Phase**: Proposal Submission</span>
</span><span id="Warehouse-461"><a href="#Warehouse-461"><span class="linenos"> 461</span></a><span class="sd">                - **Performative**: warehouse-accept (FIPA propose)</span>
</span><span id="Warehouse-462"><a href="#Warehouse-462"><span class="linenos"> 462</span></a><span class="sd">                - **Content**: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse-463"><a href="#Warehouse-463"><span class="linenos"> 463</span></a><span class="sd">                - **Receiver**: Store that sent the CFP</span>
</span><span id="Warehouse-464"><a href="#Warehouse-464"><span class="linenos"> 464</span></a><span class="sd">                - **Next Step**: Await store&#39;s accept-proposal or reject-proposal</span>
</span><span id="Warehouse-465"><a href="#Warehouse-465"><span class="linenos"> 465</span></a><span class="sd">            </span>
</span><span id="Warehouse-466"><a href="#Warehouse-466"><span class="linenos"> 466</span></a><span class="sd">            Workflow:</span>
</span><span id="Warehouse-467"><a href="#Warehouse-467"><span class="linenos"> 467</span></a><span class="sd">                1. **Log Acceptance** (verbose): Print proposal details</span>
</span><span id="Warehouse-468"><a href="#Warehouse-468"><span class="linenos"> 468</span></a><span class="sd">                2. **Construct Message**: Create warehouse-accept with all metadata</span>
</span><span id="Warehouse-469"><a href="#Warehouse-469"><span class="linenos"> 469</span></a><span class="sd">                3. **Send Proposal**: Transmit to requesting store</span>
</span><span id="Warehouse-470"><a href="#Warehouse-470"><span class="linenos"> 470</span></a><span class="sd">                4. **Create Listener**: Initialize ReceiveConfirmationOrDenial behaviour</span>
</span><span id="Warehouse-471"><a href="#Warehouse-471"><span class="linenos"> 471</span></a><span class="sd">                5. **Setup Template**: Configure filter for this specific negotiation</span>
</span><span id="Warehouse-472"><a href="#Warehouse-472"><span class="linenos"> 472</span></a><span class="sd">                6. **Register Listener**: Add behaviour with template to agent</span>
</span><span id="Warehouse-473"><a href="#Warehouse-473"><span class="linenos"> 473</span></a><span class="sd">                7. **Return**: Don&#39;t block (listener runs independently)</span>
</span><span id="Warehouse-474"><a href="#Warehouse-474"><span class="linenos"> 474</span></a><span class="sd">            </span>
</span><span id="Warehouse-475"><a href="#Warehouse-475"><span class="linenos"> 475</span></a><span class="sd">            Template Filtering:</span>
</span><span id="Warehouse-476"><a href="#Warehouse-476"><span class="linenos"> 476</span></a><span class="sd">                The template ensures the listener only receives messages for THIS</span>
</span><span id="Warehouse-477"><a href="#Warehouse-477"><span class="linenos"> 477</span></a><span class="sd">                specific negotiation by matching:</span>
</span><span id="Warehouse-478"><a href="#Warehouse-478"><span class="linenos"> 478</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="Warehouse-479"><a href="#Warehouse-479"><span class="linenos"> 479</span></a><span class="sd">                - store_id: The specific store&#39;s JID</span>
</span><span id="Warehouse-480"><a href="#Warehouse-480"><span class="linenos"> 480</span></a><span class="sd">                - request_id: This specific request&#39;s ID</span>
</span><span id="Warehouse-481"><a href="#Warehouse-481"><span class="linenos"> 481</span></a><span class="sd">            </span>
</span><span id="Warehouse-482"><a href="#Warehouse-482"><span class="linenos"> 482</span></a><span class="sd">            Non-Blocking Design:</span>
</span><span id="Warehouse-483"><a href="#Warehouse-483"><span class="linenos"> 483</span></a><span class="sd">                The commented-out `await confirm_deny_behav.join()` demonstrates</span>
</span><span id="Warehouse-484"><a href="#Warehouse-484"><span class="linenos"> 484</span></a><span class="sd">                that we intentionally DON&#39;T wait for confirmation here. This allows</span>
</span><span id="Warehouse-485"><a href="#Warehouse-485"><span class="linenos"> 485</span></a><span class="sd">                the warehouse to accept multiple store requests concurrently.</span>
</span><span id="Warehouse-486"><a href="#Warehouse-486"><span class="linenos"> 486</span></a><span class="sd">            </span>
</span><span id="Warehouse-487"><a href="#Warehouse-487"><span class="linenos"> 487</span></a><span class="sd">            Side Effects:</span>
</span><span id="Warehouse-488"><a href="#Warehouse-488"><span class="linenos"> 488</span></a><span class="sd">                - Sends SPADE message to store</span>
</span><span id="Warehouse-489"><a href="#Warehouse-489"><span class="linenos"> 489</span></a><span class="sd">                - Adds ReceiveConfirmationOrDenial behaviour to agent</span>
</span><span id="Warehouse-490"><a href="#Warehouse-490"><span class="linenos"> 490</span></a><span class="sd">                - Prints debug information if verbose enabled</span>
</span><span id="Warehouse-491"><a href="#Warehouse-491"><span class="linenos"> 491</span></a><span class="sd">            </span>
</span><span id="Warehouse-492"><a href="#Warehouse-492"><span class="linenos"> 492</span></a><span class="sd">            Returns:</span>
</span><span id="Warehouse-493"><a href="#Warehouse-493"><span class="linenos"> 493</span></a><span class="sd">                None. Completes immediately after setting up the listener.</span>
</span><span id="Warehouse-494"><a href="#Warehouse-494"><span class="linenos"> 494</span></a><span class="sd">            </span>
</span><span id="Warehouse-495"><a href="#Warehouse-495"><span class="linenos"> 495</span></a><span class="sd">            Example:</span>
</span><span id="Warehouse-496"><a href="#Warehouse-496"><span class="linenos"> 496</span></a><span class="sd">                ```</span>
</span><span id="Warehouse-497"><a href="#Warehouse-497"><span class="linenos"> 497</span></a><span class="sd">                Input: Request for &quot;50 electronics&quot; from store1</span>
</span><span id="Warehouse-498"><a href="#Warehouse-498"><span class="linenos"> 498</span></a><span class="sd">                Actions:</span>
</span><span id="Warehouse-499"><a href="#Warehouse-499"><span class="linenos"> 499</span></a><span class="sd">                    1. Send warehouse-accept to store1</span>
</span><span id="Warehouse-500"><a href="#Warehouse-500"><span class="linenos"> 500</span></a><span class="sd">                    2. Setup listener with template matching:</span>
</span><span id="Warehouse-501"><a href="#Warehouse-501"><span class="linenos"> 501</span></a><span class="sd">                       - warehouse_id=warehouse1@localhost</span>
</span><span id="Warehouse-502"><a href="#Warehouse-502"><span class="linenos"> 502</span></a><span class="sd">                       - store_id=store1@localhost</span>
</span><span id="Warehouse-503"><a href="#Warehouse-503"><span class="linenos"> 503</span></a><span class="sd">                       - request_id=1001000000</span>
</span><span id="Warehouse-504"><a href="#Warehouse-504"><span class="linenos"> 504</span></a><span class="sd">                    3. Return (warehouse ready for next request)</span>
</span><span id="Warehouse-505"><a href="#Warehouse-505"><span class="linenos"> 505</span></a><span class="sd">                Listener waits independently for store&#39;s decision</span>
</span><span id="Warehouse-506"><a href="#Warehouse-506"><span class="linenos"> 506</span></a><span class="sd">                ```</span>
</span><span id="Warehouse-507"><a href="#Warehouse-507"><span class="linenos"> 507</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse-508"><a href="#Warehouse-508"><span class="linenos"> 508</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-509"><a href="#Warehouse-509"><span class="linenos"> 509</span></a>            
</span><span id="Warehouse-510"><a href="#Warehouse-510"><span class="linenos"> 510</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-511"><a href="#Warehouse-511"><span class="linenos"> 511</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="Warehouse-512"><a href="#Warehouse-512"><span class="linenos"> 512</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Accepted a request from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">: &quot;</span>
</span><span id="Warehouse-513"><a href="#Warehouse-513"><span class="linenos"> 513</span></a>                    <span class="sa">f</span><span class="s2">&quot;id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse-514"><a href="#Warehouse-514"><span class="linenos"> 514</span></a>                    <span class="sa">f</span><span class="s2">&quot;quant=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse-515"><a href="#Warehouse-515"><span class="linenos"> 515</span></a>                    <span class="sa">f</span><span class="s2">&quot;product=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse-516"><a href="#Warehouse-516"><span class="linenos"> 516</span></a>                <span class="p">)</span>
</span><span id="Warehouse-517"><a href="#Warehouse-517"><span class="linenos"> 517</span></a>            
</span><span id="Warehouse-518"><a href="#Warehouse-518"><span class="linenos"> 518</span></a>            
</span><span id="Warehouse-519"><a href="#Warehouse-519"><span class="linenos"> 519</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse-520"><a href="#Warehouse-520"><span class="linenos"> 520</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-accept&quot;</span><span class="p">)</span>
</span><span id="Warehouse-521"><a href="#Warehouse-521"><span class="linenos"> 521</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse-522"><a href="#Warehouse-522"><span class="linenos"> 522</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">))</span>
</span><span id="Warehouse-523"><a href="#Warehouse-523"><span class="linenos"> 523</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse-524"><a href="#Warehouse-524"><span class="linenos"> 524</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse-525"><a href="#Warehouse-525"><span class="linenos"> 525</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse-526"><a href="#Warehouse-526"><span class="linenos"> 526</span></a>            
</span><span id="Warehouse-527"><a href="#Warehouse-527"><span class="linenos"> 527</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-528"><a href="#Warehouse-528"><span class="linenos"> 528</span></a>            
</span><span id="Warehouse-529"><a href="#Warehouse-529"><span class="linenos"> 529</span></a>            <span class="c1"># Wait for either confirmation or denial</span>
</span><span id="Warehouse-530"><a href="#Warehouse-530"><span class="linenos"> 530</span></a>            <span class="n">confirm_deny_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ReceiveConfirmationOrDenial</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse-531"><a href="#Warehouse-531"><span class="linenos"> 531</span></a>            
</span><span id="Warehouse-532"><a href="#Warehouse-532"><span class="linenos"> 532</span></a>            <span class="c1"># Template that matches BOTH store-confirm AND store-deny</span>
</span><span id="Warehouse-533"><a href="#Warehouse-533"><span class="linenos"> 533</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse-534"><a href="#Warehouse-534"><span class="linenos"> 534</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse-535"><a href="#Warehouse-535"><span class="linenos"> 535</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">))</span>
</span><span id="Warehouse-536"><a href="#Warehouse-536"><span class="linenos"> 536</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse-537"><a href="#Warehouse-537"><span class="linenos"> 537</span></a>            
</span><span id="Warehouse-538"><a href="#Warehouse-538"><span class="linenos"> 538</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">confirm_deny_behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Warehouse-539"><a href="#Warehouse-539"><span class="linenos"> 539</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-540"><a href="#Warehouse-540"><span class="linenos"> 540</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; AcceptBuyRequest finished, now waiting for confirmation or denial...&quot;</span><span class="p">)</span>
</span><span id="Warehouse-541"><a href="#Warehouse-541"><span class="linenos"> 541</span></a>            
</span><span id="Warehouse-542"><a href="#Warehouse-542"><span class="linenos"> 542</span></a>            <span class="c1"># Aguardar a confirmao ser recebida antes de terminar</span>
</span><span id="Warehouse-543"><a href="#Warehouse-543"><span class="linenos"> 543</span></a>            <span class="c1"># await confirm_deny_behav.join()</span>
</span><span id="Warehouse-544"><a href="#Warehouse-544"><span class="linenos"> 544</span></a>    
</span><span id="Warehouse-545"><a href="#Warehouse-545"><span class="linenos"> 545</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">RejectBuyRequest</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-546"><a href="#Warehouse-546"><span class="linenos"> 546</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-547"><a href="#Warehouse-547"><span class="linenos"> 547</span></a><span class="sd">        Behaviour that sends proposal refusal to store (FIPA refuse).</span>
</span><span id="Warehouse-548"><a href="#Warehouse-548"><span class="linenos"> 548</span></a><span class="sd">        </span>
</span><span id="Warehouse-549"><a href="#Warehouse-549"><span class="linenos"> 549</span></a><span class="sd">        This behaviour implements the refusal response in the FIPA Contract Net Protocol</span>
</span><span id="Warehouse-550"><a href="#Warehouse-550"><span class="linenos"> 550</span></a><span class="sd">        where the warehouse, acting as a participant, declines to fulfill the store&#39;s</span>
</span><span id="Warehouse-551"><a href="#Warehouse-551"><span class="linenos"> 551</span></a><span class="sd">        request due to insufficient inventory or other constraints.</span>
</span><span id="Warehouse-552"><a href="#Warehouse-552"><span class="linenos"> 552</span></a><span class="sd">        </span>
</span><span id="Warehouse-553"><a href="#Warehouse-553"><span class="linenos"> 553</span></a><span class="sd">        FIPA Protocol Phase: **Proposal Phase - Refusal**</span>
</span><span id="Warehouse-554"><a href="#Warehouse-554"><span class="linenos"> 554</span></a><span class="sd">            - Role: Participant (Warehouse declining Store&#39;s CFP)</span>
</span><span id="Warehouse-555"><a href="#Warehouse-555"><span class="linenos"> 555</span></a><span class="sd">            - Sends: warehouse-reject (FIPA refuse)</span>
</span><span id="Warehouse-556"><a href="#Warehouse-556"><span class="linenos"> 556</span></a><span class="sd">            - Purpose: &quot;I cannot fulfill your request&quot;</span>
</span><span id="Warehouse-557"><a href="#Warehouse-557"><span class="linenos"> 557</span></a><span class="sd">            - Reason: Typically &quot;insufficient_stock&quot;</span>
</span><span id="Warehouse-558"><a href="#Warehouse-558"><span class="linenos"> 558</span></a><span class="sd">            - Result: Store will try other warehouses</span>
</span><span id="Warehouse-559"><a href="#Warehouse-559"><span class="linenos"> 559</span></a><span class="sd">        </span>
</span><span id="Warehouse-560"><a href="#Warehouse-560"><span class="linenos"> 560</span></a><span class="sd">        Attributes:</span>
</span><span id="Warehouse-561"><a href="#Warehouse-561"><span class="linenos"> 561</span></a><span class="sd">            request_id (int): Unique identifier for this request.</span>
</span><span id="Warehouse-562"><a href="#Warehouse-562"><span class="linenos"> 562</span></a><span class="sd">            quant (int): Requested quantity that cannot be fulfilled.</span>
</span><span id="Warehouse-563"><a href="#Warehouse-563"><span class="linenos"> 563</span></a><span class="sd">            product (str): Requested product that is unavailable/insufficient.</span>
</span><span id="Warehouse-564"><a href="#Warehouse-564"><span class="linenos"> 564</span></a><span class="sd">            sender (str): Store JID that initiated the request.</span>
</span><span id="Warehouse-565"><a href="#Warehouse-565"><span class="linenos"> 565</span></a><span class="sd">            reason (str): Rejection reason (default: &quot;insufficient_stock&quot;).</span>
</span><span id="Warehouse-566"><a href="#Warehouse-566"><span class="linenos"> 566</span></a><span class="sd">        </span>
</span><span id="Warehouse-567"><a href="#Warehouse-567"><span class="linenos"> 567</span></a><span class="sd">        Message Format (warehouse-reject):</span>
</span><span id="Warehouse-568"><a href="#Warehouse-568"><span class="linenos"> 568</span></a><span class="sd">            Metadata:</span>
</span><span id="Warehouse-569"><a href="#Warehouse-569"><span class="linenos"> 569</span></a><span class="sd">                - performative: &quot;warehouse-reject&quot; (FIPA refuse)</span>
</span><span id="Warehouse-570"><a href="#Warehouse-570"><span class="linenos"> 570</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="Warehouse-571"><a href="#Warehouse-571"><span class="linenos"> 571</span></a><span class="sd">                - store_id: Requesting store&#39;s JID</span>
</span><span id="Warehouse-572"><a href="#Warehouse-572"><span class="linenos"> 572</span></a><span class="sd">                - node_id: Warehouse&#39;s graph location</span>
</span><span id="Warehouse-573"><a href="#Warehouse-573"><span class="linenos"> 573</span></a><span class="sd">                - request_id: Original request identifier</span>
</span><span id="Warehouse-574"><a href="#Warehouse-574"><span class="linenos"> 574</span></a><span class="sd">            Body:</span>
</span><span id="Warehouse-575"><a href="#Warehouse-575"><span class="linenos"> 575</span></a><span class="sd">                - Format: &quot;{quantity} {product} {reason}&quot;</span>
</span><span id="Warehouse-576"><a href="#Warehouse-576"><span class="linenos"> 576</span></a><span class="sd">                - Example: &quot;50 electronics insufficient_stock&quot;</span>
</span><span id="Warehouse-577"><a href="#Warehouse-577"><span class="linenos"> 577</span></a><span class="sd">        </span>
</span><span id="Warehouse-578"><a href="#Warehouse-578"><span class="linenos"> 578</span></a><span class="sd">        Common Rejection Reasons:</span>
</span><span id="Warehouse-579"><a href="#Warehouse-579"><span class="linenos"> 579</span></a><span class="sd">            - &quot;insufficient_stock&quot;: Not enough product available</span>
</span><span id="Warehouse-580"><a href="#Warehouse-580"><span class="linenos"> 580</span></a><span class="sd">            - &quot;product_unavailable&quot;: Product not carried by this warehouse</span>
</span><span id="Warehouse-581"><a href="#Warehouse-581"><span class="linenos"> 581</span></a><span class="sd">            - &quot;capacity_exceeded&quot;: Order too large for capacity constraints</span>
</span><span id="Warehouse-582"><a href="#Warehouse-582"><span class="linenos"> 582</span></a><span class="sd">        </span>
</span><span id="Warehouse-583"><a href="#Warehouse-583"><span class="linenos"> 583</span></a><span class="sd">        Example:</span>
</span><span id="Warehouse-584"><a href="#Warehouse-584"><span class="linenos"> 584</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-585"><a href="#Warehouse-585"><span class="linenos"> 585</span></a><span class="sd">            Request: &quot;100 electronics&quot; (only 50 available)</span>
</span><span id="Warehouse-586"><a href="#Warehouse-586"><span class="linenos"> 586</span></a><span class="sd">            Decision: REJECT</span>
</span><span id="Warehouse-587"><a href="#Warehouse-587"><span class="linenos"> 587</span></a><span class="sd">            Message Sent: warehouse-reject</span>
</span><span id="Warehouse-588"><a href="#Warehouse-588"><span class="linenos"> 588</span></a><span class="sd">                Body: &quot;100 electronics insufficient_stock&quot;</span>
</span><span id="Warehouse-589"><a href="#Warehouse-589"><span class="linenos"> 589</span></a><span class="sd">            Result: Stock unchanged, store tries other warehouses</span>
</span><span id="Warehouse-590"><a href="#Warehouse-590"><span class="linenos"> 590</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-591"><a href="#Warehouse-591"><span class="linenos"> 591</span></a><span class="sd">        </span>
</span><span id="Warehouse-592"><a href="#Warehouse-592"><span class="linenos"> 592</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse-593"><a href="#Warehouse-593"><span class="linenos"> 593</span></a><span class="sd">            Unlike AcceptBuyRequest, this behaviour does NOT set up any listeners</span>
</span><span id="Warehouse-594"><a href="#Warehouse-594"><span class="linenos"> 594</span></a><span class="sd">            because no further interaction is expected after refusal.</span>
</span><span id="Warehouse-595"><a href="#Warehouse-595"><span class="linenos"> 595</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-596"><a href="#Warehouse-596"><span class="linenos"> 596</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">reason</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;insufficient_stock&quot;</span><span class="p">):</span>
</span><span id="Warehouse-597"><a href="#Warehouse-597"><span class="linenos"> 597</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-598"><a href="#Warehouse-598"><span class="linenos"> 598</span></a><span class="sd">            Initialize the RejectBuyRequest behaviour.</span>
</span><span id="Warehouse-599"><a href="#Warehouse-599"><span class="linenos"> 599</span></a><span class="sd">            </span>
</span><span id="Warehouse-600"><a href="#Warehouse-600"><span class="linenos"> 600</span></a><span class="sd">            Args:</span>
</span><span id="Warehouse-601"><a href="#Warehouse-601"><span class="linenos"> 601</span></a><span class="sd">                msg (Message): The store-buy request message to reject.</span>
</span><span id="Warehouse-602"><a href="#Warehouse-602"><span class="linenos"> 602</span></a><span class="sd">                reason (str, optional): Reason for rejection. Defaults to &quot;insufficient_stock&quot;.</span>
</span><span id="Warehouse-603"><a href="#Warehouse-603"><span class="linenos"> 603</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse-604"><a href="#Warehouse-604"><span class="linenos"> 604</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse-605"><a href="#Warehouse-605"><span class="linenos"> 605</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse-606"><a href="#Warehouse-606"><span class="linenos"> 606</span></a>            <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse-607"><a href="#Warehouse-607"><span class="linenos"> 607</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse-608"><a href="#Warehouse-608"><span class="linenos"> 608</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse-609"><a href="#Warehouse-609"><span class="linenos"> 609</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Warehouse-610"><a href="#Warehouse-610"><span class="linenos"> 610</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span>
</span><span id="Warehouse-611"><a href="#Warehouse-611"><span class="linenos"> 611</span></a>        
</span><span id="Warehouse-612"><a href="#Warehouse-612"><span class="linenos"> 612</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-613"><a href="#Warehouse-613"><span class="linenos"> 613</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-614"><a href="#Warehouse-614"><span class="linenos"> 614</span></a><span class="sd">            Send warehouse-reject message to requesting store.</span>
</span><span id="Warehouse-615"><a href="#Warehouse-615"><span class="linenos"> 615</span></a><span class="sd">            </span>
</span><span id="Warehouse-616"><a href="#Warehouse-616"><span class="linenos"> 616</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Warehouse-617"><a href="#Warehouse-617"><span class="linenos"> 617</span></a><span class="sd">                - Phase: Proposal Refusal</span>
</span><span id="Warehouse-618"><a href="#Warehouse-618"><span class="linenos"> 618</span></a><span class="sd">                - Performative: warehouse-reject (FIPA refuse)</span>
</span><span id="Warehouse-619"><a href="#Warehouse-619"><span class="linenos"> 619</span></a><span class="sd">                - Direction: Warehouse  Store</span>
</span><span id="Warehouse-620"><a href="#Warehouse-620"><span class="linenos"> 620</span></a><span class="sd">            </span>
</span><span id="Warehouse-621"><a href="#Warehouse-621"><span class="linenos"> 621</span></a><span class="sd">            Workflow:</span>
</span><span id="Warehouse-622"><a href="#Warehouse-622"><span class="linenos"> 622</span></a><span class="sd">                1. **Log Rejection** (verbose): Print rejection details</span>
</span><span id="Warehouse-623"><a href="#Warehouse-623"><span class="linenos"> 623</span></a><span class="sd">                2. **Construct Message**: Create warehouse-reject with metadata</span>
</span><span id="Warehouse-624"><a href="#Warehouse-624"><span class="linenos"> 624</span></a><span class="sd">                3. **Include Reason**: Add rejection reason to message body</span>
</span><span id="Warehouse-625"><a href="#Warehouse-625"><span class="linenos"> 625</span></a><span class="sd">                4. **Send Refusal**: Transmit to requesting store</span>
</span><span id="Warehouse-626"><a href="#Warehouse-626"><span class="linenos"> 626</span></a><span class="sd">                5. **Complete**: No further interaction (one-shot behaviour)</span>
</span><span id="Warehouse-627"><a href="#Warehouse-627"><span class="linenos"> 627</span></a><span class="sd">            </span>
</span><span id="Warehouse-628"><a href="#Warehouse-628"><span class="linenos"> 628</span></a><span class="sd">            Side Effects:</span>
</span><span id="Warehouse-629"><a href="#Warehouse-629"><span class="linenos"> 629</span></a><span class="sd">                - No stock changes (was never locked for insufficient stock)</span>
</span><span id="Warehouse-630"><a href="#Warehouse-630"><span class="linenos"> 630</span></a><span class="sd">                - No listeners created (conversation ends with refusal)</span>
</span><span id="Warehouse-631"><a href="#Warehouse-631"><span class="linenos"> 631</span></a><span class="sd">                - Store receives refusal and tries other warehouses</span>
</span><span id="Warehouse-632"><a href="#Warehouse-632"><span class="linenos"> 632</span></a><span class="sd">                - Prints debug information if verbose enabled</span>
</span><span id="Warehouse-633"><a href="#Warehouse-633"><span class="linenos"> 633</span></a><span class="sd">            </span>
</span><span id="Warehouse-634"><a href="#Warehouse-634"><span class="linenos"> 634</span></a><span class="sd">            Returns:</span>
</span><span id="Warehouse-635"><a href="#Warehouse-635"><span class="linenos"> 635</span></a><span class="sd">                None. Completes immediately after sending message.</span>
</span><span id="Warehouse-636"><a href="#Warehouse-636"><span class="linenos"> 636</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse-637"><a href="#Warehouse-637"><span class="linenos"> 637</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-638"><a href="#Warehouse-638"><span class="linenos"> 638</span></a>            
</span><span id="Warehouse-639"><a href="#Warehouse-639"><span class="linenos"> 639</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-640"><a href="#Warehouse-640"><span class="linenos"> 640</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="Warehouse-641"><a href="#Warehouse-641"><span class="linenos"> 641</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Rejected request from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">: &quot;</span>
</span><span id="Warehouse-642"><a href="#Warehouse-642"><span class="linenos"> 642</span></a>                    <span class="sa">f</span><span class="s2">&quot;id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse-643"><a href="#Warehouse-643"><span class="linenos"> 643</span></a>                    <span class="sa">f</span><span class="s2">&quot;quant=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse-644"><a href="#Warehouse-644"><span class="linenos"> 644</span></a>                    <span class="sa">f</span><span class="s2">&quot;product=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse-645"><a href="#Warehouse-645"><span class="linenos"> 645</span></a>                    <span class="sa">f</span><span class="s2">&quot;reason=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse-646"><a href="#Warehouse-646"><span class="linenos"> 646</span></a>                <span class="p">)</span>
</span><span id="Warehouse-647"><a href="#Warehouse-647"><span class="linenos"> 647</span></a>            
</span><span id="Warehouse-648"><a href="#Warehouse-648"><span class="linenos"> 648</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse-649"><a href="#Warehouse-649"><span class="linenos"> 649</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-reject&quot;</span><span class="p">)</span>
</span><span id="Warehouse-650"><a href="#Warehouse-650"><span class="linenos"> 650</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse-651"><a href="#Warehouse-651"><span class="linenos"> 651</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">))</span>
</span><span id="Warehouse-652"><a href="#Warehouse-652"><span class="linenos"> 652</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse-653"><a href="#Warehouse-653"><span class="linenos"> 653</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse-654"><a href="#Warehouse-654"><span class="linenos"> 654</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse-655"><a href="#Warehouse-655"><span class="linenos"> 655</span></a>            
</span><span id="Warehouse-656"><a href="#Warehouse-656"><span class="linenos"> 656</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-657"><a href="#Warehouse-657"><span class="linenos"> 657</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-658"><a href="#Warehouse-658"><span class="linenos"> 658</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; RejectBuyRequest sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>           
</span><span id="Warehouse-659"><a href="#Warehouse-659"><span class="linenos"> 659</span></a>    
</span><span id="Warehouse-660"><a href="#Warehouse-660"><span class="linenos"> 660</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveConfirmationOrDenial</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-661"><a href="#Warehouse-661"><span class="linenos"> 661</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-662"><a href="#Warehouse-662"><span class="linenos"> 662</span></a><span class="sd">        Behaviour that processes store&#39;s award or rejection decision (FIPA result notification).</span>
</span><span id="Warehouse-663"><a href="#Warehouse-663"><span class="linenos"> 663</span></a><span class="sd">        </span>
</span><span id="Warehouse-664"><a href="#Warehouse-664"><span class="linenos"> 664</span></a><span class="sd">        This behaviour implements the result notification reception in the FIPA Contract Net</span>
</span><span id="Warehouse-665"><a href="#Warehouse-665"><span class="linenos"> 665</span></a><span class="sd">        Protocol where the warehouse, acting as a participant, receives the store&#39;s final</span>
</span><span id="Warehouse-666"><a href="#Warehouse-666"><span class="linenos"> 666</span></a><span class="sd">        decision about whether its proposal was accepted or rejected.</span>
</span><span id="Warehouse-667"><a href="#Warehouse-667"><span class="linenos"> 667</span></a><span class="sd">        </span>
</span><span id="Warehouse-668"><a href="#Warehouse-668"><span class="linenos"> 668</span></a><span class="sd">        FIPA Protocol Phase: **Result Notification Reception - Participant Role**</span>
</span><span id="Warehouse-669"><a href="#Warehouse-669"><span class="linenos"> 669</span></a><span class="sd">            - Role: Participant (Warehouse receiving Store&#39;s decision)</span>
</span><span id="Warehouse-670"><a href="#Warehouse-670"><span class="linenos"> 670</span></a><span class="sd">            - Receives: store-confirm (FIPA accept-proposal) or store-deny (FIPA reject-proposal)</span>
</span><span id="Warehouse-671"><a href="#Warehouse-671"><span class="linenos"> 671</span></a><span class="sd">            - Actions:</span>
</span><span id="Warehouse-672"><a href="#Warehouse-672"><span class="linenos"> 672</span></a><span class="sd">                - If confirm: Transfer locked stock to pending deliveries, assign vehicle</span>
</span><span id="Warehouse-673"><a href="#Warehouse-673"><span class="linenos"> 673</span></a><span class="sd">                - If deny: Release locked stock back to available inventory</span>
</span><span id="Warehouse-674"><a href="#Warehouse-674"><span class="linenos"> 674</span></a><span class="sd">                - If timeout: Release locked stock (store chose another warehouse)</span>
</span><span id="Warehouse-675"><a href="#Warehouse-675"><span class="linenos"> 675</span></a><span class="sd">        </span>
</span><span id="Warehouse-676"><a href="#Warehouse-676"><span class="linenos"> 676</span></a><span class="sd">        Stock State Transitions:</span>
</span><span id="Warehouse-677"><a href="#Warehouse-677"><span class="linenos"> 677</span></a><span class="sd">        </span>
</span><span id="Warehouse-678"><a href="#Warehouse-678"><span class="linenos"> 678</span></a><span class="sd">            **On store-confirm (Award)**:</span>
</span><span id="Warehouse-679"><a href="#Warehouse-679"><span class="linenos"> 679</span></a><span class="sd">                1. locked_stock[product] -= quantity (release lock)</span>
</span><span id="Warehouse-680"><a href="#Warehouse-680"><span class="linenos"> 680</span></a><span class="sd">                2. current_capacity[product] += quantity (update capacity tracking)</span>
</span><span id="Warehouse-681"><a href="#Warehouse-681"><span class="linenos"> 681</span></a><span class="sd">                3. Create Order object from message</span>
</span><span id="Warehouse-682"><a href="#Warehouse-682"><span class="linenos"> 682</span></a><span class="sd">                4. pending_deliveries[order_id] = order (await vehicle pickup)</span>
</span><span id="Warehouse-683"><a href="#Warehouse-683"><span class="linenos"> 683</span></a><span class="sd">                5. Launch AssignVehicle behaviour</span>
</span><span id="Warehouse-684"><a href="#Warehouse-684"><span class="linenos"> 684</span></a><span class="sd">            </span>
</span><span id="Warehouse-685"><a href="#Warehouse-685"><span class="linenos"> 685</span></a><span class="sd">            **On store-deny or timeout (Rejection/Timeout)**:</span>
</span><span id="Warehouse-686"><a href="#Warehouse-686"><span class="linenos"> 686</span></a><span class="sd">                1. locked_stock[product] -= quantity (release lock)</span>
</span><span id="Warehouse-687"><a href="#Warehouse-687"><span class="linenos"> 687</span></a><span class="sd">                2. stock[product] += quantity (return to available)</span>
</span><span id="Warehouse-688"><a href="#Warehouse-688"><span class="linenos"> 688</span></a><span class="sd">                3. No further action needed</span>
</span><span id="Warehouse-689"><a href="#Warehouse-689"><span class="linenos"> 689</span></a><span class="sd">        </span>
</span><span id="Warehouse-690"><a href="#Warehouse-690"><span class="linenos"> 690</span></a><span class="sd">        Attributes:</span>
</span><span id="Warehouse-691"><a href="#Warehouse-691"><span class="linenos"> 691</span></a><span class="sd">            accepted_id (int): Request ID for which we sent proposal.</span>
</span><span id="Warehouse-692"><a href="#Warehouse-692"><span class="linenos"> 692</span></a><span class="sd">            accepted_quantity (int): Quantity that was proposed.</span>
</span><span id="Warehouse-693"><a href="#Warehouse-693"><span class="linenos"> 693</span></a><span class="sd">            accepted_product (str): Product that was proposed.</span>
</span><span id="Warehouse-694"><a href="#Warehouse-694"><span class="linenos"> 694</span></a><span class="sd">            sender_jid (str): Store JID that will send decision.</span>
</span><span id="Warehouse-695"><a href="#Warehouse-695"><span class="linenos"> 695</span></a><span class="sd">        </span>
</span><span id="Warehouse-696"><a href="#Warehouse-696"><span class="linenos"> 696</span></a><span class="sd">        Timeout Mechanism:</span>
</span><span id="Warehouse-697"><a href="#Warehouse-697"><span class="linenos"> 697</span></a><span class="sd">            - Wait time: 10 seconds</span>
</span><span id="Warehouse-698"><a href="#Warehouse-698"><span class="linenos"> 698</span></a><span class="sd">            - Interpretation: Store chose another warehouse (implicit rejection)</span>
</span><span id="Warehouse-699"><a href="#Warehouse-699"><span class="linenos"> 699</span></a><span class="sd">            - Action: Unlock stock automatically</span>
</span><span id="Warehouse-700"><a href="#Warehouse-700"><span class="linenos"> 700</span></a><span class="sd">        </span>
</span><span id="Warehouse-701"><a href="#Warehouse-701"><span class="linenos"> 701</span></a><span class="sd">        Example Execution:</span>
</span><span id="Warehouse-702"><a href="#Warehouse-702"><span class="linenos"> 702</span></a><span class="sd">        </span>
</span><span id="Warehouse-703"><a href="#Warehouse-703"><span class="linenos"> 703</span></a><span class="sd">            **Scenario 1: Store Confirms**</span>
</span><span id="Warehouse-704"><a href="#Warehouse-704"><span class="linenos"> 704</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-705"><a href="#Warehouse-705"><span class="linenos"> 705</span></a><span class="sd">            Proposed: 50 electronics</span>
</span><span id="Warehouse-706"><a href="#Warehouse-706"><span class="linenos"> 706</span></a><span class="sd">            Message Received: store-confirm &quot;50 electronics&quot;</span>
</span><span id="Warehouse-707"><a href="#Warehouse-707"><span class="linenos"> 707</span></a><span class="sd">            Actions:</span>
</span><span id="Warehouse-708"><a href="#Warehouse-708"><span class="linenos"> 708</span></a><span class="sd">                - locked_stock[electronics]: 50 -&gt; 0</span>
</span><span id="Warehouse-709"><a href="#Warehouse-709"><span class="linenos"> 709</span></a><span class="sd">                - pending_deliveries[1001000000] = Order(...)</span>
</span><span id="Warehouse-710"><a href="#Warehouse-710"><span class="linenos"> 710</span></a><span class="sd">                - Launch AssignVehicle(1001000000)</span>
</span><span id="Warehouse-711"><a href="#Warehouse-711"><span class="linenos"> 711</span></a><span class="sd">                - Print: &quot;Order 1001000000 confirmed...&quot;</span>
</span><span id="Warehouse-712"><a href="#Warehouse-712"><span class="linenos"> 712</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-713"><a href="#Warehouse-713"><span class="linenos"> 713</span></a><span class="sd">            </span>
</span><span id="Warehouse-714"><a href="#Warehouse-714"><span class="linenos"> 714</span></a><span class="sd">            **Scenario 2: Store Denies**</span>
</span><span id="Warehouse-715"><a href="#Warehouse-715"><span class="linenos"> 715</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-716"><a href="#Warehouse-716"><span class="linenos"> 716</span></a><span class="sd">            Proposed: 50 electronics</span>
</span><span id="Warehouse-717"><a href="#Warehouse-717"><span class="linenos"> 717</span></a><span class="sd">            Message Received: store-deny &quot;50 electronics&quot;</span>
</span><span id="Warehouse-718"><a href="#Warehouse-718"><span class="linenos"> 718</span></a><span class="sd">            Actions:</span>
</span><span id="Warehouse-719"><a href="#Warehouse-719"><span class="linenos"> 719</span></a><span class="sd">                - locked_stock[electronics]: 50 -&gt; 0</span>
</span><span id="Warehouse-720"><a href="#Warehouse-720"><span class="linenos"> 720</span></a><span class="sd">                - stock[electronics]: 50 -&gt; 100</span>
</span><span id="Warehouse-721"><a href="#Warehouse-721"><span class="linenos"> 721</span></a><span class="sd">                - Print: &quot;Store chose another warehouse&quot;</span>
</span><span id="Warehouse-722"><a href="#Warehouse-722"><span class="linenos"> 722</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-723"><a href="#Warehouse-723"><span class="linenos"> 723</span></a><span class="sd">            </span>
</span><span id="Warehouse-724"><a href="#Warehouse-724"><span class="linenos"> 724</span></a><span class="sd">            **Scenario 3: Timeout**</span>
</span><span id="Warehouse-725"><a href="#Warehouse-725"><span class="linenos"> 725</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-726"><a href="#Warehouse-726"><span class="linenos"> 726</span></a><span class="sd">            Proposed: 50 electronics</span>
</span><span id="Warehouse-727"><a href="#Warehouse-727"><span class="linenos"> 727</span></a><span class="sd">            Message Received: None (10 second timeout)</span>
</span><span id="Warehouse-728"><a href="#Warehouse-728"><span class="linenos"> 728</span></a><span class="sd">            Actions:</span>
</span><span id="Warehouse-729"><a href="#Warehouse-729"><span class="linenos"> 729</span></a><span class="sd">                - locked_stock[electronics]: 50 -&gt; 0</span>
</span><span id="Warehouse-730"><a href="#Warehouse-730"><span class="linenos"> 730</span></a><span class="sd">                - stock[electronics]: 50 -&gt; 100</span>
</span><span id="Warehouse-731"><a href="#Warehouse-731"><span class="linenos"> 731</span></a><span class="sd">                - Print: &quot;No confirmation received, unlocking stock&quot;</span>
</span><span id="Warehouse-732"><a href="#Warehouse-732"><span class="linenos"> 732</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-733"><a href="#Warehouse-733"><span class="linenos"> 733</span></a><span class="sd">        </span>
</span><span id="Warehouse-734"><a href="#Warehouse-734"><span class="linenos"> 734</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse-735"><a href="#Warehouse-735"><span class="linenos"> 735</span></a><span class="sd">            This behaviour is automatically filtered by template to only receive</span>
</span><span id="Warehouse-736"><a href="#Warehouse-736"><span class="linenos"> 736</span></a><span class="sd">            messages for the specific warehouse, store, and request_id combination.</span>
</span><span id="Warehouse-737"><a href="#Warehouse-737"><span class="linenos"> 737</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-738"><a href="#Warehouse-738"><span class="linenos"> 738</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">sender_jid</span><span class="p">):</span>
</span><span id="Warehouse-739"><a href="#Warehouse-739"><span class="linenos"> 739</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-740"><a href="#Warehouse-740"><span class="linenos"> 740</span></a><span class="sd">            Initialize the ReceiveConfirmationOrDenial behaviour.</span>
</span><span id="Warehouse-741"><a href="#Warehouse-741"><span class="linenos"> 741</span></a><span class="sd">            </span>
</span><span id="Warehouse-742"><a href="#Warehouse-742"><span class="linenos"> 742</span></a><span class="sd">            Args:</span>
</span><span id="Warehouse-743"><a href="#Warehouse-743"><span class="linenos"> 743</span></a><span class="sd">                accept_msg (Message): The warehouse-accept message we sent.</span>
</span><span id="Warehouse-744"><a href="#Warehouse-744"><span class="linenos"> 744</span></a><span class="sd">                    Used to extract proposal details for stock unlocking if needed.</span>
</span><span id="Warehouse-745"><a href="#Warehouse-745"><span class="linenos"> 745</span></a><span class="sd">                sender_jid (str): JID of the store that will send the decision.</span>
</span><span id="Warehouse-746"><a href="#Warehouse-746"><span class="linenos"> 746</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse-747"><a href="#Warehouse-747"><span class="linenos"> 747</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse-748"><a href="#Warehouse-748"><span class="linenos"> 748</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accepted_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">accept_msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse-749"><a href="#Warehouse-749"><span class="linenos"> 749</span></a>            <span class="n">bod</span> <span class="o">=</span> <span class="n">accept_msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse-750"><a href="#Warehouse-750"><span class="linenos"> 750</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accepted_quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bod</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse-751"><a href="#Warehouse-751"><span class="linenos"> 751</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accepted_product</span> <span class="o">=</span> <span class="n">bod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse-752"><a href="#Warehouse-752"><span class="linenos"> 752</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sender_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sender_jid</span><span class="p">)</span>
</span><span id="Warehouse-753"><a href="#Warehouse-753"><span class="linenos"> 753</span></a>        
</span><span id="Warehouse-754"><a href="#Warehouse-754"><span class="linenos"> 754</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-755"><a href="#Warehouse-755"><span class="linenos"> 755</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-756"><a href="#Warehouse-756"><span class="linenos"> 756</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Waiting for store confirmation or denial...&quot;</span><span class="p">)</span>
</span><span id="Warehouse-757"><a href="#Warehouse-757"><span class="linenos"> 757</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="Warehouse-758"><a href="#Warehouse-758"><span class="linenos"> 758</span></a>            
</span><span id="Warehouse-759"><a href="#Warehouse-759"><span class="linenos"> 759</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Warehouse-760"><a href="#Warehouse-760"><span class="linenos"> 760</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span>
</span><span id="Warehouse-761"><a href="#Warehouse-761"><span class="linenos"> 761</span></a>                <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Warehouse-762"><a href="#Warehouse-762"><span class="linenos"> 762</span></a>                
</span><span id="Warehouse-763"><a href="#Warehouse-763"><span class="linenos"> 763</span></a>                <span class="c1"># Message with body format &quot;quantity product&quot;</span>
</span><span id="Warehouse-764"><a href="#Warehouse-764"><span class="linenos"> 764</span></a>                <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse-765"><a href="#Warehouse-765"><span class="linenos"> 765</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse-766"><a href="#Warehouse-766"><span class="linenos"> 766</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse-767"><a href="#Warehouse-767"><span class="linenos"> 767</span></a>                
</span><span id="Warehouse-768"><a href="#Warehouse-768"><span class="linenos"> 768</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;store-confirm&quot;</span><span class="p">:</span>
</span><span id="Warehouse-769"><a href="#Warehouse-769"><span class="linenos"> 769</span></a>                    <span class="c1"># Store confirmed - update locked stock and add to pending orders</span>
</span><span id="Warehouse-770"><a href="#Warehouse-770"><span class="linenos"> 770</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quantity</span>
</span><span id="Warehouse-771"><a href="#Warehouse-771"><span class="linenos"> 771</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">current_capacity</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="Warehouse-772"><a href="#Warehouse-772"><span class="linenos"> 772</span></a>                    
</span><span id="Warehouse-773"><a href="#Warehouse-773"><span class="linenos"> 773</span></a>                    <span class="c1"># Create Order object from message</span>
</span><span id="Warehouse-774"><a href="#Warehouse-774"><span class="linenos"> 774</span></a>                    <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">message_to_order</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-775"><a href="#Warehouse-775"><span class="linenos"> 775</span></a>                    
</span><span id="Warehouse-776"><a href="#Warehouse-776"><span class="linenos"> 776</span></a>                    <span class="c1"># Add to pending_deliveries dict with order_id as key</span>
</span><span id="Warehouse-777"><a href="#Warehouse-777"><span class="linenos"> 777</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
</span><span id="Warehouse-778"><a href="#Warehouse-778"><span class="linenos"> 778</span></a>                            
</span><span id="Warehouse-779"><a href="#Warehouse-779"><span class="linenos"> 779</span></a>                    <span class="c1"># Essential print - order confirmed</span>
</span><span id="Warehouse-780"><a href="#Warehouse-780"><span class="linenos"> 780</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2"> confirmed: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> x</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-781"><a href="#Warehouse-781"><span class="linenos"> 781</span></a>                    
</span><span id="Warehouse-782"><a href="#Warehouse-782"><span class="linenos"> 782</span></a>                    <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">AssignVehicle</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">)</span>
</span><span id="Warehouse-783"><a href="#Warehouse-783"><span class="linenos"> 783</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Warehouse-784"><a href="#Warehouse-784"><span class="linenos"> 784</span></a>
</span><span id="Warehouse-785"><a href="#Warehouse-785"><span class="linenos"> 785</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-786"><a href="#Warehouse-786"><span class="linenos"> 786</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="Warehouse-787"><a href="#Warehouse-787"><span class="linenos"> 787</span></a>                    
</span><span id="Warehouse-788"><a href="#Warehouse-788"><span class="linenos"> 788</span></a>                <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;store-deny&quot;</span><span class="p">:</span>
</span><span id="Warehouse-789"><a href="#Warehouse-789"><span class="linenos"> 789</span></a>                    <span class="c1"># Store denied (chose another warehouse) - unlock the stock</span>
</span><span id="Warehouse-790"><a href="#Warehouse-790"><span class="linenos"> 790</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-791"><a href="#Warehouse-791"><span class="linenos"> 791</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Denial received! Store chose another warehouse.&quot;</span><span class="p">)</span>
</span><span id="Warehouse-792"><a href="#Warehouse-792"><span class="linenos"> 792</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Unlocking stock: </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> += </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-793"><a href="#Warehouse-793"><span class="linenos"> 793</span></a>                    
</span><span id="Warehouse-794"><a href="#Warehouse-794"><span class="linenos"> 794</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quantity</span>
</span><span id="Warehouse-795"><a href="#Warehouse-795"><span class="linenos"> 795</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="Warehouse-796"><a href="#Warehouse-796"><span class="linenos"> 796</span></a>                    
</span><span id="Warehouse-797"><a href="#Warehouse-797"><span class="linenos"> 797</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-798"><a href="#Warehouse-798"><span class="linenos"> 798</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="Warehouse-799"><a href="#Warehouse-799"><span class="linenos"> 799</span></a>                    
</span><span id="Warehouse-800"><a href="#Warehouse-800"><span class="linenos"> 800</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-801"><a href="#Warehouse-801"><span class="linenos"> 801</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-802"><a href="#Warehouse-802"><span class="linenos"> 802</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Timeout: No confirmation or denial received in 10 seconds. Unlocking stock...&quot;</span><span class="p">)</span>
</span><span id="Warehouse-803"><a href="#Warehouse-803"><span class="linenos"> 803</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">accepted_product</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted_quantity</span>
</span><span id="Warehouse-804"><a href="#Warehouse-804"><span class="linenos"> 804</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">accepted_product</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted_quantity</span>
</span><span id="Warehouse-805"><a href="#Warehouse-805"><span class="linenos"> 805</span></a>                
</span><span id="Warehouse-806"><a href="#Warehouse-806"><span class="linenos"> 806</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-807"><a href="#Warehouse-807"><span class="linenos"> 807</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>            
</span><span id="Warehouse-808"><a href="#Warehouse-808"><span class="linenos"> 808</span></a>    
</span><span id="Warehouse-809"><a href="#Warehouse-809"><span class="linenos"> 809</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">AssignVehicle</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-810"><a href="#Warehouse-810"><span class="linenos"> 810</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
</span><span id="Warehouse-811"><a href="#Warehouse-811"><span class="linenos"> 811</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse-812"><a href="#Warehouse-812"><span class="linenos"> 812</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Warehouse-813"><a href="#Warehouse-813"><span class="linenos"> 813</span></a>        
</span><span id="Warehouse-814"><a href="#Warehouse-814"><span class="linenos"> 814</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">populate_vehicles_from_contacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-815"><a href="#Warehouse-815"><span class="linenos"> 815</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Populate vehicles list from presence contacts if empty&quot;&quot;&quot;</span>
</span><span id="Warehouse-816"><a href="#Warehouse-816"><span class="linenos"> 816</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-817"><a href="#Warehouse-817"><span class="linenos"> 817</span></a>            
</span><span id="Warehouse-818"><a href="#Warehouse-818"><span class="linenos"> 818</span></a>            <span class="c1"># Get all vehicles from presence contacts</span>
</span><span id="Warehouse-819"><a href="#Warehouse-819"><span class="linenos"> 819</span></a>            <span class="n">vehicles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;vehicle&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
</span><span id="Warehouse-820"><a href="#Warehouse-820"><span class="linenos"> 820</span></a>            
</span><span id="Warehouse-821"><a href="#Warehouse-821"><span class="linenos"> 821</span></a>            <span class="k">if</span> <span class="n">vehicles</span><span class="p">:</span>
</span><span id="Warehouse-822"><a href="#Warehouse-822"><span class="linenos"> 822</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="n">vehicles</span>
</span><span id="Warehouse-823"><a href="#Warehouse-823"><span class="linenos"> 823</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-824"><a href="#Warehouse-824"><span class="linenos"> 824</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Discovered </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span><span class="si">}</span><span class="s2"> vehicle(s) from presence: </span><span class="si">{</span><span class="n">vehicles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-825"><a href="#Warehouse-825"><span class="linenos"> 825</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-826"><a href="#Warehouse-826"><span class="linenos"> 826</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-827"><a href="#Warehouse-827"><span class="linenos"> 827</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  No vehicles found in presence contacts yet!&quot;</span><span class="p">)</span>
</span><span id="Warehouse-828"><a href="#Warehouse-828"><span class="linenos"> 828</span></a>            
</span><span id="Warehouse-829"><a href="#Warehouse-829"><span class="linenos"> 829</span></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="Warehouse-830"><a href="#Warehouse-830"><span class="linenos"> 830</span></a>        
</span><span id="Warehouse-831"><a href="#Warehouse-831"><span class="linenos"> 831</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">create_presence_info_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
</span><span id="Warehouse-832"><a href="#Warehouse-832"><span class="linenos"> 832</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span>
</span><span id="Warehouse-833"><a href="#Warehouse-833"><span class="linenos"> 833</span></a>            
</span><span id="Warehouse-834"><a href="#Warehouse-834"><span class="linenos"> 834</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">)</span>
</span><span id="Warehouse-835"><a href="#Warehouse-835"><span class="linenos"> 835</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;presence-info&quot;</span><span class="p">)</span>
</span><span id="Warehouse-836"><a href="#Warehouse-836"><span class="linenos"> 836</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Warehouse-837"><a href="#Warehouse-837"><span class="linenos"> 837</span></a>            <span class="k">return</span> <span class="n">msg</span>
</span><span id="Warehouse-838"><a href="#Warehouse-838"><span class="linenos"> 838</span></a>            
</span><span id="Warehouse-839"><a href="#Warehouse-839"><span class="linenos"> 839</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">create_call_for_proposal_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
</span><span id="Warehouse-840"><a href="#Warehouse-840"><span class="linenos"> 840</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span>
</span><span id="Warehouse-841"><a href="#Warehouse-841"><span class="linenos"> 841</span></a>            
</span><span id="Warehouse-842"><a href="#Warehouse-842"><span class="linenos"> 842</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">)</span>
</span><span id="Warehouse-843"><a href="#Warehouse-843"><span class="linenos"> 843</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;order-proposal&quot;</span><span class="p">)</span>
</span><span id="Warehouse-844"><a href="#Warehouse-844"><span class="linenos"> 844</span></a>            
</span><span id="Warehouse-845"><a href="#Warehouse-845"><span class="linenos"> 845</span></a>            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">]</span>
</span><span id="Warehouse-846"><a href="#Warehouse-846"><span class="linenos"> 846</span></a>
</span><span id="Warehouse-847"><a href="#Warehouse-847"><span class="linenos"> 847</span></a>            <span class="n">new_body</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Warehouse-848"><a href="#Warehouse-848"><span class="linenos"> 848</span></a>                <span class="s2">&quot;orderid&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span id="Warehouse-849"><a href="#Warehouse-849"><span class="linenos"> 849</span></a>                <span class="s2">&quot;product&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="p">,</span>
</span><span id="Warehouse-850"><a href="#Warehouse-850"><span class="linenos"> 850</span></a>                <span class="s2">&quot;quantity&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="Warehouse-851"><a href="#Warehouse-851"><span class="linenos"> 851</span></a>                <span class="s2">&quot;sender&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">receiver</span><span class="p">,</span>
</span><span id="Warehouse-852"><a href="#Warehouse-852"><span class="linenos"> 852</span></a>                <span class="s2">&quot;receiver&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span>
</span><span id="Warehouse-853"><a href="#Warehouse-853"><span class="linenos"> 853</span></a>                <span class="s2">&quot;sender_location&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span><span class="p">,</span>
</span><span id="Warehouse-854"><a href="#Warehouse-854"><span class="linenos"> 854</span></a>                <span class="s2">&quot;receiver_location&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span>
</span><span id="Warehouse-855"><a href="#Warehouse-855"><span class="linenos"> 855</span></a>            <span class="p">}</span>
</span><span id="Warehouse-856"><a href="#Warehouse-856"><span class="linenos"> 856</span></a>            
</span><span id="Warehouse-857"><a href="#Warehouse-857"><span class="linenos"> 857</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_body</span><span class="p">)</span>
</span><span id="Warehouse-858"><a href="#Warehouse-858"><span class="linenos"> 858</span></a>            <span class="k">return</span> <span class="n">msg</span>
</span><span id="Warehouse-859"><a href="#Warehouse-859"><span class="linenos"> 859</span></a>        
</span><span id="Warehouse-860"><a href="#Warehouse-860"><span class="linenos"> 860</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-861"><a href="#Warehouse-861"><span class="linenos"> 861</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-862"><a href="#Warehouse-862"><span class="linenos"> 862</span></a>            
</span><span id="Warehouse-863"><a href="#Warehouse-863"><span class="linenos"> 863</span></a>            <span class="c1"># Populate vehicles from contacts</span>
</span><span id="Warehouse-864"><a href="#Warehouse-864"><span class="linenos"> 864</span></a>            <span class="n">has_vehicles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populate_vehicles_from_contacts</span><span class="p">()</span>
</span><span id="Warehouse-865"><a href="#Warehouse-865"><span class="linenos"> 865</span></a>            
</span><span id="Warehouse-866"><a href="#Warehouse-866"><span class="linenos"> 866</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_vehicles</span><span class="p">:</span>
</span><span id="Warehouse-867"><a href="#Warehouse-867"><span class="linenos"> 867</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  ERROR: No vehicles found in contacts!&quot;</span><span class="p">)</span>
</span><span id="Warehouse-868"><a href="#Warehouse-868"><span class="linenos"> 868</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Make sure vehicles are started and have subscribed to this supplier.&quot;</span><span class="p">)</span>
</span><span id="Warehouse-869"><a href="#Warehouse-869"><span class="linenos"> 869</span></a>                <span class="k">return</span>
</span><span id="Warehouse-870"><a href="#Warehouse-870"><span class="linenos"> 870</span></a>            
</span><span id="Warehouse-871"><a href="#Warehouse-871"><span class="linenos"> 871</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-872"><a href="#Warehouse-872"><span class="linenos"> 872</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Requesting vehicle proposals...&quot;</span><span class="p">)</span>
</span><span id="Warehouse-873"><a href="#Warehouse-873"><span class="linenos"> 873</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicles to contact: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">vehicles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-874"><a href="#Warehouse-874"><span class="linenos"> 874</span></a>            
</span><span id="Warehouse-875"><a href="#Warehouse-875"><span class="linenos"> 875</span></a>            <span class="c1"># Enviar mensagens de proposal a todos os veculos</span>
</span><span id="Warehouse-876"><a href="#Warehouse-876"><span class="linenos"> 876</span></a>            <span class="c1"># No verificamos presena - deixamos cada veculo decidir se pode aceitar</span>
</span><span id="Warehouse-877"><a href="#Warehouse-877"><span class="linenos"> 877</span></a>            <span class="n">n_available_vehicles</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Warehouse-878"><a href="#Warehouse-878"><span class="linenos"> 878</span></a>            <span class="n">n_sent_messages</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Warehouse-879"><a href="#Warehouse-879"><span class="linenos"> 879</span></a>            <span class="n">away_vehicles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Warehouse-880"><a href="#Warehouse-880"><span class="linenos"> 880</span></a>            <span class="k">for</span> <span class="n">vehicle_jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicles</span><span class="p">:</span>
</span><span id="Warehouse-881"><a href="#Warehouse-881"><span class="linenos"> 881</span></a>                
</span><span id="Warehouse-882"><a href="#Warehouse-882"><span class="linenos"> 882</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_presence_info_message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse-883"><a href="#Warehouse-883"><span class="linenos"> 883</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-884"><a href="#Warehouse-884"><span class="linenos"> 884</span></a>                
</span><span id="Warehouse-885"><a href="#Warehouse-885"><span class="linenos"> 885</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">ReceivePresenceInfo</span><span class="p">()</span>
</span><span id="Warehouse-886"><a href="#Warehouse-886"><span class="linenos"> 886</span></a>                <span class="n">temp</span> <span class="p">:</span> <span class="n">Template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse-887"><a href="#Warehouse-887"><span class="linenos"> 887</span></a>                <span class="n">temp</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;presence-response&quot;</span><span class="p">)</span>
</span><span id="Warehouse-888"><a href="#Warehouse-888"><span class="linenos"> 888</span></a>                <span class="n">temp</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;vehicle_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle_jid</span><span class="p">))</span>
</span><span id="Warehouse-889"><a href="#Warehouse-889"><span class="linenos"> 889</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
</span><span id="Warehouse-890"><a href="#Warehouse-890"><span class="linenos"> 890</span></a>                
</span><span id="Warehouse-891"><a href="#Warehouse-891"><span class="linenos"> 891</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse-892"><a href="#Warehouse-892"><span class="linenos"> 892</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-893"><a href="#Warehouse-893"><span class="linenos"> 893</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Presence info from </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-894"><a href="#Warehouse-894"><span class="linenos"> 894</span></a>                
</span><span id="Warehouse-895"><a href="#Warehouse-895"><span class="linenos"> 895</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="p">[</span><span class="n">vehicle_jid</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PresenceShow.CHAT&quot;</span><span class="p">:</span>
</span><span id="Warehouse-896"><a href="#Warehouse-896"><span class="linenos"> 896</span></a>                    <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_call_for_proposal_message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse-897"><a href="#Warehouse-897"><span class="linenos"> 897</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-898"><a href="#Warehouse-898"><span class="linenos"> 898</span></a>                    <span class="n">n_available_vehicles</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse-899"><a href="#Warehouse-899"><span class="linenos"> 899</span></a>                    <span class="n">n_sent_messages</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse-900"><a href="#Warehouse-900"><span class="linenos"> 900</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Sent order proposal to </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-901"><a href="#Warehouse-901"><span class="linenos"> 901</span></a>                
</span><span id="Warehouse-902"><a href="#Warehouse-902"><span class="linenos"> 902</span></a>                <span class="k">elif</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="p">[</span><span class="n">vehicle_jid</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PresenceShow.AWAY&quot;</span> <span class="ow">and</span> <span class="n">n_available_vehicles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Warehouse-903"><a href="#Warehouse-903"><span class="linenos"> 903</span></a>                    <span class="n">away_vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse-904"><a href="#Warehouse-904"><span class="linenos"> 904</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-905"><a href="#Warehouse-905"><span class="linenos"> 905</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Vehicle </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2"> is away.&quot;</span><span class="p">)</span>
</span><span id="Warehouse-906"><a href="#Warehouse-906"><span class="linenos"> 906</span></a>                    
</span><span id="Warehouse-907"><a href="#Warehouse-907"><span class="linenos"> 907</span></a>            <span class="k">if</span> <span class="n">n_available_vehicles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Warehouse-908"><a href="#Warehouse-908"><span class="linenos"> 908</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-909"><a href="#Warehouse-909"><span class="linenos"> 909</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  No AVAILABLE vehicles found. All vehicles are AWAY.&quot;</span><span class="p">)</span>
</span><span id="Warehouse-910"><a href="#Warehouse-910"><span class="linenos"> 910</span></a>                <span class="k">for</span> <span class="n">vehicle_jid</span> <span class="ow">in</span> <span class="n">away_vehicles</span><span class="p">:</span>
</span><span id="Warehouse-911"><a href="#Warehouse-911"><span class="linenos"> 911</span></a>                    <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_call_for_proposal_message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse-912"><a href="#Warehouse-912"><span class="linenos"> 912</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-913"><a href="#Warehouse-913"><span class="linenos"> 913</span></a>                    
</span><span id="Warehouse-914"><a href="#Warehouse-914"><span class="linenos"> 914</span></a>                    <span class="n">n_sent_messages</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse-915"><a href="#Warehouse-915"><span class="linenos"> 915</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Sent order proposal to </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-916"><a href="#Warehouse-916"><span class="linenos"> 916</span></a>            
</span><span id="Warehouse-917"><a href="#Warehouse-917"><span class="linenos"> 917</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-918"><a href="#Warehouse-918"><span class="linenos"> 918</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Sent proposals to </span><span class="si">{</span><span class="n">n_sent_messages</span><span class="si">}</span><span class="s2"> vehicle(s)&quot;</span><span class="p">)</span>
</span><span id="Warehouse-919"><a href="#Warehouse-919"><span class="linenos"> 919</span></a>                    
</span><span id="Warehouse-920"><a href="#Warehouse-920"><span class="linenos"> 920</span></a>            <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">ChooseBestVehicle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span> <span class="n">n_sent_messages</span><span class="p">)</span>
</span><span id="Warehouse-921"><a href="#Warehouse-921"><span class="linenos"> 921</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
</span><span id="Warehouse-922"><a href="#Warehouse-922"><span class="linenos"> 922</span></a>            
</span><span id="Warehouse-923"><a href="#Warehouse-923"><span class="linenos"> 923</span></a>            <span class="c1"># Waits for all vehicle proposals to be received</span>
</span><span id="Warehouse-924"><a href="#Warehouse-924"><span class="linenos"> 924</span></a>            <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse-925"><a href="#Warehouse-925"><span class="linenos"> 925</span></a>    
</span><span id="Warehouse-926"><a href="#Warehouse-926"><span class="linenos"> 926</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceivePresenceInfo</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-927"><a href="#Warehouse-927"><span class="linenos"> 927</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-928"><a href="#Warehouse-928"><span class="linenos"> 928</span></a><span class="sd">        Behaviour to receive presence information from vehicle agents.</span>
</span><span id="Warehouse-929"><a href="#Warehouse-929"><span class="linenos"> 929</span></a><span class="sd">        </span>
</span><span id="Warehouse-930"><a href="#Warehouse-930"><span class="linenos"> 930</span></a><span class="sd">        This behaviour requests and collects availability status from vehicle agents,</span>
</span><span id="Warehouse-931"><a href="#Warehouse-931"><span class="linenos"> 931</span></a><span class="sd">        which is used to determine which vehicles are available for delivery tasks.</span>
</span><span id="Warehouse-932"><a href="#Warehouse-932"><span class="linenos"> 932</span></a><span class="sd">        The presence information indicates whether a vehicle is busy, available, or</span>
</span><span id="Warehouse-933"><a href="#Warehouse-933"><span class="linenos"> 933</span></a><span class="sd">        in another state.</span>
</span><span id="Warehouse-934"><a href="#Warehouse-934"><span class="linenos"> 934</span></a><span class="sd">        </span>
</span><span id="Warehouse-935"><a href="#Warehouse-935"><span class="linenos"> 935</span></a><span class="sd">        The behaviour waits for a single response from a vehicle agent containing</span>
</span><span id="Warehouse-936"><a href="#Warehouse-936"><span class="linenos"> 936</span></a><span class="sd">        its current presence status. This information is stored in the warehouse&#39;s</span>
</span><span id="Warehouse-937"><a href="#Warehouse-937"><span class="linenos"> 937</span></a><span class="sd">        presence_infos dictionary for later use in vehicle selection.</span>
</span><span id="Warehouse-938"><a href="#Warehouse-938"><span class="linenos"> 938</span></a><span class="sd">        </span>
</span><span id="Warehouse-939"><a href="#Warehouse-939"><span class="linenos"> 939</span></a><span class="sd">        Workflow:</span>
</span><span id="Warehouse-940"><a href="#Warehouse-940"><span class="linenos"> 940</span></a><span class="sd">            1. **Receive Message**: Wait up to 10 seconds for presence response</span>
</span><span id="Warehouse-941"><a href="#Warehouse-941"><span class="linenos"> 941</span></a><span class="sd">            2. **Parse JSON**: Extract presence_show status from message body</span>
</span><span id="Warehouse-942"><a href="#Warehouse-942"><span class="linenos"> 942</span></a><span class="sd">            3. **Store Information**: Save presence info indexed by vehicle_id</span>
</span><span id="Warehouse-943"><a href="#Warehouse-943"><span class="linenos"> 943</span></a><span class="sd">            4. **Handle Timeout**: Print warning if no response received</span>
</span><span id="Warehouse-944"><a href="#Warehouse-944"><span class="linenos"> 944</span></a><span class="sd">        </span>
</span><span id="Warehouse-945"><a href="#Warehouse-945"><span class="linenos"> 945</span></a><span class="sd">        Side Effects:</span>
</span><span id="Warehouse-946"><a href="#Warehouse-946"><span class="linenos"> 946</span></a><span class="sd">            - Updates agent.presence_infos dictionary with vehicle status</span>
</span><span id="Warehouse-947"><a href="#Warehouse-947"><span class="linenos"> 947</span></a><span class="sd">            - Prints presence information if verbose mode enabled</span>
</span><span id="Warehouse-948"><a href="#Warehouse-948"><span class="linenos"> 948</span></a><span class="sd">        </span>
</span><span id="Warehouse-949"><a href="#Warehouse-949"><span class="linenos"> 949</span></a><span class="sd">        Returns:</span>
</span><span id="Warehouse-950"><a href="#Warehouse-950"><span class="linenos"> 950</span></a><span class="sd">            None. Completes after receiving one presence message or timing out.</span>
</span><span id="Warehouse-951"><a href="#Warehouse-951"><span class="linenos"> 951</span></a><span class="sd">        </span>
</span><span id="Warehouse-952"><a href="#Warehouse-952"><span class="linenos"> 952</span></a><span class="sd">        Example:</span>
</span><span id="Warehouse-953"><a href="#Warehouse-953"><span class="linenos"> 953</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-954"><a href="#Warehouse-954"><span class="linenos"> 954</span></a><span class="sd">            Message Received:</span>
</span><span id="Warehouse-955"><a href="#Warehouse-955"><span class="linenos"> 955</span></a><span class="sd">                Metadata: vehicle_id = &quot;vehicle1@localhost&quot;</span>
</span><span id="Warehouse-956"><a href="#Warehouse-956"><span class="linenos"> 956</span></a><span class="sd">                Body: {&quot;presence_show&quot;: &quot;available&quot;}</span>
</span><span id="Warehouse-957"><a href="#Warehouse-957"><span class="linenos"> 957</span></a><span class="sd">            Processing:</span>
</span><span id="Warehouse-958"><a href="#Warehouse-958"><span class="linenos"> 958</span></a><span class="sd">                - presence_infos[&quot;vehicle1@localhost&quot;] = &quot;available&quot;</span>
</span><span id="Warehouse-959"><a href="#Warehouse-959"><span class="linenos"> 959</span></a><span class="sd">            Output:</span>
</span><span id="Warehouse-960"><a href="#Warehouse-960"><span class="linenos"> 960</span></a><span class="sd">                - Print: &quot;Received presence info response from vehicle1: available&quot;</span>
</span><span id="Warehouse-961"><a href="#Warehouse-961"><span class="linenos"> 961</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-962"><a href="#Warehouse-962"><span class="linenos"> 962</span></a><span class="sd">        </span>
</span><span id="Warehouse-963"><a href="#Warehouse-963"><span class="linenos"> 963</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse-964"><a href="#Warehouse-964"><span class="linenos"> 964</span></a><span class="sd">            The 10-second timeout prevents indefinite blocking if a vehicle agent</span>
</span><span id="Warehouse-965"><a href="#Warehouse-965"><span class="linenos"> 965</span></a><span class="sd">            is offline or unresponsive.</span>
</span><span id="Warehouse-966"><a href="#Warehouse-966"><span class="linenos"> 966</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-967"><a href="#Warehouse-967"><span class="linenos"> 967</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-968"><a href="#Warehouse-968"><span class="linenos"> 968</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-969"><a href="#Warehouse-969"><span class="linenos"> 969</span></a>            
</span><span id="Warehouse-970"><a href="#Warehouse-970"><span class="linenos"> 970</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="Warehouse-971"><a href="#Warehouse-971"><span class="linenos"> 971</span></a>            
</span><span id="Warehouse-972"><a href="#Warehouse-972"><span class="linenos"> 972</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse-973"><a href="#Warehouse-973"><span class="linenos"> 973</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Warehouse-974"><a href="#Warehouse-974"><span class="linenos"> 974</span></a>                <span class="n">presence_info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;presence_show&quot;</span><span class="p">]</span>
</span><span id="Warehouse-975"><a href="#Warehouse-975"><span class="linenos"> 975</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-976"><a href="#Warehouse-976"><span class="linenos"> 976</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received presence info response from </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">:&quot;</span>
</span><span id="Warehouse-977"><a href="#Warehouse-977"><span class="linenos"> 977</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">presence_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-978"><a href="#Warehouse-978"><span class="linenos"> 978</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;vehicle_id&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">presence_info</span>
</span><span id="Warehouse-979"><a href="#Warehouse-979"><span class="linenos"> 979</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-980"><a href="#Warehouse-980"><span class="linenos"> 980</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-981"><a href="#Warehouse-981"><span class="linenos"> 981</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No presence info response received from vehicle.&quot;</span><span class="p">)</span>
</span><span id="Warehouse-982"><a href="#Warehouse-982"><span class="linenos"> 982</span></a>    
</span><span id="Warehouse-983"><a href="#Warehouse-983"><span class="linenos"> 983</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveVehicleProposals</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-984"><a href="#Warehouse-984"><span class="linenos"> 984</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-985"><a href="#Warehouse-985"><span class="linenos"> 985</span></a><span class="sd">        Cyclic behaviour that collects vehicle delivery proposals for orders.</span>
</span><span id="Warehouse-986"><a href="#Warehouse-986"><span class="linenos"> 986</span></a><span class="sd">        </span>
</span><span id="Warehouse-987"><a href="#Warehouse-987"><span class="linenos"> 987</span></a><span class="sd">        This behaviour implements the proposal collection phase of vehicle selection.</span>
</span><span id="Warehouse-988"><a href="#Warehouse-988"><span class="linenos"> 988</span></a><span class="sd">        After the warehouse sends delivery requests to vehicles, this behaviour</span>
</span><span id="Warehouse-989"><a href="#Warehouse-989"><span class="linenos"> 989</span></a><span class="sd">        continuously receives and stores vehicle proposals containing delivery capacity</span>
</span><span id="Warehouse-990"><a href="#Warehouse-990"><span class="linenos"> 990</span></a><span class="sd">        and estimated delivery time information.</span>
</span><span id="Warehouse-991"><a href="#Warehouse-991"><span class="linenos"> 991</span></a><span class="sd">        </span>
</span><span id="Warehouse-992"><a href="#Warehouse-992"><span class="linenos"> 992</span></a><span class="sd">        The behaviour runs in an infinite loop within each execution, collecting all</span>
</span><span id="Warehouse-993"><a href="#Warehouse-993"><span class="linenos"> 993</span></a><span class="sd">        available proposals until a timeout occurs (no more proposals arriving). Each</span>
</span><span id="Warehouse-994"><a href="#Warehouse-994"><span class="linenos"> 994</span></a><span class="sd">        proposal is indexed by order_id and vehicle_jid for later evaluation.</span>
</span><span id="Warehouse-995"><a href="#Warehouse-995"><span class="linenos"> 995</span></a><span class="sd">        </span>
</span><span id="Warehouse-996"><a href="#Warehouse-996"><span class="linenos"> 996</span></a><span class="sd">        Proposal Data Structure:</span>
</span><span id="Warehouse-997"><a href="#Warehouse-997"><span class="linenos"> 997</span></a><span class="sd">            ```python</span>
</span><span id="Warehouse-998"><a href="#Warehouse-998"><span class="linenos"> 998</span></a><span class="sd">            vehicle_proposals = {</span>
</span><span id="Warehouse-999"><a href="#Warehouse-999"><span class="linenos"> 999</span></a><span class="sd">                order_id: {</span>
</span><span id="Warehouse-1000"><a href="#Warehouse-1000"><span class="linenos">1000</span></a><span class="sd">                    &quot;vehicle1@localhost&quot;: (can_fit: bool, delivery_time: int),</span>
</span><span id="Warehouse-1001"><a href="#Warehouse-1001"><span class="linenos">1001</span></a><span class="sd">                    &quot;vehicle2@localhost&quot;: (can_fit: bool, delivery_time: int),</span>
</span><span id="Warehouse-1002"><a href="#Warehouse-1002"><span class="linenos">1002</span></a><span class="sd">                    ...</span>
</span><span id="Warehouse-1003"><a href="#Warehouse-1003"><span class="linenos">1003</span></a><span class="sd">                }</span>
</span><span id="Warehouse-1004"><a href="#Warehouse-1004"><span class="linenos">1004</span></a><span class="sd">            }</span>
</span><span id="Warehouse-1005"><a href="#Warehouse-1005"><span class="linenos">1005</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1006"><a href="#Warehouse-1006"><span class="linenos">1006</span></a><span class="sd">        </span>
</span><span id="Warehouse-1007"><a href="#Warehouse-1007"><span class="linenos">1007</span></a><span class="sd">        Message Format:</span>
</span><span id="Warehouse-1008"><a href="#Warehouse-1008"><span class="linenos">1008</span></a><span class="sd">            Body (JSON):</span>
</span><span id="Warehouse-1009"><a href="#Warehouse-1009"><span class="linenos">1009</span></a><span class="sd">                ```json</span>
</span><span id="Warehouse-1010"><a href="#Warehouse-1010"><span class="linenos">1010</span></a><span class="sd">                {</span>
</span><span id="Warehouse-1011"><a href="#Warehouse-1011"><span class="linenos">1011</span></a><span class="sd">                    &quot;orderid&quot;: 2001000000,</span>
</span><span id="Warehouse-1012"><a href="#Warehouse-1012"><span class="linenos">1012</span></a><span class="sd">                    &quot;can_fit&quot;: true,</span>
</span><span id="Warehouse-1013"><a href="#Warehouse-1013"><span class="linenos">1013</span></a><span class="sd">                    &quot;delivery_time&quot;: 150</span>
</span><span id="Warehouse-1014"><a href="#Warehouse-1014"><span class="linenos">1014</span></a><span class="sd">                }</span>
</span><span id="Warehouse-1015"><a href="#Warehouse-1015"><span class="linenos">1015</span></a><span class="sd">                ```</span>
</span><span id="Warehouse-1016"><a href="#Warehouse-1016"><span class="linenos">1016</span></a><span class="sd">        </span>
</span><span id="Warehouse-1017"><a href="#Warehouse-1017"><span class="linenos">1017</span></a><span class="sd">        Workflow:</span>
</span><span id="Warehouse-1018"><a href="#Warehouse-1018"><span class="linenos">1018</span></a><span class="sd">            1. **Receive Message**: Wait up to 5 seconds for vehicle proposal</span>
</span><span id="Warehouse-1019"><a href="#Warehouse-1019"><span class="linenos">1019</span></a><span class="sd">            2. **Parse Proposal**: Extract orderid, can_fit, delivery_time</span>
</span><span id="Warehouse-1020"><a href="#Warehouse-1020"><span class="linenos">1020</span></a><span class="sd">            3. **Initialize Storage**: Create order_id entry if doesn&#39;t exist</span>
</span><span id="Warehouse-1021"><a href="#Warehouse-1021"><span class="linenos">1021</span></a><span class="sd">            4. **Store Proposal**: Add vehicle proposal to vehicle_proposals dict</span>
</span><span id="Warehouse-1022"><a href="#Warehouse-1022"><span class="linenos">1022</span></a><span class="sd">            5. **Continue Loop**: Repeat until timeout (no more proposals)</span>
</span><span id="Warehouse-1023"><a href="#Warehouse-1023"><span class="linenos">1023</span></a><span class="sd">            6. **Exit**: Break loop when timeout indicates all proposals received</span>
</span><span id="Warehouse-1024"><a href="#Warehouse-1024"><span class="linenos">1024</span></a><span class="sd">        </span>
</span><span id="Warehouse-1025"><a href="#Warehouse-1025"><span class="linenos">1025</span></a><span class="sd">        Side Effects:</span>
</span><span id="Warehouse-1026"><a href="#Warehouse-1026"><span class="linenos">1026</span></a><span class="sd">            - Updates agent.vehicle_proposals dictionary with new proposals</span>
</span><span id="Warehouse-1027"><a href="#Warehouse-1027"><span class="linenos">1027</span></a><span class="sd">            - Prints proposal details if verbose mode enabled</span>
</span><span id="Warehouse-1028"><a href="#Warehouse-1028"><span class="linenos">1028</span></a><span class="sd">            - Breaks loop after 5-second timeout</span>
</span><span id="Warehouse-1029"><a href="#Warehouse-1029"><span class="linenos">1029</span></a><span class="sd">        </span>
</span><span id="Warehouse-1030"><a href="#Warehouse-1030"><span class="linenos">1030</span></a><span class="sd">        Returns:</span>
</span><span id="Warehouse-1031"><a href="#Warehouse-1031"><span class="linenos">1031</span></a><span class="sd">            None. Exits after collecting all available proposals.</span>
</span><span id="Warehouse-1032"><a href="#Warehouse-1032"><span class="linenos">1032</span></a><span class="sd">        </span>
</span><span id="Warehouse-1033"><a href="#Warehouse-1033"><span class="linenos">1033</span></a><span class="sd">        Example Execution:</span>
</span><span id="Warehouse-1034"><a href="#Warehouse-1034"><span class="linenos">1034</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1035"><a href="#Warehouse-1035"><span class="linenos">1035</span></a><span class="sd">            Loop Iteration 1:</span>
</span><span id="Warehouse-1036"><a href="#Warehouse-1036"><span class="linenos">1036</span></a><span class="sd">                - Receive from vehicle1: can_fit=True, time=120</span>
</span><span id="Warehouse-1037"><a href="#Warehouse-1037"><span class="linenos">1037</span></a><span class="sd">                - Store: vehicle_proposals[2001000000][&quot;vehicle1&quot;] = (True, 120)</span>
</span><span id="Warehouse-1038"><a href="#Warehouse-1038"><span class="linenos">1038</span></a><span class="sd">            Loop Iteration 2:</span>
</span><span id="Warehouse-1039"><a href="#Warehouse-1039"><span class="linenos">1039</span></a><span class="sd">                - Receive from vehicle2: can_fit=False, time=180</span>
</span><span id="Warehouse-1040"><a href="#Warehouse-1040"><span class="linenos">1040</span></a><span class="sd">                - Store: vehicle_proposals[2001000000][&quot;vehicle2&quot;] = (False, 180)</span>
</span><span id="Warehouse-1041"><a href="#Warehouse-1041"><span class="linenos">1041</span></a><span class="sd">            Loop Iteration 3:</span>
</span><span id="Warehouse-1042"><a href="#Warehouse-1042"><span class="linenos">1042</span></a><span class="sd">                - Timeout after 5 seconds</span>
</span><span id="Warehouse-1043"><a href="#Warehouse-1043"><span class="linenos">1043</span></a><span class="sd">                - Break loop, all proposals collected</span>
</span><span id="Warehouse-1044"><a href="#Warehouse-1044"><span class="linenos">1044</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1045"><a href="#Warehouse-1045"><span class="linenos">1045</span></a><span class="sd">        </span>
</span><span id="Warehouse-1046"><a href="#Warehouse-1046"><span class="linenos">1046</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse-1047"><a href="#Warehouse-1047"><span class="linenos">1047</span></a><span class="sd">            The 5-second timeout is optimized to collect multiple proposals quickly</span>
</span><span id="Warehouse-1048"><a href="#Warehouse-1048"><span class="linenos">1048</span></a><span class="sd">            while not waiting too long for vehicles that won&#39;t respond.</span>
</span><span id="Warehouse-1049"><a href="#Warehouse-1049"><span class="linenos">1049</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1050"><a href="#Warehouse-1050"><span class="linenos">1050</span></a>        
</span><span id="Warehouse-1051"><a href="#Warehouse-1051"><span class="linenos">1051</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1052"><a href="#Warehouse-1052"><span class="linenos">1052</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-1053"><a href="#Warehouse-1053"><span class="linenos">1053</span></a>            
</span><span id="Warehouse-1054"><a href="#Warehouse-1054"><span class="linenos">1054</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Warehouse-1055"><a href="#Warehouse-1055"><span class="linenos">1055</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="Warehouse-1056"><a href="#Warehouse-1056"><span class="linenos">1056</span></a>                
</span><span id="Warehouse-1057"><a href="#Warehouse-1057"><span class="linenos">1057</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse-1058"><a href="#Warehouse-1058"><span class="linenos">1058</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1059"><a href="#Warehouse-1059"><span class="linenos">1059</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received vehicle proposal from </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1060"><a href="#Warehouse-1060"><span class="linenos">1060</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Warehouse-1061"><a href="#Warehouse-1061"><span class="linenos">1061</span></a>                    
</span><span id="Warehouse-1062"><a href="#Warehouse-1062"><span class="linenos">1062</span></a>                    <span class="c1"># A proposta do veculo no  uma Order, so apenas dados da proposta</span>
</span><span id="Warehouse-1063"><a href="#Warehouse-1063"><span class="linenos">1063</span></a>                    <span class="n">order_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">]</span>
</span><span id="Warehouse-1064"><a href="#Warehouse-1064"><span class="linenos">1064</span></a>                    <span class="n">sender_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse-1065"><a href="#Warehouse-1065"><span class="linenos">1065</span></a>                    <span class="n">can_fit</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;can_fit&quot;</span><span class="p">]</span>
</span><span id="Warehouse-1066"><a href="#Warehouse-1066"><span class="linenos">1066</span></a>                    <span class="n">time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;delivery_time&quot;</span><span class="p">]</span>
</span><span id="Warehouse-1067"><a href="#Warehouse-1067"><span class="linenos">1067</span></a>                    
</span><span id="Warehouse-1068"><a href="#Warehouse-1068"><span class="linenos">1068</span></a>                    <span class="c1"># Verificar se a entrada para este order_id existe, se no criar</span>
</span><span id="Warehouse-1069"><a href="#Warehouse-1069"><span class="linenos">1069</span></a>                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">:</span>
</span><span id="Warehouse-1070"><a href="#Warehouse-1070"><span class="linenos">1070</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">order_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse-1071"><a href="#Warehouse-1071"><span class="linenos">1071</span></a>                    
</span><span id="Warehouse-1072"><a href="#Warehouse-1072"><span class="linenos">1072</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">order_id</span><span class="p">)][</span><span class="n">sender_jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">can_fit</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span id="Warehouse-1073"><a href="#Warehouse-1073"><span class="linenos">1073</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1074"><a href="#Warehouse-1074"><span class="linenos">1074</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">sender_jid</span><span class="si">}</span><span class="s2"> proposal: can_fit=</span><span class="si">{</span><span class="n">can_fit</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1075"><a href="#Warehouse-1075"><span class="linenos">1075</span></a>  
</span><span id="Warehouse-1076"><a href="#Warehouse-1076"><span class="linenos">1076</span></a>                <span class="k">else</span><span class="p">:</span> 
</span><span id="Warehouse-1077"><a href="#Warehouse-1077"><span class="linenos">1077</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1078"><a href="#Warehouse-1078"><span class="linenos">1078</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Timeout - no more proposals received&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1079"><a href="#Warehouse-1079"><span class="linenos">1079</span></a>                    <span class="k">break</span>
</span><span id="Warehouse-1080"><a href="#Warehouse-1080"><span class="linenos">1080</span></a>                 
</span><span id="Warehouse-1081"><a href="#Warehouse-1081"><span class="linenos">1081</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ChooseBestVehicle</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-1082"><a href="#Warehouse-1082"><span class="linenos">1082</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1083"><a href="#Warehouse-1083"><span class="linenos">1083</span></a><span class="sd">        Behaviour that evaluates vehicle proposals and selects the optimal vehicle for delivery.</span>
</span><span id="Warehouse-1084"><a href="#Warehouse-1084"><span class="linenos">1084</span></a><span class="sd">        </span>
</span><span id="Warehouse-1085"><a href="#Warehouse-1085"><span class="linenos">1085</span></a><span class="sd">        This behaviour implements the proposal evaluation and winner selection phase of</span>
</span><span id="Warehouse-1086"><a href="#Warehouse-1086"><span class="linenos">1086</span></a><span class="sd">        vehicle assignment. After collecting all vehicle proposals via ReceiveVehicleProposals,</span>
</span><span id="Warehouse-1087"><a href="#Warehouse-1087"><span class="linenos">1087</span></a><span class="sd">        this behaviour compares them based on capacity and delivery time, then notifies</span>
</span><span id="Warehouse-1088"><a href="#Warehouse-1088"><span class="linenos">1088</span></a><span class="sd">        the selected vehicle and rejects all others.</span>
</span><span id="Warehouse-1089"><a href="#Warehouse-1089"><span class="linenos">1089</span></a><span class="sd">        </span>
</span><span id="Warehouse-1090"><a href="#Warehouse-1090"><span class="linenos">1090</span></a><span class="sd">        Selection Algorithm:</span>
</span><span id="Warehouse-1091"><a href="#Warehouse-1091"><span class="linenos">1091</span></a><span class="sd">            1. **Priority 1**: Filter vehicles that can fit the order (can_fit=True)</span>
</span><span id="Warehouse-1092"><a href="#Warehouse-1092"><span class="linenos">1092</span></a><span class="sd">            2. **Priority 2**: Among fitting vehicles, select one with minimum delivery_time</span>
</span><span id="Warehouse-1093"><a href="#Warehouse-1093"><span class="linenos">1093</span></a><span class="sd">            3. **Fallback**: If no vehicles can fit, select vehicle with minimum delivery_time anyway</span>
</span><span id="Warehouse-1094"><a href="#Warehouse-1094"><span class="linenos">1094</span></a><span class="sd">        </span>
</span><span id="Warehouse-1095"><a href="#Warehouse-1095"><span class="linenos">1095</span></a><span class="sd">        Attributes:</span>
</span><span id="Warehouse-1096"><a href="#Warehouse-1096"><span class="linenos">1096</span></a><span class="sd">            request_id (int): Unique order identifier to find proposals.</span>
</span><span id="Warehouse-1097"><a href="#Warehouse-1097"><span class="linenos">1097</span></a><span class="sd">            n_sent_messages (int): Expected number of vehicle responses to wait for.</span>
</span><span id="Warehouse-1098"><a href="#Warehouse-1098"><span class="linenos">1098</span></a><span class="sd">        </span>
</span><span id="Warehouse-1099"><a href="#Warehouse-1099"><span class="linenos">1099</span></a><span class="sd">        Workflow:</span>
</span><span id="Warehouse-1100"><a href="#Warehouse-1100"><span class="linenos">1100</span></a><span class="sd">            1. **Wait for Proposals**: Loop until n_sent_messages proposals received</span>
</span><span id="Warehouse-1101"><a href="#Warehouse-1101"><span class="linenos">1101</span></a><span class="sd">            2. **Evaluate Proposals**: Call get_best_vehicle() to select winner</span>
</span><span id="Warehouse-1102"><a href="#Warehouse-1102"><span class="linenos">1102</span></a><span class="sd">            3. **Send Confirmation**: Notify selected vehicle with order-confirmation</span>
</span><span id="Warehouse-1103"><a href="#Warehouse-1103"><span class="linenos">1103</span></a><span class="sd">            4. **Send Rejections**: Notify all other vehicles they were not selected</span>
</span><span id="Warehouse-1104"><a href="#Warehouse-1104"><span class="linenos">1104</span></a><span class="sd">        </span>
</span><span id="Warehouse-1105"><a href="#Warehouse-1105"><span class="linenos">1105</span></a><span class="sd">        Message Format (Confirmation):</span>
</span><span id="Warehouse-1106"><a href="#Warehouse-1106"><span class="linenos">1106</span></a><span class="sd">            Metadata:</span>
</span><span id="Warehouse-1107"><a href="#Warehouse-1107"><span class="linenos">1107</span></a><span class="sd">                - performative: &quot;order-confirmation&quot;</span>
</span><span id="Warehouse-1108"><a href="#Warehouse-1108"><span class="linenos">1108</span></a><span class="sd">            Body (JSON):</span>
</span><span id="Warehouse-1109"><a href="#Warehouse-1109"><span class="linenos">1109</span></a><span class="sd">                ```json</span>
</span><span id="Warehouse-1110"><a href="#Warehouse-1110"><span class="linenos">1110</span></a><span class="sd">                {</span>
</span><span id="Warehouse-1111"><a href="#Warehouse-1111"><span class="linenos">1111</span></a><span class="sd">                    &quot;orderid&quot;: 2001000000,</span>
</span><span id="Warehouse-1112"><a href="#Warehouse-1112"><span class="linenos">1112</span></a><span class="sd">                    &quot;confirmed&quot;: true</span>
</span><span id="Warehouse-1113"><a href="#Warehouse-1113"><span class="linenos">1113</span></a><span class="sd">                }</span>
</span><span id="Warehouse-1114"><a href="#Warehouse-1114"><span class="linenos">1114</span></a><span class="sd">                ```</span>
</span><span id="Warehouse-1115"><a href="#Warehouse-1115"><span class="linenos">1115</span></a><span class="sd">        </span>
</span><span id="Warehouse-1116"><a href="#Warehouse-1116"><span class="linenos">1116</span></a><span class="sd">        Message Format (Rejection):</span>
</span><span id="Warehouse-1117"><a href="#Warehouse-1117"><span class="linenos">1117</span></a><span class="sd">            Metadata:</span>
</span><span id="Warehouse-1118"><a href="#Warehouse-1118"><span class="linenos">1118</span></a><span class="sd">                - performative: &quot;order-confirmation&quot;</span>
</span><span id="Warehouse-1119"><a href="#Warehouse-1119"><span class="linenos">1119</span></a><span class="sd">            Body (JSON):</span>
</span><span id="Warehouse-1120"><a href="#Warehouse-1120"><span class="linenos">1120</span></a><span class="sd">                ```json</span>
</span><span id="Warehouse-1121"><a href="#Warehouse-1121"><span class="linenos">1121</span></a><span class="sd">                {</span>
</span><span id="Warehouse-1122"><a href="#Warehouse-1122"><span class="linenos">1122</span></a><span class="sd">                    &quot;orderid&quot;: 2001000000,</span>
</span><span id="Warehouse-1123"><a href="#Warehouse-1123"><span class="linenos">1123</span></a><span class="sd">                    &quot;confirmed&quot;: false</span>
</span><span id="Warehouse-1124"><a href="#Warehouse-1124"><span class="linenos">1124</span></a><span class="sd">                }</span>
</span><span id="Warehouse-1125"><a href="#Warehouse-1125"><span class="linenos">1125</span></a><span class="sd">                ```</span>
</span><span id="Warehouse-1126"><a href="#Warehouse-1126"><span class="linenos">1126</span></a><span class="sd">        </span>
</span><span id="Warehouse-1127"><a href="#Warehouse-1127"><span class="linenos">1127</span></a><span class="sd">        Side Effects:</span>
</span><span id="Warehouse-1128"><a href="#Warehouse-1128"><span class="linenos">1128</span></a><span class="sd">            - Reads from agent.vehicle_proposals dictionary</span>
</span><span id="Warehouse-1129"><a href="#Warehouse-1129"><span class="linenos">1129</span></a><span class="sd">            - Reads from agent.pending_deliveries for Order object</span>
</span><span id="Warehouse-1130"><a href="#Warehouse-1130"><span class="linenos">1130</span></a><span class="sd">            - Sends confirmation message to selected vehicle</span>
</span><span id="Warehouse-1131"><a href="#Warehouse-1131"><span class="linenos">1131</span></a><span class="sd">            - Sends rejection messages to non-selected vehicles</span>
</span><span id="Warehouse-1132"><a href="#Warehouse-1132"><span class="linenos">1132</span></a><span class="sd">            - Prints selection decision if verbose mode enabled</span>
</span><span id="Warehouse-1133"><a href="#Warehouse-1133"><span class="linenos">1133</span></a><span class="sd">        </span>
</span><span id="Warehouse-1134"><a href="#Warehouse-1134"><span class="linenos">1134</span></a><span class="sd">        Returns:</span>
</span><span id="Warehouse-1135"><a href="#Warehouse-1135"><span class="linenos">1135</span></a><span class="sd">            None. Completes after sending all confirmation/rejection messages.</span>
</span><span id="Warehouse-1136"><a href="#Warehouse-1136"><span class="linenos">1136</span></a><span class="sd">        </span>
</span><span id="Warehouse-1137"><a href="#Warehouse-1137"><span class="linenos">1137</span></a><span class="sd">        Example Execution:</span>
</span><span id="Warehouse-1138"><a href="#Warehouse-1138"><span class="linenos">1138</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1139"><a href="#Warehouse-1139"><span class="linenos">1139</span></a><span class="sd">            Proposals Received:</span>
</span><span id="Warehouse-1140"><a href="#Warehouse-1140"><span class="linenos">1140</span></a><span class="sd">                - vehicle1: (can_fit=True, time=120)</span>
</span><span id="Warehouse-1141"><a href="#Warehouse-1141"><span class="linenos">1141</span></a><span class="sd">                - vehicle2: (can_fit=True, time=150)</span>
</span><span id="Warehouse-1142"><a href="#Warehouse-1142"><span class="linenos">1142</span></a><span class="sd">                - vehicle3: (can_fit=False, time=100)</span>
</span><span id="Warehouse-1143"><a href="#Warehouse-1143"><span class="linenos">1143</span></a><span class="sd">            </span>
</span><span id="Warehouse-1144"><a href="#Warehouse-1144"><span class="linenos">1144</span></a><span class="sd">            Evaluation:</span>
</span><span id="Warehouse-1145"><a href="#Warehouse-1145"><span class="linenos">1145</span></a><span class="sd">                - Filter: vehicle1, vehicle2 (can fit)</span>
</span><span id="Warehouse-1146"><a href="#Warehouse-1146"><span class="linenos">1146</span></a><span class="sd">                - Compare times: 120 &lt; 150</span>
</span><span id="Warehouse-1147"><a href="#Warehouse-1147"><span class="linenos">1147</span></a><span class="sd">                - Winner: vehicle1</span>
</span><span id="Warehouse-1148"><a href="#Warehouse-1148"><span class="linenos">1148</span></a><span class="sd">            </span>
</span><span id="Warehouse-1149"><a href="#Warehouse-1149"><span class="linenos">1149</span></a><span class="sd">            Actions:</span>
</span><span id="Warehouse-1150"><a href="#Warehouse-1150"><span class="linenos">1150</span></a><span class="sd">                - Send confirmation to vehicle1 (confirmed=true)</span>
</span><span id="Warehouse-1151"><a href="#Warehouse-1151"><span class="linenos">1151</span></a><span class="sd">                - Send rejection to vehicle2 (confirmed=false)</span>
</span><span id="Warehouse-1152"><a href="#Warehouse-1152"><span class="linenos">1152</span></a><span class="sd">                - Send rejection to vehicle3 (confirmed=false)</span>
</span><span id="Warehouse-1153"><a href="#Warehouse-1153"><span class="linenos">1153</span></a><span class="sd">            </span>
</span><span id="Warehouse-1154"><a href="#Warehouse-1154"><span class="linenos">1154</span></a><span class="sd">            Output:</span>
</span><span id="Warehouse-1155"><a href="#Warehouse-1155"><span class="linenos">1155</span></a><span class="sd">                - Print: &quot;Best vehicle selected: vehicle1@localhost&quot;</span>
</span><span id="Warehouse-1156"><a href="#Warehouse-1156"><span class="linenos">1156</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1157"><a href="#Warehouse-1157"><span class="linenos">1157</span></a><span class="sd">        </span>
</span><span id="Warehouse-1158"><a href="#Warehouse-1158"><span class="linenos">1158</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse-1159"><a href="#Warehouse-1159"><span class="linenos">1159</span></a><span class="sd">            The behaviour waits actively (1-second sleep intervals) until all expected</span>
</span><span id="Warehouse-1160"><a href="#Warehouse-1160"><span class="linenos">1160</span></a><span class="sd">            proposals arrive before making a decision. This ensures fair comparison</span>
</span><span id="Warehouse-1161"><a href="#Warehouse-1161"><span class="linenos">1161</span></a><span class="sd">            of all available vehicles.</span>
</span><span id="Warehouse-1162"><a href="#Warehouse-1162"><span class="linenos">1162</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1163"><a href="#Warehouse-1163"><span class="linenos">1163</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">n_sent_messages</span><span class="p">):</span>
</span><span id="Warehouse-1164"><a href="#Warehouse-1164"><span class="linenos">1164</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse-1165"><a href="#Warehouse-1165"><span class="linenos">1165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Warehouse-1166"><a href="#Warehouse-1166"><span class="linenos">1166</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span> <span class="o">=</span> <span class="n">n_sent_messages</span>
</span><span id="Warehouse-1167"><a href="#Warehouse-1167"><span class="linenos">1167</span></a>        
</span><span id="Warehouse-1168"><a href="#Warehouse-1168"><span class="linenos">1168</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">get_best_vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proposals</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Warehouse-1169"><a href="#Warehouse-1169"><span class="linenos">1169</span></a>            <span class="c1"># First filter vehicles that can fit the order</span>
</span><span id="Warehouse-1170"><a href="#Warehouse-1170"><span class="linenos">1170</span></a>            <span class="n">can_fit_vehicles</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="ow">in</span> <span class="n">proposals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">fit</span><span class="p">}</span>
</span><span id="Warehouse-1171"><a href="#Warehouse-1171"><span class="linenos">1171</span></a>
</span><span id="Warehouse-1172"><a href="#Warehouse-1172"><span class="linenos">1172</span></a>            <span class="k">if</span> <span class="n">can_fit_vehicles</span><span class="p">:</span>
</span><span id="Warehouse-1173"><a href="#Warehouse-1173"><span class="linenos">1173</span></a>                <span class="c1"># If there are vehicles that can fit, choose the one with lowest delivery time</span>
</span><span id="Warehouse-1174"><a href="#Warehouse-1174"><span class="linenos">1174</span></a>                <span class="n">best_vehicle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">can_fit_vehicles</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Warehouse-1175"><a href="#Warehouse-1175"><span class="linenos">1175</span></a>                <span class="k">return</span> <span class="n">best_vehicle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Warehouse-1176"><a href="#Warehouse-1176"><span class="linenos">1176</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-1177"><a href="#Warehouse-1177"><span class="linenos">1177</span></a>                <span class="c1"># If no vehicles can fit, choose the one with lowest delivery time anyway</span>
</span><span id="Warehouse-1178"><a href="#Warehouse-1178"><span class="linenos">1178</span></a>                <span class="k">if</span> <span class="n">proposals</span><span class="p">:</span>
</span><span id="Warehouse-1179"><a href="#Warehouse-1179"><span class="linenos">1179</span></a>                    <span class="n">best_vehicle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">proposals</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Warehouse-1180"><a href="#Warehouse-1180"><span class="linenos">1180</span></a>                    <span class="k">return</span> <span class="n">best_vehicle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Warehouse-1181"><a href="#Warehouse-1181"><span class="linenos">1181</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="Warehouse-1182"><a href="#Warehouse-1182"><span class="linenos">1182</span></a>        
</span><span id="Warehouse-1183"><a href="#Warehouse-1183"><span class="linenos">1183</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1184"><a href="#Warehouse-1184"><span class="linenos">1184</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-1185"><a href="#Warehouse-1185"><span class="linenos">1185</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1186"><a href="#Warehouse-1186"><span class="linenos">1186</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Comparing vehicle proposals...&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1187"><a href="#Warehouse-1187"><span class="linenos">1187</span></a>            
</span><span id="Warehouse-1188"><a href="#Warehouse-1188"><span class="linenos">1188</span></a>            <span class="c1"># Verificar se a entrada para este order_id existe, se no criar</span>
</span><span id="Warehouse-1189"><a href="#Warehouse-1189"><span class="linenos">1189</span></a>            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">:</span>
</span><span id="Warehouse-1190"><a href="#Warehouse-1190"><span class="linenos">1190</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse-1191"><a href="#Warehouse-1191"><span class="linenos">1191</span></a>            
</span><span id="Warehouse-1192"><a href="#Warehouse-1192"><span class="linenos">1192</span></a>            <span class="n">proposals</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)]</span> <span class="c1"># vehicle_jid : (can_fit, time)</span>
</span><span id="Warehouse-1193"><a href="#Warehouse-1193"><span class="linenos">1193</span></a>            
</span><span id="Warehouse-1194"><a href="#Warehouse-1194"><span class="linenos">1194</span></a>            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span><span class="p">:</span>
</span><span id="Warehouse-1195"><a href="#Warehouse-1195"><span class="linenos">1195</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1196"><a href="#Warehouse-1196"><span class="linenos">1196</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Waiting for more proposals... &quot;</span>
</span><span id="Warehouse-1197"><a href="#Warehouse-1197"><span class="linenos">1197</span></a>                          <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1198"><a href="#Warehouse-1198"><span class="linenos">1198</span></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Warehouse-1199"><a href="#Warehouse-1199"><span class="linenos">1199</span></a>                <span class="n">proposals</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)]</span>
</span><span id="Warehouse-1200"><a href="#Warehouse-1200"><span class="linenos">1200</span></a>            
</span><span id="Warehouse-1201"><a href="#Warehouse-1201"><span class="linenos">1201</span></a>
</span><span id="Warehouse-1202"><a href="#Warehouse-1202"><span class="linenos">1202</span></a>            
</span><span id="Warehouse-1203"><a href="#Warehouse-1203"><span class="linenos">1203</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1204"><a href="#Warehouse-1204"><span class="linenos">1204</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Total proposals received: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1205"><a href="#Warehouse-1205"><span class="linenos">1205</span></a>            <span class="n">best_vehicle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_best_vehicle</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span>
</span><span id="Warehouse-1206"><a href="#Warehouse-1206"><span class="linenos">1206</span></a>            
</span><span id="Warehouse-1207"><a href="#Warehouse-1207"><span class="linenos">1207</span></a>            <span class="k">if</span> <span class="n">best_vehicle</span><span class="p">:</span>
</span><span id="Warehouse-1208"><a href="#Warehouse-1208"><span class="linenos">1208</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Best vehicle selected: </span><span class="si">{</span><span class="n">best_vehicle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1209"><a href="#Warehouse-1209"><span class="linenos">1209</span></a>                
</span><span id="Warehouse-1210"><a href="#Warehouse-1210"><span class="linenos">1210</span></a>                <span class="c1"># Send confirmation to the selected vehicle</span>
</span><span id="Warehouse-1211"><a href="#Warehouse-1211"><span class="linenos">1211</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">best_vehicle</span><span class="p">)</span>
</span><span id="Warehouse-1212"><a href="#Warehouse-1212"><span class="linenos">1212</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;order-confirmation&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1213"><a href="#Warehouse-1213"><span class="linenos">1213</span></a>                
</span><span id="Warehouse-1214"><a href="#Warehouse-1214"><span class="linenos">1214</span></a>                <span class="n">order</span> <span class="p">:</span> <span class="n">Order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">]</span>
</span><span id="Warehouse-1215"><a href="#Warehouse-1215"><span class="linenos">1215</span></a>                <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Warehouse-1216"><a href="#Warehouse-1216"><span class="linenos">1216</span></a>                    <span class="s2">&quot;orderid&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span>
</span><span id="Warehouse-1217"><a href="#Warehouse-1217"><span class="linenos">1217</span></a>                    <span class="s2">&quot;confirmed&quot;</span> <span class="p">:</span> <span class="kc">True</span>
</span><span id="Warehouse-1218"><a href="#Warehouse-1218"><span class="linenos">1218</span></a>                <span class="p">}</span>
</span><span id="Warehouse-1219"><a href="#Warehouse-1219"><span class="linenos">1219</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
</span><span id="Warehouse-1220"><a href="#Warehouse-1220"><span class="linenos">1220</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-1221"><a href="#Warehouse-1221"><span class="linenos">1221</span></a>                
</span><span id="Warehouse-1222"><a href="#Warehouse-1222"><span class="linenos">1222</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1223"><a href="#Warehouse-1223"><span class="linenos">1223</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Confirmation sent to </span><span class="si">{</span><span class="n">best_vehicle</span><span class="si">}</span><span class="s2"> for order </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1224"><a href="#Warehouse-1224"><span class="linenos">1224</span></a>                
</span><span id="Warehouse-1225"><a href="#Warehouse-1225"><span class="linenos">1225</span></a>                <span class="c1"># Send rejection to all other vehicles</span>
</span><span id="Warehouse-1226"><a href="#Warehouse-1226"><span class="linenos">1226</span></a>                <span class="n">rejected_vehicles</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">proposals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">jid</span> <span class="o">!=</span> <span class="n">best_vehicle</span><span class="p">]</span>
</span><span id="Warehouse-1227"><a href="#Warehouse-1227"><span class="linenos">1227</span></a>                <span class="k">for</span> <span class="n">vehicle_jid</span> <span class="ow">in</span> <span class="n">rejected_vehicles</span><span class="p">:</span>
</span><span id="Warehouse-1228"><a href="#Warehouse-1228"><span class="linenos">1228</span></a>                    <span class="n">reject_msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse-1229"><a href="#Warehouse-1229"><span class="linenos">1229</span></a>                    <span class="n">reject_msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;order-confirmation&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1230"><a href="#Warehouse-1230"><span class="linenos">1230</span></a>                    
</span><span id="Warehouse-1231"><a href="#Warehouse-1231"><span class="linenos">1231</span></a>                    <span class="n">reject_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Warehouse-1232"><a href="#Warehouse-1232"><span class="linenos">1232</span></a>                    <span class="s2">&quot;orderid&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span>
</span><span id="Warehouse-1233"><a href="#Warehouse-1233"><span class="linenos">1233</span></a>                    <span class="s2">&quot;confirmed&quot;</span> <span class="p">:</span> <span class="kc">False</span>
</span><span id="Warehouse-1234"><a href="#Warehouse-1234"><span class="linenos">1234</span></a>                    <span class="p">}</span>
</span><span id="Warehouse-1235"><a href="#Warehouse-1235"><span class="linenos">1235</span></a>                    
</span><span id="Warehouse-1236"><a href="#Warehouse-1236"><span class="linenos">1236</span></a>                    <span class="n">reject_msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">reject_data</span><span class="p">)</span>
</span><span id="Warehouse-1237"><a href="#Warehouse-1237"><span class="linenos">1237</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">reject_msg</span><span class="p">)</span>                        
</span><span id="Warehouse-1238"><a href="#Warehouse-1238"><span class="linenos">1238</span></a>    
</span><span id="Warehouse-1239"><a href="#Warehouse-1239"><span class="linenos">1239</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Warehouse-1240"><a href="#Warehouse-1240"><span class="linenos">1240</span></a>    <span class="c1">#         WAREHOUSE &lt;-&gt; SUPPLIER</span>
</span><span id="Warehouse-1241"><a href="#Warehouse-1241"><span class="linenos">1241</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Warehouse-1242"><a href="#Warehouse-1242"><span class="linenos">1242</span></a>        
</span><span id="Warehouse-1243"><a href="#Warehouse-1243"><span class="linenos">1243</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">BuyMaterial</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-1244"><a href="#Warehouse-1244"><span class="linenos">1244</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1245"><a href="#Warehouse-1245"><span class="linenos">1245</span></a><span class="sd">        Behaviour that initiates material purchase from suppliers (FIPA CFP - Initiator Role).</span>
</span><span id="Warehouse-1246"><a href="#Warehouse-1246"><span class="linenos">1246</span></a><span class="sd">        </span>
</span><span id="Warehouse-1247"><a href="#Warehouse-1247"><span class="linenos">1247</span></a><span class="sd">        This behaviour implements the FIPA Contract Net Protocol with the warehouse acting</span>
</span><span id="Warehouse-1248"><a href="#Warehouse-1248"><span class="linenos">1248</span></a><span class="sd">        as the INITIATOR role. The warehouse broadcasts a Call For Proposals (CFP) to</span>
</span><span id="Warehouse-1249"><a href="#Warehouse-1249"><span class="linenos">1249</span></a><span class="sd">        suppliers to replenish inventory. This is the dual role mentioned in the class</span>
</span><span id="Warehouse-1250"><a href="#Warehouse-1250"><span class="linenos">1250</span></a><span class="sd">        docstring - the warehouse is a participant when dealing with stores but becomes</span>
</span><span id="Warehouse-1251"><a href="#Warehouse-1251"><span class="linenos">1251</span></a><span class="sd">        an initiator when dealing with suppliers.</span>
</span><span id="Warehouse-1252"><a href="#Warehouse-1252"><span class="linenos">1252</span></a><span class="sd">        </span>
</span><span id="Warehouse-1253"><a href="#Warehouse-1253"><span class="linenos">1253</span></a><span class="sd">        FIPA Protocol: **Contract Net - Initiator Role**</span>
</span><span id="Warehouse-1254"><a href="#Warehouse-1254"><span class="linenos">1254</span></a><span class="sd">            - Role: Initiator (Warehouse requesting materials from Suppliers)</span>
</span><span id="Warehouse-1255"><a href="#Warehouse-1255"><span class="linenos">1255</span></a><span class="sd">            - Sends: warehouse-buy (FIPA CFP) with quantity and product</span>
</span><span id="Warehouse-1256"><a href="#Warehouse-1256"><span class="linenos">1256</span></a><span class="sd">            - Receives: supplier-accept (FIPA propose) or supplier-reject (FIPA refuse)</span>
</span><span id="Warehouse-1257"><a href="#Warehouse-1257"><span class="linenos">1257</span></a><span class="sd">            - Selection: Choose best supplier based on price and availability</span>
</span><span id="Warehouse-1258"><a href="#Warehouse-1258"><span class="linenos">1258</span></a><span class="sd">            - Award: Send warehouse-confirm (FIPA accept-proposal) to winner</span>
</span><span id="Warehouse-1259"><a href="#Warehouse-1259"><span class="linenos">1259</span></a><span class="sd">        </span>
</span><span id="Warehouse-1260"><a href="#Warehouse-1260"><span class="linenos">1260</span></a><span class="sd">        Dual FIPA Role Context:</span>
</span><span id="Warehouse-1261"><a href="#Warehouse-1261"><span class="linenos">1261</span></a><span class="sd">            - **As Participant** (Store  Warehouse): Warehouse responds to store CFPs</span>
</span><span id="Warehouse-1262"><a href="#Warehouse-1262"><span class="linenos">1262</span></a><span class="sd">            - **As Initiator** (Warehouse  Supplier): Warehouse sends CFPs to suppliers</span>
</span><span id="Warehouse-1263"><a href="#Warehouse-1263"><span class="linenos">1263</span></a><span class="sd">            </span>
</span><span id="Warehouse-1264"><a href="#Warehouse-1264"><span class="linenos">1264</span></a><span class="sd">            This dual role makes the warehouse a critical intermediary in the supply chain,</span>
</span><span id="Warehouse-1265"><a href="#Warehouse-1265"><span class="linenos">1265</span></a><span class="sd">            translating downstream demand into upstream procurement.</span>
</span><span id="Warehouse-1266"><a href="#Warehouse-1266"><span class="linenos">1266</span></a><span class="sd">        </span>
</span><span id="Warehouse-1267"><a href="#Warehouse-1267"><span class="linenos">1267</span></a><span class="sd">        Attributes:</span>
</span><span id="Warehouse-1268"><a href="#Warehouse-1268"><span class="linenos">1268</span></a><span class="sd">            quantity (int): Amount of material to purchase from suppliers.</span>
</span><span id="Warehouse-1269"><a href="#Warehouse-1269"><span class="linenos">1269</span></a><span class="sd">            product (str): Type of material/product needed for restocking.</span>
</span><span id="Warehouse-1270"><a href="#Warehouse-1270"><span class="linenos">1270</span></a><span class="sd">        </span>
</span><span id="Warehouse-1271"><a href="#Warehouse-1271"><span class="linenos">1271</span></a><span class="sd">        Message Format (warehouse-buy):</span>
</span><span id="Warehouse-1272"><a href="#Warehouse-1272"><span class="linenos">1272</span></a><span class="sd">            Metadata:</span>
</span><span id="Warehouse-1273"><a href="#Warehouse-1273"><span class="linenos">1273</span></a><span class="sd">                - performative: &quot;warehouse-buy&quot; (FIPA CFP)</span>
</span><span id="Warehouse-1274"><a href="#Warehouse-1274"><span class="linenos">1274</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="Warehouse-1275"><a href="#Warehouse-1275"><span class="linenos">1275</span></a><span class="sd">                - request_id: Unique request identifier (ID encoding)</span>
</span><span id="Warehouse-1276"><a href="#Warehouse-1276"><span class="linenos">1276</span></a><span class="sd">            Body:</span>
</span><span id="Warehouse-1277"><a href="#Warehouse-1277"><span class="linenos">1277</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse-1278"><a href="#Warehouse-1278"><span class="linenos">1278</span></a><span class="sd">                - Example: &quot;100 raw_materials&quot;</span>
</span><span id="Warehouse-1279"><a href="#Warehouse-1279"><span class="linenos">1279</span></a><span class="sd">        </span>
</span><span id="Warehouse-1280"><a href="#Warehouse-1280"><span class="linenos">1280</span></a><span class="sd">        ID Encoding for Request:</span>
</span><span id="Warehouse-1281"><a href="#Warehouse-1281"><span class="linenos">1281</span></a><span class="sd">            Uses the warehouse&#39;s ID encoding scheme:</span>
</span><span id="Warehouse-1282"><a href="#Warehouse-1282"><span class="linenos">1282</span></a><span class="sd">            - request_id = warehouse.id_base + warehouse.request_counter</span>
</span><span id="Warehouse-1283"><a href="#Warehouse-1283"><span class="linenos">1283</span></a><span class="sd">            - Format: 1 (warehouse type) * 100_000_000 + instance * 1_000_000 + counter</span>
</span><span id="Warehouse-1284"><a href="#Warehouse-1284"><span class="linenos">1284</span></a><span class="sd">            - Example: 101000000 (warehouse 1, request 0)</span>
</span><span id="Warehouse-1285"><a href="#Warehouse-1285"><span class="linenos">1285</span></a><span class="sd">        </span>
</span><span id="Warehouse-1286"><a href="#Warehouse-1286"><span class="linenos">1286</span></a><span class="sd">        Workflow:</span>
</span><span id="Warehouse-1287"><a href="#Warehouse-1287"><span class="linenos">1287</span></a><span class="sd">            1. **Populate Suppliers**: Auto-discover suppliers from presence contacts</span>
</span><span id="Warehouse-1288"><a href="#Warehouse-1288"><span class="linenos">1288</span></a><span class="sd">            2. **Generate Request ID**: Create unique ID for this procurement</span>
</span><span id="Warehouse-1289"><a href="#Warehouse-1289"><span class="linenos">1289</span></a><span class="sd">            3. **Broadcast CFP**: Send warehouse-buy to all available suppliers</span>
</span><span id="Warehouse-1290"><a href="#Warehouse-1290"><span class="linenos">1290</span></a><span class="sd">            4. **Set Metadata**: Store request for retry mechanism (current_buy_request)</span>
</span><span id="Warehouse-1291"><a href="#Warehouse-1291"><span class="linenos">1291</span></a><span class="sd">            5. **Launch Coordinator**: Start CollectSupplierResponses to gather proposals</span>
</span><span id="Warehouse-1292"><a href="#Warehouse-1292"><span class="linenos">1292</span></a><span class="sd">            6. **Non-blocking**: Return immediately (coordinator handles responses)</span>
</span><span id="Warehouse-1293"><a href="#Warehouse-1293"><span class="linenos">1293</span></a><span class="sd">        </span>
</span><span id="Warehouse-1294"><a href="#Warehouse-1294"><span class="linenos">1294</span></a><span class="sd">        Coordinator/Worker Pattern:</span>
</span><span id="Warehouse-1295"><a href="#Warehouse-1295"><span class="linenos">1295</span></a><span class="sd">            - **Initiator (this)**: Sends CFP and launches coordinator</span>
</span><span id="Warehouse-1296"><a href="#Warehouse-1296"><span class="linenos">1296</span></a><span class="sd">            - **Coordinator**: CollectSupplierResponses (manages collection process)</span>
</span><span id="Warehouse-1297"><a href="#Warehouse-1297"><span class="linenos">1297</span></a><span class="sd">            - **Worker**: ReceiveAllSupplierResponses (collects individual proposals)</span>
</span><span id="Warehouse-1298"><a href="#Warehouse-1298"><span class="linenos">1298</span></a><span class="sd">            - **Decision**: SendWarehouseConfirmation (award) or SendWarehouseDenial (reject)</span>
</span><span id="Warehouse-1299"><a href="#Warehouse-1299"><span class="linenos">1299</span></a><span class="sd">        </span>
</span><span id="Warehouse-1300"><a href="#Warehouse-1300"><span class="linenos">1300</span></a><span class="sd">        Supplier Discovery:</span>
</span><span id="Warehouse-1301"><a href="#Warehouse-1301"><span class="linenos">1301</span></a><span class="sd">            Automatically populates supplier list from presence contacts:</span>
</span><span id="Warehouse-1302"><a href="#Warehouse-1302"><span class="linenos">1302</span></a><span class="sd">            - Filters contacts for JIDs containing &quot;supplier&quot;</span>
</span><span id="Warehouse-1303"><a href="#Warehouse-1303"><span class="linenos">1303</span></a><span class="sd">            - Updates agent.suppliers list if empty</span>
</span><span id="Warehouse-1304"><a href="#Warehouse-1304"><span class="linenos">1304</span></a><span class="sd">            - Requires presence subscription to be active</span>
</span><span id="Warehouse-1305"><a href="#Warehouse-1305"><span class="linenos">1305</span></a><span class="sd">        </span>
</span><span id="Warehouse-1306"><a href="#Warehouse-1306"><span class="linenos">1306</span></a><span class="sd">        Example Execution:</span>
</span><span id="Warehouse-1307"><a href="#Warehouse-1307"><span class="linenos">1307</span></a><span class="sd">        </span>
</span><span id="Warehouse-1308"><a href="#Warehouse-1308"><span class="linenos">1308</span></a><span class="sd">            **Scenario 1: Normal Procurement**</span>
</span><span id="Warehouse-1309"><a href="#Warehouse-1309"><span class="linenos">1309</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1310"><a href="#Warehouse-1310"><span class="linenos">1310</span></a><span class="sd">            Trigger: stock[electronics] &lt; restock_threshold</span>
</span><span id="Warehouse-1311"><a href="#Warehouse-1311"><span class="linenos">1311</span></a><span class="sd">            Request: BuyMaterial(100, &quot;electronics&quot;)</span>
</span><span id="Warehouse-1312"><a href="#Warehouse-1312"><span class="linenos">1312</span></a><span class="sd">            </span>
</span><span id="Warehouse-1313"><a href="#Warehouse-1313"><span class="linenos">1313</span></a><span class="sd">            Step 1: Populate suppliers</span>
</span><span id="Warehouse-1314"><a href="#Warehouse-1314"><span class="linenos">1314</span></a><span class="sd">                Discovered: [supplier1@localhost, supplier2@localhost]</span>
</span><span id="Warehouse-1315"><a href="#Warehouse-1315"><span class="linenos">1315</span></a><span class="sd">            </span>
</span><span id="Warehouse-1316"><a href="#Warehouse-1316"><span class="linenos">1316</span></a><span class="sd">            Step 2: Generate ID</span>
</span><span id="Warehouse-1317"><a href="#Warehouse-1317"><span class="linenos">1317</span></a><span class="sd">                request_id: 101000000</span>
</span><span id="Warehouse-1318"><a href="#Warehouse-1318"><span class="linenos">1318</span></a><span class="sd">            </span>
</span><span id="Warehouse-1319"><a href="#Warehouse-1319"><span class="linenos">1319</span></a><span class="sd">            Step 3: Broadcast CFP</span>
</span><span id="Warehouse-1320"><a href="#Warehouse-1320"><span class="linenos">1320</span></a><span class="sd">                To: supplier1, supplier2</span>
</span><span id="Warehouse-1321"><a href="#Warehouse-1321"><span class="linenos">1321</span></a><span class="sd">                Message: warehouse-buy &quot;100 electronics&quot;</span>
</span><span id="Warehouse-1322"><a href="#Warehouse-1322"><span class="linenos">1322</span></a><span class="sd">            </span>
</span><span id="Warehouse-1323"><a href="#Warehouse-1323"><span class="linenos">1323</span></a><span class="sd">            Step 4: Launch coordinator</span>
</span><span id="Warehouse-1324"><a href="#Warehouse-1324"><span class="linenos">1324</span></a><span class="sd">                CollectSupplierResponses(101000000, 100, &quot;electronics&quot;)</span>
</span><span id="Warehouse-1325"><a href="#Warehouse-1325"><span class="linenos">1325</span></a><span class="sd">                Coordinator launches ReceiveAllSupplierResponses worker</span>
</span><span id="Warehouse-1326"><a href="#Warehouse-1326"><span class="linenos">1326</span></a><span class="sd">            </span>
</span><span id="Warehouse-1327"><a href="#Warehouse-1327"><span class="linenos">1327</span></a><span class="sd">            Step 5: Wait for proposals (handled by coordinator)</span>
</span><span id="Warehouse-1328"><a href="#Warehouse-1328"><span class="linenos">1328</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1329"><a href="#Warehouse-1329"><span class="linenos">1329</span></a><span class="sd">            </span>
</span><span id="Warehouse-1330"><a href="#Warehouse-1330"><span class="linenos">1330</span></a><span class="sd">            **Scenario 2: No Suppliers Available**</span>
</span><span id="Warehouse-1331"><a href="#Warehouse-1331"><span class="linenos">1331</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1332"><a href="#Warehouse-1332"><span class="linenos">1332</span></a><span class="sd">            Request: BuyMaterial(100, &quot;electronics&quot;)</span>
</span><span id="Warehouse-1333"><a href="#Warehouse-1333"><span class="linenos">1333</span></a><span class="sd">            Suppliers: [] (empty list, none in presence)</span>
</span><span id="Warehouse-1334"><a href="#Warehouse-1334"><span class="linenos">1334</span></a><span class="sd">            </span>
</span><span id="Warehouse-1335"><a href="#Warehouse-1335"><span class="linenos">1335</span></a><span class="sd">            Result: ERROR logged, no messages sent</span>
</span><span id="Warehouse-1336"><a href="#Warehouse-1336"><span class="linenos">1336</span></a><span class="sd">            Action: Retry later when suppliers available</span>
</span><span id="Warehouse-1337"><a href="#Warehouse-1337"><span class="linenos">1337</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1338"><a href="#Warehouse-1338"><span class="linenos">1338</span></a><span class="sd">        </span>
</span><span id="Warehouse-1339"><a href="#Warehouse-1339"><span class="linenos">1339</span></a><span class="sd">        Retry Mechanism:</span>
</span><span id="Warehouse-1340"><a href="#Warehouse-1340"><span class="linenos">1340</span></a><span class="sd">            Sets agent.current_buy_request with:</span>
</span><span id="Warehouse-1341"><a href="#Warehouse-1341"><span class="linenos">1341</span></a><span class="sd">            - quantity: Amount requested</span>
</span><span id="Warehouse-1342"><a href="#Warehouse-1342"><span class="linenos">1342</span></a><span class="sd">            - product: Product type</span>
</span><span id="Warehouse-1343"><a href="#Warehouse-1343"><span class="linenos">1343</span></a><span class="sd">            - request_id: Request identifier</span>
</span><span id="Warehouse-1344"><a href="#Warehouse-1344"><span class="linenos">1344</span></a><span class="sd">            </span>
</span><span id="Warehouse-1345"><a href="#Warehouse-1345"><span class="linenos">1345</span></a><span class="sd">            Used by RetryPreviousBuy if procurement fails.</span>
</span><span id="Warehouse-1346"><a href="#Warehouse-1346"><span class="linenos">1346</span></a><span class="sd">        </span>
</span><span id="Warehouse-1347"><a href="#Warehouse-1347"><span class="linenos">1347</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse-1348"><a href="#Warehouse-1348"><span class="linenos">1348</span></a><span class="sd">            This behaviour implements the same FIPA protocol that stores use when</span>
</span><span id="Warehouse-1349"><a href="#Warehouse-1349"><span class="linenos">1349</span></a><span class="sd">            buying from warehouses, but with reversed roles. The message format and</span>
</span><span id="Warehouse-1350"><a href="#Warehouse-1350"><span class="linenos">1350</span></a><span class="sd">            workflow mirror the store-warehouse interaction.</span>
</span><span id="Warehouse-1351"><a href="#Warehouse-1351"><span class="linenos">1351</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1352"><a href="#Warehouse-1352"><span class="linenos">1352</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
</span><span id="Warehouse-1353"><a href="#Warehouse-1353"><span class="linenos">1353</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1354"><a href="#Warehouse-1354"><span class="linenos">1354</span></a><span class="sd">            Initialize the BuyMaterial behaviour.</span>
</span><span id="Warehouse-1355"><a href="#Warehouse-1355"><span class="linenos">1355</span></a><span class="sd">            </span>
</span><span id="Warehouse-1356"><a href="#Warehouse-1356"><span class="linenos">1356</span></a><span class="sd">            Args:</span>
</span><span id="Warehouse-1357"><a href="#Warehouse-1357"><span class="linenos">1357</span></a><span class="sd">                quantity (int): Amount of material to purchase.</span>
</span><span id="Warehouse-1358"><a href="#Warehouse-1358"><span class="linenos">1358</span></a><span class="sd">                product (str): Type of material/product to procure.</span>
</span><span id="Warehouse-1359"><a href="#Warehouse-1359"><span class="linenos">1359</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse-1360"><a href="#Warehouse-1360"><span class="linenos">1360</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse-1361"><a href="#Warehouse-1361"><span class="linenos">1361</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Warehouse-1362"><a href="#Warehouse-1362"><span class="linenos">1362</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="Warehouse-1363"><a href="#Warehouse-1363"><span class="linenos">1363</span></a>        
</span><span id="Warehouse-1364"><a href="#Warehouse-1364"><span class="linenos">1364</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">populate_suppliers_from_contacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1365"><a href="#Warehouse-1365"><span class="linenos">1365</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Populate suppliers list from presence contacts if empty&quot;&quot;&quot;</span>
</span><span id="Warehouse-1366"><a href="#Warehouse-1366"><span class="linenos">1366</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-1367"><a href="#Warehouse-1367"><span class="linenos">1367</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="Warehouse-1368"><a href="#Warehouse-1368"><span class="linenos">1368</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;supplier&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
</span><span id="Warehouse-1369"><a href="#Warehouse-1369"><span class="linenos">1369</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1370"><a href="#Warehouse-1370"><span class="linenos">1370</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Auto-populated suppliers from contacts: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1371"><a href="#Warehouse-1371"><span class="linenos">1371</span></a>        
</span><span id="Warehouse-1372"><a href="#Warehouse-1372"><span class="linenos">1372</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1373"><a href="#Warehouse-1373"><span class="linenos">1373</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-1374"><a href="#Warehouse-1374"><span class="linenos">1374</span></a>            
</span><span id="Warehouse-1375"><a href="#Warehouse-1375"><span class="linenos">1375</span></a>            <span class="c1"># Populate suppliers from contacts if list is empty</span>
</span><span id="Warehouse-1376"><a href="#Warehouse-1376"><span class="linenos">1376</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">populate_suppliers_from_contacts</span><span class="p">()</span>
</span><span id="Warehouse-1377"><a href="#Warehouse-1377"><span class="linenos">1377</span></a>            
</span><span id="Warehouse-1378"><a href="#Warehouse-1378"><span class="linenos">1378</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="Warehouse-1379"><a href="#Warehouse-1379"><span class="linenos">1379</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1380"><a href="#Warehouse-1380"><span class="linenos">1380</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: No suppliers found in contacts!&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1381"><a href="#Warehouse-1381"><span class="linenos">1381</span></a>                <span class="k">return</span>
</span><span id="Warehouse-1382"><a href="#Warehouse-1382"><span class="linenos">1382</span></a>            
</span><span id="Warehouse-1383"><a href="#Warehouse-1383"><span class="linenos">1383</span></a>            <span class="c1"># Get request_id before sending - use ID encoding</span>
</span><span id="Warehouse-1384"><a href="#Warehouse-1384"><span class="linenos">1384</span></a>            <span class="n">request_id_for_template</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">id_base</span> <span class="o">+</span> <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span>
</span><span id="Warehouse-1385"><a href="#Warehouse-1385"><span class="linenos">1385</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse-1386"><a href="#Warehouse-1386"><span class="linenos">1386</span></a>            
</span><span id="Warehouse-1387"><a href="#Warehouse-1387"><span class="linenos">1387</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will store the last sent message for current_buy_request</span>
</span><span id="Warehouse-1388"><a href="#Warehouse-1388"><span class="linenos">1388</span></a>            <span class="c1"># Only send to suppliers, not all contacts</span>
</span><span id="Warehouse-1389"><a href="#Warehouse-1389"><span class="linenos">1389</span></a>            <span class="k">for</span> <span class="n">supplier_jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="Warehouse-1390"><a href="#Warehouse-1390"><span class="linenos">1390</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">supplier_jid</span><span class="p">)</span>
</span><span id="Warehouse-1391"><a href="#Warehouse-1391"><span class="linenos">1391</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-buy&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1392"><a href="#Warehouse-1392"><span class="linenos">1392</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse-1393"><a href="#Warehouse-1393"><span class="linenos">1393</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id_for_template</span><span class="p">))</span>
</span><span id="Warehouse-1394"><a href="#Warehouse-1394"><span class="linenos">1394</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse-1395"><a href="#Warehouse-1395"><span class="linenos">1395</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse-1396"><a href="#Warehouse-1396"><span class="linenos">1396</span></a>                
</span><span id="Warehouse-1397"><a href="#Warehouse-1397"><span class="linenos">1397</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1398"><a href="#Warehouse-1398"><span class="linenos">1398</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent request (id=</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;request_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="Warehouse-1399"><a href="#Warehouse-1399"><span class="linenos">1399</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1400"><a href="#Warehouse-1400"><span class="linenos">1400</span></a>                
</span><span id="Warehouse-1401"><a href="#Warehouse-1401"><span class="linenos">1401</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-1402"><a href="#Warehouse-1402"><span class="linenos">1402</span></a>            
</span><span id="Warehouse-1403"><a href="#Warehouse-1403"><span class="linenos">1403</span></a>            <span class="c1"># Store the last message (or could store all if needed)</span>
</span><span id="Warehouse-1404"><a href="#Warehouse-1404"><span class="linenos">1404</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse-1405"><a href="#Warehouse-1405"><span class="linenos">1405</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="Warehouse-1406"><a href="#Warehouse-1406"><span class="linenos">1406</span></a>        
</span><span id="Warehouse-1407"><a href="#Warehouse-1407"><span class="linenos">1407</span></a>                <span class="c1"># Collect responses from all suppliers</span>
</span><span id="Warehouse-1408"><a href="#Warehouse-1408"><span class="linenos">1408</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectSupplierResponses</span><span class="p">(</span>
</span><span id="Warehouse-1409"><a href="#Warehouse-1409"><span class="linenos">1409</span></a>                    <span class="n">msg</span><span class="p">,</span> 
</span><span id="Warehouse-1410"><a href="#Warehouse-1410"><span class="linenos">1410</span></a>                    <span class="n">request_id_for_template</span><span class="p">,</span> 
</span><span id="Warehouse-1411"><a href="#Warehouse-1411"><span class="linenos">1411</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">),</span>
</span><span id="Warehouse-1412"><a href="#Warehouse-1412"><span class="linenos">1412</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="Warehouse-1413"><a href="#Warehouse-1413"><span class="linenos">1413</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">product</span>
</span><span id="Warehouse-1414"><a href="#Warehouse-1414"><span class="linenos">1414</span></a>                <span class="p">)</span>
</span><span id="Warehouse-1415"><a href="#Warehouse-1415"><span class="linenos">1415</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Warehouse-1416"><a href="#Warehouse-1416"><span class="linenos">1416</span></a>                
</span><span id="Warehouse-1417"><a href="#Warehouse-1417"><span class="linenos">1417</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse-1418"><a href="#Warehouse-1418"><span class="linenos">1418</span></a>    
</span><span id="Warehouse-1419"><a href="#Warehouse-1419"><span class="linenos">1419</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">CollectSupplierResponses</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-1420"><a href="#Warehouse-1420"><span class="linenos">1420</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1421"><a href="#Warehouse-1421"><span class="linenos">1421</span></a><span class="sd">        Coordinator behaviour that manages supplier proposal collection and evaluation.</span>
</span><span id="Warehouse-1422"><a href="#Warehouse-1422"><span class="linenos">1422</span></a><span class="sd">        </span>
</span><span id="Warehouse-1423"><a href="#Warehouse-1423"><span class="linenos">1423</span></a><span class="sd">        Launches ReceiveAllSupplierResponses worker to collect proposals from all suppliers,</span>
</span><span id="Warehouse-1424"><a href="#Warehouse-1424"><span class="linenos">1424</span></a><span class="sd">        then evaluates responses and selects the best supplier based on delivery time.</span>
</span><span id="Warehouse-1425"><a href="#Warehouse-1425"><span class="linenos">1425</span></a><span class="sd">        Sends confirmation to winner and denials to others. Implements FIPA initiator role.</span>
</span><span id="Warehouse-1426"><a href="#Warehouse-1426"><span class="linenos">1426</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1427"><a href="#Warehouse-1427"><span class="linenos">1427</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_suppliers</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">quantity</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">product</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Warehouse-1428"><a href="#Warehouse-1428"><span class="linenos">1428</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse-1429"><a href="#Warehouse-1429"><span class="linenos">1429</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Warehouse-1430"><a href="#Warehouse-1430"><span class="linenos">1430</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">buy_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="Warehouse-1431"><a href="#Warehouse-1431"><span class="linenos">1431</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span> <span class="o">=</span> <span class="n">num_suppliers</span>
</span><span id="Warehouse-1432"><a href="#Warehouse-1432"><span class="linenos">1432</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Warehouse-1433"><a href="#Warehouse-1433"><span class="linenos">1433</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="Warehouse-1434"><a href="#Warehouse-1434"><span class="linenos">1434</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of (supplier_jid, msg)</span>
</span><span id="Warehouse-1435"><a href="#Warehouse-1435"><span class="linenos">1435</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># List of (supplier_jid, msg, reason)</span>
</span><span id="Warehouse-1436"><a href="#Warehouse-1436"><span class="linenos">1436</span></a>            
</span><span id="Warehouse-1437"><a href="#Warehouse-1437"><span class="linenos">1437</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1438"><a href="#Warehouse-1438"><span class="linenos">1438</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-1439"><a href="#Warehouse-1439"><span class="linenos">1439</span></a>            
</span><span id="Warehouse-1440"><a href="#Warehouse-1440"><span class="linenos">1440</span></a>            <span class="c1"># Setup template that accepts BOTH supplier-accept AND supplier-reject</span>
</span><span id="Warehouse-1441"><a href="#Warehouse-1441"><span class="linenos">1441</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse-1442"><a href="#Warehouse-1442"><span class="linenos">1442</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse-1443"><a href="#Warehouse-1443"><span class="linenos">1443</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse-1444"><a href="#Warehouse-1444"><span class="linenos">1444</span></a>            <span class="c1"># Don&#39;t filter by performative - we want both accept and reject</span>
</span><span id="Warehouse-1445"><a href="#Warehouse-1445"><span class="linenos">1445</span></a>            
</span><span id="Warehouse-1446"><a href="#Warehouse-1446"><span class="linenos">1446</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1447"><a href="#Warehouse-1447"><span class="linenos">1447</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Setting up to receive supplier responses for request_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1448"><a href="#Warehouse-1448"><span class="linenos">1448</span></a>            
</span><span id="Warehouse-1449"><a href="#Warehouse-1449"><span class="linenos">1449</span></a>            <span class="c1"># Create a combined behaviour to listen for both</span>
</span><span id="Warehouse-1450"><a href="#Warehouse-1450"><span class="linenos">1450</span></a>            <span class="n">combined_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ReceiveAllSupplierResponses</span><span class="p">(</span>
</span><span id="Warehouse-1451"><a href="#Warehouse-1451"><span class="linenos">1451</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span id="Warehouse-1452"><a href="#Warehouse-1452"><span class="linenos">1452</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="p">,</span>
</span><span id="Warehouse-1453"><a href="#Warehouse-1453"><span class="linenos">1453</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">,</span>
</span><span id="Warehouse-1454"><a href="#Warehouse-1454"><span class="linenos">1454</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span>
</span><span id="Warehouse-1455"><a href="#Warehouse-1455"><span class="linenos">1455</span></a>            <span class="p">)</span>
</span><span id="Warehouse-1456"><a href="#Warehouse-1456"><span class="linenos">1456</span></a>            
</span><span id="Warehouse-1457"><a href="#Warehouse-1457"><span class="linenos">1457</span></a>            <span class="c1"># Add with template that matches both performatives</span>
</span><span id="Warehouse-1458"><a href="#Warehouse-1458"><span class="linenos">1458</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">combined_behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Warehouse-1459"><a href="#Warehouse-1459"><span class="linenos">1459</span></a>            
</span><span id="Warehouse-1460"><a href="#Warehouse-1460"><span class="linenos">1460</span></a>            <span class="c1"># Wait for collection to complete</span>
</span><span id="Warehouse-1461"><a href="#Warehouse-1461"><span class="linenos">1461</span></a>            <span class="k">await</span> <span class="n">combined_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse-1462"><a href="#Warehouse-1462"><span class="linenos">1462</span></a>            
</span><span id="Warehouse-1463"><a href="#Warehouse-1463"><span class="linenos">1463</span></a>            <span class="c1"># Now evaluate and choose best supplier</span>
</span><span id="Warehouse-1464"><a href="#Warehouse-1464"><span class="linenos">1464</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Warehouse-1465"><a href="#Warehouse-1465"><span class="linenos">1465</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1466"><a href="#Warehouse-1466"><span class="linenos">1466</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> acceptance(s) and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejection(s)&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1467"><a href="#Warehouse-1467"><span class="linenos">1467</span></a>                
</span><span id="Warehouse-1468"><a href="#Warehouse-1468"><span class="linenos">1468</span></a>                <span class="c1"># Calculate scores for each supplier that accepted</span>
</span><span id="Warehouse-1469"><a href="#Warehouse-1469"><span class="linenos">1469</span></a>                <span class="n">best_supplier</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Warehouse-1470"><a href="#Warehouse-1470"><span class="linenos">1470</span></a>                <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="Warehouse-1471"><a href="#Warehouse-1471"><span class="linenos">1471</span></a>                
</span><span id="Warehouse-1472"><a href="#Warehouse-1472"><span class="linenos">1472</span></a>                <span class="k">for</span> <span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Warehouse-1473"><a href="#Warehouse-1473"><span class="linenos">1473</span></a>                    <span class="n">score</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">calculate_supplier_score</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-1474"><a href="#Warehouse-1474"><span class="linenos">1474</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1475"><a href="#Warehouse-1475"><span class="linenos">1475</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Warehouse </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2"> score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1476"><a href="#Warehouse-1476"><span class="linenos">1476</span></a>                    
</span><span id="Warehouse-1477"><a href="#Warehouse-1477"><span class="linenos">1477</span></a>                    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">best_score</span><span class="p">:</span>
</span><span id="Warehouse-1478"><a href="#Warehouse-1478"><span class="linenos">1478</span></a>                        <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
</span><span id="Warehouse-1479"><a href="#Warehouse-1479"><span class="linenos">1479</span></a>                        <span class="n">best_supplier</span> <span class="o">=</span> <span class="p">(</span><span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-1480"><a href="#Warehouse-1480"><span class="linenos">1480</span></a>                
</span><span id="Warehouse-1481"><a href="#Warehouse-1481"><span class="linenos">1481</span></a>                <span class="k">if</span> <span class="n">best_supplier</span><span class="p">:</span>
</span><span id="Warehouse-1482"><a href="#Warehouse-1482"><span class="linenos">1482</span></a>                    <span class="n">supplier_jid</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="o">=</span> <span class="n">best_supplier</span>
</span><span id="Warehouse-1483"><a href="#Warehouse-1483"><span class="linenos">1483</span></a>                    <span class="c1"># Essential print - supplier selected</span>
</span><span id="Warehouse-1484"><a href="#Warehouse-1484"><span class="linenos">1484</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Selected supplier </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1485"><a href="#Warehouse-1485"><span class="linenos">1485</span></a>                    
</span><span id="Warehouse-1486"><a href="#Warehouse-1486"><span class="linenos">1486</span></a>                    <span class="c1"># Send confirmation to the chosen supplier</span>
</span><span id="Warehouse-1487"><a href="#Warehouse-1487"><span class="linenos">1487</span></a>                    <span class="n">confirm_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendWarehouseConfirmation</span><span class="p">(</span><span class="n">accept_msg</span><span class="p">)</span>
</span><span id="Warehouse-1488"><a href="#Warehouse-1488"><span class="linenos">1488</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">confirm_behav</span><span class="p">)</span>
</span><span id="Warehouse-1489"><a href="#Warehouse-1489"><span class="linenos">1489</span></a>                    <span class="k">await</span> <span class="n">confirm_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse-1490"><a href="#Warehouse-1490"><span class="linenos">1490</span></a>                    
</span><span id="Warehouse-1491"><a href="#Warehouse-1491"><span class="linenos">1491</span></a>                    <span class="c1"># Send denial to other suppliers that accepted but weren&#39;t chosen</span>
</span><span id="Warehouse-1492"><a href="#Warehouse-1492"><span class="linenos">1492</span></a>                    <span class="k">for</span> <span class="n">other_supplier_jid</span><span class="p">,</span> <span class="n">other_msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Warehouse-1493"><a href="#Warehouse-1493"><span class="linenos">1493</span></a>                        <span class="k">if</span> <span class="n">other_supplier_jid</span> <span class="o">!=</span> <span class="n">supplier_jid</span><span class="p">:</span>
</span><span id="Warehouse-1494"><a href="#Warehouse-1494"><span class="linenos">1494</span></a>                            <span class="n">deny_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendWarehouseDenial</span><span class="p">(</span><span class="n">other_msg</span><span class="p">)</span>
</span><span id="Warehouse-1495"><a href="#Warehouse-1495"><span class="linenos">1495</span></a>                            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">deny_behav</span><span class="p">)</span>
</span><span id="Warehouse-1496"><a href="#Warehouse-1496"><span class="linenos">1496</span></a>                            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1497"><a href="#Warehouse-1497"><span class="linenos">1497</span></a>                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent denial to </span><span class="si">{</span><span class="n">other_supplier_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1498"><a href="#Warehouse-1498"><span class="linenos">1498</span></a>                    
</span><span id="Warehouse-1499"><a href="#Warehouse-1499"><span class="linenos">1499</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-1500"><a href="#Warehouse-1500"><span class="linenos">1500</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1501"><a href="#Warehouse-1501"><span class="linenos">1501</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No acceptances received. All suppliers rejected or timed out.&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1502"><a href="#Warehouse-1502"><span class="linenos">1502</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Request saved in self.failed_requests&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1503"><a href="#Warehouse-1503"><span class="linenos">1503</span></a>                
</span><span id="Warehouse-1504"><a href="#Warehouse-1504"><span class="linenos">1504</span></a>                <span class="c1"># Add to failed requests</span>
</span><span id="Warehouse-1505"><a href="#Warehouse-1505"><span class="linenos">1505</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;current_buy_request&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span><span class="p">:</span>
</span><span id="Warehouse-1506"><a href="#Warehouse-1506"><span class="linenos">1506</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span><span class="p">)</span>
</span><span id="Warehouse-1507"><a href="#Warehouse-1507"><span class="linenos">1507</span></a>
</span><span id="Warehouse-1508"><a href="#Warehouse-1508"><span class="linenos">1508</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveAllSupplierResponses</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-1509"><a href="#Warehouse-1509"><span class="linenos">1509</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1510"><a href="#Warehouse-1510"><span class="linenos">1510</span></a><span class="sd">        Worker behaviour that collects supplier-accept and supplier-reject responses.</span>
</span><span id="Warehouse-1511"><a href="#Warehouse-1511"><span class="linenos">1511</span></a><span class="sd">        </span>
</span><span id="Warehouse-1512"><a href="#Warehouse-1512"><span class="linenos">1512</span></a><span class="sd">        Waits for responses from all suppliers (with timeout), categorizing them into</span>
</span><span id="Warehouse-1513"><a href="#Warehouse-1513"><span class="linenos">1513</span></a><span class="sd">        acceptances and rejections lists shared with CollectSupplierResponses coordinator.</span>
</span><span id="Warehouse-1514"><a href="#Warehouse-1514"><span class="linenos">1514</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1515"><a href="#Warehouse-1515"><span class="linenos">1515</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_suppliers</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">acceptances</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">rejections</span> <span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Warehouse-1516"><a href="#Warehouse-1516"><span class="linenos">1516</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse-1517"><a href="#Warehouse-1517"><span class="linenos">1517</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Warehouse-1518"><a href="#Warehouse-1518"><span class="linenos">1518</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span> <span class="o">=</span> <span class="n">num_suppliers</span>
</span><span id="Warehouse-1519"><a href="#Warehouse-1519"><span class="linenos">1519</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="n">acceptances</span>  <span class="c1"># Shared list</span>
</span><span id="Warehouse-1520"><a href="#Warehouse-1520"><span class="linenos">1520</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="n">rejections</span>    <span class="c1"># Shared list</span>
</span><span id="Warehouse-1521"><a href="#Warehouse-1521"><span class="linenos">1521</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Warehouse-1522"><a href="#Warehouse-1522"><span class="linenos">1522</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds to wait for all responses</span>
</span><span id="Warehouse-1523"><a href="#Warehouse-1523"><span class="linenos">1523</span></a>            
</span><span id="Warehouse-1524"><a href="#Warehouse-1524"><span class="linenos">1524</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1525"><a href="#Warehouse-1525"><span class="linenos">1525</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-1526"><a href="#Warehouse-1526"><span class="linenos">1526</span></a>            
</span><span id="Warehouse-1527"><a href="#Warehouse-1527"><span class="linenos">1527</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1528"><a href="#Warehouse-1528"><span class="linenos">1528</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ReceiveAllSupplierResponses starting - waiting for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="si">}</span><span class="s2"> responses (request_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1529"><a href="#Warehouse-1529"><span class="linenos">1529</span></a>            
</span><span id="Warehouse-1530"><a href="#Warehouse-1530"><span class="linenos">1530</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="Warehouse-1531"><a href="#Warehouse-1531"><span class="linenos">1531</span></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="Warehouse-1532"><a href="#Warehouse-1532"><span class="linenos">1532</span></a>            
</span><span id="Warehouse-1533"><a href="#Warehouse-1533"><span class="linenos">1533</span></a>            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="p">:</span>
</span><span id="Warehouse-1534"><a href="#Warehouse-1534"><span class="linenos">1534</span></a>                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="Warehouse-1535"><a href="#Warehouse-1535"><span class="linenos">1535</span></a>                <span class="n">remaining_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">-</span> <span class="n">elapsed</span>
</span><span id="Warehouse-1536"><a href="#Warehouse-1536"><span class="linenos">1536</span></a>                
</span><span id="Warehouse-1537"><a href="#Warehouse-1537"><span class="linenos">1537</span></a>                <span class="k">if</span> <span class="n">remaining_timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Warehouse-1538"><a href="#Warehouse-1538"><span class="linenos">1538</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1539"><a href="#Warehouse-1539"><span class="linenos">1539</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Timeout: Only received </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="si">}</span><span class="s2"> responses&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1540"><a href="#Warehouse-1540"><span class="linenos">1540</span></a>                    <span class="k">break</span>
</span><span id="Warehouse-1541"><a href="#Warehouse-1541"><span class="linenos">1541</span></a>                
</span><span id="Warehouse-1542"><a href="#Warehouse-1542"><span class="linenos">1542</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1543"><a href="#Warehouse-1543"><span class="linenos">1543</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Waiting for supplier response... (timeout=</span><span class="si">{</span><span class="n">remaining_timeout</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1544"><a href="#Warehouse-1544"><span class="linenos">1544</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">remaining_timeout</span><span class="p">)</span>
</span><span id="Warehouse-1545"><a href="#Warehouse-1545"><span class="linenos">1545</span></a>                
</span><span id="Warehouse-1546"><a href="#Warehouse-1546"><span class="linenos">1546</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse-1547"><a href="#Warehouse-1547"><span class="linenos">1547</span></a>                    <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1548"><a href="#Warehouse-1548"><span class="linenos">1548</span></a>                    <span class="n">supplier_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse-1549"><a href="#Warehouse-1549"><span class="linenos">1549</span></a>                    
</span><span id="Warehouse-1550"><a href="#Warehouse-1550"><span class="linenos">1550</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1551"><a href="#Warehouse-1551"><span class="linenos">1551</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received message from </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2"> with performative=</span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1552"><a href="#Warehouse-1552"><span class="linenos">1552</span></a>                    
</span><span id="Warehouse-1553"><a href="#Warehouse-1553"><span class="linenos">1553</span></a>                    <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;supplier-accept&quot;</span><span class="p">:</span>
</span><span id="Warehouse-1554"><a href="#Warehouse-1554"><span class="linenos">1554</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse-1555"><a href="#Warehouse-1555"><span class="linenos">1555</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse-1556"><a href="#Warehouse-1556"><span class="linenos">1556</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse-1557"><a href="#Warehouse-1557"><span class="linenos">1557</span></a>                        
</span><span id="Warehouse-1558"><a href="#Warehouse-1558"><span class="linenos">1558</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1559"><a href="#Warehouse-1559"><span class="linenos">1559</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received acceptance from </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1560"><a href="#Warehouse-1560"><span class="linenos">1560</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
</span><span id="Warehouse-1561"><a href="#Warehouse-1561"><span class="linenos">1561</span></a>                        
</span><span id="Warehouse-1562"><a href="#Warehouse-1562"><span class="linenos">1562</span></a>                    <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;supplier-reject&quot;</span><span class="p">:</span>
</span><span id="Warehouse-1563"><a href="#Warehouse-1563"><span class="linenos">1563</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse-1564"><a href="#Warehouse-1564"><span class="linenos">1564</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse-1565"><a href="#Warehouse-1565"><span class="linenos">1565</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse-1566"><a href="#Warehouse-1566"><span class="linenos">1566</span></a>                        <span class="n">reason</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
</span><span id="Warehouse-1567"><a href="#Warehouse-1567"><span class="linenos">1567</span></a>                        
</span><span id="Warehouse-1568"><a href="#Warehouse-1568"><span class="linenos">1568</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1569"><a href="#Warehouse-1569"><span class="linenos">1569</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received rejection from </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> (reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1570"><a href="#Warehouse-1570"><span class="linenos">1570</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
</span><span id="Warehouse-1571"><a href="#Warehouse-1571"><span class="linenos">1571</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-1572"><a href="#Warehouse-1572"><span class="linenos">1572</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1573"><a href="#Warehouse-1573"><span class="linenos">1573</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; WARNING: Received unknown performative: </span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1574"><a href="#Warehouse-1574"><span class="linenos">1574</span></a>                    
</span><span id="Warehouse-1575"><a href="#Warehouse-1575"><span class="linenos">1575</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse-1576"><a href="#Warehouse-1576"><span class="linenos">1576</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-1577"><a href="#Warehouse-1577"><span class="linenos">1577</span></a>                    <span class="c1"># No more messages, timeout</span>
</span><span id="Warehouse-1578"><a href="#Warehouse-1578"><span class="linenos">1578</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1579"><a href="#Warehouse-1579"><span class="linenos">1579</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No message received in timeout window&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1580"><a href="#Warehouse-1580"><span class="linenos">1580</span></a>                    <span class="k">break</span>
</span><span id="Warehouse-1581"><a href="#Warehouse-1581"><span class="linenos">1581</span></a>            
</span><span id="Warehouse-1582"><a href="#Warehouse-1582"><span class="linenos">1582</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1583"><a href="#Warehouse-1583"><span class="linenos">1583</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Finished collecting responses: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> accepts, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejects&quot;</span><span class="p">)</span>               
</span><span id="Warehouse-1584"><a href="#Warehouse-1584"><span class="linenos">1584</span></a>    
</span><span id="Warehouse-1585"><a href="#Warehouse-1585"><span class="linenos">1585</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SendWarehouseConfirmation</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-1586"><a href="#Warehouse-1586"><span class="linenos">1586</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1587"><a href="#Warehouse-1587"><span class="linenos">1587</span></a><span class="sd">        Sends warehouse-confirm (FIPA accept-proposal) to selected supplier.</span>
</span><span id="Warehouse-1588"><a href="#Warehouse-1588"><span class="linenos">1588</span></a><span class="sd">        </span>
</span><span id="Warehouse-1589"><a href="#Warehouse-1589"><span class="linenos">1589</span></a><span class="sd">        Awards the contract to the best supplier, updates stock immediately,</span>
</span><span id="Warehouse-1590"><a href="#Warehouse-1590"><span class="linenos">1590</span></a><span class="sd">        and notifies the supplier that their proposal was accepted.</span>
</span><span id="Warehouse-1591"><a href="#Warehouse-1591"><span class="linenos">1591</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1592"><a href="#Warehouse-1592"><span class="linenos">1592</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Warehouse-1593"><a href="#Warehouse-1593"><span class="linenos">1593</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse-1594"><a href="#Warehouse-1594"><span class="linenos">1594</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Warehouse-1595"><a href="#Warehouse-1595"><span class="linenos">1595</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1596"><a href="#Warehouse-1596"><span class="linenos">1596</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse-1597"><a href="#Warehouse-1597"><span class="linenos">1597</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse-1598"><a href="#Warehouse-1598"><span class="linenos">1598</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse-1599"><a href="#Warehouse-1599"><span class="linenos">1599</span></a>            
</span><span id="Warehouse-1600"><a href="#Warehouse-1600"><span class="linenos">1600</span></a>        
</span><span id="Warehouse-1601"><a href="#Warehouse-1601"><span class="linenos">1601</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1602"><a href="#Warehouse-1602"><span class="linenos">1602</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-1603"><a href="#Warehouse-1603"><span class="linenos">1603</span></a>            
</span><span id="Warehouse-1604"><a href="#Warehouse-1604"><span class="linenos">1604</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="Warehouse-1605"><a href="#Warehouse-1605"><span class="linenos">1605</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="Warehouse-1606"><a href="#Warehouse-1606"><span class="linenos">1606</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-1607"><a href="#Warehouse-1607"><span class="linenos">1607</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>           
</span><span id="Warehouse-1608"><a href="#Warehouse-1608"><span class="linenos">1608</span></a>            
</span><span id="Warehouse-1609"><a href="#Warehouse-1609"><span class="linenos">1609</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="Warehouse-1610"><a href="#Warehouse-1610"><span class="linenos">1610</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-confirm&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1611"><a href="#Warehouse-1611"><span class="linenos">1611</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;supplier_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="Warehouse-1612"><a href="#Warehouse-1612"><span class="linenos">1612</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse-1613"><a href="#Warehouse-1613"><span class="linenos">1613</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse-1614"><a href="#Warehouse-1614"><span class="linenos">1614</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse-1615"><a href="#Warehouse-1615"><span class="linenos">1615</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse-1616"><a href="#Warehouse-1616"><span class="linenos">1616</span></a>            
</span><span id="Warehouse-1617"><a href="#Warehouse-1617"><span class="linenos">1617</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-1618"><a href="#Warehouse-1618"><span class="linenos">1618</span></a>            
</span><span id="Warehouse-1619"><a href="#Warehouse-1619"><span class="linenos">1619</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1620"><a href="#Warehouse-1620"><span class="linenos">1620</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Confirmation sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1621"><a href="#Warehouse-1621"><span class="linenos">1621</span></a>    
</span><span id="Warehouse-1622"><a href="#Warehouse-1622"><span class="linenos">1622</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SendWarehouseDenial</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-1623"><a href="#Warehouse-1623"><span class="linenos">1623</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1624"><a href="#Warehouse-1624"><span class="linenos">1624</span></a><span class="sd">        Sends warehouse-deny (FIPA reject-proposal) to non-selected suppliers.</span>
</span><span id="Warehouse-1625"><a href="#Warehouse-1625"><span class="linenos">1625</span></a><span class="sd">        </span>
</span><span id="Warehouse-1626"><a href="#Warehouse-1626"><span class="linenos">1626</span></a><span class="sd">        Notifies suppliers that their proposal was not accepted, allowing them</span>
</span><span id="Warehouse-1627"><a href="#Warehouse-1627"><span class="linenos">1627</span></a><span class="sd">        to release any resources they may have reserved.</span>
</span><span id="Warehouse-1628"><a href="#Warehouse-1628"><span class="linenos">1628</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1629"><a href="#Warehouse-1629"><span class="linenos">1629</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Warehouse-1630"><a href="#Warehouse-1630"><span class="linenos">1630</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse-1631"><a href="#Warehouse-1631"><span class="linenos">1631</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Warehouse-1632"><a href="#Warehouse-1632"><span class="linenos">1632</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1633"><a href="#Warehouse-1633"><span class="linenos">1633</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse-1634"><a href="#Warehouse-1634"><span class="linenos">1634</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse-1635"><a href="#Warehouse-1635"><span class="linenos">1635</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse-1636"><a href="#Warehouse-1636"><span class="linenos">1636</span></a>        
</span><span id="Warehouse-1637"><a href="#Warehouse-1637"><span class="linenos">1637</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1638"><a href="#Warehouse-1638"><span class="linenos">1638</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-1639"><a href="#Warehouse-1639"><span class="linenos">1639</span></a>            
</span><span id="Warehouse-1640"><a href="#Warehouse-1640"><span class="linenos">1640</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="Warehouse-1641"><a href="#Warehouse-1641"><span class="linenos">1641</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-deny&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1642"><a href="#Warehouse-1642"><span class="linenos">1642</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;supplier_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="Warehouse-1643"><a href="#Warehouse-1643"><span class="linenos">1643</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse-1644"><a href="#Warehouse-1644"><span class="linenos">1644</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse-1645"><a href="#Warehouse-1645"><span class="linenos">1645</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse-1646"><a href="#Warehouse-1646"><span class="linenos">1646</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse-1647"><a href="#Warehouse-1647"><span class="linenos">1647</span></a>            
</span><span id="Warehouse-1648"><a href="#Warehouse-1648"><span class="linenos">1648</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-1649"><a href="#Warehouse-1649"><span class="linenos">1649</span></a>            
</span><span id="Warehouse-1650"><a href="#Warehouse-1650"><span class="linenos">1650</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1651"><a href="#Warehouse-1651"><span class="linenos">1651</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Denial sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1652"><a href="#Warehouse-1652"><span class="linenos">1652</span></a>    
</span><span id="Warehouse-1653"><a href="#Warehouse-1653"><span class="linenos">1653</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">RetryPreviousBuy</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-1654"><a href="#Warehouse-1654"><span class="linenos">1654</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1655"><a href="#Warehouse-1655"><span class="linenos">1655</span></a><span class="sd">        Retries failed supplier purchase requests from the failed_requests queue.</span>
</span><span id="Warehouse-1656"><a href="#Warehouse-1656"><span class="linenos">1656</span></a><span class="sd">        </span>
</span><span id="Warehouse-1657"><a href="#Warehouse-1657"><span class="linenos">1657</span></a><span class="sd">        Dequeues one failed request and re-initiates the FIPA Contract Net Protocol</span>
</span><span id="Warehouse-1658"><a href="#Warehouse-1658"><span class="linenos">1658</span></a><span class="sd">        with suppliers, reusing the same request_id for traceability.</span>
</span><span id="Warehouse-1659"><a href="#Warehouse-1659"><span class="linenos">1659</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1660"><a href="#Warehouse-1660"><span class="linenos">1660</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1661"><a href="#Warehouse-1661"><span class="linenos">1661</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-1662"><a href="#Warehouse-1662"><span class="linenos">1662</span></a>            
</span><span id="Warehouse-1663"><a href="#Warehouse-1663"><span class="linenos">1663</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="Warehouse-1664"><a href="#Warehouse-1664"><span class="linenos">1664</span></a>                <span class="n">request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="Warehouse-1665"><a href="#Warehouse-1665"><span class="linenos">1665</span></a>                <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse-1666"><a href="#Warehouse-1666"><span class="linenos">1666</span></a>                
</span><span id="Warehouse-1667"><a href="#Warehouse-1667"><span class="linenos">1667</span></a>                <span class="c1"># Parse quantity and product from request body</span>
</span><span id="Warehouse-1668"><a href="#Warehouse-1668"><span class="linenos">1668</span></a>                <span class="n">parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse-1669"><a href="#Warehouse-1669"><span class="linenos">1669</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse-1670"><a href="#Warehouse-1670"><span class="linenos">1670</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse-1671"><a href="#Warehouse-1671"><span class="linenos">1671</span></a>                
</span><span id="Warehouse-1672"><a href="#Warehouse-1672"><span class="linenos">1672</span></a>                <span class="c1"># Only send to suppliers, not all contacts</span>
</span><span id="Warehouse-1673"><a href="#Warehouse-1673"><span class="linenos">1673</span></a>                <span class="n">num_suppliers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">)</span>
</span><span id="Warehouse-1674"><a href="#Warehouse-1674"><span class="linenos">1674</span></a>                
</span><span id="Warehouse-1675"><a href="#Warehouse-1675"><span class="linenos">1675</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Warehouse-1676"><a href="#Warehouse-1676"><span class="linenos">1676</span></a>                <span class="k">for</span> <span class="n">supplier_jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="Warehouse-1677"><a href="#Warehouse-1677"><span class="linenos">1677</span></a>                    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">supplier_jid</span><span class="p">)</span>
</span><span id="Warehouse-1678"><a href="#Warehouse-1678"><span class="linenos">1678</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-buy&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1679"><a href="#Warehouse-1679"><span class="linenos">1679</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse-1680"><a href="#Warehouse-1680"><span class="linenos">1680</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse-1681"><a href="#Warehouse-1681"><span class="linenos">1681</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse-1682"><a href="#Warehouse-1682"><span class="linenos">1682</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
</span><span id="Warehouse-1683"><a href="#Warehouse-1683"><span class="linenos">1683</span></a>
</span><span id="Warehouse-1684"><a href="#Warehouse-1684"><span class="linenos">1684</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-1685"><a href="#Warehouse-1685"><span class="linenos">1685</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Retrying request (id=</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="Warehouse-1686"><a href="#Warehouse-1686"><span class="linenos">1686</span></a>                              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1687"><a href="#Warehouse-1687"><span class="linenos">1687</span></a>
</span><span id="Warehouse-1688"><a href="#Warehouse-1688"><span class="linenos">1688</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse-1689"><a href="#Warehouse-1689"><span class="linenos">1689</span></a>
</span><span id="Warehouse-1690"><a href="#Warehouse-1690"><span class="linenos">1690</span></a>                <span class="c1"># Use CollectSupplierResponses with all required parameters</span>
</span><span id="Warehouse-1691"><a href="#Warehouse-1691"><span class="linenos">1691</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse-1692"><a href="#Warehouse-1692"><span class="linenos">1692</span></a>                    <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectSupplierResponses</span><span class="p">(</span>
</span><span id="Warehouse-1693"><a href="#Warehouse-1693"><span class="linenos">1693</span></a>                        <span class="n">msg</span><span class="p">,</span>
</span><span id="Warehouse-1694"><a href="#Warehouse-1694"><span class="linenos">1694</span></a>                        <span class="n">request_id</span><span class="p">,</span>
</span><span id="Warehouse-1695"><a href="#Warehouse-1695"><span class="linenos">1695</span></a>                        <span class="n">num_suppliers</span><span class="p">,</span>
</span><span id="Warehouse-1696"><a href="#Warehouse-1696"><span class="linenos">1696</span></a>                        <span class="n">quantity</span><span class="p">,</span>
</span><span id="Warehouse-1697"><a href="#Warehouse-1697"><span class="linenos">1697</span></a>                        <span class="n">product</span>
</span><span id="Warehouse-1698"><a href="#Warehouse-1698"><span class="linenos">1698</span></a>                    <span class="p">)</span>
</span><span id="Warehouse-1699"><a href="#Warehouse-1699"><span class="linenos">1699</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Warehouse-1700"><a href="#Warehouse-1700"><span class="linenos">1700</span></a>
</span><span id="Warehouse-1701"><a href="#Warehouse-1701"><span class="linenos">1701</span></a>                    <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse-1702"><a href="#Warehouse-1702"><span class="linenos">1702</span></a>    
</span><span id="Warehouse-1703"><a href="#Warehouse-1703"><span class="linenos">1703</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">HandleResupply</span><span class="p">(</span><span class="n">PeriodicBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-1704"><a href="#Warehouse-1704"><span class="linenos">1704</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1705"><a href="#Warehouse-1705"><span class="linenos">1705</span></a><span class="sd">        Periodic behaviour that monitors stock levels and triggers restocking.</span>
</span><span id="Warehouse-1706"><a href="#Warehouse-1706"><span class="linenos">1706</span></a><span class="sd">        </span>
</span><span id="Warehouse-1707"><a href="#Warehouse-1707"><span class="linenos">1707</span></a><span class="sd">        Checks each product&#39;s stock against WAREHOUSE_RESUPPLY_THRESHOLD and</span>
</span><span id="Warehouse-1708"><a href="#Warehouse-1708"><span class="linenos">1708</span></a><span class="sd">        launches BuyMaterial behaviour when inventory falls below threshold.</span>
</span><span id="Warehouse-1709"><a href="#Warehouse-1709"><span class="linenos">1709</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1710"><a href="#Warehouse-1710"><span class="linenos">1710</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1711"><a href="#Warehouse-1711"><span class="linenos">1711</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-1712"><a href="#Warehouse-1712"><span class="linenos">1712</span></a>            
</span><span id="Warehouse-1713"><a href="#Warehouse-1713"><span class="linenos">1713</span></a>            <span class="c1"># Check stock levels</span>
</span><span id="Warehouse-1714"><a href="#Warehouse-1714"><span class="linenos">1714</span></a>            <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Warehouse-1715"><a href="#Warehouse-1715"><span class="linenos">1715</span></a>                <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_RESUPPLY_THRESHOLD</span><span class="p">:</span>
</span><span id="Warehouse-1716"><a href="#Warehouse-1716"><span class="linenos">1716</span></a>                    <span class="c1"># Need to restock this product</span>
</span><span id="Warehouse-1717"><a href="#Warehouse-1717"><span class="linenos">1717</span></a>                    <span class="n">restock_amount</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span> <span class="o">-</span> <span class="n">amount</span>
</span><span id="Warehouse-1718"><a href="#Warehouse-1718"><span class="linenos">1718</span></a>                    <span class="c1"># Essential print - warehouse restocking</span>
</span><span id="Warehouse-1719"><a href="#Warehouse-1719"><span class="linenos">1719</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Restocking </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span><span class="si">}</span><span class="s2"> (buying </span><span class="si">{</span><span class="n">restock_amount</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1720"><a href="#Warehouse-1720"><span class="linenos">1720</span></a>                    
</span><span id="Warehouse-1721"><a href="#Warehouse-1721"><span class="linenos">1721</span></a>                    <span class="n">buy_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">BuyMaterial</span><span class="p">(</span><span class="n">restock_amount</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
</span><span id="Warehouse-1722"><a href="#Warehouse-1722"><span class="linenos">1722</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">buy_behav</span><span class="p">)</span>
</span><span id="Warehouse-1723"><a href="#Warehouse-1723"><span class="linenos">1723</span></a>                    
</span><span id="Warehouse-1724"><a href="#Warehouse-1724"><span class="linenos">1724</span></a>                    <span class="k">await</span> <span class="n">buy_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse-1725"><a href="#Warehouse-1725"><span class="linenos">1725</span></a>    
</span><span id="Warehouse-1726"><a href="#Warehouse-1726"><span class="linenos">1726</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Warehouse-1727"><a href="#Warehouse-1727"><span class="linenos">1727</span></a>    <span class="c1">#         COMMON / OTHER BEHAVIORS</span>
</span><span id="Warehouse-1728"><a href="#Warehouse-1728"><span class="linenos">1728</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Warehouse-1729"><a href="#Warehouse-1729"><span class="linenos">1729</span></a>
</span><span id="Warehouse-1730"><a href="#Warehouse-1730"><span class="linenos">1730</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveVehicleArrival</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-1731"><a href="#Warehouse-1731"><span class="linenos">1731</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1732"><a href="#Warehouse-1732"><span class="linenos">1732</span></a><span class="sd">        Cyclic behaviour that processes vehicle pickup and delivery notifications.</span>
</span><span id="Warehouse-1733"><a href="#Warehouse-1733"><span class="linenos">1733</span></a><span class="sd">        </span>
</span><span id="Warehouse-1734"><a href="#Warehouse-1734"><span class="linenos">1734</span></a><span class="sd">        Handles vehicle-pickup messages (vehicle collects order from warehouse) and</span>
</span><span id="Warehouse-1735"><a href="#Warehouse-1735"><span class="linenos">1735</span></a><span class="sd">        vehicle-delivery messages (vehicle delivers supplies from supplier), updating</span>
</span><span id="Warehouse-1736"><a href="#Warehouse-1736"><span class="linenos">1736</span></a><span class="sd">        pending_deliveries and stock accordingly.</span>
</span><span id="Warehouse-1737"><a href="#Warehouse-1737"><span class="linenos">1737</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1738"><a href="#Warehouse-1738"><span class="linenos">1738</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1739"><a href="#Warehouse-1739"><span class="linenos">1739</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-1740"><a href="#Warehouse-1740"><span class="linenos">1740</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Warehouse-1741"><a href="#Warehouse-1741"><span class="linenos">1741</span></a>            
</span><span id="Warehouse-1742"><a href="#Warehouse-1742"><span class="linenos">1742</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse-1743"><a href="#Warehouse-1743"><span class="linenos">1743</span></a>                <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1744"><a href="#Warehouse-1744"><span class="linenos">1744</span></a>                
</span><span id="Warehouse-1745"><a href="#Warehouse-1745"><span class="linenos">1745</span></a>                <span class="c1"># Double-check (should already be filtered by templates)</span>
</span><span id="Warehouse-1746"><a href="#Warehouse-1746"><span class="linenos">1746</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">]:</span>
</span><span id="Warehouse-1747"><a href="#Warehouse-1747"><span class="linenos">1747</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Received unexpected performative &#39;</span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1748"><a href="#Warehouse-1748"><span class="linenos">1748</span></a>                    <span class="k">return</span>
</span><span id="Warehouse-1749"><a href="#Warehouse-1749"><span class="linenos">1749</span></a>                
</span><span id="Warehouse-1750"><a href="#Warehouse-1750"><span class="linenos">1750</span></a>                <span class="c1"># Parse message body</span>
</span><span id="Warehouse-1751"><a href="#Warehouse-1751"><span class="linenos">1751</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Warehouse-1752"><a href="#Warehouse-1752"><span class="linenos">1752</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Warehouse-1753"><a href="#Warehouse-1753"><span class="linenos">1753</span></a>                    <span class="n">orderid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">]</span>
</span><span id="Warehouse-1754"><a href="#Warehouse-1754"><span class="linenos">1754</span></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">orderid</span><span class="p">]</span> 
</span><span id="Warehouse-1755"><a href="#Warehouse-1755"><span class="linenos">1755</span></a>                <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Warehouse-1756"><a href="#Warehouse-1756"><span class="linenos">1756</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Failed to parse vehicle message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1757"><a href="#Warehouse-1757"><span class="linenos">1757</span></a>                    <span class="k">return</span>
</span><span id="Warehouse-1758"><a href="#Warehouse-1758"><span class="linenos">1758</span></a>                
</span><span id="Warehouse-1759"><a href="#Warehouse-1759"><span class="linenos">1759</span></a>                <span class="c1"># Handle based on performative</span>
</span><span id="Warehouse-1760"><a href="#Warehouse-1760"><span class="linenos">1760</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">:</span>
</span><span id="Warehouse-1761"><a href="#Warehouse-1761"><span class="linenos">1761</span></a>                    <span class="c1"># Vehicle is picking up an order to deliver to store</span>
</span><span id="Warehouse-1762"><a href="#Warehouse-1762"><span class="linenos">1762</span></a>                    <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">:</span>
</span><span id="Warehouse-1763"><a href="#Warehouse-1763"><span class="linenos">1763</span></a>                        <span class="k">del</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span>
</span><span id="Warehouse-1764"><a href="#Warehouse-1764"><span class="linenos">1764</span></a>                        <span class="c1"># Essential print - vehicle pickup</span>
</span><span id="Warehouse-1765"><a href="#Warehouse-1765"><span class="linenos">1765</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> picked up order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse-1766"><a href="#Warehouse-1766"><span class="linenos">1766</span></a>                            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1767"><a href="#Warehouse-1767"><span class="linenos">1767</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-1768"><a href="#Warehouse-1768"><span class="linenos">1768</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2"> not found in pending orders!&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1769"><a href="#Warehouse-1769"><span class="linenos">1769</span></a>                
</span><span id="Warehouse-1770"><a href="#Warehouse-1770"><span class="linenos">1770</span></a>                <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">:</span>
</span><span id="Warehouse-1771"><a href="#Warehouse-1771"><span class="linenos">1771</span></a>                    <span class="c1"># Vehicle is delivering supplies from supplier</span>
</span><span id="Warehouse-1772"><a href="#Warehouse-1772"><span class="linenos">1772</span></a>                    <span class="n">product</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span>
</span><span id="Warehouse-1773"><a href="#Warehouse-1773"><span class="linenos">1773</span></a>                    <span class="n">quantity</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="Warehouse-1774"><a href="#Warehouse-1774"><span class="linenos">1774</span></a>                    
</span><span id="Warehouse-1775"><a href="#Warehouse-1775"><span class="linenos">1775</span></a>                    <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="Warehouse-1776"><a href="#Warehouse-1776"><span class="linenos">1776</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="Warehouse-1777"><a href="#Warehouse-1777"><span class="linenos">1777</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-1778"><a href="#Warehouse-1778"><span class="linenos">1778</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Warehouse-1779"><a href="#Warehouse-1779"><span class="linenos">1779</span></a>                    
</span><span id="Warehouse-1780"><a href="#Warehouse-1780"><span class="linenos">1780</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> delivered </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1781"><a href="#Warehouse-1781"><span class="linenos">1781</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>                            
</span><span id="Warehouse-1782"><a href="#Warehouse-1782"><span class="linenos">1782</span></a>    
</span><span id="Warehouse-1783"><a href="#Warehouse-1783"><span class="linenos">1783</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveTimeDelta</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="Warehouse-1784"><a href="#Warehouse-1784"><span class="linenos">1784</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1785"><a href="#Warehouse-1785"><span class="linenos">1785</span></a><span class="sd">        Cyclic behaviour that synchronizes simulation time and applies traffic updates.</span>
</span><span id="Warehouse-1786"><a href="#Warehouse-1786"><span class="linenos">1786</span></a><span class="sd">        </span>
</span><span id="Warehouse-1787"><a href="#Warehouse-1787"><span class="linenos">1787</span></a><span class="sd">        Receives time delta messages from world agent, updates current_tick, and</span>
</span><span id="Warehouse-1788"><a href="#Warehouse-1788"><span class="linenos">1788</span></a><span class="sd">        applies dynamic graph edge weight changes for traffic simulation.</span>
</span><span id="Warehouse-1789"><a href="#Warehouse-1789"><span class="linenos">1789</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1790"><a href="#Warehouse-1790"><span class="linenos">1790</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1791"><a href="#Warehouse-1791"><span class="linenos">1791</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse-1792"><a href="#Warehouse-1792"><span class="linenos">1792</span></a>            
</span><span id="Warehouse-1793"><a href="#Warehouse-1793"><span class="linenos">1793</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Warehouse-1794"><a href="#Warehouse-1794"><span class="linenos">1794</span></a>            
</span><span id="Warehouse-1795"><a href="#Warehouse-1795"><span class="linenos">1795</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Warehouse-1796"><a href="#Warehouse-1796"><span class="linenos">1796</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Warehouse-1797"><a href="#Warehouse-1797"><span class="linenos">1797</span></a>                
</span><span id="Warehouse-1798"><a href="#Warehouse-1798"><span class="linenos">1798</span></a>                <span class="nb">type</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="Warehouse-1799"><a href="#Warehouse-1799"><span class="linenos">1799</span></a>                <span class="n">delta</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
</span><span id="Warehouse-1800"><a href="#Warehouse-1800"><span class="linenos">1800</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="Warehouse-1801"><a href="#Warehouse-1801"><span class="linenos">1801</span></a>                
</span><span id="Warehouse-1802"><a href="#Warehouse-1802"><span class="linenos">1802</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;arrival&quot;</span><span class="p">:</span>
</span><span id="Warehouse-1803"><a href="#Warehouse-1803"><span class="linenos">1803</span></a>                    <span class="n">map_updates</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> 
</span><span id="Warehouse-1804"><a href="#Warehouse-1804"><span class="linenos">1804</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">update_graph</span><span class="p">(</span><span class="n">map_updates</span><span class="p">)</span>
</span><span id="Warehouse-1805"><a href="#Warehouse-1805"><span class="linenos">1805</span></a>    
</span><span id="Warehouse-1806"><a href="#Warehouse-1806"><span class="linenos">1806</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Warehouse-1807"><a href="#Warehouse-1807"><span class="linenos">1807</span></a>    <span class="c1">#           AUXILARY FUNCTIONS</span>
</span><span id="Warehouse-1808"><a href="#Warehouse-1808"><span class="linenos">1808</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Warehouse-1809"><a href="#Warehouse-1809"><span class="linenos">1809</span></a>    
</span><span id="Warehouse-1810"><a href="#Warehouse-1810"><span class="linenos">1810</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_supplier_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Warehouse-1811"><a href="#Warehouse-1811"><span class="linenos">1811</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1812"><a href="#Warehouse-1812"><span class="linenos">1812</span></a><span class="sd">        Calculate supplier score based on delivery time (used in FIPA supplier selection).</span>
</span><span id="Warehouse-1813"><a href="#Warehouse-1813"><span class="linenos">1813</span></a><span class="sd">        </span>
</span><span id="Warehouse-1814"><a href="#Warehouse-1814"><span class="linenos">1814</span></a><span class="sd">        This function evaluates supplier proposals in the FIPA Contract Net Protocol</span>
</span><span id="Warehouse-1815"><a href="#Warehouse-1815"><span class="linenos">1815</span></a><span class="sd">        by computing the estimated delivery time from supplier to warehouse using</span>
</span><span id="Warehouse-1816"><a href="#Warehouse-1816"><span class="linenos">1816</span></a><span class="sd">        Dijkstra&#39;s algorithm on the world graph. Lower scores indicate faster delivery.</span>
</span><span id="Warehouse-1817"><a href="#Warehouse-1817"><span class="linenos">1817</span></a><span class="sd">        </span>
</span><span id="Warehouse-1818"><a href="#Warehouse-1818"><span class="linenos">1818</span></a><span class="sd">        FIPA Protocol Context:</span>
</span><span id="Warehouse-1819"><a href="#Warehouse-1819"><span class="linenos">1819</span></a><span class="sd">            - Phase: Proposal Evaluation (Initiator evaluating participants)</span>
</span><span id="Warehouse-1820"><a href="#Warehouse-1820"><span class="linenos">1820</span></a><span class="sd">            - Used by: CollectSupplierResponses and ReceiveAllSupplierResponses</span>
</span><span id="Warehouse-1821"><a href="#Warehouse-1821"><span class="linenos">1821</span></a><span class="sd">            - Purpose: Select best supplier from multiple proposals</span>
</span><span id="Warehouse-1822"><a href="#Warehouse-1822"><span class="linenos">1822</span></a><span class="sd">        </span>
</span><span id="Warehouse-1823"><a href="#Warehouse-1823"><span class="linenos">1823</span></a><span class="sd">        Scoring Algorithm:</span>
</span><span id="Warehouse-1824"><a href="#Warehouse-1824"><span class="linenos">1824</span></a><span class="sd">            1. Extract supplier&#39;s node_id from message metadata</span>
</span><span id="Warehouse-1825"><a href="#Warehouse-1825"><span class="linenos">1825</span></a><span class="sd">            2. Run Dijkstra&#39;s algorithm: supplier_node  warehouse_node</span>
</span><span id="Warehouse-1826"><a href="#Warehouse-1826"><span class="linenos">1826</span></a><span class="sd">            3. Return estimated travel time as score</span>
</span><span id="Warehouse-1827"><a href="#Warehouse-1827"><span class="linenos">1827</span></a><span class="sd">            4. Lower score = shorter delivery time = better supplier</span>
</span><span id="Warehouse-1828"><a href="#Warehouse-1828"><span class="linenos">1828</span></a><span class="sd">        </span>
</span><span id="Warehouse-1829"><a href="#Warehouse-1829"><span class="linenos">1829</span></a><span class="sd">        Args:</span>
</span><span id="Warehouse-1830"><a href="#Warehouse-1830"><span class="linenos">1830</span></a><span class="sd">            accept_msg (Message): supplier-accept message containing:</span>
</span><span id="Warehouse-1831"><a href="#Warehouse-1831"><span class="linenos">1831</span></a><span class="sd">                - Metadata: &quot;node_id&quot; (supplier&#39;s graph location)</span>
</span><span id="Warehouse-1832"><a href="#Warehouse-1832"><span class="linenos">1832</span></a><span class="sd">                - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse-1833"><a href="#Warehouse-1833"><span class="linenos">1833</span></a><span class="sd">        </span>
</span><span id="Warehouse-1834"><a href="#Warehouse-1834"><span class="linenos">1834</span></a><span class="sd">        Returns:</span>
</span><span id="Warehouse-1835"><a href="#Warehouse-1835"><span class="linenos">1835</span></a><span class="sd">            float: Estimated delivery time (seconds). Lower is better.</span>
</span><span id="Warehouse-1836"><a href="#Warehouse-1836"><span class="linenos">1836</span></a><span class="sd">        </span>
</span><span id="Warehouse-1837"><a href="#Warehouse-1837"><span class="linenos">1837</span></a><span class="sd">        Example:</span>
</span><span id="Warehouse-1838"><a href="#Warehouse-1838"><span class="linenos">1838</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1839"><a href="#Warehouse-1839"><span class="linenos">1839</span></a><span class="sd">            Warehouse at node 10</span>
</span><span id="Warehouse-1840"><a href="#Warehouse-1840"><span class="linenos">1840</span></a><span class="sd">            Supplier1 at node 5: delivery_time = 120s</span>
</span><span id="Warehouse-1841"><a href="#Warehouse-1841"><span class="linenos">1841</span></a><span class="sd">            Supplier2 at node 8: delivery_time = 85s</span>
</span><span id="Warehouse-1842"><a href="#Warehouse-1842"><span class="linenos">1842</span></a><span class="sd">            </span>
</span><span id="Warehouse-1843"><a href="#Warehouse-1843"><span class="linenos">1843</span></a><span class="sd">            calculate_supplier_score(supplier1_msg)  120.0</span>
</span><span id="Warehouse-1844"><a href="#Warehouse-1844"><span class="linenos">1844</span></a><span class="sd">            calculate_supplier_score(supplier2_msg)  85.0</span>
</span><span id="Warehouse-1845"><a href="#Warehouse-1845"><span class="linenos">1845</span></a><span class="sd">            </span>
</span><span id="Warehouse-1846"><a href="#Warehouse-1846"><span class="linenos">1846</span></a><span class="sd">            Winner: Supplier2 (lower score)</span>
</span><span id="Warehouse-1847"><a href="#Warehouse-1847"><span class="linenos">1847</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1848"><a href="#Warehouse-1848"><span class="linenos">1848</span></a><span class="sd">        </span>
</span><span id="Warehouse-1849"><a href="#Warehouse-1849"><span class="linenos">1849</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse-1850"><a href="#Warehouse-1850"><span class="linenos">1850</span></a><span class="sd">            Currently uses time as the scoring metric. Could be extended to use</span>
</span><span id="Warehouse-1851"><a href="#Warehouse-1851"><span class="linenos">1851</span></a><span class="sd">            fuel cost or a weighted combination of multiple factors.</span>
</span><span id="Warehouse-1852"><a href="#Warehouse-1852"><span class="linenos">1852</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1853"><a href="#Warehouse-1853"><span class="linenos">1853</span></a>        
</span><span id="Warehouse-1854"><a href="#Warehouse-1854"><span class="linenos">1854</span></a>        <span class="n">supplier_node_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">accept_msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse-1855"><a href="#Warehouse-1855"><span class="linenos">1855</span></a>        <span class="n">path</span><span class="p">,</span> <span class="n">fuel</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">djikstra</span><span class="p">(</span><span class="n">supplier_node_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="Warehouse-1856"><a href="#Warehouse-1856"><span class="linenos">1856</span></a>        
</span><span id="Warehouse-1857"><a href="#Warehouse-1857"><span class="linenos">1857</span></a>        <span class="k">return</span> <span class="n">time</span>  <span class="c1"># Use time as score (could also use fuel)</span>
</span><span id="Warehouse-1858"><a href="#Warehouse-1858"><span class="linenos">1858</span></a>
</span><span id="Warehouse-1859"><a href="#Warehouse-1859"><span class="linenos">1859</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">message_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
</span><span id="Warehouse-1860"><a href="#Warehouse-1860"><span class="linenos">1860</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1861"><a href="#Warehouse-1861"><span class="linenos">1861</span></a><span class="sd">        Convert store-confirm message to Order object for delivery tracking.</span>
</span><span id="Warehouse-1862"><a href="#Warehouse-1862"><span class="linenos">1862</span></a><span class="sd">        </span>
</span><span id="Warehouse-1863"><a href="#Warehouse-1863"><span class="linenos">1863</span></a><span class="sd">        This helper function transforms a FIPA accept-proposal message from a store</span>
</span><span id="Warehouse-1864"><a href="#Warehouse-1864"><span class="linenos">1864</span></a><span class="sd">        into a structured Order object that can be stored in pending_deliveries</span>
</span><span id="Warehouse-1865"><a href="#Warehouse-1865"><span class="linenos">1865</span></a><span class="sd">        and assigned to vehicles for transportation.</span>
</span><span id="Warehouse-1866"><a href="#Warehouse-1866"><span class="linenos">1866</span></a><span class="sd">        </span>
</span><span id="Warehouse-1867"><a href="#Warehouse-1867"><span class="linenos">1867</span></a><span class="sd">        FIPA Protocol Context:</span>
</span><span id="Warehouse-1868"><a href="#Warehouse-1868"><span class="linenos">1868</span></a><span class="sd">            - Triggered by: store-confirm message (FIPA accept-proposal)</span>
</span><span id="Warehouse-1869"><a href="#Warehouse-1869"><span class="linenos">1869</span></a><span class="sd">            - Used by: ReceiveConfirmationOrDenial behaviour</span>
</span><span id="Warehouse-1870"><a href="#Warehouse-1870"><span class="linenos">1870</span></a><span class="sd">            - Purpose: Create deliverable order from confirmed proposal</span>
</span><span id="Warehouse-1871"><a href="#Warehouse-1871"><span class="linenos">1871</span></a><span class="sd">        </span>
</span><span id="Warehouse-1872"><a href="#Warehouse-1872"><span class="linenos">1872</span></a><span class="sd">        Message Parsing:</span>
</span><span id="Warehouse-1873"><a href="#Warehouse-1873"><span class="linenos">1873</span></a><span class="sd">            Body Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse-1874"><a href="#Warehouse-1874"><span class="linenos">1874</span></a><span class="sd">            Example: &quot;50 electronics&quot;</span>
</span><span id="Warehouse-1875"><a href="#Warehouse-1875"><span class="linenos">1875</span></a><span class="sd">            </span>
</span><span id="Warehouse-1876"><a href="#Warehouse-1876"><span class="linenos">1876</span></a><span class="sd">            Metadata Extracted:</span>
</span><span id="Warehouse-1877"><a href="#Warehouse-1877"><span class="linenos">1877</span></a><span class="sd">                - request_id: Unique order identifier</span>
</span><span id="Warehouse-1878"><a href="#Warehouse-1878"><span class="linenos">1878</span></a><span class="sd">                - node_id: Store&#39;s graph location (delivery destination)</span>
</span><span id="Warehouse-1879"><a href="#Warehouse-1879"><span class="linenos">1879</span></a><span class="sd">        </span>
</span><span id="Warehouse-1880"><a href="#Warehouse-1880"><span class="linenos">1880</span></a><span class="sd">        Args:</span>
</span><span id="Warehouse-1881"><a href="#Warehouse-1881"><span class="linenos">1881</span></a><span class="sd">            msg (Message): store-confirm message with:</span>
</span><span id="Warehouse-1882"><a href="#Warehouse-1882"><span class="linenos">1882</span></a><span class="sd">                - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse-1883"><a href="#Warehouse-1883"><span class="linenos">1883</span></a><span class="sd">                - Metadata: request_id, node_id</span>
</span><span id="Warehouse-1884"><a href="#Warehouse-1884"><span class="linenos">1884</span></a><span class="sd">                - Sender: Store JID</span>
</span><span id="Warehouse-1885"><a href="#Warehouse-1885"><span class="linenos">1885</span></a><span class="sd">        </span>
</span><span id="Warehouse-1886"><a href="#Warehouse-1886"><span class="linenos">1886</span></a><span class="sd">        Returns:</span>
</span><span id="Warehouse-1887"><a href="#Warehouse-1887"><span class="linenos">1887</span></a><span class="sd">            Order: Structured order object with:</span>
</span><span id="Warehouse-1888"><a href="#Warehouse-1888"><span class="linenos">1888</span></a><span class="sd">                - product: Product type</span>
</span><span id="Warehouse-1889"><a href="#Warehouse-1889"><span class="linenos">1889</span></a><span class="sd">                - quantity: Amount to deliver</span>
</span><span id="Warehouse-1890"><a href="#Warehouse-1890"><span class="linenos">1890</span></a><span class="sd">                - orderid: Unique identifier</span>
</span><span id="Warehouse-1891"><a href="#Warehouse-1891"><span class="linenos">1891</span></a><span class="sd">                - sender: Store JID (delivery destination)</span>
</span><span id="Warehouse-1892"><a href="#Warehouse-1892"><span class="linenos">1892</span></a><span class="sd">                - receiver: Warehouse JID (pickup location)</span>
</span><span id="Warehouse-1893"><a href="#Warehouse-1893"><span class="linenos">1893</span></a><span class="sd">                - sender_location: Store&#39;s graph node</span>
</span><span id="Warehouse-1894"><a href="#Warehouse-1894"><span class="linenos">1894</span></a><span class="sd">                - receiver_location: Warehouse&#39;s graph node</span>
</span><span id="Warehouse-1895"><a href="#Warehouse-1895"><span class="linenos">1895</span></a><span class="sd">        </span>
</span><span id="Warehouse-1896"><a href="#Warehouse-1896"><span class="linenos">1896</span></a><span class="sd">        Order Object Structure:</span>
</span><span id="Warehouse-1897"><a href="#Warehouse-1897"><span class="linenos">1897</span></a><span class="sd">            The Order uses inverted semantics for delivery context:</span>
</span><span id="Warehouse-1898"><a href="#Warehouse-1898"><span class="linenos">1898</span></a><span class="sd">            - sender = Store (WHERE to deliver)</span>
</span><span id="Warehouse-1899"><a href="#Warehouse-1899"><span class="linenos">1899</span></a><span class="sd">            - receiver = Warehouse (WHERE to pickup)</span>
</span><span id="Warehouse-1900"><a href="#Warehouse-1900"><span class="linenos">1900</span></a><span class="sd">            - sender_location = Store node (delivery destination)</span>
</span><span id="Warehouse-1901"><a href="#Warehouse-1901"><span class="linenos">1901</span></a><span class="sd">            - receiver_location = Warehouse node (pickup origin)</span>
</span><span id="Warehouse-1902"><a href="#Warehouse-1902"><span class="linenos">1902</span></a><span class="sd">        </span>
</span><span id="Warehouse-1903"><a href="#Warehouse-1903"><span class="linenos">1903</span></a><span class="sd">        Example:</span>
</span><span id="Warehouse-1904"><a href="#Warehouse-1904"><span class="linenos">1904</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1905"><a href="#Warehouse-1905"><span class="linenos">1905</span></a><span class="sd">            Input Message (store-confirm):</span>
</span><span id="Warehouse-1906"><a href="#Warehouse-1906"><span class="linenos">1906</span></a><span class="sd">                Body: &quot;50 electronics&quot;</span>
</span><span id="Warehouse-1907"><a href="#Warehouse-1907"><span class="linenos">1907</span></a><span class="sd">                Metadata:</span>
</span><span id="Warehouse-1908"><a href="#Warehouse-1908"><span class="linenos">1908</span></a><span class="sd">                    - request_id: &quot;201000000&quot;</span>
</span><span id="Warehouse-1909"><a href="#Warehouse-1909"><span class="linenos">1909</span></a><span class="sd">                    - node_id: &quot;15&quot;</span>
</span><span id="Warehouse-1910"><a href="#Warehouse-1910"><span class="linenos">1910</span></a><span class="sd">                Sender: &quot;store1@localhost&quot;</span>
</span><span id="Warehouse-1911"><a href="#Warehouse-1911"><span class="linenos">1911</span></a><span class="sd">            </span>
</span><span id="Warehouse-1912"><a href="#Warehouse-1912"><span class="linenos">1912</span></a><span class="sd">            Warehouse: &quot;warehouse1@localhost&quot; at node 10</span>
</span><span id="Warehouse-1913"><a href="#Warehouse-1913"><span class="linenos">1913</span></a><span class="sd">            </span>
</span><span id="Warehouse-1914"><a href="#Warehouse-1914"><span class="linenos">1914</span></a><span class="sd">            Output Order:</span>
</span><span id="Warehouse-1915"><a href="#Warehouse-1915"><span class="linenos">1915</span></a><span class="sd">                product: &quot;electronics&quot;</span>
</span><span id="Warehouse-1916"><a href="#Warehouse-1916"><span class="linenos">1916</span></a><span class="sd">                quantity: 50</span>
</span><span id="Warehouse-1917"><a href="#Warehouse-1917"><span class="linenos">1917</span></a><span class="sd">                orderid: 201000000</span>
</span><span id="Warehouse-1918"><a href="#Warehouse-1918"><span class="linenos">1918</span></a><span class="sd">                sender: &quot;store1@localhost&quot;</span>
</span><span id="Warehouse-1919"><a href="#Warehouse-1919"><span class="linenos">1919</span></a><span class="sd">                receiver: &quot;warehouse1@localhost&quot;</span>
</span><span id="Warehouse-1920"><a href="#Warehouse-1920"><span class="linenos">1920</span></a><span class="sd">                sender_location: 15 (store node)</span>
</span><span id="Warehouse-1921"><a href="#Warehouse-1921"><span class="linenos">1921</span></a><span class="sd">                receiver_location: 10 (warehouse node)</span>
</span><span id="Warehouse-1922"><a href="#Warehouse-1922"><span class="linenos">1922</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-1923"><a href="#Warehouse-1923"><span class="linenos">1923</span></a><span class="sd">        </span>
</span><span id="Warehouse-1924"><a href="#Warehouse-1924"><span class="linenos">1924</span></a><span class="sd">        Integration:</span>
</span><span id="Warehouse-1925"><a href="#Warehouse-1925"><span class="linenos">1925</span></a><span class="sd">            Created Order is added to self.pending_deliveries[order_id]</span>
</span><span id="Warehouse-1926"><a href="#Warehouse-1926"><span class="linenos">1926</span></a><span class="sd">            and passed to AssignVehicle behaviour for transportation.</span>
</span><span id="Warehouse-1927"><a href="#Warehouse-1927"><span class="linenos">1927</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-1928"><a href="#Warehouse-1928"><span class="linenos">1928</span></a>        <span class="n">body</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="Warehouse-1929"><a href="#Warehouse-1929"><span class="linenos">1929</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse-1930"><a href="#Warehouse-1930"><span class="linenos">1930</span></a>        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse-1931"><a href="#Warehouse-1931"><span class="linenos">1931</span></a>        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse-1932"><a href="#Warehouse-1932"><span class="linenos">1932</span></a>        
</span><span id="Warehouse-1933"><a href="#Warehouse-1933"><span class="linenos">1933</span></a>        <span class="n">order_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse-1934"><a href="#Warehouse-1934"><span class="linenos">1934</span></a>        <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>  <span class="c1"># Store JID</span>
</span><span id="Warehouse-1935"><a href="#Warehouse-1935"><span class="linenos">1935</span></a>        <span class="n">receiver</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">)</span>  <span class="c1"># Warehouse JID</span>
</span><span id="Warehouse-1936"><a href="#Warehouse-1936"><span class="linenos">1936</span></a>        <span class="n">store_location</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse-1937"><a href="#Warehouse-1937"><span class="linenos">1937</span></a>        <span class="n">warehouse_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span>
</span><span id="Warehouse-1938"><a href="#Warehouse-1938"><span class="linenos">1938</span></a>        
</span><span id="Warehouse-1939"><a href="#Warehouse-1939"><span class="linenos">1939</span></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
</span><span id="Warehouse-1940"><a href="#Warehouse-1940"><span class="linenos">1940</span></a>            <span class="n">product</span><span class="o">=</span><span class="n">product</span><span class="p">,</span>
</span><span id="Warehouse-1941"><a href="#Warehouse-1941"><span class="linenos">1941</span></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="Warehouse-1942"><a href="#Warehouse-1942"><span class="linenos">1942</span></a>            <span class="n">orderid</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
</span><span id="Warehouse-1943"><a href="#Warehouse-1943"><span class="linenos">1943</span></a>            <span class="n">sender</span><span class="o">=</span><span class="n">sender</span><span class="p">,</span>
</span><span id="Warehouse-1944"><a href="#Warehouse-1944"><span class="linenos">1944</span></a>            <span class="n">receiver</span><span class="o">=</span><span class="n">receiver</span>
</span><span id="Warehouse-1945"><a href="#Warehouse-1945"><span class="linenos">1945</span></a>        <span class="p">)</span>
</span><span id="Warehouse-1946"><a href="#Warehouse-1946"><span class="linenos">1946</span></a>        
</span><span id="Warehouse-1947"><a href="#Warehouse-1947"><span class="linenos">1947</span></a>        <span class="c1"># Set locations</span>
</span><span id="Warehouse-1948"><a href="#Warehouse-1948"><span class="linenos">1948</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span> <span class="o">=</span> <span class="n">store_location</span>  <span class="c1"># Store location</span>
</span><span id="Warehouse-1949"><a href="#Warehouse-1949"><span class="linenos">1949</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span> <span class="o">=</span> <span class="n">warehouse_location</span>  <span class="c1"># Warehouse location</span>
</span><span id="Warehouse-1950"><a href="#Warehouse-1950"><span class="linenos">1950</span></a>        
</span><span id="Warehouse-1951"><a href="#Warehouse-1951"><span class="linenos">1951</span></a>        <span class="k">return</span> <span class="n">order</span>
</span><span id="Warehouse-1952"><a href="#Warehouse-1952"><span class="linenos">1952</span></a>        
</span><span id="Warehouse-1953"><a href="#Warehouse-1953"><span class="linenos">1953</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_buy_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Warehouse-1954"><a href="#Warehouse-1954"><span class="linenos">1954</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-buy&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1955"><a href="#Warehouse-1955"><span class="linenos">1955</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse-1956"><a href="#Warehouse-1956"><span class="linenos">1956</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span><span class="p">))</span>
</span><span id="Warehouse-1957"><a href="#Warehouse-1957"><span class="linenos">1957</span></a>    
</span><span id="Warehouse-1958"><a href="#Warehouse-1958"><span class="linenos">1958</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traffic_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Warehouse-1959"><a href="#Warehouse-1959"><span class="linenos">1959</span></a>        <span class="k">for</span> <span class="n">edge_info</span> <span class="ow">in</span> <span class="n">traffic_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Warehouse-1960"><a href="#Warehouse-1960"><span class="linenos">1960</span></a>                <span class="n">node1_id</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node1&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1961"><a href="#Warehouse-1961"><span class="linenos">1961</span></a>                <span class="n">node2_id</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node2&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1962"><a href="#Warehouse-1962"><span class="linenos">1962</span></a>                <span class="n">new_weight</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
</span><span id="Warehouse-1963"><a href="#Warehouse-1963"><span class="linenos">1963</span></a>                
</span><span id="Warehouse-1964"><a href="#Warehouse-1964"><span class="linenos">1964</span></a>                <span class="n">edge</span> <span class="p">:</span> <span class="n">Edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">node1_id</span><span class="p">,</span> <span class="n">node2_id</span><span class="p">)</span>
</span><span id="Warehouse-1965"><a href="#Warehouse-1965"><span class="linenos">1965</span></a>                <span class="k">if</span> <span class="n">edge</span><span class="p">:</span>
</span><span id="Warehouse-1966"><a href="#Warehouse-1966"><span class="linenos">1966</span></a>                    <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">new_weight</span>
</span><span id="Warehouse-1967"><a href="#Warehouse-1967"><span class="linenos">1967</span></a>
</span><span id="Warehouse-1968"><a href="#Warehouse-1968"><span class="linenos">1968</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_stock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-1969"><a href="#Warehouse-1969"><span class="linenos">1969</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-1970"><a href="#Warehouse-1970"><span class="linenos">1970</span></a><span class="sd">        Print comprehensive warehouse inventory status (debugging utility).</span>
</span><span id="Warehouse-1971"><a href="#Warehouse-1971"><span class="linenos">1971</span></a><span class="sd">        </span>
</span><span id="Warehouse-1972"><a href="#Warehouse-1972"><span class="linenos">1972</span></a><span class="sd">        Displays the three-tier stock management system:</span>
</span><span id="Warehouse-1973"><a href="#Warehouse-1973"><span class="linenos">1973</span></a><span class="sd">        1. **Unlocked Stock**: Available for new orders</span>
</span><span id="Warehouse-1974"><a href="#Warehouse-1974"><span class="linenos">1974</span></a><span class="sd">        2. **Locked Stock**: Reserved during FIPA negotiations</span>
</span><span id="Warehouse-1975"><a href="#Warehouse-1975"><span class="linenos">1975</span></a><span class="sd">        3. **Pending Orders**: Confirmed deliveries awaiting vehicle pickup</span>
</span><span id="Warehouse-1976"><a href="#Warehouse-1976"><span class="linenos">1976</span></a><span class="sd">        </span>
</span><span id="Warehouse-1977"><a href="#Warehouse-1977"><span class="linenos">1977</span></a><span class="sd">        Output Format:</span>
</span><span id="Warehouse-1978"><a href="#Warehouse-1978"><span class="linenos">1978</span></a><span class="sd">            ==============================</span>
</span><span id="Warehouse-1979"><a href="#Warehouse-1979"><span class="linenos">1979</span></a><span class="sd">            Current warehouse1@localhost UNLOCKED stock:</span>
</span><span id="Warehouse-1980"><a href="#Warehouse-1980"><span class="linenos">1980</span></a><span class="sd">            electronics: 75/150</span>
</span><span id="Warehouse-1981"><a href="#Warehouse-1981"><span class="linenos">1981</span></a><span class="sd">            textiles: 120/150</span>
</span><span id="Warehouse-1982"><a href="#Warehouse-1982"><span class="linenos">1982</span></a><span class="sd">            food: 40/150</span>
</span><span id="Warehouse-1983"><a href="#Warehouse-1983"><span class="linenos">1983</span></a><span class="sd">            ------------------------------</span>
</span><span id="Warehouse-1984"><a href="#Warehouse-1984"><span class="linenos">1984</span></a><span class="sd">            Current warehouse1@localhost LOCKED stock:</span>
</span><span id="Warehouse-1985"><a href="#Warehouse-1985"><span class="linenos">1985</span></a><span class="sd">            electronics: 25/100</span>
</span><span id="Warehouse-1986"><a href="#Warehouse-1986"><span class="linenos">1986</span></a><span class="sd">            textiles: 0/120</span>
</span><span id="Warehouse-1987"><a href="#Warehouse-1987"><span class="linenos">1987</span></a><span class="sd">            ------------------------------</span>
</span><span id="Warehouse-1988"><a href="#Warehouse-1988"><span class="linenos">1988</span></a><span class="sd">            Current warehouse1@localhost PENDING ORDERS:</span>
</span><span id="Warehouse-1989"><a href="#Warehouse-1989"><span class="linenos">1989</span></a><span class="sd">            Order 201000000: 25xelectronics from store1@localhost to warehouse1@localhost</span>
</span><span id="Warehouse-1990"><a href="#Warehouse-1990"><span class="linenos">1990</span></a><span class="sd">            Order 201000001: 50xtextiles from store2@localhost to warehouse1@localhost</span>
</span><span id="Warehouse-1991"><a href="#Warehouse-1991"><span class="linenos">1991</span></a><span class="sd">            ==============================</span>
</span><span id="Warehouse-1992"><a href="#Warehouse-1992"><span class="linenos">1992</span></a><span class="sd">        </span>
</span><span id="Warehouse-1993"><a href="#Warehouse-1993"><span class="linenos">1993</span></a><span class="sd">        Stock Interpretation:</span>
</span><span id="Warehouse-1994"><a href="#Warehouse-1994"><span class="linenos">1994</span></a><span class="sd">            - Unlocked: X/MAX_CAPACITY</span>
</span><span id="Warehouse-1995"><a href="#Warehouse-1995"><span class="linenos">1995</span></a><span class="sd">            - Locked: X/Total_Available (stock + locked)</span>
</span><span id="Warehouse-1996"><a href="#Warehouse-1996"><span class="linenos">1996</span></a><span class="sd">            - Pending: Formatted as &quot;{order_id}: {quantity}x{product} from {sender} to {receiver}&quot;</span>
</span><span id="Warehouse-1997"><a href="#Warehouse-1997"><span class="linenos">1997</span></a><span class="sd">        </span>
</span><span id="Warehouse-1998"><a href="#Warehouse-1998"><span class="linenos">1998</span></a><span class="sd">        Use Cases:</span>
</span><span id="Warehouse-1999"><a href="#Warehouse-1999"><span class="linenos">1999</span></a><span class="sd">            - Debugging stock state transitions</span>
</span><span id="Warehouse-2000"><a href="#Warehouse-2000"><span class="linenos">2000</span></a><span class="sd">            - Verifying FIPA protocol effects on inventory</span>
</span><span id="Warehouse-2001"><a href="#Warehouse-2001"><span class="linenos">2001</span></a><span class="sd">            - Monitoring pending delivery queue</span>
</span><span id="Warehouse-2002"><a href="#Warehouse-2002"><span class="linenos">2002</span></a><span class="sd">            - Tracking resource availability</span>
</span><span id="Warehouse-2003"><a href="#Warehouse-2003"><span class="linenos">2003</span></a><span class="sd">        </span>
</span><span id="Warehouse-2004"><a href="#Warehouse-2004"><span class="linenos">2004</span></a><span class="sd">        Example Usage:</span>
</span><span id="Warehouse-2005"><a href="#Warehouse-2005"><span class="linenos">2005</span></a><span class="sd">            ```python</span>
</span><span id="Warehouse-2006"><a href="#Warehouse-2006"><span class="linenos">2006</span></a><span class="sd">            # After accepting store request</span>
</span><span id="Warehouse-2007"><a href="#Warehouse-2007"><span class="linenos">2007</span></a><span class="sd">            warehouse.locked_stock[product] = 50</span>
</span><span id="Warehouse-2008"><a href="#Warehouse-2008"><span class="linenos">2008</span></a><span class="sd">            warehouse.print_stock()  # Shows locked stock increased</span>
</span><span id="Warehouse-2009"><a href="#Warehouse-2009"><span class="linenos">2009</span></a><span class="sd">            </span>
</span><span id="Warehouse-2010"><a href="#Warehouse-2010"><span class="linenos">2010</span></a><span class="sd">            # After store confirmation</span>
</span><span id="Warehouse-2011"><a href="#Warehouse-2011"><span class="linenos">2011</span></a><span class="sd">            warehouse.pending_deliveries[order_id] = order</span>
</span><span id="Warehouse-2012"><a href="#Warehouse-2012"><span class="linenos">2012</span></a><span class="sd">            warehouse.print_stock()  # Shows new pending order</span>
</span><span id="Warehouse-2013"><a href="#Warehouse-2013"><span class="linenos">2013</span></a><span class="sd">            </span>
</span><span id="Warehouse-2014"><a href="#Warehouse-2014"><span class="linenos">2014</span></a><span class="sd">            # After vehicle pickup</span>
</span><span id="Warehouse-2015"><a href="#Warehouse-2015"><span class="linenos">2015</span></a><span class="sd">            del warehouse.pending_deliveries[order_id]</span>
</span><span id="Warehouse-2016"><a href="#Warehouse-2016"><span class="linenos">2016</span></a><span class="sd">            warehouse.print_stock()  # Shows order removed</span>
</span><span id="Warehouse-2017"><a href="#Warehouse-2017"><span class="linenos">2017</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-2018"><a href="#Warehouse-2018"><span class="linenos">2018</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-2019"><a href="#Warehouse-2019"><span class="linenos">2019</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
</span><span id="Warehouse-2020"><a href="#Warehouse-2020"><span class="linenos">2020</span></a>        
</span><span id="Warehouse-2021"><a href="#Warehouse-2021"><span class="linenos">2021</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2"> UNLOCKED stock:&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2022"><a href="#Warehouse-2022"><span class="linenos">2022</span></a>        <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Warehouse-2023"><a href="#Warehouse-2023"><span class="linenos">2023</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2024"><a href="#Warehouse-2024"><span class="linenos">2024</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
</span><span id="Warehouse-2025"><a href="#Warehouse-2025"><span class="linenos">2025</span></a>        
</span><span id="Warehouse-2026"><a href="#Warehouse-2026"><span class="linenos">2026</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2"> LOCKED stock:&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2027"><a href="#Warehouse-2027"><span class="linenos">2027</span></a>        <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked_stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Warehouse-2028"><a href="#Warehouse-2028"><span class="linenos">2028</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2029"><a href="#Warehouse-2029"><span class="linenos">2029</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
</span><span id="Warehouse-2030"><a href="#Warehouse-2030"><span class="linenos">2030</span></a>                
</span><span id="Warehouse-2031"><a href="#Warehouse-2031"><span class="linenos">2031</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2"> PENDING ORDERS:&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2032"><a href="#Warehouse-2032"><span class="linenos">2032</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">:</span>
</span><span id="Warehouse-2033"><a href="#Warehouse-2033"><span class="linenos">2033</span></a>            <span class="k">for</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Warehouse-2034"><a href="#Warehouse-2034"><span class="linenos">2034</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse-2035"><a href="#Warehouse-2035"><span class="linenos">2035</span></a>                      <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">receiver</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2036"><a href="#Warehouse-2036"><span class="linenos">2036</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse-2037"><a href="#Warehouse-2037"><span class="linenos">2037</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No pending orders&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2038"><a href="#Warehouse-2038"><span class="linenos">2038</span></a>        
</span><span id="Warehouse-2039"><a href="#Warehouse-2039"><span class="linenos">2039</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
</span><span id="Warehouse-2040"><a href="#Warehouse-2040"><span class="linenos">2040</span></a>    
</span><span id="Warehouse-2041"><a href="#Warehouse-2041"><span class="linenos">2041</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dict_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
</span><span id="Warehouse-2042"><a href="#Warehouse-2042"><span class="linenos">2042</span></a>        <span class="n">order</span> <span class="o">=</span>  <span class="n">Order</span><span class="p">(</span>
</span><span id="Warehouse-2043"><a href="#Warehouse-2043"><span class="linenos">2043</span></a>            <span class="n">product</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span>
</span><span id="Warehouse-2044"><a href="#Warehouse-2044"><span class="linenos">2044</span></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">],</span>
</span><span id="Warehouse-2045"><a href="#Warehouse-2045"><span class="linenos">2045</span></a>            <span class="n">orderid</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">],</span>
</span><span id="Warehouse-2046"><a href="#Warehouse-2046"><span class="linenos">2046</span></a>            <span class="n">sender</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;sender&quot;</span><span class="p">],</span>
</span><span id="Warehouse-2047"><a href="#Warehouse-2047"><span class="linenos">2047</span></a>            <span class="n">receiver</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;receiver&quot;</span><span class="p">]</span>
</span><span id="Warehouse-2048"><a href="#Warehouse-2048"><span class="linenos">2048</span></a>        <span class="p">)</span>
</span><span id="Warehouse-2049"><a href="#Warehouse-2049"><span class="linenos">2049</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sender_location&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2050"><a href="#Warehouse-2050"><span class="linenos">2050</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;receiver_location&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2051"><a href="#Warehouse-2051"><span class="linenos">2051</span></a>        <span class="k">return</span> <span class="n">order</span>
</span><span id="Warehouse-2052"><a href="#Warehouse-2052"><span class="linenos">2052</span></a>    
</span><span id="Warehouse-2053"><a href="#Warehouse-2053"><span class="linenos">2053</span></a>    <span class="c1"># ------------------------------------------</span>
</span><span id="Warehouse-2054"><a href="#Warehouse-2054"><span class="linenos">2054</span></a>    
</span><span id="Warehouse-2055"><a href="#Warehouse-2055"><span class="linenos">2055</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="nb">map</span> <span class="p">:</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">node_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">5222</span><span class="p">,</span> <span class="n">verify_security</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">contact_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="Warehouse-2056"><a href="#Warehouse-2056"><span class="linenos">2056</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-2057"><a href="#Warehouse-2057"><span class="linenos">2057</span></a><span class="sd">        Initialize the Warehouse agent with connection parameters and world state.</span>
</span><span id="Warehouse-2058"><a href="#Warehouse-2058"><span class="linenos">2058</span></a><span class="sd">        </span>
</span><span id="Warehouse-2059"><a href="#Warehouse-2059"><span class="linenos">2059</span></a><span class="sd">        The constructor configures the warehouse&#39;s identity, location, and initial</span>
</span><span id="Warehouse-2060"><a href="#Warehouse-2060"><span class="linenos">2060</span></a><span class="sd">        state. It implements the ID encoding system for generating unique request</span>
</span><span id="Warehouse-2061"><a href="#Warehouse-2061"><span class="linenos">2061</span></a><span class="sd">        identifiers compatible with the FIPA Contract Net Protocol.</span>
</span><span id="Warehouse-2062"><a href="#Warehouse-2062"><span class="linenos">2062</span></a><span class="sd">        </span>
</span><span id="Warehouse-2063"><a href="#Warehouse-2063"><span class="linenos">2063</span></a><span class="sd">        ID Encoding System:</span>
</span><span id="Warehouse-2064"><a href="#Warehouse-2064"><span class="linenos">2064</span></a><span class="sd">            Formula: `agent_type * 100_000_000 + instance_id * 1_000_000 + counter`</span>
</span><span id="Warehouse-2065"><a href="#Warehouse-2065"><span class="linenos">2065</span></a><span class="sd">            - Agent Type Code: 2 (for Warehouse agents)</span>
</span><span id="Warehouse-2066"><a href="#Warehouse-2066"><span class="linenos">2066</span></a><span class="sd">            - Instance ID: Extracted from JID (e.g., &quot;warehouse3&quot; -&gt; 3)</span>
</span><span id="Warehouse-2067"><a href="#Warehouse-2067"><span class="linenos">2067</span></a><span class="sd">            - Base ID Calculation: `2 * 100_000_000 + instance_id * 1_000_000`</span>
</span><span id="Warehouse-2068"><a href="#Warehouse-2068"><span class="linenos">2068</span></a><span class="sd">            </span>
</span><span id="Warehouse-2069"><a href="#Warehouse-2069"><span class="linenos">2069</span></a><span class="sd">            Examples:</span>
</span><span id="Warehouse-2070"><a href="#Warehouse-2070"><span class="linenos">2070</span></a><span class="sd">                - warehouse1: base = 201_000_000 (first request: 201_000_000)</span>
</span><span id="Warehouse-2071"><a href="#Warehouse-2071"><span class="linenos">2071</span></a><span class="sd">                - warehouse2: base = 202_000_000 (first request: 202_000_000)</span>
</span><span id="Warehouse-2072"><a href="#Warehouse-2072"><span class="linenos">2072</span></a><span class="sd">                - warehouse5: base = 205_000_000 (first request: 205_000_000)</span>
</span><span id="Warehouse-2073"><a href="#Warehouse-2073"><span class="linenos">2073</span></a><span class="sd">            </span>
</span><span id="Warehouse-2074"><a href="#Warehouse-2074"><span class="linenos">2074</span></a><span class="sd">            This encoding allows agents to identify:</span>
</span><span id="Warehouse-2075"><a href="#Warehouse-2075"><span class="linenos">2075</span></a><span class="sd">                1. What type of agent created the request (200M range = warehouse)</span>
</span><span id="Warehouse-2076"><a href="#Warehouse-2076"><span class="linenos">2076</span></a><span class="sd">                2. Which specific warehouse instance (next 1M range)</span>
</span><span id="Warehouse-2077"><a href="#Warehouse-2077"><span class="linenos">2077</span></a><span class="sd">                3. Which request in sequence (counter increments)</span>
</span><span id="Warehouse-2078"><a href="#Warehouse-2078"><span class="linenos">2078</span></a><span class="sd">        </span>
</span><span id="Warehouse-2079"><a href="#Warehouse-2079"><span class="linenos">2079</span></a><span class="sd">        Args:</span>
</span><span id="Warehouse-2080"><a href="#Warehouse-2080"><span class="linenos">2080</span></a><span class="sd">            jid (str): Jabber ID for XMPP communication (e.g., &quot;warehouse1@localhost&quot;).</span>
</span><span id="Warehouse-2081"><a href="#Warehouse-2081"><span class="linenos">2081</span></a><span class="sd">            password (str): Authentication password for XMPP server.</span>
</span><span id="Warehouse-2082"><a href="#Warehouse-2082"><span class="linenos">2082</span></a><span class="sd">            map (Graph): Reference to the world graph for pathfinding and locations.</span>
</span><span id="Warehouse-2083"><a href="#Warehouse-2083"><span class="linenos">2083</span></a><span class="sd">            node_id (int): Graph node representing the warehouse&#39;s physical location.</span>
</span><span id="Warehouse-2084"><a href="#Warehouse-2084"><span class="linenos">2084</span></a><span class="sd">            port (int, optional): XMPP server port. Defaults to 5222.</span>
</span><span id="Warehouse-2085"><a href="#Warehouse-2085"><span class="linenos">2085</span></a><span class="sd">            verify_security (bool, optional): Enable SSL/TLS verification. Defaults to False.</span>
</span><span id="Warehouse-2086"><a href="#Warehouse-2086"><span class="linenos">2086</span></a><span class="sd">            contact_list (list[str], optional): JIDs of stores, suppliers, vehicles for presence</span>
</span><span id="Warehouse-2087"><a href="#Warehouse-2087"><span class="linenos">2087</span></a><span class="sd">                subscription. Defaults to empty list.</span>
</span><span id="Warehouse-2088"><a href="#Warehouse-2088"><span class="linenos">2088</span></a><span class="sd">            verbose (bool, optional): Enable detailed debug logging. Defaults to False.</span>
</span><span id="Warehouse-2089"><a href="#Warehouse-2089"><span class="linenos">2089</span></a><span class="sd">        </span>
</span><span id="Warehouse-2090"><a href="#Warehouse-2090"><span class="linenos">2090</span></a><span class="sd">        Attributes Initialized:</span>
</span><span id="Warehouse-2091"><a href="#Warehouse-2091"><span class="linenos">2091</span></a><span class="sd">            Core Identity:</span>
</span><span id="Warehouse-2092"><a href="#Warehouse-2092"><span class="linenos">2092</span></a><span class="sd">                - node_id: Warehouse location on graph</span>
</span><span id="Warehouse-2093"><a href="#Warehouse-2093"><span class="linenos">2093</span></a><span class="sd">                - map: World graph reference</span>
</span><span id="Warehouse-2094"><a href="#Warehouse-2094"><span class="linenos">2094</span></a><span class="sd">                - contact_list: Agents for presence subscription</span>
</span><span id="Warehouse-2095"><a href="#Warehouse-2095"><span class="linenos">2095</span></a><span class="sd">                - verbose: Debug output flag</span>
</span><span id="Warehouse-2096"><a href="#Warehouse-2096"><span class="linenos">2096</span></a><span class="sd">            </span>
</span><span id="Warehouse-2097"><a href="#Warehouse-2097"><span class="linenos">2097</span></a><span class="sd">            ID Encoding:</span>
</span><span id="Warehouse-2098"><a href="#Warehouse-2098"><span class="linenos">2098</span></a><span class="sd">                - id_base: Base value for generating unique request IDs</span>
</span><span id="Warehouse-2099"><a href="#Warehouse-2099"><span class="linenos">2099</span></a><span class="sd">                - request_counter: Monotonic counter for requests</span>
</span><span id="Warehouse-2100"><a href="#Warehouse-2100"><span class="linenos">2100</span></a><span class="sd">            </span>
</span><span id="Warehouse-2101"><a href="#Warehouse-2101"><span class="linenos">2101</span></a><span class="sd">            Order Management:</span>
</span><span id="Warehouse-2102"><a href="#Warehouse-2102"><span class="linenos">2102</span></a><span class="sd">                - pending_deliveries: Dict mapping order_id -&gt; Order objects</span>
</span><span id="Warehouse-2103"><a href="#Warehouse-2103"><span class="linenos">2103</span></a><span class="sd">                - vehicle_proposals: Dict mapping order_id -&gt; vehicle proposals</span>
</span><span id="Warehouse-2104"><a href="#Warehouse-2104"><span class="linenos">2104</span></a><span class="sd">            </span>
</span><span id="Warehouse-2105"><a href="#Warehouse-2105"><span class="linenos">2105</span></a><span class="sd">            Contact Discovery:</span>
</span><span id="Warehouse-2106"><a href="#Warehouse-2106"><span class="linenos">2106</span></a><span class="sd">                - vehicles: List of vehicle JIDs (populated during setup)</span>
</span><span id="Warehouse-2107"><a href="#Warehouse-2107"><span class="linenos">2107</span></a><span class="sd">                - suppliers: List of supplier JIDs (populated during setup)</span>
</span><span id="Warehouse-2108"><a href="#Warehouse-2108"><span class="linenos">2108</span></a><span class="sd">        </span>
</span><span id="Warehouse-2109"><a href="#Warehouse-2109"><span class="linenos">2109</span></a><span class="sd">        Example:</span>
</span><span id="Warehouse-2110"><a href="#Warehouse-2110"><span class="linenos">2110</span></a><span class="sd">            ```python</span>
</span><span id="Warehouse-2111"><a href="#Warehouse-2111"><span class="linenos">2111</span></a><span class="sd">            warehouse = Warehouse(</span>
</span><span id="Warehouse-2112"><a href="#Warehouse-2112"><span class="linenos">2112</span></a><span class="sd">                jid=&quot;warehouse1@localhost&quot;,</span>
</span><span id="Warehouse-2113"><a href="#Warehouse-2113"><span class="linenos">2113</span></a><span class="sd">                password=&quot;password123&quot;,</span>
</span><span id="Warehouse-2114"><a href="#Warehouse-2114"><span class="linenos">2114</span></a><span class="sd">                map=world_graph,</span>
</span><span id="Warehouse-2115"><a href="#Warehouse-2115"><span class="linenos">2115</span></a><span class="sd">                node_id=10,</span>
</span><span id="Warehouse-2116"><a href="#Warehouse-2116"><span class="linenos">2116</span></a><span class="sd">                contact_list=[</span>
</span><span id="Warehouse-2117"><a href="#Warehouse-2117"><span class="linenos">2117</span></a><span class="sd">                    &quot;store1@localhost&quot;,</span>
</span><span id="Warehouse-2118"><a href="#Warehouse-2118"><span class="linenos">2118</span></a><span class="sd">                    &quot;store2@localhost&quot;,</span>
</span><span id="Warehouse-2119"><a href="#Warehouse-2119"><span class="linenos">2119</span></a><span class="sd">                    &quot;supplier1@localhost&quot;,</span>
</span><span id="Warehouse-2120"><a href="#Warehouse-2120"><span class="linenos">2120</span></a><span class="sd">                    &quot;vehicle1@localhost&quot;</span>
</span><span id="Warehouse-2121"><a href="#Warehouse-2121"><span class="linenos">2121</span></a><span class="sd">                ],</span>
</span><span id="Warehouse-2122"><a href="#Warehouse-2122"><span class="linenos">2122</span></a><span class="sd">                verbose=True</span>
</span><span id="Warehouse-2123"><a href="#Warehouse-2123"><span class="linenos">2123</span></a><span class="sd">            )</span>
</span><span id="Warehouse-2124"><a href="#Warehouse-2124"><span class="linenos">2124</span></a><span class="sd">            # ID base calculated: 2 * 100_000_000 + 1 * 1_000_000 = 201_000_000</span>
</span><span id="Warehouse-2125"><a href="#Warehouse-2125"><span class="linenos">2125</span></a><span class="sd">            # First request ID will be: 201_000_000</span>
</span><span id="Warehouse-2126"><a href="#Warehouse-2126"><span class="linenos">2126</span></a><span class="sd">            # Second request ID will be: 201_000_001</span>
</span><span id="Warehouse-2127"><a href="#Warehouse-2127"><span class="linenos">2127</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-2128"><a href="#Warehouse-2128"><span class="linenos">2128</span></a><span class="sd">        </span>
</span><span id="Warehouse-2129"><a href="#Warehouse-2129"><span class="linenos">2129</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse-2130"><a href="#Warehouse-2130"><span class="linenos">2130</span></a><span class="sd">            The constructor only initializes essential attributes. Most warehouse</span>
</span><span id="Warehouse-2131"><a href="#Warehouse-2131"><span class="linenos">2131</span></a><span class="sd">            state (stock, locked_stock, behaviours) is configured in the setup()</span>
</span><span id="Warehouse-2132"><a href="#Warehouse-2132"><span class="linenos">2132</span></a><span class="sd">            method which runs after the agent connects to the XMPP server.</span>
</span><span id="Warehouse-2133"><a href="#Warehouse-2133"><span class="linenos">2133</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-2134"><a href="#Warehouse-2134"><span class="linenos">2134</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">verify_security</span><span class="p">)</span>
</span><span id="Warehouse-2135"><a href="#Warehouse-2135"><span class="linenos">2135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node_id</span>
</span><span id="Warehouse-2136"><a href="#Warehouse-2136"><span class="linenos">2136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="p">:</span> <span class="n">Graph</span> <span class="o">=</span> <span class="nb">map</span>
</span><span id="Warehouse-2137"><a href="#Warehouse-2137"><span class="linenos">2137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contact_list</span> <span class="o">=</span> <span class="n">contact_list</span>
</span><span id="Warehouse-2138"><a href="#Warehouse-2138"><span class="linenos">2138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="Warehouse-2139"><a href="#Warehouse-2139"><span class="linenos">2139</span></a>        <span class="c1"># Extract instance number from JID for ID encoding (e.g., &quot;warehouse1@localhost&quot; -&gt; 1)</span>
</span><span id="Warehouse-2140"><a href="#Warehouse-2140"><span class="linenos">2140</span></a>        <span class="n">jid_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Warehouse-2141"><a href="#Warehouse-2141"><span class="linenos">2141</span></a>        <span class="n">instance_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">,</span> <span class="n">jid_name</span><span class="p">)))</span>
</span><span id="Warehouse-2142"><a href="#Warehouse-2142"><span class="linenos">2142</span></a>
</span><span id="Warehouse-2143"><a href="#Warehouse-2143"><span class="linenos">2143</span></a>        <span class="c1"># Calculate ID base: Warehouse type code = 2</span>
</span><span id="Warehouse-2144"><a href="#Warehouse-2144"><span class="linenos">2144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id_base</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">100_000_000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">instance_id</span> <span class="o">*</span> <span class="mi">1_000_000</span><span class="p">)</span>
</span><span id="Warehouse-2145"><a href="#Warehouse-2145"><span class="linenos">2145</span></a>        
</span><span id="Warehouse-2146"><a href="#Warehouse-2146"><span class="linenos">2146</span></a>        <span class="c1"># Initialize critical attributes early to avoid AttributeError</span>
</span><span id="Warehouse-2147"><a href="#Warehouse-2147"><span class="linenos">2147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pending_deliveries</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># order_id as key and Order object as value</span>
</span><span id="Warehouse-2148"><a href="#Warehouse-2148"><span class="linenos">2148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_proposals</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse-2149"><a href="#Warehouse-2149"><span class="linenos">2149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Warehouse-2150"><a href="#Warehouse-2150"><span class="linenos">2150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">suppliers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Warehouse-2151"><a href="#Warehouse-2151"><span class="linenos">2151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Warehouse-2152"><a href="#Warehouse-2152"><span class="linenos">2152</span></a>    
</span><span id="Warehouse-2153"><a href="#Warehouse-2153"><span class="linenos">2153</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse-2154"><a href="#Warehouse-2154"><span class="linenos">2154</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse-2155"><a href="#Warehouse-2155"><span class="linenos">2155</span></a><span class="sd">        Configure warehouse state and register all FIPA protocol behaviours.</span>
</span><span id="Warehouse-2156"><a href="#Warehouse-2156"><span class="linenos">2156</span></a><span class="sd">        </span>
</span><span id="Warehouse-2157"><a href="#Warehouse-2157"><span class="linenos">2157</span></a><span class="sd">        This method is automatically called by SPADE after the agent successfully</span>
</span><span id="Warehouse-2158"><a href="#Warehouse-2158"><span class="linenos">2158</span></a><span class="sd">        connects to the XMPP server. It initializes the warehouse&#39;s operational</span>
</span><span id="Warehouse-2159"><a href="#Warehouse-2159"><span class="linenos">2159</span></a><span class="sd">        state and registers all cyclic and periodic behaviours needed for the</span>
</span><span id="Warehouse-2160"><a href="#Warehouse-2160"><span class="linenos">2160</span></a><span class="sd">        dual FIPA Contract Net Protocol implementation.</span>
</span><span id="Warehouse-2161"><a href="#Warehouse-2161"><span class="linenos">2161</span></a><span class="sd">        </span>
</span><span id="Warehouse-2162"><a href="#Warehouse-2162"><span class="linenos">2162</span></a><span class="sd">        Setup Process:</span>
</span><span id="Warehouse-2163"><a href="#Warehouse-2163"><span class="linenos">2163</span></a><span class="sd">        </span>
</span><span id="Warehouse-2164"><a href="#Warehouse-2164"><span class="linenos">2164</span></a><span class="sd">            **Phase 1: Presence Management**</span>
</span><span id="Warehouse-2165"><a href="#Warehouse-2165"><span class="linenos">2165</span></a><span class="sd">                - Enable auto-approval of presence subscriptions</span>
</span><span id="Warehouse-2166"><a href="#Warehouse-2166"><span class="linenos">2166</span></a><span class="sd">                - Subscribe to all contacts (stores, suppliers, vehicles)</span>
</span><span id="Warehouse-2167"><a href="#Warehouse-2167"><span class="linenos">2167</span></a><span class="sd">                - Enables presence-based availability checking</span>
</span><span id="Warehouse-2168"><a href="#Warehouse-2168"><span class="linenos">2168</span></a><span class="sd">            </span>
</span><span id="Warehouse-2169"><a href="#Warehouse-2169"><span class="linenos">2169</span></a><span class="sd">            **Phase 2: Stock Initialization**</span>
</span><span id="Warehouse-2170"><a href="#Warehouse-2170"><span class="linenos">2170</span></a><span class="sd">                - Randomize initial stock for each product</span>
</span><span id="Warehouse-2171"><a href="#Warehouse-2171"><span class="linenos">2171</span></a><span class="sd">                - Range: [WAREHOUSE_RESUPPLY_THRESHOLD+1, WAREHOUSE_MAX_PRODUCT_CAPACITY]</span>
</span><span id="Warehouse-2172"><a href="#Warehouse-2172"><span class="linenos">2172</span></a><span class="sd">                - Calculate current_capacity per product</span>
</span><span id="Warehouse-2173"><a href="#Warehouse-2173"><span class="linenos">2173</span></a><span class="sd">                - Initialize locked_stock dictionary (empty)</span>
</span><span id="Warehouse-2174"><a href="#Warehouse-2174"><span class="linenos">2174</span></a><span class="sd">            </span>
</span><span id="Warehouse-2175"><a href="#Warehouse-2175"><span class="linenos">2175</span></a><span class="sd">            **Phase 3: State Initialization**</span>
</span><span id="Warehouse-2176"><a href="#Warehouse-2176"><span class="linenos">2176</span></a><span class="sd">                - current_tick: Simulation time (starts at 0)</span>
</span><span id="Warehouse-2177"><a href="#Warehouse-2177"><span class="linenos">2177</span></a><span class="sd">                - presence_infos: Vehicle availability cache</span>
</span><span id="Warehouse-2178"><a href="#Warehouse-2178"><span class="linenos">2178</span></a><span class="sd">                - current_buy_request: Last supplier purchase request</span>
</span><span id="Warehouse-2179"><a href="#Warehouse-2179"><span class="linenos">2179</span></a><span class="sd">                - failed_requests: Queue for retry mechanism</span>
</span><span id="Warehouse-2180"><a href="#Warehouse-2180"><span class="linenos">2180</span></a><span class="sd">            </span>
</span><span id="Warehouse-2181"><a href="#Warehouse-2181"><span class="linenos">2181</span></a><span class="sd">            **Phase 4: Contact Discovery**</span>
</span><span id="Warehouse-2182"><a href="#Warehouse-2182"><span class="linenos">2182</span></a><span class="sd">                - Parse presence.contacts to identify vehicles and suppliers</span>
</span><span id="Warehouse-2183"><a href="#Warehouse-2183"><span class="linenos">2183</span></a><span class="sd">                - Filter by JID string matching (&quot;vehicle&quot;, &quot;supplier&quot;)</span>
</span><span id="Warehouse-2184"><a href="#Warehouse-2184"><span class="linenos">2184</span></a><span class="sd">                - Populate vehicles and suppliers lists</span>
</span><span id="Warehouse-2185"><a href="#Warehouse-2185"><span class="linenos">2185</span></a><span class="sd">            </span>
</span><span id="Warehouse-2186"><a href="#Warehouse-2186"><span class="linenos">2186</span></a><span class="sd">            **Phase 5: Behaviour Registration**</span>
</span><span id="Warehouse-2187"><a href="#Warehouse-2187"><span class="linenos">2187</span></a><span class="sd">                1. ReceiveBuyRequest (Store Interaction - FIPA Participant)</span>
</span><span id="Warehouse-2188"><a href="#Warehouse-2188"><span class="linenos">2188</span></a><span class="sd">                2. HandleResupply (Inventory Management - Triggers FIPA Initiator)</span>
</span><span id="Warehouse-2189"><a href="#Warehouse-2189"><span class="linenos">2189</span></a><span class="sd">                3. ReceiveVehicleArrival (Logistics Coordination)</span>
</span><span id="Warehouse-2190"><a href="#Warehouse-2190"><span class="linenos">2190</span></a><span class="sd">                4. ReceiveTimeDelta (Time Synchronization)</span>
</span><span id="Warehouse-2191"><a href="#Warehouse-2191"><span class="linenos">2191</span></a><span class="sd">        </span>
</span><span id="Warehouse-2192"><a href="#Warehouse-2192"><span class="linenos">2192</span></a><span class="sd">        Behaviour Registration Details:</span>
</span><span id="Warehouse-2193"><a href="#Warehouse-2193"><span class="linenos">2193</span></a><span class="sd">        </span>
</span><span id="Warehouse-2194"><a href="#Warehouse-2194"><span class="linenos">2194</span></a><span class="sd">            **ReceiveBuyRequest** (CyclicBehaviour):</span>
</span><span id="Warehouse-2195"><a href="#Warehouse-2195"><span class="linenos">2195</span></a><span class="sd">                - Template: performative = &quot;store-buy&quot;</span>
</span><span id="Warehouse-2196"><a href="#Warehouse-2196"><span class="linenos">2196</span></a><span class="sd">                - Purpose: Listen for store purchase requests (FIPA CFP)</span>
</span><span id="Warehouse-2197"><a href="#Warehouse-2197"><span class="linenos">2197</span></a><span class="sd">                - Role: FIPA Participant (responds to stores)</span>
</span><span id="Warehouse-2198"><a href="#Warehouse-2198"><span class="linenos">2198</span></a><span class="sd">            </span>
</span><span id="Warehouse-2199"><a href="#Warehouse-2199"><span class="linenos">2199</span></a><span class="sd">            **HandleResupply** (PeriodicBehaviour):</span>
</span><span id="Warehouse-2200"><a href="#Warehouse-2200"><span class="linenos">2200</span></a><span class="sd">                - Period: 5 seconds</span>
</span><span id="Warehouse-2201"><a href="#Warehouse-2201"><span class="linenos">2201</span></a><span class="sd">                - Purpose: Monitor stock levels and trigger restocking</span>
</span><span id="Warehouse-2202"><a href="#Warehouse-2202"><span class="linenos">2202</span></a><span class="sd">                - Role: Launches BuyMaterial (FIPA Initiator with suppliers)</span>
</span><span id="Warehouse-2203"><a href="#Warehouse-2203"><span class="linenos">2203</span></a><span class="sd">            </span>
</span><span id="Warehouse-2204"><a href="#Warehouse-2204"><span class="linenos">2204</span></a><span class="sd">            **ReceiveVehicleArrival** (CyclicBehaviour):</span>
</span><span id="Warehouse-2205"><a href="#Warehouse-2205"><span class="linenos">2205</span></a><span class="sd">                - Template: performative = &quot;vehicle-pickup&quot; OR &quot;vehicle-delivery&quot;</span>
</span><span id="Warehouse-2206"><a href="#Warehouse-2206"><span class="linenos">2206</span></a><span class="sd">                - Purpose: Handle vehicle logistics notifications</span>
</span><span id="Warehouse-2207"><a href="#Warehouse-2207"><span class="linenos">2207</span></a><span class="sd">                - Actions:</span>
</span><span id="Warehouse-2208"><a href="#Warehouse-2208"><span class="linenos">2208</span></a><span class="sd">                    - vehicle-pickup: Remove order from pending_deliveries</span>
</span><span id="Warehouse-2209"><a href="#Warehouse-2209"><span class="linenos">2209</span></a><span class="sd">                    - vehicle-delivery: Add delivered materials to stock</span>
</span><span id="Warehouse-2210"><a href="#Warehouse-2210"><span class="linenos">2210</span></a><span class="sd">            </span>
</span><span id="Warehouse-2211"><a href="#Warehouse-2211"><span class="linenos">2211</span></a><span class="sd">            **ReceiveTimeDelta** (CyclicBehaviour):</span>
</span><span id="Warehouse-2212"><a href="#Warehouse-2212"><span class="linenos">2212</span></a><span class="sd">                - Template: performative = &quot;time-delta&quot;</span>
</span><span id="Warehouse-2213"><a href="#Warehouse-2213"><span class="linenos">2213</span></a><span class="sd">                - Purpose: Synchronize simulation time with world agent</span>
</span><span id="Warehouse-2214"><a href="#Warehouse-2214"><span class="linenos">2214</span></a><span class="sd">                - Actions: Update current_tick, apply traffic conditions</span>
</span><span id="Warehouse-2215"><a href="#Warehouse-2215"><span class="linenos">2215</span></a><span class="sd">        </span>
</span><span id="Warehouse-2216"><a href="#Warehouse-2216"><span class="linenos">2216</span></a><span class="sd">        Stock Initialization Example:</span>
</span><span id="Warehouse-2217"><a href="#Warehouse-2217"><span class="linenos">2217</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-2218"><a href="#Warehouse-2218"><span class="linenos">2218</span></a><span class="sd">            Products: [electronics, textiles, food]</span>
</span><span id="Warehouse-2219"><a href="#Warehouse-2219"><span class="linenos">2219</span></a><span class="sd">            WAREHOUSE_MAX_PRODUCT_CAPACITY: 150</span>
</span><span id="Warehouse-2220"><a href="#Warehouse-2220"><span class="linenos">2220</span></a><span class="sd">            WAREHOUSE_RESUPPLY_THRESHOLD: 30</span>
</span><span id="Warehouse-2221"><a href="#Warehouse-2221"><span class="linenos">2221</span></a><span class="sd">            </span>
</span><span id="Warehouse-2222"><a href="#Warehouse-2222"><span class="linenos">2222</span></a><span class="sd">            Initial Stock (randomized):</span>
</span><span id="Warehouse-2223"><a href="#Warehouse-2223"><span class="linenos">2223</span></a><span class="sd">                electronics: 87  (available)</span>
</span><span id="Warehouse-2224"><a href="#Warehouse-2224"><span class="linenos">2224</span></a><span class="sd">                textiles:    45  (available)</span>
</span><span id="Warehouse-2225"><a href="#Warehouse-2225"><span class="linenos">2225</span></a><span class="sd">                food:        120 (available)</span>
</span><span id="Warehouse-2226"><a href="#Warehouse-2226"><span class="linenos">2226</span></a><span class="sd">            </span>
</span><span id="Warehouse-2227"><a href="#Warehouse-2227"><span class="linenos">2227</span></a><span class="sd">            Current Capacity (calculated):</span>
</span><span id="Warehouse-2228"><a href="#Warehouse-2228"><span class="linenos">2228</span></a><span class="sd">                electronics: 150 - 87 = 63</span>
</span><span id="Warehouse-2229"><a href="#Warehouse-2229"><span class="linenos">2229</span></a><span class="sd">                textiles:    150 - 45 = 105</span>
</span><span id="Warehouse-2230"><a href="#Warehouse-2230"><span class="linenos">2230</span></a><span class="sd">                food:        150 - 120 = 30</span>
</span><span id="Warehouse-2231"><a href="#Warehouse-2231"><span class="linenos">2231</span></a><span class="sd">            </span>
</span><span id="Warehouse-2232"><a href="#Warehouse-2232"><span class="linenos">2232</span></a><span class="sd">            Locked Stock (initialized empty):</span>
</span><span id="Warehouse-2233"><a href="#Warehouse-2233"><span class="linenos">2233</span></a><span class="sd">                electronics: 0</span>
</span><span id="Warehouse-2234"><a href="#Warehouse-2234"><span class="linenos">2234</span></a><span class="sd">                textiles:    0</span>
</span><span id="Warehouse-2235"><a href="#Warehouse-2235"><span class="linenos">2235</span></a><span class="sd">                food:        0</span>
</span><span id="Warehouse-2236"><a href="#Warehouse-2236"><span class="linenos">2236</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-2237"><a href="#Warehouse-2237"><span class="linenos">2237</span></a><span class="sd">        </span>
</span><span id="Warehouse-2238"><a href="#Warehouse-2238"><span class="linenos">2238</span></a><span class="sd">        Presence Subscription Example:</span>
</span><span id="Warehouse-2239"><a href="#Warehouse-2239"><span class="linenos">2239</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-2240"><a href="#Warehouse-2240"><span class="linenos">2240</span></a><span class="sd">            contact_list: [</span>
</span><span id="Warehouse-2241"><a href="#Warehouse-2241"><span class="linenos">2241</span></a><span class="sd">                &quot;store1@localhost&quot;,</span>
</span><span id="Warehouse-2242"><a href="#Warehouse-2242"><span class="linenos">2242</span></a><span class="sd">                &quot;store2@localhost&quot;,</span>
</span><span id="Warehouse-2243"><a href="#Warehouse-2243"><span class="linenos">2243</span></a><span class="sd">                &quot;supplier1@localhost&quot;,</span>
</span><span id="Warehouse-2244"><a href="#Warehouse-2244"><span class="linenos">2244</span></a><span class="sd">                &quot;vehicle1@localhost&quot;,</span>
</span><span id="Warehouse-2245"><a href="#Warehouse-2245"><span class="linenos">2245</span></a><span class="sd">                &quot;vehicle2@localhost&quot;</span>
</span><span id="Warehouse-2246"><a href="#Warehouse-2246"><span class="linenos">2246</span></a><span class="sd">            ]</span>
</span><span id="Warehouse-2247"><a href="#Warehouse-2247"><span class="linenos">2247</span></a><span class="sd">            </span>
</span><span id="Warehouse-2248"><a href="#Warehouse-2248"><span class="linenos">2248</span></a><span class="sd">            Actions:</span>
</span><span id="Warehouse-2249"><a href="#Warehouse-2249"><span class="linenos">2249</span></a><span class="sd">                1. Subscribe to all 5 contacts</span>
</span><span id="Warehouse-2250"><a href="#Warehouse-2250"><span class="linenos">2250</span></a><span class="sd">                2. Parse contacts for types:</span>
</span><span id="Warehouse-2251"><a href="#Warehouse-2251"><span class="linenos">2251</span></a><span class="sd">                   - vehicles: [&quot;vehicle1@localhost&quot;, &quot;vehicle2@localhost&quot;]</span>
</span><span id="Warehouse-2252"><a href="#Warehouse-2252"><span class="linenos">2252</span></a><span class="sd">                   - suppliers: [&quot;supplier1@localhost&quot;]</span>
</span><span id="Warehouse-2253"><a href="#Warehouse-2253"><span class="linenos">2253</span></a><span class="sd">                3. Stores automatically discovered via presence system</span>
</span><span id="Warehouse-2254"><a href="#Warehouse-2254"><span class="linenos">2254</span></a><span class="sd">            ```</span>
</span><span id="Warehouse-2255"><a href="#Warehouse-2255"><span class="linenos">2255</span></a><span class="sd">        </span>
</span><span id="Warehouse-2256"><a href="#Warehouse-2256"><span class="linenos">2256</span></a><span class="sd">        Template Configuration:</span>
</span><span id="Warehouse-2257"><a href="#Warehouse-2257"><span class="linenos">2257</span></a><span class="sd">            Templates use metadata filtering to route messages to correct behaviours:</span>
</span><span id="Warehouse-2258"><a href="#Warehouse-2258"><span class="linenos">2258</span></a><span class="sd">            - ReceiveBuyRequest: performative=&quot;store-buy&quot;</span>
</span><span id="Warehouse-2259"><a href="#Warehouse-2259"><span class="linenos">2259</span></a><span class="sd">            - ReceiveVehicleArrival: performative in [&quot;vehicle-pickup&quot;, &quot;vehicle-delivery&quot;]</span>
</span><span id="Warehouse-2260"><a href="#Warehouse-2260"><span class="linenos">2260</span></a><span class="sd">            - ReceiveTimeDelta: performative=&quot;time-delta&quot;</span>
</span><span id="Warehouse-2261"><a href="#Warehouse-2261"><span class="linenos">2261</span></a><span class="sd">        </span>
</span><span id="Warehouse-2262"><a href="#Warehouse-2262"><span class="linenos">2262</span></a><span class="sd">        Side Effects:</span>
</span><span id="Warehouse-2263"><a href="#Warehouse-2263"><span class="linenos">2263</span></a><span class="sd">            - Prints initial stock levels if verbose=True</span>
</span><span id="Warehouse-2264"><a href="#Warehouse-2264"><span class="linenos">2264</span></a><span class="sd">            - Begins listening for store requests immediately</span>
</span><span id="Warehouse-2265"><a href="#Warehouse-2265"><span class="linenos">2265</span></a><span class="sd">            - Starts periodic inventory monitoring</span>
</span><span id="Warehouse-2266"><a href="#Warehouse-2266"><span class="linenos">2266</span></a><span class="sd">            - Enables vehicle coordination capability</span>
</span><span id="Warehouse-2267"><a href="#Warehouse-2267"><span class="linenos">2267</span></a><span class="sd">        </span>
</span><span id="Warehouse-2268"><a href="#Warehouse-2268"><span class="linenos">2268</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse-2269"><a href="#Warehouse-2269"><span class="linenos">2269</span></a><span class="sd">            This method must complete before the warehouse can participate in any</span>
</span><span id="Warehouse-2270"><a href="#Warehouse-2270"><span class="linenos">2270</span></a><span class="sd">            FIPA protocol interactions. All behaviours are registered but don&#39;t</span>
</span><span id="Warehouse-2271"><a href="#Warehouse-2271"><span class="linenos">2271</span></a><span class="sd">            execute until the main agent event loop processes them.</span>
</span><span id="Warehouse-2272"><a href="#Warehouse-2272"><span class="linenos">2272</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse-2273"><a href="#Warehouse-2273"><span class="linenos">2273</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">approve_all</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Warehouse-2274"><a href="#Warehouse-2274"><span class="linenos">2274</span></a>        <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_list</span><span class="p">:</span>
</span><span id="Warehouse-2275"><a href="#Warehouse-2275"><span class="linenos">2275</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
</span><span id="Warehouse-2276"><a href="#Warehouse-2276"><span class="linenos">2276</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse-2277"><a href="#Warehouse-2277"><span class="linenos">2277</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Subscribed to presence of </span><span class="si">{</span><span class="n">contact</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2278"><a href="#Warehouse-2278"><span class="linenos">2278</span></a>        <span class="c1"># Initialize stock and time</span>
</span><span id="Warehouse-2279"><a href="#Warehouse-2279"><span class="linenos">2279</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stock</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse-2280"><a href="#Warehouse-2280"><span class="linenos">2280</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Warehouse-2281"><a href="#Warehouse-2281"><span class="linenos">2281</span></a>        
</span><span id="Warehouse-2282"><a href="#Warehouse-2282"><span class="linenos">2282</span></a>        <span class="c1"># Set the starting stock randomly</span>
</span><span id="Warehouse-2283"><a href="#Warehouse-2283"><span class="linenos">2283</span></a>        <span class="n">product_max</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span>
</span><span id="Warehouse-2284"><a href="#Warehouse-2284"><span class="linenos">2284</span></a>        <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">PRODUCTS</span><span class="p">:</span>
</span><span id="Warehouse-2285"><a href="#Warehouse-2285"><span class="linenos">2285</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_RESUPPLY_THRESHOLD</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Warehouse-2286"><a href="#Warehouse-2286"><span class="linenos">2286</span></a>                                              <span class="n">product_max</span><span class="p">)</span>
</span><span id="Warehouse-2287"><a href="#Warehouse-2287"><span class="linenos">2287</span></a>        
</span><span id="Warehouse-2288"><a href="#Warehouse-2288"><span class="linenos">2288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_capacity</span> <span class="o">=</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">product_max</span> <span class="o">-</span> <span class="n">quant</span> <span class="k">for</span> <span class="n">prod</span><span class="p">,</span> <span class="n">quant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Warehouse-2289"><a href="#Warehouse-2289"><span class="linenos">2289</span></a>        
</span><span id="Warehouse-2290"><a href="#Warehouse-2290"><span class="linenos">2290</span></a>        <span class="c1"># Dict with products as keys and the sum of requested items as values</span>
</span><span id="Warehouse-2291"><a href="#Warehouse-2291"><span class="linenos">2291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">locked_stock</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse-2292"><a href="#Warehouse-2292"><span class="linenos">2292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="Warehouse-2293"><a href="#Warehouse-2293"><span class="linenos">2293</span></a>        
</span><span id="Warehouse-2294"><a href="#Warehouse-2294"><span class="linenos">2294</span></a>        
</span><span id="Warehouse-2295"><a href="#Warehouse-2295"><span class="linenos">2295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_infos</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse-2296"><a href="#Warehouse-2296"><span class="linenos">2296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Warehouse-2297"><a href="#Warehouse-2297"><span class="linenos">2297</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failed_requests</span> <span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span><span id="Warehouse-2298"><a href="#Warehouse-2298"><span class="linenos">2298</span></a>        
</span><span id="Warehouse-2299"><a href="#Warehouse-2299"><span class="linenos">2299</span></a>        <span class="c1"># Identify vehicles from presence contacts</span>
</span><span id="Warehouse-2300"><a href="#Warehouse-2300"><span class="linenos">2300</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Warehouse-2301"><a href="#Warehouse-2301"><span class="linenos">2301</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">suppliers</span>  <span class="o">=</span> <span class="p">[]</span>
</span><span id="Warehouse-2302"><a href="#Warehouse-2302"><span class="linenos">2302</span></a>        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="Warehouse-2303"><a href="#Warehouse-2303"><span class="linenos">2303</span></a>            <span class="k">if</span> <span class="s2">&quot;vehicle&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle</span><span class="p">):</span>
</span><span id="Warehouse-2304"><a href="#Warehouse-2304"><span class="linenos">2304</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>
</span><span id="Warehouse-2305"><a href="#Warehouse-2305"><span class="linenos">2305</span></a>            <span class="k">if</span> <span class="s2">&quot;supplier&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle</span><span class="p">):</span>
</span><span id="Warehouse-2306"><a href="#Warehouse-2306"><span class="linenos">2306</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">suppliers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>
</span><span id="Warehouse-2307"><a href="#Warehouse-2307"><span class="linenos">2307</span></a>        
</span><span id="Warehouse-2308"><a href="#Warehouse-2308"><span class="linenos">2308</span></a>        <span class="c1"># Run ReceiveBuyRequest behaviour</span>
</span><span id="Warehouse-2309"><a href="#Warehouse-2309"><span class="linenos">2309</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveBuyRequest</span><span class="p">()</span>
</span><span id="Warehouse-2310"><a href="#Warehouse-2310"><span class="linenos">2310</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse-2311"><a href="#Warehouse-2311"><span class="linenos">2311</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-buy&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2312"><a href="#Warehouse-2312"><span class="linenos">2312</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Warehouse-2313"><a href="#Warehouse-2313"><span class="linenos">2313</span></a>        
</span><span id="Warehouse-2314"><a href="#Warehouse-2314"><span class="linenos">2314</span></a>        <span class="c1"># Run HandleResupply behaviour</span>
</span><span id="Warehouse-2315"><a href="#Warehouse-2315"><span class="linenos">2315</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HandleResupply</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="Warehouse-2316"><a href="#Warehouse-2316"><span class="linenos">2316</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Warehouse-2317"><a href="#Warehouse-2317"><span class="linenos">2317</span></a>        
</span><span id="Warehouse-2318"><a href="#Warehouse-2318"><span class="linenos">2318</span></a>        <span class="c1"># Run ReceiveVehicleArrival behaviour for pickups</span>
</span><span id="Warehouse-2319"><a href="#Warehouse-2319"><span class="linenos">2319</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveVehicleArrival</span><span class="p">()</span>
</span><span id="Warehouse-2320"><a href="#Warehouse-2320"><span class="linenos">2320</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse-2321"><a href="#Warehouse-2321"><span class="linenos">2321</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2322"><a href="#Warehouse-2322"><span class="linenos">2322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Warehouse-2323"><a href="#Warehouse-2323"><span class="linenos">2323</span></a>        
</span><span id="Warehouse-2324"><a href="#Warehouse-2324"><span class="linenos">2324</span></a>        <span class="c1"># Run ReceiveVehicleProposals behaviour</span>
</span><span id="Warehouse-2325"><a href="#Warehouse-2325"><span class="linenos">2325</span></a>        <span class="n">vehicle_proposal_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveVehicleProposals</span><span class="p">()</span>
</span><span id="Warehouse-2326"><a href="#Warehouse-2326"><span class="linenos">2326</span></a>        <span class="n">vehicle_proposal_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse-2327"><a href="#Warehouse-2327"><span class="linenos">2327</span></a>        <span class="n">vehicle_proposal_template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-proposal&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2328"><a href="#Warehouse-2328"><span class="linenos">2328</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">vehicle_proposal_behav</span><span class="p">,</span> <span class="n">vehicle_proposal_template</span><span class="p">)</span>
</span><span id="Warehouse-2329"><a href="#Warehouse-2329"><span class="linenos">2329</span></a>
</span><span id="Warehouse-2330"><a href="#Warehouse-2330"><span class="linenos">2330</span></a>        <span class="c1"># Run ReceiveVehicleArrival behaviour for deliveries</span>
</span><span id="Warehouse-2331"><a href="#Warehouse-2331"><span class="linenos">2331</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveVehicleArrival</span><span class="p">()</span>
</span><span id="Warehouse-2332"><a href="#Warehouse-2332"><span class="linenos">2332</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse-2333"><a href="#Warehouse-2333"><span class="linenos">2333</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2334"><a href="#Warehouse-2334"><span class="linenos">2334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Warehouse-2335"><a href="#Warehouse-2335"><span class="linenos">2335</span></a>        
</span><span id="Warehouse-2336"><a href="#Warehouse-2336"><span class="linenos">2336</span></a>        <span class="c1"># Run ReceiveTimeDelta</span>
</span><span id="Warehouse-2337"><a href="#Warehouse-2337"><span class="linenos">2337</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveTimeDelta</span><span class="p">()</span>
</span><span id="Warehouse-2338"><a href="#Warehouse-2338"><span class="linenos">2338</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse-2339"><a href="#Warehouse-2339"><span class="linenos">2339</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="Warehouse-2340"><a href="#Warehouse-2340"><span class="linenos">2340</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Warehouse Agent for Supply Chain Management System.</p>

<p>The Warehouse agent acts as a critical intermediary in the supply chain, managing
inventory, fulfilling store orders, and coordinating with suppliers and vehicles.
It implements dual FIPA Contract Net Protocol roles, acting as both participant
and initiator depending on the interaction context.</p>

<p>FIPA Contract Net Protocol - Dual Role Implementation:</p>

<ol>
<li><p><strong>As Participant (with Stores)</strong>:</p>

<ul>
<li><strong>Proposal Phase</strong>: Receives store-buy CFP from stores</li>
<li><strong>Proposal Submission</strong>: Sends warehouse-accept (propose) or warehouse-reject (refuse)</li>
<li><strong>Result Reception</strong>: Receives store-confirm (accept-proposal) or store-deny (reject-proposal)</li>
<li><strong>Execution</strong>: Assigns vehicles for confirmed orders</li>
</ul></li>
<li><p><strong>As Initiator (with Suppliers)</strong>:</p>

<ul>
<li><strong>CFP Phase</strong>: Sends warehouse-buy CFP to suppliers for restocking</li>
<li><strong>Proposal Collection</strong>: Receives supplier-accept (propose) or supplier-reject (refuse)</li>
<li><strong>Evaluation</strong>: Scores suppliers based on delivery time</li>
<li><strong>Award</strong>: Sends warehouse-confirm (accept-proposal) or warehouse-deny (reject-proposal)</li>
</ul></li>
</ol>

<h6 id="stock-management-strategy">Stock Management Strategy:</h6>

<blockquote>
  <p>The warehouse uses a three-tier stock system:</p>
  
  <ol>
  <li><strong>Available Stock</strong> (self.stock): Products available for new orders</li>
  <li><strong>Locked Stock</strong> (self.locked_stock): Reserved for pending negotiations</li>
  <li><strong>Pending Deliveries</strong> (self.pending_deliveries): Confirmed orders awaiting pickup</li>
  </ol>
</blockquote>

<h6 id="id-encoding-system">ID Encoding System:</h6>

<blockquote>
  <p>Similar to Store agent, uses hierarchical encoding:</p>
  
  <ul>
  <li>Formula: <code>agent_type * 100_000_000 + instance_id * 1_000_000 + request_counter</code></li>
  <li>Agent type code for Warehouse: 2</li>
  <li>Example: warehouse1's first request = 2_001_000_000</li>
  </ul>
</blockquote>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>jid (str):</strong>  Jabber ID of the warehouse agent (e.g., "warehouse1@localhost").</li>
<li><strong>node_id (int):</strong>  Graph node ID representing the warehouse's physical location.</li>
<li><strong>map (Graph):</strong>  Reference to the world graph for pathfinding calculations.</li>
<li><strong>contact_list (list[str]):</strong>  JIDs for stores, suppliers, and vehicles.</li>
<li><strong>verbose (bool):</strong>  Flag to control debug output verbosity.</li>
<li><strong>id_base (int):</strong>  Base value for generating unique request IDs.</li>
<li><strong>stock (dict[str, int]):</strong>  Available inventory (not locked or pending).</li>
<li><strong>locked_stock (dict[str, int]):</strong>  Stock reserved during store negotiations.</li>
<li><strong>current_capacity (dict[str, int]):</strong>  Remaining capacity per product.</li>
<li><strong>pending_deliveries (dict[int, Order]):</strong>  Confirmed orders awaiting vehicle pickup.</li>
<li><strong>vehicle_proposals (dict[int, dict[str, tuple[bool, int]]]):</strong>  Vehicle delivery proposals.
Format: {order_id: {vehicle_jid: (can_fit, delivery_time)}}</li>
<li><strong>vehicles (list[str]):</strong>  List of vehicle JIDs discovered from contacts.</li>
<li><strong>suppliers (list[str]):</strong>  List of supplier JIDs discovered from contacts.</li>
<li><strong>request_counter (int):</strong>  Monotonic counter for unique request IDs.</li>
<li><strong>current_buy_request (Message):</strong>  Most recent supplier purchase request.</li>
<li><strong>failed_requests (queue.Queue):</strong>  Queue of failed supplier requests for retry.</li>
<li><strong>presence_infos (dict[str, str]):</strong>  Vehicle presence status cache.</li>
<li><strong>current_tick (int):</strong>  Current simulation time, synchronized by world agent.</li>
</ul>

<h6 id="behaviours">Behaviours:</h6>

<blockquote>
  <p>Store Interaction:
      - ReceiveBuyRequest: Processes store purchase requests (FIPA participant)
      - AcceptBuyRequest: Sends proposal to store (FIPA propose)
      - RejectBuyRequest: Sends refusal to store (FIPA refuse)
      - ReceiveConfirmationOrDenial: Handles store's award/rejection
      - AssignVehicle: Coordinates vehicle assignment for deliveries
      - ReceivePresenceInfo: Checks vehicle availability
      - ReceiveVehicleProposals: Collects vehicle delivery proposals
      - ChooseBestVehicle: Selects optimal vehicle using scoring algorithm</p>
  
  <p>Supplier Interaction:
      - BuyMaterial: Initiates purchase requests to suppliers (FIPA initiator)
      - CollectSupplierResponses: Coordinator for supplier negotiation
      - ReceiveAllSupplierResponses: Worker collecting supplier responses
      - SendWarehouseConfirmation: Awards contract to supplier (FIPA accept-proposal)
      - SendWarehouseDenial: Rejects supplier proposals (FIPA reject-proposal)
      - RetryPreviousBuy: Retries failed supplier requests
      - HandleResupply: Monitors stock and triggers restocking</p>
  
  <p>Vehicle &amp; Time Management:
      - ReceiveVehicleArrival: Handles vehicle pickup and delivery notifications
      - ReceiveTimeDelta: Synchronizes time and applies traffic updates</p>
</blockquote>

<h6 id="message-protocols">Message Protocols:</h6>

<blockquote>
  <p>Incoming from Stores:
      - store-buy: Purchase request (FIPA CFP)
      - store-confirm: Order confirmation (FIPA accept-proposal)
      - store-deny: Order rejection (FIPA reject-proposal)</p>
  
  <p>Outgoing to Stores:
      - warehouse-accept: Order proposal (FIPA propose)
      - warehouse-reject: Order refusal (FIPA refuse)</p>
  
  <p>Outgoing to Suppliers:
      - warehouse-buy: Purchase request (FIPA CFP)
      - warehouse-confirm: Supplier confirmation (FIPA accept-proposal)
      - warehouse-deny: Supplier rejection (FIPA reject-proposal)</p>
  
  <p>Incoming from Suppliers:
      - supplier-accept: Material proposal (FIPA propose)
      - supplier-reject: Material refusal (FIPA refuse)</p>
  
  <p>Vehicle Communication:
      - order-proposal: Request vehicle delivery quote
      - vehicle-proposal: Vehicle delivery proposal
      - order-confirmation: Confirm vehicle assignment
      - vehicle-pickup: Vehicle picks up order
      - vehicle-delivery: Vehicle delivers supplies
      - presence-info: Request vehicle availability
      - presence-response: Vehicle availability status</p>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">warehouse</span> <span class="o">=</span> <span class="n">Warehouse</span><span class="p">(</span>
    <span class="n">jid</span><span class="o">=</span><span class="s2">&quot;warehouse1@localhost&quot;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">,</span>
    <span class="nb">map</span><span class="o">=</span><span class="n">world_graph</span><span class="p">,</span>
    <span class="n">node_id</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">contact_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;store1@localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;supplier1@localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle1@localhost&quot;</span><span class="p">],</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">await</span> <span class="n">warehouse</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre>
  </div>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>The warehouse automatically restocks when inventory falls below
  config.WAREHOUSE_RESUPPLY_THRESHOLD, maintaining operational capacity.</p>
</blockquote>
</div>


                            <div id="Warehouse.__init__" class="classattr">
                                        <input id="Warehouse.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Warehouse</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">jid</span>,</span><span class="param">	<span class="n">password</span>,</span><span class="param">	<span class="nb">map</span><span class="p">:</span> <span class="n">world</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Graph</span>,</span><span class="param">	<span class="n">node_id</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">port</span><span class="o">=</span><span class="mi">5222</span>,</span><span class="param">	<span class="n">verify_security</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">contact_list</span><span class="o">=</span><span class="p">[]</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="Warehouse.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.__init__-2055"><a href="#Warehouse.__init__-2055"><span class="linenos">2055</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="nb">map</span> <span class="p">:</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">node_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">5222</span><span class="p">,</span> <span class="n">verify_security</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">contact_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="Warehouse.__init__-2056"><a href="#Warehouse.__init__-2056"><span class="linenos">2056</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.__init__-2057"><a href="#Warehouse.__init__-2057"><span class="linenos">2057</span></a><span class="sd">        Initialize the Warehouse agent with connection parameters and world state.</span>
</span><span id="Warehouse.__init__-2058"><a href="#Warehouse.__init__-2058"><span class="linenos">2058</span></a><span class="sd">        </span>
</span><span id="Warehouse.__init__-2059"><a href="#Warehouse.__init__-2059"><span class="linenos">2059</span></a><span class="sd">        The constructor configures the warehouse&#39;s identity, location, and initial</span>
</span><span id="Warehouse.__init__-2060"><a href="#Warehouse.__init__-2060"><span class="linenos">2060</span></a><span class="sd">        state. It implements the ID encoding system for generating unique request</span>
</span><span id="Warehouse.__init__-2061"><a href="#Warehouse.__init__-2061"><span class="linenos">2061</span></a><span class="sd">        identifiers compatible with the FIPA Contract Net Protocol.</span>
</span><span id="Warehouse.__init__-2062"><a href="#Warehouse.__init__-2062"><span class="linenos">2062</span></a><span class="sd">        </span>
</span><span id="Warehouse.__init__-2063"><a href="#Warehouse.__init__-2063"><span class="linenos">2063</span></a><span class="sd">        ID Encoding System:</span>
</span><span id="Warehouse.__init__-2064"><a href="#Warehouse.__init__-2064"><span class="linenos">2064</span></a><span class="sd">            Formula: `agent_type * 100_000_000 + instance_id * 1_000_000 + counter`</span>
</span><span id="Warehouse.__init__-2065"><a href="#Warehouse.__init__-2065"><span class="linenos">2065</span></a><span class="sd">            - Agent Type Code: 2 (for Warehouse agents)</span>
</span><span id="Warehouse.__init__-2066"><a href="#Warehouse.__init__-2066"><span class="linenos">2066</span></a><span class="sd">            - Instance ID: Extracted from JID (e.g., &quot;warehouse3&quot; -&gt; 3)</span>
</span><span id="Warehouse.__init__-2067"><a href="#Warehouse.__init__-2067"><span class="linenos">2067</span></a><span class="sd">            - Base ID Calculation: `2 * 100_000_000 + instance_id * 1_000_000`</span>
</span><span id="Warehouse.__init__-2068"><a href="#Warehouse.__init__-2068"><span class="linenos">2068</span></a><span class="sd">            </span>
</span><span id="Warehouse.__init__-2069"><a href="#Warehouse.__init__-2069"><span class="linenos">2069</span></a><span class="sd">            Examples:</span>
</span><span id="Warehouse.__init__-2070"><a href="#Warehouse.__init__-2070"><span class="linenos">2070</span></a><span class="sd">                - warehouse1: base = 201_000_000 (first request: 201_000_000)</span>
</span><span id="Warehouse.__init__-2071"><a href="#Warehouse.__init__-2071"><span class="linenos">2071</span></a><span class="sd">                - warehouse2: base = 202_000_000 (first request: 202_000_000)</span>
</span><span id="Warehouse.__init__-2072"><a href="#Warehouse.__init__-2072"><span class="linenos">2072</span></a><span class="sd">                - warehouse5: base = 205_000_000 (first request: 205_000_000)</span>
</span><span id="Warehouse.__init__-2073"><a href="#Warehouse.__init__-2073"><span class="linenos">2073</span></a><span class="sd">            </span>
</span><span id="Warehouse.__init__-2074"><a href="#Warehouse.__init__-2074"><span class="linenos">2074</span></a><span class="sd">            This encoding allows agents to identify:</span>
</span><span id="Warehouse.__init__-2075"><a href="#Warehouse.__init__-2075"><span class="linenos">2075</span></a><span class="sd">                1. What type of agent created the request (200M range = warehouse)</span>
</span><span id="Warehouse.__init__-2076"><a href="#Warehouse.__init__-2076"><span class="linenos">2076</span></a><span class="sd">                2. Which specific warehouse instance (next 1M range)</span>
</span><span id="Warehouse.__init__-2077"><a href="#Warehouse.__init__-2077"><span class="linenos">2077</span></a><span class="sd">                3. Which request in sequence (counter increments)</span>
</span><span id="Warehouse.__init__-2078"><a href="#Warehouse.__init__-2078"><span class="linenos">2078</span></a><span class="sd">        </span>
</span><span id="Warehouse.__init__-2079"><a href="#Warehouse.__init__-2079"><span class="linenos">2079</span></a><span class="sd">        Args:</span>
</span><span id="Warehouse.__init__-2080"><a href="#Warehouse.__init__-2080"><span class="linenos">2080</span></a><span class="sd">            jid (str): Jabber ID for XMPP communication (e.g., &quot;warehouse1@localhost&quot;).</span>
</span><span id="Warehouse.__init__-2081"><a href="#Warehouse.__init__-2081"><span class="linenos">2081</span></a><span class="sd">            password (str): Authentication password for XMPP server.</span>
</span><span id="Warehouse.__init__-2082"><a href="#Warehouse.__init__-2082"><span class="linenos">2082</span></a><span class="sd">            map (Graph): Reference to the world graph for pathfinding and locations.</span>
</span><span id="Warehouse.__init__-2083"><a href="#Warehouse.__init__-2083"><span class="linenos">2083</span></a><span class="sd">            node_id (int): Graph node representing the warehouse&#39;s physical location.</span>
</span><span id="Warehouse.__init__-2084"><a href="#Warehouse.__init__-2084"><span class="linenos">2084</span></a><span class="sd">            port (int, optional): XMPP server port. Defaults to 5222.</span>
</span><span id="Warehouse.__init__-2085"><a href="#Warehouse.__init__-2085"><span class="linenos">2085</span></a><span class="sd">            verify_security (bool, optional): Enable SSL/TLS verification. Defaults to False.</span>
</span><span id="Warehouse.__init__-2086"><a href="#Warehouse.__init__-2086"><span class="linenos">2086</span></a><span class="sd">            contact_list (list[str], optional): JIDs of stores, suppliers, vehicles for presence</span>
</span><span id="Warehouse.__init__-2087"><a href="#Warehouse.__init__-2087"><span class="linenos">2087</span></a><span class="sd">                subscription. Defaults to empty list.</span>
</span><span id="Warehouse.__init__-2088"><a href="#Warehouse.__init__-2088"><span class="linenos">2088</span></a><span class="sd">            verbose (bool, optional): Enable detailed debug logging. Defaults to False.</span>
</span><span id="Warehouse.__init__-2089"><a href="#Warehouse.__init__-2089"><span class="linenos">2089</span></a><span class="sd">        </span>
</span><span id="Warehouse.__init__-2090"><a href="#Warehouse.__init__-2090"><span class="linenos">2090</span></a><span class="sd">        Attributes Initialized:</span>
</span><span id="Warehouse.__init__-2091"><a href="#Warehouse.__init__-2091"><span class="linenos">2091</span></a><span class="sd">            Core Identity:</span>
</span><span id="Warehouse.__init__-2092"><a href="#Warehouse.__init__-2092"><span class="linenos">2092</span></a><span class="sd">                - node_id: Warehouse location on graph</span>
</span><span id="Warehouse.__init__-2093"><a href="#Warehouse.__init__-2093"><span class="linenos">2093</span></a><span class="sd">                - map: World graph reference</span>
</span><span id="Warehouse.__init__-2094"><a href="#Warehouse.__init__-2094"><span class="linenos">2094</span></a><span class="sd">                - contact_list: Agents for presence subscription</span>
</span><span id="Warehouse.__init__-2095"><a href="#Warehouse.__init__-2095"><span class="linenos">2095</span></a><span class="sd">                - verbose: Debug output flag</span>
</span><span id="Warehouse.__init__-2096"><a href="#Warehouse.__init__-2096"><span class="linenos">2096</span></a><span class="sd">            </span>
</span><span id="Warehouse.__init__-2097"><a href="#Warehouse.__init__-2097"><span class="linenos">2097</span></a><span class="sd">            ID Encoding:</span>
</span><span id="Warehouse.__init__-2098"><a href="#Warehouse.__init__-2098"><span class="linenos">2098</span></a><span class="sd">                - id_base: Base value for generating unique request IDs</span>
</span><span id="Warehouse.__init__-2099"><a href="#Warehouse.__init__-2099"><span class="linenos">2099</span></a><span class="sd">                - request_counter: Monotonic counter for requests</span>
</span><span id="Warehouse.__init__-2100"><a href="#Warehouse.__init__-2100"><span class="linenos">2100</span></a><span class="sd">            </span>
</span><span id="Warehouse.__init__-2101"><a href="#Warehouse.__init__-2101"><span class="linenos">2101</span></a><span class="sd">            Order Management:</span>
</span><span id="Warehouse.__init__-2102"><a href="#Warehouse.__init__-2102"><span class="linenos">2102</span></a><span class="sd">                - pending_deliveries: Dict mapping order_id -&gt; Order objects</span>
</span><span id="Warehouse.__init__-2103"><a href="#Warehouse.__init__-2103"><span class="linenos">2103</span></a><span class="sd">                - vehicle_proposals: Dict mapping order_id -&gt; vehicle proposals</span>
</span><span id="Warehouse.__init__-2104"><a href="#Warehouse.__init__-2104"><span class="linenos">2104</span></a><span class="sd">            </span>
</span><span id="Warehouse.__init__-2105"><a href="#Warehouse.__init__-2105"><span class="linenos">2105</span></a><span class="sd">            Contact Discovery:</span>
</span><span id="Warehouse.__init__-2106"><a href="#Warehouse.__init__-2106"><span class="linenos">2106</span></a><span class="sd">                - vehicles: List of vehicle JIDs (populated during setup)</span>
</span><span id="Warehouse.__init__-2107"><a href="#Warehouse.__init__-2107"><span class="linenos">2107</span></a><span class="sd">                - suppliers: List of supplier JIDs (populated during setup)</span>
</span><span id="Warehouse.__init__-2108"><a href="#Warehouse.__init__-2108"><span class="linenos">2108</span></a><span class="sd">        </span>
</span><span id="Warehouse.__init__-2109"><a href="#Warehouse.__init__-2109"><span class="linenos">2109</span></a><span class="sd">        Example:</span>
</span><span id="Warehouse.__init__-2110"><a href="#Warehouse.__init__-2110"><span class="linenos">2110</span></a><span class="sd">            ```python</span>
</span><span id="Warehouse.__init__-2111"><a href="#Warehouse.__init__-2111"><span class="linenos">2111</span></a><span class="sd">            warehouse = Warehouse(</span>
</span><span id="Warehouse.__init__-2112"><a href="#Warehouse.__init__-2112"><span class="linenos">2112</span></a><span class="sd">                jid=&quot;warehouse1@localhost&quot;,</span>
</span><span id="Warehouse.__init__-2113"><a href="#Warehouse.__init__-2113"><span class="linenos">2113</span></a><span class="sd">                password=&quot;password123&quot;,</span>
</span><span id="Warehouse.__init__-2114"><a href="#Warehouse.__init__-2114"><span class="linenos">2114</span></a><span class="sd">                map=world_graph,</span>
</span><span id="Warehouse.__init__-2115"><a href="#Warehouse.__init__-2115"><span class="linenos">2115</span></a><span class="sd">                node_id=10,</span>
</span><span id="Warehouse.__init__-2116"><a href="#Warehouse.__init__-2116"><span class="linenos">2116</span></a><span class="sd">                contact_list=[</span>
</span><span id="Warehouse.__init__-2117"><a href="#Warehouse.__init__-2117"><span class="linenos">2117</span></a><span class="sd">                    &quot;store1@localhost&quot;,</span>
</span><span id="Warehouse.__init__-2118"><a href="#Warehouse.__init__-2118"><span class="linenos">2118</span></a><span class="sd">                    &quot;store2@localhost&quot;,</span>
</span><span id="Warehouse.__init__-2119"><a href="#Warehouse.__init__-2119"><span class="linenos">2119</span></a><span class="sd">                    &quot;supplier1@localhost&quot;,</span>
</span><span id="Warehouse.__init__-2120"><a href="#Warehouse.__init__-2120"><span class="linenos">2120</span></a><span class="sd">                    &quot;vehicle1@localhost&quot;</span>
</span><span id="Warehouse.__init__-2121"><a href="#Warehouse.__init__-2121"><span class="linenos">2121</span></a><span class="sd">                ],</span>
</span><span id="Warehouse.__init__-2122"><a href="#Warehouse.__init__-2122"><span class="linenos">2122</span></a><span class="sd">                verbose=True</span>
</span><span id="Warehouse.__init__-2123"><a href="#Warehouse.__init__-2123"><span class="linenos">2123</span></a><span class="sd">            )</span>
</span><span id="Warehouse.__init__-2124"><a href="#Warehouse.__init__-2124"><span class="linenos">2124</span></a><span class="sd">            # ID base calculated: 2 * 100_000_000 + 1 * 1_000_000 = 201_000_000</span>
</span><span id="Warehouse.__init__-2125"><a href="#Warehouse.__init__-2125"><span class="linenos">2125</span></a><span class="sd">            # First request ID will be: 201_000_000</span>
</span><span id="Warehouse.__init__-2126"><a href="#Warehouse.__init__-2126"><span class="linenos">2126</span></a><span class="sd">            # Second request ID will be: 201_000_001</span>
</span><span id="Warehouse.__init__-2127"><a href="#Warehouse.__init__-2127"><span class="linenos">2127</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.__init__-2128"><a href="#Warehouse.__init__-2128"><span class="linenos">2128</span></a><span class="sd">        </span>
</span><span id="Warehouse.__init__-2129"><a href="#Warehouse.__init__-2129"><span class="linenos">2129</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse.__init__-2130"><a href="#Warehouse.__init__-2130"><span class="linenos">2130</span></a><span class="sd">            The constructor only initializes essential attributes. Most warehouse</span>
</span><span id="Warehouse.__init__-2131"><a href="#Warehouse.__init__-2131"><span class="linenos">2131</span></a><span class="sd">            state (stock, locked_stock, behaviours) is configured in the setup()</span>
</span><span id="Warehouse.__init__-2132"><a href="#Warehouse.__init__-2132"><span class="linenos">2132</span></a><span class="sd">            method which runs after the agent connects to the XMPP server.</span>
</span><span id="Warehouse.__init__-2133"><a href="#Warehouse.__init__-2133"><span class="linenos">2133</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.__init__-2134"><a href="#Warehouse.__init__-2134"><span class="linenos">2134</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">verify_security</span><span class="p">)</span>
</span><span id="Warehouse.__init__-2135"><a href="#Warehouse.__init__-2135"><span class="linenos">2135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node_id</span>
</span><span id="Warehouse.__init__-2136"><a href="#Warehouse.__init__-2136"><span class="linenos">2136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="p">:</span> <span class="n">Graph</span> <span class="o">=</span> <span class="nb">map</span>
</span><span id="Warehouse.__init__-2137"><a href="#Warehouse.__init__-2137"><span class="linenos">2137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contact_list</span> <span class="o">=</span> <span class="n">contact_list</span>
</span><span id="Warehouse.__init__-2138"><a href="#Warehouse.__init__-2138"><span class="linenos">2138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="Warehouse.__init__-2139"><a href="#Warehouse.__init__-2139"><span class="linenos">2139</span></a>        <span class="c1"># Extract instance number from JID for ID encoding (e.g., &quot;warehouse1@localhost&quot; -&gt; 1)</span>
</span><span id="Warehouse.__init__-2140"><a href="#Warehouse.__init__-2140"><span class="linenos">2140</span></a>        <span class="n">jid_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Warehouse.__init__-2141"><a href="#Warehouse.__init__-2141"><span class="linenos">2141</span></a>        <span class="n">instance_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">,</span> <span class="n">jid_name</span><span class="p">)))</span>
</span><span id="Warehouse.__init__-2142"><a href="#Warehouse.__init__-2142"><span class="linenos">2142</span></a>
</span><span id="Warehouse.__init__-2143"><a href="#Warehouse.__init__-2143"><span class="linenos">2143</span></a>        <span class="c1"># Calculate ID base: Warehouse type code = 2</span>
</span><span id="Warehouse.__init__-2144"><a href="#Warehouse.__init__-2144"><span class="linenos">2144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id_base</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">100_000_000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">instance_id</span> <span class="o">*</span> <span class="mi">1_000_000</span><span class="p">)</span>
</span><span id="Warehouse.__init__-2145"><a href="#Warehouse.__init__-2145"><span class="linenos">2145</span></a>        
</span><span id="Warehouse.__init__-2146"><a href="#Warehouse.__init__-2146"><span class="linenos">2146</span></a>        <span class="c1"># Initialize critical attributes early to avoid AttributeError</span>
</span><span id="Warehouse.__init__-2147"><a href="#Warehouse.__init__-2147"><span class="linenos">2147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pending_deliveries</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># order_id as key and Order object as value</span>
</span><span id="Warehouse.__init__-2148"><a href="#Warehouse.__init__-2148"><span class="linenos">2148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_proposals</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse.__init__-2149"><a href="#Warehouse.__init__-2149"><span class="linenos">2149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Warehouse.__init__-2150"><a href="#Warehouse.__init__-2150"><span class="linenos">2150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">suppliers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Warehouse.__init__-2151"><a href="#Warehouse.__init__-2151"><span class="linenos">2151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the Warehouse agent with connection parameters and world state.</p>

<p>The constructor configures the warehouse's identity, location, and initial
state. It implements the ID encoding system for generating unique request
identifiers compatible with the FIPA Contract Net Protocol.</p>

<h6 id="id-encoding-system">ID Encoding System:</h6>

<blockquote>
  <p>Formula: <code>agent_type * 100_000_000 + instance_id * 1_000_000 + counter</code></p>
  
  <ul>
  <li>Agent Type Code: 2 (for Warehouse agents)</li>
  <li>Instance ID: Extracted from JID (e.g., "warehouse3" -> 3)</li>
  <li>Base ID Calculation: <code>2 * 100_000_000 + instance_id * 1_000_000</code></li>
  </ul>
  
  <p>Examples:
      - warehouse1: base = 201_000_000 (first request: 201_000_000)
      - warehouse2: base = 202_000_000 (first request: 202_000_000)
      - warehouse5: base = 205_000_000 (first request: 205_000_000)</p>
  
  <p>This encoding allows agents to identify:
      1. What type of agent created the request (200M range = warehouse)
      2. Which specific warehouse instance (next 1M range)
      3. Which request in sequence (counter increments)</p>
</blockquote>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>jid (str):</strong>  Jabber ID for XMPP communication (e.g., "warehouse1@localhost").</li>
<li><strong>password (str):</strong>  Authentication password for XMPP server.</li>
<li><strong>map (Graph):</strong>  Reference to the world graph for pathfinding and locations.</li>
<li><strong>node_id (int):</strong>  Graph node representing the warehouse's physical location.</li>
<li><strong>port (int, optional):</strong>  XMPP server port. Defaults to 5222.</li>
<li><strong>verify_security (bool, optional):</strong>  Enable SSL/TLS verification. Defaults to False.</li>
<li><strong>contact_list (list[str], optional):</strong>  JIDs of stores, suppliers, vehicles for presence
subscription. Defaults to empty list.</li>
<li><strong>verbose (bool, optional):</strong>  Enable detailed debug logging. Defaults to False.</li>
</ul>

<h6 id="attributes-initialized">Attributes Initialized:</h6>

<blockquote>
  <p>Core Identity:
      - node_id: Warehouse location on graph
      - map: World graph reference
      - contact_list: Agents for presence subscription
      - verbose: Debug output flag</p>
  
  <p>ID Encoding:
      - id_base: Base value for generating unique request IDs
      - request_counter: Monotonic counter for requests</p>
  
  <p>Order Management:
      - pending_deliveries: Dict mapping order_id -> Order objects
      - vehicle_proposals: Dict mapping order_id -> vehicle proposals</p>
  
  <p>Contact Discovery:
      - vehicles: List of vehicle JIDs (populated during setup)
      - suppliers: List of supplier JIDs (populated during setup)</p>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">warehouse</span> <span class="o">=</span> <span class="n">Warehouse</span><span class="p">(</span>
    <span class="n">jid</span><span class="o">=</span><span class="s2">&quot;warehouse1@localhost&quot;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password123&quot;</span><span class="p">,</span>
    <span class="nb">map</span><span class="o">=</span><span class="n">world_graph</span><span class="p">,</span>
    <span class="n">node_id</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">contact_list</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;store1@localhost&quot;</span><span class="p">,</span>
        <span class="s2">&quot;store2@localhost&quot;</span><span class="p">,</span>
        <span class="s2">&quot;supplier1@localhost&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vehicle1@localhost&quot;</span>
    <span class="p">],</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="c1"># ID base calculated: 2 * 100_000_000 + 1 * 1_000_000 = 201_000_000</span>
<span class="c1"># First request ID will be: 201_000_000</span>
<span class="c1"># Second request ID will be: 201_000_001</span>
</code></pre>
  </div>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>The constructor only initializes essential attributes. Most warehouse
  state (stock, locked_stock, behaviours) is configured in the setup()
  method which runs after the agent connects to the XMPP server.</p>
</blockquote>
</div>


                            </div>
                            <div id="Warehouse.calculate_supplier_score" class="classattr">
                                        <input id="Warehouse.calculate_supplier_score-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_supplier_score</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">accept_msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Warehouse.calculate_supplier_score-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.calculate_supplier_score"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.calculate_supplier_score-1810"><a href="#Warehouse.calculate_supplier_score-1810"><span class="linenos">1810</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_supplier_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Warehouse.calculate_supplier_score-1811"><a href="#Warehouse.calculate_supplier_score-1811"><span class="linenos">1811</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.calculate_supplier_score-1812"><a href="#Warehouse.calculate_supplier_score-1812"><span class="linenos">1812</span></a><span class="sd">        Calculate supplier score based on delivery time (used in FIPA supplier selection).</span>
</span><span id="Warehouse.calculate_supplier_score-1813"><a href="#Warehouse.calculate_supplier_score-1813"><span class="linenos">1813</span></a><span class="sd">        </span>
</span><span id="Warehouse.calculate_supplier_score-1814"><a href="#Warehouse.calculate_supplier_score-1814"><span class="linenos">1814</span></a><span class="sd">        This function evaluates supplier proposals in the FIPA Contract Net Protocol</span>
</span><span id="Warehouse.calculate_supplier_score-1815"><a href="#Warehouse.calculate_supplier_score-1815"><span class="linenos">1815</span></a><span class="sd">        by computing the estimated delivery time from supplier to warehouse using</span>
</span><span id="Warehouse.calculate_supplier_score-1816"><a href="#Warehouse.calculate_supplier_score-1816"><span class="linenos">1816</span></a><span class="sd">        Dijkstra&#39;s algorithm on the world graph. Lower scores indicate faster delivery.</span>
</span><span id="Warehouse.calculate_supplier_score-1817"><a href="#Warehouse.calculate_supplier_score-1817"><span class="linenos">1817</span></a><span class="sd">        </span>
</span><span id="Warehouse.calculate_supplier_score-1818"><a href="#Warehouse.calculate_supplier_score-1818"><span class="linenos">1818</span></a><span class="sd">        FIPA Protocol Context:</span>
</span><span id="Warehouse.calculate_supplier_score-1819"><a href="#Warehouse.calculate_supplier_score-1819"><span class="linenos">1819</span></a><span class="sd">            - Phase: Proposal Evaluation (Initiator evaluating participants)</span>
</span><span id="Warehouse.calculate_supplier_score-1820"><a href="#Warehouse.calculate_supplier_score-1820"><span class="linenos">1820</span></a><span class="sd">            - Used by: CollectSupplierResponses and ReceiveAllSupplierResponses</span>
</span><span id="Warehouse.calculate_supplier_score-1821"><a href="#Warehouse.calculate_supplier_score-1821"><span class="linenos">1821</span></a><span class="sd">            - Purpose: Select best supplier from multiple proposals</span>
</span><span id="Warehouse.calculate_supplier_score-1822"><a href="#Warehouse.calculate_supplier_score-1822"><span class="linenos">1822</span></a><span class="sd">        </span>
</span><span id="Warehouse.calculate_supplier_score-1823"><a href="#Warehouse.calculate_supplier_score-1823"><span class="linenos">1823</span></a><span class="sd">        Scoring Algorithm:</span>
</span><span id="Warehouse.calculate_supplier_score-1824"><a href="#Warehouse.calculate_supplier_score-1824"><span class="linenos">1824</span></a><span class="sd">            1. Extract supplier&#39;s node_id from message metadata</span>
</span><span id="Warehouse.calculate_supplier_score-1825"><a href="#Warehouse.calculate_supplier_score-1825"><span class="linenos">1825</span></a><span class="sd">            2. Run Dijkstra&#39;s algorithm: supplier_node  warehouse_node</span>
</span><span id="Warehouse.calculate_supplier_score-1826"><a href="#Warehouse.calculate_supplier_score-1826"><span class="linenos">1826</span></a><span class="sd">            3. Return estimated travel time as score</span>
</span><span id="Warehouse.calculate_supplier_score-1827"><a href="#Warehouse.calculate_supplier_score-1827"><span class="linenos">1827</span></a><span class="sd">            4. Lower score = shorter delivery time = better supplier</span>
</span><span id="Warehouse.calculate_supplier_score-1828"><a href="#Warehouse.calculate_supplier_score-1828"><span class="linenos">1828</span></a><span class="sd">        </span>
</span><span id="Warehouse.calculate_supplier_score-1829"><a href="#Warehouse.calculate_supplier_score-1829"><span class="linenos">1829</span></a><span class="sd">        Args:</span>
</span><span id="Warehouse.calculate_supplier_score-1830"><a href="#Warehouse.calculate_supplier_score-1830"><span class="linenos">1830</span></a><span class="sd">            accept_msg (Message): supplier-accept message containing:</span>
</span><span id="Warehouse.calculate_supplier_score-1831"><a href="#Warehouse.calculate_supplier_score-1831"><span class="linenos">1831</span></a><span class="sd">                - Metadata: &quot;node_id&quot; (supplier&#39;s graph location)</span>
</span><span id="Warehouse.calculate_supplier_score-1832"><a href="#Warehouse.calculate_supplier_score-1832"><span class="linenos">1832</span></a><span class="sd">                - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse.calculate_supplier_score-1833"><a href="#Warehouse.calculate_supplier_score-1833"><span class="linenos">1833</span></a><span class="sd">        </span>
</span><span id="Warehouse.calculate_supplier_score-1834"><a href="#Warehouse.calculate_supplier_score-1834"><span class="linenos">1834</span></a><span class="sd">        Returns:</span>
</span><span id="Warehouse.calculate_supplier_score-1835"><a href="#Warehouse.calculate_supplier_score-1835"><span class="linenos">1835</span></a><span class="sd">            float: Estimated delivery time (seconds). Lower is better.</span>
</span><span id="Warehouse.calculate_supplier_score-1836"><a href="#Warehouse.calculate_supplier_score-1836"><span class="linenos">1836</span></a><span class="sd">        </span>
</span><span id="Warehouse.calculate_supplier_score-1837"><a href="#Warehouse.calculate_supplier_score-1837"><span class="linenos">1837</span></a><span class="sd">        Example:</span>
</span><span id="Warehouse.calculate_supplier_score-1838"><a href="#Warehouse.calculate_supplier_score-1838"><span class="linenos">1838</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.calculate_supplier_score-1839"><a href="#Warehouse.calculate_supplier_score-1839"><span class="linenos">1839</span></a><span class="sd">            Warehouse at node 10</span>
</span><span id="Warehouse.calculate_supplier_score-1840"><a href="#Warehouse.calculate_supplier_score-1840"><span class="linenos">1840</span></a><span class="sd">            Supplier1 at node 5: delivery_time = 120s</span>
</span><span id="Warehouse.calculate_supplier_score-1841"><a href="#Warehouse.calculate_supplier_score-1841"><span class="linenos">1841</span></a><span class="sd">            Supplier2 at node 8: delivery_time = 85s</span>
</span><span id="Warehouse.calculate_supplier_score-1842"><a href="#Warehouse.calculate_supplier_score-1842"><span class="linenos">1842</span></a><span class="sd">            </span>
</span><span id="Warehouse.calculate_supplier_score-1843"><a href="#Warehouse.calculate_supplier_score-1843"><span class="linenos">1843</span></a><span class="sd">            calculate_supplier_score(supplier1_msg)  120.0</span>
</span><span id="Warehouse.calculate_supplier_score-1844"><a href="#Warehouse.calculate_supplier_score-1844"><span class="linenos">1844</span></a><span class="sd">            calculate_supplier_score(supplier2_msg)  85.0</span>
</span><span id="Warehouse.calculate_supplier_score-1845"><a href="#Warehouse.calculate_supplier_score-1845"><span class="linenos">1845</span></a><span class="sd">            </span>
</span><span id="Warehouse.calculate_supplier_score-1846"><a href="#Warehouse.calculate_supplier_score-1846"><span class="linenos">1846</span></a><span class="sd">            Winner: Supplier2 (lower score)</span>
</span><span id="Warehouse.calculate_supplier_score-1847"><a href="#Warehouse.calculate_supplier_score-1847"><span class="linenos">1847</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.calculate_supplier_score-1848"><a href="#Warehouse.calculate_supplier_score-1848"><span class="linenos">1848</span></a><span class="sd">        </span>
</span><span id="Warehouse.calculate_supplier_score-1849"><a href="#Warehouse.calculate_supplier_score-1849"><span class="linenos">1849</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse.calculate_supplier_score-1850"><a href="#Warehouse.calculate_supplier_score-1850"><span class="linenos">1850</span></a><span class="sd">            Currently uses time as the scoring metric. Could be extended to use</span>
</span><span id="Warehouse.calculate_supplier_score-1851"><a href="#Warehouse.calculate_supplier_score-1851"><span class="linenos">1851</span></a><span class="sd">            fuel cost or a weighted combination of multiple factors.</span>
</span><span id="Warehouse.calculate_supplier_score-1852"><a href="#Warehouse.calculate_supplier_score-1852"><span class="linenos">1852</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.calculate_supplier_score-1853"><a href="#Warehouse.calculate_supplier_score-1853"><span class="linenos">1853</span></a>        
</span><span id="Warehouse.calculate_supplier_score-1854"><a href="#Warehouse.calculate_supplier_score-1854"><span class="linenos">1854</span></a>        <span class="n">supplier_node_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">accept_msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.calculate_supplier_score-1855"><a href="#Warehouse.calculate_supplier_score-1855"><span class="linenos">1855</span></a>        <span class="n">path</span><span class="p">,</span> <span class="n">fuel</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">djikstra</span><span class="p">(</span><span class="n">supplier_node_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="Warehouse.calculate_supplier_score-1856"><a href="#Warehouse.calculate_supplier_score-1856"><span class="linenos">1856</span></a>        
</span><span id="Warehouse.calculate_supplier_score-1857"><a href="#Warehouse.calculate_supplier_score-1857"><span class="linenos">1857</span></a>        <span class="k">return</span> <span class="n">time</span>  <span class="c1"># Use time as score (could also use fuel)</span>
</span></pre></div>


            <div class="docstring"><p>Calculate supplier score based on delivery time (used in FIPA supplier selection).</p>

<p>This function evaluates supplier proposals in the FIPA Contract Net Protocol
by computing the estimated delivery time from supplier to warehouse using
Dijkstra's algorithm on the world graph. Lower scores indicate faster delivery.</p>

<h6 id="fipa-protocol-context">FIPA Protocol Context:</h6>

<blockquote>
  <ul>
  <li>Phase: Proposal Evaluation (Initiator evaluating participants)</li>
  <li>Used by: CollectSupplierResponses and ReceiveAllSupplierResponses</li>
  <li>Purpose: Select best supplier from multiple proposals</li>
  </ul>
</blockquote>

<h6 id="scoring-algorithm">Scoring Algorithm:</h6>

<blockquote>
  <ol>
  <li>Extract supplier's node_id from message metadata</li>
  <li>Run Dijkstra's algorithm: supplier_node  warehouse_node</li>
  <li>Return estimated travel time as score</li>
  <li>Lower score = shorter delivery time = better supplier</li>
  </ol>
</blockquote>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>accept_msg (Message):</strong>  supplier-accept message containing:
<ul>
<li>Metadata: "node_id" (supplier's graph location)</li>
<li>Body: "{quantity} {product}"</li>
</ul></li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>float: Estimated delivery time (seconds). Lower is better.</p>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
<pre><code>Warehouse at node 10
Supplier1 at node 5: delivery_time = 120s
Supplier2 at node 8: delivery_time = 85s

calculate_supplier_score(supplier1_msg)  120.0
calculate_supplier_score(supplier2_msg)  85.0

Winner: Supplier2 (lower score)
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Currently uses time as the scoring metric. Could be extended to use
  fuel cost or a weighted combination of multiple factors.</p>
</blockquote>
</div>


                            </div>
                            <div id="Warehouse.message_to_order" class="classattr">
                                        <input id="Warehouse.message_to_order-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">message_to_order</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span></span><span class="return-annotation">) -> <span class="n">veiculos</span><span class="o">.</span><span class="n">veiculos</span><span class="o">.</span><span class="n">Order</span>:</span></span>

                <label class="view-source-button" for="Warehouse.message_to_order-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.message_to_order"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.message_to_order-1859"><a href="#Warehouse.message_to_order-1859"><span class="linenos">1859</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">message_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
</span><span id="Warehouse.message_to_order-1860"><a href="#Warehouse.message_to_order-1860"><span class="linenos">1860</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.message_to_order-1861"><a href="#Warehouse.message_to_order-1861"><span class="linenos">1861</span></a><span class="sd">        Convert store-confirm message to Order object for delivery tracking.</span>
</span><span id="Warehouse.message_to_order-1862"><a href="#Warehouse.message_to_order-1862"><span class="linenos">1862</span></a><span class="sd">        </span>
</span><span id="Warehouse.message_to_order-1863"><a href="#Warehouse.message_to_order-1863"><span class="linenos">1863</span></a><span class="sd">        This helper function transforms a FIPA accept-proposal message from a store</span>
</span><span id="Warehouse.message_to_order-1864"><a href="#Warehouse.message_to_order-1864"><span class="linenos">1864</span></a><span class="sd">        into a structured Order object that can be stored in pending_deliveries</span>
</span><span id="Warehouse.message_to_order-1865"><a href="#Warehouse.message_to_order-1865"><span class="linenos">1865</span></a><span class="sd">        and assigned to vehicles for transportation.</span>
</span><span id="Warehouse.message_to_order-1866"><a href="#Warehouse.message_to_order-1866"><span class="linenos">1866</span></a><span class="sd">        </span>
</span><span id="Warehouse.message_to_order-1867"><a href="#Warehouse.message_to_order-1867"><span class="linenos">1867</span></a><span class="sd">        FIPA Protocol Context:</span>
</span><span id="Warehouse.message_to_order-1868"><a href="#Warehouse.message_to_order-1868"><span class="linenos">1868</span></a><span class="sd">            - Triggered by: store-confirm message (FIPA accept-proposal)</span>
</span><span id="Warehouse.message_to_order-1869"><a href="#Warehouse.message_to_order-1869"><span class="linenos">1869</span></a><span class="sd">            - Used by: ReceiveConfirmationOrDenial behaviour</span>
</span><span id="Warehouse.message_to_order-1870"><a href="#Warehouse.message_to_order-1870"><span class="linenos">1870</span></a><span class="sd">            - Purpose: Create deliverable order from confirmed proposal</span>
</span><span id="Warehouse.message_to_order-1871"><a href="#Warehouse.message_to_order-1871"><span class="linenos">1871</span></a><span class="sd">        </span>
</span><span id="Warehouse.message_to_order-1872"><a href="#Warehouse.message_to_order-1872"><span class="linenos">1872</span></a><span class="sd">        Message Parsing:</span>
</span><span id="Warehouse.message_to_order-1873"><a href="#Warehouse.message_to_order-1873"><span class="linenos">1873</span></a><span class="sd">            Body Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse.message_to_order-1874"><a href="#Warehouse.message_to_order-1874"><span class="linenos">1874</span></a><span class="sd">            Example: &quot;50 electronics&quot;</span>
</span><span id="Warehouse.message_to_order-1875"><a href="#Warehouse.message_to_order-1875"><span class="linenos">1875</span></a><span class="sd">            </span>
</span><span id="Warehouse.message_to_order-1876"><a href="#Warehouse.message_to_order-1876"><span class="linenos">1876</span></a><span class="sd">            Metadata Extracted:</span>
</span><span id="Warehouse.message_to_order-1877"><a href="#Warehouse.message_to_order-1877"><span class="linenos">1877</span></a><span class="sd">                - request_id: Unique order identifier</span>
</span><span id="Warehouse.message_to_order-1878"><a href="#Warehouse.message_to_order-1878"><span class="linenos">1878</span></a><span class="sd">                - node_id: Store&#39;s graph location (delivery destination)</span>
</span><span id="Warehouse.message_to_order-1879"><a href="#Warehouse.message_to_order-1879"><span class="linenos">1879</span></a><span class="sd">        </span>
</span><span id="Warehouse.message_to_order-1880"><a href="#Warehouse.message_to_order-1880"><span class="linenos">1880</span></a><span class="sd">        Args:</span>
</span><span id="Warehouse.message_to_order-1881"><a href="#Warehouse.message_to_order-1881"><span class="linenos">1881</span></a><span class="sd">            msg (Message): store-confirm message with:</span>
</span><span id="Warehouse.message_to_order-1882"><a href="#Warehouse.message_to_order-1882"><span class="linenos">1882</span></a><span class="sd">                - Body: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse.message_to_order-1883"><a href="#Warehouse.message_to_order-1883"><span class="linenos">1883</span></a><span class="sd">                - Metadata: request_id, node_id</span>
</span><span id="Warehouse.message_to_order-1884"><a href="#Warehouse.message_to_order-1884"><span class="linenos">1884</span></a><span class="sd">                - Sender: Store JID</span>
</span><span id="Warehouse.message_to_order-1885"><a href="#Warehouse.message_to_order-1885"><span class="linenos">1885</span></a><span class="sd">        </span>
</span><span id="Warehouse.message_to_order-1886"><a href="#Warehouse.message_to_order-1886"><span class="linenos">1886</span></a><span class="sd">        Returns:</span>
</span><span id="Warehouse.message_to_order-1887"><a href="#Warehouse.message_to_order-1887"><span class="linenos">1887</span></a><span class="sd">            Order: Structured order object with:</span>
</span><span id="Warehouse.message_to_order-1888"><a href="#Warehouse.message_to_order-1888"><span class="linenos">1888</span></a><span class="sd">                - product: Product type</span>
</span><span id="Warehouse.message_to_order-1889"><a href="#Warehouse.message_to_order-1889"><span class="linenos">1889</span></a><span class="sd">                - quantity: Amount to deliver</span>
</span><span id="Warehouse.message_to_order-1890"><a href="#Warehouse.message_to_order-1890"><span class="linenos">1890</span></a><span class="sd">                - orderid: Unique identifier</span>
</span><span id="Warehouse.message_to_order-1891"><a href="#Warehouse.message_to_order-1891"><span class="linenos">1891</span></a><span class="sd">                - sender: Store JID (delivery destination)</span>
</span><span id="Warehouse.message_to_order-1892"><a href="#Warehouse.message_to_order-1892"><span class="linenos">1892</span></a><span class="sd">                - receiver: Warehouse JID (pickup location)</span>
</span><span id="Warehouse.message_to_order-1893"><a href="#Warehouse.message_to_order-1893"><span class="linenos">1893</span></a><span class="sd">                - sender_location: Store&#39;s graph node</span>
</span><span id="Warehouse.message_to_order-1894"><a href="#Warehouse.message_to_order-1894"><span class="linenos">1894</span></a><span class="sd">                - receiver_location: Warehouse&#39;s graph node</span>
</span><span id="Warehouse.message_to_order-1895"><a href="#Warehouse.message_to_order-1895"><span class="linenos">1895</span></a><span class="sd">        </span>
</span><span id="Warehouse.message_to_order-1896"><a href="#Warehouse.message_to_order-1896"><span class="linenos">1896</span></a><span class="sd">        Order Object Structure:</span>
</span><span id="Warehouse.message_to_order-1897"><a href="#Warehouse.message_to_order-1897"><span class="linenos">1897</span></a><span class="sd">            The Order uses inverted semantics for delivery context:</span>
</span><span id="Warehouse.message_to_order-1898"><a href="#Warehouse.message_to_order-1898"><span class="linenos">1898</span></a><span class="sd">            - sender = Store (WHERE to deliver)</span>
</span><span id="Warehouse.message_to_order-1899"><a href="#Warehouse.message_to_order-1899"><span class="linenos">1899</span></a><span class="sd">            - receiver = Warehouse (WHERE to pickup)</span>
</span><span id="Warehouse.message_to_order-1900"><a href="#Warehouse.message_to_order-1900"><span class="linenos">1900</span></a><span class="sd">            - sender_location = Store node (delivery destination)</span>
</span><span id="Warehouse.message_to_order-1901"><a href="#Warehouse.message_to_order-1901"><span class="linenos">1901</span></a><span class="sd">            - receiver_location = Warehouse node (pickup origin)</span>
</span><span id="Warehouse.message_to_order-1902"><a href="#Warehouse.message_to_order-1902"><span class="linenos">1902</span></a><span class="sd">        </span>
</span><span id="Warehouse.message_to_order-1903"><a href="#Warehouse.message_to_order-1903"><span class="linenos">1903</span></a><span class="sd">        Example:</span>
</span><span id="Warehouse.message_to_order-1904"><a href="#Warehouse.message_to_order-1904"><span class="linenos">1904</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.message_to_order-1905"><a href="#Warehouse.message_to_order-1905"><span class="linenos">1905</span></a><span class="sd">            Input Message (store-confirm):</span>
</span><span id="Warehouse.message_to_order-1906"><a href="#Warehouse.message_to_order-1906"><span class="linenos">1906</span></a><span class="sd">                Body: &quot;50 electronics&quot;</span>
</span><span id="Warehouse.message_to_order-1907"><a href="#Warehouse.message_to_order-1907"><span class="linenos">1907</span></a><span class="sd">                Metadata:</span>
</span><span id="Warehouse.message_to_order-1908"><a href="#Warehouse.message_to_order-1908"><span class="linenos">1908</span></a><span class="sd">                    - request_id: &quot;201000000&quot;</span>
</span><span id="Warehouse.message_to_order-1909"><a href="#Warehouse.message_to_order-1909"><span class="linenos">1909</span></a><span class="sd">                    - node_id: &quot;15&quot;</span>
</span><span id="Warehouse.message_to_order-1910"><a href="#Warehouse.message_to_order-1910"><span class="linenos">1910</span></a><span class="sd">                Sender: &quot;store1@localhost&quot;</span>
</span><span id="Warehouse.message_to_order-1911"><a href="#Warehouse.message_to_order-1911"><span class="linenos">1911</span></a><span class="sd">            </span>
</span><span id="Warehouse.message_to_order-1912"><a href="#Warehouse.message_to_order-1912"><span class="linenos">1912</span></a><span class="sd">            Warehouse: &quot;warehouse1@localhost&quot; at node 10</span>
</span><span id="Warehouse.message_to_order-1913"><a href="#Warehouse.message_to_order-1913"><span class="linenos">1913</span></a><span class="sd">            </span>
</span><span id="Warehouse.message_to_order-1914"><a href="#Warehouse.message_to_order-1914"><span class="linenos">1914</span></a><span class="sd">            Output Order:</span>
</span><span id="Warehouse.message_to_order-1915"><a href="#Warehouse.message_to_order-1915"><span class="linenos">1915</span></a><span class="sd">                product: &quot;electronics&quot;</span>
</span><span id="Warehouse.message_to_order-1916"><a href="#Warehouse.message_to_order-1916"><span class="linenos">1916</span></a><span class="sd">                quantity: 50</span>
</span><span id="Warehouse.message_to_order-1917"><a href="#Warehouse.message_to_order-1917"><span class="linenos">1917</span></a><span class="sd">                orderid: 201000000</span>
</span><span id="Warehouse.message_to_order-1918"><a href="#Warehouse.message_to_order-1918"><span class="linenos">1918</span></a><span class="sd">                sender: &quot;store1@localhost&quot;</span>
</span><span id="Warehouse.message_to_order-1919"><a href="#Warehouse.message_to_order-1919"><span class="linenos">1919</span></a><span class="sd">                receiver: &quot;warehouse1@localhost&quot;</span>
</span><span id="Warehouse.message_to_order-1920"><a href="#Warehouse.message_to_order-1920"><span class="linenos">1920</span></a><span class="sd">                sender_location: 15 (store node)</span>
</span><span id="Warehouse.message_to_order-1921"><a href="#Warehouse.message_to_order-1921"><span class="linenos">1921</span></a><span class="sd">                receiver_location: 10 (warehouse node)</span>
</span><span id="Warehouse.message_to_order-1922"><a href="#Warehouse.message_to_order-1922"><span class="linenos">1922</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.message_to_order-1923"><a href="#Warehouse.message_to_order-1923"><span class="linenos">1923</span></a><span class="sd">        </span>
</span><span id="Warehouse.message_to_order-1924"><a href="#Warehouse.message_to_order-1924"><span class="linenos">1924</span></a><span class="sd">        Integration:</span>
</span><span id="Warehouse.message_to_order-1925"><a href="#Warehouse.message_to_order-1925"><span class="linenos">1925</span></a><span class="sd">            Created Order is added to self.pending_deliveries[order_id]</span>
</span><span id="Warehouse.message_to_order-1926"><a href="#Warehouse.message_to_order-1926"><span class="linenos">1926</span></a><span class="sd">            and passed to AssignVehicle behaviour for transportation.</span>
</span><span id="Warehouse.message_to_order-1927"><a href="#Warehouse.message_to_order-1927"><span class="linenos">1927</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.message_to_order-1928"><a href="#Warehouse.message_to_order-1928"><span class="linenos">1928</span></a>        <span class="n">body</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="Warehouse.message_to_order-1929"><a href="#Warehouse.message_to_order-1929"><span class="linenos">1929</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.message_to_order-1930"><a href="#Warehouse.message_to_order-1930"><span class="linenos">1930</span></a>        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.message_to_order-1931"><a href="#Warehouse.message_to_order-1931"><span class="linenos">1931</span></a>        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.message_to_order-1932"><a href="#Warehouse.message_to_order-1932"><span class="linenos">1932</span></a>        
</span><span id="Warehouse.message_to_order-1933"><a href="#Warehouse.message_to_order-1933"><span class="linenos">1933</span></a>        <span class="n">order_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.message_to_order-1934"><a href="#Warehouse.message_to_order-1934"><span class="linenos">1934</span></a>        <span class="n">sender</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>  <span class="c1"># Store JID</span>
</span><span id="Warehouse.message_to_order-1935"><a href="#Warehouse.message_to_order-1935"><span class="linenos">1935</span></a>        <span class="n">receiver</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">)</span>  <span class="c1"># Warehouse JID</span>
</span><span id="Warehouse.message_to_order-1936"><a href="#Warehouse.message_to_order-1936"><span class="linenos">1936</span></a>        <span class="n">store_location</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.message_to_order-1937"><a href="#Warehouse.message_to_order-1937"><span class="linenos">1937</span></a>        <span class="n">warehouse_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span>
</span><span id="Warehouse.message_to_order-1938"><a href="#Warehouse.message_to_order-1938"><span class="linenos">1938</span></a>        
</span><span id="Warehouse.message_to_order-1939"><a href="#Warehouse.message_to_order-1939"><span class="linenos">1939</span></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
</span><span id="Warehouse.message_to_order-1940"><a href="#Warehouse.message_to_order-1940"><span class="linenos">1940</span></a>            <span class="n">product</span><span class="o">=</span><span class="n">product</span><span class="p">,</span>
</span><span id="Warehouse.message_to_order-1941"><a href="#Warehouse.message_to_order-1941"><span class="linenos">1941</span></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="Warehouse.message_to_order-1942"><a href="#Warehouse.message_to_order-1942"><span class="linenos">1942</span></a>            <span class="n">orderid</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
</span><span id="Warehouse.message_to_order-1943"><a href="#Warehouse.message_to_order-1943"><span class="linenos">1943</span></a>            <span class="n">sender</span><span class="o">=</span><span class="n">sender</span><span class="p">,</span>
</span><span id="Warehouse.message_to_order-1944"><a href="#Warehouse.message_to_order-1944"><span class="linenos">1944</span></a>            <span class="n">receiver</span><span class="o">=</span><span class="n">receiver</span>
</span><span id="Warehouse.message_to_order-1945"><a href="#Warehouse.message_to_order-1945"><span class="linenos">1945</span></a>        <span class="p">)</span>
</span><span id="Warehouse.message_to_order-1946"><a href="#Warehouse.message_to_order-1946"><span class="linenos">1946</span></a>        
</span><span id="Warehouse.message_to_order-1947"><a href="#Warehouse.message_to_order-1947"><span class="linenos">1947</span></a>        <span class="c1"># Set locations</span>
</span><span id="Warehouse.message_to_order-1948"><a href="#Warehouse.message_to_order-1948"><span class="linenos">1948</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span> <span class="o">=</span> <span class="n">store_location</span>  <span class="c1"># Store location</span>
</span><span id="Warehouse.message_to_order-1949"><a href="#Warehouse.message_to_order-1949"><span class="linenos">1949</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span> <span class="o">=</span> <span class="n">warehouse_location</span>  <span class="c1"># Warehouse location</span>
</span><span id="Warehouse.message_to_order-1950"><a href="#Warehouse.message_to_order-1950"><span class="linenos">1950</span></a>        
</span><span id="Warehouse.message_to_order-1951"><a href="#Warehouse.message_to_order-1951"><span class="linenos">1951</span></a>        <span class="k">return</span> <span class="n">order</span>
</span></pre></div>


            <div class="docstring"><p>Convert store-confirm message to Order object for delivery tracking.</p>

<p>This helper function transforms a FIPA accept-proposal message from a store
into a structured Order object that can be stored in pending_deliveries
and assigned to vehicles for transportation.</p>

<h6 id="fipa-protocol-context">FIPA Protocol Context:</h6>

<blockquote>
  <ul>
  <li>Triggered by: store-confirm message (FIPA accept-proposal)</li>
  <li>Used by: ReceiveConfirmationOrDenial behaviour</li>
  <li>Purpose: Create deliverable order from confirmed proposal</li>
  </ul>
</blockquote>

<h6 id="message-parsing">Message Parsing:</h6>

<blockquote>
  <p>Body Format: "{quantity} {product}"
  Example: "50 electronics"</p>
  
  <p>Metadata Extracted:
      - request_id: Unique order identifier
      - node_id: Store's graph location (delivery destination)</p>
</blockquote>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>msg (Message):</strong>  store-confirm message with:
<ul>
<li>Body: "{quantity} {product}"</li>
<li>Metadata: request_id, node_id</li>
<li>Sender: Store JID</li>
</ul></li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Order: Structured order object with:
      - product: Product type
      - quantity: Amount to deliver
      - orderid: Unique identifier
      - sender: Store JID (delivery destination)
      - receiver: Warehouse JID (pickup location)
      - sender_location: Store's graph node
      - receiver_location: Warehouse's graph node</p>
</blockquote>

<h6 id="order-object-structure">Order Object Structure:</h6>

<blockquote>
  <p>The Order uses inverted semantics for delivery context:</p>
  
  <ul>
  <li>sender = Store (WHERE to deliver)</li>
  <li>receiver = Warehouse (WHERE to pickup)</li>
  <li>sender_location = Store node (delivery destination)</li>
  <li>receiver_location = Warehouse node (pickup origin)</li>
  </ul>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
<pre><code>Input Message (store-confirm):
    Body: "50 electronics"
    Metadata:
        - request_id: "201000000"
        - node_id: "15"
    Sender: "store1@localhost"

Warehouse: "warehouse1@localhost" at node 10

Output Order:
    product: "electronics"
    quantity: 50
    orderid: 201000000
    sender: "store1@localhost"
    receiver: "warehouse1@localhost"
    sender_location: 15 (store node)
    receiver_location: 10 (warehouse node)
</code></pre>
</blockquote>

<h6 id="integration">Integration:</h6>

<blockquote>
  <p>Created Order is added to self.pending_deliveries[order_id]
  and passed to AssignVehicle behaviour for transportation.</p>
</blockquote>
</div>


                            </div>
                            <div id="Warehouse.set_buy_metadata" class="classattr">
                                        <input id="Warehouse.set_buy_metadata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_buy_metadata</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.set_buy_metadata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.set_buy_metadata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.set_buy_metadata-1953"><a href="#Warehouse.set_buy_metadata-1953"><span class="linenos">1953</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_buy_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Warehouse.set_buy_metadata-1954"><a href="#Warehouse.set_buy_metadata-1954"><span class="linenos">1954</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-buy&quot;</span><span class="p">)</span>
</span><span id="Warehouse.set_buy_metadata-1955"><a href="#Warehouse.set_buy_metadata-1955"><span class="linenos">1955</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.set_buy_metadata-1956"><a href="#Warehouse.set_buy_metadata-1956"><span class="linenos">1956</span></a>        <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span><span class="p">))</span>
</span></pre></div>


    

                            </div>
                            <div id="Warehouse.update_graph" class="classattr">
                                        <input id="Warehouse.update_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_graph</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">traffic_data</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Warehouse.update_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.update_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.update_graph-1958"><a href="#Warehouse.update_graph-1958"><span class="linenos">1958</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traffic_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Warehouse.update_graph-1959"><a href="#Warehouse.update_graph-1959"><span class="linenos">1959</span></a>        <span class="k">for</span> <span class="n">edge_info</span> <span class="ow">in</span> <span class="n">traffic_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Warehouse.update_graph-1960"><a href="#Warehouse.update_graph-1960"><span class="linenos">1960</span></a>                <span class="n">node1_id</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node1&quot;</span><span class="p">)</span>
</span><span id="Warehouse.update_graph-1961"><a href="#Warehouse.update_graph-1961"><span class="linenos">1961</span></a>                <span class="n">node2_id</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node2&quot;</span><span class="p">)</span>
</span><span id="Warehouse.update_graph-1962"><a href="#Warehouse.update_graph-1962"><span class="linenos">1962</span></a>                <span class="n">new_weight</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
</span><span id="Warehouse.update_graph-1963"><a href="#Warehouse.update_graph-1963"><span class="linenos">1963</span></a>                
</span><span id="Warehouse.update_graph-1964"><a href="#Warehouse.update_graph-1964"><span class="linenos">1964</span></a>                <span class="n">edge</span> <span class="p">:</span> <span class="n">Edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">node1_id</span><span class="p">,</span> <span class="n">node2_id</span><span class="p">)</span>
</span><span id="Warehouse.update_graph-1965"><a href="#Warehouse.update_graph-1965"><span class="linenos">1965</span></a>                <span class="k">if</span> <span class="n">edge</span><span class="p">:</span>
</span><span id="Warehouse.update_graph-1966"><a href="#Warehouse.update_graph-1966"><span class="linenos">1966</span></a>                    <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">new_weight</span>
</span></pre></div>


    

                            </div>
                            <div id="Warehouse.print_stock" class="classattr">
                                        <input id="Warehouse.print_stock-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">print_stock</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.print_stock-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.print_stock"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.print_stock-1968"><a href="#Warehouse.print_stock-1968"><span class="linenos">1968</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_stock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.print_stock-1969"><a href="#Warehouse.print_stock-1969"><span class="linenos">1969</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.print_stock-1970"><a href="#Warehouse.print_stock-1970"><span class="linenos">1970</span></a><span class="sd">        Print comprehensive warehouse inventory status (debugging utility).</span>
</span><span id="Warehouse.print_stock-1971"><a href="#Warehouse.print_stock-1971"><span class="linenos">1971</span></a><span class="sd">        </span>
</span><span id="Warehouse.print_stock-1972"><a href="#Warehouse.print_stock-1972"><span class="linenos">1972</span></a><span class="sd">        Displays the three-tier stock management system:</span>
</span><span id="Warehouse.print_stock-1973"><a href="#Warehouse.print_stock-1973"><span class="linenos">1973</span></a><span class="sd">        1. **Unlocked Stock**: Available for new orders</span>
</span><span id="Warehouse.print_stock-1974"><a href="#Warehouse.print_stock-1974"><span class="linenos">1974</span></a><span class="sd">        2. **Locked Stock**: Reserved during FIPA negotiations</span>
</span><span id="Warehouse.print_stock-1975"><a href="#Warehouse.print_stock-1975"><span class="linenos">1975</span></a><span class="sd">        3. **Pending Orders**: Confirmed deliveries awaiting vehicle pickup</span>
</span><span id="Warehouse.print_stock-1976"><a href="#Warehouse.print_stock-1976"><span class="linenos">1976</span></a><span class="sd">        </span>
</span><span id="Warehouse.print_stock-1977"><a href="#Warehouse.print_stock-1977"><span class="linenos">1977</span></a><span class="sd">        Output Format:</span>
</span><span id="Warehouse.print_stock-1978"><a href="#Warehouse.print_stock-1978"><span class="linenos">1978</span></a><span class="sd">            ==============================</span>
</span><span id="Warehouse.print_stock-1979"><a href="#Warehouse.print_stock-1979"><span class="linenos">1979</span></a><span class="sd">            Current warehouse1@localhost UNLOCKED stock:</span>
</span><span id="Warehouse.print_stock-1980"><a href="#Warehouse.print_stock-1980"><span class="linenos">1980</span></a><span class="sd">            electronics: 75/150</span>
</span><span id="Warehouse.print_stock-1981"><a href="#Warehouse.print_stock-1981"><span class="linenos">1981</span></a><span class="sd">            textiles: 120/150</span>
</span><span id="Warehouse.print_stock-1982"><a href="#Warehouse.print_stock-1982"><span class="linenos">1982</span></a><span class="sd">            food: 40/150</span>
</span><span id="Warehouse.print_stock-1983"><a href="#Warehouse.print_stock-1983"><span class="linenos">1983</span></a><span class="sd">            ------------------------------</span>
</span><span id="Warehouse.print_stock-1984"><a href="#Warehouse.print_stock-1984"><span class="linenos">1984</span></a><span class="sd">            Current warehouse1@localhost LOCKED stock:</span>
</span><span id="Warehouse.print_stock-1985"><a href="#Warehouse.print_stock-1985"><span class="linenos">1985</span></a><span class="sd">            electronics: 25/100</span>
</span><span id="Warehouse.print_stock-1986"><a href="#Warehouse.print_stock-1986"><span class="linenos">1986</span></a><span class="sd">            textiles: 0/120</span>
</span><span id="Warehouse.print_stock-1987"><a href="#Warehouse.print_stock-1987"><span class="linenos">1987</span></a><span class="sd">            ------------------------------</span>
</span><span id="Warehouse.print_stock-1988"><a href="#Warehouse.print_stock-1988"><span class="linenos">1988</span></a><span class="sd">            Current warehouse1@localhost PENDING ORDERS:</span>
</span><span id="Warehouse.print_stock-1989"><a href="#Warehouse.print_stock-1989"><span class="linenos">1989</span></a><span class="sd">            Order 201000000: 25xelectronics from store1@localhost to warehouse1@localhost</span>
</span><span id="Warehouse.print_stock-1990"><a href="#Warehouse.print_stock-1990"><span class="linenos">1990</span></a><span class="sd">            Order 201000001: 50xtextiles from store2@localhost to warehouse1@localhost</span>
</span><span id="Warehouse.print_stock-1991"><a href="#Warehouse.print_stock-1991"><span class="linenos">1991</span></a><span class="sd">            ==============================</span>
</span><span id="Warehouse.print_stock-1992"><a href="#Warehouse.print_stock-1992"><span class="linenos">1992</span></a><span class="sd">        </span>
</span><span id="Warehouse.print_stock-1993"><a href="#Warehouse.print_stock-1993"><span class="linenos">1993</span></a><span class="sd">        Stock Interpretation:</span>
</span><span id="Warehouse.print_stock-1994"><a href="#Warehouse.print_stock-1994"><span class="linenos">1994</span></a><span class="sd">            - Unlocked: X/MAX_CAPACITY</span>
</span><span id="Warehouse.print_stock-1995"><a href="#Warehouse.print_stock-1995"><span class="linenos">1995</span></a><span class="sd">            - Locked: X/Total_Available (stock + locked)</span>
</span><span id="Warehouse.print_stock-1996"><a href="#Warehouse.print_stock-1996"><span class="linenos">1996</span></a><span class="sd">            - Pending: Formatted as &quot;{order_id}: {quantity}x{product} from {sender} to {receiver}&quot;</span>
</span><span id="Warehouse.print_stock-1997"><a href="#Warehouse.print_stock-1997"><span class="linenos">1997</span></a><span class="sd">        </span>
</span><span id="Warehouse.print_stock-1998"><a href="#Warehouse.print_stock-1998"><span class="linenos">1998</span></a><span class="sd">        Use Cases:</span>
</span><span id="Warehouse.print_stock-1999"><a href="#Warehouse.print_stock-1999"><span class="linenos">1999</span></a><span class="sd">            - Debugging stock state transitions</span>
</span><span id="Warehouse.print_stock-2000"><a href="#Warehouse.print_stock-2000"><span class="linenos">2000</span></a><span class="sd">            - Verifying FIPA protocol effects on inventory</span>
</span><span id="Warehouse.print_stock-2001"><a href="#Warehouse.print_stock-2001"><span class="linenos">2001</span></a><span class="sd">            - Monitoring pending delivery queue</span>
</span><span id="Warehouse.print_stock-2002"><a href="#Warehouse.print_stock-2002"><span class="linenos">2002</span></a><span class="sd">            - Tracking resource availability</span>
</span><span id="Warehouse.print_stock-2003"><a href="#Warehouse.print_stock-2003"><span class="linenos">2003</span></a><span class="sd">        </span>
</span><span id="Warehouse.print_stock-2004"><a href="#Warehouse.print_stock-2004"><span class="linenos">2004</span></a><span class="sd">        Example Usage:</span>
</span><span id="Warehouse.print_stock-2005"><a href="#Warehouse.print_stock-2005"><span class="linenos">2005</span></a><span class="sd">            ```python</span>
</span><span id="Warehouse.print_stock-2006"><a href="#Warehouse.print_stock-2006"><span class="linenos">2006</span></a><span class="sd">            # After accepting store request</span>
</span><span id="Warehouse.print_stock-2007"><a href="#Warehouse.print_stock-2007"><span class="linenos">2007</span></a><span class="sd">            warehouse.locked_stock[product] = 50</span>
</span><span id="Warehouse.print_stock-2008"><a href="#Warehouse.print_stock-2008"><span class="linenos">2008</span></a><span class="sd">            warehouse.print_stock()  # Shows locked stock increased</span>
</span><span id="Warehouse.print_stock-2009"><a href="#Warehouse.print_stock-2009"><span class="linenos">2009</span></a><span class="sd">            </span>
</span><span id="Warehouse.print_stock-2010"><a href="#Warehouse.print_stock-2010"><span class="linenos">2010</span></a><span class="sd">            # After store confirmation</span>
</span><span id="Warehouse.print_stock-2011"><a href="#Warehouse.print_stock-2011"><span class="linenos">2011</span></a><span class="sd">            warehouse.pending_deliveries[order_id] = order</span>
</span><span id="Warehouse.print_stock-2012"><a href="#Warehouse.print_stock-2012"><span class="linenos">2012</span></a><span class="sd">            warehouse.print_stock()  # Shows new pending order</span>
</span><span id="Warehouse.print_stock-2013"><a href="#Warehouse.print_stock-2013"><span class="linenos">2013</span></a><span class="sd">            </span>
</span><span id="Warehouse.print_stock-2014"><a href="#Warehouse.print_stock-2014"><span class="linenos">2014</span></a><span class="sd">            # After vehicle pickup</span>
</span><span id="Warehouse.print_stock-2015"><a href="#Warehouse.print_stock-2015"><span class="linenos">2015</span></a><span class="sd">            del warehouse.pending_deliveries[order_id]</span>
</span><span id="Warehouse.print_stock-2016"><a href="#Warehouse.print_stock-2016"><span class="linenos">2016</span></a><span class="sd">            warehouse.print_stock()  # Shows order removed</span>
</span><span id="Warehouse.print_stock-2017"><a href="#Warehouse.print_stock-2017"><span class="linenos">2017</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.print_stock-2018"><a href="#Warehouse.print_stock-2018"><span class="linenos">2018</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.print_stock-2019"><a href="#Warehouse.print_stock-2019"><span class="linenos">2019</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
</span><span id="Warehouse.print_stock-2020"><a href="#Warehouse.print_stock-2020"><span class="linenos">2020</span></a>        
</span><span id="Warehouse.print_stock-2021"><a href="#Warehouse.print_stock-2021"><span class="linenos">2021</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2"> UNLOCKED stock:&quot;</span><span class="p">)</span>
</span><span id="Warehouse.print_stock-2022"><a href="#Warehouse.print_stock-2022"><span class="linenos">2022</span></a>        <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Warehouse.print_stock-2023"><a href="#Warehouse.print_stock-2023"><span class="linenos">2023</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.print_stock-2024"><a href="#Warehouse.print_stock-2024"><span class="linenos">2024</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
</span><span id="Warehouse.print_stock-2025"><a href="#Warehouse.print_stock-2025"><span class="linenos">2025</span></a>        
</span><span id="Warehouse.print_stock-2026"><a href="#Warehouse.print_stock-2026"><span class="linenos">2026</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2"> LOCKED stock:&quot;</span><span class="p">)</span>
</span><span id="Warehouse.print_stock-2027"><a href="#Warehouse.print_stock-2027"><span class="linenos">2027</span></a>        <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locked_stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Warehouse.print_stock-2028"><a href="#Warehouse.print_stock-2028"><span class="linenos">2028</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.print_stock-2029"><a href="#Warehouse.print_stock-2029"><span class="linenos">2029</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
</span><span id="Warehouse.print_stock-2030"><a href="#Warehouse.print_stock-2030"><span class="linenos">2030</span></a>                
</span><span id="Warehouse.print_stock-2031"><a href="#Warehouse.print_stock-2031"><span class="linenos">2031</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2"> PENDING ORDERS:&quot;</span><span class="p">)</span>
</span><span id="Warehouse.print_stock-2032"><a href="#Warehouse.print_stock-2032"><span class="linenos">2032</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">:</span>
</span><span id="Warehouse.print_stock-2033"><a href="#Warehouse.print_stock-2033"><span class="linenos">2033</span></a>            <span class="k">for</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Warehouse.print_stock-2034"><a href="#Warehouse.print_stock-2034"><span class="linenos">2034</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.print_stock-2035"><a href="#Warehouse.print_stock-2035"><span class="linenos">2035</span></a>                      <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">receiver</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.print_stock-2036"><a href="#Warehouse.print_stock-2036"><span class="linenos">2036</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.print_stock-2037"><a href="#Warehouse.print_stock-2037"><span class="linenos">2037</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No pending orders&quot;</span><span class="p">)</span>
</span><span id="Warehouse.print_stock-2038"><a href="#Warehouse.print_stock-2038"><span class="linenos">2038</span></a>        
</span><span id="Warehouse.print_stock-2039"><a href="#Warehouse.print_stock-2039"><span class="linenos">2039</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
</span></pre></div>


            <div class="docstring"><p>Print comprehensive warehouse inventory status (debugging utility).</p>

<p>Displays the three-tier stock management system:</p>

<ol>
<li><strong>Unlocked Stock</strong>: Available for new orders</li>
<li><strong>Locked Stock</strong>: Reserved during FIPA negotiations</li>
<li><strong>Pending Orders</strong>: Confirmed deliveries awaiting vehicle pickup</li>
</ol>

<h6 id="output-format">Output Format:</h6>

<blockquote>
  <p>==============================
  Current warehouse1@localhost UNLOCKED stock:
  electronics: 75/150
  textiles: 120/150</p>
  
  <h2 id="food-40150">food: 40/150</h2>
  
  <p>Current warehouse1@localhost LOCKED stock:
  electronics: 25/100</p>
  
  <h2 id="textiles-0120">textiles: 0/120</h2>
  
  <p>Current warehouse1@localhost PENDING ORDERS:
  Order 201000000: 25xelectronics from store1@localhost to warehouse1@localhost</p>
  
  <h1 id="order-201000001-50xtextiles-from-store2localhost-to-warehouse1localhost">Order 201000001: 50xtextiles from store2@localhost to warehouse1@localhost</h1>
</blockquote>

<h6 id="stock-interpretation">Stock Interpretation:</h6>

<blockquote>
  <ul>
  <li>Unlocked: X/MAX_CAPACITY</li>
  <li>Locked: X/Total_Available (stock + locked)</li>
  <li>Pending: Formatted as "{order_id}: {quantity}x{product} from {sender} to {receiver}"</li>
  </ul>
</blockquote>

<h6 id="use-cases">Use Cases:</h6>

<blockquote>
  <ul>
  <li>Debugging stock state transitions</li>
  <li>Verifying FIPA protocol effects on inventory</li>
  <li>Monitoring pending delivery queue</li>
  <li>Tracking resource availability</li>
  </ul>
</blockquote>

<h6 id="example-usage">Example Usage:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># After accepting store request</span>
<span class="n">warehouse</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">warehouse</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>  <span class="c1"># Shows locked stock increased</span>

<span class="c1"># After store confirmation</span>
<span class="n">warehouse</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
<span class="n">warehouse</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>  <span class="c1"># Shows new pending order</span>

<span class="c1"># After vehicle pickup</span>
<span class="k">del</span> <span class="n">warehouse</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span>
<span class="n">warehouse</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>  <span class="c1"># Shows order removed</span>
</code></pre>
  </div>
</blockquote>
</div>


                            </div>
                            <div id="Warehouse.dict_to_order" class="classattr">
                                        <input id="Warehouse.dict_to_order-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dict_to_order</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">) -> <span class="n">veiculos</span><span class="o">.</span><span class="n">veiculos</span><span class="o">.</span><span class="n">Order</span>:</span></span>

                <label class="view-source-button" for="Warehouse.dict_to_order-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.dict_to_order"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.dict_to_order-2041"><a href="#Warehouse.dict_to_order-2041"><span class="linenos">2041</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dict_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
</span><span id="Warehouse.dict_to_order-2042"><a href="#Warehouse.dict_to_order-2042"><span class="linenos">2042</span></a>        <span class="n">order</span> <span class="o">=</span>  <span class="n">Order</span><span class="p">(</span>
</span><span id="Warehouse.dict_to_order-2043"><a href="#Warehouse.dict_to_order-2043"><span class="linenos">2043</span></a>            <span class="n">product</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">],</span>
</span><span id="Warehouse.dict_to_order-2044"><a href="#Warehouse.dict_to_order-2044"><span class="linenos">2044</span></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">],</span>
</span><span id="Warehouse.dict_to_order-2045"><a href="#Warehouse.dict_to_order-2045"><span class="linenos">2045</span></a>            <span class="n">orderid</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">],</span>
</span><span id="Warehouse.dict_to_order-2046"><a href="#Warehouse.dict_to_order-2046"><span class="linenos">2046</span></a>            <span class="n">sender</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;sender&quot;</span><span class="p">],</span>
</span><span id="Warehouse.dict_to_order-2047"><a href="#Warehouse.dict_to_order-2047"><span class="linenos">2047</span></a>            <span class="n">receiver</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;receiver&quot;</span><span class="p">]</span>
</span><span id="Warehouse.dict_to_order-2048"><a href="#Warehouse.dict_to_order-2048"><span class="linenos">2048</span></a>        <span class="p">)</span>
</span><span id="Warehouse.dict_to_order-2049"><a href="#Warehouse.dict_to_order-2049"><span class="linenos">2049</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sender_location&quot;</span><span class="p">)</span>
</span><span id="Warehouse.dict_to_order-2050"><a href="#Warehouse.dict_to_order-2050"><span class="linenos">2050</span></a>        <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;receiver_location&quot;</span><span class="p">)</span>
</span><span id="Warehouse.dict_to_order-2051"><a href="#Warehouse.dict_to_order-2051"><span class="linenos">2051</span></a>        <span class="k">return</span> <span class="n">order</span>
</span></pre></div>


    

                            </div>
                            <div id="Warehouse.node_id" class="classattr">
                                <div class="attr variable">
            <span class="name">node_id</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.node_id"></a>
    
    

                            </div>
                            <div id="Warehouse.map" class="classattr">
                                <div class="attr variable">
            <span class="name">map</span><span class="annotation">: world.graph.Graph</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.map"></a>
    
    

                            </div>
                            <div id="Warehouse.contact_list" class="classattr">
                                <div class="attr variable">
            <span class="name">contact_list</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.contact_list"></a>
    
    

                            </div>
                            <div id="Warehouse.verbose" class="classattr">
                                <div class="attr variable">
            <span class="name">verbose</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.verbose"></a>
    
    

                            </div>
                            <div id="Warehouse.id_base" class="classattr">
                                <div class="attr variable">
            <span class="name">id_base</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.id_base"></a>
    
    

                            </div>
                            <div id="Warehouse.pending_deliveries" class="classattr">
                                <div class="attr variable">
            <span class="name">pending_deliveries</span><span class="annotation">: dict[int, veiculos.veiculos.Order]</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.pending_deliveries"></a>
    
    

                            </div>
                            <div id="Warehouse.vehicle_proposals" class="classattr">
                                <div class="attr variable">
            <span class="name">vehicle_proposals</span><span class="annotation">: dict[int, dict[str, tuple[bool]]]</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.vehicle_proposals"></a>
    
    

                            </div>
                            <div id="Warehouse.vehicles" class="classattr">
                                <div class="attr variable">
            <span class="name">vehicles</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.vehicles"></a>
    
    

                            </div>
                            <div id="Warehouse.suppliers" class="classattr">
                                <div class="attr variable">
            <span class="name">suppliers</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.suppliers"></a>
    
    

                            </div>
                            <div id="Warehouse.request_counter" class="classattr">
                                <div class="attr variable">
            <span class="name">request_counter</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.request_counter"></a>
    
    

                            </div>
                            <div id="Warehouse.setup" class="classattr">
                                        <input id="Warehouse.setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.setup-2153"><a href="#Warehouse.setup-2153"><span class="linenos">2153</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.setup-2154"><a href="#Warehouse.setup-2154"><span class="linenos">2154</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.setup-2155"><a href="#Warehouse.setup-2155"><span class="linenos">2155</span></a><span class="sd">        Configure warehouse state and register all FIPA protocol behaviours.</span>
</span><span id="Warehouse.setup-2156"><a href="#Warehouse.setup-2156"><span class="linenos">2156</span></a><span class="sd">        </span>
</span><span id="Warehouse.setup-2157"><a href="#Warehouse.setup-2157"><span class="linenos">2157</span></a><span class="sd">        This method is automatically called by SPADE after the agent successfully</span>
</span><span id="Warehouse.setup-2158"><a href="#Warehouse.setup-2158"><span class="linenos">2158</span></a><span class="sd">        connects to the XMPP server. It initializes the warehouse&#39;s operational</span>
</span><span id="Warehouse.setup-2159"><a href="#Warehouse.setup-2159"><span class="linenos">2159</span></a><span class="sd">        state and registers all cyclic and periodic behaviours needed for the</span>
</span><span id="Warehouse.setup-2160"><a href="#Warehouse.setup-2160"><span class="linenos">2160</span></a><span class="sd">        dual FIPA Contract Net Protocol implementation.</span>
</span><span id="Warehouse.setup-2161"><a href="#Warehouse.setup-2161"><span class="linenos">2161</span></a><span class="sd">        </span>
</span><span id="Warehouse.setup-2162"><a href="#Warehouse.setup-2162"><span class="linenos">2162</span></a><span class="sd">        Setup Process:</span>
</span><span id="Warehouse.setup-2163"><a href="#Warehouse.setup-2163"><span class="linenos">2163</span></a><span class="sd">        </span>
</span><span id="Warehouse.setup-2164"><a href="#Warehouse.setup-2164"><span class="linenos">2164</span></a><span class="sd">            **Phase 1: Presence Management**</span>
</span><span id="Warehouse.setup-2165"><a href="#Warehouse.setup-2165"><span class="linenos">2165</span></a><span class="sd">                - Enable auto-approval of presence subscriptions</span>
</span><span id="Warehouse.setup-2166"><a href="#Warehouse.setup-2166"><span class="linenos">2166</span></a><span class="sd">                - Subscribe to all contacts (stores, suppliers, vehicles)</span>
</span><span id="Warehouse.setup-2167"><a href="#Warehouse.setup-2167"><span class="linenos">2167</span></a><span class="sd">                - Enables presence-based availability checking</span>
</span><span id="Warehouse.setup-2168"><a href="#Warehouse.setup-2168"><span class="linenos">2168</span></a><span class="sd">            </span>
</span><span id="Warehouse.setup-2169"><a href="#Warehouse.setup-2169"><span class="linenos">2169</span></a><span class="sd">            **Phase 2: Stock Initialization**</span>
</span><span id="Warehouse.setup-2170"><a href="#Warehouse.setup-2170"><span class="linenos">2170</span></a><span class="sd">                - Randomize initial stock for each product</span>
</span><span id="Warehouse.setup-2171"><a href="#Warehouse.setup-2171"><span class="linenos">2171</span></a><span class="sd">                - Range: [WAREHOUSE_RESUPPLY_THRESHOLD+1, WAREHOUSE_MAX_PRODUCT_CAPACITY]</span>
</span><span id="Warehouse.setup-2172"><a href="#Warehouse.setup-2172"><span class="linenos">2172</span></a><span class="sd">                - Calculate current_capacity per product</span>
</span><span id="Warehouse.setup-2173"><a href="#Warehouse.setup-2173"><span class="linenos">2173</span></a><span class="sd">                - Initialize locked_stock dictionary (empty)</span>
</span><span id="Warehouse.setup-2174"><a href="#Warehouse.setup-2174"><span class="linenos">2174</span></a><span class="sd">            </span>
</span><span id="Warehouse.setup-2175"><a href="#Warehouse.setup-2175"><span class="linenos">2175</span></a><span class="sd">            **Phase 3: State Initialization**</span>
</span><span id="Warehouse.setup-2176"><a href="#Warehouse.setup-2176"><span class="linenos">2176</span></a><span class="sd">                - current_tick: Simulation time (starts at 0)</span>
</span><span id="Warehouse.setup-2177"><a href="#Warehouse.setup-2177"><span class="linenos">2177</span></a><span class="sd">                - presence_infos: Vehicle availability cache</span>
</span><span id="Warehouse.setup-2178"><a href="#Warehouse.setup-2178"><span class="linenos">2178</span></a><span class="sd">                - current_buy_request: Last supplier purchase request</span>
</span><span id="Warehouse.setup-2179"><a href="#Warehouse.setup-2179"><span class="linenos">2179</span></a><span class="sd">                - failed_requests: Queue for retry mechanism</span>
</span><span id="Warehouse.setup-2180"><a href="#Warehouse.setup-2180"><span class="linenos">2180</span></a><span class="sd">            </span>
</span><span id="Warehouse.setup-2181"><a href="#Warehouse.setup-2181"><span class="linenos">2181</span></a><span class="sd">            **Phase 4: Contact Discovery**</span>
</span><span id="Warehouse.setup-2182"><a href="#Warehouse.setup-2182"><span class="linenos">2182</span></a><span class="sd">                - Parse presence.contacts to identify vehicles and suppliers</span>
</span><span id="Warehouse.setup-2183"><a href="#Warehouse.setup-2183"><span class="linenos">2183</span></a><span class="sd">                - Filter by JID string matching (&quot;vehicle&quot;, &quot;supplier&quot;)</span>
</span><span id="Warehouse.setup-2184"><a href="#Warehouse.setup-2184"><span class="linenos">2184</span></a><span class="sd">                - Populate vehicles and suppliers lists</span>
</span><span id="Warehouse.setup-2185"><a href="#Warehouse.setup-2185"><span class="linenos">2185</span></a><span class="sd">            </span>
</span><span id="Warehouse.setup-2186"><a href="#Warehouse.setup-2186"><span class="linenos">2186</span></a><span class="sd">            **Phase 5: Behaviour Registration**</span>
</span><span id="Warehouse.setup-2187"><a href="#Warehouse.setup-2187"><span class="linenos">2187</span></a><span class="sd">                1. ReceiveBuyRequest (Store Interaction - FIPA Participant)</span>
</span><span id="Warehouse.setup-2188"><a href="#Warehouse.setup-2188"><span class="linenos">2188</span></a><span class="sd">                2. HandleResupply (Inventory Management - Triggers FIPA Initiator)</span>
</span><span id="Warehouse.setup-2189"><a href="#Warehouse.setup-2189"><span class="linenos">2189</span></a><span class="sd">                3. ReceiveVehicleArrival (Logistics Coordination)</span>
</span><span id="Warehouse.setup-2190"><a href="#Warehouse.setup-2190"><span class="linenos">2190</span></a><span class="sd">                4. ReceiveTimeDelta (Time Synchronization)</span>
</span><span id="Warehouse.setup-2191"><a href="#Warehouse.setup-2191"><span class="linenos">2191</span></a><span class="sd">        </span>
</span><span id="Warehouse.setup-2192"><a href="#Warehouse.setup-2192"><span class="linenos">2192</span></a><span class="sd">        Behaviour Registration Details:</span>
</span><span id="Warehouse.setup-2193"><a href="#Warehouse.setup-2193"><span class="linenos">2193</span></a><span class="sd">        </span>
</span><span id="Warehouse.setup-2194"><a href="#Warehouse.setup-2194"><span class="linenos">2194</span></a><span class="sd">            **ReceiveBuyRequest** (CyclicBehaviour):</span>
</span><span id="Warehouse.setup-2195"><a href="#Warehouse.setup-2195"><span class="linenos">2195</span></a><span class="sd">                - Template: performative = &quot;store-buy&quot;</span>
</span><span id="Warehouse.setup-2196"><a href="#Warehouse.setup-2196"><span class="linenos">2196</span></a><span class="sd">                - Purpose: Listen for store purchase requests (FIPA CFP)</span>
</span><span id="Warehouse.setup-2197"><a href="#Warehouse.setup-2197"><span class="linenos">2197</span></a><span class="sd">                - Role: FIPA Participant (responds to stores)</span>
</span><span id="Warehouse.setup-2198"><a href="#Warehouse.setup-2198"><span class="linenos">2198</span></a><span class="sd">            </span>
</span><span id="Warehouse.setup-2199"><a href="#Warehouse.setup-2199"><span class="linenos">2199</span></a><span class="sd">            **HandleResupply** (PeriodicBehaviour):</span>
</span><span id="Warehouse.setup-2200"><a href="#Warehouse.setup-2200"><span class="linenos">2200</span></a><span class="sd">                - Period: 5 seconds</span>
</span><span id="Warehouse.setup-2201"><a href="#Warehouse.setup-2201"><span class="linenos">2201</span></a><span class="sd">                - Purpose: Monitor stock levels and trigger restocking</span>
</span><span id="Warehouse.setup-2202"><a href="#Warehouse.setup-2202"><span class="linenos">2202</span></a><span class="sd">                - Role: Launches BuyMaterial (FIPA Initiator with suppliers)</span>
</span><span id="Warehouse.setup-2203"><a href="#Warehouse.setup-2203"><span class="linenos">2203</span></a><span class="sd">            </span>
</span><span id="Warehouse.setup-2204"><a href="#Warehouse.setup-2204"><span class="linenos">2204</span></a><span class="sd">            **ReceiveVehicleArrival** (CyclicBehaviour):</span>
</span><span id="Warehouse.setup-2205"><a href="#Warehouse.setup-2205"><span class="linenos">2205</span></a><span class="sd">                - Template: performative = &quot;vehicle-pickup&quot; OR &quot;vehicle-delivery&quot;</span>
</span><span id="Warehouse.setup-2206"><a href="#Warehouse.setup-2206"><span class="linenos">2206</span></a><span class="sd">                - Purpose: Handle vehicle logistics notifications</span>
</span><span id="Warehouse.setup-2207"><a href="#Warehouse.setup-2207"><span class="linenos">2207</span></a><span class="sd">                - Actions:</span>
</span><span id="Warehouse.setup-2208"><a href="#Warehouse.setup-2208"><span class="linenos">2208</span></a><span class="sd">                    - vehicle-pickup: Remove order from pending_deliveries</span>
</span><span id="Warehouse.setup-2209"><a href="#Warehouse.setup-2209"><span class="linenos">2209</span></a><span class="sd">                    - vehicle-delivery: Add delivered materials to stock</span>
</span><span id="Warehouse.setup-2210"><a href="#Warehouse.setup-2210"><span class="linenos">2210</span></a><span class="sd">            </span>
</span><span id="Warehouse.setup-2211"><a href="#Warehouse.setup-2211"><span class="linenos">2211</span></a><span class="sd">            **ReceiveTimeDelta** (CyclicBehaviour):</span>
</span><span id="Warehouse.setup-2212"><a href="#Warehouse.setup-2212"><span class="linenos">2212</span></a><span class="sd">                - Template: performative = &quot;time-delta&quot;</span>
</span><span id="Warehouse.setup-2213"><a href="#Warehouse.setup-2213"><span class="linenos">2213</span></a><span class="sd">                - Purpose: Synchronize simulation time with world agent</span>
</span><span id="Warehouse.setup-2214"><a href="#Warehouse.setup-2214"><span class="linenos">2214</span></a><span class="sd">                - Actions: Update current_tick, apply traffic conditions</span>
</span><span id="Warehouse.setup-2215"><a href="#Warehouse.setup-2215"><span class="linenos">2215</span></a><span class="sd">        </span>
</span><span id="Warehouse.setup-2216"><a href="#Warehouse.setup-2216"><span class="linenos">2216</span></a><span class="sd">        Stock Initialization Example:</span>
</span><span id="Warehouse.setup-2217"><a href="#Warehouse.setup-2217"><span class="linenos">2217</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.setup-2218"><a href="#Warehouse.setup-2218"><span class="linenos">2218</span></a><span class="sd">            Products: [electronics, textiles, food]</span>
</span><span id="Warehouse.setup-2219"><a href="#Warehouse.setup-2219"><span class="linenos">2219</span></a><span class="sd">            WAREHOUSE_MAX_PRODUCT_CAPACITY: 150</span>
</span><span id="Warehouse.setup-2220"><a href="#Warehouse.setup-2220"><span class="linenos">2220</span></a><span class="sd">            WAREHOUSE_RESUPPLY_THRESHOLD: 30</span>
</span><span id="Warehouse.setup-2221"><a href="#Warehouse.setup-2221"><span class="linenos">2221</span></a><span class="sd">            </span>
</span><span id="Warehouse.setup-2222"><a href="#Warehouse.setup-2222"><span class="linenos">2222</span></a><span class="sd">            Initial Stock (randomized):</span>
</span><span id="Warehouse.setup-2223"><a href="#Warehouse.setup-2223"><span class="linenos">2223</span></a><span class="sd">                electronics: 87  (available)</span>
</span><span id="Warehouse.setup-2224"><a href="#Warehouse.setup-2224"><span class="linenos">2224</span></a><span class="sd">                textiles:    45  (available)</span>
</span><span id="Warehouse.setup-2225"><a href="#Warehouse.setup-2225"><span class="linenos">2225</span></a><span class="sd">                food:        120 (available)</span>
</span><span id="Warehouse.setup-2226"><a href="#Warehouse.setup-2226"><span class="linenos">2226</span></a><span class="sd">            </span>
</span><span id="Warehouse.setup-2227"><a href="#Warehouse.setup-2227"><span class="linenos">2227</span></a><span class="sd">            Current Capacity (calculated):</span>
</span><span id="Warehouse.setup-2228"><a href="#Warehouse.setup-2228"><span class="linenos">2228</span></a><span class="sd">                electronics: 150 - 87 = 63</span>
</span><span id="Warehouse.setup-2229"><a href="#Warehouse.setup-2229"><span class="linenos">2229</span></a><span class="sd">                textiles:    150 - 45 = 105</span>
</span><span id="Warehouse.setup-2230"><a href="#Warehouse.setup-2230"><span class="linenos">2230</span></a><span class="sd">                food:        150 - 120 = 30</span>
</span><span id="Warehouse.setup-2231"><a href="#Warehouse.setup-2231"><span class="linenos">2231</span></a><span class="sd">            </span>
</span><span id="Warehouse.setup-2232"><a href="#Warehouse.setup-2232"><span class="linenos">2232</span></a><span class="sd">            Locked Stock (initialized empty):</span>
</span><span id="Warehouse.setup-2233"><a href="#Warehouse.setup-2233"><span class="linenos">2233</span></a><span class="sd">                electronics: 0</span>
</span><span id="Warehouse.setup-2234"><a href="#Warehouse.setup-2234"><span class="linenos">2234</span></a><span class="sd">                textiles:    0</span>
</span><span id="Warehouse.setup-2235"><a href="#Warehouse.setup-2235"><span class="linenos">2235</span></a><span class="sd">                food:        0</span>
</span><span id="Warehouse.setup-2236"><a href="#Warehouse.setup-2236"><span class="linenos">2236</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.setup-2237"><a href="#Warehouse.setup-2237"><span class="linenos">2237</span></a><span class="sd">        </span>
</span><span id="Warehouse.setup-2238"><a href="#Warehouse.setup-2238"><span class="linenos">2238</span></a><span class="sd">        Presence Subscription Example:</span>
</span><span id="Warehouse.setup-2239"><a href="#Warehouse.setup-2239"><span class="linenos">2239</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.setup-2240"><a href="#Warehouse.setup-2240"><span class="linenos">2240</span></a><span class="sd">            contact_list: [</span>
</span><span id="Warehouse.setup-2241"><a href="#Warehouse.setup-2241"><span class="linenos">2241</span></a><span class="sd">                &quot;store1@localhost&quot;,</span>
</span><span id="Warehouse.setup-2242"><a href="#Warehouse.setup-2242"><span class="linenos">2242</span></a><span class="sd">                &quot;store2@localhost&quot;,</span>
</span><span id="Warehouse.setup-2243"><a href="#Warehouse.setup-2243"><span class="linenos">2243</span></a><span class="sd">                &quot;supplier1@localhost&quot;,</span>
</span><span id="Warehouse.setup-2244"><a href="#Warehouse.setup-2244"><span class="linenos">2244</span></a><span class="sd">                &quot;vehicle1@localhost&quot;,</span>
</span><span id="Warehouse.setup-2245"><a href="#Warehouse.setup-2245"><span class="linenos">2245</span></a><span class="sd">                &quot;vehicle2@localhost&quot;</span>
</span><span id="Warehouse.setup-2246"><a href="#Warehouse.setup-2246"><span class="linenos">2246</span></a><span class="sd">            ]</span>
</span><span id="Warehouse.setup-2247"><a href="#Warehouse.setup-2247"><span class="linenos">2247</span></a><span class="sd">            </span>
</span><span id="Warehouse.setup-2248"><a href="#Warehouse.setup-2248"><span class="linenos">2248</span></a><span class="sd">            Actions:</span>
</span><span id="Warehouse.setup-2249"><a href="#Warehouse.setup-2249"><span class="linenos">2249</span></a><span class="sd">                1. Subscribe to all 5 contacts</span>
</span><span id="Warehouse.setup-2250"><a href="#Warehouse.setup-2250"><span class="linenos">2250</span></a><span class="sd">                2. Parse contacts for types:</span>
</span><span id="Warehouse.setup-2251"><a href="#Warehouse.setup-2251"><span class="linenos">2251</span></a><span class="sd">                   - vehicles: [&quot;vehicle1@localhost&quot;, &quot;vehicle2@localhost&quot;]</span>
</span><span id="Warehouse.setup-2252"><a href="#Warehouse.setup-2252"><span class="linenos">2252</span></a><span class="sd">                   - suppliers: [&quot;supplier1@localhost&quot;]</span>
</span><span id="Warehouse.setup-2253"><a href="#Warehouse.setup-2253"><span class="linenos">2253</span></a><span class="sd">                3. Stores automatically discovered via presence system</span>
</span><span id="Warehouse.setup-2254"><a href="#Warehouse.setup-2254"><span class="linenos">2254</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.setup-2255"><a href="#Warehouse.setup-2255"><span class="linenos">2255</span></a><span class="sd">        </span>
</span><span id="Warehouse.setup-2256"><a href="#Warehouse.setup-2256"><span class="linenos">2256</span></a><span class="sd">        Template Configuration:</span>
</span><span id="Warehouse.setup-2257"><a href="#Warehouse.setup-2257"><span class="linenos">2257</span></a><span class="sd">            Templates use metadata filtering to route messages to correct behaviours:</span>
</span><span id="Warehouse.setup-2258"><a href="#Warehouse.setup-2258"><span class="linenos">2258</span></a><span class="sd">            - ReceiveBuyRequest: performative=&quot;store-buy&quot;</span>
</span><span id="Warehouse.setup-2259"><a href="#Warehouse.setup-2259"><span class="linenos">2259</span></a><span class="sd">            - ReceiveVehicleArrival: performative in [&quot;vehicle-pickup&quot;, &quot;vehicle-delivery&quot;]</span>
</span><span id="Warehouse.setup-2260"><a href="#Warehouse.setup-2260"><span class="linenos">2260</span></a><span class="sd">            - ReceiveTimeDelta: performative=&quot;time-delta&quot;</span>
</span><span id="Warehouse.setup-2261"><a href="#Warehouse.setup-2261"><span class="linenos">2261</span></a><span class="sd">        </span>
</span><span id="Warehouse.setup-2262"><a href="#Warehouse.setup-2262"><span class="linenos">2262</span></a><span class="sd">        Side Effects:</span>
</span><span id="Warehouse.setup-2263"><a href="#Warehouse.setup-2263"><span class="linenos">2263</span></a><span class="sd">            - Prints initial stock levels if verbose=True</span>
</span><span id="Warehouse.setup-2264"><a href="#Warehouse.setup-2264"><span class="linenos">2264</span></a><span class="sd">            - Begins listening for store requests immediately</span>
</span><span id="Warehouse.setup-2265"><a href="#Warehouse.setup-2265"><span class="linenos">2265</span></a><span class="sd">            - Starts periodic inventory monitoring</span>
</span><span id="Warehouse.setup-2266"><a href="#Warehouse.setup-2266"><span class="linenos">2266</span></a><span class="sd">            - Enables vehicle coordination capability</span>
</span><span id="Warehouse.setup-2267"><a href="#Warehouse.setup-2267"><span class="linenos">2267</span></a><span class="sd">        </span>
</span><span id="Warehouse.setup-2268"><a href="#Warehouse.setup-2268"><span class="linenos">2268</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse.setup-2269"><a href="#Warehouse.setup-2269"><span class="linenos">2269</span></a><span class="sd">            This method must complete before the warehouse can participate in any</span>
</span><span id="Warehouse.setup-2270"><a href="#Warehouse.setup-2270"><span class="linenos">2270</span></a><span class="sd">            FIPA protocol interactions. All behaviours are registered but don&#39;t</span>
</span><span id="Warehouse.setup-2271"><a href="#Warehouse.setup-2271"><span class="linenos">2271</span></a><span class="sd">            execute until the main agent event loop processes them.</span>
</span><span id="Warehouse.setup-2272"><a href="#Warehouse.setup-2272"><span class="linenos">2272</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.setup-2273"><a href="#Warehouse.setup-2273"><span class="linenos">2273</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">approve_all</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Warehouse.setup-2274"><a href="#Warehouse.setup-2274"><span class="linenos">2274</span></a>        <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_list</span><span class="p">:</span>
</span><span id="Warehouse.setup-2275"><a href="#Warehouse.setup-2275"><span class="linenos">2275</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
</span><span id="Warehouse.setup-2276"><a href="#Warehouse.setup-2276"><span class="linenos">2276</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.setup-2277"><a href="#Warehouse.setup-2277"><span class="linenos">2277</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Subscribed to presence of </span><span class="si">{</span><span class="n">contact</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.setup-2278"><a href="#Warehouse.setup-2278"><span class="linenos">2278</span></a>        <span class="c1"># Initialize stock and time</span>
</span><span id="Warehouse.setup-2279"><a href="#Warehouse.setup-2279"><span class="linenos">2279</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stock</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse.setup-2280"><a href="#Warehouse.setup-2280"><span class="linenos">2280</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Warehouse.setup-2281"><a href="#Warehouse.setup-2281"><span class="linenos">2281</span></a>        
</span><span id="Warehouse.setup-2282"><a href="#Warehouse.setup-2282"><span class="linenos">2282</span></a>        <span class="c1"># Set the starting stock randomly</span>
</span><span id="Warehouse.setup-2283"><a href="#Warehouse.setup-2283"><span class="linenos">2283</span></a>        <span class="n">product_max</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span>
</span><span id="Warehouse.setup-2284"><a href="#Warehouse.setup-2284"><span class="linenos">2284</span></a>        <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">PRODUCTS</span><span class="p">:</span>
</span><span id="Warehouse.setup-2285"><a href="#Warehouse.setup-2285"><span class="linenos">2285</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_RESUPPLY_THRESHOLD</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Warehouse.setup-2286"><a href="#Warehouse.setup-2286"><span class="linenos">2286</span></a>                                              <span class="n">product_max</span><span class="p">)</span>
</span><span id="Warehouse.setup-2287"><a href="#Warehouse.setup-2287"><span class="linenos">2287</span></a>        
</span><span id="Warehouse.setup-2288"><a href="#Warehouse.setup-2288"><span class="linenos">2288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_capacity</span> <span class="o">=</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">product_max</span> <span class="o">-</span> <span class="n">quant</span> <span class="k">for</span> <span class="n">prod</span><span class="p">,</span> <span class="n">quant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Warehouse.setup-2289"><a href="#Warehouse.setup-2289"><span class="linenos">2289</span></a>        
</span><span id="Warehouse.setup-2290"><a href="#Warehouse.setup-2290"><span class="linenos">2290</span></a>        <span class="c1"># Dict with products as keys and the sum of requested items as values</span>
</span><span id="Warehouse.setup-2291"><a href="#Warehouse.setup-2291"><span class="linenos">2291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">locked_stock</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse.setup-2292"><a href="#Warehouse.setup-2292"><span class="linenos">2292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="Warehouse.setup-2293"><a href="#Warehouse.setup-2293"><span class="linenos">2293</span></a>        
</span><span id="Warehouse.setup-2294"><a href="#Warehouse.setup-2294"><span class="linenos">2294</span></a>        
</span><span id="Warehouse.setup-2295"><a href="#Warehouse.setup-2295"><span class="linenos">2295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">presence_infos</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse.setup-2296"><a href="#Warehouse.setup-2296"><span class="linenos">2296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Warehouse.setup-2297"><a href="#Warehouse.setup-2297"><span class="linenos">2297</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failed_requests</span> <span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span><span id="Warehouse.setup-2298"><a href="#Warehouse.setup-2298"><span class="linenos">2298</span></a>        
</span><span id="Warehouse.setup-2299"><a href="#Warehouse.setup-2299"><span class="linenos">2299</span></a>        <span class="c1"># Identify vehicles from presence contacts</span>
</span><span id="Warehouse.setup-2300"><a href="#Warehouse.setup-2300"><span class="linenos">2300</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Warehouse.setup-2301"><a href="#Warehouse.setup-2301"><span class="linenos">2301</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">suppliers</span>  <span class="o">=</span> <span class="p">[]</span>
</span><span id="Warehouse.setup-2302"><a href="#Warehouse.setup-2302"><span class="linenos">2302</span></a>        <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="Warehouse.setup-2303"><a href="#Warehouse.setup-2303"><span class="linenos">2303</span></a>            <span class="k">if</span> <span class="s2">&quot;vehicle&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle</span><span class="p">):</span>
</span><span id="Warehouse.setup-2304"><a href="#Warehouse.setup-2304"><span class="linenos">2304</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>
</span><span id="Warehouse.setup-2305"><a href="#Warehouse.setup-2305"><span class="linenos">2305</span></a>            <span class="k">if</span> <span class="s2">&quot;supplier&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle</span><span class="p">):</span>
</span><span id="Warehouse.setup-2306"><a href="#Warehouse.setup-2306"><span class="linenos">2306</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">suppliers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>
</span><span id="Warehouse.setup-2307"><a href="#Warehouse.setup-2307"><span class="linenos">2307</span></a>        
</span><span id="Warehouse.setup-2308"><a href="#Warehouse.setup-2308"><span class="linenos">2308</span></a>        <span class="c1"># Run ReceiveBuyRequest behaviour</span>
</span><span id="Warehouse.setup-2309"><a href="#Warehouse.setup-2309"><span class="linenos">2309</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveBuyRequest</span><span class="p">()</span>
</span><span id="Warehouse.setup-2310"><a href="#Warehouse.setup-2310"><span class="linenos">2310</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse.setup-2311"><a href="#Warehouse.setup-2311"><span class="linenos">2311</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;store-buy&quot;</span><span class="p">)</span>
</span><span id="Warehouse.setup-2312"><a href="#Warehouse.setup-2312"><span class="linenos">2312</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Warehouse.setup-2313"><a href="#Warehouse.setup-2313"><span class="linenos">2313</span></a>        
</span><span id="Warehouse.setup-2314"><a href="#Warehouse.setup-2314"><span class="linenos">2314</span></a>        <span class="c1"># Run HandleResupply behaviour</span>
</span><span id="Warehouse.setup-2315"><a href="#Warehouse.setup-2315"><span class="linenos">2315</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HandleResupply</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="Warehouse.setup-2316"><a href="#Warehouse.setup-2316"><span class="linenos">2316</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Warehouse.setup-2317"><a href="#Warehouse.setup-2317"><span class="linenos">2317</span></a>        
</span><span id="Warehouse.setup-2318"><a href="#Warehouse.setup-2318"><span class="linenos">2318</span></a>        <span class="c1"># Run ReceiveVehicleArrival behaviour for pickups</span>
</span><span id="Warehouse.setup-2319"><a href="#Warehouse.setup-2319"><span class="linenos">2319</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveVehicleArrival</span><span class="p">()</span>
</span><span id="Warehouse.setup-2320"><a href="#Warehouse.setup-2320"><span class="linenos">2320</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse.setup-2321"><a href="#Warehouse.setup-2321"><span class="linenos">2321</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">)</span>
</span><span id="Warehouse.setup-2322"><a href="#Warehouse.setup-2322"><span class="linenos">2322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Warehouse.setup-2323"><a href="#Warehouse.setup-2323"><span class="linenos">2323</span></a>        
</span><span id="Warehouse.setup-2324"><a href="#Warehouse.setup-2324"><span class="linenos">2324</span></a>        <span class="c1"># Run ReceiveVehicleProposals behaviour</span>
</span><span id="Warehouse.setup-2325"><a href="#Warehouse.setup-2325"><span class="linenos">2325</span></a>        <span class="n">vehicle_proposal_behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveVehicleProposals</span><span class="p">()</span>
</span><span id="Warehouse.setup-2326"><a href="#Warehouse.setup-2326"><span class="linenos">2326</span></a>        <span class="n">vehicle_proposal_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse.setup-2327"><a href="#Warehouse.setup-2327"><span class="linenos">2327</span></a>        <span class="n">vehicle_proposal_template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-proposal&quot;</span><span class="p">)</span>
</span><span id="Warehouse.setup-2328"><a href="#Warehouse.setup-2328"><span class="linenos">2328</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">vehicle_proposal_behav</span><span class="p">,</span> <span class="n">vehicle_proposal_template</span><span class="p">)</span>
</span><span id="Warehouse.setup-2329"><a href="#Warehouse.setup-2329"><span class="linenos">2329</span></a>
</span><span id="Warehouse.setup-2330"><a href="#Warehouse.setup-2330"><span class="linenos">2330</span></a>        <span class="c1"># Run ReceiveVehicleArrival behaviour for deliveries</span>
</span><span id="Warehouse.setup-2331"><a href="#Warehouse.setup-2331"><span class="linenos">2331</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveVehicleArrival</span><span class="p">()</span>
</span><span id="Warehouse.setup-2332"><a href="#Warehouse.setup-2332"><span class="linenos">2332</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse.setup-2333"><a href="#Warehouse.setup-2333"><span class="linenos">2333</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">)</span>
</span><span id="Warehouse.setup-2334"><a href="#Warehouse.setup-2334"><span class="linenos">2334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Warehouse.setup-2335"><a href="#Warehouse.setup-2335"><span class="linenos">2335</span></a>        
</span><span id="Warehouse.setup-2336"><a href="#Warehouse.setup-2336"><span class="linenos">2336</span></a>        <span class="c1"># Run ReceiveTimeDelta</span>
</span><span id="Warehouse.setup-2337"><a href="#Warehouse.setup-2337"><span class="linenos">2337</span></a>        <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ReceiveTimeDelta</span><span class="p">()</span>
</span><span id="Warehouse.setup-2338"><a href="#Warehouse.setup-2338"><span class="linenos">2338</span></a>        <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse.setup-2339"><a href="#Warehouse.setup-2339"><span class="linenos">2339</span></a>        <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;inform&quot;</span><span class="p">)</span>
</span><span id="Warehouse.setup-2340"><a href="#Warehouse.setup-2340"><span class="linenos">2340</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Configure warehouse state and register all FIPA protocol behaviours.</p>

<p>This method is automatically called by SPADE after the agent successfully
connects to the XMPP server. It initializes the warehouse's operational
state and registers all cyclic and periodic behaviours needed for the
dual FIPA Contract Net Protocol implementation.</p>

<h6 id="setup-process">Setup Process:</h6>

<blockquote>
  <p><strong>Phase 1: Presence Management</strong>
      - Enable auto-approval of presence subscriptions
      - Subscribe to all contacts (stores, suppliers, vehicles)
      - Enables presence-based availability checking</p>
  
  <p><strong>Phase 2: Stock Initialization</strong>
      - Randomize initial stock for each product
      - Range: [WAREHOUSE_RESUPPLY_THRESHOLD+1, WAREHOUSE_MAX_PRODUCT_CAPACITY]
      - Calculate current_capacity per product
      - Initialize locked_stock dictionary (empty)</p>
  
  <p><strong>Phase 3: State Initialization</strong>
      - current_tick: Simulation time (starts at 0)
      - presence_infos: Vehicle availability cache
      - current_buy_request: Last supplier purchase request
      - failed_requests: Queue for retry mechanism</p>
  
  <p><strong>Phase 4: Contact Discovery</strong>
      - Parse presence.contacts to identify vehicles and suppliers
      - Filter by JID string matching ("vehicle", "supplier")
      - Populate vehicles and suppliers lists</p>
  
  <p><strong>Phase 5: Behaviour Registration</strong>
      1. ReceiveBuyRequest (Store Interaction - FIPA Participant)
      2. HandleResupply (Inventory Management - Triggers FIPA Initiator)
      3. ReceiveVehicleArrival (Logistics Coordination)
      4. ReceiveTimeDelta (Time Synchronization)</p>
</blockquote>

<h6 id="behaviour-registration-details">Behaviour Registration Details:</h6>

<blockquote>
  <p><strong>ReceiveBuyRequest</strong> (CyclicBehaviour):
      - Template: performative = "store-buy"
      - Purpose: Listen for store purchase requests (FIPA CFP)
      - Role: FIPA Participant (responds to stores)</p>
  
  <p><strong>HandleResupply</strong> (PeriodicBehaviour):
      - Period: 5 seconds
      - Purpose: Monitor stock levels and trigger restocking
      - Role: Launches BuyMaterial (FIPA Initiator with suppliers)</p>
  
  <p><strong>ReceiveVehicleArrival</strong> (CyclicBehaviour):
      - Template: performative = "vehicle-pickup" OR "vehicle-delivery"
      - Purpose: Handle vehicle logistics notifications
      - Actions:
          - vehicle-pickup: Remove order from pending_deliveries
          - vehicle-delivery: Add delivered materials to stock</p>
  
  <p><strong>ReceiveTimeDelta</strong> (CyclicBehaviour):
      - Template: performative = "time-delta"
      - Purpose: Synchronize simulation time with world agent
      - Actions: Update current_tick, apply traffic conditions</p>
</blockquote>

<h6 id="stock-initialization-example">Stock Initialization Example:</h6>

<blockquote>
<pre><code>Products: [electronics, textiles, food]
WAREHOUSE_MAX_PRODUCT_CAPACITY: 150
WAREHOUSE_RESUPPLY_THRESHOLD: 30

Initial Stock (randomized):
    electronics: 87  (available)
    textiles:    45  (available)
    food:        120 (available)

Current Capacity (calculated):
    electronics: 150 - 87 = 63
    textiles:    150 - 45 = 105
    food:        150 - 120 = 30

Locked Stock (initialized empty):
    electronics: 0
    textiles:    0
    food:        0
</code></pre>
</blockquote>

<h6 id="presence-subscription-example">Presence Subscription Example:</h6>

<blockquote>
<pre><code>contact_list: [
    "store1@localhost",
    "store2@localhost",
    "supplier1@localhost",
    "vehicle1@localhost",
    "vehicle2@localhost"
]

Actions:
    1. Subscribe to all 5 contacts
    2. Parse contacts for types:
       - vehicles: ["vehicle1@localhost", "vehicle2@localhost"]
       - suppliers: ["supplier1@localhost"]
    3. Stores automatically discovered via presence system
</code></pre>
</blockquote>

<h6 id="template-configuration">Template Configuration:</h6>

<blockquote>
  <p>Templates use metadata filtering to route messages to correct behaviours:</p>
  
  <ul>
  <li>ReceiveBuyRequest: performative="store-buy"</li>
  <li>ReceiveVehicleArrival: performative in ["vehicle-pickup", "vehicle-delivery"]</li>
  <li>ReceiveTimeDelta: performative="time-delta"</li>
  </ul>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Prints initial stock levels if verbose=True</li>
  <li>Begins listening for store requests immediately</li>
  <li>Starts periodic inventory monitoring</li>
  <li>Enables vehicle coordination capability</li>
  </ul>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This method must complete before the warehouse can participate in any
  FIPA protocol interactions. All behaviours are registered but don't
  execute until the main agent event loop processes them.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Warehouse.ReceiveBuyRequest">
                            <input id="Warehouse.ReceiveBuyRequest-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.ReceiveBuyRequest</span><wbr>(<span class="base">spade.behaviour.CyclicBehaviour</span>):

                <label class="view-source-button" for="Warehouse.ReceiveBuyRequest-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveBuyRequest"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveBuyRequest-260"><a href="#Warehouse.ReceiveBuyRequest-260"><span class="linenos">260</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveBuyRequest</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveBuyRequest-261"><a href="#Warehouse.ReceiveBuyRequest-261"><span class="linenos">261</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveBuyRequest-262"><a href="#Warehouse.ReceiveBuyRequest-262"><span class="linenos">262</span></a><span class="sd">        Cyclic behaviour that processes incoming purchase requests from stores.</span>
</span><span id="Warehouse.ReceiveBuyRequest-263"><a href="#Warehouse.ReceiveBuyRequest-263"><span class="linenos">263</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveBuyRequest-264"><a href="#Warehouse.ReceiveBuyRequest-264"><span class="linenos">264</span></a><span class="sd">        This behaviour implements the proposal phase of the FIPA Contract Net Protocol</span>
</span><span id="Warehouse.ReceiveBuyRequest-265"><a href="#Warehouse.ReceiveBuyRequest-265"><span class="linenos">265</span></a><span class="sd">        where the warehouse acts as a **Participant**. It receives CFP messages from</span>
</span><span id="Warehouse.ReceiveBuyRequest-266"><a href="#Warehouse.ReceiveBuyRequest-266"><span class="linenos">266</span></a><span class="sd">        stores, evaluates inventory availability, and responds with either a proposal</span>
</span><span id="Warehouse.ReceiveBuyRequest-267"><a href="#Warehouse.ReceiveBuyRequest-267"><span class="linenos">267</span></a><span class="sd">        (warehouse-accept) or refusal (warehouse-reject).</span>
</span><span id="Warehouse.ReceiveBuyRequest-268"><a href="#Warehouse.ReceiveBuyRequest-268"><span class="linenos">268</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveBuyRequest-269"><a href="#Warehouse.ReceiveBuyRequest-269"><span class="linenos">269</span></a><span class="sd">        FIPA Protocol Phase: **Proposal Phase - Participant Role**</span>
</span><span id="Warehouse.ReceiveBuyRequest-270"><a href="#Warehouse.ReceiveBuyRequest-270"><span class="linenos">270</span></a><span class="sd">            - Role: Participant (Warehouse responding to Store&#39;s CFP)</span>
</span><span id="Warehouse.ReceiveBuyRequest-271"><a href="#Warehouse.ReceiveBuyRequest-271"><span class="linenos">271</span></a><span class="sd">            - Receives: store-buy messages (FIPA CFP)</span>
</span><span id="Warehouse.ReceiveBuyRequest-272"><a href="#Warehouse.ReceiveBuyRequest-272"><span class="linenos">272</span></a><span class="sd">            - Evaluates: Stock availability vs requested quantity</span>
</span><span id="Warehouse.ReceiveBuyRequest-273"><a href="#Warehouse.ReceiveBuyRequest-273"><span class="linenos">273</span></a><span class="sd">            - Responds: warehouse-accept (propose) or warehouse-reject (refuse)</span>
</span><span id="Warehouse.ReceiveBuyRequest-274"><a href="#Warehouse.ReceiveBuyRequest-274"><span class="linenos">274</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveBuyRequest-275"><a href="#Warehouse.ReceiveBuyRequest-275"><span class="linenos">275</span></a><span class="sd">        Stock Locking Mechanism:</span>
</span><span id="Warehouse.ReceiveBuyRequest-276"><a href="#Warehouse.ReceiveBuyRequest-276"><span class="linenos">276</span></a><span class="sd">            When accepting a request, stock is immediately moved from available to locked:</span>
</span><span id="Warehouse.ReceiveBuyRequest-277"><a href="#Warehouse.ReceiveBuyRequest-277"><span class="linenos">277</span></a><span class="sd">            - Prevents overselling (race condition protection)</span>
</span><span id="Warehouse.ReceiveBuyRequest-278"><a href="#Warehouse.ReceiveBuyRequest-278"><span class="linenos">278</span></a><span class="sd">            - Reserved during negotiation (awaiting confirmation)</span>
</span><span id="Warehouse.ReceiveBuyRequest-279"><a href="#Warehouse.ReceiveBuyRequest-279"><span class="linenos">279</span></a><span class="sd">            - Released if store sends denial or timeout occurs</span>
</span><span id="Warehouse.ReceiveBuyRequest-280"><a href="#Warehouse.ReceiveBuyRequest-280"><span class="linenos">280</span></a><span class="sd">            - Transferred to pending_deliveries if store confirms</span>
</span><span id="Warehouse.ReceiveBuyRequest-281"><a href="#Warehouse.ReceiveBuyRequest-281"><span class="linenos">281</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveBuyRequest-282"><a href="#Warehouse.ReceiveBuyRequest-282"><span class="linenos">282</span></a><span class="sd">        Decision Logic:</span>
</span><span id="Warehouse.ReceiveBuyRequest-283"><a href="#Warehouse.ReceiveBuyRequest-283"><span class="linenos">283</span></a><span class="sd">            Accept if: (product in stock) AND (stock[product] &gt;= quantity)</span>
</span><span id="Warehouse.ReceiveBuyRequest-284"><a href="#Warehouse.ReceiveBuyRequest-284"><span class="linenos">284</span></a><span class="sd">            Reject if: Product unavailable OR insufficient quantity</span>
</span><span id="Warehouse.ReceiveBuyRequest-285"><a href="#Warehouse.ReceiveBuyRequest-285"><span class="linenos">285</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveBuyRequest-286"><a href="#Warehouse.ReceiveBuyRequest-286"><span class="linenos">286</span></a><span class="sd">        Message Format (store-buy):</span>
</span><span id="Warehouse.ReceiveBuyRequest-287"><a href="#Warehouse.ReceiveBuyRequest-287"><span class="linenos">287</span></a><span class="sd">            Metadata:</span>
</span><span id="Warehouse.ReceiveBuyRequest-288"><a href="#Warehouse.ReceiveBuyRequest-288"><span class="linenos">288</span></a><span class="sd">                - performative: &quot;store-buy&quot;</span>
</span><span id="Warehouse.ReceiveBuyRequest-289"><a href="#Warehouse.ReceiveBuyRequest-289"><span class="linenos">289</span></a><span class="sd">                - request_id: Unique request identifier</span>
</span><span id="Warehouse.ReceiveBuyRequest-290"><a href="#Warehouse.ReceiveBuyRequest-290"><span class="linenos">290</span></a><span class="sd">            Body:</span>
</span><span id="Warehouse.ReceiveBuyRequest-291"><a href="#Warehouse.ReceiveBuyRequest-291"><span class="linenos">291</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse.ReceiveBuyRequest-292"><a href="#Warehouse.ReceiveBuyRequest-292"><span class="linenos">292</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="Warehouse.ReceiveBuyRequest-293"><a href="#Warehouse.ReceiveBuyRequest-293"><span class="linenos">293</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveBuyRequest-294"><a href="#Warehouse.ReceiveBuyRequest-294"><span class="linenos">294</span></a><span class="sd">        Workflow:</span>
</span><span id="Warehouse.ReceiveBuyRequest-295"><a href="#Warehouse.ReceiveBuyRequest-295"><span class="linenos">295</span></a><span class="sd">            1. **Receive**: Wait up to 20 seconds for store-buy message</span>
</span><span id="Warehouse.ReceiveBuyRequest-296"><a href="#Warehouse.ReceiveBuyRequest-296"><span class="linenos">296</span></a><span class="sd">            2. **Parse**: Extract request_id, quantity, product from message</span>
</span><span id="Warehouse.ReceiveBuyRequest-297"><a href="#Warehouse.ReceiveBuyRequest-297"><span class="linenos">297</span></a><span class="sd">            3. **Evaluate**: Check if product exists and quantity available</span>
</span><span id="Warehouse.ReceiveBuyRequest-298"><a href="#Warehouse.ReceiveBuyRequest-298"><span class="linenos">298</span></a><span class="sd">            4. **Accept Path**:</span>
</span><span id="Warehouse.ReceiveBuyRequest-299"><a href="#Warehouse.ReceiveBuyRequest-299"><span class="linenos">299</span></a><span class="sd">                a. Lock stock: stock[product] -= quantity</span>
</span><span id="Warehouse.ReceiveBuyRequest-300"><a href="#Warehouse.ReceiveBuyRequest-300"><span class="linenos">300</span></a><span class="sd">                b. Update locked_stock: locked_stock[product] += quantity</span>
</span><span id="Warehouse.ReceiveBuyRequest-301"><a href="#Warehouse.ReceiveBuyRequest-301"><span class="linenos">301</span></a><span class="sd">                c. Launch AcceptBuyRequest behaviour (send warehouse-accept)</span>
</span><span id="Warehouse.ReceiveBuyRequest-302"><a href="#Warehouse.ReceiveBuyRequest-302"><span class="linenos">302</span></a><span class="sd">            5. **Reject Path**:</span>
</span><span id="Warehouse.ReceiveBuyRequest-303"><a href="#Warehouse.ReceiveBuyRequest-303"><span class="linenos">303</span></a><span class="sd">                a. Launch RejectBuyRequest behaviour with reason</span>
</span><span id="Warehouse.ReceiveBuyRequest-304"><a href="#Warehouse.ReceiveBuyRequest-304"><span class="linenos">304</span></a><span class="sd">                b. No stock changes</span>
</span><span id="Warehouse.ReceiveBuyRequest-305"><a href="#Warehouse.ReceiveBuyRequest-305"><span class="linenos">305</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveBuyRequest-306"><a href="#Warehouse.ReceiveBuyRequest-306"><span class="linenos">306</span></a><span class="sd">        Concurrency Handling:</span>
</span><span id="Warehouse.ReceiveBuyRequest-307"><a href="#Warehouse.ReceiveBuyRequest-307"><span class="linenos">307</span></a><span class="sd">            - Processes multiple requests concurrently (cyclic behaviour)</span>
</span><span id="Warehouse.ReceiveBuyRequest-308"><a href="#Warehouse.ReceiveBuyRequest-308"><span class="linenos">308</span></a><span class="sd">            - Stock locking prevents double-allocation</span>
</span><span id="Warehouse.ReceiveBuyRequest-309"><a href="#Warehouse.ReceiveBuyRequest-309"><span class="linenos">309</span></a><span class="sd">            - Each request launches independent OneShot behaviours</span>
</span><span id="Warehouse.ReceiveBuyRequest-310"><a href="#Warehouse.ReceiveBuyRequest-310"><span class="linenos">310</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveBuyRequest-311"><a href="#Warehouse.ReceiveBuyRequest-311"><span class="linenos">311</span></a><span class="sd">        Example Execution:</span>
</span><span id="Warehouse.ReceiveBuyRequest-312"><a href="#Warehouse.ReceiveBuyRequest-312"><span class="linenos">312</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceiveBuyRequest-313"><a href="#Warehouse.ReceiveBuyRequest-313"><span class="linenos">313</span></a><span class="sd">            Request Received: &quot;50 electronics&quot; (request_id=1001000000)</span>
</span><span id="Warehouse.ReceiveBuyRequest-314"><a href="#Warehouse.ReceiveBuyRequest-314"><span class="linenos">314</span></a><span class="sd">            Stock Check: electronics: 100 available</span>
</span><span id="Warehouse.ReceiveBuyRequest-315"><a href="#Warehouse.ReceiveBuyRequest-315"><span class="linenos">315</span></a><span class="sd">            Decision: ACCEPT</span>
</span><span id="Warehouse.ReceiveBuyRequest-316"><a href="#Warehouse.ReceiveBuyRequest-316"><span class="linenos">316</span></a><span class="sd">            Actions:</span>
</span><span id="Warehouse.ReceiveBuyRequest-317"><a href="#Warehouse.ReceiveBuyRequest-317"><span class="linenos">317</span></a><span class="sd">                - stock[electronics]: 100 -&gt; 50</span>
</span><span id="Warehouse.ReceiveBuyRequest-318"><a href="#Warehouse.ReceiveBuyRequest-318"><span class="linenos">318</span></a><span class="sd">                - locked_stock[electronics]: 0 -&gt; 50</span>
</span><span id="Warehouse.ReceiveBuyRequest-319"><a href="#Warehouse.ReceiveBuyRequest-319"><span class="linenos">319</span></a><span class="sd">                - Launch AcceptBuyRequest</span>
</span><span id="Warehouse.ReceiveBuyRequest-320"><a href="#Warehouse.ReceiveBuyRequest-320"><span class="linenos">320</span></a><span class="sd">                - Wait for store-confirm or store-deny</span>
</span><span id="Warehouse.ReceiveBuyRequest-321"><a href="#Warehouse.ReceiveBuyRequest-321"><span class="linenos">321</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceiveBuyRequest-322"><a href="#Warehouse.ReceiveBuyRequest-322"><span class="linenos">322</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveBuyRequest-323"><a href="#Warehouse.ReceiveBuyRequest-323"><span class="linenos">323</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse.ReceiveBuyRequest-324"><a href="#Warehouse.ReceiveBuyRequest-324"><span class="linenos">324</span></a><span class="sd">            This behaviour never terminates (cyclic), continuously listening for</span>
</span><span id="Warehouse.ReceiveBuyRequest-325"><a href="#Warehouse.ReceiveBuyRequest-325"><span class="linenos">325</span></a><span class="sd">            store requests throughout the warehouse&#39;s lifecycle.</span>
</span><span id="Warehouse.ReceiveBuyRequest-326"><a href="#Warehouse.ReceiveBuyRequest-326"><span class="linenos">326</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveBuyRequest-327"><a href="#Warehouse.ReceiveBuyRequest-327"><span class="linenos">327</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveBuyRequest-328"><a href="#Warehouse.ReceiveBuyRequest-328"><span class="linenos">328</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ReceiveBuyRequest-329"><a href="#Warehouse.ReceiveBuyRequest-329"><span class="linenos">329</span></a>        
</span><span id="Warehouse.ReceiveBuyRequest-330"><a href="#Warehouse.ReceiveBuyRequest-330"><span class="linenos">330</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest-331"><a href="#Warehouse.ReceiveBuyRequest-331"><span class="linenos">331</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Awaiting buy request...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest-332"><a href="#Warehouse.ReceiveBuyRequest-332"><span class="linenos">332</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest-333"><a href="#Warehouse.ReceiveBuyRequest-333"><span class="linenos">333</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest-334"><a href="#Warehouse.ReceiveBuyRequest-334"><span class="linenos">334</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveBuyRequest-335"><a href="#Warehouse.ReceiveBuyRequest-335"><span class="linenos">335</span></a><span class="sd">                Messages with metadata (&quot;performative&quot;, &quot;store-buy&quot;) have body</span>
</span><span id="Warehouse.ReceiveBuyRequest-336"><a href="#Warehouse.ReceiveBuyRequest-336"><span class="linenos">336</span></a><span class="sd">                with the following format:</span>
</span><span id="Warehouse.ReceiveBuyRequest-337"><a href="#Warehouse.ReceiveBuyRequest-337"><span class="linenos">337</span></a><span class="sd">                </span>
</span><span id="Warehouse.ReceiveBuyRequest-338"><a href="#Warehouse.ReceiveBuyRequest-338"><span class="linenos">338</span></a><span class="sd">                &quot;product_quantity product_type&quot;</span>
</span><span id="Warehouse.ReceiveBuyRequest-339"><a href="#Warehouse.ReceiveBuyRequest-339"><span class="linenos">339</span></a><span class="sd">                </span>
</span><span id="Warehouse.ReceiveBuyRequest-340"><a href="#Warehouse.ReceiveBuyRequest-340"><span class="linenos">340</span></a><span class="sd">                request_id is in metadata[&quot;request_id&quot;]</span>
</span><span id="Warehouse.ReceiveBuyRequest-341"><a href="#Warehouse.ReceiveBuyRequest-341"><span class="linenos">341</span></a><span class="sd">                &quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveBuyRequest-342"><a href="#Warehouse.ReceiveBuyRequest-342"><span class="linenos">342</span></a>                <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.ReceiveBuyRequest-343"><a href="#Warehouse.ReceiveBuyRequest-343"><span class="linenos">343</span></a>                <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest-344"><a href="#Warehouse.ReceiveBuyRequest-344"><span class="linenos">344</span></a>                <span class="n">quant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.ReceiveBuyRequest-345"><a href="#Warehouse.ReceiveBuyRequest-345"><span class="linenos">345</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveBuyRequest-346"><a href="#Warehouse.ReceiveBuyRequest-346"><span class="linenos">346</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Got request </span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">quant</span><span class="si">}</span><span class="s2"> x</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest-347"><a href="#Warehouse.ReceiveBuyRequest-347"><span class="linenos">347</span></a>                
</span><span id="Warehouse.ReceiveBuyRequest-348"><a href="#Warehouse.ReceiveBuyRequest-348"><span class="linenos">348</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">quant</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest-349"><a href="#Warehouse.ReceiveBuyRequest-349"><span class="linenos">349</span></a>                    <span class="n">accept_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">AcceptBuyRequest</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest-350"><a href="#Warehouse.ReceiveBuyRequest-350"><span class="linenos">350</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest-351"><a href="#Warehouse.ReceiveBuyRequest-351"><span class="linenos">351</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Locking </span><span class="si">{</span><span class="n">quant</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest-352"><a href="#Warehouse.ReceiveBuyRequest-352"><span class="linenos">352</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quant</span>
</span><span id="Warehouse.ReceiveBuyRequest-353"><a href="#Warehouse.ReceiveBuyRequest-353"><span class="linenos">353</span></a>                    
</span><span id="Warehouse.ReceiveBuyRequest-354"><a href="#Warehouse.ReceiveBuyRequest-354"><span class="linenos">354</span></a>                    <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest-355"><a href="#Warehouse.ReceiveBuyRequest-355"><span class="linenos">355</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quant</span>
</span><span id="Warehouse.ReceiveBuyRequest-356"><a href="#Warehouse.ReceiveBuyRequest-356"><span class="linenos">356</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant</span>
</span><span id="Warehouse.ReceiveBuyRequest-357"><a href="#Warehouse.ReceiveBuyRequest-357"><span class="linenos">357</span></a>
</span><span id="Warehouse.ReceiveBuyRequest-358"><a href="#Warehouse.ReceiveBuyRequest-358"><span class="linenos">358</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest-359"><a href="#Warehouse.ReceiveBuyRequest-359"><span class="linenos">359</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Items locked at </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest-360"><a href="#Warehouse.ReceiveBuyRequest-360"><span class="linenos">360</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="Warehouse.ReceiveBuyRequest-361"><a href="#Warehouse.ReceiveBuyRequest-361"><span class="linenos">361</span></a>                    
</span><span id="Warehouse.ReceiveBuyRequest-362"><a href="#Warehouse.ReceiveBuyRequest-362"><span class="linenos">362</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">accept_behav</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest-363"><a href="#Warehouse.ReceiveBuyRequest-363"><span class="linenos">363</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest-364"><a href="#Warehouse.ReceiveBuyRequest-364"><span class="linenos">364</span></a>                    <span class="c1"># Reject the request - insufficient stock</span>
</span><span id="Warehouse.ReceiveBuyRequest-365"><a href="#Warehouse.ReceiveBuyRequest-365"><span class="linenos">365</span></a>                    <span class="n">reject_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">RejectBuyRequest</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;insufficient_stock&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest-366"><a href="#Warehouse.ReceiveBuyRequest-366"><span class="linenos">366</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">reject_behav</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest-367"><a href="#Warehouse.ReceiveBuyRequest-367"><span class="linenos">367</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest-368"><a href="#Warehouse.ReceiveBuyRequest-368"><span class="linenos">368</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Could not satisfy request. Rejection sent.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest-369"><a href="#Warehouse.ReceiveBuyRequest-369"><span class="linenos">369</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest-370"><a href="#Warehouse.ReceiveBuyRequest-370"><span class="linenos">370</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest-371"><a href="#Warehouse.ReceiveBuyRequest-371"><span class="linenos">371</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Did not get any buy requests in 20 seconds.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Cyclic behaviour that processes incoming purchase requests from stores.</p>

<p>This behaviour implements the proposal phase of the FIPA Contract Net Protocol
where the warehouse acts as a <strong>Participant</strong>. It receives CFP messages from
stores, evaluates inventory availability, and responds with either a proposal
(warehouse-accept) or refusal (warehouse-reject).</p>

<p>FIPA Protocol Phase: <strong>Proposal Phase - Participant Role</strong>
    - Role: Participant (Warehouse responding to Store's CFP)
    - Receives: store-buy messages (FIPA CFP)
    - Evaluates: Stock availability vs requested quantity
    - Responds: warehouse-accept (propose) or warehouse-reject (refuse)</p>

<h6 id="stock-locking-mechanism">Stock Locking Mechanism:</h6>

<blockquote>
  <p>When accepting a request, stock is immediately moved from available to locked:</p>
  
  <ul>
  <li>Prevents overselling (race condition protection)</li>
  <li>Reserved during negotiation (awaiting confirmation)</li>
  <li>Released if store sends denial or timeout occurs</li>
  <li>Transferred to pending_deliveries if store confirms</li>
  </ul>
</blockquote>

<h6 id="decision-logic">Decision Logic:</h6>

<blockquote>
  <p>Accept if: (product in stock) AND (stock[product] &gt;= quantity)
  Reject if: Product unavailable OR insufficient quantity</p>
</blockquote>

<p>Message Format (store-buy):
    Metadata:
        - performative: "store-buy"
        - request_id: Unique request identifier
    Body:
        - Format: "{quantity} {product}"
        - Example: "50 electronics"</p>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Receive</strong>: Wait up to 20 seconds for store-buy message</li>
  <li><strong>Parse</strong>: Extract request_id, quantity, product from message</li>
  <li><strong>Evaluate</strong>: Check if product exists and quantity available</li>
  <li><strong>Accept Path</strong>:
  a. Lock stock: stock[product] -= quantity
  b. Update locked_stock: locked_stock[product] += quantity
  c. Launch AcceptBuyRequest behaviour (send warehouse-accept)</li>
  <li><strong>Reject Path</strong>:
  a. Launch RejectBuyRequest behaviour with reason
  b. No stock changes</li>
  </ol>
</blockquote>

<h6 id="concurrency-handling">Concurrency Handling:</h6>

<blockquote>
  <ul>
  <li>Processes multiple requests concurrently (cyclic behaviour)</li>
  <li>Stock locking prevents double-allocation</li>
  <li>Each request launches independent OneShot behaviours</li>
  </ul>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
<pre><code>Request Received: "50 electronics" (request_id=1001000000)
Stock Check: electronics: 100 available
Decision: ACCEPT
Actions:
    - stock[electronics]: 100 -&gt; 50
    - locked_stock[electronics]: 0 -&gt; 50
    - Launch AcceptBuyRequest
    - Wait for store-confirm or store-deny
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This behaviour never terminates (cyclic), continuously listening for
  store requests throughout the warehouse's lifecycle.</p>
</blockquote>
</div>


                            <div id="Warehouse.ReceiveBuyRequest.run" class="classattr">
                                        <input id="Warehouse.ReceiveBuyRequest.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.ReceiveBuyRequest.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveBuyRequest.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveBuyRequest.run-327"><a href="#Warehouse.ReceiveBuyRequest.run-327"><span class="linenos">327</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-328"><a href="#Warehouse.ReceiveBuyRequest.run-328"><span class="linenos">328</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-329"><a href="#Warehouse.ReceiveBuyRequest.run-329"><span class="linenos">329</span></a>        
</span><span id="Warehouse.ReceiveBuyRequest.run-330"><a href="#Warehouse.ReceiveBuyRequest.run-330"><span class="linenos">330</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-331"><a href="#Warehouse.ReceiveBuyRequest.run-331"><span class="linenos">331</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Awaiting buy request...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-332"><a href="#Warehouse.ReceiveBuyRequest.run-332"><span class="linenos">332</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-333"><a href="#Warehouse.ReceiveBuyRequest.run-333"><span class="linenos">333</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-334"><a href="#Warehouse.ReceiveBuyRequest.run-334"><span class="linenos">334</span></a><span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-335"><a href="#Warehouse.ReceiveBuyRequest.run-335"><span class="linenos">335</span></a><span class="sd">                Messages with metadata (&quot;performative&quot;, &quot;store-buy&quot;) have body</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-336"><a href="#Warehouse.ReceiveBuyRequest.run-336"><span class="linenos">336</span></a><span class="sd">                with the following format:</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-337"><a href="#Warehouse.ReceiveBuyRequest.run-337"><span class="linenos">337</span></a><span class="sd">                </span>
</span><span id="Warehouse.ReceiveBuyRequest.run-338"><a href="#Warehouse.ReceiveBuyRequest.run-338"><span class="linenos">338</span></a><span class="sd">                &quot;product_quantity product_type&quot;</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-339"><a href="#Warehouse.ReceiveBuyRequest.run-339"><span class="linenos">339</span></a><span class="sd">                </span>
</span><span id="Warehouse.ReceiveBuyRequest.run-340"><a href="#Warehouse.ReceiveBuyRequest.run-340"><span class="linenos">340</span></a><span class="sd">                request_id is in metadata[&quot;request_id&quot;]</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-341"><a href="#Warehouse.ReceiveBuyRequest.run-341"><span class="linenos">341</span></a><span class="sd">                &quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-342"><a href="#Warehouse.ReceiveBuyRequest.run-342"><span class="linenos">342</span></a>                <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-343"><a href="#Warehouse.ReceiveBuyRequest.run-343"><span class="linenos">343</span></a>                <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-344"><a href="#Warehouse.ReceiveBuyRequest.run-344"><span class="linenos">344</span></a>                <span class="n">quant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-345"><a href="#Warehouse.ReceiveBuyRequest.run-345"><span class="linenos">345</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-346"><a href="#Warehouse.ReceiveBuyRequest.run-346"><span class="linenos">346</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Got request </span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">quant</span><span class="si">}</span><span class="s2"> x</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-347"><a href="#Warehouse.ReceiveBuyRequest.run-347"><span class="linenos">347</span></a>                
</span><span id="Warehouse.ReceiveBuyRequest.run-348"><a href="#Warehouse.ReceiveBuyRequest.run-348"><span class="linenos">348</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">quant</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-349"><a href="#Warehouse.ReceiveBuyRequest.run-349"><span class="linenos">349</span></a>                    <span class="n">accept_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">AcceptBuyRequest</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-350"><a href="#Warehouse.ReceiveBuyRequest.run-350"><span class="linenos">350</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-351"><a href="#Warehouse.ReceiveBuyRequest.run-351"><span class="linenos">351</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Locking </span><span class="si">{</span><span class="n">quant</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-352"><a href="#Warehouse.ReceiveBuyRequest.run-352"><span class="linenos">352</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quant</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-353"><a href="#Warehouse.ReceiveBuyRequest.run-353"><span class="linenos">353</span></a>                    
</span><span id="Warehouse.ReceiveBuyRequest.run-354"><a href="#Warehouse.ReceiveBuyRequest.run-354"><span class="linenos">354</span></a>                    <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-355"><a href="#Warehouse.ReceiveBuyRequest.run-355"><span class="linenos">355</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quant</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-356"><a href="#Warehouse.ReceiveBuyRequest.run-356"><span class="linenos">356</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-357"><a href="#Warehouse.ReceiveBuyRequest.run-357"><span class="linenos">357</span></a>
</span><span id="Warehouse.ReceiveBuyRequest.run-358"><a href="#Warehouse.ReceiveBuyRequest.run-358"><span class="linenos">358</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-359"><a href="#Warehouse.ReceiveBuyRequest.run-359"><span class="linenos">359</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Items locked at </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-360"><a href="#Warehouse.ReceiveBuyRequest.run-360"><span class="linenos">360</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-361"><a href="#Warehouse.ReceiveBuyRequest.run-361"><span class="linenos">361</span></a>                    
</span><span id="Warehouse.ReceiveBuyRequest.run-362"><a href="#Warehouse.ReceiveBuyRequest.run-362"><span class="linenos">362</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">accept_behav</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-363"><a href="#Warehouse.ReceiveBuyRequest.run-363"><span class="linenos">363</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-364"><a href="#Warehouse.ReceiveBuyRequest.run-364"><span class="linenos">364</span></a>                    <span class="c1"># Reject the request - insufficient stock</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-365"><a href="#Warehouse.ReceiveBuyRequest.run-365"><span class="linenos">365</span></a>                    <span class="n">reject_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">RejectBuyRequest</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;insufficient_stock&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-366"><a href="#Warehouse.ReceiveBuyRequest.run-366"><span class="linenos">366</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">reject_behav</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-367"><a href="#Warehouse.ReceiveBuyRequest.run-367"><span class="linenos">367</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-368"><a href="#Warehouse.ReceiveBuyRequest.run-368"><span class="linenos">368</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Could not satisfy request. Rejection sent.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-369"><a href="#Warehouse.ReceiveBuyRequest.run-369"><span class="linenos">369</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-370"><a href="#Warehouse.ReceiveBuyRequest.run-370"><span class="linenos">370</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveBuyRequest.run-371"><a href="#Warehouse.ReceiveBuyRequest.run-371"><span class="linenos">371</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Did not get any buy requests in 20 seconds.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.AcceptBuyRequest">
                            <input id="Warehouse.AcceptBuyRequest-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.AcceptBuyRequest</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Warehouse.AcceptBuyRequest-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.AcceptBuyRequest"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.AcceptBuyRequest-373"><a href="#Warehouse.AcceptBuyRequest-373"><span class="linenos">373</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">AcceptBuyRequest</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.AcceptBuyRequest-374"><a href="#Warehouse.AcceptBuyRequest-374"><span class="linenos">374</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-375"><a href="#Warehouse.AcceptBuyRequest-375"><span class="linenos">375</span></a><span class="sd">        Behaviour that sends proposal acceptance to store (FIPA propose).</span>
</span><span id="Warehouse.AcceptBuyRequest-376"><a href="#Warehouse.AcceptBuyRequest-376"><span class="linenos">376</span></a><span class="sd">        </span>
</span><span id="Warehouse.AcceptBuyRequest-377"><a href="#Warehouse.AcceptBuyRequest-377"><span class="linenos">377</span></a><span class="sd">        This behaviour implements the proposal submission in the FIPA Contract Net</span>
</span><span id="Warehouse.AcceptBuyRequest-378"><a href="#Warehouse.AcceptBuyRequest-378"><span class="linenos">378</span></a><span class="sd">        Protocol where the warehouse, acting as a participant, sends its proposal</span>
</span><span id="Warehouse.AcceptBuyRequest-379"><a href="#Warehouse.AcceptBuyRequest-379"><span class="linenos">379</span></a><span class="sd">        to fulfill the store&#39;s request. It then sets up to receive the store&#39;s</span>
</span><span id="Warehouse.AcceptBuyRequest-380"><a href="#Warehouse.AcceptBuyRequest-380"><span class="linenos">380</span></a><span class="sd">        decision (accept-proposal or reject-proposal).</span>
</span><span id="Warehouse.AcceptBuyRequest-381"><a href="#Warehouse.AcceptBuyRequest-381"><span class="linenos">381</span></a><span class="sd">        </span>
</span><span id="Warehouse.AcceptBuyRequest-382"><a href="#Warehouse.AcceptBuyRequest-382"><span class="linenos">382</span></a><span class="sd">        FIPA Protocol Phase: **Proposal Submission - Participant Role**</span>
</span><span id="Warehouse.AcceptBuyRequest-383"><a href="#Warehouse.AcceptBuyRequest-383"><span class="linenos">383</span></a><span class="sd">            - Role: Participant (Warehouse proposing to Store)</span>
</span><span id="Warehouse.AcceptBuyRequest-384"><a href="#Warehouse.AcceptBuyRequest-384"><span class="linenos">384</span></a><span class="sd">            - Sends: warehouse-accept (FIPA propose)</span>
</span><span id="Warehouse.AcceptBuyRequest-385"><a href="#Warehouse.AcceptBuyRequest-385"><span class="linenos">385</span></a><span class="sd">            - Purpose: &quot;I can fulfill your request&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-386"><a href="#Warehouse.AcceptBuyRequest-386"><span class="linenos">386</span></a><span class="sd">            - Next Phase: Await store&#39;s award or rejection decision</span>
</span><span id="Warehouse.AcceptBuyRequest-387"><a href="#Warehouse.AcceptBuyRequest-387"><span class="linenos">387</span></a><span class="sd">        </span>
</span><span id="Warehouse.AcceptBuyRequest-388"><a href="#Warehouse.AcceptBuyRequest-388"><span class="linenos">388</span></a><span class="sd">        Attributes:</span>
</span><span id="Warehouse.AcceptBuyRequest-389"><a href="#Warehouse.AcceptBuyRequest-389"><span class="linenos">389</span></a><span class="sd">            request_id (int): Unique identifier for this request.</span>
</span><span id="Warehouse.AcceptBuyRequest-390"><a href="#Warehouse.AcceptBuyRequest-390"><span class="linenos">390</span></a><span class="sd">            quant (int): Quantity of product being proposed.</span>
</span><span id="Warehouse.AcceptBuyRequest-391"><a href="#Warehouse.AcceptBuyRequest-391"><span class="linenos">391</span></a><span class="sd">            product (str): Name of product being proposed.</span>
</span><span id="Warehouse.AcceptBuyRequest-392"><a href="#Warehouse.AcceptBuyRequest-392"><span class="linenos">392</span></a><span class="sd">            sender (str): Store JID that initiated the request.</span>
</span><span id="Warehouse.AcceptBuyRequest-393"><a href="#Warehouse.AcceptBuyRequest-393"><span class="linenos">393</span></a><span class="sd">        </span>
</span><span id="Warehouse.AcceptBuyRequest-394"><a href="#Warehouse.AcceptBuyRequest-394"><span class="linenos">394</span></a><span class="sd">        Message Format (warehouse-accept):</span>
</span><span id="Warehouse.AcceptBuyRequest-395"><a href="#Warehouse.AcceptBuyRequest-395"><span class="linenos">395</span></a><span class="sd">            Metadata:</span>
</span><span id="Warehouse.AcceptBuyRequest-396"><a href="#Warehouse.AcceptBuyRequest-396"><span class="linenos">396</span></a><span class="sd">                - performative: &quot;warehouse-accept&quot; (FIPA propose)</span>
</span><span id="Warehouse.AcceptBuyRequest-397"><a href="#Warehouse.AcceptBuyRequest-397"><span class="linenos">397</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="Warehouse.AcceptBuyRequest-398"><a href="#Warehouse.AcceptBuyRequest-398"><span class="linenos">398</span></a><span class="sd">                - store_id: Requesting store&#39;s JID</span>
</span><span id="Warehouse.AcceptBuyRequest-399"><a href="#Warehouse.AcceptBuyRequest-399"><span class="linenos">399</span></a><span class="sd">                - node_id: Warehouse&#39;s graph location</span>
</span><span id="Warehouse.AcceptBuyRequest-400"><a href="#Warehouse.AcceptBuyRequest-400"><span class="linenos">400</span></a><span class="sd">                - request_id: Original request identifier</span>
</span><span id="Warehouse.AcceptBuyRequest-401"><a href="#Warehouse.AcceptBuyRequest-401"><span class="linenos">401</span></a><span class="sd">            Body:</span>
</span><span id="Warehouse.AcceptBuyRequest-402"><a href="#Warehouse.AcceptBuyRequest-402"><span class="linenos">402</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-403"><a href="#Warehouse.AcceptBuyRequest-403"><span class="linenos">403</span></a><span class="sd">                - Example: &quot;50 electronics&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-404"><a href="#Warehouse.AcceptBuyRequest-404"><span class="linenos">404</span></a><span class="sd">        </span>
</span><span id="Warehouse.AcceptBuyRequest-405"><a href="#Warehouse.AcceptBuyRequest-405"><span class="linenos">405</span></a><span class="sd">        Workflow:</span>
</span><span id="Warehouse.AcceptBuyRequest-406"><a href="#Warehouse.AcceptBuyRequest-406"><span class="linenos">406</span></a><span class="sd">            1. **Send Proposal**: Construct and send warehouse-accept message</span>
</span><span id="Warehouse.AcceptBuyRequest-407"><a href="#Warehouse.AcceptBuyRequest-407"><span class="linenos">407</span></a><span class="sd">            2. **Setup Listener**: Create ReceiveConfirmationOrDenial behaviour</span>
</span><span id="Warehouse.AcceptBuyRequest-408"><a href="#Warehouse.AcceptBuyRequest-408"><span class="linenos">408</span></a><span class="sd">            3. **Configure Template**: Filter for this specific store and request</span>
</span><span id="Warehouse.AcceptBuyRequest-409"><a href="#Warehouse.AcceptBuyRequest-409"><span class="linenos">409</span></a><span class="sd">            4. **Register Behaviour**: Add listener with template to agent</span>
</span><span id="Warehouse.AcceptBuyRequest-410"><a href="#Warehouse.AcceptBuyRequest-410"><span class="linenos">410</span></a><span class="sd">            5. **Non-blocking**: Return immediately (don&#39;t wait for response)</span>
</span><span id="Warehouse.AcceptBuyRequest-411"><a href="#Warehouse.AcceptBuyRequest-411"><span class="linenos">411</span></a><span class="sd">        </span>
</span><span id="Warehouse.AcceptBuyRequest-412"><a href="#Warehouse.AcceptBuyRequest-412"><span class="linenos">412</span></a><span class="sd">        Template Configuration:</span>
</span><span id="Warehouse.AcceptBuyRequest-413"><a href="#Warehouse.AcceptBuyRequest-413"><span class="linenos">413</span></a><span class="sd">            Filters messages to match:</span>
</span><span id="Warehouse.AcceptBuyRequest-414"><a href="#Warehouse.AcceptBuyRequest-414"><span class="linenos">414</span></a><span class="sd">            - warehouse_id: This warehouse</span>
</span><span id="Warehouse.AcceptBuyRequest-415"><a href="#Warehouse.AcceptBuyRequest-415"><span class="linenos">415</span></a><span class="sd">            - store_id: Specific store that made request</span>
</span><span id="Warehouse.AcceptBuyRequest-416"><a href="#Warehouse.AcceptBuyRequest-416"><span class="linenos">416</span></a><span class="sd">            - request_id: This specific request</span>
</span><span id="Warehouse.AcceptBuyRequest-417"><a href="#Warehouse.AcceptBuyRequest-417"><span class="linenos">417</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest-418"><a href="#Warehouse.AcceptBuyRequest-418"><span class="linenos">418</span></a><span class="sd">            Accepts both performatives:</span>
</span><span id="Warehouse.AcceptBuyRequest-419"><a href="#Warehouse.AcceptBuyRequest-419"><span class="linenos">419</span></a><span class="sd">            - store-confirm (FIPA accept-proposal)</span>
</span><span id="Warehouse.AcceptBuyRequest-420"><a href="#Warehouse.AcceptBuyRequest-420"><span class="linenos">420</span></a><span class="sd">            - store-deny (FIPA reject-proposal)</span>
</span><span id="Warehouse.AcceptBuyRequest-421"><a href="#Warehouse.AcceptBuyRequest-421"><span class="linenos">421</span></a><span class="sd">        </span>
</span><span id="Warehouse.AcceptBuyRequest-422"><a href="#Warehouse.AcceptBuyRequest-422"><span class="linenos">422</span></a><span class="sd">        Example:</span>
</span><span id="Warehouse.AcceptBuyRequest-423"><a href="#Warehouse.AcceptBuyRequest-423"><span class="linenos">423</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.AcceptBuyRequest-424"><a href="#Warehouse.AcceptBuyRequest-424"><span class="linenos">424</span></a><span class="sd">            Input: Store request for &quot;50 electronics&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-425"><a href="#Warehouse.AcceptBuyRequest-425"><span class="linenos">425</span></a><span class="sd">            Proposal Sent: warehouse-accept with body &quot;50 electronics&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-426"><a href="#Warehouse.AcceptBuyRequest-426"><span class="linenos">426</span></a><span class="sd">            Listener Setup: ReceiveConfirmationOrDenial waiting for:</span>
</span><span id="Warehouse.AcceptBuyRequest-427"><a href="#Warehouse.AcceptBuyRequest-427"><span class="linenos">427</span></a><span class="sd">                - store-confirm (unlock -&gt; pending delivery) OR</span>
</span><span id="Warehouse.AcceptBuyRequest-428"><a href="#Warehouse.AcceptBuyRequest-428"><span class="linenos">428</span></a><span class="sd">                - store-deny (unlock -&gt; available stock)</span>
</span><span id="Warehouse.AcceptBuyRequest-429"><a href="#Warehouse.AcceptBuyRequest-429"><span class="linenos">429</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.AcceptBuyRequest-430"><a href="#Warehouse.AcceptBuyRequest-430"><span class="linenos">430</span></a><span class="sd">        </span>
</span><span id="Warehouse.AcceptBuyRequest-431"><a href="#Warehouse.AcceptBuyRequest-431"><span class="linenos">431</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse.AcceptBuyRequest-432"><a href="#Warehouse.AcceptBuyRequest-432"><span class="linenos">432</span></a><span class="sd">            Stock remains locked until ReceiveConfirmationOrDenial processes</span>
</span><span id="Warehouse.AcceptBuyRequest-433"><a href="#Warehouse.AcceptBuyRequest-433"><span class="linenos">433</span></a><span class="sd">            the store&#39;s decision or times out.</span>
</span><span id="Warehouse.AcceptBuyRequest-434"><a href="#Warehouse.AcceptBuyRequest-434"><span class="linenos">434</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-435"><a href="#Warehouse.AcceptBuyRequest-435"><span class="linenos">435</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Warehouse.AcceptBuyRequest-436"><a href="#Warehouse.AcceptBuyRequest-436"><span class="linenos">436</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-437"><a href="#Warehouse.AcceptBuyRequest-437"><span class="linenos">437</span></a><span class="sd">            Initialize the AcceptBuyRequest behaviour.</span>
</span><span id="Warehouse.AcceptBuyRequest-438"><a href="#Warehouse.AcceptBuyRequest-438"><span class="linenos">438</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest-439"><a href="#Warehouse.AcceptBuyRequest-439"><span class="linenos">439</span></a><span class="sd">            Args:</span>
</span><span id="Warehouse.AcceptBuyRequest-440"><a href="#Warehouse.AcceptBuyRequest-440"><span class="linenos">440</span></a><span class="sd">                msg (Message): The store-buy request message to accept.</span>
</span><span id="Warehouse.AcceptBuyRequest-441"><a href="#Warehouse.AcceptBuyRequest-441"><span class="linenos">441</span></a><span class="sd">                    Contains request_id in metadata and &quot;{quantity} {product}&quot; in body.</span>
</span><span id="Warehouse.AcceptBuyRequest-442"><a href="#Warehouse.AcceptBuyRequest-442"><span class="linenos">442</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-443"><a href="#Warehouse.AcceptBuyRequest-443"><span class="linenos">443</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.AcceptBuyRequest-444"><a href="#Warehouse.AcceptBuyRequest-444"><span class="linenos">444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest-445"><a href="#Warehouse.AcceptBuyRequest-445"><span class="linenos">445</span></a>            <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest-446"><a href="#Warehouse.AcceptBuyRequest-446"><span class="linenos">446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.AcceptBuyRequest-447"><a href="#Warehouse.AcceptBuyRequest-447"><span class="linenos">447</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.AcceptBuyRequest-448"><a href="#Warehouse.AcceptBuyRequest-448"><span class="linenos">448</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Warehouse.AcceptBuyRequest-449"><a href="#Warehouse.AcceptBuyRequest-449"><span class="linenos">449</span></a>        
</span><span id="Warehouse.AcceptBuyRequest-450"><a href="#Warehouse.AcceptBuyRequest-450"><span class="linenos">450</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.AcceptBuyRequest-451"><a href="#Warehouse.AcceptBuyRequest-451"><span class="linenos">451</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-452"><a href="#Warehouse.AcceptBuyRequest-452"><span class="linenos">452</span></a><span class="sd">            Execute the proposal sending and confirmation listener setup.</span>
</span><span id="Warehouse.AcceptBuyRequest-453"><a href="#Warehouse.AcceptBuyRequest-453"><span class="linenos">453</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest-454"><a href="#Warehouse.AcceptBuyRequest-454"><span class="linenos">454</span></a><span class="sd">            This method sends the warehouse-accept (FIPA propose) message to the store</span>
</span><span id="Warehouse.AcceptBuyRequest-455"><a href="#Warehouse.AcceptBuyRequest-455"><span class="linenos">455</span></a><span class="sd">            and immediately sets up a listener behaviour to await the store&#39;s decision.</span>
</span><span id="Warehouse.AcceptBuyRequest-456"><a href="#Warehouse.AcceptBuyRequest-456"><span class="linenos">456</span></a><span class="sd">            The method returns quickly without blocking, allowing the warehouse to</span>
</span><span id="Warehouse.AcceptBuyRequest-457"><a href="#Warehouse.AcceptBuyRequest-457"><span class="linenos">457</span></a><span class="sd">            continue processing other requests concurrently.</span>
</span><span id="Warehouse.AcceptBuyRequest-458"><a href="#Warehouse.AcceptBuyRequest-458"><span class="linenos">458</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest-459"><a href="#Warehouse.AcceptBuyRequest-459"><span class="linenos">459</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Warehouse.AcceptBuyRequest-460"><a href="#Warehouse.AcceptBuyRequest-460"><span class="linenos">460</span></a><span class="sd">                - **Phase**: Proposal Submission</span>
</span><span id="Warehouse.AcceptBuyRequest-461"><a href="#Warehouse.AcceptBuyRequest-461"><span class="linenos">461</span></a><span class="sd">                - **Performative**: warehouse-accept (FIPA propose)</span>
</span><span id="Warehouse.AcceptBuyRequest-462"><a href="#Warehouse.AcceptBuyRequest-462"><span class="linenos">462</span></a><span class="sd">                - **Content**: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-463"><a href="#Warehouse.AcceptBuyRequest-463"><span class="linenos">463</span></a><span class="sd">                - **Receiver**: Store that sent the CFP</span>
</span><span id="Warehouse.AcceptBuyRequest-464"><a href="#Warehouse.AcceptBuyRequest-464"><span class="linenos">464</span></a><span class="sd">                - **Next Step**: Await store&#39;s accept-proposal or reject-proposal</span>
</span><span id="Warehouse.AcceptBuyRequest-465"><a href="#Warehouse.AcceptBuyRequest-465"><span class="linenos">465</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest-466"><a href="#Warehouse.AcceptBuyRequest-466"><span class="linenos">466</span></a><span class="sd">            Workflow:</span>
</span><span id="Warehouse.AcceptBuyRequest-467"><a href="#Warehouse.AcceptBuyRequest-467"><span class="linenos">467</span></a><span class="sd">                1. **Log Acceptance** (verbose): Print proposal details</span>
</span><span id="Warehouse.AcceptBuyRequest-468"><a href="#Warehouse.AcceptBuyRequest-468"><span class="linenos">468</span></a><span class="sd">                2. **Construct Message**: Create warehouse-accept with all metadata</span>
</span><span id="Warehouse.AcceptBuyRequest-469"><a href="#Warehouse.AcceptBuyRequest-469"><span class="linenos">469</span></a><span class="sd">                3. **Send Proposal**: Transmit to requesting store</span>
</span><span id="Warehouse.AcceptBuyRequest-470"><a href="#Warehouse.AcceptBuyRequest-470"><span class="linenos">470</span></a><span class="sd">                4. **Create Listener**: Initialize ReceiveConfirmationOrDenial behaviour</span>
</span><span id="Warehouse.AcceptBuyRequest-471"><a href="#Warehouse.AcceptBuyRequest-471"><span class="linenos">471</span></a><span class="sd">                5. **Setup Template**: Configure filter for this specific negotiation</span>
</span><span id="Warehouse.AcceptBuyRequest-472"><a href="#Warehouse.AcceptBuyRequest-472"><span class="linenos">472</span></a><span class="sd">                6. **Register Listener**: Add behaviour with template to agent</span>
</span><span id="Warehouse.AcceptBuyRequest-473"><a href="#Warehouse.AcceptBuyRequest-473"><span class="linenos">473</span></a><span class="sd">                7. **Return**: Don&#39;t block (listener runs independently)</span>
</span><span id="Warehouse.AcceptBuyRequest-474"><a href="#Warehouse.AcceptBuyRequest-474"><span class="linenos">474</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest-475"><a href="#Warehouse.AcceptBuyRequest-475"><span class="linenos">475</span></a><span class="sd">            Template Filtering:</span>
</span><span id="Warehouse.AcceptBuyRequest-476"><a href="#Warehouse.AcceptBuyRequest-476"><span class="linenos">476</span></a><span class="sd">                The template ensures the listener only receives messages for THIS</span>
</span><span id="Warehouse.AcceptBuyRequest-477"><a href="#Warehouse.AcceptBuyRequest-477"><span class="linenos">477</span></a><span class="sd">                specific negotiation by matching:</span>
</span><span id="Warehouse.AcceptBuyRequest-478"><a href="#Warehouse.AcceptBuyRequest-478"><span class="linenos">478</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="Warehouse.AcceptBuyRequest-479"><a href="#Warehouse.AcceptBuyRequest-479"><span class="linenos">479</span></a><span class="sd">                - store_id: The specific store&#39;s JID</span>
</span><span id="Warehouse.AcceptBuyRequest-480"><a href="#Warehouse.AcceptBuyRequest-480"><span class="linenos">480</span></a><span class="sd">                - request_id: This specific request&#39;s ID</span>
</span><span id="Warehouse.AcceptBuyRequest-481"><a href="#Warehouse.AcceptBuyRequest-481"><span class="linenos">481</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest-482"><a href="#Warehouse.AcceptBuyRequest-482"><span class="linenos">482</span></a><span class="sd">            Non-Blocking Design:</span>
</span><span id="Warehouse.AcceptBuyRequest-483"><a href="#Warehouse.AcceptBuyRequest-483"><span class="linenos">483</span></a><span class="sd">                The commented-out `await confirm_deny_behav.join()` demonstrates</span>
</span><span id="Warehouse.AcceptBuyRequest-484"><a href="#Warehouse.AcceptBuyRequest-484"><span class="linenos">484</span></a><span class="sd">                that we intentionally DON&#39;T wait for confirmation here. This allows</span>
</span><span id="Warehouse.AcceptBuyRequest-485"><a href="#Warehouse.AcceptBuyRequest-485"><span class="linenos">485</span></a><span class="sd">                the warehouse to accept multiple store requests concurrently.</span>
</span><span id="Warehouse.AcceptBuyRequest-486"><a href="#Warehouse.AcceptBuyRequest-486"><span class="linenos">486</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest-487"><a href="#Warehouse.AcceptBuyRequest-487"><span class="linenos">487</span></a><span class="sd">            Side Effects:</span>
</span><span id="Warehouse.AcceptBuyRequest-488"><a href="#Warehouse.AcceptBuyRequest-488"><span class="linenos">488</span></a><span class="sd">                - Sends SPADE message to store</span>
</span><span id="Warehouse.AcceptBuyRequest-489"><a href="#Warehouse.AcceptBuyRequest-489"><span class="linenos">489</span></a><span class="sd">                - Adds ReceiveConfirmationOrDenial behaviour to agent</span>
</span><span id="Warehouse.AcceptBuyRequest-490"><a href="#Warehouse.AcceptBuyRequest-490"><span class="linenos">490</span></a><span class="sd">                - Prints debug information if verbose enabled</span>
</span><span id="Warehouse.AcceptBuyRequest-491"><a href="#Warehouse.AcceptBuyRequest-491"><span class="linenos">491</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest-492"><a href="#Warehouse.AcceptBuyRequest-492"><span class="linenos">492</span></a><span class="sd">            Returns:</span>
</span><span id="Warehouse.AcceptBuyRequest-493"><a href="#Warehouse.AcceptBuyRequest-493"><span class="linenos">493</span></a><span class="sd">                None. Completes immediately after setting up the listener.</span>
</span><span id="Warehouse.AcceptBuyRequest-494"><a href="#Warehouse.AcceptBuyRequest-494"><span class="linenos">494</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest-495"><a href="#Warehouse.AcceptBuyRequest-495"><span class="linenos">495</span></a><span class="sd">            Example:</span>
</span><span id="Warehouse.AcceptBuyRequest-496"><a href="#Warehouse.AcceptBuyRequest-496"><span class="linenos">496</span></a><span class="sd">                ```</span>
</span><span id="Warehouse.AcceptBuyRequest-497"><a href="#Warehouse.AcceptBuyRequest-497"><span class="linenos">497</span></a><span class="sd">                Input: Request for &quot;50 electronics&quot; from store1</span>
</span><span id="Warehouse.AcceptBuyRequest-498"><a href="#Warehouse.AcceptBuyRequest-498"><span class="linenos">498</span></a><span class="sd">                Actions:</span>
</span><span id="Warehouse.AcceptBuyRequest-499"><a href="#Warehouse.AcceptBuyRequest-499"><span class="linenos">499</span></a><span class="sd">                    1. Send warehouse-accept to store1</span>
</span><span id="Warehouse.AcceptBuyRequest-500"><a href="#Warehouse.AcceptBuyRequest-500"><span class="linenos">500</span></a><span class="sd">                    2. Setup listener with template matching:</span>
</span><span id="Warehouse.AcceptBuyRequest-501"><a href="#Warehouse.AcceptBuyRequest-501"><span class="linenos">501</span></a><span class="sd">                       - warehouse_id=warehouse1@localhost</span>
</span><span id="Warehouse.AcceptBuyRequest-502"><a href="#Warehouse.AcceptBuyRequest-502"><span class="linenos">502</span></a><span class="sd">                       - store_id=store1@localhost</span>
</span><span id="Warehouse.AcceptBuyRequest-503"><a href="#Warehouse.AcceptBuyRequest-503"><span class="linenos">503</span></a><span class="sd">                       - request_id=1001000000</span>
</span><span id="Warehouse.AcceptBuyRequest-504"><a href="#Warehouse.AcceptBuyRequest-504"><span class="linenos">504</span></a><span class="sd">                    3. Return (warehouse ready for next request)</span>
</span><span id="Warehouse.AcceptBuyRequest-505"><a href="#Warehouse.AcceptBuyRequest-505"><span class="linenos">505</span></a><span class="sd">                Listener waits independently for store&#39;s decision</span>
</span><span id="Warehouse.AcceptBuyRequest-506"><a href="#Warehouse.AcceptBuyRequest-506"><span class="linenos">506</span></a><span class="sd">                ```</span>
</span><span id="Warehouse.AcceptBuyRequest-507"><a href="#Warehouse.AcceptBuyRequest-507"><span class="linenos">507</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-508"><a href="#Warehouse.AcceptBuyRequest-508"><span class="linenos">508</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.AcceptBuyRequest-509"><a href="#Warehouse.AcceptBuyRequest-509"><span class="linenos">509</span></a>            
</span><span id="Warehouse.AcceptBuyRequest-510"><a href="#Warehouse.AcceptBuyRequest-510"><span class="linenos">510</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AcceptBuyRequest-511"><a href="#Warehouse.AcceptBuyRequest-511"><span class="linenos">511</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="Warehouse.AcceptBuyRequest-512"><a href="#Warehouse.AcceptBuyRequest-512"><span class="linenos">512</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Accepted a request from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">: &quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-513"><a href="#Warehouse.AcceptBuyRequest-513"><span class="linenos">513</span></a>                    <span class="sa">f</span><span class="s2">&quot;id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-514"><a href="#Warehouse.AcceptBuyRequest-514"><span class="linenos">514</span></a>                    <span class="sa">f</span><span class="s2">&quot;quant=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-515"><a href="#Warehouse.AcceptBuyRequest-515"><span class="linenos">515</span></a>                    <span class="sa">f</span><span class="s2">&quot;product=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-516"><a href="#Warehouse.AcceptBuyRequest-516"><span class="linenos">516</span></a>                <span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest-517"><a href="#Warehouse.AcceptBuyRequest-517"><span class="linenos">517</span></a>            
</span><span id="Warehouse.AcceptBuyRequest-518"><a href="#Warehouse.AcceptBuyRequest-518"><span class="linenos">518</span></a>            
</span><span id="Warehouse.AcceptBuyRequest-519"><a href="#Warehouse.AcceptBuyRequest-519"><span class="linenos">519</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest-520"><a href="#Warehouse.AcceptBuyRequest-520"><span class="linenos">520</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-accept&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest-521"><a href="#Warehouse.AcceptBuyRequest-521"><span class="linenos">521</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest-522"><a href="#Warehouse.AcceptBuyRequest-522"><span class="linenos">522</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest-523"><a href="#Warehouse.AcceptBuyRequest-523"><span class="linenos">523</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest-524"><a href="#Warehouse.AcceptBuyRequest-524"><span class="linenos">524</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest-525"><a href="#Warehouse.AcceptBuyRequest-525"><span class="linenos">525</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest-526"><a href="#Warehouse.AcceptBuyRequest-526"><span class="linenos">526</span></a>            
</span><span id="Warehouse.AcceptBuyRequest-527"><a href="#Warehouse.AcceptBuyRequest-527"><span class="linenos">527</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest-528"><a href="#Warehouse.AcceptBuyRequest-528"><span class="linenos">528</span></a>            
</span><span id="Warehouse.AcceptBuyRequest-529"><a href="#Warehouse.AcceptBuyRequest-529"><span class="linenos">529</span></a>            <span class="c1"># Wait for either confirmation or denial</span>
</span><span id="Warehouse.AcceptBuyRequest-530"><a href="#Warehouse.AcceptBuyRequest-530"><span class="linenos">530</span></a>            <span class="n">confirm_deny_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ReceiveConfirmationOrDenial</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest-531"><a href="#Warehouse.AcceptBuyRequest-531"><span class="linenos">531</span></a>            
</span><span id="Warehouse.AcceptBuyRequest-532"><a href="#Warehouse.AcceptBuyRequest-532"><span class="linenos">532</span></a>            <span class="c1"># Template that matches BOTH store-confirm AND store-deny</span>
</span><span id="Warehouse.AcceptBuyRequest-533"><a href="#Warehouse.AcceptBuyRequest-533"><span class="linenos">533</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse.AcceptBuyRequest-534"><a href="#Warehouse.AcceptBuyRequest-534"><span class="linenos">534</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest-535"><a href="#Warehouse.AcceptBuyRequest-535"><span class="linenos">535</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest-536"><a href="#Warehouse.AcceptBuyRequest-536"><span class="linenos">536</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest-537"><a href="#Warehouse.AcceptBuyRequest-537"><span class="linenos">537</span></a>            
</span><span id="Warehouse.AcceptBuyRequest-538"><a href="#Warehouse.AcceptBuyRequest-538"><span class="linenos">538</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">confirm_deny_behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest-539"><a href="#Warehouse.AcceptBuyRequest-539"><span class="linenos">539</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AcceptBuyRequest-540"><a href="#Warehouse.AcceptBuyRequest-540"><span class="linenos">540</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; AcceptBuyRequest finished, now waiting for confirmation or denial...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest-541"><a href="#Warehouse.AcceptBuyRequest-541"><span class="linenos">541</span></a>            
</span><span id="Warehouse.AcceptBuyRequest-542"><a href="#Warehouse.AcceptBuyRequest-542"><span class="linenos">542</span></a>            <span class="c1"># Aguardar a confirmao ser recebida antes de terminar</span>
</span><span id="Warehouse.AcceptBuyRequest-543"><a href="#Warehouse.AcceptBuyRequest-543"><span class="linenos">543</span></a>            <span class="c1"># await confirm_deny_behav.join()</span>
</span></pre></div>


            <div class="docstring"><p>Behaviour that sends proposal acceptance to store (FIPA propose).</p>

<p>This behaviour implements the proposal submission in the FIPA Contract Net
Protocol where the warehouse, acting as a participant, sends its proposal
to fulfill the store's request. It then sets up to receive the store's
decision (accept-proposal or reject-proposal).</p>

<p>FIPA Protocol Phase: <strong>Proposal Submission - Participant Role</strong>
    - Role: Participant (Warehouse proposing to Store)
    - Sends: warehouse-accept (FIPA propose)
    - Purpose: "I can fulfill your request"
    - Next Phase: Await store's award or rejection decision</p>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>request_id (int):</strong>  Unique identifier for this request.</li>
<li><strong>quant (int):</strong>  Quantity of product being proposed.</li>
<li><strong>product (str):</strong>  Name of product being proposed.</li>
<li><strong>sender (str):</strong>  Store JID that initiated the request.</li>
</ul>

<p>Message Format (warehouse-accept):
    Metadata:
        - performative: "warehouse-accept" (FIPA propose)
        - warehouse_id: This warehouse's JID
        - store_id: Requesting store's JID
        - node_id: Warehouse's graph location
        - request_id: Original request identifier
    Body:
        - Format: "{quantity} {product}"
        - Example: "50 electronics"</p>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Send Proposal</strong>: Construct and send warehouse-accept message</li>
  <li><strong>Setup Listener</strong>: Create ReceiveConfirmationOrDenial behaviour</li>
  <li><strong>Configure Template</strong>: Filter for this specific store and request</li>
  <li><strong>Register Behaviour</strong>: Add listener with template to agent</li>
  <li><strong>Non-blocking</strong>: Return immediately (don't wait for response)</li>
  </ol>
</blockquote>

<h6 id="template-configuration">Template Configuration:</h6>

<blockquote>
  <p>Filters messages to match:</p>
  
  <ul>
  <li>warehouse_id: This warehouse</li>
  <li>store_id: Specific store that made request</li>
  <li>request_id: This specific request</li>
  </ul>
  
  <p>Accepts both performatives:</p>
  
  <ul>
  <li>store-confirm (FIPA accept-proposal)</li>
  <li>store-deny (FIPA reject-proposal)</li>
  </ul>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
<pre><code>Input: Store request for "50 electronics"
Proposal Sent: warehouse-accept with body "50 electronics"
Listener Setup: ReceiveConfirmationOrDenial waiting for:
    - store-confirm (unlock -&gt; pending delivery) OR
    - store-deny (unlock -&gt; available stock)
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Stock remains locked until ReceiveConfirmationOrDenial processes
  the store's decision or times out.</p>
</blockquote>
</div>


                            <div id="Warehouse.AcceptBuyRequest.__init__" class="classattr">
                                        <input id="Warehouse.AcceptBuyRequest.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Warehouse.AcceptBuyRequest</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span></span>)</span>

                <label class="view-source-button" for="Warehouse.AcceptBuyRequest.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.AcceptBuyRequest.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.AcceptBuyRequest.__init__-435"><a href="#Warehouse.AcceptBuyRequest.__init__-435"><span class="linenos">435</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-436"><a href="#Warehouse.AcceptBuyRequest.__init__-436"><span class="linenos">436</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-437"><a href="#Warehouse.AcceptBuyRequest.__init__-437"><span class="linenos">437</span></a><span class="sd">            Initialize the AcceptBuyRequest behaviour.</span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-438"><a href="#Warehouse.AcceptBuyRequest.__init__-438"><span class="linenos">438</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-439"><a href="#Warehouse.AcceptBuyRequest.__init__-439"><span class="linenos">439</span></a><span class="sd">            Args:</span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-440"><a href="#Warehouse.AcceptBuyRequest.__init__-440"><span class="linenos">440</span></a><span class="sd">                msg (Message): The store-buy request message to accept.</span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-441"><a href="#Warehouse.AcceptBuyRequest.__init__-441"><span class="linenos">441</span></a><span class="sd">                    Contains request_id in metadata and &quot;{quantity} {product}&quot; in body.</span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-442"><a href="#Warehouse.AcceptBuyRequest.__init__-442"><span class="linenos">442</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-443"><a href="#Warehouse.AcceptBuyRequest.__init__-443"><span class="linenos">443</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-444"><a href="#Warehouse.AcceptBuyRequest.__init__-444"><span class="linenos">444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-445"><a href="#Warehouse.AcceptBuyRequest.__init__-445"><span class="linenos">445</span></a>            <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-446"><a href="#Warehouse.AcceptBuyRequest.__init__-446"><span class="linenos">446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-447"><a href="#Warehouse.AcceptBuyRequest.__init__-447"><span class="linenos">447</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.AcceptBuyRequest.__init__-448"><a href="#Warehouse.AcceptBuyRequest.__init__-448"><span class="linenos">448</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the AcceptBuyRequest behaviour.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>msg (Message):</strong>  The store-buy request message to accept.
Contains request_id in metadata and "{quantity} {product}" in body.</li>
</ul>
</div>


                            </div>
                            <div id="Warehouse.AcceptBuyRequest.request_id" class="classattr">
                                <div class="attr variable">
            <span class="name">request_id</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.AcceptBuyRequest.request_id"></a>
    
    

                            </div>
                            <div id="Warehouse.AcceptBuyRequest.quant" class="classattr">
                                <div class="attr variable">
            <span class="name">quant</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.AcceptBuyRequest.quant"></a>
    
    

                            </div>
                            <div id="Warehouse.AcceptBuyRequest.product" class="classattr">
                                <div class="attr variable">
            <span class="name">product</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.AcceptBuyRequest.product"></a>
    
    

                            </div>
                            <div id="Warehouse.AcceptBuyRequest.sender" class="classattr">
                                <div class="attr variable">
            <span class="name">sender</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.AcceptBuyRequest.sender"></a>
    
    

                            </div>
                            <div id="Warehouse.AcceptBuyRequest.run" class="classattr">
                                        <input id="Warehouse.AcceptBuyRequest.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.AcceptBuyRequest.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.AcceptBuyRequest.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.AcceptBuyRequest.run-450"><a href="#Warehouse.AcceptBuyRequest.run-450"><span class="linenos">450</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.AcceptBuyRequest.run-451"><a href="#Warehouse.AcceptBuyRequest.run-451"><span class="linenos">451</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest.run-452"><a href="#Warehouse.AcceptBuyRequest.run-452"><span class="linenos">452</span></a><span class="sd">            Execute the proposal sending and confirmation listener setup.</span>
</span><span id="Warehouse.AcceptBuyRequest.run-453"><a href="#Warehouse.AcceptBuyRequest.run-453"><span class="linenos">453</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest.run-454"><a href="#Warehouse.AcceptBuyRequest.run-454"><span class="linenos">454</span></a><span class="sd">            This method sends the warehouse-accept (FIPA propose) message to the store</span>
</span><span id="Warehouse.AcceptBuyRequest.run-455"><a href="#Warehouse.AcceptBuyRequest.run-455"><span class="linenos">455</span></a><span class="sd">            and immediately sets up a listener behaviour to await the store&#39;s decision.</span>
</span><span id="Warehouse.AcceptBuyRequest.run-456"><a href="#Warehouse.AcceptBuyRequest.run-456"><span class="linenos">456</span></a><span class="sd">            The method returns quickly without blocking, allowing the warehouse to</span>
</span><span id="Warehouse.AcceptBuyRequest.run-457"><a href="#Warehouse.AcceptBuyRequest.run-457"><span class="linenos">457</span></a><span class="sd">            continue processing other requests concurrently.</span>
</span><span id="Warehouse.AcceptBuyRequest.run-458"><a href="#Warehouse.AcceptBuyRequest.run-458"><span class="linenos">458</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest.run-459"><a href="#Warehouse.AcceptBuyRequest.run-459"><span class="linenos">459</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Warehouse.AcceptBuyRequest.run-460"><a href="#Warehouse.AcceptBuyRequest.run-460"><span class="linenos">460</span></a><span class="sd">                - **Phase**: Proposal Submission</span>
</span><span id="Warehouse.AcceptBuyRequest.run-461"><a href="#Warehouse.AcceptBuyRequest.run-461"><span class="linenos">461</span></a><span class="sd">                - **Performative**: warehouse-accept (FIPA propose)</span>
</span><span id="Warehouse.AcceptBuyRequest.run-462"><a href="#Warehouse.AcceptBuyRequest.run-462"><span class="linenos">462</span></a><span class="sd">                - **Content**: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest.run-463"><a href="#Warehouse.AcceptBuyRequest.run-463"><span class="linenos">463</span></a><span class="sd">                - **Receiver**: Store that sent the CFP</span>
</span><span id="Warehouse.AcceptBuyRequest.run-464"><a href="#Warehouse.AcceptBuyRequest.run-464"><span class="linenos">464</span></a><span class="sd">                - **Next Step**: Await store&#39;s accept-proposal or reject-proposal</span>
</span><span id="Warehouse.AcceptBuyRequest.run-465"><a href="#Warehouse.AcceptBuyRequest.run-465"><span class="linenos">465</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest.run-466"><a href="#Warehouse.AcceptBuyRequest.run-466"><span class="linenos">466</span></a><span class="sd">            Workflow:</span>
</span><span id="Warehouse.AcceptBuyRequest.run-467"><a href="#Warehouse.AcceptBuyRequest.run-467"><span class="linenos">467</span></a><span class="sd">                1. **Log Acceptance** (verbose): Print proposal details</span>
</span><span id="Warehouse.AcceptBuyRequest.run-468"><a href="#Warehouse.AcceptBuyRequest.run-468"><span class="linenos">468</span></a><span class="sd">                2. **Construct Message**: Create warehouse-accept with all metadata</span>
</span><span id="Warehouse.AcceptBuyRequest.run-469"><a href="#Warehouse.AcceptBuyRequest.run-469"><span class="linenos">469</span></a><span class="sd">                3. **Send Proposal**: Transmit to requesting store</span>
</span><span id="Warehouse.AcceptBuyRequest.run-470"><a href="#Warehouse.AcceptBuyRequest.run-470"><span class="linenos">470</span></a><span class="sd">                4. **Create Listener**: Initialize ReceiveConfirmationOrDenial behaviour</span>
</span><span id="Warehouse.AcceptBuyRequest.run-471"><a href="#Warehouse.AcceptBuyRequest.run-471"><span class="linenos">471</span></a><span class="sd">                5. **Setup Template**: Configure filter for this specific negotiation</span>
</span><span id="Warehouse.AcceptBuyRequest.run-472"><a href="#Warehouse.AcceptBuyRequest.run-472"><span class="linenos">472</span></a><span class="sd">                6. **Register Listener**: Add behaviour with template to agent</span>
</span><span id="Warehouse.AcceptBuyRequest.run-473"><a href="#Warehouse.AcceptBuyRequest.run-473"><span class="linenos">473</span></a><span class="sd">                7. **Return**: Don&#39;t block (listener runs independently)</span>
</span><span id="Warehouse.AcceptBuyRequest.run-474"><a href="#Warehouse.AcceptBuyRequest.run-474"><span class="linenos">474</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest.run-475"><a href="#Warehouse.AcceptBuyRequest.run-475"><span class="linenos">475</span></a><span class="sd">            Template Filtering:</span>
</span><span id="Warehouse.AcceptBuyRequest.run-476"><a href="#Warehouse.AcceptBuyRequest.run-476"><span class="linenos">476</span></a><span class="sd">                The template ensures the listener only receives messages for THIS</span>
</span><span id="Warehouse.AcceptBuyRequest.run-477"><a href="#Warehouse.AcceptBuyRequest.run-477"><span class="linenos">477</span></a><span class="sd">                specific negotiation by matching:</span>
</span><span id="Warehouse.AcceptBuyRequest.run-478"><a href="#Warehouse.AcceptBuyRequest.run-478"><span class="linenos">478</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="Warehouse.AcceptBuyRequest.run-479"><a href="#Warehouse.AcceptBuyRequest.run-479"><span class="linenos">479</span></a><span class="sd">                - store_id: The specific store&#39;s JID</span>
</span><span id="Warehouse.AcceptBuyRequest.run-480"><a href="#Warehouse.AcceptBuyRequest.run-480"><span class="linenos">480</span></a><span class="sd">                - request_id: This specific request&#39;s ID</span>
</span><span id="Warehouse.AcceptBuyRequest.run-481"><a href="#Warehouse.AcceptBuyRequest.run-481"><span class="linenos">481</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest.run-482"><a href="#Warehouse.AcceptBuyRequest.run-482"><span class="linenos">482</span></a><span class="sd">            Non-Blocking Design:</span>
</span><span id="Warehouse.AcceptBuyRequest.run-483"><a href="#Warehouse.AcceptBuyRequest.run-483"><span class="linenos">483</span></a><span class="sd">                The commented-out `await confirm_deny_behav.join()` demonstrates</span>
</span><span id="Warehouse.AcceptBuyRequest.run-484"><a href="#Warehouse.AcceptBuyRequest.run-484"><span class="linenos">484</span></a><span class="sd">                that we intentionally DON&#39;T wait for confirmation here. This allows</span>
</span><span id="Warehouse.AcceptBuyRequest.run-485"><a href="#Warehouse.AcceptBuyRequest.run-485"><span class="linenos">485</span></a><span class="sd">                the warehouse to accept multiple store requests concurrently.</span>
</span><span id="Warehouse.AcceptBuyRequest.run-486"><a href="#Warehouse.AcceptBuyRequest.run-486"><span class="linenos">486</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest.run-487"><a href="#Warehouse.AcceptBuyRequest.run-487"><span class="linenos">487</span></a><span class="sd">            Side Effects:</span>
</span><span id="Warehouse.AcceptBuyRequest.run-488"><a href="#Warehouse.AcceptBuyRequest.run-488"><span class="linenos">488</span></a><span class="sd">                - Sends SPADE message to store</span>
</span><span id="Warehouse.AcceptBuyRequest.run-489"><a href="#Warehouse.AcceptBuyRequest.run-489"><span class="linenos">489</span></a><span class="sd">                - Adds ReceiveConfirmationOrDenial behaviour to agent</span>
</span><span id="Warehouse.AcceptBuyRequest.run-490"><a href="#Warehouse.AcceptBuyRequest.run-490"><span class="linenos">490</span></a><span class="sd">                - Prints debug information if verbose enabled</span>
</span><span id="Warehouse.AcceptBuyRequest.run-491"><a href="#Warehouse.AcceptBuyRequest.run-491"><span class="linenos">491</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest.run-492"><a href="#Warehouse.AcceptBuyRequest.run-492"><span class="linenos">492</span></a><span class="sd">            Returns:</span>
</span><span id="Warehouse.AcceptBuyRequest.run-493"><a href="#Warehouse.AcceptBuyRequest.run-493"><span class="linenos">493</span></a><span class="sd">                None. Completes immediately after setting up the listener.</span>
</span><span id="Warehouse.AcceptBuyRequest.run-494"><a href="#Warehouse.AcceptBuyRequest.run-494"><span class="linenos">494</span></a><span class="sd">            </span>
</span><span id="Warehouse.AcceptBuyRequest.run-495"><a href="#Warehouse.AcceptBuyRequest.run-495"><span class="linenos">495</span></a><span class="sd">            Example:</span>
</span><span id="Warehouse.AcceptBuyRequest.run-496"><a href="#Warehouse.AcceptBuyRequest.run-496"><span class="linenos">496</span></a><span class="sd">                ```</span>
</span><span id="Warehouse.AcceptBuyRequest.run-497"><a href="#Warehouse.AcceptBuyRequest.run-497"><span class="linenos">497</span></a><span class="sd">                Input: Request for &quot;50 electronics&quot; from store1</span>
</span><span id="Warehouse.AcceptBuyRequest.run-498"><a href="#Warehouse.AcceptBuyRequest.run-498"><span class="linenos">498</span></a><span class="sd">                Actions:</span>
</span><span id="Warehouse.AcceptBuyRequest.run-499"><a href="#Warehouse.AcceptBuyRequest.run-499"><span class="linenos">499</span></a><span class="sd">                    1. Send warehouse-accept to store1</span>
</span><span id="Warehouse.AcceptBuyRequest.run-500"><a href="#Warehouse.AcceptBuyRequest.run-500"><span class="linenos">500</span></a><span class="sd">                    2. Setup listener with template matching:</span>
</span><span id="Warehouse.AcceptBuyRequest.run-501"><a href="#Warehouse.AcceptBuyRequest.run-501"><span class="linenos">501</span></a><span class="sd">                       - warehouse_id=warehouse1@localhost</span>
</span><span id="Warehouse.AcceptBuyRequest.run-502"><a href="#Warehouse.AcceptBuyRequest.run-502"><span class="linenos">502</span></a><span class="sd">                       - store_id=store1@localhost</span>
</span><span id="Warehouse.AcceptBuyRequest.run-503"><a href="#Warehouse.AcceptBuyRequest.run-503"><span class="linenos">503</span></a><span class="sd">                       - request_id=1001000000</span>
</span><span id="Warehouse.AcceptBuyRequest.run-504"><a href="#Warehouse.AcceptBuyRequest.run-504"><span class="linenos">504</span></a><span class="sd">                    3. Return (warehouse ready for next request)</span>
</span><span id="Warehouse.AcceptBuyRequest.run-505"><a href="#Warehouse.AcceptBuyRequest.run-505"><span class="linenos">505</span></a><span class="sd">                Listener waits independently for store&#39;s decision</span>
</span><span id="Warehouse.AcceptBuyRequest.run-506"><a href="#Warehouse.AcceptBuyRequest.run-506"><span class="linenos">506</span></a><span class="sd">                ```</span>
</span><span id="Warehouse.AcceptBuyRequest.run-507"><a href="#Warehouse.AcceptBuyRequest.run-507"><span class="linenos">507</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest.run-508"><a href="#Warehouse.AcceptBuyRequest.run-508"><span class="linenos">508</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.AcceptBuyRequest.run-509"><a href="#Warehouse.AcceptBuyRequest.run-509"><span class="linenos">509</span></a>            
</span><span id="Warehouse.AcceptBuyRequest.run-510"><a href="#Warehouse.AcceptBuyRequest.run-510"><span class="linenos">510</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AcceptBuyRequest.run-511"><a href="#Warehouse.AcceptBuyRequest.run-511"><span class="linenos">511</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="Warehouse.AcceptBuyRequest.run-512"><a href="#Warehouse.AcceptBuyRequest.run-512"><span class="linenos">512</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Accepted a request from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">: &quot;</span>
</span><span id="Warehouse.AcceptBuyRequest.run-513"><a href="#Warehouse.AcceptBuyRequest.run-513"><span class="linenos">513</span></a>                    <span class="sa">f</span><span class="s2">&quot;id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.AcceptBuyRequest.run-514"><a href="#Warehouse.AcceptBuyRequest.run-514"><span class="linenos">514</span></a>                    <span class="sa">f</span><span class="s2">&quot;quant=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.AcceptBuyRequest.run-515"><a href="#Warehouse.AcceptBuyRequest.run-515"><span class="linenos">515</span></a>                    <span class="sa">f</span><span class="s2">&quot;product=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest.run-516"><a href="#Warehouse.AcceptBuyRequest.run-516"><span class="linenos">516</span></a>                <span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest.run-517"><a href="#Warehouse.AcceptBuyRequest.run-517"><span class="linenos">517</span></a>            
</span><span id="Warehouse.AcceptBuyRequest.run-518"><a href="#Warehouse.AcceptBuyRequest.run-518"><span class="linenos">518</span></a>            
</span><span id="Warehouse.AcceptBuyRequest.run-519"><a href="#Warehouse.AcceptBuyRequest.run-519"><span class="linenos">519</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest.run-520"><a href="#Warehouse.AcceptBuyRequest.run-520"><span class="linenos">520</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-accept&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest.run-521"><a href="#Warehouse.AcceptBuyRequest.run-521"><span class="linenos">521</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest.run-522"><a href="#Warehouse.AcceptBuyRequest.run-522"><span class="linenos">522</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest.run-523"><a href="#Warehouse.AcceptBuyRequest.run-523"><span class="linenos">523</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest.run-524"><a href="#Warehouse.AcceptBuyRequest.run-524"><span class="linenos">524</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest.run-525"><a href="#Warehouse.AcceptBuyRequest.run-525"><span class="linenos">525</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.AcceptBuyRequest.run-526"><a href="#Warehouse.AcceptBuyRequest.run-526"><span class="linenos">526</span></a>            
</span><span id="Warehouse.AcceptBuyRequest.run-527"><a href="#Warehouse.AcceptBuyRequest.run-527"><span class="linenos">527</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest.run-528"><a href="#Warehouse.AcceptBuyRequest.run-528"><span class="linenos">528</span></a>            
</span><span id="Warehouse.AcceptBuyRequest.run-529"><a href="#Warehouse.AcceptBuyRequest.run-529"><span class="linenos">529</span></a>            <span class="c1"># Wait for either confirmation or denial</span>
</span><span id="Warehouse.AcceptBuyRequest.run-530"><a href="#Warehouse.AcceptBuyRequest.run-530"><span class="linenos">530</span></a>            <span class="n">confirm_deny_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ReceiveConfirmationOrDenial</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest.run-531"><a href="#Warehouse.AcceptBuyRequest.run-531"><span class="linenos">531</span></a>            
</span><span id="Warehouse.AcceptBuyRequest.run-532"><a href="#Warehouse.AcceptBuyRequest.run-532"><span class="linenos">532</span></a>            <span class="c1"># Template that matches BOTH store-confirm AND store-deny</span>
</span><span id="Warehouse.AcceptBuyRequest.run-533"><a href="#Warehouse.AcceptBuyRequest.run-533"><span class="linenos">533</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse.AcceptBuyRequest.run-534"><a href="#Warehouse.AcceptBuyRequest.run-534"><span class="linenos">534</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest.run-535"><a href="#Warehouse.AcceptBuyRequest.run-535"><span class="linenos">535</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest.run-536"><a href="#Warehouse.AcceptBuyRequest.run-536"><span class="linenos">536</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.AcceptBuyRequest.run-537"><a href="#Warehouse.AcceptBuyRequest.run-537"><span class="linenos">537</span></a>            
</span><span id="Warehouse.AcceptBuyRequest.run-538"><a href="#Warehouse.AcceptBuyRequest.run-538"><span class="linenos">538</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">confirm_deny_behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest.run-539"><a href="#Warehouse.AcceptBuyRequest.run-539"><span class="linenos">539</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AcceptBuyRequest.run-540"><a href="#Warehouse.AcceptBuyRequest.run-540"><span class="linenos">540</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; AcceptBuyRequest finished, now waiting for confirmation or denial...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AcceptBuyRequest.run-541"><a href="#Warehouse.AcceptBuyRequest.run-541"><span class="linenos">541</span></a>            
</span><span id="Warehouse.AcceptBuyRequest.run-542"><a href="#Warehouse.AcceptBuyRequest.run-542"><span class="linenos">542</span></a>            <span class="c1"># Aguardar a confirmao ser recebida antes de terminar</span>
</span><span id="Warehouse.AcceptBuyRequest.run-543"><a href="#Warehouse.AcceptBuyRequest.run-543"><span class="linenos">543</span></a>            <span class="c1"># await confirm_deny_behav.join()</span>
</span></pre></div>


            <div class="docstring"><p>Execute the proposal sending and confirmation listener setup.</p>

<p>This method sends the warehouse-accept (FIPA propose) message to the store
and immediately sets up a listener behaviour to await the store's decision.
The method returns quickly without blocking, allowing the warehouse to
continue processing other requests concurrently.</p>

<h6 id="fipa-protocol-implementation">FIPA Protocol Implementation:</h6>

<blockquote>
  <ul>
  <li><strong>Phase</strong>: Proposal Submission</li>
  <li><strong>Performative</strong>: warehouse-accept (FIPA propose)</li>
  <li><strong>Content</strong>: "{quantity} {product}"</li>
  <li><strong>Receiver</strong>: Store that sent the CFP</li>
  <li><strong>Next Step</strong>: Await store's accept-proposal or reject-proposal</li>
  </ul>
</blockquote>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Log Acceptance</strong> (verbose): Print proposal details</li>
  <li><strong>Construct Message</strong>: Create warehouse-accept with all metadata</li>
  <li><strong>Send Proposal</strong>: Transmit to requesting store</li>
  <li><strong>Create Listener</strong>: Initialize ReceiveConfirmationOrDenial behaviour</li>
  <li><strong>Setup Template</strong>: Configure filter for this specific negotiation</li>
  <li><strong>Register Listener</strong>: Add behaviour with template to agent</li>
  <li><strong>Return</strong>: Don't block (listener runs independently)</li>
  </ol>
</blockquote>

<h6 id="template-filtering">Template Filtering:</h6>

<blockquote>
  <p>The template ensures the listener only receives messages for THIS
  specific negotiation by matching:</p>
  
  <ul>
  <li>warehouse_id: This warehouse's JID</li>
  <li>store_id: The specific store's JID</li>
  <li>request_id: This specific request's ID</li>
  </ul>
</blockquote>

<p>Non-Blocking Design:
    The commented-out <code>await confirm_deny_behav.join()</code> demonstrates
    that we intentionally DON'T wait for confirmation here. This allows
    the warehouse to accept multiple store requests concurrently.</p>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Sends SPADE message to store</li>
  <li>Adds ReceiveConfirmationOrDenial behaviour to agent</li>
  <li>Prints debug information if verbose enabled</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Completes immediately after setting up the listener.</p>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
<pre><code>Input: Request for "50 electronics" from store1
Actions:
    1. Send warehouse-accept to store1
    2. Setup listener with template matching:
       - warehouse_id=warehouse1@localhost
       - store_id=store1@localhost
       - request_id=1001000000
    3. Return (warehouse ready for next request)
Listener waits independently for store's decision
</code></pre>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Warehouse.RejectBuyRequest">
                            <input id="Warehouse.RejectBuyRequest-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.RejectBuyRequest</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Warehouse.RejectBuyRequest-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.RejectBuyRequest"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.RejectBuyRequest-545"><a href="#Warehouse.RejectBuyRequest-545"><span class="linenos">545</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">RejectBuyRequest</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.RejectBuyRequest-546"><a href="#Warehouse.RejectBuyRequest-546"><span class="linenos">546</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-547"><a href="#Warehouse.RejectBuyRequest-547"><span class="linenos">547</span></a><span class="sd">        Behaviour that sends proposal refusal to store (FIPA refuse).</span>
</span><span id="Warehouse.RejectBuyRequest-548"><a href="#Warehouse.RejectBuyRequest-548"><span class="linenos">548</span></a><span class="sd">        </span>
</span><span id="Warehouse.RejectBuyRequest-549"><a href="#Warehouse.RejectBuyRequest-549"><span class="linenos">549</span></a><span class="sd">        This behaviour implements the refusal response in the FIPA Contract Net Protocol</span>
</span><span id="Warehouse.RejectBuyRequest-550"><a href="#Warehouse.RejectBuyRequest-550"><span class="linenos">550</span></a><span class="sd">        where the warehouse, acting as a participant, declines to fulfill the store&#39;s</span>
</span><span id="Warehouse.RejectBuyRequest-551"><a href="#Warehouse.RejectBuyRequest-551"><span class="linenos">551</span></a><span class="sd">        request due to insufficient inventory or other constraints.</span>
</span><span id="Warehouse.RejectBuyRequest-552"><a href="#Warehouse.RejectBuyRequest-552"><span class="linenos">552</span></a><span class="sd">        </span>
</span><span id="Warehouse.RejectBuyRequest-553"><a href="#Warehouse.RejectBuyRequest-553"><span class="linenos">553</span></a><span class="sd">        FIPA Protocol Phase: **Proposal Phase - Refusal**</span>
</span><span id="Warehouse.RejectBuyRequest-554"><a href="#Warehouse.RejectBuyRequest-554"><span class="linenos">554</span></a><span class="sd">            - Role: Participant (Warehouse declining Store&#39;s CFP)</span>
</span><span id="Warehouse.RejectBuyRequest-555"><a href="#Warehouse.RejectBuyRequest-555"><span class="linenos">555</span></a><span class="sd">            - Sends: warehouse-reject (FIPA refuse)</span>
</span><span id="Warehouse.RejectBuyRequest-556"><a href="#Warehouse.RejectBuyRequest-556"><span class="linenos">556</span></a><span class="sd">            - Purpose: &quot;I cannot fulfill your request&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-557"><a href="#Warehouse.RejectBuyRequest-557"><span class="linenos">557</span></a><span class="sd">            - Reason: Typically &quot;insufficient_stock&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-558"><a href="#Warehouse.RejectBuyRequest-558"><span class="linenos">558</span></a><span class="sd">            - Result: Store will try other warehouses</span>
</span><span id="Warehouse.RejectBuyRequest-559"><a href="#Warehouse.RejectBuyRequest-559"><span class="linenos">559</span></a><span class="sd">        </span>
</span><span id="Warehouse.RejectBuyRequest-560"><a href="#Warehouse.RejectBuyRequest-560"><span class="linenos">560</span></a><span class="sd">        Attributes:</span>
</span><span id="Warehouse.RejectBuyRequest-561"><a href="#Warehouse.RejectBuyRequest-561"><span class="linenos">561</span></a><span class="sd">            request_id (int): Unique identifier for this request.</span>
</span><span id="Warehouse.RejectBuyRequest-562"><a href="#Warehouse.RejectBuyRequest-562"><span class="linenos">562</span></a><span class="sd">            quant (int): Requested quantity that cannot be fulfilled.</span>
</span><span id="Warehouse.RejectBuyRequest-563"><a href="#Warehouse.RejectBuyRequest-563"><span class="linenos">563</span></a><span class="sd">            product (str): Requested product that is unavailable/insufficient.</span>
</span><span id="Warehouse.RejectBuyRequest-564"><a href="#Warehouse.RejectBuyRequest-564"><span class="linenos">564</span></a><span class="sd">            sender (str): Store JID that initiated the request.</span>
</span><span id="Warehouse.RejectBuyRequest-565"><a href="#Warehouse.RejectBuyRequest-565"><span class="linenos">565</span></a><span class="sd">            reason (str): Rejection reason (default: &quot;insufficient_stock&quot;).</span>
</span><span id="Warehouse.RejectBuyRequest-566"><a href="#Warehouse.RejectBuyRequest-566"><span class="linenos">566</span></a><span class="sd">        </span>
</span><span id="Warehouse.RejectBuyRequest-567"><a href="#Warehouse.RejectBuyRequest-567"><span class="linenos">567</span></a><span class="sd">        Message Format (warehouse-reject):</span>
</span><span id="Warehouse.RejectBuyRequest-568"><a href="#Warehouse.RejectBuyRequest-568"><span class="linenos">568</span></a><span class="sd">            Metadata:</span>
</span><span id="Warehouse.RejectBuyRequest-569"><a href="#Warehouse.RejectBuyRequest-569"><span class="linenos">569</span></a><span class="sd">                - performative: &quot;warehouse-reject&quot; (FIPA refuse)</span>
</span><span id="Warehouse.RejectBuyRequest-570"><a href="#Warehouse.RejectBuyRequest-570"><span class="linenos">570</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="Warehouse.RejectBuyRequest-571"><a href="#Warehouse.RejectBuyRequest-571"><span class="linenos">571</span></a><span class="sd">                - store_id: Requesting store&#39;s JID</span>
</span><span id="Warehouse.RejectBuyRequest-572"><a href="#Warehouse.RejectBuyRequest-572"><span class="linenos">572</span></a><span class="sd">                - node_id: Warehouse&#39;s graph location</span>
</span><span id="Warehouse.RejectBuyRequest-573"><a href="#Warehouse.RejectBuyRequest-573"><span class="linenos">573</span></a><span class="sd">                - request_id: Original request identifier</span>
</span><span id="Warehouse.RejectBuyRequest-574"><a href="#Warehouse.RejectBuyRequest-574"><span class="linenos">574</span></a><span class="sd">            Body:</span>
</span><span id="Warehouse.RejectBuyRequest-575"><a href="#Warehouse.RejectBuyRequest-575"><span class="linenos">575</span></a><span class="sd">                - Format: &quot;{quantity} {product} {reason}&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-576"><a href="#Warehouse.RejectBuyRequest-576"><span class="linenos">576</span></a><span class="sd">                - Example: &quot;50 electronics insufficient_stock&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-577"><a href="#Warehouse.RejectBuyRequest-577"><span class="linenos">577</span></a><span class="sd">        </span>
</span><span id="Warehouse.RejectBuyRequest-578"><a href="#Warehouse.RejectBuyRequest-578"><span class="linenos">578</span></a><span class="sd">        Common Rejection Reasons:</span>
</span><span id="Warehouse.RejectBuyRequest-579"><a href="#Warehouse.RejectBuyRequest-579"><span class="linenos">579</span></a><span class="sd">            - &quot;insufficient_stock&quot;: Not enough product available</span>
</span><span id="Warehouse.RejectBuyRequest-580"><a href="#Warehouse.RejectBuyRequest-580"><span class="linenos">580</span></a><span class="sd">            - &quot;product_unavailable&quot;: Product not carried by this warehouse</span>
</span><span id="Warehouse.RejectBuyRequest-581"><a href="#Warehouse.RejectBuyRequest-581"><span class="linenos">581</span></a><span class="sd">            - &quot;capacity_exceeded&quot;: Order too large for capacity constraints</span>
</span><span id="Warehouse.RejectBuyRequest-582"><a href="#Warehouse.RejectBuyRequest-582"><span class="linenos">582</span></a><span class="sd">        </span>
</span><span id="Warehouse.RejectBuyRequest-583"><a href="#Warehouse.RejectBuyRequest-583"><span class="linenos">583</span></a><span class="sd">        Example:</span>
</span><span id="Warehouse.RejectBuyRequest-584"><a href="#Warehouse.RejectBuyRequest-584"><span class="linenos">584</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.RejectBuyRequest-585"><a href="#Warehouse.RejectBuyRequest-585"><span class="linenos">585</span></a><span class="sd">            Request: &quot;100 electronics&quot; (only 50 available)</span>
</span><span id="Warehouse.RejectBuyRequest-586"><a href="#Warehouse.RejectBuyRequest-586"><span class="linenos">586</span></a><span class="sd">            Decision: REJECT</span>
</span><span id="Warehouse.RejectBuyRequest-587"><a href="#Warehouse.RejectBuyRequest-587"><span class="linenos">587</span></a><span class="sd">            Message Sent: warehouse-reject</span>
</span><span id="Warehouse.RejectBuyRequest-588"><a href="#Warehouse.RejectBuyRequest-588"><span class="linenos">588</span></a><span class="sd">                Body: &quot;100 electronics insufficient_stock&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-589"><a href="#Warehouse.RejectBuyRequest-589"><span class="linenos">589</span></a><span class="sd">            Result: Stock unchanged, store tries other warehouses</span>
</span><span id="Warehouse.RejectBuyRequest-590"><a href="#Warehouse.RejectBuyRequest-590"><span class="linenos">590</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.RejectBuyRequest-591"><a href="#Warehouse.RejectBuyRequest-591"><span class="linenos">591</span></a><span class="sd">        </span>
</span><span id="Warehouse.RejectBuyRequest-592"><a href="#Warehouse.RejectBuyRequest-592"><span class="linenos">592</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse.RejectBuyRequest-593"><a href="#Warehouse.RejectBuyRequest-593"><span class="linenos">593</span></a><span class="sd">            Unlike AcceptBuyRequest, this behaviour does NOT set up any listeners</span>
</span><span id="Warehouse.RejectBuyRequest-594"><a href="#Warehouse.RejectBuyRequest-594"><span class="linenos">594</span></a><span class="sd">            because no further interaction is expected after refusal.</span>
</span><span id="Warehouse.RejectBuyRequest-595"><a href="#Warehouse.RejectBuyRequest-595"><span class="linenos">595</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-596"><a href="#Warehouse.RejectBuyRequest-596"><span class="linenos">596</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">reason</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;insufficient_stock&quot;</span><span class="p">):</span>
</span><span id="Warehouse.RejectBuyRequest-597"><a href="#Warehouse.RejectBuyRequest-597"><span class="linenos">597</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-598"><a href="#Warehouse.RejectBuyRequest-598"><span class="linenos">598</span></a><span class="sd">            Initialize the RejectBuyRequest behaviour.</span>
</span><span id="Warehouse.RejectBuyRequest-599"><a href="#Warehouse.RejectBuyRequest-599"><span class="linenos">599</span></a><span class="sd">            </span>
</span><span id="Warehouse.RejectBuyRequest-600"><a href="#Warehouse.RejectBuyRequest-600"><span class="linenos">600</span></a><span class="sd">            Args:</span>
</span><span id="Warehouse.RejectBuyRequest-601"><a href="#Warehouse.RejectBuyRequest-601"><span class="linenos">601</span></a><span class="sd">                msg (Message): The store-buy request message to reject.</span>
</span><span id="Warehouse.RejectBuyRequest-602"><a href="#Warehouse.RejectBuyRequest-602"><span class="linenos">602</span></a><span class="sd">                reason (str, optional): Reason for rejection. Defaults to &quot;insufficient_stock&quot;.</span>
</span><span id="Warehouse.RejectBuyRequest-603"><a href="#Warehouse.RejectBuyRequest-603"><span class="linenos">603</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-604"><a href="#Warehouse.RejectBuyRequest-604"><span class="linenos">604</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.RejectBuyRequest-605"><a href="#Warehouse.RejectBuyRequest-605"><span class="linenos">605</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.RejectBuyRequest-606"><a href="#Warehouse.RejectBuyRequest-606"><span class="linenos">606</span></a>            <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.RejectBuyRequest-607"><a href="#Warehouse.RejectBuyRequest-607"><span class="linenos">607</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.RejectBuyRequest-608"><a href="#Warehouse.RejectBuyRequest-608"><span class="linenos">608</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.RejectBuyRequest-609"><a href="#Warehouse.RejectBuyRequest-609"><span class="linenos">609</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Warehouse.RejectBuyRequest-610"><a href="#Warehouse.RejectBuyRequest-610"><span class="linenos">610</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span>
</span><span id="Warehouse.RejectBuyRequest-611"><a href="#Warehouse.RejectBuyRequest-611"><span class="linenos">611</span></a>        
</span><span id="Warehouse.RejectBuyRequest-612"><a href="#Warehouse.RejectBuyRequest-612"><span class="linenos">612</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.RejectBuyRequest-613"><a href="#Warehouse.RejectBuyRequest-613"><span class="linenos">613</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-614"><a href="#Warehouse.RejectBuyRequest-614"><span class="linenos">614</span></a><span class="sd">            Send warehouse-reject message to requesting store.</span>
</span><span id="Warehouse.RejectBuyRequest-615"><a href="#Warehouse.RejectBuyRequest-615"><span class="linenos">615</span></a><span class="sd">            </span>
</span><span id="Warehouse.RejectBuyRequest-616"><a href="#Warehouse.RejectBuyRequest-616"><span class="linenos">616</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Warehouse.RejectBuyRequest-617"><a href="#Warehouse.RejectBuyRequest-617"><span class="linenos">617</span></a><span class="sd">                - Phase: Proposal Refusal</span>
</span><span id="Warehouse.RejectBuyRequest-618"><a href="#Warehouse.RejectBuyRequest-618"><span class="linenos">618</span></a><span class="sd">                - Performative: warehouse-reject (FIPA refuse)</span>
</span><span id="Warehouse.RejectBuyRequest-619"><a href="#Warehouse.RejectBuyRequest-619"><span class="linenos">619</span></a><span class="sd">                - Direction: Warehouse  Store</span>
</span><span id="Warehouse.RejectBuyRequest-620"><a href="#Warehouse.RejectBuyRequest-620"><span class="linenos">620</span></a><span class="sd">            </span>
</span><span id="Warehouse.RejectBuyRequest-621"><a href="#Warehouse.RejectBuyRequest-621"><span class="linenos">621</span></a><span class="sd">            Workflow:</span>
</span><span id="Warehouse.RejectBuyRequest-622"><a href="#Warehouse.RejectBuyRequest-622"><span class="linenos">622</span></a><span class="sd">                1. **Log Rejection** (verbose): Print rejection details</span>
</span><span id="Warehouse.RejectBuyRequest-623"><a href="#Warehouse.RejectBuyRequest-623"><span class="linenos">623</span></a><span class="sd">                2. **Construct Message**: Create warehouse-reject with metadata</span>
</span><span id="Warehouse.RejectBuyRequest-624"><a href="#Warehouse.RejectBuyRequest-624"><span class="linenos">624</span></a><span class="sd">                3. **Include Reason**: Add rejection reason to message body</span>
</span><span id="Warehouse.RejectBuyRequest-625"><a href="#Warehouse.RejectBuyRequest-625"><span class="linenos">625</span></a><span class="sd">                4. **Send Refusal**: Transmit to requesting store</span>
</span><span id="Warehouse.RejectBuyRequest-626"><a href="#Warehouse.RejectBuyRequest-626"><span class="linenos">626</span></a><span class="sd">                5. **Complete**: No further interaction (one-shot behaviour)</span>
</span><span id="Warehouse.RejectBuyRequest-627"><a href="#Warehouse.RejectBuyRequest-627"><span class="linenos">627</span></a><span class="sd">            </span>
</span><span id="Warehouse.RejectBuyRequest-628"><a href="#Warehouse.RejectBuyRequest-628"><span class="linenos">628</span></a><span class="sd">            Side Effects:</span>
</span><span id="Warehouse.RejectBuyRequest-629"><a href="#Warehouse.RejectBuyRequest-629"><span class="linenos">629</span></a><span class="sd">                - No stock changes (was never locked for insufficient stock)</span>
</span><span id="Warehouse.RejectBuyRequest-630"><a href="#Warehouse.RejectBuyRequest-630"><span class="linenos">630</span></a><span class="sd">                - No listeners created (conversation ends with refusal)</span>
</span><span id="Warehouse.RejectBuyRequest-631"><a href="#Warehouse.RejectBuyRequest-631"><span class="linenos">631</span></a><span class="sd">                - Store receives refusal and tries other warehouses</span>
</span><span id="Warehouse.RejectBuyRequest-632"><a href="#Warehouse.RejectBuyRequest-632"><span class="linenos">632</span></a><span class="sd">                - Prints debug information if verbose enabled</span>
</span><span id="Warehouse.RejectBuyRequest-633"><a href="#Warehouse.RejectBuyRequest-633"><span class="linenos">633</span></a><span class="sd">            </span>
</span><span id="Warehouse.RejectBuyRequest-634"><a href="#Warehouse.RejectBuyRequest-634"><span class="linenos">634</span></a><span class="sd">            Returns:</span>
</span><span id="Warehouse.RejectBuyRequest-635"><a href="#Warehouse.RejectBuyRequest-635"><span class="linenos">635</span></a><span class="sd">                None. Completes immediately after sending message.</span>
</span><span id="Warehouse.RejectBuyRequest-636"><a href="#Warehouse.RejectBuyRequest-636"><span class="linenos">636</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-637"><a href="#Warehouse.RejectBuyRequest-637"><span class="linenos">637</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.RejectBuyRequest-638"><a href="#Warehouse.RejectBuyRequest-638"><span class="linenos">638</span></a>            
</span><span id="Warehouse.RejectBuyRequest-639"><a href="#Warehouse.RejectBuyRequest-639"><span class="linenos">639</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.RejectBuyRequest-640"><a href="#Warehouse.RejectBuyRequest-640"><span class="linenos">640</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="Warehouse.RejectBuyRequest-641"><a href="#Warehouse.RejectBuyRequest-641"><span class="linenos">641</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Rejected request from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">: &quot;</span>
</span><span id="Warehouse.RejectBuyRequest-642"><a href="#Warehouse.RejectBuyRequest-642"><span class="linenos">642</span></a>                    <span class="sa">f</span><span class="s2">&quot;id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.RejectBuyRequest-643"><a href="#Warehouse.RejectBuyRequest-643"><span class="linenos">643</span></a>                    <span class="sa">f</span><span class="s2">&quot;quant=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.RejectBuyRequest-644"><a href="#Warehouse.RejectBuyRequest-644"><span class="linenos">644</span></a>                    <span class="sa">f</span><span class="s2">&quot;product=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.RejectBuyRequest-645"><a href="#Warehouse.RejectBuyRequest-645"><span class="linenos">645</span></a>                    <span class="sa">f</span><span class="s2">&quot;reason=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-646"><a href="#Warehouse.RejectBuyRequest-646"><span class="linenos">646</span></a>                <span class="p">)</span>
</span><span id="Warehouse.RejectBuyRequest-647"><a href="#Warehouse.RejectBuyRequest-647"><span class="linenos">647</span></a>            
</span><span id="Warehouse.RejectBuyRequest-648"><a href="#Warehouse.RejectBuyRequest-648"><span class="linenos">648</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse.RejectBuyRequest-649"><a href="#Warehouse.RejectBuyRequest-649"><span class="linenos">649</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-reject&quot;</span><span class="p">)</span>
</span><span id="Warehouse.RejectBuyRequest-650"><a href="#Warehouse.RejectBuyRequest-650"><span class="linenos">650</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.RejectBuyRequest-651"><a href="#Warehouse.RejectBuyRequest-651"><span class="linenos">651</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">))</span>
</span><span id="Warehouse.RejectBuyRequest-652"><a href="#Warehouse.RejectBuyRequest-652"><span class="linenos">652</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse.RejectBuyRequest-653"><a href="#Warehouse.RejectBuyRequest-653"><span class="linenos">653</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.RejectBuyRequest-654"><a href="#Warehouse.RejectBuyRequest-654"><span class="linenos">654</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.RejectBuyRequest-655"><a href="#Warehouse.RejectBuyRequest-655"><span class="linenos">655</span></a>            
</span><span id="Warehouse.RejectBuyRequest-656"><a href="#Warehouse.RejectBuyRequest-656"><span class="linenos">656</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.RejectBuyRequest-657"><a href="#Warehouse.RejectBuyRequest-657"><span class="linenos">657</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.RejectBuyRequest-658"><a href="#Warehouse.RejectBuyRequest-658"><span class="linenos">658</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; RejectBuyRequest sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>           
</span></pre></div>


            <div class="docstring"><p>Behaviour that sends proposal refusal to store (FIPA refuse).</p>

<p>This behaviour implements the refusal response in the FIPA Contract Net Protocol
where the warehouse, acting as a participant, declines to fulfill the store's
request due to insufficient inventory or other constraints.</p>

<p>FIPA Protocol Phase: <strong>Proposal Phase - Refusal</strong>
    - Role: Participant (Warehouse declining Store's CFP)
    - Sends: warehouse-reject (FIPA refuse)
    - Purpose: "I cannot fulfill your request"
    - Reason: Typically "insufficient_stock"
    - Result: Store will try other warehouses</p>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>request_id (int):</strong>  Unique identifier for this request.</li>
<li><strong>quant (int):</strong>  Requested quantity that cannot be fulfilled.</li>
<li><strong>product (str):</strong>  Requested product that is unavailable/insufficient.</li>
<li><strong>sender (str):</strong>  Store JID that initiated the request.</li>
<li><strong>reason (str):</strong>  Rejection reason (default: "insufficient_stock").</li>
</ul>

<p>Message Format (warehouse-reject):
    Metadata:
        - performative: "warehouse-reject" (FIPA refuse)
        - warehouse_id: This warehouse's JID
        - store_id: Requesting store's JID
        - node_id: Warehouse's graph location
        - request_id: Original request identifier
    Body:
        - Format: "{quantity} {product} {reason}"
        - Example: "50 electronics insufficient_stock"</p>

<h6 id="common-rejection-reasons">Common Rejection Reasons:</h6>

<blockquote>
  <ul>
  <li>"insufficient_stock": Not enough product available</li>
  <li>"product_unavailable": Product not carried by this warehouse</li>
  <li>"capacity_exceeded": Order too large for capacity constraints</li>
  </ul>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
<pre><code>Request: "100 electronics" (only 50 available)
Decision: REJECT
Message Sent: warehouse-reject
    Body: "100 electronics insufficient_stock"
Result: Stock unchanged, store tries other warehouses
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Unlike AcceptBuyRequest, this behaviour does NOT set up any listeners
  because no further interaction is expected after refusal.</p>
</blockquote>
</div>


                            <div id="Warehouse.RejectBuyRequest.__init__" class="classattr">
                                        <input id="Warehouse.RejectBuyRequest.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Warehouse.RejectBuyRequest</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span>, </span><span class="param"><span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;insufficient_stock&#39;</span></span>)</span>

                <label class="view-source-button" for="Warehouse.RejectBuyRequest.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.RejectBuyRequest.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.RejectBuyRequest.__init__-596"><a href="#Warehouse.RejectBuyRequest.__init__-596"><span class="linenos">596</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">reason</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;insufficient_stock&quot;</span><span class="p">):</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-597"><a href="#Warehouse.RejectBuyRequest.__init__-597"><span class="linenos">597</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-598"><a href="#Warehouse.RejectBuyRequest.__init__-598"><span class="linenos">598</span></a><span class="sd">            Initialize the RejectBuyRequest behaviour.</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-599"><a href="#Warehouse.RejectBuyRequest.__init__-599"><span class="linenos">599</span></a><span class="sd">            </span>
</span><span id="Warehouse.RejectBuyRequest.__init__-600"><a href="#Warehouse.RejectBuyRequest.__init__-600"><span class="linenos">600</span></a><span class="sd">            Args:</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-601"><a href="#Warehouse.RejectBuyRequest.__init__-601"><span class="linenos">601</span></a><span class="sd">                msg (Message): The store-buy request message to reject.</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-602"><a href="#Warehouse.RejectBuyRequest.__init__-602"><span class="linenos">602</span></a><span class="sd">                reason (str, optional): Reason for rejection. Defaults to &quot;insufficient_stock&quot;.</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-603"><a href="#Warehouse.RejectBuyRequest.__init__-603"><span class="linenos">603</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-604"><a href="#Warehouse.RejectBuyRequest.__init__-604"><span class="linenos">604</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-605"><a href="#Warehouse.RejectBuyRequest.__init__-605"><span class="linenos">605</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-606"><a href="#Warehouse.RejectBuyRequest.__init__-606"><span class="linenos">606</span></a>            <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-607"><a href="#Warehouse.RejectBuyRequest.__init__-607"><span class="linenos">607</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-608"><a href="#Warehouse.RejectBuyRequest.__init__-608"><span class="linenos">608</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-609"><a href="#Warehouse.RejectBuyRequest.__init__-609"><span class="linenos">609</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Warehouse.RejectBuyRequest.__init__-610"><a href="#Warehouse.RejectBuyRequest.__init__-610"><span class="linenos">610</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the RejectBuyRequest behaviour.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>msg (Message):</strong>  The store-buy request message to reject.</li>
<li><strong>reason (str, optional):</strong>  Reason for rejection. Defaults to "insufficient_stock".</li>
</ul>
</div>


                            </div>
                            <div id="Warehouse.RejectBuyRequest.request_id" class="classattr">
                                <div class="attr variable">
            <span class="name">request_id</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.RejectBuyRequest.request_id"></a>
    
    

                            </div>
                            <div id="Warehouse.RejectBuyRequest.quant" class="classattr">
                                <div class="attr variable">
            <span class="name">quant</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.RejectBuyRequest.quant"></a>
    
    

                            </div>
                            <div id="Warehouse.RejectBuyRequest.product" class="classattr">
                                <div class="attr variable">
            <span class="name">product</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.RejectBuyRequest.product"></a>
    
    

                            </div>
                            <div id="Warehouse.RejectBuyRequest.sender" class="classattr">
                                <div class="attr variable">
            <span class="name">sender</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.RejectBuyRequest.sender"></a>
    
    

                            </div>
                            <div id="Warehouse.RejectBuyRequest.reason" class="classattr">
                                <div class="attr variable">
            <span class="name">reason</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.RejectBuyRequest.reason"></a>
    
    

                            </div>
                            <div id="Warehouse.RejectBuyRequest.run" class="classattr">
                                        <input id="Warehouse.RejectBuyRequest.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.RejectBuyRequest.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.RejectBuyRequest.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.RejectBuyRequest.run-612"><a href="#Warehouse.RejectBuyRequest.run-612"><span class="linenos">612</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.RejectBuyRequest.run-613"><a href="#Warehouse.RejectBuyRequest.run-613"><span class="linenos">613</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.RejectBuyRequest.run-614"><a href="#Warehouse.RejectBuyRequest.run-614"><span class="linenos">614</span></a><span class="sd">            Send warehouse-reject message to requesting store.</span>
</span><span id="Warehouse.RejectBuyRequest.run-615"><a href="#Warehouse.RejectBuyRequest.run-615"><span class="linenos">615</span></a><span class="sd">            </span>
</span><span id="Warehouse.RejectBuyRequest.run-616"><a href="#Warehouse.RejectBuyRequest.run-616"><span class="linenos">616</span></a><span class="sd">            FIPA Protocol Implementation:</span>
</span><span id="Warehouse.RejectBuyRequest.run-617"><a href="#Warehouse.RejectBuyRequest.run-617"><span class="linenos">617</span></a><span class="sd">                - Phase: Proposal Refusal</span>
</span><span id="Warehouse.RejectBuyRequest.run-618"><a href="#Warehouse.RejectBuyRequest.run-618"><span class="linenos">618</span></a><span class="sd">                - Performative: warehouse-reject (FIPA refuse)</span>
</span><span id="Warehouse.RejectBuyRequest.run-619"><a href="#Warehouse.RejectBuyRequest.run-619"><span class="linenos">619</span></a><span class="sd">                - Direction: Warehouse  Store</span>
</span><span id="Warehouse.RejectBuyRequest.run-620"><a href="#Warehouse.RejectBuyRequest.run-620"><span class="linenos">620</span></a><span class="sd">            </span>
</span><span id="Warehouse.RejectBuyRequest.run-621"><a href="#Warehouse.RejectBuyRequest.run-621"><span class="linenos">621</span></a><span class="sd">            Workflow:</span>
</span><span id="Warehouse.RejectBuyRequest.run-622"><a href="#Warehouse.RejectBuyRequest.run-622"><span class="linenos">622</span></a><span class="sd">                1. **Log Rejection** (verbose): Print rejection details</span>
</span><span id="Warehouse.RejectBuyRequest.run-623"><a href="#Warehouse.RejectBuyRequest.run-623"><span class="linenos">623</span></a><span class="sd">                2. **Construct Message**: Create warehouse-reject with metadata</span>
</span><span id="Warehouse.RejectBuyRequest.run-624"><a href="#Warehouse.RejectBuyRequest.run-624"><span class="linenos">624</span></a><span class="sd">                3. **Include Reason**: Add rejection reason to message body</span>
</span><span id="Warehouse.RejectBuyRequest.run-625"><a href="#Warehouse.RejectBuyRequest.run-625"><span class="linenos">625</span></a><span class="sd">                4. **Send Refusal**: Transmit to requesting store</span>
</span><span id="Warehouse.RejectBuyRequest.run-626"><a href="#Warehouse.RejectBuyRequest.run-626"><span class="linenos">626</span></a><span class="sd">                5. **Complete**: No further interaction (one-shot behaviour)</span>
</span><span id="Warehouse.RejectBuyRequest.run-627"><a href="#Warehouse.RejectBuyRequest.run-627"><span class="linenos">627</span></a><span class="sd">            </span>
</span><span id="Warehouse.RejectBuyRequest.run-628"><a href="#Warehouse.RejectBuyRequest.run-628"><span class="linenos">628</span></a><span class="sd">            Side Effects:</span>
</span><span id="Warehouse.RejectBuyRequest.run-629"><a href="#Warehouse.RejectBuyRequest.run-629"><span class="linenos">629</span></a><span class="sd">                - No stock changes (was never locked for insufficient stock)</span>
</span><span id="Warehouse.RejectBuyRequest.run-630"><a href="#Warehouse.RejectBuyRequest.run-630"><span class="linenos">630</span></a><span class="sd">                - No listeners created (conversation ends with refusal)</span>
</span><span id="Warehouse.RejectBuyRequest.run-631"><a href="#Warehouse.RejectBuyRequest.run-631"><span class="linenos">631</span></a><span class="sd">                - Store receives refusal and tries other warehouses</span>
</span><span id="Warehouse.RejectBuyRequest.run-632"><a href="#Warehouse.RejectBuyRequest.run-632"><span class="linenos">632</span></a><span class="sd">                - Prints debug information if verbose enabled</span>
</span><span id="Warehouse.RejectBuyRequest.run-633"><a href="#Warehouse.RejectBuyRequest.run-633"><span class="linenos">633</span></a><span class="sd">            </span>
</span><span id="Warehouse.RejectBuyRequest.run-634"><a href="#Warehouse.RejectBuyRequest.run-634"><span class="linenos">634</span></a><span class="sd">            Returns:</span>
</span><span id="Warehouse.RejectBuyRequest.run-635"><a href="#Warehouse.RejectBuyRequest.run-635"><span class="linenos">635</span></a><span class="sd">                None. Completes immediately after sending message.</span>
</span><span id="Warehouse.RejectBuyRequest.run-636"><a href="#Warehouse.RejectBuyRequest.run-636"><span class="linenos">636</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse.RejectBuyRequest.run-637"><a href="#Warehouse.RejectBuyRequest.run-637"><span class="linenos">637</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.RejectBuyRequest.run-638"><a href="#Warehouse.RejectBuyRequest.run-638"><span class="linenos">638</span></a>            
</span><span id="Warehouse.RejectBuyRequest.run-639"><a href="#Warehouse.RejectBuyRequest.run-639"><span class="linenos">639</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.RejectBuyRequest.run-640"><a href="#Warehouse.RejectBuyRequest.run-640"><span class="linenos">640</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="Warehouse.RejectBuyRequest.run-641"><a href="#Warehouse.RejectBuyRequest.run-641"><span class="linenos">641</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Rejected request from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">: &quot;</span>
</span><span id="Warehouse.RejectBuyRequest.run-642"><a href="#Warehouse.RejectBuyRequest.run-642"><span class="linenos">642</span></a>                    <span class="sa">f</span><span class="s2">&quot;id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.RejectBuyRequest.run-643"><a href="#Warehouse.RejectBuyRequest.run-643"><span class="linenos">643</span></a>                    <span class="sa">f</span><span class="s2">&quot;quant=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.RejectBuyRequest.run-644"><a href="#Warehouse.RejectBuyRequest.run-644"><span class="linenos">644</span></a>                    <span class="sa">f</span><span class="s2">&quot;product=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.RejectBuyRequest.run-645"><a href="#Warehouse.RejectBuyRequest.run-645"><span class="linenos">645</span></a>                    <span class="sa">f</span><span class="s2">&quot;reason=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.RejectBuyRequest.run-646"><a href="#Warehouse.RejectBuyRequest.run-646"><span class="linenos">646</span></a>                <span class="p">)</span>
</span><span id="Warehouse.RejectBuyRequest.run-647"><a href="#Warehouse.RejectBuyRequest.run-647"><span class="linenos">647</span></a>            
</span><span id="Warehouse.RejectBuyRequest.run-648"><a href="#Warehouse.RejectBuyRequest.run-648"><span class="linenos">648</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse.RejectBuyRequest.run-649"><a href="#Warehouse.RejectBuyRequest.run-649"><span class="linenos">649</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-reject&quot;</span><span class="p">)</span>
</span><span id="Warehouse.RejectBuyRequest.run-650"><a href="#Warehouse.RejectBuyRequest.run-650"><span class="linenos">650</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.RejectBuyRequest.run-651"><a href="#Warehouse.RejectBuyRequest.run-651"><span class="linenos">651</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">))</span>
</span><span id="Warehouse.RejectBuyRequest.run-652"><a href="#Warehouse.RejectBuyRequest.run-652"><span class="linenos">652</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse.RejectBuyRequest.run-653"><a href="#Warehouse.RejectBuyRequest.run-653"><span class="linenos">653</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.RejectBuyRequest.run-654"><a href="#Warehouse.RejectBuyRequest.run-654"><span class="linenos">654</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.RejectBuyRequest.run-655"><a href="#Warehouse.RejectBuyRequest.run-655"><span class="linenos">655</span></a>            
</span><span id="Warehouse.RejectBuyRequest.run-656"><a href="#Warehouse.RejectBuyRequest.run-656"><span class="linenos">656</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.RejectBuyRequest.run-657"><a href="#Warehouse.RejectBuyRequest.run-657"><span class="linenos">657</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.RejectBuyRequest.run-658"><a href="#Warehouse.RejectBuyRequest.run-658"><span class="linenos">658</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; RejectBuyRequest sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>           
</span></pre></div>


            <div class="docstring"><p>Send warehouse-reject message to requesting store.</p>

<h6 id="fipa-protocol-implementation">FIPA Protocol Implementation:</h6>

<blockquote>
  <ul>
  <li>Phase: Proposal Refusal</li>
  <li>Performative: warehouse-reject (FIPA refuse)</li>
  <li>Direction: Warehouse  Store</li>
  </ul>
</blockquote>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Log Rejection</strong> (verbose): Print rejection details</li>
  <li><strong>Construct Message</strong>: Create warehouse-reject with metadata</li>
  <li><strong>Include Reason</strong>: Add rejection reason to message body</li>
  <li><strong>Send Refusal</strong>: Transmit to requesting store</li>
  <li><strong>Complete</strong>: No further interaction (one-shot behaviour)</li>
  </ol>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>No stock changes (was never locked for insufficient stock)</li>
  <li>No listeners created (conversation ends with refusal)</li>
  <li>Store receives refusal and tries other warehouses</li>
  <li>Prints debug information if verbose enabled</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Completes immediately after sending message.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Warehouse.ReceiveConfirmationOrDenial">
                            <input id="Warehouse.ReceiveConfirmationOrDenial-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.ReceiveConfirmationOrDenial</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Warehouse.ReceiveConfirmationOrDenial-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveConfirmationOrDenial"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveConfirmationOrDenial-660"><a href="#Warehouse.ReceiveConfirmationOrDenial-660"><span class="linenos">660</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveConfirmationOrDenial</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-661"><a href="#Warehouse.ReceiveConfirmationOrDenial-661"><span class="linenos">661</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-662"><a href="#Warehouse.ReceiveConfirmationOrDenial-662"><span class="linenos">662</span></a><span class="sd">        Behaviour that processes store&#39;s award or rejection decision (FIPA result notification).</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-663"><a href="#Warehouse.ReceiveConfirmationOrDenial-663"><span class="linenos">663</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-664"><a href="#Warehouse.ReceiveConfirmationOrDenial-664"><span class="linenos">664</span></a><span class="sd">        This behaviour implements the result notification reception in the FIPA Contract Net</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-665"><a href="#Warehouse.ReceiveConfirmationOrDenial-665"><span class="linenos">665</span></a><span class="sd">        Protocol where the warehouse, acting as a participant, receives the store&#39;s final</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-666"><a href="#Warehouse.ReceiveConfirmationOrDenial-666"><span class="linenos">666</span></a><span class="sd">        decision about whether its proposal was accepted or rejected.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-667"><a href="#Warehouse.ReceiveConfirmationOrDenial-667"><span class="linenos">667</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-668"><a href="#Warehouse.ReceiveConfirmationOrDenial-668"><span class="linenos">668</span></a><span class="sd">        FIPA Protocol Phase: **Result Notification Reception - Participant Role**</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-669"><a href="#Warehouse.ReceiveConfirmationOrDenial-669"><span class="linenos">669</span></a><span class="sd">            - Role: Participant (Warehouse receiving Store&#39;s decision)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-670"><a href="#Warehouse.ReceiveConfirmationOrDenial-670"><span class="linenos">670</span></a><span class="sd">            - Receives: store-confirm (FIPA accept-proposal) or store-deny (FIPA reject-proposal)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-671"><a href="#Warehouse.ReceiveConfirmationOrDenial-671"><span class="linenos">671</span></a><span class="sd">            - Actions:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-672"><a href="#Warehouse.ReceiveConfirmationOrDenial-672"><span class="linenos">672</span></a><span class="sd">                - If confirm: Transfer locked stock to pending deliveries, assign vehicle</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-673"><a href="#Warehouse.ReceiveConfirmationOrDenial-673"><span class="linenos">673</span></a><span class="sd">                - If deny: Release locked stock back to available inventory</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-674"><a href="#Warehouse.ReceiveConfirmationOrDenial-674"><span class="linenos">674</span></a><span class="sd">                - If timeout: Release locked stock (store chose another warehouse)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-675"><a href="#Warehouse.ReceiveConfirmationOrDenial-675"><span class="linenos">675</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-676"><a href="#Warehouse.ReceiveConfirmationOrDenial-676"><span class="linenos">676</span></a><span class="sd">        Stock State Transitions:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-677"><a href="#Warehouse.ReceiveConfirmationOrDenial-677"><span class="linenos">677</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-678"><a href="#Warehouse.ReceiveConfirmationOrDenial-678"><span class="linenos">678</span></a><span class="sd">            **On store-confirm (Award)**:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-679"><a href="#Warehouse.ReceiveConfirmationOrDenial-679"><span class="linenos">679</span></a><span class="sd">                1. locked_stock[product] -= quantity (release lock)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-680"><a href="#Warehouse.ReceiveConfirmationOrDenial-680"><span class="linenos">680</span></a><span class="sd">                2. current_capacity[product] += quantity (update capacity tracking)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-681"><a href="#Warehouse.ReceiveConfirmationOrDenial-681"><span class="linenos">681</span></a><span class="sd">                3. Create Order object from message</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-682"><a href="#Warehouse.ReceiveConfirmationOrDenial-682"><span class="linenos">682</span></a><span class="sd">                4. pending_deliveries[order_id] = order (await vehicle pickup)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-683"><a href="#Warehouse.ReceiveConfirmationOrDenial-683"><span class="linenos">683</span></a><span class="sd">                5. Launch AssignVehicle behaviour</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-684"><a href="#Warehouse.ReceiveConfirmationOrDenial-684"><span class="linenos">684</span></a><span class="sd">            </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-685"><a href="#Warehouse.ReceiveConfirmationOrDenial-685"><span class="linenos">685</span></a><span class="sd">            **On store-deny or timeout (Rejection/Timeout)**:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-686"><a href="#Warehouse.ReceiveConfirmationOrDenial-686"><span class="linenos">686</span></a><span class="sd">                1. locked_stock[product] -= quantity (release lock)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-687"><a href="#Warehouse.ReceiveConfirmationOrDenial-687"><span class="linenos">687</span></a><span class="sd">                2. stock[product] += quantity (return to available)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-688"><a href="#Warehouse.ReceiveConfirmationOrDenial-688"><span class="linenos">688</span></a><span class="sd">                3. No further action needed</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-689"><a href="#Warehouse.ReceiveConfirmationOrDenial-689"><span class="linenos">689</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-690"><a href="#Warehouse.ReceiveConfirmationOrDenial-690"><span class="linenos">690</span></a><span class="sd">        Attributes:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-691"><a href="#Warehouse.ReceiveConfirmationOrDenial-691"><span class="linenos">691</span></a><span class="sd">            accepted_id (int): Request ID for which we sent proposal.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-692"><a href="#Warehouse.ReceiveConfirmationOrDenial-692"><span class="linenos">692</span></a><span class="sd">            accepted_quantity (int): Quantity that was proposed.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-693"><a href="#Warehouse.ReceiveConfirmationOrDenial-693"><span class="linenos">693</span></a><span class="sd">            accepted_product (str): Product that was proposed.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-694"><a href="#Warehouse.ReceiveConfirmationOrDenial-694"><span class="linenos">694</span></a><span class="sd">            sender_jid (str): Store JID that will send decision.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-695"><a href="#Warehouse.ReceiveConfirmationOrDenial-695"><span class="linenos">695</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-696"><a href="#Warehouse.ReceiveConfirmationOrDenial-696"><span class="linenos">696</span></a><span class="sd">        Timeout Mechanism:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-697"><a href="#Warehouse.ReceiveConfirmationOrDenial-697"><span class="linenos">697</span></a><span class="sd">            - Wait time: 10 seconds</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-698"><a href="#Warehouse.ReceiveConfirmationOrDenial-698"><span class="linenos">698</span></a><span class="sd">            - Interpretation: Store chose another warehouse (implicit rejection)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-699"><a href="#Warehouse.ReceiveConfirmationOrDenial-699"><span class="linenos">699</span></a><span class="sd">            - Action: Unlock stock automatically</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-700"><a href="#Warehouse.ReceiveConfirmationOrDenial-700"><span class="linenos">700</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-701"><a href="#Warehouse.ReceiveConfirmationOrDenial-701"><span class="linenos">701</span></a><span class="sd">        Example Execution:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-702"><a href="#Warehouse.ReceiveConfirmationOrDenial-702"><span class="linenos">702</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-703"><a href="#Warehouse.ReceiveConfirmationOrDenial-703"><span class="linenos">703</span></a><span class="sd">            **Scenario 1: Store Confirms**</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-704"><a href="#Warehouse.ReceiveConfirmationOrDenial-704"><span class="linenos">704</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-705"><a href="#Warehouse.ReceiveConfirmationOrDenial-705"><span class="linenos">705</span></a><span class="sd">            Proposed: 50 electronics</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-706"><a href="#Warehouse.ReceiveConfirmationOrDenial-706"><span class="linenos">706</span></a><span class="sd">            Message Received: store-confirm &quot;50 electronics&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-707"><a href="#Warehouse.ReceiveConfirmationOrDenial-707"><span class="linenos">707</span></a><span class="sd">            Actions:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-708"><a href="#Warehouse.ReceiveConfirmationOrDenial-708"><span class="linenos">708</span></a><span class="sd">                - locked_stock[electronics]: 50 -&gt; 0</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-709"><a href="#Warehouse.ReceiveConfirmationOrDenial-709"><span class="linenos">709</span></a><span class="sd">                - pending_deliveries[1001000000] = Order(...)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-710"><a href="#Warehouse.ReceiveConfirmationOrDenial-710"><span class="linenos">710</span></a><span class="sd">                - Launch AssignVehicle(1001000000)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-711"><a href="#Warehouse.ReceiveConfirmationOrDenial-711"><span class="linenos">711</span></a><span class="sd">                - Print: &quot;Order 1001000000 confirmed...&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-712"><a href="#Warehouse.ReceiveConfirmationOrDenial-712"><span class="linenos">712</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-713"><a href="#Warehouse.ReceiveConfirmationOrDenial-713"><span class="linenos">713</span></a><span class="sd">            </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-714"><a href="#Warehouse.ReceiveConfirmationOrDenial-714"><span class="linenos">714</span></a><span class="sd">            **Scenario 2: Store Denies**</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-715"><a href="#Warehouse.ReceiveConfirmationOrDenial-715"><span class="linenos">715</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-716"><a href="#Warehouse.ReceiveConfirmationOrDenial-716"><span class="linenos">716</span></a><span class="sd">            Proposed: 50 electronics</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-717"><a href="#Warehouse.ReceiveConfirmationOrDenial-717"><span class="linenos">717</span></a><span class="sd">            Message Received: store-deny &quot;50 electronics&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-718"><a href="#Warehouse.ReceiveConfirmationOrDenial-718"><span class="linenos">718</span></a><span class="sd">            Actions:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-719"><a href="#Warehouse.ReceiveConfirmationOrDenial-719"><span class="linenos">719</span></a><span class="sd">                - locked_stock[electronics]: 50 -&gt; 0</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-720"><a href="#Warehouse.ReceiveConfirmationOrDenial-720"><span class="linenos">720</span></a><span class="sd">                - stock[electronics]: 50 -&gt; 100</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-721"><a href="#Warehouse.ReceiveConfirmationOrDenial-721"><span class="linenos">721</span></a><span class="sd">                - Print: &quot;Store chose another warehouse&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-722"><a href="#Warehouse.ReceiveConfirmationOrDenial-722"><span class="linenos">722</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-723"><a href="#Warehouse.ReceiveConfirmationOrDenial-723"><span class="linenos">723</span></a><span class="sd">            </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-724"><a href="#Warehouse.ReceiveConfirmationOrDenial-724"><span class="linenos">724</span></a><span class="sd">            **Scenario 3: Timeout**</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-725"><a href="#Warehouse.ReceiveConfirmationOrDenial-725"><span class="linenos">725</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-726"><a href="#Warehouse.ReceiveConfirmationOrDenial-726"><span class="linenos">726</span></a><span class="sd">            Proposed: 50 electronics</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-727"><a href="#Warehouse.ReceiveConfirmationOrDenial-727"><span class="linenos">727</span></a><span class="sd">            Message Received: None (10 second timeout)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-728"><a href="#Warehouse.ReceiveConfirmationOrDenial-728"><span class="linenos">728</span></a><span class="sd">            Actions:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-729"><a href="#Warehouse.ReceiveConfirmationOrDenial-729"><span class="linenos">729</span></a><span class="sd">                - locked_stock[electronics]: 50 -&gt; 0</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-730"><a href="#Warehouse.ReceiveConfirmationOrDenial-730"><span class="linenos">730</span></a><span class="sd">                - stock[electronics]: 50 -&gt; 100</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-731"><a href="#Warehouse.ReceiveConfirmationOrDenial-731"><span class="linenos">731</span></a><span class="sd">                - Print: &quot;No confirmation received, unlocking stock&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-732"><a href="#Warehouse.ReceiveConfirmationOrDenial-732"><span class="linenos">732</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-733"><a href="#Warehouse.ReceiveConfirmationOrDenial-733"><span class="linenos">733</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-734"><a href="#Warehouse.ReceiveConfirmationOrDenial-734"><span class="linenos">734</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-735"><a href="#Warehouse.ReceiveConfirmationOrDenial-735"><span class="linenos">735</span></a><span class="sd">            This behaviour is automatically filtered by template to only receive</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-736"><a href="#Warehouse.ReceiveConfirmationOrDenial-736"><span class="linenos">736</span></a><span class="sd">            messages for the specific warehouse, store, and request_id combination.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-737"><a href="#Warehouse.ReceiveConfirmationOrDenial-737"><span class="linenos">737</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-738"><a href="#Warehouse.ReceiveConfirmationOrDenial-738"><span class="linenos">738</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">sender_jid</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-739"><a href="#Warehouse.ReceiveConfirmationOrDenial-739"><span class="linenos">739</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-740"><a href="#Warehouse.ReceiveConfirmationOrDenial-740"><span class="linenos">740</span></a><span class="sd">            Initialize the ReceiveConfirmationOrDenial behaviour.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-741"><a href="#Warehouse.ReceiveConfirmationOrDenial-741"><span class="linenos">741</span></a><span class="sd">            </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-742"><a href="#Warehouse.ReceiveConfirmationOrDenial-742"><span class="linenos">742</span></a><span class="sd">            Args:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-743"><a href="#Warehouse.ReceiveConfirmationOrDenial-743"><span class="linenos">743</span></a><span class="sd">                accept_msg (Message): The warehouse-accept message we sent.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-744"><a href="#Warehouse.ReceiveConfirmationOrDenial-744"><span class="linenos">744</span></a><span class="sd">                    Used to extract proposal details for stock unlocking if needed.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-745"><a href="#Warehouse.ReceiveConfirmationOrDenial-745"><span class="linenos">745</span></a><span class="sd">                sender_jid (str): JID of the store that will send the decision.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-746"><a href="#Warehouse.ReceiveConfirmationOrDenial-746"><span class="linenos">746</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-747"><a href="#Warehouse.ReceiveConfirmationOrDenial-747"><span class="linenos">747</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-748"><a href="#Warehouse.ReceiveConfirmationOrDenial-748"><span class="linenos">748</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accepted_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">accept_msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-749"><a href="#Warehouse.ReceiveConfirmationOrDenial-749"><span class="linenos">749</span></a>            <span class="n">bod</span> <span class="o">=</span> <span class="n">accept_msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-750"><a href="#Warehouse.ReceiveConfirmationOrDenial-750"><span class="linenos">750</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accepted_quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bod</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-751"><a href="#Warehouse.ReceiveConfirmationOrDenial-751"><span class="linenos">751</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accepted_product</span> <span class="o">=</span> <span class="n">bod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-752"><a href="#Warehouse.ReceiveConfirmationOrDenial-752"><span class="linenos">752</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sender_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sender_jid</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-753"><a href="#Warehouse.ReceiveConfirmationOrDenial-753"><span class="linenos">753</span></a>        
</span><span id="Warehouse.ReceiveConfirmationOrDenial-754"><a href="#Warehouse.ReceiveConfirmationOrDenial-754"><span class="linenos">754</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-755"><a href="#Warehouse.ReceiveConfirmationOrDenial-755"><span class="linenos">755</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-756"><a href="#Warehouse.ReceiveConfirmationOrDenial-756"><span class="linenos">756</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Waiting for store confirmation or denial...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-757"><a href="#Warehouse.ReceiveConfirmationOrDenial-757"><span class="linenos">757</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-758"><a href="#Warehouse.ReceiveConfirmationOrDenial-758"><span class="linenos">758</span></a>            
</span><span id="Warehouse.ReceiveConfirmationOrDenial-759"><a href="#Warehouse.ReceiveConfirmationOrDenial-759"><span class="linenos">759</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-760"><a href="#Warehouse.ReceiveConfirmationOrDenial-760"><span class="linenos">760</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-761"><a href="#Warehouse.ReceiveConfirmationOrDenial-761"><span class="linenos">761</span></a>                <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-762"><a href="#Warehouse.ReceiveConfirmationOrDenial-762"><span class="linenos">762</span></a>                
</span><span id="Warehouse.ReceiveConfirmationOrDenial-763"><a href="#Warehouse.ReceiveConfirmationOrDenial-763"><span class="linenos">763</span></a>                <span class="c1"># Message with body format &quot;quantity product&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-764"><a href="#Warehouse.ReceiveConfirmationOrDenial-764"><span class="linenos">764</span></a>                <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-765"><a href="#Warehouse.ReceiveConfirmationOrDenial-765"><span class="linenos">765</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-766"><a href="#Warehouse.ReceiveConfirmationOrDenial-766"><span class="linenos">766</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-767"><a href="#Warehouse.ReceiveConfirmationOrDenial-767"><span class="linenos">767</span></a>                
</span><span id="Warehouse.ReceiveConfirmationOrDenial-768"><a href="#Warehouse.ReceiveConfirmationOrDenial-768"><span class="linenos">768</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;store-confirm&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-769"><a href="#Warehouse.ReceiveConfirmationOrDenial-769"><span class="linenos">769</span></a>                    <span class="c1"># Store confirmed - update locked stock and add to pending orders</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-770"><a href="#Warehouse.ReceiveConfirmationOrDenial-770"><span class="linenos">770</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quantity</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-771"><a href="#Warehouse.ReceiveConfirmationOrDenial-771"><span class="linenos">771</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">current_capacity</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-772"><a href="#Warehouse.ReceiveConfirmationOrDenial-772"><span class="linenos">772</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial-773"><a href="#Warehouse.ReceiveConfirmationOrDenial-773"><span class="linenos">773</span></a>                    <span class="c1"># Create Order object from message</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-774"><a href="#Warehouse.ReceiveConfirmationOrDenial-774"><span class="linenos">774</span></a>                    <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">message_to_order</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-775"><a href="#Warehouse.ReceiveConfirmationOrDenial-775"><span class="linenos">775</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial-776"><a href="#Warehouse.ReceiveConfirmationOrDenial-776"><span class="linenos">776</span></a>                    <span class="c1"># Add to pending_deliveries dict with order_id as key</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-777"><a href="#Warehouse.ReceiveConfirmationOrDenial-777"><span class="linenos">777</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-778"><a href="#Warehouse.ReceiveConfirmationOrDenial-778"><span class="linenos">778</span></a>                            
</span><span id="Warehouse.ReceiveConfirmationOrDenial-779"><a href="#Warehouse.ReceiveConfirmationOrDenial-779"><span class="linenos">779</span></a>                    <span class="c1"># Essential print - order confirmed</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-780"><a href="#Warehouse.ReceiveConfirmationOrDenial-780"><span class="linenos">780</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2"> confirmed: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> x</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-781"><a href="#Warehouse.ReceiveConfirmationOrDenial-781"><span class="linenos">781</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial-782"><a href="#Warehouse.ReceiveConfirmationOrDenial-782"><span class="linenos">782</span></a>                    <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">AssignVehicle</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-783"><a href="#Warehouse.ReceiveConfirmationOrDenial-783"><span class="linenos">783</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-784"><a href="#Warehouse.ReceiveConfirmationOrDenial-784"><span class="linenos">784</span></a>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-785"><a href="#Warehouse.ReceiveConfirmationOrDenial-785"><span class="linenos">785</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-786"><a href="#Warehouse.ReceiveConfirmationOrDenial-786"><span class="linenos">786</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-787"><a href="#Warehouse.ReceiveConfirmationOrDenial-787"><span class="linenos">787</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial-788"><a href="#Warehouse.ReceiveConfirmationOrDenial-788"><span class="linenos">788</span></a>                <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;store-deny&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-789"><a href="#Warehouse.ReceiveConfirmationOrDenial-789"><span class="linenos">789</span></a>                    <span class="c1"># Store denied (chose another warehouse) - unlock the stock</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-790"><a href="#Warehouse.ReceiveConfirmationOrDenial-790"><span class="linenos">790</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-791"><a href="#Warehouse.ReceiveConfirmationOrDenial-791"><span class="linenos">791</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Denial received! Store chose another warehouse.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-792"><a href="#Warehouse.ReceiveConfirmationOrDenial-792"><span class="linenos">792</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Unlocking stock: </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> += </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-793"><a href="#Warehouse.ReceiveConfirmationOrDenial-793"><span class="linenos">793</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial-794"><a href="#Warehouse.ReceiveConfirmationOrDenial-794"><span class="linenos">794</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quantity</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-795"><a href="#Warehouse.ReceiveConfirmationOrDenial-795"><span class="linenos">795</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-796"><a href="#Warehouse.ReceiveConfirmationOrDenial-796"><span class="linenos">796</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial-797"><a href="#Warehouse.ReceiveConfirmationOrDenial-797"><span class="linenos">797</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-798"><a href="#Warehouse.ReceiveConfirmationOrDenial-798"><span class="linenos">798</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-799"><a href="#Warehouse.ReceiveConfirmationOrDenial-799"><span class="linenos">799</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial-800"><a href="#Warehouse.ReceiveConfirmationOrDenial-800"><span class="linenos">800</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-801"><a href="#Warehouse.ReceiveConfirmationOrDenial-801"><span class="linenos">801</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-802"><a href="#Warehouse.ReceiveConfirmationOrDenial-802"><span class="linenos">802</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Timeout: No confirmation or denial received in 10 seconds. Unlocking stock...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-803"><a href="#Warehouse.ReceiveConfirmationOrDenial-803"><span class="linenos">803</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">accepted_product</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted_quantity</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-804"><a href="#Warehouse.ReceiveConfirmationOrDenial-804"><span class="linenos">804</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">accepted_product</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted_quantity</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-805"><a href="#Warehouse.ReceiveConfirmationOrDenial-805"><span class="linenos">805</span></a>                
</span><span id="Warehouse.ReceiveConfirmationOrDenial-806"><a href="#Warehouse.ReceiveConfirmationOrDenial-806"><span class="linenos">806</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial-807"><a href="#Warehouse.ReceiveConfirmationOrDenial-807"><span class="linenos">807</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>            
</span></pre></div>


            <div class="docstring"><p>Behaviour that processes store's award or rejection decision (FIPA result notification).</p>

<p>This behaviour implements the result notification reception in the FIPA Contract Net
Protocol where the warehouse, acting as a participant, receives the store's final
decision about whether its proposal was accepted or rejected.</p>

<p>FIPA Protocol Phase: <strong>Result Notification Reception - Participant Role</strong>
    - Role: Participant (Warehouse receiving Store's decision)
    - Receives: store-confirm (FIPA accept-proposal) or store-deny (FIPA reject-proposal)
    - Actions:
        - If confirm: Transfer locked stock to pending deliveries, assign vehicle
        - If deny: Release locked stock back to available inventory
        - If timeout: Release locked stock (store chose another warehouse)</p>

<h6 id="stock-state-transitions">Stock State Transitions:</h6>

<blockquote>
  <p><strong>On store-confirm (Award)</strong>:
      1. locked_stock[product] -= quantity (release lock)
      2. current_capacity[product] += quantity (update capacity tracking)
      3. Create Order object from message
      4. pending_deliveries[order_id] = order (await vehicle pickup)
      5. Launch AssignVehicle behaviour</p>
  
  <p><strong>On store-deny or timeout (Rejection/Timeout)</strong>:
      1. locked_stock[product] -= quantity (release lock)
      2. stock[product] += quantity (return to available)
      3. No further action needed</p>
</blockquote>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>accepted_id (int):</strong>  Request ID for which we sent proposal.</li>
<li><strong>accepted_quantity (int):</strong>  Quantity that was proposed.</li>
<li><strong>accepted_product (str):</strong>  Product that was proposed.</li>
<li><strong>sender_jid (str):</strong>  Store JID that will send decision.</li>
</ul>

<h6 id="timeout-mechanism">Timeout Mechanism:</h6>

<blockquote>
  <ul>
  <li>Wait time: 10 seconds</li>
  <li>Interpretation: Store chose another warehouse (implicit rejection)</li>
  <li>Action: Unlock stock automatically</li>
  </ul>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
  <p><strong>Scenario 1: Store Confirms</strong></p>

<pre><code>Proposed: 50 electronics
Message Received: store-confirm "50 electronics"
Actions:
    - locked_stock[electronics]: 50 -&gt; 0
    - pending_deliveries[1001000000] = Order(...)
    - Launch AssignVehicle(1001000000)
    - Print: "Order 1001000000 confirmed..."
</code></pre>
  
  <p><strong>Scenario 2: Store Denies</strong></p>

<pre><code>Proposed: 50 electronics
Message Received: store-deny "50 electronics"
Actions:
    - locked_stock[electronics]: 50 -&gt; 0
    - stock[electronics]: 50 -&gt; 100
    - Print: "Store chose another warehouse"
</code></pre>
  
  <p><strong>Scenario 3: Timeout</strong></p>

<pre><code>Proposed: 50 electronics
Message Received: None (10 second timeout)
Actions:
    - locked_stock[electronics]: 50 -&gt; 0
    - stock[electronics]: 50 -&gt; 100
    - Print: "No confirmation received, unlocking stock"
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This behaviour is automatically filtered by template to only receive
  messages for the specific warehouse, store, and request_id combination.</p>
</blockquote>
</div>


                            <div id="Warehouse.ReceiveConfirmationOrDenial.__init__" class="classattr">
                                        <input id="Warehouse.ReceiveConfirmationOrDenial.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Warehouse.ReceiveConfirmationOrDenial</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">accept_msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span>, </span><span class="param"><span class="n">sender_jid</span></span>)</span>

                <label class="view-source-button" for="Warehouse.ReceiveConfirmationOrDenial.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveConfirmationOrDenial.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-738"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-738"><span class="linenos">738</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">sender_jid</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-739"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-739"><span class="linenos">739</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-740"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-740"><span class="linenos">740</span></a><span class="sd">            Initialize the ReceiveConfirmationOrDenial behaviour.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-741"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-741"><span class="linenos">741</span></a><span class="sd">            </span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-742"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-742"><span class="linenos">742</span></a><span class="sd">            Args:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-743"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-743"><span class="linenos">743</span></a><span class="sd">                accept_msg (Message): The warehouse-accept message we sent.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-744"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-744"><span class="linenos">744</span></a><span class="sd">                    Used to extract proposal details for stock unlocking if needed.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-745"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-745"><span class="linenos">745</span></a><span class="sd">                sender_jid (str): JID of the store that will send the decision.</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-746"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-746"><span class="linenos">746</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-747"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-747"><span class="linenos">747</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-748"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-748"><span class="linenos">748</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accepted_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">accept_msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-749"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-749"><span class="linenos">749</span></a>            <span class="n">bod</span> <span class="o">=</span> <span class="n">accept_msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-750"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-750"><span class="linenos">750</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accepted_quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bod</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-751"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-751"><span class="linenos">751</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accepted_product</span> <span class="o">=</span> <span class="n">bod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.__init__-752"><a href="#Warehouse.ReceiveConfirmationOrDenial.__init__-752"><span class="linenos">752</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sender_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sender_jid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the ReceiveConfirmationOrDenial behaviour.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>accept_msg (Message):</strong>  The warehouse-accept message we sent.
Used to extract proposal details for stock unlocking if needed.</li>
<li><strong>sender_jid (str):</strong>  JID of the store that will send the decision.</li>
</ul>
</div>


                            </div>
                            <div id="Warehouse.ReceiveConfirmationOrDenial.accepted_id" class="classattr">
                                <div class="attr variable">
            <span class="name">accepted_id</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.ReceiveConfirmationOrDenial.accepted_id"></a>
    
    

                            </div>
                            <div id="Warehouse.ReceiveConfirmationOrDenial.accepted_quantity" class="classattr">
                                <div class="attr variable">
            <span class="name">accepted_quantity</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.ReceiveConfirmationOrDenial.accepted_quantity"></a>
    
    

                            </div>
                            <div id="Warehouse.ReceiveConfirmationOrDenial.accepted_product" class="classattr">
                                <div class="attr variable">
            <span class="name">accepted_product</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.ReceiveConfirmationOrDenial.accepted_product"></a>
    
    

                            </div>
                            <div id="Warehouse.ReceiveConfirmationOrDenial.sender_jid" class="classattr">
                                <div class="attr variable">
            <span class="name">sender_jid</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.ReceiveConfirmationOrDenial.sender_jid"></a>
    
    

                            </div>
                            <div id="Warehouse.ReceiveConfirmationOrDenial.run" class="classattr">
                                        <input id="Warehouse.ReceiveConfirmationOrDenial.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.ReceiveConfirmationOrDenial.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveConfirmationOrDenial.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveConfirmationOrDenial.run-754"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-754"><span class="linenos">754</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-755"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-755"><span class="linenos">755</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-756"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-756"><span class="linenos">756</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Waiting for store confirmation or denial...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-757"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-757"><span class="linenos">757</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-758"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-758"><span class="linenos">758</span></a>            
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-759"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-759"><span class="linenos">759</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-760"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-760"><span class="linenos">760</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-761"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-761"><span class="linenos">761</span></a>                <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-762"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-762"><span class="linenos">762</span></a>                
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-763"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-763"><span class="linenos">763</span></a>                <span class="c1"># Message with body format &quot;quantity product&quot;</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-764"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-764"><span class="linenos">764</span></a>                <span class="n">request</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-765"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-765"><span class="linenos">765</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-766"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-766"><span class="linenos">766</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-767"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-767"><span class="linenos">767</span></a>                
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-768"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-768"><span class="linenos">768</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;store-confirm&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-769"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-769"><span class="linenos">769</span></a>                    <span class="c1"># Store confirmed - update locked stock and add to pending orders</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-770"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-770"><span class="linenos">770</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quantity</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-771"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-771"><span class="linenos">771</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">current_capacity</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-772"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-772"><span class="linenos">772</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-773"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-773"><span class="linenos">773</span></a>                    <span class="c1"># Create Order object from message</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-774"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-774"><span class="linenos">774</span></a>                    <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">message_to_order</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-775"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-775"><span class="linenos">775</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-776"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-776"><span class="linenos">776</span></a>                    <span class="c1"># Add to pending_deliveries dict with order_id as key</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-777"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-777"><span class="linenos">777</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-778"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-778"><span class="linenos">778</span></a>                            
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-779"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-779"><span class="linenos">779</span></a>                    <span class="c1"># Essential print - order confirmed</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-780"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-780"><span class="linenos">780</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2"> confirmed: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> x</span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-781"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-781"><span class="linenos">781</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-782"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-782"><span class="linenos">782</span></a>                    <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">AssignVehicle</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-783"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-783"><span class="linenos">783</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-784"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-784"><span class="linenos">784</span></a>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-785"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-785"><span class="linenos">785</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-786"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-786"><span class="linenos">786</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-787"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-787"><span class="linenos">787</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-788"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-788"><span class="linenos">788</span></a>                <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;store-deny&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-789"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-789"><span class="linenos">789</span></a>                    <span class="c1"># Store denied (chose another warehouse) - unlock the stock</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-790"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-790"><span class="linenos">790</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-791"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-791"><span class="linenos">791</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Denial received! Store chose another warehouse.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-792"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-792"><span class="linenos">792</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Unlocking stock: </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> += </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-793"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-793"><span class="linenos">793</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-794"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-794"><span class="linenos">794</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">-=</span> <span class="n">quantity</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-795"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-795"><span class="linenos">795</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-796"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-796"><span class="linenos">796</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-797"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-797"><span class="linenos">797</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-798"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-798"><span class="linenos">798</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-799"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-799"><span class="linenos">799</span></a>                    
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-800"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-800"><span class="linenos">800</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-801"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-801"><span class="linenos">801</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-802"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-802"><span class="linenos">802</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Timeout: No confirmation or denial received in 10 seconds. Unlocking stock...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-803"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-803"><span class="linenos">803</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">locked_stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">accepted_product</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted_quantity</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-804"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-804"><span class="linenos">804</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">accepted_product</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted_quantity</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-805"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-805"><span class="linenos">805</span></a>                
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-806"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-806"><span class="linenos">806</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveConfirmationOrDenial.run-807"><a href="#Warehouse.ReceiveConfirmationOrDenial.run-807"><span class="linenos">807</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>            
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.AssignVehicle">
                            <input id="Warehouse.AssignVehicle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.AssignVehicle</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Warehouse.AssignVehicle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.AssignVehicle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.AssignVehicle-809"><a href="#Warehouse.AssignVehicle-809"><span class="linenos">809</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">AssignVehicle</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.AssignVehicle-810"><a href="#Warehouse.AssignVehicle-810"><span class="linenos">810</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
</span><span id="Warehouse.AssignVehicle-811"><a href="#Warehouse.AssignVehicle-811"><span class="linenos">811</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.AssignVehicle-812"><a href="#Warehouse.AssignVehicle-812"><span class="linenos">812</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Warehouse.AssignVehicle-813"><a href="#Warehouse.AssignVehicle-813"><span class="linenos">813</span></a>        
</span><span id="Warehouse.AssignVehicle-814"><a href="#Warehouse.AssignVehicle-814"><span class="linenos">814</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">populate_vehicles_from_contacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.AssignVehicle-815"><a href="#Warehouse.AssignVehicle-815"><span class="linenos">815</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Populate vehicles list from presence contacts if empty&quot;&quot;&quot;</span>
</span><span id="Warehouse.AssignVehicle-816"><a href="#Warehouse.AssignVehicle-816"><span class="linenos">816</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.AssignVehicle-817"><a href="#Warehouse.AssignVehicle-817"><span class="linenos">817</span></a>            
</span><span id="Warehouse.AssignVehicle-818"><a href="#Warehouse.AssignVehicle-818"><span class="linenos">818</span></a>            <span class="c1"># Get all vehicles from presence contacts</span>
</span><span id="Warehouse.AssignVehicle-819"><a href="#Warehouse.AssignVehicle-819"><span class="linenos">819</span></a>            <span class="n">vehicles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;vehicle&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
</span><span id="Warehouse.AssignVehicle-820"><a href="#Warehouse.AssignVehicle-820"><span class="linenos">820</span></a>            
</span><span id="Warehouse.AssignVehicle-821"><a href="#Warehouse.AssignVehicle-821"><span class="linenos">821</span></a>            <span class="k">if</span> <span class="n">vehicles</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-822"><a href="#Warehouse.AssignVehicle-822"><span class="linenos">822</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="n">vehicles</span>
</span><span id="Warehouse.AssignVehicle-823"><a href="#Warehouse.AssignVehicle-823"><span class="linenos">823</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-824"><a href="#Warehouse.AssignVehicle-824"><span class="linenos">824</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Discovered </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span><span class="si">}</span><span class="s2"> vehicle(s) from presence: </span><span class="si">{</span><span class="n">vehicles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-825"><a href="#Warehouse.AssignVehicle-825"><span class="linenos">825</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-826"><a href="#Warehouse.AssignVehicle-826"><span class="linenos">826</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-827"><a href="#Warehouse.AssignVehicle-827"><span class="linenos">827</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  No vehicles found in presence contacts yet!&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-828"><a href="#Warehouse.AssignVehicle-828"><span class="linenos">828</span></a>            
</span><span id="Warehouse.AssignVehicle-829"><a href="#Warehouse.AssignVehicle-829"><span class="linenos">829</span></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="Warehouse.AssignVehicle-830"><a href="#Warehouse.AssignVehicle-830"><span class="linenos">830</span></a>        
</span><span id="Warehouse.AssignVehicle-831"><a href="#Warehouse.AssignVehicle-831"><span class="linenos">831</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">create_presence_info_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-832"><a href="#Warehouse.AssignVehicle-832"><span class="linenos">832</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span>
</span><span id="Warehouse.AssignVehicle-833"><a href="#Warehouse.AssignVehicle-833"><span class="linenos">833</span></a>            
</span><span id="Warehouse.AssignVehicle-834"><a href="#Warehouse.AssignVehicle-834"><span class="linenos">834</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-835"><a href="#Warehouse.AssignVehicle-835"><span class="linenos">835</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;presence-info&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-836"><a href="#Warehouse.AssignVehicle-836"><span class="linenos">836</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Warehouse.AssignVehicle-837"><a href="#Warehouse.AssignVehicle-837"><span class="linenos">837</span></a>            <span class="k">return</span> <span class="n">msg</span>
</span><span id="Warehouse.AssignVehicle-838"><a href="#Warehouse.AssignVehicle-838"><span class="linenos">838</span></a>            
</span><span id="Warehouse.AssignVehicle-839"><a href="#Warehouse.AssignVehicle-839"><span class="linenos">839</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">create_call_for_proposal_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-840"><a href="#Warehouse.AssignVehicle-840"><span class="linenos">840</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span>
</span><span id="Warehouse.AssignVehicle-841"><a href="#Warehouse.AssignVehicle-841"><span class="linenos">841</span></a>            
</span><span id="Warehouse.AssignVehicle-842"><a href="#Warehouse.AssignVehicle-842"><span class="linenos">842</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-843"><a href="#Warehouse.AssignVehicle-843"><span class="linenos">843</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;order-proposal&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-844"><a href="#Warehouse.AssignVehicle-844"><span class="linenos">844</span></a>            
</span><span id="Warehouse.AssignVehicle-845"><a href="#Warehouse.AssignVehicle-845"><span class="linenos">845</span></a>            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">]</span>
</span><span id="Warehouse.AssignVehicle-846"><a href="#Warehouse.AssignVehicle-846"><span class="linenos">846</span></a>
</span><span id="Warehouse.AssignVehicle-847"><a href="#Warehouse.AssignVehicle-847"><span class="linenos">847</span></a>            <span class="n">new_body</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Warehouse.AssignVehicle-848"><a href="#Warehouse.AssignVehicle-848"><span class="linenos">848</span></a>                <span class="s2">&quot;orderid&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span id="Warehouse.AssignVehicle-849"><a href="#Warehouse.AssignVehicle-849"><span class="linenos">849</span></a>                <span class="s2">&quot;product&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="p">,</span>
</span><span id="Warehouse.AssignVehicle-850"><a href="#Warehouse.AssignVehicle-850"><span class="linenos">850</span></a>                <span class="s2">&quot;quantity&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="Warehouse.AssignVehicle-851"><a href="#Warehouse.AssignVehicle-851"><span class="linenos">851</span></a>                <span class="s2">&quot;sender&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">receiver</span><span class="p">,</span>
</span><span id="Warehouse.AssignVehicle-852"><a href="#Warehouse.AssignVehicle-852"><span class="linenos">852</span></a>                <span class="s2">&quot;receiver&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span>
</span><span id="Warehouse.AssignVehicle-853"><a href="#Warehouse.AssignVehicle-853"><span class="linenos">853</span></a>                <span class="s2">&quot;sender_location&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span><span class="p">,</span>
</span><span id="Warehouse.AssignVehicle-854"><a href="#Warehouse.AssignVehicle-854"><span class="linenos">854</span></a>                <span class="s2">&quot;receiver_location&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span>
</span><span id="Warehouse.AssignVehicle-855"><a href="#Warehouse.AssignVehicle-855"><span class="linenos">855</span></a>            <span class="p">}</span>
</span><span id="Warehouse.AssignVehicle-856"><a href="#Warehouse.AssignVehicle-856"><span class="linenos">856</span></a>            
</span><span id="Warehouse.AssignVehicle-857"><a href="#Warehouse.AssignVehicle-857"><span class="linenos">857</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_body</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-858"><a href="#Warehouse.AssignVehicle-858"><span class="linenos">858</span></a>            <span class="k">return</span> <span class="n">msg</span>
</span><span id="Warehouse.AssignVehicle-859"><a href="#Warehouse.AssignVehicle-859"><span class="linenos">859</span></a>        
</span><span id="Warehouse.AssignVehicle-860"><a href="#Warehouse.AssignVehicle-860"><span class="linenos">860</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.AssignVehicle-861"><a href="#Warehouse.AssignVehicle-861"><span class="linenos">861</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.AssignVehicle-862"><a href="#Warehouse.AssignVehicle-862"><span class="linenos">862</span></a>            
</span><span id="Warehouse.AssignVehicle-863"><a href="#Warehouse.AssignVehicle-863"><span class="linenos">863</span></a>            <span class="c1"># Populate vehicles from contacts</span>
</span><span id="Warehouse.AssignVehicle-864"><a href="#Warehouse.AssignVehicle-864"><span class="linenos">864</span></a>            <span class="n">has_vehicles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populate_vehicles_from_contacts</span><span class="p">()</span>
</span><span id="Warehouse.AssignVehicle-865"><a href="#Warehouse.AssignVehicle-865"><span class="linenos">865</span></a>            
</span><span id="Warehouse.AssignVehicle-866"><a href="#Warehouse.AssignVehicle-866"><span class="linenos">866</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_vehicles</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-867"><a href="#Warehouse.AssignVehicle-867"><span class="linenos">867</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  ERROR: No vehicles found in contacts!&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-868"><a href="#Warehouse.AssignVehicle-868"><span class="linenos">868</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Make sure vehicles are started and have subscribed to this supplier.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-869"><a href="#Warehouse.AssignVehicle-869"><span class="linenos">869</span></a>                <span class="k">return</span>
</span><span id="Warehouse.AssignVehicle-870"><a href="#Warehouse.AssignVehicle-870"><span class="linenos">870</span></a>            
</span><span id="Warehouse.AssignVehicle-871"><a href="#Warehouse.AssignVehicle-871"><span class="linenos">871</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-872"><a href="#Warehouse.AssignVehicle-872"><span class="linenos">872</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Requesting vehicle proposals...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-873"><a href="#Warehouse.AssignVehicle-873"><span class="linenos">873</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicles to contact: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">vehicles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-874"><a href="#Warehouse.AssignVehicle-874"><span class="linenos">874</span></a>            
</span><span id="Warehouse.AssignVehicle-875"><a href="#Warehouse.AssignVehicle-875"><span class="linenos">875</span></a>            <span class="c1"># Enviar mensagens de proposal a todos os veculos</span>
</span><span id="Warehouse.AssignVehicle-876"><a href="#Warehouse.AssignVehicle-876"><span class="linenos">876</span></a>            <span class="c1"># No verificamos presena - deixamos cada veculo decidir se pode aceitar</span>
</span><span id="Warehouse.AssignVehicle-877"><a href="#Warehouse.AssignVehicle-877"><span class="linenos">877</span></a>            <span class="n">n_available_vehicles</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Warehouse.AssignVehicle-878"><a href="#Warehouse.AssignVehicle-878"><span class="linenos">878</span></a>            <span class="n">n_sent_messages</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Warehouse.AssignVehicle-879"><a href="#Warehouse.AssignVehicle-879"><span class="linenos">879</span></a>            <span class="n">away_vehicles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Warehouse.AssignVehicle-880"><a href="#Warehouse.AssignVehicle-880"><span class="linenos">880</span></a>            <span class="k">for</span> <span class="n">vehicle_jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicles</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-881"><a href="#Warehouse.AssignVehicle-881"><span class="linenos">881</span></a>                
</span><span id="Warehouse.AssignVehicle-882"><a href="#Warehouse.AssignVehicle-882"><span class="linenos">882</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_presence_info_message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-883"><a href="#Warehouse.AssignVehicle-883"><span class="linenos">883</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-884"><a href="#Warehouse.AssignVehicle-884"><span class="linenos">884</span></a>                
</span><span id="Warehouse.AssignVehicle-885"><a href="#Warehouse.AssignVehicle-885"><span class="linenos">885</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">ReceivePresenceInfo</span><span class="p">()</span>
</span><span id="Warehouse.AssignVehicle-886"><a href="#Warehouse.AssignVehicle-886"><span class="linenos">886</span></a>                <span class="n">temp</span> <span class="p">:</span> <span class="n">Template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse.AssignVehicle-887"><a href="#Warehouse.AssignVehicle-887"><span class="linenos">887</span></a>                <span class="n">temp</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;presence-response&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-888"><a href="#Warehouse.AssignVehicle-888"><span class="linenos">888</span></a>                <span class="n">temp</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;vehicle_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle_jid</span><span class="p">))</span>
</span><span id="Warehouse.AssignVehicle-889"><a href="#Warehouse.AssignVehicle-889"><span class="linenos">889</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-890"><a href="#Warehouse.AssignVehicle-890"><span class="linenos">890</span></a>                
</span><span id="Warehouse.AssignVehicle-891"><a href="#Warehouse.AssignVehicle-891"><span class="linenos">891</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse.AssignVehicle-892"><a href="#Warehouse.AssignVehicle-892"><span class="linenos">892</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-893"><a href="#Warehouse.AssignVehicle-893"><span class="linenos">893</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Presence info from </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-894"><a href="#Warehouse.AssignVehicle-894"><span class="linenos">894</span></a>                
</span><span id="Warehouse.AssignVehicle-895"><a href="#Warehouse.AssignVehicle-895"><span class="linenos">895</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="p">[</span><span class="n">vehicle_jid</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PresenceShow.CHAT&quot;</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-896"><a href="#Warehouse.AssignVehicle-896"><span class="linenos">896</span></a>                    <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_call_for_proposal_message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-897"><a href="#Warehouse.AssignVehicle-897"><span class="linenos">897</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-898"><a href="#Warehouse.AssignVehicle-898"><span class="linenos">898</span></a>                    <span class="n">n_available_vehicles</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse.AssignVehicle-899"><a href="#Warehouse.AssignVehicle-899"><span class="linenos">899</span></a>                    <span class="n">n_sent_messages</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse.AssignVehicle-900"><a href="#Warehouse.AssignVehicle-900"><span class="linenos">900</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Sent order proposal to </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-901"><a href="#Warehouse.AssignVehicle-901"><span class="linenos">901</span></a>                
</span><span id="Warehouse.AssignVehicle-902"><a href="#Warehouse.AssignVehicle-902"><span class="linenos">902</span></a>                <span class="k">elif</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="p">[</span><span class="n">vehicle_jid</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PresenceShow.AWAY&quot;</span> <span class="ow">and</span> <span class="n">n_available_vehicles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-903"><a href="#Warehouse.AssignVehicle-903"><span class="linenos">903</span></a>                    <span class="n">away_vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-904"><a href="#Warehouse.AssignVehicle-904"><span class="linenos">904</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-905"><a href="#Warehouse.AssignVehicle-905"><span class="linenos">905</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Vehicle </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2"> is away.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-906"><a href="#Warehouse.AssignVehicle-906"><span class="linenos">906</span></a>                    
</span><span id="Warehouse.AssignVehicle-907"><a href="#Warehouse.AssignVehicle-907"><span class="linenos">907</span></a>            <span class="k">if</span> <span class="n">n_available_vehicles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-908"><a href="#Warehouse.AssignVehicle-908"><span class="linenos">908</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-909"><a href="#Warehouse.AssignVehicle-909"><span class="linenos">909</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  No AVAILABLE vehicles found. All vehicles are AWAY.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-910"><a href="#Warehouse.AssignVehicle-910"><span class="linenos">910</span></a>                <span class="k">for</span> <span class="n">vehicle_jid</span> <span class="ow">in</span> <span class="n">away_vehicles</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-911"><a href="#Warehouse.AssignVehicle-911"><span class="linenos">911</span></a>                    <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_call_for_proposal_message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-912"><a href="#Warehouse.AssignVehicle-912"><span class="linenos">912</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-913"><a href="#Warehouse.AssignVehicle-913"><span class="linenos">913</span></a>                    
</span><span id="Warehouse.AssignVehicle-914"><a href="#Warehouse.AssignVehicle-914"><span class="linenos">914</span></a>                    <span class="n">n_sent_messages</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse.AssignVehicle-915"><a href="#Warehouse.AssignVehicle-915"><span class="linenos">915</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Sent order proposal to </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-916"><a href="#Warehouse.AssignVehicle-916"><span class="linenos">916</span></a>            
</span><span id="Warehouse.AssignVehicle-917"><a href="#Warehouse.AssignVehicle-917"><span class="linenos">917</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle-918"><a href="#Warehouse.AssignVehicle-918"><span class="linenos">918</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Sent proposals to </span><span class="si">{</span><span class="n">n_sent_messages</span><span class="si">}</span><span class="s2"> vehicle(s)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-919"><a href="#Warehouse.AssignVehicle-919"><span class="linenos">919</span></a>                    
</span><span id="Warehouse.AssignVehicle-920"><a href="#Warehouse.AssignVehicle-920"><span class="linenos">920</span></a>            <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">ChooseBestVehicle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span> <span class="n">n_sent_messages</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-921"><a href="#Warehouse.AssignVehicle-921"><span class="linenos">921</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle-922"><a href="#Warehouse.AssignVehicle-922"><span class="linenos">922</span></a>            
</span><span id="Warehouse.AssignVehicle-923"><a href="#Warehouse.AssignVehicle-923"><span class="linenos">923</span></a>            <span class="c1"># Waits for all vehicle proposals to be received</span>
</span><span id="Warehouse.AssignVehicle-924"><a href="#Warehouse.AssignVehicle-924"><span class="linenos">924</span></a>            <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>This behaviour is only executed once</p>
</div>


                            <div id="Warehouse.AssignVehicle.__init__" class="classattr">
                                        <input id="Warehouse.AssignVehicle.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Warehouse.AssignVehicle</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">request_id</span></span>)</span>

                <label class="view-source-button" for="Warehouse.AssignVehicle.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.AssignVehicle.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.AssignVehicle.__init__-810"><a href="#Warehouse.AssignVehicle.__init__-810"><span class="linenos">810</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
</span><span id="Warehouse.AssignVehicle.__init__-811"><a href="#Warehouse.AssignVehicle.__init__-811"><span class="linenos">811</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.AssignVehicle.__init__-812"><a href="#Warehouse.AssignVehicle.__init__-812"><span class="linenos">812</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span></pre></div>


    

                            </div>
                            <div id="Warehouse.AssignVehicle.request_id" class="classattr">
                                <div class="attr variable">
            <span class="name">request_id</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.AssignVehicle.request_id"></a>
    
    

                            </div>
                            <div id="Warehouse.AssignVehicle.populate_vehicles_from_contacts" class="classattr">
                                        <input id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">populate_vehicles_from_contacts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.AssignVehicle.populate_vehicles_from_contacts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-814"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-814"><span class="linenos">814</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">populate_vehicles_from_contacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-815"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-815"><span class="linenos">815</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Populate vehicles list from presence contacts if empty&quot;&quot;&quot;</span>
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-816"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-816"><span class="linenos">816</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-817"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-817"><span class="linenos">817</span></a>            
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-818"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-818"><span class="linenos">818</span></a>            <span class="c1"># Get all vehicles from presence contacts</span>
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-819"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-819"><span class="linenos">819</span></a>            <span class="n">vehicles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;vehicle&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-820"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-820"><span class="linenos">820</span></a>            
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-821"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-821"><span class="linenos">821</span></a>            <span class="k">if</span> <span class="n">vehicles</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-822"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-822"><span class="linenos">822</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">vehicles</span> <span class="o">=</span> <span class="n">vehicles</span>
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-823"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-823"><span class="linenos">823</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-824"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-824"><span class="linenos">824</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Discovered </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span><span class="si">}</span><span class="s2"> vehicle(s) from presence: </span><span class="si">{</span><span class="n">vehicles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-825"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-825"><span class="linenos">825</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-826"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-826"><span class="linenos">826</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-827"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-827"><span class="linenos">827</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  No vehicles found in presence contacts yet!&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-828"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-828"><span class="linenos">828</span></a>            
</span><span id="Warehouse.AssignVehicle.populate_vehicles_from_contacts-829"><a href="#Warehouse.AssignVehicle.populate_vehicles_from_contacts-829"><span class="linenos">829</span></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></pre></div>


            <div class="docstring"><p>Populate vehicles list from presence contacts if empty</p>
</div>


                            </div>
                            <div id="Warehouse.AssignVehicle.create_presence_info_message" class="classattr">
                                        <input id="Warehouse.AssignVehicle.create_presence_info_message-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_presence_info_message</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">to</span></span><span class="return-annotation">) -> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span>:</span></span>

                <label class="view-source-button" for="Warehouse.AssignVehicle.create_presence_info_message-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.AssignVehicle.create_presence_info_message"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.AssignVehicle.create_presence_info_message-831"><a href="#Warehouse.AssignVehicle.create_presence_info_message-831"><span class="linenos">831</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">create_presence_info_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.create_presence_info_message-832"><a href="#Warehouse.AssignVehicle.create_presence_info_message-832"><span class="linenos">832</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span>
</span><span id="Warehouse.AssignVehicle.create_presence_info_message-833"><a href="#Warehouse.AssignVehicle.create_presence_info_message-833"><span class="linenos">833</span></a>            
</span><span id="Warehouse.AssignVehicle.create_presence_info_message-834"><a href="#Warehouse.AssignVehicle.create_presence_info_message-834"><span class="linenos">834</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.create_presence_info_message-835"><a href="#Warehouse.AssignVehicle.create_presence_info_message-835"><span class="linenos">835</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;presence-info&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.create_presence_info_message-836"><a href="#Warehouse.AssignVehicle.create_presence_info_message-836"><span class="linenos">836</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Warehouse.AssignVehicle.create_presence_info_message-837"><a href="#Warehouse.AssignVehicle.create_presence_info_message-837"><span class="linenos">837</span></a>            <span class="k">return</span> <span class="n">msg</span>
</span></pre></div>


    

                            </div>
                            <div id="Warehouse.AssignVehicle.create_call_for_proposal_message" class="classattr">
                                        <input id="Warehouse.AssignVehicle.create_call_for_proposal_message-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_call_for_proposal_message</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">to</span></span><span class="return-annotation">) -> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span>:</span></span>

                <label class="view-source-button" for="Warehouse.AssignVehicle.create_call_for_proposal_message-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.AssignVehicle.create_call_for_proposal_message"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-839"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-839"><span class="linenos">839</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">create_call_for_proposal_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-840"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-840"><span class="linenos">840</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-841"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-841"><span class="linenos">841</span></a>            
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-842"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-842"><span class="linenos">842</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">to</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-843"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-843"><span class="linenos">843</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;order-proposal&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-844"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-844"><span class="linenos">844</span></a>            
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-845"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-845"><span class="linenos">845</span></a>            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">]</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-846"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-846"><span class="linenos">846</span></a>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-847"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-847"><span class="linenos">847</span></a>            <span class="n">new_body</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-848"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-848"><span class="linenos">848</span></a>                <span class="s2">&quot;orderid&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-849"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-849"><span class="linenos">849</span></a>                <span class="s2">&quot;product&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="p">,</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-850"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-850"><span class="linenos">850</span></a>                <span class="s2">&quot;quantity&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-851"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-851"><span class="linenos">851</span></a>                <span class="s2">&quot;sender&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">receiver</span><span class="p">,</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-852"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-852"><span class="linenos">852</span></a>                <span class="s2">&quot;receiver&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-853"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-853"><span class="linenos">853</span></a>                <span class="s2">&quot;sender_location&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">receiver_location</span><span class="p">,</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-854"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-854"><span class="linenos">854</span></a>                <span class="s2">&quot;receiver_location&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">sender_location</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-855"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-855"><span class="linenos">855</span></a>            <span class="p">}</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-856"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-856"><span class="linenos">856</span></a>            
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-857"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-857"><span class="linenos">857</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_body</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.create_call_for_proposal_message-858"><a href="#Warehouse.AssignVehicle.create_call_for_proposal_message-858"><span class="linenos">858</span></a>            <span class="k">return</span> <span class="n">msg</span>
</span></pre></div>


    

                            </div>
                            <div id="Warehouse.AssignVehicle.run" class="classattr">
                                        <input id="Warehouse.AssignVehicle.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.AssignVehicle.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.AssignVehicle.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.AssignVehicle.run-860"><a href="#Warehouse.AssignVehicle.run-860"><span class="linenos">860</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.AssignVehicle.run-861"><a href="#Warehouse.AssignVehicle.run-861"><span class="linenos">861</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.AssignVehicle.run-862"><a href="#Warehouse.AssignVehicle.run-862"><span class="linenos">862</span></a>            
</span><span id="Warehouse.AssignVehicle.run-863"><a href="#Warehouse.AssignVehicle.run-863"><span class="linenos">863</span></a>            <span class="c1"># Populate vehicles from contacts</span>
</span><span id="Warehouse.AssignVehicle.run-864"><a href="#Warehouse.AssignVehicle.run-864"><span class="linenos">864</span></a>            <span class="n">has_vehicles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populate_vehicles_from_contacts</span><span class="p">()</span>
</span><span id="Warehouse.AssignVehicle.run-865"><a href="#Warehouse.AssignVehicle.run-865"><span class="linenos">865</span></a>            
</span><span id="Warehouse.AssignVehicle.run-866"><a href="#Warehouse.AssignVehicle.run-866"><span class="linenos">866</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_vehicles</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.run-867"><a href="#Warehouse.AssignVehicle.run-867"><span class="linenos">867</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  ERROR: No vehicles found in contacts!&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-868"><a href="#Warehouse.AssignVehicle.run-868"><span class="linenos">868</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Make sure vehicles are started and have subscribed to this supplier.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-869"><a href="#Warehouse.AssignVehicle.run-869"><span class="linenos">869</span></a>                <span class="k">return</span>
</span><span id="Warehouse.AssignVehicle.run-870"><a href="#Warehouse.AssignVehicle.run-870"><span class="linenos">870</span></a>            
</span><span id="Warehouse.AssignVehicle.run-871"><a href="#Warehouse.AssignVehicle.run-871"><span class="linenos">871</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.run-872"><a href="#Warehouse.AssignVehicle.run-872"><span class="linenos">872</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Requesting vehicle proposals...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-873"><a href="#Warehouse.AssignVehicle.run-873"><span class="linenos">873</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicles to contact: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">vehicles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-874"><a href="#Warehouse.AssignVehicle.run-874"><span class="linenos">874</span></a>            
</span><span id="Warehouse.AssignVehicle.run-875"><a href="#Warehouse.AssignVehicle.run-875"><span class="linenos">875</span></a>            <span class="c1"># Enviar mensagens de proposal a todos os veculos</span>
</span><span id="Warehouse.AssignVehicle.run-876"><a href="#Warehouse.AssignVehicle.run-876"><span class="linenos">876</span></a>            <span class="c1"># No verificamos presena - deixamos cada veculo decidir se pode aceitar</span>
</span><span id="Warehouse.AssignVehicle.run-877"><a href="#Warehouse.AssignVehicle.run-877"><span class="linenos">877</span></a>            <span class="n">n_available_vehicles</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Warehouse.AssignVehicle.run-878"><a href="#Warehouse.AssignVehicle.run-878"><span class="linenos">878</span></a>            <span class="n">n_sent_messages</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Warehouse.AssignVehicle.run-879"><a href="#Warehouse.AssignVehicle.run-879"><span class="linenos">879</span></a>            <span class="n">away_vehicles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Warehouse.AssignVehicle.run-880"><a href="#Warehouse.AssignVehicle.run-880"><span class="linenos">880</span></a>            <span class="k">for</span> <span class="n">vehicle_jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicles</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.run-881"><a href="#Warehouse.AssignVehicle.run-881"><span class="linenos">881</span></a>                
</span><span id="Warehouse.AssignVehicle.run-882"><a href="#Warehouse.AssignVehicle.run-882"><span class="linenos">882</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_presence_info_message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-883"><a href="#Warehouse.AssignVehicle.run-883"><span class="linenos">883</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-884"><a href="#Warehouse.AssignVehicle.run-884"><span class="linenos">884</span></a>                
</span><span id="Warehouse.AssignVehicle.run-885"><a href="#Warehouse.AssignVehicle.run-885"><span class="linenos">885</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">ReceivePresenceInfo</span><span class="p">()</span>
</span><span id="Warehouse.AssignVehicle.run-886"><a href="#Warehouse.AssignVehicle.run-886"><span class="linenos">886</span></a>                <span class="n">temp</span> <span class="p">:</span> <span class="n">Template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse.AssignVehicle.run-887"><a href="#Warehouse.AssignVehicle.run-887"><span class="linenos">887</span></a>                <span class="n">temp</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;presence-response&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-888"><a href="#Warehouse.AssignVehicle.run-888"><span class="linenos">888</span></a>                <span class="n">temp</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;vehicle_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vehicle_jid</span><span class="p">))</span>
</span><span id="Warehouse.AssignVehicle.run-889"><a href="#Warehouse.AssignVehicle.run-889"><span class="linenos">889</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-890"><a href="#Warehouse.AssignVehicle.run-890"><span class="linenos">890</span></a>                
</span><span id="Warehouse.AssignVehicle.run-891"><a href="#Warehouse.AssignVehicle.run-891"><span class="linenos">891</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse.AssignVehicle.run-892"><a href="#Warehouse.AssignVehicle.run-892"><span class="linenos">892</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.run-893"><a href="#Warehouse.AssignVehicle.run-893"><span class="linenos">893</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Presence info from </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-894"><a href="#Warehouse.AssignVehicle.run-894"><span class="linenos">894</span></a>                
</span><span id="Warehouse.AssignVehicle.run-895"><a href="#Warehouse.AssignVehicle.run-895"><span class="linenos">895</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="p">[</span><span class="n">vehicle_jid</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PresenceShow.CHAT&quot;</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.run-896"><a href="#Warehouse.AssignVehicle.run-896"><span class="linenos">896</span></a>                    <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_call_for_proposal_message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-897"><a href="#Warehouse.AssignVehicle.run-897"><span class="linenos">897</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-898"><a href="#Warehouse.AssignVehicle.run-898"><span class="linenos">898</span></a>                    <span class="n">n_available_vehicles</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse.AssignVehicle.run-899"><a href="#Warehouse.AssignVehicle.run-899"><span class="linenos">899</span></a>                    <span class="n">n_sent_messages</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse.AssignVehicle.run-900"><a href="#Warehouse.AssignVehicle.run-900"><span class="linenos">900</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Sent order proposal to </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-901"><a href="#Warehouse.AssignVehicle.run-901"><span class="linenos">901</span></a>                
</span><span id="Warehouse.AssignVehicle.run-902"><a href="#Warehouse.AssignVehicle.run-902"><span class="linenos">902</span></a>                <span class="k">elif</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="p">[</span><span class="n">vehicle_jid</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PresenceShow.AWAY&quot;</span> <span class="ow">and</span> <span class="n">n_available_vehicles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.run-903"><a href="#Warehouse.AssignVehicle.run-903"><span class="linenos">903</span></a>                    <span class="n">away_vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-904"><a href="#Warehouse.AssignVehicle.run-904"><span class="linenos">904</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.run-905"><a href="#Warehouse.AssignVehicle.run-905"><span class="linenos">905</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Vehicle </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2"> is away.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-906"><a href="#Warehouse.AssignVehicle.run-906"><span class="linenos">906</span></a>                    
</span><span id="Warehouse.AssignVehicle.run-907"><a href="#Warehouse.AssignVehicle.run-907"><span class="linenos">907</span></a>            <span class="k">if</span> <span class="n">n_available_vehicles</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.run-908"><a href="#Warehouse.AssignVehicle.run-908"><span class="linenos">908</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.run-909"><a href="#Warehouse.AssignVehicle.run-909"><span class="linenos">909</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  No AVAILABLE vehicles found. All vehicles are AWAY.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-910"><a href="#Warehouse.AssignVehicle.run-910"><span class="linenos">910</span></a>                <span class="k">for</span> <span class="n">vehicle_jid</span> <span class="ow">in</span> <span class="n">away_vehicles</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.run-911"><a href="#Warehouse.AssignVehicle.run-911"><span class="linenos">911</span></a>                    <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_call_for_proposal_message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-912"><a href="#Warehouse.AssignVehicle.run-912"><span class="linenos">912</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-913"><a href="#Warehouse.AssignVehicle.run-913"><span class="linenos">913</span></a>                    
</span><span id="Warehouse.AssignVehicle.run-914"><a href="#Warehouse.AssignVehicle.run-914"><span class="linenos">914</span></a>                    <span class="n">n_sent_messages</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse.AssignVehicle.run-915"><a href="#Warehouse.AssignVehicle.run-915"><span class="linenos">915</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Sent order proposal to </span><span class="si">{</span><span class="n">vehicle_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-916"><a href="#Warehouse.AssignVehicle.run-916"><span class="linenos">916</span></a>            
</span><span id="Warehouse.AssignVehicle.run-917"><a href="#Warehouse.AssignVehicle.run-917"><span class="linenos">917</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.AssignVehicle.run-918"><a href="#Warehouse.AssignVehicle.run-918"><span class="linenos">918</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Sent proposals to </span><span class="si">{</span><span class="n">n_sent_messages</span><span class="si">}</span><span class="s2"> vehicle(s)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-919"><a href="#Warehouse.AssignVehicle.run-919"><span class="linenos">919</span></a>                    
</span><span id="Warehouse.AssignVehicle.run-920"><a href="#Warehouse.AssignVehicle.run-920"><span class="linenos">920</span></a>            <span class="n">behav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">ChooseBestVehicle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span> <span class="n">n_sent_messages</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-921"><a href="#Warehouse.AssignVehicle.run-921"><span class="linenos">921</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
</span><span id="Warehouse.AssignVehicle.run-922"><a href="#Warehouse.AssignVehicle.run-922"><span class="linenos">922</span></a>            
</span><span id="Warehouse.AssignVehicle.run-923"><a href="#Warehouse.AssignVehicle.run-923"><span class="linenos">923</span></a>            <span class="c1"># Waits for all vehicle proposals to be received</span>
</span><span id="Warehouse.AssignVehicle.run-924"><a href="#Warehouse.AssignVehicle.run-924"><span class="linenos">924</span></a>            <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.ReceivePresenceInfo">
                            <input id="Warehouse.ReceivePresenceInfo-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.ReceivePresenceInfo</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Warehouse.ReceivePresenceInfo-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceivePresenceInfo"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceivePresenceInfo-926"><a href="#Warehouse.ReceivePresenceInfo-926"><span class="linenos">926</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceivePresenceInfo</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.ReceivePresenceInfo-927"><a href="#Warehouse.ReceivePresenceInfo-927"><span class="linenos">927</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceivePresenceInfo-928"><a href="#Warehouse.ReceivePresenceInfo-928"><span class="linenos">928</span></a><span class="sd">        Behaviour to receive presence information from vehicle agents.</span>
</span><span id="Warehouse.ReceivePresenceInfo-929"><a href="#Warehouse.ReceivePresenceInfo-929"><span class="linenos">929</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceivePresenceInfo-930"><a href="#Warehouse.ReceivePresenceInfo-930"><span class="linenos">930</span></a><span class="sd">        This behaviour requests and collects availability status from vehicle agents,</span>
</span><span id="Warehouse.ReceivePresenceInfo-931"><a href="#Warehouse.ReceivePresenceInfo-931"><span class="linenos">931</span></a><span class="sd">        which is used to determine which vehicles are available for delivery tasks.</span>
</span><span id="Warehouse.ReceivePresenceInfo-932"><a href="#Warehouse.ReceivePresenceInfo-932"><span class="linenos">932</span></a><span class="sd">        The presence information indicates whether a vehicle is busy, available, or</span>
</span><span id="Warehouse.ReceivePresenceInfo-933"><a href="#Warehouse.ReceivePresenceInfo-933"><span class="linenos">933</span></a><span class="sd">        in another state.</span>
</span><span id="Warehouse.ReceivePresenceInfo-934"><a href="#Warehouse.ReceivePresenceInfo-934"><span class="linenos">934</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceivePresenceInfo-935"><a href="#Warehouse.ReceivePresenceInfo-935"><span class="linenos">935</span></a><span class="sd">        The behaviour waits for a single response from a vehicle agent containing</span>
</span><span id="Warehouse.ReceivePresenceInfo-936"><a href="#Warehouse.ReceivePresenceInfo-936"><span class="linenos">936</span></a><span class="sd">        its current presence status. This information is stored in the warehouse&#39;s</span>
</span><span id="Warehouse.ReceivePresenceInfo-937"><a href="#Warehouse.ReceivePresenceInfo-937"><span class="linenos">937</span></a><span class="sd">        presence_infos dictionary for later use in vehicle selection.</span>
</span><span id="Warehouse.ReceivePresenceInfo-938"><a href="#Warehouse.ReceivePresenceInfo-938"><span class="linenos">938</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceivePresenceInfo-939"><a href="#Warehouse.ReceivePresenceInfo-939"><span class="linenos">939</span></a><span class="sd">        Workflow:</span>
</span><span id="Warehouse.ReceivePresenceInfo-940"><a href="#Warehouse.ReceivePresenceInfo-940"><span class="linenos">940</span></a><span class="sd">            1. **Receive Message**: Wait up to 10 seconds for presence response</span>
</span><span id="Warehouse.ReceivePresenceInfo-941"><a href="#Warehouse.ReceivePresenceInfo-941"><span class="linenos">941</span></a><span class="sd">            2. **Parse JSON**: Extract presence_show status from message body</span>
</span><span id="Warehouse.ReceivePresenceInfo-942"><a href="#Warehouse.ReceivePresenceInfo-942"><span class="linenos">942</span></a><span class="sd">            3. **Store Information**: Save presence info indexed by vehicle_id</span>
</span><span id="Warehouse.ReceivePresenceInfo-943"><a href="#Warehouse.ReceivePresenceInfo-943"><span class="linenos">943</span></a><span class="sd">            4. **Handle Timeout**: Print warning if no response received</span>
</span><span id="Warehouse.ReceivePresenceInfo-944"><a href="#Warehouse.ReceivePresenceInfo-944"><span class="linenos">944</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceivePresenceInfo-945"><a href="#Warehouse.ReceivePresenceInfo-945"><span class="linenos">945</span></a><span class="sd">        Side Effects:</span>
</span><span id="Warehouse.ReceivePresenceInfo-946"><a href="#Warehouse.ReceivePresenceInfo-946"><span class="linenos">946</span></a><span class="sd">            - Updates agent.presence_infos dictionary with vehicle status</span>
</span><span id="Warehouse.ReceivePresenceInfo-947"><a href="#Warehouse.ReceivePresenceInfo-947"><span class="linenos">947</span></a><span class="sd">            - Prints presence information if verbose mode enabled</span>
</span><span id="Warehouse.ReceivePresenceInfo-948"><a href="#Warehouse.ReceivePresenceInfo-948"><span class="linenos">948</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceivePresenceInfo-949"><a href="#Warehouse.ReceivePresenceInfo-949"><span class="linenos">949</span></a><span class="sd">        Returns:</span>
</span><span id="Warehouse.ReceivePresenceInfo-950"><a href="#Warehouse.ReceivePresenceInfo-950"><span class="linenos">950</span></a><span class="sd">            None. Completes after receiving one presence message or timing out.</span>
</span><span id="Warehouse.ReceivePresenceInfo-951"><a href="#Warehouse.ReceivePresenceInfo-951"><span class="linenos">951</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceivePresenceInfo-952"><a href="#Warehouse.ReceivePresenceInfo-952"><span class="linenos">952</span></a><span class="sd">        Example:</span>
</span><span id="Warehouse.ReceivePresenceInfo-953"><a href="#Warehouse.ReceivePresenceInfo-953"><span class="linenos">953</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceivePresenceInfo-954"><a href="#Warehouse.ReceivePresenceInfo-954"><span class="linenos">954</span></a><span class="sd">            Message Received:</span>
</span><span id="Warehouse.ReceivePresenceInfo-955"><a href="#Warehouse.ReceivePresenceInfo-955"><span class="linenos">955</span></a><span class="sd">                Metadata: vehicle_id = &quot;vehicle1@localhost&quot;</span>
</span><span id="Warehouse.ReceivePresenceInfo-956"><a href="#Warehouse.ReceivePresenceInfo-956"><span class="linenos">956</span></a><span class="sd">                Body: {&quot;presence_show&quot;: &quot;available&quot;}</span>
</span><span id="Warehouse.ReceivePresenceInfo-957"><a href="#Warehouse.ReceivePresenceInfo-957"><span class="linenos">957</span></a><span class="sd">            Processing:</span>
</span><span id="Warehouse.ReceivePresenceInfo-958"><a href="#Warehouse.ReceivePresenceInfo-958"><span class="linenos">958</span></a><span class="sd">                - presence_infos[&quot;vehicle1@localhost&quot;] = &quot;available&quot;</span>
</span><span id="Warehouse.ReceivePresenceInfo-959"><a href="#Warehouse.ReceivePresenceInfo-959"><span class="linenos">959</span></a><span class="sd">            Output:</span>
</span><span id="Warehouse.ReceivePresenceInfo-960"><a href="#Warehouse.ReceivePresenceInfo-960"><span class="linenos">960</span></a><span class="sd">                - Print: &quot;Received presence info response from vehicle1: available&quot;</span>
</span><span id="Warehouse.ReceivePresenceInfo-961"><a href="#Warehouse.ReceivePresenceInfo-961"><span class="linenos">961</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceivePresenceInfo-962"><a href="#Warehouse.ReceivePresenceInfo-962"><span class="linenos">962</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceivePresenceInfo-963"><a href="#Warehouse.ReceivePresenceInfo-963"><span class="linenos">963</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse.ReceivePresenceInfo-964"><a href="#Warehouse.ReceivePresenceInfo-964"><span class="linenos">964</span></a><span class="sd">            The 10-second timeout prevents indefinite blocking if a vehicle agent</span>
</span><span id="Warehouse.ReceivePresenceInfo-965"><a href="#Warehouse.ReceivePresenceInfo-965"><span class="linenos">965</span></a><span class="sd">            is offline or unresponsive.</span>
</span><span id="Warehouse.ReceivePresenceInfo-966"><a href="#Warehouse.ReceivePresenceInfo-966"><span class="linenos">966</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceivePresenceInfo-967"><a href="#Warehouse.ReceivePresenceInfo-967"><span class="linenos">967</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceivePresenceInfo-968"><a href="#Warehouse.ReceivePresenceInfo-968"><span class="linenos">968</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ReceivePresenceInfo-969"><a href="#Warehouse.ReceivePresenceInfo-969"><span class="linenos">969</span></a>            
</span><span id="Warehouse.ReceivePresenceInfo-970"><a href="#Warehouse.ReceivePresenceInfo-970"><span class="linenos">970</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="Warehouse.ReceivePresenceInfo-971"><a href="#Warehouse.ReceivePresenceInfo-971"><span class="linenos">971</span></a>            
</span><span id="Warehouse.ReceivePresenceInfo-972"><a href="#Warehouse.ReceivePresenceInfo-972"><span class="linenos">972</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse.ReceivePresenceInfo-973"><a href="#Warehouse.ReceivePresenceInfo-973"><span class="linenos">973</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Warehouse.ReceivePresenceInfo-974"><a href="#Warehouse.ReceivePresenceInfo-974"><span class="linenos">974</span></a>                <span class="n">presence_info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;presence_show&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceivePresenceInfo-975"><a href="#Warehouse.ReceivePresenceInfo-975"><span class="linenos">975</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceivePresenceInfo-976"><a href="#Warehouse.ReceivePresenceInfo-976"><span class="linenos">976</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received presence info response from </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">:&quot;</span>
</span><span id="Warehouse.ReceivePresenceInfo-977"><a href="#Warehouse.ReceivePresenceInfo-977"><span class="linenos">977</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">presence_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceivePresenceInfo-978"><a href="#Warehouse.ReceivePresenceInfo-978"><span class="linenos">978</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;vehicle_id&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">presence_info</span>
</span><span id="Warehouse.ReceivePresenceInfo-979"><a href="#Warehouse.ReceivePresenceInfo-979"><span class="linenos">979</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceivePresenceInfo-980"><a href="#Warehouse.ReceivePresenceInfo-980"><span class="linenos">980</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceivePresenceInfo-981"><a href="#Warehouse.ReceivePresenceInfo-981"><span class="linenos">981</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No presence info response received from vehicle.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Behaviour to receive presence information from vehicle agents.</p>

<p>This behaviour requests and collects availability status from vehicle agents,
which is used to determine which vehicles are available for delivery tasks.
The presence information indicates whether a vehicle is busy, available, or
in another state.</p>

<p>The behaviour waits for a single response from a vehicle agent containing
its current presence status. This information is stored in the warehouse's
presence_infos dictionary for later use in vehicle selection.</p>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Receive Message</strong>: Wait up to 10 seconds for presence response</li>
  <li><strong>Parse JSON</strong>: Extract presence_show status from message body</li>
  <li><strong>Store Information</strong>: Save presence info indexed by vehicle_id</li>
  <li><strong>Handle Timeout</strong>: Print warning if no response received</li>
  </ol>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Updates agent.presence_infos dictionary with vehicle status</li>
  <li>Prints presence information if verbose mode enabled</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Completes after receiving one presence message or timing out.</p>
</blockquote>

<h6 id="example">Example:</h6>

<blockquote>
<pre><code>Message Received:
    Metadata: vehicle_id = "vehicle1@localhost"
    Body: {"presence_show": "available"}
Processing:
    - presence_infos["vehicle1@localhost"] = "available"
Output:
    - Print: "Received presence info response from vehicle1: available"
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>The 10-second timeout prevents indefinite blocking if a vehicle agent
  is offline or unresponsive.</p>
</blockquote>
</div>


                            <div id="Warehouse.ReceivePresenceInfo.run" class="classattr">
                                        <input id="Warehouse.ReceivePresenceInfo.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.ReceivePresenceInfo.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceivePresenceInfo.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceivePresenceInfo.run-967"><a href="#Warehouse.ReceivePresenceInfo.run-967"><span class="linenos">967</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceivePresenceInfo.run-968"><a href="#Warehouse.ReceivePresenceInfo.run-968"><span class="linenos">968</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ReceivePresenceInfo.run-969"><a href="#Warehouse.ReceivePresenceInfo.run-969"><span class="linenos">969</span></a>            
</span><span id="Warehouse.ReceivePresenceInfo.run-970"><a href="#Warehouse.ReceivePresenceInfo.run-970"><span class="linenos">970</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="Warehouse.ReceivePresenceInfo.run-971"><a href="#Warehouse.ReceivePresenceInfo.run-971"><span class="linenos">971</span></a>            
</span><span id="Warehouse.ReceivePresenceInfo.run-972"><a href="#Warehouse.ReceivePresenceInfo.run-972"><span class="linenos">972</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse.ReceivePresenceInfo.run-973"><a href="#Warehouse.ReceivePresenceInfo.run-973"><span class="linenos">973</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Warehouse.ReceivePresenceInfo.run-974"><a href="#Warehouse.ReceivePresenceInfo.run-974"><span class="linenos">974</span></a>                <span class="n">presence_info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;presence_show&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceivePresenceInfo.run-975"><a href="#Warehouse.ReceivePresenceInfo.run-975"><span class="linenos">975</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceivePresenceInfo.run-976"><a href="#Warehouse.ReceivePresenceInfo.run-976"><span class="linenos">976</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received presence info response from </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">:&quot;</span>
</span><span id="Warehouse.ReceivePresenceInfo.run-977"><a href="#Warehouse.ReceivePresenceInfo.run-977"><span class="linenos">977</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">presence_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceivePresenceInfo.run-978"><a href="#Warehouse.ReceivePresenceInfo.run-978"><span class="linenos">978</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">presence_infos</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;vehicle_id&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">presence_info</span>
</span><span id="Warehouse.ReceivePresenceInfo.run-979"><a href="#Warehouse.ReceivePresenceInfo.run-979"><span class="linenos">979</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceivePresenceInfo.run-980"><a href="#Warehouse.ReceivePresenceInfo.run-980"><span class="linenos">980</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceivePresenceInfo.run-981"><a href="#Warehouse.ReceivePresenceInfo.run-981"><span class="linenos">981</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No presence info response received from vehicle.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.ReceiveVehicleProposals">
                            <input id="Warehouse.ReceiveVehicleProposals-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.ReceiveVehicleProposals</span><wbr>(<span class="base">spade.behaviour.CyclicBehaviour</span>):

                <label class="view-source-button" for="Warehouse.ReceiveVehicleProposals-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveVehicleProposals"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveVehicleProposals-983"><a href="#Warehouse.ReceiveVehicleProposals-983"><span class="linenos"> 983</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveVehicleProposals</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveVehicleProposals-984"><a href="#Warehouse.ReceiveVehicleProposals-984"><span class="linenos"> 984</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveVehicleProposals-985"><a href="#Warehouse.ReceiveVehicleProposals-985"><span class="linenos"> 985</span></a><span class="sd">        Cyclic behaviour that collects vehicle delivery proposals for orders.</span>
</span><span id="Warehouse.ReceiveVehicleProposals-986"><a href="#Warehouse.ReceiveVehicleProposals-986"><span class="linenos"> 986</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveVehicleProposals-987"><a href="#Warehouse.ReceiveVehicleProposals-987"><span class="linenos"> 987</span></a><span class="sd">        This behaviour implements the proposal collection phase of vehicle selection.</span>
</span><span id="Warehouse.ReceiveVehicleProposals-988"><a href="#Warehouse.ReceiveVehicleProposals-988"><span class="linenos"> 988</span></a><span class="sd">        After the warehouse sends delivery requests to vehicles, this behaviour</span>
</span><span id="Warehouse.ReceiveVehicleProposals-989"><a href="#Warehouse.ReceiveVehicleProposals-989"><span class="linenos"> 989</span></a><span class="sd">        continuously receives and stores vehicle proposals containing delivery capacity</span>
</span><span id="Warehouse.ReceiveVehicleProposals-990"><a href="#Warehouse.ReceiveVehicleProposals-990"><span class="linenos"> 990</span></a><span class="sd">        and estimated delivery time information.</span>
</span><span id="Warehouse.ReceiveVehicleProposals-991"><a href="#Warehouse.ReceiveVehicleProposals-991"><span class="linenos"> 991</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveVehicleProposals-992"><a href="#Warehouse.ReceiveVehicleProposals-992"><span class="linenos"> 992</span></a><span class="sd">        The behaviour runs in an infinite loop within each execution, collecting all</span>
</span><span id="Warehouse.ReceiveVehicleProposals-993"><a href="#Warehouse.ReceiveVehicleProposals-993"><span class="linenos"> 993</span></a><span class="sd">        available proposals until a timeout occurs (no more proposals arriving). Each</span>
</span><span id="Warehouse.ReceiveVehicleProposals-994"><a href="#Warehouse.ReceiveVehicleProposals-994"><span class="linenos"> 994</span></a><span class="sd">        proposal is indexed by order_id and vehicle_jid for later evaluation.</span>
</span><span id="Warehouse.ReceiveVehicleProposals-995"><a href="#Warehouse.ReceiveVehicleProposals-995"><span class="linenos"> 995</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveVehicleProposals-996"><a href="#Warehouse.ReceiveVehicleProposals-996"><span class="linenos"> 996</span></a><span class="sd">        Proposal Data Structure:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-997"><a href="#Warehouse.ReceiveVehicleProposals-997"><span class="linenos"> 997</span></a><span class="sd">            ```python</span>
</span><span id="Warehouse.ReceiveVehicleProposals-998"><a href="#Warehouse.ReceiveVehicleProposals-998"><span class="linenos"> 998</span></a><span class="sd">            vehicle_proposals = {</span>
</span><span id="Warehouse.ReceiveVehicleProposals-999"><a href="#Warehouse.ReceiveVehicleProposals-999"><span class="linenos"> 999</span></a><span class="sd">                order_id: {</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1000"><a href="#Warehouse.ReceiveVehicleProposals-1000"><span class="linenos">1000</span></a><span class="sd">                    &quot;vehicle1@localhost&quot;: (can_fit: bool, delivery_time: int),</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1001"><a href="#Warehouse.ReceiveVehicleProposals-1001"><span class="linenos">1001</span></a><span class="sd">                    &quot;vehicle2@localhost&quot;: (can_fit: bool, delivery_time: int),</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1002"><a href="#Warehouse.ReceiveVehicleProposals-1002"><span class="linenos">1002</span></a><span class="sd">                    ...</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1003"><a href="#Warehouse.ReceiveVehicleProposals-1003"><span class="linenos">1003</span></a><span class="sd">                }</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1004"><a href="#Warehouse.ReceiveVehicleProposals-1004"><span class="linenos">1004</span></a><span class="sd">            }</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1005"><a href="#Warehouse.ReceiveVehicleProposals-1005"><span class="linenos">1005</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1006"><a href="#Warehouse.ReceiveVehicleProposals-1006"><span class="linenos">1006</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveVehicleProposals-1007"><a href="#Warehouse.ReceiveVehicleProposals-1007"><span class="linenos">1007</span></a><span class="sd">        Message Format:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1008"><a href="#Warehouse.ReceiveVehicleProposals-1008"><span class="linenos">1008</span></a><span class="sd">            Body (JSON):</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1009"><a href="#Warehouse.ReceiveVehicleProposals-1009"><span class="linenos">1009</span></a><span class="sd">                ```json</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1010"><a href="#Warehouse.ReceiveVehicleProposals-1010"><span class="linenos">1010</span></a><span class="sd">                {</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1011"><a href="#Warehouse.ReceiveVehicleProposals-1011"><span class="linenos">1011</span></a><span class="sd">                    &quot;orderid&quot;: 2001000000,</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1012"><a href="#Warehouse.ReceiveVehicleProposals-1012"><span class="linenos">1012</span></a><span class="sd">                    &quot;can_fit&quot;: true,</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1013"><a href="#Warehouse.ReceiveVehicleProposals-1013"><span class="linenos">1013</span></a><span class="sd">                    &quot;delivery_time&quot;: 150</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1014"><a href="#Warehouse.ReceiveVehicleProposals-1014"><span class="linenos">1014</span></a><span class="sd">                }</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1015"><a href="#Warehouse.ReceiveVehicleProposals-1015"><span class="linenos">1015</span></a><span class="sd">                ```</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1016"><a href="#Warehouse.ReceiveVehicleProposals-1016"><span class="linenos">1016</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveVehicleProposals-1017"><a href="#Warehouse.ReceiveVehicleProposals-1017"><span class="linenos">1017</span></a><span class="sd">        Workflow:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1018"><a href="#Warehouse.ReceiveVehicleProposals-1018"><span class="linenos">1018</span></a><span class="sd">            1. **Receive Message**: Wait up to 5 seconds for vehicle proposal</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1019"><a href="#Warehouse.ReceiveVehicleProposals-1019"><span class="linenos">1019</span></a><span class="sd">            2. **Parse Proposal**: Extract orderid, can_fit, delivery_time</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1020"><a href="#Warehouse.ReceiveVehicleProposals-1020"><span class="linenos">1020</span></a><span class="sd">            3. **Initialize Storage**: Create order_id entry if doesn&#39;t exist</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1021"><a href="#Warehouse.ReceiveVehicleProposals-1021"><span class="linenos">1021</span></a><span class="sd">            4. **Store Proposal**: Add vehicle proposal to vehicle_proposals dict</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1022"><a href="#Warehouse.ReceiveVehicleProposals-1022"><span class="linenos">1022</span></a><span class="sd">            5. **Continue Loop**: Repeat until timeout (no more proposals)</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1023"><a href="#Warehouse.ReceiveVehicleProposals-1023"><span class="linenos">1023</span></a><span class="sd">            6. **Exit**: Break loop when timeout indicates all proposals received</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1024"><a href="#Warehouse.ReceiveVehicleProposals-1024"><span class="linenos">1024</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveVehicleProposals-1025"><a href="#Warehouse.ReceiveVehicleProposals-1025"><span class="linenos">1025</span></a><span class="sd">        Side Effects:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1026"><a href="#Warehouse.ReceiveVehicleProposals-1026"><span class="linenos">1026</span></a><span class="sd">            - Updates agent.vehicle_proposals dictionary with new proposals</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1027"><a href="#Warehouse.ReceiveVehicleProposals-1027"><span class="linenos">1027</span></a><span class="sd">            - Prints proposal details if verbose mode enabled</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1028"><a href="#Warehouse.ReceiveVehicleProposals-1028"><span class="linenos">1028</span></a><span class="sd">            - Breaks loop after 5-second timeout</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1029"><a href="#Warehouse.ReceiveVehicleProposals-1029"><span class="linenos">1029</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveVehicleProposals-1030"><a href="#Warehouse.ReceiveVehicleProposals-1030"><span class="linenos">1030</span></a><span class="sd">        Returns:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1031"><a href="#Warehouse.ReceiveVehicleProposals-1031"><span class="linenos">1031</span></a><span class="sd">            None. Exits after collecting all available proposals.</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1032"><a href="#Warehouse.ReceiveVehicleProposals-1032"><span class="linenos">1032</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveVehicleProposals-1033"><a href="#Warehouse.ReceiveVehicleProposals-1033"><span class="linenos">1033</span></a><span class="sd">        Example Execution:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1034"><a href="#Warehouse.ReceiveVehicleProposals-1034"><span class="linenos">1034</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1035"><a href="#Warehouse.ReceiveVehicleProposals-1035"><span class="linenos">1035</span></a><span class="sd">            Loop Iteration 1:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1036"><a href="#Warehouse.ReceiveVehicleProposals-1036"><span class="linenos">1036</span></a><span class="sd">                - Receive from vehicle1: can_fit=True, time=120</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1037"><a href="#Warehouse.ReceiveVehicleProposals-1037"><span class="linenos">1037</span></a><span class="sd">                - Store: vehicle_proposals[2001000000][&quot;vehicle1&quot;] = (True, 120)</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1038"><a href="#Warehouse.ReceiveVehicleProposals-1038"><span class="linenos">1038</span></a><span class="sd">            Loop Iteration 2:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1039"><a href="#Warehouse.ReceiveVehicleProposals-1039"><span class="linenos">1039</span></a><span class="sd">                - Receive from vehicle2: can_fit=False, time=180</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1040"><a href="#Warehouse.ReceiveVehicleProposals-1040"><span class="linenos">1040</span></a><span class="sd">                - Store: vehicle_proposals[2001000000][&quot;vehicle2&quot;] = (False, 180)</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1041"><a href="#Warehouse.ReceiveVehicleProposals-1041"><span class="linenos">1041</span></a><span class="sd">            Loop Iteration 3:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1042"><a href="#Warehouse.ReceiveVehicleProposals-1042"><span class="linenos">1042</span></a><span class="sd">                - Timeout after 5 seconds</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1043"><a href="#Warehouse.ReceiveVehicleProposals-1043"><span class="linenos">1043</span></a><span class="sd">                - Break loop, all proposals collected</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1044"><a href="#Warehouse.ReceiveVehicleProposals-1044"><span class="linenos">1044</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1045"><a href="#Warehouse.ReceiveVehicleProposals-1045"><span class="linenos">1045</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveVehicleProposals-1046"><a href="#Warehouse.ReceiveVehicleProposals-1046"><span class="linenos">1046</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1047"><a href="#Warehouse.ReceiveVehicleProposals-1047"><span class="linenos">1047</span></a><span class="sd">            The 5-second timeout is optimized to collect multiple proposals quickly</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1048"><a href="#Warehouse.ReceiveVehicleProposals-1048"><span class="linenos">1048</span></a><span class="sd">            while not waiting too long for vehicles that won&#39;t respond.</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1049"><a href="#Warehouse.ReceiveVehicleProposals-1049"><span class="linenos">1049</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1050"><a href="#Warehouse.ReceiveVehicleProposals-1050"><span class="linenos">1050</span></a>        
</span><span id="Warehouse.ReceiveVehicleProposals-1051"><a href="#Warehouse.ReceiveVehicleProposals-1051"><span class="linenos">1051</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1052"><a href="#Warehouse.ReceiveVehicleProposals-1052"><span class="linenos">1052</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1053"><a href="#Warehouse.ReceiveVehicleProposals-1053"><span class="linenos">1053</span></a>            
</span><span id="Warehouse.ReceiveVehicleProposals-1054"><a href="#Warehouse.ReceiveVehicleProposals-1054"><span class="linenos">1054</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1055"><a href="#Warehouse.ReceiveVehicleProposals-1055"><span class="linenos">1055</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1056"><a href="#Warehouse.ReceiveVehicleProposals-1056"><span class="linenos">1056</span></a>                
</span><span id="Warehouse.ReceiveVehicleProposals-1057"><a href="#Warehouse.ReceiveVehicleProposals-1057"><span class="linenos">1057</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1058"><a href="#Warehouse.ReceiveVehicleProposals-1058"><span class="linenos">1058</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1059"><a href="#Warehouse.ReceiveVehicleProposals-1059"><span class="linenos">1059</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received vehicle proposal from </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1060"><a href="#Warehouse.ReceiveVehicleProposals-1060"><span class="linenos">1060</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1061"><a href="#Warehouse.ReceiveVehicleProposals-1061"><span class="linenos">1061</span></a>                    
</span><span id="Warehouse.ReceiveVehicleProposals-1062"><a href="#Warehouse.ReceiveVehicleProposals-1062"><span class="linenos">1062</span></a>                    <span class="c1"># A proposta do veculo no  uma Order, so apenas dados da proposta</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1063"><a href="#Warehouse.ReceiveVehicleProposals-1063"><span class="linenos">1063</span></a>                    <span class="n">order_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1064"><a href="#Warehouse.ReceiveVehicleProposals-1064"><span class="linenos">1064</span></a>                    <span class="n">sender_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1065"><a href="#Warehouse.ReceiveVehicleProposals-1065"><span class="linenos">1065</span></a>                    <span class="n">can_fit</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;can_fit&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1066"><a href="#Warehouse.ReceiveVehicleProposals-1066"><span class="linenos">1066</span></a>                    <span class="n">time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;delivery_time&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1067"><a href="#Warehouse.ReceiveVehicleProposals-1067"><span class="linenos">1067</span></a>                    
</span><span id="Warehouse.ReceiveVehicleProposals-1068"><a href="#Warehouse.ReceiveVehicleProposals-1068"><span class="linenos">1068</span></a>                    <span class="c1"># Verificar se a entrada para este order_id existe, se no criar</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1069"><a href="#Warehouse.ReceiveVehicleProposals-1069"><span class="linenos">1069</span></a>                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1070"><a href="#Warehouse.ReceiveVehicleProposals-1070"><span class="linenos">1070</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">order_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1071"><a href="#Warehouse.ReceiveVehicleProposals-1071"><span class="linenos">1071</span></a>                    
</span><span id="Warehouse.ReceiveVehicleProposals-1072"><a href="#Warehouse.ReceiveVehicleProposals-1072"><span class="linenos">1072</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">order_id</span><span class="p">)][</span><span class="n">sender_jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">can_fit</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1073"><a href="#Warehouse.ReceiveVehicleProposals-1073"><span class="linenos">1073</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1074"><a href="#Warehouse.ReceiveVehicleProposals-1074"><span class="linenos">1074</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">sender_jid</span><span class="si">}</span><span class="s2"> proposal: can_fit=</span><span class="si">{</span><span class="n">can_fit</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1075"><a href="#Warehouse.ReceiveVehicleProposals-1075"><span class="linenos">1075</span></a>  
</span><span id="Warehouse.ReceiveVehicleProposals-1076"><a href="#Warehouse.ReceiveVehicleProposals-1076"><span class="linenos">1076</span></a>                <span class="k">else</span><span class="p">:</span> 
</span><span id="Warehouse.ReceiveVehicleProposals-1077"><a href="#Warehouse.ReceiveVehicleProposals-1077"><span class="linenos">1077</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1078"><a href="#Warehouse.ReceiveVehicleProposals-1078"><span class="linenos">1078</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Timeout - no more proposals received&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals-1079"><a href="#Warehouse.ReceiveVehicleProposals-1079"><span class="linenos">1079</span></a>                    <span class="k">break</span>
</span></pre></div>


            <div class="docstring"><p>Cyclic behaviour that collects vehicle delivery proposals for orders.</p>

<p>This behaviour implements the proposal collection phase of vehicle selection.
After the warehouse sends delivery requests to vehicles, this behaviour
continuously receives and stores vehicle proposals containing delivery capacity
and estimated delivery time information.</p>

<p>The behaviour runs in an infinite loop within each execution, collecting all
available proposals until a timeout occurs (no more proposals arriving). Each
proposal is indexed by order_id and vehicle_jid for later evaluation.</p>

<h6 id="proposal-data-structure">Proposal Data Structure:</h6>

<blockquote>
  <div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">vehicle_proposals</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;vehicle1@localhost&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">can_fit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">delivery_time</span><span class="p">:</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;vehicle2@localhost&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">can_fit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">delivery_time</span><span class="p">:</span> <span class="nb">int</span><span class="p">),</span>
        <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
  </div>
</blockquote>

<h6 id="message-format">Message Format:</h6>

<blockquote>
  <p>Body (JSON):</p>
  
  <p><div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;orderid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2001000000</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;can_fit&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;delivery_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">150</span>
<span class="p">}</span>
</code></pre>
</div></p>
</blockquote>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Receive Message</strong>: Wait up to 5 seconds for vehicle proposal</li>
  <li><strong>Parse Proposal</strong>: Extract orderid, can_fit, delivery_time</li>
  <li><strong>Initialize Storage</strong>: Create order_id entry if doesn't exist</li>
  <li><strong>Store Proposal</strong>: Add vehicle proposal to vehicle_proposals dict</li>
  <li><strong>Continue Loop</strong>: Repeat until timeout (no more proposals)</li>
  <li><strong>Exit</strong>: Break loop when timeout indicates all proposals received</li>
  </ol>
</blockquote>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Updates agent.vehicle_proposals dictionary with new proposals</li>
  <li>Prints proposal details if verbose mode enabled</li>
  <li>Breaks loop after 5-second timeout</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Exits after collecting all available proposals.</p>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
<pre><code>Loop Iteration 1:
    - Receive from vehicle1: can_fit=True, time=120
    - Store: vehicle_proposals[2001000000]["vehicle1"] = (True, 120)
Loop Iteration 2:
    - Receive from vehicle2: can_fit=False, time=180
    - Store: vehicle_proposals[2001000000]["vehicle2"] = (False, 180)
Loop Iteration 3:
    - Timeout after 5 seconds
    - Break loop, all proposals collected
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>The 5-second timeout is optimized to collect multiple proposals quickly
  while not waiting too long for vehicles that won't respond.</p>
</blockquote>
</div>


                            <div id="Warehouse.ReceiveVehicleProposals.run" class="classattr">
                                        <input id="Warehouse.ReceiveVehicleProposals.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.ReceiveVehicleProposals.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveVehicleProposals.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveVehicleProposals.run-1051"><a href="#Warehouse.ReceiveVehicleProposals.run-1051"><span class="linenos">1051</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1052"><a href="#Warehouse.ReceiveVehicleProposals.run-1052"><span class="linenos">1052</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1053"><a href="#Warehouse.ReceiveVehicleProposals.run-1053"><span class="linenos">1053</span></a>            
</span><span id="Warehouse.ReceiveVehicleProposals.run-1054"><a href="#Warehouse.ReceiveVehicleProposals.run-1054"><span class="linenos">1054</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1055"><a href="#Warehouse.ReceiveVehicleProposals.run-1055"><span class="linenos">1055</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1056"><a href="#Warehouse.ReceiveVehicleProposals.run-1056"><span class="linenos">1056</span></a>                
</span><span id="Warehouse.ReceiveVehicleProposals.run-1057"><a href="#Warehouse.ReceiveVehicleProposals.run-1057"><span class="linenos">1057</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1058"><a href="#Warehouse.ReceiveVehicleProposals.run-1058"><span class="linenos">1058</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1059"><a href="#Warehouse.ReceiveVehicleProposals.run-1059"><span class="linenos">1059</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received vehicle proposal from </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1060"><a href="#Warehouse.ReceiveVehicleProposals.run-1060"><span class="linenos">1060</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1061"><a href="#Warehouse.ReceiveVehicleProposals.run-1061"><span class="linenos">1061</span></a>                    
</span><span id="Warehouse.ReceiveVehicleProposals.run-1062"><a href="#Warehouse.ReceiveVehicleProposals.run-1062"><span class="linenos">1062</span></a>                    <span class="c1"># A proposta do veculo no  uma Order, so apenas dados da proposta</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1063"><a href="#Warehouse.ReceiveVehicleProposals.run-1063"><span class="linenos">1063</span></a>                    <span class="n">order_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1064"><a href="#Warehouse.ReceiveVehicleProposals.run-1064"><span class="linenos">1064</span></a>                    <span class="n">sender_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1065"><a href="#Warehouse.ReceiveVehicleProposals.run-1065"><span class="linenos">1065</span></a>                    <span class="n">can_fit</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;can_fit&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1066"><a href="#Warehouse.ReceiveVehicleProposals.run-1066"><span class="linenos">1066</span></a>                    <span class="n">time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;delivery_time&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1067"><a href="#Warehouse.ReceiveVehicleProposals.run-1067"><span class="linenos">1067</span></a>                    
</span><span id="Warehouse.ReceiveVehicleProposals.run-1068"><a href="#Warehouse.ReceiveVehicleProposals.run-1068"><span class="linenos">1068</span></a>                    <span class="c1"># Verificar se a entrada para este order_id existe, se no criar</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1069"><a href="#Warehouse.ReceiveVehicleProposals.run-1069"><span class="linenos">1069</span></a>                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1070"><a href="#Warehouse.ReceiveVehicleProposals.run-1070"><span class="linenos">1070</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">order_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1071"><a href="#Warehouse.ReceiveVehicleProposals.run-1071"><span class="linenos">1071</span></a>                    
</span><span id="Warehouse.ReceiveVehicleProposals.run-1072"><a href="#Warehouse.ReceiveVehicleProposals.run-1072"><span class="linenos">1072</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">order_id</span><span class="p">)][</span><span class="n">sender_jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">can_fit</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1073"><a href="#Warehouse.ReceiveVehicleProposals.run-1073"><span class="linenos">1073</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1074"><a href="#Warehouse.ReceiveVehicleProposals.run-1074"><span class="linenos">1074</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">sender_jid</span><span class="si">}</span><span class="s2"> proposal: can_fit=</span><span class="si">{</span><span class="n">can_fit</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1075"><a href="#Warehouse.ReceiveVehicleProposals.run-1075"><span class="linenos">1075</span></a>  
</span><span id="Warehouse.ReceiveVehicleProposals.run-1076"><a href="#Warehouse.ReceiveVehicleProposals.run-1076"><span class="linenos">1076</span></a>                <span class="k">else</span><span class="p">:</span> 
</span><span id="Warehouse.ReceiveVehicleProposals.run-1077"><a href="#Warehouse.ReceiveVehicleProposals.run-1077"><span class="linenos">1077</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1078"><a href="#Warehouse.ReceiveVehicleProposals.run-1078"><span class="linenos">1078</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Timeout - no more proposals received&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleProposals.run-1079"><a href="#Warehouse.ReceiveVehicleProposals.run-1079"><span class="linenos">1079</span></a>                    <span class="k">break</span>
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.ChooseBestVehicle">
                            <input id="Warehouse.ChooseBestVehicle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.ChooseBestVehicle</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Warehouse.ChooseBestVehicle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ChooseBestVehicle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ChooseBestVehicle-1081"><a href="#Warehouse.ChooseBestVehicle-1081"><span class="linenos">1081</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ChooseBestVehicle</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.ChooseBestVehicle-1082"><a href="#Warehouse.ChooseBestVehicle-1082"><span class="linenos">1082</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.ChooseBestVehicle-1083"><a href="#Warehouse.ChooseBestVehicle-1083"><span class="linenos">1083</span></a><span class="sd">        Behaviour that evaluates vehicle proposals and selects the optimal vehicle for delivery.</span>
</span><span id="Warehouse.ChooseBestVehicle-1084"><a href="#Warehouse.ChooseBestVehicle-1084"><span class="linenos">1084</span></a><span class="sd">        </span>
</span><span id="Warehouse.ChooseBestVehicle-1085"><a href="#Warehouse.ChooseBestVehicle-1085"><span class="linenos">1085</span></a><span class="sd">        This behaviour implements the proposal evaluation and winner selection phase of</span>
</span><span id="Warehouse.ChooseBestVehicle-1086"><a href="#Warehouse.ChooseBestVehicle-1086"><span class="linenos">1086</span></a><span class="sd">        vehicle assignment. After collecting all vehicle proposals via ReceiveVehicleProposals,</span>
</span><span id="Warehouse.ChooseBestVehicle-1087"><a href="#Warehouse.ChooseBestVehicle-1087"><span class="linenos">1087</span></a><span class="sd">        this behaviour compares them based on capacity and delivery time, then notifies</span>
</span><span id="Warehouse.ChooseBestVehicle-1088"><a href="#Warehouse.ChooseBestVehicle-1088"><span class="linenos">1088</span></a><span class="sd">        the selected vehicle and rejects all others.</span>
</span><span id="Warehouse.ChooseBestVehicle-1089"><a href="#Warehouse.ChooseBestVehicle-1089"><span class="linenos">1089</span></a><span class="sd">        </span>
</span><span id="Warehouse.ChooseBestVehicle-1090"><a href="#Warehouse.ChooseBestVehicle-1090"><span class="linenos">1090</span></a><span class="sd">        Selection Algorithm:</span>
</span><span id="Warehouse.ChooseBestVehicle-1091"><a href="#Warehouse.ChooseBestVehicle-1091"><span class="linenos">1091</span></a><span class="sd">            1. **Priority 1**: Filter vehicles that can fit the order (can_fit=True)</span>
</span><span id="Warehouse.ChooseBestVehicle-1092"><a href="#Warehouse.ChooseBestVehicle-1092"><span class="linenos">1092</span></a><span class="sd">            2. **Priority 2**: Among fitting vehicles, select one with minimum delivery_time</span>
</span><span id="Warehouse.ChooseBestVehicle-1093"><a href="#Warehouse.ChooseBestVehicle-1093"><span class="linenos">1093</span></a><span class="sd">            3. **Fallback**: If no vehicles can fit, select vehicle with minimum delivery_time anyway</span>
</span><span id="Warehouse.ChooseBestVehicle-1094"><a href="#Warehouse.ChooseBestVehicle-1094"><span class="linenos">1094</span></a><span class="sd">        </span>
</span><span id="Warehouse.ChooseBestVehicle-1095"><a href="#Warehouse.ChooseBestVehicle-1095"><span class="linenos">1095</span></a><span class="sd">        Attributes:</span>
</span><span id="Warehouse.ChooseBestVehicle-1096"><a href="#Warehouse.ChooseBestVehicle-1096"><span class="linenos">1096</span></a><span class="sd">            request_id (int): Unique order identifier to find proposals.</span>
</span><span id="Warehouse.ChooseBestVehicle-1097"><a href="#Warehouse.ChooseBestVehicle-1097"><span class="linenos">1097</span></a><span class="sd">            n_sent_messages (int): Expected number of vehicle responses to wait for.</span>
</span><span id="Warehouse.ChooseBestVehicle-1098"><a href="#Warehouse.ChooseBestVehicle-1098"><span class="linenos">1098</span></a><span class="sd">        </span>
</span><span id="Warehouse.ChooseBestVehicle-1099"><a href="#Warehouse.ChooseBestVehicle-1099"><span class="linenos">1099</span></a><span class="sd">        Workflow:</span>
</span><span id="Warehouse.ChooseBestVehicle-1100"><a href="#Warehouse.ChooseBestVehicle-1100"><span class="linenos">1100</span></a><span class="sd">            1. **Wait for Proposals**: Loop until n_sent_messages proposals received</span>
</span><span id="Warehouse.ChooseBestVehicle-1101"><a href="#Warehouse.ChooseBestVehicle-1101"><span class="linenos">1101</span></a><span class="sd">            2. **Evaluate Proposals**: Call get_best_vehicle() to select winner</span>
</span><span id="Warehouse.ChooseBestVehicle-1102"><a href="#Warehouse.ChooseBestVehicle-1102"><span class="linenos">1102</span></a><span class="sd">            3. **Send Confirmation**: Notify selected vehicle with order-confirmation</span>
</span><span id="Warehouse.ChooseBestVehicle-1103"><a href="#Warehouse.ChooseBestVehicle-1103"><span class="linenos">1103</span></a><span class="sd">            4. **Send Rejections**: Notify all other vehicles they were not selected</span>
</span><span id="Warehouse.ChooseBestVehicle-1104"><a href="#Warehouse.ChooseBestVehicle-1104"><span class="linenos">1104</span></a><span class="sd">        </span>
</span><span id="Warehouse.ChooseBestVehicle-1105"><a href="#Warehouse.ChooseBestVehicle-1105"><span class="linenos">1105</span></a><span class="sd">        Message Format (Confirmation):</span>
</span><span id="Warehouse.ChooseBestVehicle-1106"><a href="#Warehouse.ChooseBestVehicle-1106"><span class="linenos">1106</span></a><span class="sd">            Metadata:</span>
</span><span id="Warehouse.ChooseBestVehicle-1107"><a href="#Warehouse.ChooseBestVehicle-1107"><span class="linenos">1107</span></a><span class="sd">                - performative: &quot;order-confirmation&quot;</span>
</span><span id="Warehouse.ChooseBestVehicle-1108"><a href="#Warehouse.ChooseBestVehicle-1108"><span class="linenos">1108</span></a><span class="sd">            Body (JSON):</span>
</span><span id="Warehouse.ChooseBestVehicle-1109"><a href="#Warehouse.ChooseBestVehicle-1109"><span class="linenos">1109</span></a><span class="sd">                ```json</span>
</span><span id="Warehouse.ChooseBestVehicle-1110"><a href="#Warehouse.ChooseBestVehicle-1110"><span class="linenos">1110</span></a><span class="sd">                {</span>
</span><span id="Warehouse.ChooseBestVehicle-1111"><a href="#Warehouse.ChooseBestVehicle-1111"><span class="linenos">1111</span></a><span class="sd">                    &quot;orderid&quot;: 2001000000,</span>
</span><span id="Warehouse.ChooseBestVehicle-1112"><a href="#Warehouse.ChooseBestVehicle-1112"><span class="linenos">1112</span></a><span class="sd">                    &quot;confirmed&quot;: true</span>
</span><span id="Warehouse.ChooseBestVehicle-1113"><a href="#Warehouse.ChooseBestVehicle-1113"><span class="linenos">1113</span></a><span class="sd">                }</span>
</span><span id="Warehouse.ChooseBestVehicle-1114"><a href="#Warehouse.ChooseBestVehicle-1114"><span class="linenos">1114</span></a><span class="sd">                ```</span>
</span><span id="Warehouse.ChooseBestVehicle-1115"><a href="#Warehouse.ChooseBestVehicle-1115"><span class="linenos">1115</span></a><span class="sd">        </span>
</span><span id="Warehouse.ChooseBestVehicle-1116"><a href="#Warehouse.ChooseBestVehicle-1116"><span class="linenos">1116</span></a><span class="sd">        Message Format (Rejection):</span>
</span><span id="Warehouse.ChooseBestVehicle-1117"><a href="#Warehouse.ChooseBestVehicle-1117"><span class="linenos">1117</span></a><span class="sd">            Metadata:</span>
</span><span id="Warehouse.ChooseBestVehicle-1118"><a href="#Warehouse.ChooseBestVehicle-1118"><span class="linenos">1118</span></a><span class="sd">                - performative: &quot;order-confirmation&quot;</span>
</span><span id="Warehouse.ChooseBestVehicle-1119"><a href="#Warehouse.ChooseBestVehicle-1119"><span class="linenos">1119</span></a><span class="sd">            Body (JSON):</span>
</span><span id="Warehouse.ChooseBestVehicle-1120"><a href="#Warehouse.ChooseBestVehicle-1120"><span class="linenos">1120</span></a><span class="sd">                ```json</span>
</span><span id="Warehouse.ChooseBestVehicle-1121"><a href="#Warehouse.ChooseBestVehicle-1121"><span class="linenos">1121</span></a><span class="sd">                {</span>
</span><span id="Warehouse.ChooseBestVehicle-1122"><a href="#Warehouse.ChooseBestVehicle-1122"><span class="linenos">1122</span></a><span class="sd">                    &quot;orderid&quot;: 2001000000,</span>
</span><span id="Warehouse.ChooseBestVehicle-1123"><a href="#Warehouse.ChooseBestVehicle-1123"><span class="linenos">1123</span></a><span class="sd">                    &quot;confirmed&quot;: false</span>
</span><span id="Warehouse.ChooseBestVehicle-1124"><a href="#Warehouse.ChooseBestVehicle-1124"><span class="linenos">1124</span></a><span class="sd">                }</span>
</span><span id="Warehouse.ChooseBestVehicle-1125"><a href="#Warehouse.ChooseBestVehicle-1125"><span class="linenos">1125</span></a><span class="sd">                ```</span>
</span><span id="Warehouse.ChooseBestVehicle-1126"><a href="#Warehouse.ChooseBestVehicle-1126"><span class="linenos">1126</span></a><span class="sd">        </span>
</span><span id="Warehouse.ChooseBestVehicle-1127"><a href="#Warehouse.ChooseBestVehicle-1127"><span class="linenos">1127</span></a><span class="sd">        Side Effects:</span>
</span><span id="Warehouse.ChooseBestVehicle-1128"><a href="#Warehouse.ChooseBestVehicle-1128"><span class="linenos">1128</span></a><span class="sd">            - Reads from agent.vehicle_proposals dictionary</span>
</span><span id="Warehouse.ChooseBestVehicle-1129"><a href="#Warehouse.ChooseBestVehicle-1129"><span class="linenos">1129</span></a><span class="sd">            - Reads from agent.pending_deliveries for Order object</span>
</span><span id="Warehouse.ChooseBestVehicle-1130"><a href="#Warehouse.ChooseBestVehicle-1130"><span class="linenos">1130</span></a><span class="sd">            - Sends confirmation message to selected vehicle</span>
</span><span id="Warehouse.ChooseBestVehicle-1131"><a href="#Warehouse.ChooseBestVehicle-1131"><span class="linenos">1131</span></a><span class="sd">            - Sends rejection messages to non-selected vehicles</span>
</span><span id="Warehouse.ChooseBestVehicle-1132"><a href="#Warehouse.ChooseBestVehicle-1132"><span class="linenos">1132</span></a><span class="sd">            - Prints selection decision if verbose mode enabled</span>
</span><span id="Warehouse.ChooseBestVehicle-1133"><a href="#Warehouse.ChooseBestVehicle-1133"><span class="linenos">1133</span></a><span class="sd">        </span>
</span><span id="Warehouse.ChooseBestVehicle-1134"><a href="#Warehouse.ChooseBestVehicle-1134"><span class="linenos">1134</span></a><span class="sd">        Returns:</span>
</span><span id="Warehouse.ChooseBestVehicle-1135"><a href="#Warehouse.ChooseBestVehicle-1135"><span class="linenos">1135</span></a><span class="sd">            None. Completes after sending all confirmation/rejection messages.</span>
</span><span id="Warehouse.ChooseBestVehicle-1136"><a href="#Warehouse.ChooseBestVehicle-1136"><span class="linenos">1136</span></a><span class="sd">        </span>
</span><span id="Warehouse.ChooseBestVehicle-1137"><a href="#Warehouse.ChooseBestVehicle-1137"><span class="linenos">1137</span></a><span class="sd">        Example Execution:</span>
</span><span id="Warehouse.ChooseBestVehicle-1138"><a href="#Warehouse.ChooseBestVehicle-1138"><span class="linenos">1138</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ChooseBestVehicle-1139"><a href="#Warehouse.ChooseBestVehicle-1139"><span class="linenos">1139</span></a><span class="sd">            Proposals Received:</span>
</span><span id="Warehouse.ChooseBestVehicle-1140"><a href="#Warehouse.ChooseBestVehicle-1140"><span class="linenos">1140</span></a><span class="sd">                - vehicle1: (can_fit=True, time=120)</span>
</span><span id="Warehouse.ChooseBestVehicle-1141"><a href="#Warehouse.ChooseBestVehicle-1141"><span class="linenos">1141</span></a><span class="sd">                - vehicle2: (can_fit=True, time=150)</span>
</span><span id="Warehouse.ChooseBestVehicle-1142"><a href="#Warehouse.ChooseBestVehicle-1142"><span class="linenos">1142</span></a><span class="sd">                - vehicle3: (can_fit=False, time=100)</span>
</span><span id="Warehouse.ChooseBestVehicle-1143"><a href="#Warehouse.ChooseBestVehicle-1143"><span class="linenos">1143</span></a><span class="sd">            </span>
</span><span id="Warehouse.ChooseBestVehicle-1144"><a href="#Warehouse.ChooseBestVehicle-1144"><span class="linenos">1144</span></a><span class="sd">            Evaluation:</span>
</span><span id="Warehouse.ChooseBestVehicle-1145"><a href="#Warehouse.ChooseBestVehicle-1145"><span class="linenos">1145</span></a><span class="sd">                - Filter: vehicle1, vehicle2 (can fit)</span>
</span><span id="Warehouse.ChooseBestVehicle-1146"><a href="#Warehouse.ChooseBestVehicle-1146"><span class="linenos">1146</span></a><span class="sd">                - Compare times: 120 &lt; 150</span>
</span><span id="Warehouse.ChooseBestVehicle-1147"><a href="#Warehouse.ChooseBestVehicle-1147"><span class="linenos">1147</span></a><span class="sd">                - Winner: vehicle1</span>
</span><span id="Warehouse.ChooseBestVehicle-1148"><a href="#Warehouse.ChooseBestVehicle-1148"><span class="linenos">1148</span></a><span class="sd">            </span>
</span><span id="Warehouse.ChooseBestVehicle-1149"><a href="#Warehouse.ChooseBestVehicle-1149"><span class="linenos">1149</span></a><span class="sd">            Actions:</span>
</span><span id="Warehouse.ChooseBestVehicle-1150"><a href="#Warehouse.ChooseBestVehicle-1150"><span class="linenos">1150</span></a><span class="sd">                - Send confirmation to vehicle1 (confirmed=true)</span>
</span><span id="Warehouse.ChooseBestVehicle-1151"><a href="#Warehouse.ChooseBestVehicle-1151"><span class="linenos">1151</span></a><span class="sd">                - Send rejection to vehicle2 (confirmed=false)</span>
</span><span id="Warehouse.ChooseBestVehicle-1152"><a href="#Warehouse.ChooseBestVehicle-1152"><span class="linenos">1152</span></a><span class="sd">                - Send rejection to vehicle3 (confirmed=false)</span>
</span><span id="Warehouse.ChooseBestVehicle-1153"><a href="#Warehouse.ChooseBestVehicle-1153"><span class="linenos">1153</span></a><span class="sd">            </span>
</span><span id="Warehouse.ChooseBestVehicle-1154"><a href="#Warehouse.ChooseBestVehicle-1154"><span class="linenos">1154</span></a><span class="sd">            Output:</span>
</span><span id="Warehouse.ChooseBestVehicle-1155"><a href="#Warehouse.ChooseBestVehicle-1155"><span class="linenos">1155</span></a><span class="sd">                - Print: &quot;Best vehicle selected: vehicle1@localhost&quot;</span>
</span><span id="Warehouse.ChooseBestVehicle-1156"><a href="#Warehouse.ChooseBestVehicle-1156"><span class="linenos">1156</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.ChooseBestVehicle-1157"><a href="#Warehouse.ChooseBestVehicle-1157"><span class="linenos">1157</span></a><span class="sd">        </span>
</span><span id="Warehouse.ChooseBestVehicle-1158"><a href="#Warehouse.ChooseBestVehicle-1158"><span class="linenos">1158</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse.ChooseBestVehicle-1159"><a href="#Warehouse.ChooseBestVehicle-1159"><span class="linenos">1159</span></a><span class="sd">            The behaviour waits actively (1-second sleep intervals) until all expected</span>
</span><span id="Warehouse.ChooseBestVehicle-1160"><a href="#Warehouse.ChooseBestVehicle-1160"><span class="linenos">1160</span></a><span class="sd">            proposals arrive before making a decision. This ensures fair comparison</span>
</span><span id="Warehouse.ChooseBestVehicle-1161"><a href="#Warehouse.ChooseBestVehicle-1161"><span class="linenos">1161</span></a><span class="sd">            of all available vehicles.</span>
</span><span id="Warehouse.ChooseBestVehicle-1162"><a href="#Warehouse.ChooseBestVehicle-1162"><span class="linenos">1162</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.ChooseBestVehicle-1163"><a href="#Warehouse.ChooseBestVehicle-1163"><span class="linenos">1163</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">n_sent_messages</span><span class="p">):</span>
</span><span id="Warehouse.ChooseBestVehicle-1164"><a href="#Warehouse.ChooseBestVehicle-1164"><span class="linenos">1164</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.ChooseBestVehicle-1165"><a href="#Warehouse.ChooseBestVehicle-1165"><span class="linenos">1165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Warehouse.ChooseBestVehicle-1166"><a href="#Warehouse.ChooseBestVehicle-1166"><span class="linenos">1166</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span> <span class="o">=</span> <span class="n">n_sent_messages</span>
</span><span id="Warehouse.ChooseBestVehicle-1167"><a href="#Warehouse.ChooseBestVehicle-1167"><span class="linenos">1167</span></a>        
</span><span id="Warehouse.ChooseBestVehicle-1168"><a href="#Warehouse.ChooseBestVehicle-1168"><span class="linenos">1168</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">get_best_vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proposals</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle-1169"><a href="#Warehouse.ChooseBestVehicle-1169"><span class="linenos">1169</span></a>            <span class="c1"># First filter vehicles that can fit the order</span>
</span><span id="Warehouse.ChooseBestVehicle-1170"><a href="#Warehouse.ChooseBestVehicle-1170"><span class="linenos">1170</span></a>            <span class="n">can_fit_vehicles</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="ow">in</span> <span class="n">proposals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">fit</span><span class="p">}</span>
</span><span id="Warehouse.ChooseBestVehicle-1171"><a href="#Warehouse.ChooseBestVehicle-1171"><span class="linenos">1171</span></a>
</span><span id="Warehouse.ChooseBestVehicle-1172"><a href="#Warehouse.ChooseBestVehicle-1172"><span class="linenos">1172</span></a>            <span class="k">if</span> <span class="n">can_fit_vehicles</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle-1173"><a href="#Warehouse.ChooseBestVehicle-1173"><span class="linenos">1173</span></a>                <span class="c1"># If there are vehicles that can fit, choose the one with lowest delivery time</span>
</span><span id="Warehouse.ChooseBestVehicle-1174"><a href="#Warehouse.ChooseBestVehicle-1174"><span class="linenos">1174</span></a>                <span class="n">best_vehicle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">can_fit_vehicles</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Warehouse.ChooseBestVehicle-1175"><a href="#Warehouse.ChooseBestVehicle-1175"><span class="linenos">1175</span></a>                <span class="k">return</span> <span class="n">best_vehicle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Warehouse.ChooseBestVehicle-1176"><a href="#Warehouse.ChooseBestVehicle-1176"><span class="linenos">1176</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle-1177"><a href="#Warehouse.ChooseBestVehicle-1177"><span class="linenos">1177</span></a>                <span class="c1"># If no vehicles can fit, choose the one with lowest delivery time anyway</span>
</span><span id="Warehouse.ChooseBestVehicle-1178"><a href="#Warehouse.ChooseBestVehicle-1178"><span class="linenos">1178</span></a>                <span class="k">if</span> <span class="n">proposals</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle-1179"><a href="#Warehouse.ChooseBestVehicle-1179"><span class="linenos">1179</span></a>                    <span class="n">best_vehicle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">proposals</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Warehouse.ChooseBestVehicle-1180"><a href="#Warehouse.ChooseBestVehicle-1180"><span class="linenos">1180</span></a>                    <span class="k">return</span> <span class="n">best_vehicle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Warehouse.ChooseBestVehicle-1181"><a href="#Warehouse.ChooseBestVehicle-1181"><span class="linenos">1181</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="Warehouse.ChooseBestVehicle-1182"><a href="#Warehouse.ChooseBestVehicle-1182"><span class="linenos">1182</span></a>        
</span><span id="Warehouse.ChooseBestVehicle-1183"><a href="#Warehouse.ChooseBestVehicle-1183"><span class="linenos">1183</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ChooseBestVehicle-1184"><a href="#Warehouse.ChooseBestVehicle-1184"><span class="linenos">1184</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ChooseBestVehicle-1185"><a href="#Warehouse.ChooseBestVehicle-1185"><span class="linenos">1185</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle-1186"><a href="#Warehouse.ChooseBestVehicle-1186"><span class="linenos">1186</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Comparing vehicle proposals...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1187"><a href="#Warehouse.ChooseBestVehicle-1187"><span class="linenos">1187</span></a>            
</span><span id="Warehouse.ChooseBestVehicle-1188"><a href="#Warehouse.ChooseBestVehicle-1188"><span class="linenos">1188</span></a>            <span class="c1"># Verificar se a entrada para este order_id existe, se no criar</span>
</span><span id="Warehouse.ChooseBestVehicle-1189"><a href="#Warehouse.ChooseBestVehicle-1189"><span class="linenos">1189</span></a>            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle-1190"><a href="#Warehouse.ChooseBestVehicle-1190"><span class="linenos">1190</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse.ChooseBestVehicle-1191"><a href="#Warehouse.ChooseBestVehicle-1191"><span class="linenos">1191</span></a>            
</span><span id="Warehouse.ChooseBestVehicle-1192"><a href="#Warehouse.ChooseBestVehicle-1192"><span class="linenos">1192</span></a>            <span class="n">proposals</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)]</span> <span class="c1"># vehicle_jid : (can_fit, time)</span>
</span><span id="Warehouse.ChooseBestVehicle-1193"><a href="#Warehouse.ChooseBestVehicle-1193"><span class="linenos">1193</span></a>            
</span><span id="Warehouse.ChooseBestVehicle-1194"><a href="#Warehouse.ChooseBestVehicle-1194"><span class="linenos">1194</span></a>            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle-1195"><a href="#Warehouse.ChooseBestVehicle-1195"><span class="linenos">1195</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle-1196"><a href="#Warehouse.ChooseBestVehicle-1196"><span class="linenos">1196</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Waiting for more proposals... &quot;</span>
</span><span id="Warehouse.ChooseBestVehicle-1197"><a href="#Warehouse.ChooseBestVehicle-1197"><span class="linenos">1197</span></a>                          <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1198"><a href="#Warehouse.ChooseBestVehicle-1198"><span class="linenos">1198</span></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1199"><a href="#Warehouse.ChooseBestVehicle-1199"><span class="linenos">1199</span></a>                <span class="n">proposals</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)]</span>
</span><span id="Warehouse.ChooseBestVehicle-1200"><a href="#Warehouse.ChooseBestVehicle-1200"><span class="linenos">1200</span></a>            
</span><span id="Warehouse.ChooseBestVehicle-1201"><a href="#Warehouse.ChooseBestVehicle-1201"><span class="linenos">1201</span></a>
</span><span id="Warehouse.ChooseBestVehicle-1202"><a href="#Warehouse.ChooseBestVehicle-1202"><span class="linenos">1202</span></a>            
</span><span id="Warehouse.ChooseBestVehicle-1203"><a href="#Warehouse.ChooseBestVehicle-1203"><span class="linenos">1203</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle-1204"><a href="#Warehouse.ChooseBestVehicle-1204"><span class="linenos">1204</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Total proposals received: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1205"><a href="#Warehouse.ChooseBestVehicle-1205"><span class="linenos">1205</span></a>            <span class="n">best_vehicle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_best_vehicle</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1206"><a href="#Warehouse.ChooseBestVehicle-1206"><span class="linenos">1206</span></a>            
</span><span id="Warehouse.ChooseBestVehicle-1207"><a href="#Warehouse.ChooseBestVehicle-1207"><span class="linenos">1207</span></a>            <span class="k">if</span> <span class="n">best_vehicle</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle-1208"><a href="#Warehouse.ChooseBestVehicle-1208"><span class="linenos">1208</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Best vehicle selected: </span><span class="si">{</span><span class="n">best_vehicle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1209"><a href="#Warehouse.ChooseBestVehicle-1209"><span class="linenos">1209</span></a>                
</span><span id="Warehouse.ChooseBestVehicle-1210"><a href="#Warehouse.ChooseBestVehicle-1210"><span class="linenos">1210</span></a>                <span class="c1"># Send confirmation to the selected vehicle</span>
</span><span id="Warehouse.ChooseBestVehicle-1211"><a href="#Warehouse.ChooseBestVehicle-1211"><span class="linenos">1211</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">best_vehicle</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1212"><a href="#Warehouse.ChooseBestVehicle-1212"><span class="linenos">1212</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;order-confirmation&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1213"><a href="#Warehouse.ChooseBestVehicle-1213"><span class="linenos">1213</span></a>                
</span><span id="Warehouse.ChooseBestVehicle-1214"><a href="#Warehouse.ChooseBestVehicle-1214"><span class="linenos">1214</span></a>                <span class="n">order</span> <span class="p">:</span> <span class="n">Order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">]</span>
</span><span id="Warehouse.ChooseBestVehicle-1215"><a href="#Warehouse.ChooseBestVehicle-1215"><span class="linenos">1215</span></a>                <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Warehouse.ChooseBestVehicle-1216"><a href="#Warehouse.ChooseBestVehicle-1216"><span class="linenos">1216</span></a>                    <span class="s2">&quot;orderid&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span>
</span><span id="Warehouse.ChooseBestVehicle-1217"><a href="#Warehouse.ChooseBestVehicle-1217"><span class="linenos">1217</span></a>                    <span class="s2">&quot;confirmed&quot;</span> <span class="p">:</span> <span class="kc">True</span>
</span><span id="Warehouse.ChooseBestVehicle-1218"><a href="#Warehouse.ChooseBestVehicle-1218"><span class="linenos">1218</span></a>                <span class="p">}</span>
</span><span id="Warehouse.ChooseBestVehicle-1219"><a href="#Warehouse.ChooseBestVehicle-1219"><span class="linenos">1219</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1220"><a href="#Warehouse.ChooseBestVehicle-1220"><span class="linenos">1220</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1221"><a href="#Warehouse.ChooseBestVehicle-1221"><span class="linenos">1221</span></a>                
</span><span id="Warehouse.ChooseBestVehicle-1222"><a href="#Warehouse.ChooseBestVehicle-1222"><span class="linenos">1222</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle-1223"><a href="#Warehouse.ChooseBestVehicle-1223"><span class="linenos">1223</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Confirmation sent to </span><span class="si">{</span><span class="n">best_vehicle</span><span class="si">}</span><span class="s2"> for order </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1224"><a href="#Warehouse.ChooseBestVehicle-1224"><span class="linenos">1224</span></a>                
</span><span id="Warehouse.ChooseBestVehicle-1225"><a href="#Warehouse.ChooseBestVehicle-1225"><span class="linenos">1225</span></a>                <span class="c1"># Send rejection to all other vehicles</span>
</span><span id="Warehouse.ChooseBestVehicle-1226"><a href="#Warehouse.ChooseBestVehicle-1226"><span class="linenos">1226</span></a>                <span class="n">rejected_vehicles</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">proposals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">jid</span> <span class="o">!=</span> <span class="n">best_vehicle</span><span class="p">]</span>
</span><span id="Warehouse.ChooseBestVehicle-1227"><a href="#Warehouse.ChooseBestVehicle-1227"><span class="linenos">1227</span></a>                <span class="k">for</span> <span class="n">vehicle_jid</span> <span class="ow">in</span> <span class="n">rejected_vehicles</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle-1228"><a href="#Warehouse.ChooseBestVehicle-1228"><span class="linenos">1228</span></a>                    <span class="n">reject_msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1229"><a href="#Warehouse.ChooseBestVehicle-1229"><span class="linenos">1229</span></a>                    <span class="n">reject_msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;order-confirmation&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1230"><a href="#Warehouse.ChooseBestVehicle-1230"><span class="linenos">1230</span></a>                    
</span><span id="Warehouse.ChooseBestVehicle-1231"><a href="#Warehouse.ChooseBestVehicle-1231"><span class="linenos">1231</span></a>                    <span class="n">reject_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Warehouse.ChooseBestVehicle-1232"><a href="#Warehouse.ChooseBestVehicle-1232"><span class="linenos">1232</span></a>                    <span class="s2">&quot;orderid&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span>
</span><span id="Warehouse.ChooseBestVehicle-1233"><a href="#Warehouse.ChooseBestVehicle-1233"><span class="linenos">1233</span></a>                    <span class="s2">&quot;confirmed&quot;</span> <span class="p">:</span> <span class="kc">False</span>
</span><span id="Warehouse.ChooseBestVehicle-1234"><a href="#Warehouse.ChooseBestVehicle-1234"><span class="linenos">1234</span></a>                    <span class="p">}</span>
</span><span id="Warehouse.ChooseBestVehicle-1235"><a href="#Warehouse.ChooseBestVehicle-1235"><span class="linenos">1235</span></a>                    
</span><span id="Warehouse.ChooseBestVehicle-1236"><a href="#Warehouse.ChooseBestVehicle-1236"><span class="linenos">1236</span></a>                    <span class="n">reject_msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">reject_data</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle-1237"><a href="#Warehouse.ChooseBestVehicle-1237"><span class="linenos">1237</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">reject_msg</span><span class="p">)</span>                        
</span></pre></div>


            <div class="docstring"><p>Behaviour that evaluates vehicle proposals and selects the optimal vehicle for delivery.</p>

<p>This behaviour implements the proposal evaluation and winner selection phase of
vehicle assignment. After collecting all vehicle proposals via ReceiveVehicleProposals,
this behaviour compares them based on capacity and delivery time, then notifies
the selected vehicle and rejects all others.</p>

<h6 id="selection-algorithm">Selection Algorithm:</h6>

<blockquote>
  <ol>
  <li><strong>Priority 1</strong>: Filter vehicles that can fit the order (can_fit=True)</li>
  <li><strong>Priority 2</strong>: Among fitting vehicles, select one with minimum delivery_time</li>
  <li><strong>Fallback</strong>: If no vehicles can fit, select vehicle with minimum delivery_time anyway</li>
  </ol>
</blockquote>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>request_id (int):</strong>  Unique order identifier to find proposals.</li>
<li><strong>n_sent_messages (int):</strong>  Expected number of vehicle responses to wait for.</li>
</ul>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Wait for Proposals</strong>: Loop until n_sent_messages proposals received</li>
  <li><strong>Evaluate Proposals</strong>: Call get_best_vehicle() to select winner</li>
  <li><strong>Send Confirmation</strong>: Notify selected vehicle with order-confirmation</li>
  <li><strong>Send Rejections</strong>: Notify all other vehicles they were not selected</li>
  </ol>
</blockquote>

<p>Message Format (Confirmation):
    Metadata:
        - performative: "order-confirmation"
    Body (JSON):</p>

<pre><code>    <div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;orderid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2001000000</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;confirmed&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>
</code></pre>
</div>
</code></pre>

<p>Message Format (Rejection):
    Metadata:
        - performative: "order-confirmation"
    Body (JSON):</p>

<pre><code>    <div class="pdoc-code codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;orderid&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2001000000</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;confirmed&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</code></pre>
</div>
</code></pre>

<h6 id="side-effects">Side Effects:</h6>

<blockquote>
  <ul>
  <li>Reads from agent.vehicle_proposals dictionary</li>
  <li>Reads from agent.pending_deliveries for Order object</li>
  <li>Sends confirmation message to selected vehicle</li>
  <li>Sends rejection messages to non-selected vehicles</li>
  <li>Prints selection decision if verbose mode enabled</li>
  </ul>
</blockquote>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None. Completes after sending all confirmation/rejection messages.</p>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
<pre><code>Proposals Received:
    - vehicle1: (can_fit=True, time=120)
    - vehicle2: (can_fit=True, time=150)
    - vehicle3: (can_fit=False, time=100)

Evaluation:
    - Filter: vehicle1, vehicle2 (can fit)
    - Compare times: 120 &lt; 150
    - Winner: vehicle1

Actions:
    - Send confirmation to vehicle1 (confirmed=true)
    - Send rejection to vehicle2 (confirmed=false)
    - Send rejection to vehicle3 (confirmed=false)

Output:
    - Print: "Best vehicle selected: vehicle1@localhost"
</code></pre>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>The behaviour waits actively (1-second sleep intervals) until all expected
  proposals arrive before making a decision. This ensures fair comparison
  of all available vehicles.</p>
</blockquote>
</div>


                            <div id="Warehouse.ChooseBestVehicle.__init__" class="classattr">
                                        <input id="Warehouse.ChooseBestVehicle.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Warehouse.ChooseBestVehicle</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">request_id</span>, </span><span class="param"><span class="n">n_sent_messages</span></span>)</span>

                <label class="view-source-button" for="Warehouse.ChooseBestVehicle.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ChooseBestVehicle.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ChooseBestVehicle.__init__-1163"><a href="#Warehouse.ChooseBestVehicle.__init__-1163"><span class="linenos">1163</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">n_sent_messages</span><span class="p">):</span>
</span><span id="Warehouse.ChooseBestVehicle.__init__-1164"><a href="#Warehouse.ChooseBestVehicle.__init__-1164"><span class="linenos">1164</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.ChooseBestVehicle.__init__-1165"><a href="#Warehouse.ChooseBestVehicle.__init__-1165"><span class="linenos">1165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Warehouse.ChooseBestVehicle.__init__-1166"><a href="#Warehouse.ChooseBestVehicle.__init__-1166"><span class="linenos">1166</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span> <span class="o">=</span> <span class="n">n_sent_messages</span>
</span></pre></div>


    

                            </div>
                            <div id="Warehouse.ChooseBestVehicle.request_id" class="classattr">
                                <div class="attr variable">
            <span class="name">request_id</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.ChooseBestVehicle.request_id"></a>
    
    

                            </div>
                            <div id="Warehouse.ChooseBestVehicle.n_sent_messages" class="classattr">
                                <div class="attr variable">
            <span class="name">n_sent_messages</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.ChooseBestVehicle.n_sent_messages"></a>
    
    

                            </div>
                            <div id="Warehouse.ChooseBestVehicle.get_best_vehicle" class="classattr">
                                        <input id="Warehouse.ChooseBestVehicle.get_best_vehicle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_best_vehicle</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">proposals</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Warehouse.ChooseBestVehicle.get_best_vehicle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ChooseBestVehicle.get_best_vehicle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1168"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1168"><span class="linenos">1168</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">get_best_vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proposals</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1169"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1169"><span class="linenos">1169</span></a>            <span class="c1"># First filter vehicles that can fit the order</span>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1170"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1170"><span class="linenos">1170</span></a>            <span class="n">can_fit_vehicles</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="ow">in</span> <span class="n">proposals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">fit</span><span class="p">}</span>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1171"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1171"><span class="linenos">1171</span></a>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1172"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1172"><span class="linenos">1172</span></a>            <span class="k">if</span> <span class="n">can_fit_vehicles</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1173"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1173"><span class="linenos">1173</span></a>                <span class="c1"># If there are vehicles that can fit, choose the one with lowest delivery time</span>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1174"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1174"><span class="linenos">1174</span></a>                <span class="n">best_vehicle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">can_fit_vehicles</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1175"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1175"><span class="linenos">1175</span></a>                <span class="k">return</span> <span class="n">best_vehicle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1176"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1176"><span class="linenos">1176</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1177"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1177"><span class="linenos">1177</span></a>                <span class="c1"># If no vehicles can fit, choose the one with lowest delivery time anyway</span>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1178"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1178"><span class="linenos">1178</span></a>                <span class="k">if</span> <span class="n">proposals</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1179"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1179"><span class="linenos">1179</span></a>                    <span class="n">best_vehicle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">proposals</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1180"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1180"><span class="linenos">1180</span></a>                    <span class="k">return</span> <span class="n">best_vehicle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Warehouse.ChooseBestVehicle.get_best_vehicle-1181"><a href="#Warehouse.ChooseBestVehicle.get_best_vehicle-1181"><span class="linenos">1181</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div id="Warehouse.ChooseBestVehicle.run" class="classattr">
                                        <input id="Warehouse.ChooseBestVehicle.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.ChooseBestVehicle.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ChooseBestVehicle.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ChooseBestVehicle.run-1183"><a href="#Warehouse.ChooseBestVehicle.run-1183"><span class="linenos">1183</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1184"><a href="#Warehouse.ChooseBestVehicle.run-1184"><span class="linenos">1184</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1185"><a href="#Warehouse.ChooseBestVehicle.run-1185"><span class="linenos">1185</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1186"><a href="#Warehouse.ChooseBestVehicle.run-1186"><span class="linenos">1186</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Comparing vehicle proposals...&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1187"><a href="#Warehouse.ChooseBestVehicle.run-1187"><span class="linenos">1187</span></a>            
</span><span id="Warehouse.ChooseBestVehicle.run-1188"><a href="#Warehouse.ChooseBestVehicle.run-1188"><span class="linenos">1188</span></a>            <span class="c1"># Verificar se a entrada para este order_id existe, se no criar</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1189"><a href="#Warehouse.ChooseBestVehicle.run-1189"><span class="linenos">1189</span></a>            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1190"><a href="#Warehouse.ChooseBestVehicle.run-1190"><span class="linenos">1190</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1191"><a href="#Warehouse.ChooseBestVehicle.run-1191"><span class="linenos">1191</span></a>            
</span><span id="Warehouse.ChooseBestVehicle.run-1192"><a href="#Warehouse.ChooseBestVehicle.run-1192"><span class="linenos">1192</span></a>            <span class="n">proposals</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)]</span> <span class="c1"># vehicle_jid : (can_fit, time)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1193"><a href="#Warehouse.ChooseBestVehicle.run-1193"><span class="linenos">1193</span></a>            
</span><span id="Warehouse.ChooseBestVehicle.run-1194"><a href="#Warehouse.ChooseBestVehicle.run-1194"><span class="linenos">1194</span></a>            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1195"><a href="#Warehouse.ChooseBestVehicle.run-1195"><span class="linenos">1195</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1196"><a href="#Warehouse.ChooseBestVehicle.run-1196"><span class="linenos">1196</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Waiting for more proposals... &quot;</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1197"><a href="#Warehouse.ChooseBestVehicle.run-1197"><span class="linenos">1197</span></a>                          <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sent_messages</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1198"><a href="#Warehouse.ChooseBestVehicle.run-1198"><span class="linenos">1198</span></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1199"><a href="#Warehouse.ChooseBestVehicle.run-1199"><span class="linenos">1199</span></a>                <span class="n">proposals</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">vehicle_proposals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">)]</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1200"><a href="#Warehouse.ChooseBestVehicle.run-1200"><span class="linenos">1200</span></a>            
</span><span id="Warehouse.ChooseBestVehicle.run-1201"><a href="#Warehouse.ChooseBestVehicle.run-1201"><span class="linenos">1201</span></a>
</span><span id="Warehouse.ChooseBestVehicle.run-1202"><a href="#Warehouse.ChooseBestVehicle.run-1202"><span class="linenos">1202</span></a>            
</span><span id="Warehouse.ChooseBestVehicle.run-1203"><a href="#Warehouse.ChooseBestVehicle.run-1203"><span class="linenos">1203</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1204"><a href="#Warehouse.ChooseBestVehicle.run-1204"><span class="linenos">1204</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Total proposals received: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1205"><a href="#Warehouse.ChooseBestVehicle.run-1205"><span class="linenos">1205</span></a>            <span class="n">best_vehicle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_best_vehicle</span><span class="p">(</span><span class="n">proposals</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1206"><a href="#Warehouse.ChooseBestVehicle.run-1206"><span class="linenos">1206</span></a>            
</span><span id="Warehouse.ChooseBestVehicle.run-1207"><a href="#Warehouse.ChooseBestVehicle.run-1207"><span class="linenos">1207</span></a>            <span class="k">if</span> <span class="n">best_vehicle</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1208"><a href="#Warehouse.ChooseBestVehicle.run-1208"><span class="linenos">1208</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Best vehicle selected: </span><span class="si">{</span><span class="n">best_vehicle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1209"><a href="#Warehouse.ChooseBestVehicle.run-1209"><span class="linenos">1209</span></a>                
</span><span id="Warehouse.ChooseBestVehicle.run-1210"><a href="#Warehouse.ChooseBestVehicle.run-1210"><span class="linenos">1210</span></a>                <span class="c1"># Send confirmation to the selected vehicle</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1211"><a href="#Warehouse.ChooseBestVehicle.run-1211"><span class="linenos">1211</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">best_vehicle</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1212"><a href="#Warehouse.ChooseBestVehicle.run-1212"><span class="linenos">1212</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;order-confirmation&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1213"><a href="#Warehouse.ChooseBestVehicle.run-1213"><span class="linenos">1213</span></a>                
</span><span id="Warehouse.ChooseBestVehicle.run-1214"><a href="#Warehouse.ChooseBestVehicle.run-1214"><span class="linenos">1214</span></a>                <span class="n">order</span> <span class="p">:</span> <span class="n">Order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">]</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1215"><a href="#Warehouse.ChooseBestVehicle.run-1215"><span class="linenos">1215</span></a>                <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1216"><a href="#Warehouse.ChooseBestVehicle.run-1216"><span class="linenos">1216</span></a>                    <span class="s2">&quot;orderid&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1217"><a href="#Warehouse.ChooseBestVehicle.run-1217"><span class="linenos">1217</span></a>                    <span class="s2">&quot;confirmed&quot;</span> <span class="p">:</span> <span class="kc">True</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1218"><a href="#Warehouse.ChooseBestVehicle.run-1218"><span class="linenos">1218</span></a>                <span class="p">}</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1219"><a href="#Warehouse.ChooseBestVehicle.run-1219"><span class="linenos">1219</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1220"><a href="#Warehouse.ChooseBestVehicle.run-1220"><span class="linenos">1220</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1221"><a href="#Warehouse.ChooseBestVehicle.run-1221"><span class="linenos">1221</span></a>                
</span><span id="Warehouse.ChooseBestVehicle.run-1222"><a href="#Warehouse.ChooseBestVehicle.run-1222"><span class="linenos">1222</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1223"><a href="#Warehouse.ChooseBestVehicle.run-1223"><span class="linenos">1223</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt;  Confirmation sent to </span><span class="si">{</span><span class="n">best_vehicle</span><span class="si">}</span><span class="s2"> for order </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1224"><a href="#Warehouse.ChooseBestVehicle.run-1224"><span class="linenos">1224</span></a>                
</span><span id="Warehouse.ChooseBestVehicle.run-1225"><a href="#Warehouse.ChooseBestVehicle.run-1225"><span class="linenos">1225</span></a>                <span class="c1"># Send rejection to all other vehicles</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1226"><a href="#Warehouse.ChooseBestVehicle.run-1226"><span class="linenos">1226</span></a>                <span class="n">rejected_vehicles</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">proposals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">jid</span> <span class="o">!=</span> <span class="n">best_vehicle</span><span class="p">]</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1227"><a href="#Warehouse.ChooseBestVehicle.run-1227"><span class="linenos">1227</span></a>                <span class="k">for</span> <span class="n">vehicle_jid</span> <span class="ow">in</span> <span class="n">rejected_vehicles</span><span class="p">:</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1228"><a href="#Warehouse.ChooseBestVehicle.run-1228"><span class="linenos">1228</span></a>                    <span class="n">reject_msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">vehicle_jid</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1229"><a href="#Warehouse.ChooseBestVehicle.run-1229"><span class="linenos">1229</span></a>                    <span class="n">reject_msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;order-confirmation&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1230"><a href="#Warehouse.ChooseBestVehicle.run-1230"><span class="linenos">1230</span></a>                    
</span><span id="Warehouse.ChooseBestVehicle.run-1231"><a href="#Warehouse.ChooseBestVehicle.run-1231"><span class="linenos">1231</span></a>                    <span class="n">reject_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1232"><a href="#Warehouse.ChooseBestVehicle.run-1232"><span class="linenos">1232</span></a>                    <span class="s2">&quot;orderid&quot;</span> <span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1233"><a href="#Warehouse.ChooseBestVehicle.run-1233"><span class="linenos">1233</span></a>                    <span class="s2">&quot;confirmed&quot;</span> <span class="p">:</span> <span class="kc">False</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1234"><a href="#Warehouse.ChooseBestVehicle.run-1234"><span class="linenos">1234</span></a>                    <span class="p">}</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1235"><a href="#Warehouse.ChooseBestVehicle.run-1235"><span class="linenos">1235</span></a>                    
</span><span id="Warehouse.ChooseBestVehicle.run-1236"><a href="#Warehouse.ChooseBestVehicle.run-1236"><span class="linenos">1236</span></a>                    <span class="n">reject_msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">reject_data</span><span class="p">)</span>
</span><span id="Warehouse.ChooseBestVehicle.run-1237"><a href="#Warehouse.ChooseBestVehicle.run-1237"><span class="linenos">1237</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">reject_msg</span><span class="p">)</span>                        
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.BuyMaterial">
                            <input id="Warehouse.BuyMaterial-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.BuyMaterial</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Warehouse.BuyMaterial-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.BuyMaterial"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.BuyMaterial-1243"><a href="#Warehouse.BuyMaterial-1243"><span class="linenos">1243</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">BuyMaterial</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.BuyMaterial-1244"><a href="#Warehouse.BuyMaterial-1244"><span class="linenos">1244</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.BuyMaterial-1245"><a href="#Warehouse.BuyMaterial-1245"><span class="linenos">1245</span></a><span class="sd">        Behaviour that initiates material purchase from suppliers (FIPA CFP - Initiator Role).</span>
</span><span id="Warehouse.BuyMaterial-1246"><a href="#Warehouse.BuyMaterial-1246"><span class="linenos">1246</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1247"><a href="#Warehouse.BuyMaterial-1247"><span class="linenos">1247</span></a><span class="sd">        This behaviour implements the FIPA Contract Net Protocol with the warehouse acting</span>
</span><span id="Warehouse.BuyMaterial-1248"><a href="#Warehouse.BuyMaterial-1248"><span class="linenos">1248</span></a><span class="sd">        as the INITIATOR role. The warehouse broadcasts a Call For Proposals (CFP) to</span>
</span><span id="Warehouse.BuyMaterial-1249"><a href="#Warehouse.BuyMaterial-1249"><span class="linenos">1249</span></a><span class="sd">        suppliers to replenish inventory. This is the dual role mentioned in the class</span>
</span><span id="Warehouse.BuyMaterial-1250"><a href="#Warehouse.BuyMaterial-1250"><span class="linenos">1250</span></a><span class="sd">        docstring - the warehouse is a participant when dealing with stores but becomes</span>
</span><span id="Warehouse.BuyMaterial-1251"><a href="#Warehouse.BuyMaterial-1251"><span class="linenos">1251</span></a><span class="sd">        an initiator when dealing with suppliers.</span>
</span><span id="Warehouse.BuyMaterial-1252"><a href="#Warehouse.BuyMaterial-1252"><span class="linenos">1252</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1253"><a href="#Warehouse.BuyMaterial-1253"><span class="linenos">1253</span></a><span class="sd">        FIPA Protocol: **Contract Net - Initiator Role**</span>
</span><span id="Warehouse.BuyMaterial-1254"><a href="#Warehouse.BuyMaterial-1254"><span class="linenos">1254</span></a><span class="sd">            - Role: Initiator (Warehouse requesting materials from Suppliers)</span>
</span><span id="Warehouse.BuyMaterial-1255"><a href="#Warehouse.BuyMaterial-1255"><span class="linenos">1255</span></a><span class="sd">            - Sends: warehouse-buy (FIPA CFP) with quantity and product</span>
</span><span id="Warehouse.BuyMaterial-1256"><a href="#Warehouse.BuyMaterial-1256"><span class="linenos">1256</span></a><span class="sd">            - Receives: supplier-accept (FIPA propose) or supplier-reject (FIPA refuse)</span>
</span><span id="Warehouse.BuyMaterial-1257"><a href="#Warehouse.BuyMaterial-1257"><span class="linenos">1257</span></a><span class="sd">            - Selection: Choose best supplier based on price and availability</span>
</span><span id="Warehouse.BuyMaterial-1258"><a href="#Warehouse.BuyMaterial-1258"><span class="linenos">1258</span></a><span class="sd">            - Award: Send warehouse-confirm (FIPA accept-proposal) to winner</span>
</span><span id="Warehouse.BuyMaterial-1259"><a href="#Warehouse.BuyMaterial-1259"><span class="linenos">1259</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1260"><a href="#Warehouse.BuyMaterial-1260"><span class="linenos">1260</span></a><span class="sd">        Dual FIPA Role Context:</span>
</span><span id="Warehouse.BuyMaterial-1261"><a href="#Warehouse.BuyMaterial-1261"><span class="linenos">1261</span></a><span class="sd">            - **As Participant** (Store  Warehouse): Warehouse responds to store CFPs</span>
</span><span id="Warehouse.BuyMaterial-1262"><a href="#Warehouse.BuyMaterial-1262"><span class="linenos">1262</span></a><span class="sd">            - **As Initiator** (Warehouse  Supplier): Warehouse sends CFPs to suppliers</span>
</span><span id="Warehouse.BuyMaterial-1263"><a href="#Warehouse.BuyMaterial-1263"><span class="linenos">1263</span></a><span class="sd">            </span>
</span><span id="Warehouse.BuyMaterial-1264"><a href="#Warehouse.BuyMaterial-1264"><span class="linenos">1264</span></a><span class="sd">            This dual role makes the warehouse a critical intermediary in the supply chain,</span>
</span><span id="Warehouse.BuyMaterial-1265"><a href="#Warehouse.BuyMaterial-1265"><span class="linenos">1265</span></a><span class="sd">            translating downstream demand into upstream procurement.</span>
</span><span id="Warehouse.BuyMaterial-1266"><a href="#Warehouse.BuyMaterial-1266"><span class="linenos">1266</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1267"><a href="#Warehouse.BuyMaterial-1267"><span class="linenos">1267</span></a><span class="sd">        Attributes:</span>
</span><span id="Warehouse.BuyMaterial-1268"><a href="#Warehouse.BuyMaterial-1268"><span class="linenos">1268</span></a><span class="sd">            quantity (int): Amount of material to purchase from suppliers.</span>
</span><span id="Warehouse.BuyMaterial-1269"><a href="#Warehouse.BuyMaterial-1269"><span class="linenos">1269</span></a><span class="sd">            product (str): Type of material/product needed for restocking.</span>
</span><span id="Warehouse.BuyMaterial-1270"><a href="#Warehouse.BuyMaterial-1270"><span class="linenos">1270</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1271"><a href="#Warehouse.BuyMaterial-1271"><span class="linenos">1271</span></a><span class="sd">        Message Format (warehouse-buy):</span>
</span><span id="Warehouse.BuyMaterial-1272"><a href="#Warehouse.BuyMaterial-1272"><span class="linenos">1272</span></a><span class="sd">            Metadata:</span>
</span><span id="Warehouse.BuyMaterial-1273"><a href="#Warehouse.BuyMaterial-1273"><span class="linenos">1273</span></a><span class="sd">                - performative: &quot;warehouse-buy&quot; (FIPA CFP)</span>
</span><span id="Warehouse.BuyMaterial-1274"><a href="#Warehouse.BuyMaterial-1274"><span class="linenos">1274</span></a><span class="sd">                - warehouse_id: This warehouse&#39;s JID</span>
</span><span id="Warehouse.BuyMaterial-1275"><a href="#Warehouse.BuyMaterial-1275"><span class="linenos">1275</span></a><span class="sd">                - request_id: Unique request identifier (ID encoding)</span>
</span><span id="Warehouse.BuyMaterial-1276"><a href="#Warehouse.BuyMaterial-1276"><span class="linenos">1276</span></a><span class="sd">            Body:</span>
</span><span id="Warehouse.BuyMaterial-1277"><a href="#Warehouse.BuyMaterial-1277"><span class="linenos">1277</span></a><span class="sd">                - Format: &quot;{quantity} {product}&quot;</span>
</span><span id="Warehouse.BuyMaterial-1278"><a href="#Warehouse.BuyMaterial-1278"><span class="linenos">1278</span></a><span class="sd">                - Example: &quot;100 raw_materials&quot;</span>
</span><span id="Warehouse.BuyMaterial-1279"><a href="#Warehouse.BuyMaterial-1279"><span class="linenos">1279</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1280"><a href="#Warehouse.BuyMaterial-1280"><span class="linenos">1280</span></a><span class="sd">        ID Encoding for Request:</span>
</span><span id="Warehouse.BuyMaterial-1281"><a href="#Warehouse.BuyMaterial-1281"><span class="linenos">1281</span></a><span class="sd">            Uses the warehouse&#39;s ID encoding scheme:</span>
</span><span id="Warehouse.BuyMaterial-1282"><a href="#Warehouse.BuyMaterial-1282"><span class="linenos">1282</span></a><span class="sd">            - request_id = warehouse.id_base + warehouse.request_counter</span>
</span><span id="Warehouse.BuyMaterial-1283"><a href="#Warehouse.BuyMaterial-1283"><span class="linenos">1283</span></a><span class="sd">            - Format: 1 (warehouse type) * 100_000_000 + instance * 1_000_000 + counter</span>
</span><span id="Warehouse.BuyMaterial-1284"><a href="#Warehouse.BuyMaterial-1284"><span class="linenos">1284</span></a><span class="sd">            - Example: 101000000 (warehouse 1, request 0)</span>
</span><span id="Warehouse.BuyMaterial-1285"><a href="#Warehouse.BuyMaterial-1285"><span class="linenos">1285</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1286"><a href="#Warehouse.BuyMaterial-1286"><span class="linenos">1286</span></a><span class="sd">        Workflow:</span>
</span><span id="Warehouse.BuyMaterial-1287"><a href="#Warehouse.BuyMaterial-1287"><span class="linenos">1287</span></a><span class="sd">            1. **Populate Suppliers**: Auto-discover suppliers from presence contacts</span>
</span><span id="Warehouse.BuyMaterial-1288"><a href="#Warehouse.BuyMaterial-1288"><span class="linenos">1288</span></a><span class="sd">            2. **Generate Request ID**: Create unique ID for this procurement</span>
</span><span id="Warehouse.BuyMaterial-1289"><a href="#Warehouse.BuyMaterial-1289"><span class="linenos">1289</span></a><span class="sd">            3. **Broadcast CFP**: Send warehouse-buy to all available suppliers</span>
</span><span id="Warehouse.BuyMaterial-1290"><a href="#Warehouse.BuyMaterial-1290"><span class="linenos">1290</span></a><span class="sd">            4. **Set Metadata**: Store request for retry mechanism (current_buy_request)</span>
</span><span id="Warehouse.BuyMaterial-1291"><a href="#Warehouse.BuyMaterial-1291"><span class="linenos">1291</span></a><span class="sd">            5. **Launch Coordinator**: Start CollectSupplierResponses to gather proposals</span>
</span><span id="Warehouse.BuyMaterial-1292"><a href="#Warehouse.BuyMaterial-1292"><span class="linenos">1292</span></a><span class="sd">            6. **Non-blocking**: Return immediately (coordinator handles responses)</span>
</span><span id="Warehouse.BuyMaterial-1293"><a href="#Warehouse.BuyMaterial-1293"><span class="linenos">1293</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1294"><a href="#Warehouse.BuyMaterial-1294"><span class="linenos">1294</span></a><span class="sd">        Coordinator/Worker Pattern:</span>
</span><span id="Warehouse.BuyMaterial-1295"><a href="#Warehouse.BuyMaterial-1295"><span class="linenos">1295</span></a><span class="sd">            - **Initiator (this)**: Sends CFP and launches coordinator</span>
</span><span id="Warehouse.BuyMaterial-1296"><a href="#Warehouse.BuyMaterial-1296"><span class="linenos">1296</span></a><span class="sd">            - **Coordinator**: CollectSupplierResponses (manages collection process)</span>
</span><span id="Warehouse.BuyMaterial-1297"><a href="#Warehouse.BuyMaterial-1297"><span class="linenos">1297</span></a><span class="sd">            - **Worker**: ReceiveAllSupplierResponses (collects individual proposals)</span>
</span><span id="Warehouse.BuyMaterial-1298"><a href="#Warehouse.BuyMaterial-1298"><span class="linenos">1298</span></a><span class="sd">            - **Decision**: SendWarehouseConfirmation (award) or SendWarehouseDenial (reject)</span>
</span><span id="Warehouse.BuyMaterial-1299"><a href="#Warehouse.BuyMaterial-1299"><span class="linenos">1299</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1300"><a href="#Warehouse.BuyMaterial-1300"><span class="linenos">1300</span></a><span class="sd">        Supplier Discovery:</span>
</span><span id="Warehouse.BuyMaterial-1301"><a href="#Warehouse.BuyMaterial-1301"><span class="linenos">1301</span></a><span class="sd">            Automatically populates supplier list from presence contacts:</span>
</span><span id="Warehouse.BuyMaterial-1302"><a href="#Warehouse.BuyMaterial-1302"><span class="linenos">1302</span></a><span class="sd">            - Filters contacts for JIDs containing &quot;supplier&quot;</span>
</span><span id="Warehouse.BuyMaterial-1303"><a href="#Warehouse.BuyMaterial-1303"><span class="linenos">1303</span></a><span class="sd">            - Updates agent.suppliers list if empty</span>
</span><span id="Warehouse.BuyMaterial-1304"><a href="#Warehouse.BuyMaterial-1304"><span class="linenos">1304</span></a><span class="sd">            - Requires presence subscription to be active</span>
</span><span id="Warehouse.BuyMaterial-1305"><a href="#Warehouse.BuyMaterial-1305"><span class="linenos">1305</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1306"><a href="#Warehouse.BuyMaterial-1306"><span class="linenos">1306</span></a><span class="sd">        Example Execution:</span>
</span><span id="Warehouse.BuyMaterial-1307"><a href="#Warehouse.BuyMaterial-1307"><span class="linenos">1307</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1308"><a href="#Warehouse.BuyMaterial-1308"><span class="linenos">1308</span></a><span class="sd">            **Scenario 1: Normal Procurement**</span>
</span><span id="Warehouse.BuyMaterial-1309"><a href="#Warehouse.BuyMaterial-1309"><span class="linenos">1309</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.BuyMaterial-1310"><a href="#Warehouse.BuyMaterial-1310"><span class="linenos">1310</span></a><span class="sd">            Trigger: stock[electronics] &lt; restock_threshold</span>
</span><span id="Warehouse.BuyMaterial-1311"><a href="#Warehouse.BuyMaterial-1311"><span class="linenos">1311</span></a><span class="sd">            Request: BuyMaterial(100, &quot;electronics&quot;)</span>
</span><span id="Warehouse.BuyMaterial-1312"><a href="#Warehouse.BuyMaterial-1312"><span class="linenos">1312</span></a><span class="sd">            </span>
</span><span id="Warehouse.BuyMaterial-1313"><a href="#Warehouse.BuyMaterial-1313"><span class="linenos">1313</span></a><span class="sd">            Step 1: Populate suppliers</span>
</span><span id="Warehouse.BuyMaterial-1314"><a href="#Warehouse.BuyMaterial-1314"><span class="linenos">1314</span></a><span class="sd">                Discovered: [supplier1@localhost, supplier2@localhost]</span>
</span><span id="Warehouse.BuyMaterial-1315"><a href="#Warehouse.BuyMaterial-1315"><span class="linenos">1315</span></a><span class="sd">            </span>
</span><span id="Warehouse.BuyMaterial-1316"><a href="#Warehouse.BuyMaterial-1316"><span class="linenos">1316</span></a><span class="sd">            Step 2: Generate ID</span>
</span><span id="Warehouse.BuyMaterial-1317"><a href="#Warehouse.BuyMaterial-1317"><span class="linenos">1317</span></a><span class="sd">                request_id: 101000000</span>
</span><span id="Warehouse.BuyMaterial-1318"><a href="#Warehouse.BuyMaterial-1318"><span class="linenos">1318</span></a><span class="sd">            </span>
</span><span id="Warehouse.BuyMaterial-1319"><a href="#Warehouse.BuyMaterial-1319"><span class="linenos">1319</span></a><span class="sd">            Step 3: Broadcast CFP</span>
</span><span id="Warehouse.BuyMaterial-1320"><a href="#Warehouse.BuyMaterial-1320"><span class="linenos">1320</span></a><span class="sd">                To: supplier1, supplier2</span>
</span><span id="Warehouse.BuyMaterial-1321"><a href="#Warehouse.BuyMaterial-1321"><span class="linenos">1321</span></a><span class="sd">                Message: warehouse-buy &quot;100 electronics&quot;</span>
</span><span id="Warehouse.BuyMaterial-1322"><a href="#Warehouse.BuyMaterial-1322"><span class="linenos">1322</span></a><span class="sd">            </span>
</span><span id="Warehouse.BuyMaterial-1323"><a href="#Warehouse.BuyMaterial-1323"><span class="linenos">1323</span></a><span class="sd">            Step 4: Launch coordinator</span>
</span><span id="Warehouse.BuyMaterial-1324"><a href="#Warehouse.BuyMaterial-1324"><span class="linenos">1324</span></a><span class="sd">                CollectSupplierResponses(101000000, 100, &quot;electronics&quot;)</span>
</span><span id="Warehouse.BuyMaterial-1325"><a href="#Warehouse.BuyMaterial-1325"><span class="linenos">1325</span></a><span class="sd">                Coordinator launches ReceiveAllSupplierResponses worker</span>
</span><span id="Warehouse.BuyMaterial-1326"><a href="#Warehouse.BuyMaterial-1326"><span class="linenos">1326</span></a><span class="sd">            </span>
</span><span id="Warehouse.BuyMaterial-1327"><a href="#Warehouse.BuyMaterial-1327"><span class="linenos">1327</span></a><span class="sd">            Step 5: Wait for proposals (handled by coordinator)</span>
</span><span id="Warehouse.BuyMaterial-1328"><a href="#Warehouse.BuyMaterial-1328"><span class="linenos">1328</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.BuyMaterial-1329"><a href="#Warehouse.BuyMaterial-1329"><span class="linenos">1329</span></a><span class="sd">            </span>
</span><span id="Warehouse.BuyMaterial-1330"><a href="#Warehouse.BuyMaterial-1330"><span class="linenos">1330</span></a><span class="sd">            **Scenario 2: No Suppliers Available**</span>
</span><span id="Warehouse.BuyMaterial-1331"><a href="#Warehouse.BuyMaterial-1331"><span class="linenos">1331</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.BuyMaterial-1332"><a href="#Warehouse.BuyMaterial-1332"><span class="linenos">1332</span></a><span class="sd">            Request: BuyMaterial(100, &quot;electronics&quot;)</span>
</span><span id="Warehouse.BuyMaterial-1333"><a href="#Warehouse.BuyMaterial-1333"><span class="linenos">1333</span></a><span class="sd">            Suppliers: [] (empty list, none in presence)</span>
</span><span id="Warehouse.BuyMaterial-1334"><a href="#Warehouse.BuyMaterial-1334"><span class="linenos">1334</span></a><span class="sd">            </span>
</span><span id="Warehouse.BuyMaterial-1335"><a href="#Warehouse.BuyMaterial-1335"><span class="linenos">1335</span></a><span class="sd">            Result: ERROR logged, no messages sent</span>
</span><span id="Warehouse.BuyMaterial-1336"><a href="#Warehouse.BuyMaterial-1336"><span class="linenos">1336</span></a><span class="sd">            Action: Retry later when suppliers available</span>
</span><span id="Warehouse.BuyMaterial-1337"><a href="#Warehouse.BuyMaterial-1337"><span class="linenos">1337</span></a><span class="sd">            ```</span>
</span><span id="Warehouse.BuyMaterial-1338"><a href="#Warehouse.BuyMaterial-1338"><span class="linenos">1338</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1339"><a href="#Warehouse.BuyMaterial-1339"><span class="linenos">1339</span></a><span class="sd">        Retry Mechanism:</span>
</span><span id="Warehouse.BuyMaterial-1340"><a href="#Warehouse.BuyMaterial-1340"><span class="linenos">1340</span></a><span class="sd">            Sets agent.current_buy_request with:</span>
</span><span id="Warehouse.BuyMaterial-1341"><a href="#Warehouse.BuyMaterial-1341"><span class="linenos">1341</span></a><span class="sd">            - quantity: Amount requested</span>
</span><span id="Warehouse.BuyMaterial-1342"><a href="#Warehouse.BuyMaterial-1342"><span class="linenos">1342</span></a><span class="sd">            - product: Product type</span>
</span><span id="Warehouse.BuyMaterial-1343"><a href="#Warehouse.BuyMaterial-1343"><span class="linenos">1343</span></a><span class="sd">            - request_id: Request identifier</span>
</span><span id="Warehouse.BuyMaterial-1344"><a href="#Warehouse.BuyMaterial-1344"><span class="linenos">1344</span></a><span class="sd">            </span>
</span><span id="Warehouse.BuyMaterial-1345"><a href="#Warehouse.BuyMaterial-1345"><span class="linenos">1345</span></a><span class="sd">            Used by RetryPreviousBuy if procurement fails.</span>
</span><span id="Warehouse.BuyMaterial-1346"><a href="#Warehouse.BuyMaterial-1346"><span class="linenos">1346</span></a><span class="sd">        </span>
</span><span id="Warehouse.BuyMaterial-1347"><a href="#Warehouse.BuyMaterial-1347"><span class="linenos">1347</span></a><span class="sd">        Note:</span>
</span><span id="Warehouse.BuyMaterial-1348"><a href="#Warehouse.BuyMaterial-1348"><span class="linenos">1348</span></a><span class="sd">            This behaviour implements the same FIPA protocol that stores use when</span>
</span><span id="Warehouse.BuyMaterial-1349"><a href="#Warehouse.BuyMaterial-1349"><span class="linenos">1349</span></a><span class="sd">            buying from warehouses, but with reversed roles. The message format and</span>
</span><span id="Warehouse.BuyMaterial-1350"><a href="#Warehouse.BuyMaterial-1350"><span class="linenos">1350</span></a><span class="sd">            workflow mirror the store-warehouse interaction.</span>
</span><span id="Warehouse.BuyMaterial-1351"><a href="#Warehouse.BuyMaterial-1351"><span class="linenos">1351</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.BuyMaterial-1352"><a href="#Warehouse.BuyMaterial-1352"><span class="linenos">1352</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
</span><span id="Warehouse.BuyMaterial-1353"><a href="#Warehouse.BuyMaterial-1353"><span class="linenos">1353</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.BuyMaterial-1354"><a href="#Warehouse.BuyMaterial-1354"><span class="linenos">1354</span></a><span class="sd">            Initialize the BuyMaterial behaviour.</span>
</span><span id="Warehouse.BuyMaterial-1355"><a href="#Warehouse.BuyMaterial-1355"><span class="linenos">1355</span></a><span class="sd">            </span>
</span><span id="Warehouse.BuyMaterial-1356"><a href="#Warehouse.BuyMaterial-1356"><span class="linenos">1356</span></a><span class="sd">            Args:</span>
</span><span id="Warehouse.BuyMaterial-1357"><a href="#Warehouse.BuyMaterial-1357"><span class="linenos">1357</span></a><span class="sd">                quantity (int): Amount of material to purchase.</span>
</span><span id="Warehouse.BuyMaterial-1358"><a href="#Warehouse.BuyMaterial-1358"><span class="linenos">1358</span></a><span class="sd">                product (str): Type of material/product to procure.</span>
</span><span id="Warehouse.BuyMaterial-1359"><a href="#Warehouse.BuyMaterial-1359"><span class="linenos">1359</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse.BuyMaterial-1360"><a href="#Warehouse.BuyMaterial-1360"><span class="linenos">1360</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.BuyMaterial-1361"><a href="#Warehouse.BuyMaterial-1361"><span class="linenos">1361</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Warehouse.BuyMaterial-1362"><a href="#Warehouse.BuyMaterial-1362"><span class="linenos">1362</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="Warehouse.BuyMaterial-1363"><a href="#Warehouse.BuyMaterial-1363"><span class="linenos">1363</span></a>        
</span><span id="Warehouse.BuyMaterial-1364"><a href="#Warehouse.BuyMaterial-1364"><span class="linenos">1364</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">populate_suppliers_from_contacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.BuyMaterial-1365"><a href="#Warehouse.BuyMaterial-1365"><span class="linenos">1365</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Populate suppliers list from presence contacts if empty&quot;&quot;&quot;</span>
</span><span id="Warehouse.BuyMaterial-1366"><a href="#Warehouse.BuyMaterial-1366"><span class="linenos">1366</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.BuyMaterial-1367"><a href="#Warehouse.BuyMaterial-1367"><span class="linenos">1367</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial-1368"><a href="#Warehouse.BuyMaterial-1368"><span class="linenos">1368</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;supplier&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
</span><span id="Warehouse.BuyMaterial-1369"><a href="#Warehouse.BuyMaterial-1369"><span class="linenos">1369</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial-1370"><a href="#Warehouse.BuyMaterial-1370"><span class="linenos">1370</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Auto-populated suppliers from contacts: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial-1371"><a href="#Warehouse.BuyMaterial-1371"><span class="linenos">1371</span></a>        
</span><span id="Warehouse.BuyMaterial-1372"><a href="#Warehouse.BuyMaterial-1372"><span class="linenos">1372</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.BuyMaterial-1373"><a href="#Warehouse.BuyMaterial-1373"><span class="linenos">1373</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.BuyMaterial-1374"><a href="#Warehouse.BuyMaterial-1374"><span class="linenos">1374</span></a>            
</span><span id="Warehouse.BuyMaterial-1375"><a href="#Warehouse.BuyMaterial-1375"><span class="linenos">1375</span></a>            <span class="c1"># Populate suppliers from contacts if list is empty</span>
</span><span id="Warehouse.BuyMaterial-1376"><a href="#Warehouse.BuyMaterial-1376"><span class="linenos">1376</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">populate_suppliers_from_contacts</span><span class="p">()</span>
</span><span id="Warehouse.BuyMaterial-1377"><a href="#Warehouse.BuyMaterial-1377"><span class="linenos">1377</span></a>            
</span><span id="Warehouse.BuyMaterial-1378"><a href="#Warehouse.BuyMaterial-1378"><span class="linenos">1378</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial-1379"><a href="#Warehouse.BuyMaterial-1379"><span class="linenos">1379</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial-1380"><a href="#Warehouse.BuyMaterial-1380"><span class="linenos">1380</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: No suppliers found in contacts!&quot;</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial-1381"><a href="#Warehouse.BuyMaterial-1381"><span class="linenos">1381</span></a>                <span class="k">return</span>
</span><span id="Warehouse.BuyMaterial-1382"><a href="#Warehouse.BuyMaterial-1382"><span class="linenos">1382</span></a>            
</span><span id="Warehouse.BuyMaterial-1383"><a href="#Warehouse.BuyMaterial-1383"><span class="linenos">1383</span></a>            <span class="c1"># Get request_id before sending - use ID encoding</span>
</span><span id="Warehouse.BuyMaterial-1384"><a href="#Warehouse.BuyMaterial-1384"><span class="linenos">1384</span></a>            <span class="n">request_id_for_template</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">id_base</span> <span class="o">+</span> <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span>
</span><span id="Warehouse.BuyMaterial-1385"><a href="#Warehouse.BuyMaterial-1385"><span class="linenos">1385</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse.BuyMaterial-1386"><a href="#Warehouse.BuyMaterial-1386"><span class="linenos">1386</span></a>            
</span><span id="Warehouse.BuyMaterial-1387"><a href="#Warehouse.BuyMaterial-1387"><span class="linenos">1387</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will store the last sent message for current_buy_request</span>
</span><span id="Warehouse.BuyMaterial-1388"><a href="#Warehouse.BuyMaterial-1388"><span class="linenos">1388</span></a>            <span class="c1"># Only send to suppliers, not all contacts</span>
</span><span id="Warehouse.BuyMaterial-1389"><a href="#Warehouse.BuyMaterial-1389"><span class="linenos">1389</span></a>            <span class="k">for</span> <span class="n">supplier_jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial-1390"><a href="#Warehouse.BuyMaterial-1390"><span class="linenos">1390</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">supplier_jid</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial-1391"><a href="#Warehouse.BuyMaterial-1391"><span class="linenos">1391</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-buy&quot;</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial-1392"><a href="#Warehouse.BuyMaterial-1392"><span class="linenos">1392</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.BuyMaterial-1393"><a href="#Warehouse.BuyMaterial-1393"><span class="linenos">1393</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id_for_template</span><span class="p">))</span>
</span><span id="Warehouse.BuyMaterial-1394"><a href="#Warehouse.BuyMaterial-1394"><span class="linenos">1394</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse.BuyMaterial-1395"><a href="#Warehouse.BuyMaterial-1395"><span class="linenos">1395</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.BuyMaterial-1396"><a href="#Warehouse.BuyMaterial-1396"><span class="linenos">1396</span></a>                
</span><span id="Warehouse.BuyMaterial-1397"><a href="#Warehouse.BuyMaterial-1397"><span class="linenos">1397</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial-1398"><a href="#Warehouse.BuyMaterial-1398"><span class="linenos">1398</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent request (id=</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;request_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="Warehouse.BuyMaterial-1399"><a href="#Warehouse.BuyMaterial-1399"><span class="linenos">1399</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial-1400"><a href="#Warehouse.BuyMaterial-1400"><span class="linenos">1400</span></a>                
</span><span id="Warehouse.BuyMaterial-1401"><a href="#Warehouse.BuyMaterial-1401"><span class="linenos">1401</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial-1402"><a href="#Warehouse.BuyMaterial-1402"><span class="linenos">1402</span></a>            
</span><span id="Warehouse.BuyMaterial-1403"><a href="#Warehouse.BuyMaterial-1403"><span class="linenos">1403</span></a>            <span class="c1"># Store the last message (or could store all if needed)</span>
</span><span id="Warehouse.BuyMaterial-1404"><a href="#Warehouse.BuyMaterial-1404"><span class="linenos">1404</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial-1405"><a href="#Warehouse.BuyMaterial-1405"><span class="linenos">1405</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="Warehouse.BuyMaterial-1406"><a href="#Warehouse.BuyMaterial-1406"><span class="linenos">1406</span></a>        
</span><span id="Warehouse.BuyMaterial-1407"><a href="#Warehouse.BuyMaterial-1407"><span class="linenos">1407</span></a>                <span class="c1"># Collect responses from all suppliers</span>
</span><span id="Warehouse.BuyMaterial-1408"><a href="#Warehouse.BuyMaterial-1408"><span class="linenos">1408</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectSupplierResponses</span><span class="p">(</span>
</span><span id="Warehouse.BuyMaterial-1409"><a href="#Warehouse.BuyMaterial-1409"><span class="linenos">1409</span></a>                    <span class="n">msg</span><span class="p">,</span> 
</span><span id="Warehouse.BuyMaterial-1410"><a href="#Warehouse.BuyMaterial-1410"><span class="linenos">1410</span></a>                    <span class="n">request_id_for_template</span><span class="p">,</span> 
</span><span id="Warehouse.BuyMaterial-1411"><a href="#Warehouse.BuyMaterial-1411"><span class="linenos">1411</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">),</span>
</span><span id="Warehouse.BuyMaterial-1412"><a href="#Warehouse.BuyMaterial-1412"><span class="linenos">1412</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="Warehouse.BuyMaterial-1413"><a href="#Warehouse.BuyMaterial-1413"><span class="linenos">1413</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">product</span>
</span><span id="Warehouse.BuyMaterial-1414"><a href="#Warehouse.BuyMaterial-1414"><span class="linenos">1414</span></a>                <span class="p">)</span>
</span><span id="Warehouse.BuyMaterial-1415"><a href="#Warehouse.BuyMaterial-1415"><span class="linenos">1415</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial-1416"><a href="#Warehouse.BuyMaterial-1416"><span class="linenos">1416</span></a>                
</span><span id="Warehouse.BuyMaterial-1417"><a href="#Warehouse.BuyMaterial-1417"><span class="linenos">1417</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Behaviour that initiates material purchase from suppliers (FIPA CFP - Initiator Role).</p>

<p>This behaviour implements the FIPA Contract Net Protocol with the warehouse acting
as the INITIATOR role. The warehouse broadcasts a Call For Proposals (CFP) to
suppliers to replenish inventory. This is the dual role mentioned in the class
docstring - the warehouse is a participant when dealing with stores but becomes
an initiator when dealing with suppliers.</p>

<p>FIPA Protocol: <strong>Contract Net - Initiator Role</strong>
    - Role: Initiator (Warehouse requesting materials from Suppliers)
    - Sends: warehouse-buy (FIPA CFP) with quantity and product
    - Receives: supplier-accept (FIPA propose) or supplier-reject (FIPA refuse)
    - Selection: Choose best supplier based on price and availability
    - Award: Send warehouse-confirm (FIPA accept-proposal) to winner</p>

<h6 id="dual-fipa-role-context">Dual FIPA Role Context:</h6>

<blockquote>
  <ul>
  <li><strong>As Participant</strong> (Store  Warehouse): Warehouse responds to store CFPs</li>
  <li><strong>As Initiator</strong> (Warehouse  Supplier): Warehouse sends CFPs to suppliers</li>
  </ul>
  
  <p>This dual role makes the warehouse a critical intermediary in the supply chain,
  translating downstream demand into upstream procurement.</p>
</blockquote>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>quantity (int):</strong>  Amount of material to purchase from suppliers.</li>
<li><strong>product (str):</strong>  Type of material/product needed for restocking.</li>
</ul>

<p>Message Format (warehouse-buy):
    Metadata:
        - performative: "warehouse-buy" (FIPA CFP)
        - warehouse_id: This warehouse's JID
        - request_id: Unique request identifier (ID encoding)
    Body:
        - Format: "{quantity} {product}"
        - Example: "100 raw_materials"</p>

<h6 id="id-encoding-for-request">ID Encoding for Request:</h6>

<blockquote>
  <p>Uses the warehouse's ID encoding scheme:</p>
  
  <ul>
  <li>request_id = warehouse.id_base + warehouse.request_counter</li>
  <li>Format: 1 (warehouse type) * 100_000_000 + instance * 1_000_000 + counter</li>
  <li>Example: 101000000 (warehouse 1, request 0)</li>
  </ul>
</blockquote>

<h6 id="workflow">Workflow:</h6>

<blockquote>
  <ol>
  <li><strong>Populate Suppliers</strong>: Auto-discover suppliers from presence contacts</li>
  <li><strong>Generate Request ID</strong>: Create unique ID for this procurement</li>
  <li><strong>Broadcast CFP</strong>: Send warehouse-buy to all available suppliers</li>
  <li><strong>Set Metadata</strong>: Store request for retry mechanism (current_buy_request)</li>
  <li><strong>Launch Coordinator</strong>: Start CollectSupplierResponses to gather proposals</li>
  <li><strong>Non-blocking</strong>: Return immediately (coordinator handles responses)</li>
  </ol>
</blockquote>

<p>Coordinator/Worker Pattern:
    - <strong>Initiator (this)</strong>: Sends CFP and launches coordinator
    - <strong>Coordinator</strong>: CollectSupplierResponses (manages collection process)
    - <strong>Worker</strong>: ReceiveAllSupplierResponses (collects individual proposals)
    - <strong>Decision</strong>: SendWarehouseConfirmation (award) or SendWarehouseDenial (reject)</p>

<h6 id="supplier-discovery">Supplier Discovery:</h6>

<blockquote>
  <p>Automatically populates supplier list from presence contacts:</p>
  
  <ul>
  <li>Filters contacts for JIDs containing "supplier"</li>
  <li>Updates agent.suppliers list if empty</li>
  <li>Requires presence subscription to be active</li>
  </ul>
</blockquote>

<h6 id="example-execution">Example Execution:</h6>

<blockquote>
  <p><strong>Scenario 1: Normal Procurement</strong></p>

<pre><code>Trigger: stock[electronics] &lt; restock_threshold
Request: BuyMaterial(100, "electronics")

Step 1: Populate suppliers
    Discovered: [supplier1@localhost, supplier2@localhost]

Step 2: Generate ID
    request_id: 101000000

Step 3: Broadcast CFP
    To: supplier1, supplier2
    Message: warehouse-buy "100 electronics"

Step 4: Launch coordinator
    CollectSupplierResponses(101000000, 100, "electronics")
    Coordinator launches ReceiveAllSupplierResponses worker

Step 5: Wait for proposals (handled by coordinator)
</code></pre>
  
  <p><strong>Scenario 2: No Suppliers Available</strong></p>

<pre><code>Request: BuyMaterial(100, "electronics")
Suppliers: [] (empty list, none in presence)

Result: ERROR logged, no messages sent
Action: Retry later when suppliers available
</code></pre>
</blockquote>

<h6 id="retry-mechanism">Retry Mechanism:</h6>

<blockquote>
  <p>Sets agent.current_buy_request with:</p>
  
  <ul>
  <li>quantity: Amount requested</li>
  <li>product: Product type</li>
  <li>request_id: Request identifier</li>
  </ul>
  
  <p>Used by RetryPreviousBuy if procurement fails.</p>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>This behaviour implements the same FIPA protocol that stores use when
  buying from warehouses, but with reversed roles. The message format and
  workflow mirror the store-warehouse interaction.</p>
</blockquote>
</div>


                            <div id="Warehouse.BuyMaterial.__init__" class="classattr">
                                        <input id="Warehouse.BuyMaterial.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Warehouse.BuyMaterial</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">quantity</span>, </span><span class="param"><span class="n">product</span></span>)</span>

                <label class="view-source-button" for="Warehouse.BuyMaterial.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.BuyMaterial.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.BuyMaterial.__init__-1352"><a href="#Warehouse.BuyMaterial.__init__-1352"><span class="linenos">1352</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
</span><span id="Warehouse.BuyMaterial.__init__-1353"><a href="#Warehouse.BuyMaterial.__init__-1353"><span class="linenos">1353</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.BuyMaterial.__init__-1354"><a href="#Warehouse.BuyMaterial.__init__-1354"><span class="linenos">1354</span></a><span class="sd">            Initialize the BuyMaterial behaviour.</span>
</span><span id="Warehouse.BuyMaterial.__init__-1355"><a href="#Warehouse.BuyMaterial.__init__-1355"><span class="linenos">1355</span></a><span class="sd">            </span>
</span><span id="Warehouse.BuyMaterial.__init__-1356"><a href="#Warehouse.BuyMaterial.__init__-1356"><span class="linenos">1356</span></a><span class="sd">            Args:</span>
</span><span id="Warehouse.BuyMaterial.__init__-1357"><a href="#Warehouse.BuyMaterial.__init__-1357"><span class="linenos">1357</span></a><span class="sd">                quantity (int): Amount of material to purchase.</span>
</span><span id="Warehouse.BuyMaterial.__init__-1358"><a href="#Warehouse.BuyMaterial.__init__-1358"><span class="linenos">1358</span></a><span class="sd">                product (str): Type of material/product to procure.</span>
</span><span id="Warehouse.BuyMaterial.__init__-1359"><a href="#Warehouse.BuyMaterial.__init__-1359"><span class="linenos">1359</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Warehouse.BuyMaterial.__init__-1360"><a href="#Warehouse.BuyMaterial.__init__-1360"><span class="linenos">1360</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.BuyMaterial.__init__-1361"><a href="#Warehouse.BuyMaterial.__init__-1361"><span class="linenos">1361</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Warehouse.BuyMaterial.__init__-1362"><a href="#Warehouse.BuyMaterial.__init__-1362"><span class="linenos">1362</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the BuyMaterial behaviour.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>quantity (int):</strong>  Amount of material to purchase.</li>
<li><strong>product (str):</strong>  Type of material/product to procure.</li>
</ul>
</div>


                            </div>
                            <div id="Warehouse.BuyMaterial.quantity" class="classattr">
                                <div class="attr variable">
            <span class="name">quantity</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.BuyMaterial.quantity"></a>
    
    

                            </div>
                            <div id="Warehouse.BuyMaterial.product" class="classattr">
                                <div class="attr variable">
            <span class="name">product</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.BuyMaterial.product"></a>
    
    

                            </div>
                            <div id="Warehouse.BuyMaterial.populate_suppliers_from_contacts" class="classattr">
                                        <input id="Warehouse.BuyMaterial.populate_suppliers_from_contacts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">populate_suppliers_from_contacts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.BuyMaterial.populate_suppliers_from_contacts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.BuyMaterial.populate_suppliers_from_contacts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.BuyMaterial.populate_suppliers_from_contacts-1364"><a href="#Warehouse.BuyMaterial.populate_suppliers_from_contacts-1364"><span class="linenos">1364</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">populate_suppliers_from_contacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.BuyMaterial.populate_suppliers_from_contacts-1365"><a href="#Warehouse.BuyMaterial.populate_suppliers_from_contacts-1365"><span class="linenos">1365</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Populate suppliers list from presence contacts if empty&quot;&quot;&quot;</span>
</span><span id="Warehouse.BuyMaterial.populate_suppliers_from_contacts-1366"><a href="#Warehouse.BuyMaterial.populate_suppliers_from_contacts-1366"><span class="linenos">1366</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.BuyMaterial.populate_suppliers_from_contacts-1367"><a href="#Warehouse.BuyMaterial.populate_suppliers_from_contacts-1367"><span class="linenos">1367</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial.populate_suppliers_from_contacts-1368"><a href="#Warehouse.BuyMaterial.populate_suppliers_from_contacts-1368"><span class="linenos">1368</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">presence</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;supplier&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
</span><span id="Warehouse.BuyMaterial.populate_suppliers_from_contacts-1369"><a href="#Warehouse.BuyMaterial.populate_suppliers_from_contacts-1369"><span class="linenos">1369</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial.populate_suppliers_from_contacts-1370"><a href="#Warehouse.BuyMaterial.populate_suppliers_from_contacts-1370"><span class="linenos">1370</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Auto-populated suppliers from contacts: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Populate suppliers list from presence contacts if empty</p>
</div>


                            </div>
                            <div id="Warehouse.BuyMaterial.run" class="classattr">
                                        <input id="Warehouse.BuyMaterial.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.BuyMaterial.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.BuyMaterial.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.BuyMaterial.run-1372"><a href="#Warehouse.BuyMaterial.run-1372"><span class="linenos">1372</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.BuyMaterial.run-1373"><a href="#Warehouse.BuyMaterial.run-1373"><span class="linenos">1373</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.BuyMaterial.run-1374"><a href="#Warehouse.BuyMaterial.run-1374"><span class="linenos">1374</span></a>            
</span><span id="Warehouse.BuyMaterial.run-1375"><a href="#Warehouse.BuyMaterial.run-1375"><span class="linenos">1375</span></a>            <span class="c1"># Populate suppliers from contacts if list is empty</span>
</span><span id="Warehouse.BuyMaterial.run-1376"><a href="#Warehouse.BuyMaterial.run-1376"><span class="linenos">1376</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">populate_suppliers_from_contacts</span><span class="p">()</span>
</span><span id="Warehouse.BuyMaterial.run-1377"><a href="#Warehouse.BuyMaterial.run-1377"><span class="linenos">1377</span></a>            
</span><span id="Warehouse.BuyMaterial.run-1378"><a href="#Warehouse.BuyMaterial.run-1378"><span class="linenos">1378</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial.run-1379"><a href="#Warehouse.BuyMaterial.run-1379"><span class="linenos">1379</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial.run-1380"><a href="#Warehouse.BuyMaterial.run-1380"><span class="linenos">1380</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: No suppliers found in contacts!&quot;</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial.run-1381"><a href="#Warehouse.BuyMaterial.run-1381"><span class="linenos">1381</span></a>                <span class="k">return</span>
</span><span id="Warehouse.BuyMaterial.run-1382"><a href="#Warehouse.BuyMaterial.run-1382"><span class="linenos">1382</span></a>            
</span><span id="Warehouse.BuyMaterial.run-1383"><a href="#Warehouse.BuyMaterial.run-1383"><span class="linenos">1383</span></a>            <span class="c1"># Get request_id before sending - use ID encoding</span>
</span><span id="Warehouse.BuyMaterial.run-1384"><a href="#Warehouse.BuyMaterial.run-1384"><span class="linenos">1384</span></a>            <span class="n">request_id_for_template</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">id_base</span> <span class="o">+</span> <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span>
</span><span id="Warehouse.BuyMaterial.run-1385"><a href="#Warehouse.BuyMaterial.run-1385"><span class="linenos">1385</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse.BuyMaterial.run-1386"><a href="#Warehouse.BuyMaterial.run-1386"><span class="linenos">1386</span></a>            
</span><span id="Warehouse.BuyMaterial.run-1387"><a href="#Warehouse.BuyMaterial.run-1387"><span class="linenos">1387</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will store the last sent message for current_buy_request</span>
</span><span id="Warehouse.BuyMaterial.run-1388"><a href="#Warehouse.BuyMaterial.run-1388"><span class="linenos">1388</span></a>            <span class="c1"># Only send to suppliers, not all contacts</span>
</span><span id="Warehouse.BuyMaterial.run-1389"><a href="#Warehouse.BuyMaterial.run-1389"><span class="linenos">1389</span></a>            <span class="k">for</span> <span class="n">supplier_jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial.run-1390"><a href="#Warehouse.BuyMaterial.run-1390"><span class="linenos">1390</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">supplier_jid</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial.run-1391"><a href="#Warehouse.BuyMaterial.run-1391"><span class="linenos">1391</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-buy&quot;</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial.run-1392"><a href="#Warehouse.BuyMaterial.run-1392"><span class="linenos">1392</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.BuyMaterial.run-1393"><a href="#Warehouse.BuyMaterial.run-1393"><span class="linenos">1393</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id_for_template</span><span class="p">))</span>
</span><span id="Warehouse.BuyMaterial.run-1394"><a href="#Warehouse.BuyMaterial.run-1394"><span class="linenos">1394</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse.BuyMaterial.run-1395"><a href="#Warehouse.BuyMaterial.run-1395"><span class="linenos">1395</span></a>                <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.BuyMaterial.run-1396"><a href="#Warehouse.BuyMaterial.run-1396"><span class="linenos">1396</span></a>                
</span><span id="Warehouse.BuyMaterial.run-1397"><a href="#Warehouse.BuyMaterial.run-1397"><span class="linenos">1397</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial.run-1398"><a href="#Warehouse.BuyMaterial.run-1398"><span class="linenos">1398</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent request (id=</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;request_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="Warehouse.BuyMaterial.run-1399"><a href="#Warehouse.BuyMaterial.run-1399"><span class="linenos">1399</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial.run-1400"><a href="#Warehouse.BuyMaterial.run-1400"><span class="linenos">1400</span></a>                
</span><span id="Warehouse.BuyMaterial.run-1401"><a href="#Warehouse.BuyMaterial.run-1401"><span class="linenos">1401</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial.run-1402"><a href="#Warehouse.BuyMaterial.run-1402"><span class="linenos">1402</span></a>            
</span><span id="Warehouse.BuyMaterial.run-1403"><a href="#Warehouse.BuyMaterial.run-1403"><span class="linenos">1403</span></a>            <span class="c1"># Store the last message (or could store all if needed)</span>
</span><span id="Warehouse.BuyMaterial.run-1404"><a href="#Warehouse.BuyMaterial.run-1404"><span class="linenos">1404</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse.BuyMaterial.run-1405"><a href="#Warehouse.BuyMaterial.run-1405"><span class="linenos">1405</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span> <span class="o">=</span> <span class="n">msg</span>
</span><span id="Warehouse.BuyMaterial.run-1406"><a href="#Warehouse.BuyMaterial.run-1406"><span class="linenos">1406</span></a>        
</span><span id="Warehouse.BuyMaterial.run-1407"><a href="#Warehouse.BuyMaterial.run-1407"><span class="linenos">1407</span></a>                <span class="c1"># Collect responses from all suppliers</span>
</span><span id="Warehouse.BuyMaterial.run-1408"><a href="#Warehouse.BuyMaterial.run-1408"><span class="linenos">1408</span></a>                <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectSupplierResponses</span><span class="p">(</span>
</span><span id="Warehouse.BuyMaterial.run-1409"><a href="#Warehouse.BuyMaterial.run-1409"><span class="linenos">1409</span></a>                    <span class="n">msg</span><span class="p">,</span> 
</span><span id="Warehouse.BuyMaterial.run-1410"><a href="#Warehouse.BuyMaterial.run-1410"><span class="linenos">1410</span></a>                    <span class="n">request_id_for_template</span><span class="p">,</span> 
</span><span id="Warehouse.BuyMaterial.run-1411"><a href="#Warehouse.BuyMaterial.run-1411"><span class="linenos">1411</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">),</span>
</span><span id="Warehouse.BuyMaterial.run-1412"><a href="#Warehouse.BuyMaterial.run-1412"><span class="linenos">1412</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="Warehouse.BuyMaterial.run-1413"><a href="#Warehouse.BuyMaterial.run-1413"><span class="linenos">1413</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">product</span>
</span><span id="Warehouse.BuyMaterial.run-1414"><a href="#Warehouse.BuyMaterial.run-1414"><span class="linenos">1414</span></a>                <span class="p">)</span>
</span><span id="Warehouse.BuyMaterial.run-1415"><a href="#Warehouse.BuyMaterial.run-1415"><span class="linenos">1415</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Warehouse.BuyMaterial.run-1416"><a href="#Warehouse.BuyMaterial.run-1416"><span class="linenos">1416</span></a>                
</span><span id="Warehouse.BuyMaterial.run-1417"><a href="#Warehouse.BuyMaterial.run-1417"><span class="linenos">1417</span></a>                <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.CollectSupplierResponses">
                            <input id="Warehouse.CollectSupplierResponses-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.CollectSupplierResponses</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Warehouse.CollectSupplierResponses-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.CollectSupplierResponses"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.CollectSupplierResponses-1419"><a href="#Warehouse.CollectSupplierResponses-1419"><span class="linenos">1419</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">CollectSupplierResponses</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.CollectSupplierResponses-1420"><a href="#Warehouse.CollectSupplierResponses-1420"><span class="linenos">1420</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.CollectSupplierResponses-1421"><a href="#Warehouse.CollectSupplierResponses-1421"><span class="linenos">1421</span></a><span class="sd">        Coordinator behaviour that manages supplier proposal collection and evaluation.</span>
</span><span id="Warehouse.CollectSupplierResponses-1422"><a href="#Warehouse.CollectSupplierResponses-1422"><span class="linenos">1422</span></a><span class="sd">        </span>
</span><span id="Warehouse.CollectSupplierResponses-1423"><a href="#Warehouse.CollectSupplierResponses-1423"><span class="linenos">1423</span></a><span class="sd">        Launches ReceiveAllSupplierResponses worker to collect proposals from all suppliers,</span>
</span><span id="Warehouse.CollectSupplierResponses-1424"><a href="#Warehouse.CollectSupplierResponses-1424"><span class="linenos">1424</span></a><span class="sd">        then evaluates responses and selects the best supplier based on delivery time.</span>
</span><span id="Warehouse.CollectSupplierResponses-1425"><a href="#Warehouse.CollectSupplierResponses-1425"><span class="linenos">1425</span></a><span class="sd">        Sends confirmation to winner and denials to others. Implements FIPA initiator role.</span>
</span><span id="Warehouse.CollectSupplierResponses-1426"><a href="#Warehouse.CollectSupplierResponses-1426"><span class="linenos">1426</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.CollectSupplierResponses-1427"><a href="#Warehouse.CollectSupplierResponses-1427"><span class="linenos">1427</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_suppliers</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">quantity</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">product</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Warehouse.CollectSupplierResponses-1428"><a href="#Warehouse.CollectSupplierResponses-1428"><span class="linenos">1428</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.CollectSupplierResponses-1429"><a href="#Warehouse.CollectSupplierResponses-1429"><span class="linenos">1429</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Warehouse.CollectSupplierResponses-1430"><a href="#Warehouse.CollectSupplierResponses-1430"><span class="linenos">1430</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">buy_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="Warehouse.CollectSupplierResponses-1431"><a href="#Warehouse.CollectSupplierResponses-1431"><span class="linenos">1431</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span> <span class="o">=</span> <span class="n">num_suppliers</span>
</span><span id="Warehouse.CollectSupplierResponses-1432"><a href="#Warehouse.CollectSupplierResponses-1432"><span class="linenos">1432</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Warehouse.CollectSupplierResponses-1433"><a href="#Warehouse.CollectSupplierResponses-1433"><span class="linenos">1433</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="Warehouse.CollectSupplierResponses-1434"><a href="#Warehouse.CollectSupplierResponses-1434"><span class="linenos">1434</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of (supplier_jid, msg)</span>
</span><span id="Warehouse.CollectSupplierResponses-1435"><a href="#Warehouse.CollectSupplierResponses-1435"><span class="linenos">1435</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># List of (supplier_jid, msg, reason)</span>
</span><span id="Warehouse.CollectSupplierResponses-1436"><a href="#Warehouse.CollectSupplierResponses-1436"><span class="linenos">1436</span></a>            
</span><span id="Warehouse.CollectSupplierResponses-1437"><a href="#Warehouse.CollectSupplierResponses-1437"><span class="linenos">1437</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.CollectSupplierResponses-1438"><a href="#Warehouse.CollectSupplierResponses-1438"><span class="linenos">1438</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.CollectSupplierResponses-1439"><a href="#Warehouse.CollectSupplierResponses-1439"><span class="linenos">1439</span></a>            
</span><span id="Warehouse.CollectSupplierResponses-1440"><a href="#Warehouse.CollectSupplierResponses-1440"><span class="linenos">1440</span></a>            <span class="c1"># Setup template that accepts BOTH supplier-accept AND supplier-reject</span>
</span><span id="Warehouse.CollectSupplierResponses-1441"><a href="#Warehouse.CollectSupplierResponses-1441"><span class="linenos">1441</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse.CollectSupplierResponses-1442"><a href="#Warehouse.CollectSupplierResponses-1442"><span class="linenos">1442</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.CollectSupplierResponses-1443"><a href="#Warehouse.CollectSupplierResponses-1443"><span class="linenos">1443</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.CollectSupplierResponses-1444"><a href="#Warehouse.CollectSupplierResponses-1444"><span class="linenos">1444</span></a>            <span class="c1"># Don&#39;t filter by performative - we want both accept and reject</span>
</span><span id="Warehouse.CollectSupplierResponses-1445"><a href="#Warehouse.CollectSupplierResponses-1445"><span class="linenos">1445</span></a>            
</span><span id="Warehouse.CollectSupplierResponses-1446"><a href="#Warehouse.CollectSupplierResponses-1446"><span class="linenos">1446</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1447"><a href="#Warehouse.CollectSupplierResponses-1447"><span class="linenos">1447</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Setting up to receive supplier responses for request_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1448"><a href="#Warehouse.CollectSupplierResponses-1448"><span class="linenos">1448</span></a>            
</span><span id="Warehouse.CollectSupplierResponses-1449"><a href="#Warehouse.CollectSupplierResponses-1449"><span class="linenos">1449</span></a>            <span class="c1"># Create a combined behaviour to listen for both</span>
</span><span id="Warehouse.CollectSupplierResponses-1450"><a href="#Warehouse.CollectSupplierResponses-1450"><span class="linenos">1450</span></a>            <span class="n">combined_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ReceiveAllSupplierResponses</span><span class="p">(</span>
</span><span id="Warehouse.CollectSupplierResponses-1451"><a href="#Warehouse.CollectSupplierResponses-1451"><span class="linenos">1451</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span id="Warehouse.CollectSupplierResponses-1452"><a href="#Warehouse.CollectSupplierResponses-1452"><span class="linenos">1452</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="p">,</span>
</span><span id="Warehouse.CollectSupplierResponses-1453"><a href="#Warehouse.CollectSupplierResponses-1453"><span class="linenos">1453</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">,</span>
</span><span id="Warehouse.CollectSupplierResponses-1454"><a href="#Warehouse.CollectSupplierResponses-1454"><span class="linenos">1454</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span>
</span><span id="Warehouse.CollectSupplierResponses-1455"><a href="#Warehouse.CollectSupplierResponses-1455"><span class="linenos">1455</span></a>            <span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1456"><a href="#Warehouse.CollectSupplierResponses-1456"><span class="linenos">1456</span></a>            
</span><span id="Warehouse.CollectSupplierResponses-1457"><a href="#Warehouse.CollectSupplierResponses-1457"><span class="linenos">1457</span></a>            <span class="c1"># Add with template that matches both performatives</span>
</span><span id="Warehouse.CollectSupplierResponses-1458"><a href="#Warehouse.CollectSupplierResponses-1458"><span class="linenos">1458</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">combined_behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1459"><a href="#Warehouse.CollectSupplierResponses-1459"><span class="linenos">1459</span></a>            
</span><span id="Warehouse.CollectSupplierResponses-1460"><a href="#Warehouse.CollectSupplierResponses-1460"><span class="linenos">1460</span></a>            <span class="c1"># Wait for collection to complete</span>
</span><span id="Warehouse.CollectSupplierResponses-1461"><a href="#Warehouse.CollectSupplierResponses-1461"><span class="linenos">1461</span></a>            <span class="k">await</span> <span class="n">combined_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse.CollectSupplierResponses-1462"><a href="#Warehouse.CollectSupplierResponses-1462"><span class="linenos">1462</span></a>            
</span><span id="Warehouse.CollectSupplierResponses-1463"><a href="#Warehouse.CollectSupplierResponses-1463"><span class="linenos">1463</span></a>            <span class="c1"># Now evaluate and choose best supplier</span>
</span><span id="Warehouse.CollectSupplierResponses-1464"><a href="#Warehouse.CollectSupplierResponses-1464"><span class="linenos">1464</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1465"><a href="#Warehouse.CollectSupplierResponses-1465"><span class="linenos">1465</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1466"><a href="#Warehouse.CollectSupplierResponses-1466"><span class="linenos">1466</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> acceptance(s) and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejection(s)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1467"><a href="#Warehouse.CollectSupplierResponses-1467"><span class="linenos">1467</span></a>                
</span><span id="Warehouse.CollectSupplierResponses-1468"><a href="#Warehouse.CollectSupplierResponses-1468"><span class="linenos">1468</span></a>                <span class="c1"># Calculate scores for each supplier that accepted</span>
</span><span id="Warehouse.CollectSupplierResponses-1469"><a href="#Warehouse.CollectSupplierResponses-1469"><span class="linenos">1469</span></a>                <span class="n">best_supplier</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Warehouse.CollectSupplierResponses-1470"><a href="#Warehouse.CollectSupplierResponses-1470"><span class="linenos">1470</span></a>                <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1471"><a href="#Warehouse.CollectSupplierResponses-1471"><span class="linenos">1471</span></a>                
</span><span id="Warehouse.CollectSupplierResponses-1472"><a href="#Warehouse.CollectSupplierResponses-1472"><span class="linenos">1472</span></a>                <span class="k">for</span> <span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1473"><a href="#Warehouse.CollectSupplierResponses-1473"><span class="linenos">1473</span></a>                    <span class="n">score</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">calculate_supplier_score</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1474"><a href="#Warehouse.CollectSupplierResponses-1474"><span class="linenos">1474</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1475"><a href="#Warehouse.CollectSupplierResponses-1475"><span class="linenos">1475</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Warehouse </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2"> score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1476"><a href="#Warehouse.CollectSupplierResponses-1476"><span class="linenos">1476</span></a>                    
</span><span id="Warehouse.CollectSupplierResponses-1477"><a href="#Warehouse.CollectSupplierResponses-1477"><span class="linenos">1477</span></a>                    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">best_score</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1478"><a href="#Warehouse.CollectSupplierResponses-1478"><span class="linenos">1478</span></a>                        <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
</span><span id="Warehouse.CollectSupplierResponses-1479"><a href="#Warehouse.CollectSupplierResponses-1479"><span class="linenos">1479</span></a>                        <span class="n">best_supplier</span> <span class="o">=</span> <span class="p">(</span><span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1480"><a href="#Warehouse.CollectSupplierResponses-1480"><span class="linenos">1480</span></a>                
</span><span id="Warehouse.CollectSupplierResponses-1481"><a href="#Warehouse.CollectSupplierResponses-1481"><span class="linenos">1481</span></a>                <span class="k">if</span> <span class="n">best_supplier</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1482"><a href="#Warehouse.CollectSupplierResponses-1482"><span class="linenos">1482</span></a>                    <span class="n">supplier_jid</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="o">=</span> <span class="n">best_supplier</span>
</span><span id="Warehouse.CollectSupplierResponses-1483"><a href="#Warehouse.CollectSupplierResponses-1483"><span class="linenos">1483</span></a>                    <span class="c1"># Essential print - supplier selected</span>
</span><span id="Warehouse.CollectSupplierResponses-1484"><a href="#Warehouse.CollectSupplierResponses-1484"><span class="linenos">1484</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Selected supplier </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1485"><a href="#Warehouse.CollectSupplierResponses-1485"><span class="linenos">1485</span></a>                    
</span><span id="Warehouse.CollectSupplierResponses-1486"><a href="#Warehouse.CollectSupplierResponses-1486"><span class="linenos">1486</span></a>                    <span class="c1"># Send confirmation to the chosen supplier</span>
</span><span id="Warehouse.CollectSupplierResponses-1487"><a href="#Warehouse.CollectSupplierResponses-1487"><span class="linenos">1487</span></a>                    <span class="n">confirm_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendWarehouseConfirmation</span><span class="p">(</span><span class="n">accept_msg</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1488"><a href="#Warehouse.CollectSupplierResponses-1488"><span class="linenos">1488</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">confirm_behav</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1489"><a href="#Warehouse.CollectSupplierResponses-1489"><span class="linenos">1489</span></a>                    <span class="k">await</span> <span class="n">confirm_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse.CollectSupplierResponses-1490"><a href="#Warehouse.CollectSupplierResponses-1490"><span class="linenos">1490</span></a>                    
</span><span id="Warehouse.CollectSupplierResponses-1491"><a href="#Warehouse.CollectSupplierResponses-1491"><span class="linenos">1491</span></a>                    <span class="c1"># Send denial to other suppliers that accepted but weren&#39;t chosen</span>
</span><span id="Warehouse.CollectSupplierResponses-1492"><a href="#Warehouse.CollectSupplierResponses-1492"><span class="linenos">1492</span></a>                    <span class="k">for</span> <span class="n">other_supplier_jid</span><span class="p">,</span> <span class="n">other_msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1493"><a href="#Warehouse.CollectSupplierResponses-1493"><span class="linenos">1493</span></a>                        <span class="k">if</span> <span class="n">other_supplier_jid</span> <span class="o">!=</span> <span class="n">supplier_jid</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1494"><a href="#Warehouse.CollectSupplierResponses-1494"><span class="linenos">1494</span></a>                            <span class="n">deny_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendWarehouseDenial</span><span class="p">(</span><span class="n">other_msg</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1495"><a href="#Warehouse.CollectSupplierResponses-1495"><span class="linenos">1495</span></a>                            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">deny_behav</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1496"><a href="#Warehouse.CollectSupplierResponses-1496"><span class="linenos">1496</span></a>                            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1497"><a href="#Warehouse.CollectSupplierResponses-1497"><span class="linenos">1497</span></a>                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent denial to </span><span class="si">{</span><span class="n">other_supplier_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1498"><a href="#Warehouse.CollectSupplierResponses-1498"><span class="linenos">1498</span></a>                    
</span><span id="Warehouse.CollectSupplierResponses-1499"><a href="#Warehouse.CollectSupplierResponses-1499"><span class="linenos">1499</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1500"><a href="#Warehouse.CollectSupplierResponses-1500"><span class="linenos">1500</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1501"><a href="#Warehouse.CollectSupplierResponses-1501"><span class="linenos">1501</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No acceptances received. All suppliers rejected or timed out.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1502"><a href="#Warehouse.CollectSupplierResponses-1502"><span class="linenos">1502</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Request saved in self.failed_requests&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses-1503"><a href="#Warehouse.CollectSupplierResponses-1503"><span class="linenos">1503</span></a>                
</span><span id="Warehouse.CollectSupplierResponses-1504"><a href="#Warehouse.CollectSupplierResponses-1504"><span class="linenos">1504</span></a>                <span class="c1"># Add to failed requests</span>
</span><span id="Warehouse.CollectSupplierResponses-1505"><a href="#Warehouse.CollectSupplierResponses-1505"><span class="linenos">1505</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;current_buy_request&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses-1506"><a href="#Warehouse.CollectSupplierResponses-1506"><span class="linenos">1506</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Coordinator behaviour that manages supplier proposal collection and evaluation.</p>

<p>Launches ReceiveAllSupplierResponses worker to collect proposals from all suppliers,
then evaluates responses and selects the best supplier based on delivery time.
Sends confirmation to winner and denials to others. Implements FIPA initiator role.</p>
</div>


                            <div id="Warehouse.CollectSupplierResponses.__init__" class="classattr">
                                        <input id="Warehouse.CollectSupplierResponses.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Warehouse.CollectSupplierResponses</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span>,</span><span class="param">	<span class="n">request_id</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">num_suppliers</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">product</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="Warehouse.CollectSupplierResponses.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.CollectSupplierResponses.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.CollectSupplierResponses.__init__-1427"><a href="#Warehouse.CollectSupplierResponses.__init__-1427"><span class="linenos">1427</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_suppliers</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">quantity</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">product</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Warehouse.CollectSupplierResponses.__init__-1428"><a href="#Warehouse.CollectSupplierResponses.__init__-1428"><span class="linenos">1428</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.CollectSupplierResponses.__init__-1429"><a href="#Warehouse.CollectSupplierResponses.__init__-1429"><span class="linenos">1429</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Warehouse.CollectSupplierResponses.__init__-1430"><a href="#Warehouse.CollectSupplierResponses.__init__-1430"><span class="linenos">1430</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">buy_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span>
</span><span id="Warehouse.CollectSupplierResponses.__init__-1431"><a href="#Warehouse.CollectSupplierResponses.__init__-1431"><span class="linenos">1431</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span> <span class="o">=</span> <span class="n">num_suppliers</span>
</span><span id="Warehouse.CollectSupplierResponses.__init__-1432"><a href="#Warehouse.CollectSupplierResponses.__init__-1432"><span class="linenos">1432</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Warehouse.CollectSupplierResponses.__init__-1433"><a href="#Warehouse.CollectSupplierResponses.__init__-1433"><span class="linenos">1433</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
</span><span id="Warehouse.CollectSupplierResponses.__init__-1434"><a href="#Warehouse.CollectSupplierResponses.__init__-1434"><span class="linenos">1434</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of (supplier_jid, msg)</span>
</span><span id="Warehouse.CollectSupplierResponses.__init__-1435"><a href="#Warehouse.CollectSupplierResponses.__init__-1435"><span class="linenos">1435</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># List of (supplier_jid, msg, reason)</span>
</span></pre></div>


    

                            </div>
                            <div id="Warehouse.CollectSupplierResponses.request_id" class="classattr">
                                <div class="attr variable">
            <span class="name">request_id</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.CollectSupplierResponses.request_id"></a>
    
    

                            </div>
                            <div id="Warehouse.CollectSupplierResponses.buy_msg" class="classattr">
                                <div class="attr variable">
            <span class="name">buy_msg</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.CollectSupplierResponses.buy_msg"></a>
    
    

                            </div>
                            <div id="Warehouse.CollectSupplierResponses.num_suppliers" class="classattr">
                                <div class="attr variable">
            <span class="name">num_suppliers</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.CollectSupplierResponses.num_suppliers"></a>
    
    

                            </div>
                            <div id="Warehouse.CollectSupplierResponses.quantity" class="classattr">
                                <div class="attr variable">
            <span class="name">quantity</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.CollectSupplierResponses.quantity"></a>
    
    

                            </div>
                            <div id="Warehouse.CollectSupplierResponses.product" class="classattr">
                                <div class="attr variable">
            <span class="name">product</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.CollectSupplierResponses.product"></a>
    
    

                            </div>
                            <div id="Warehouse.CollectSupplierResponses.acceptances" class="classattr">
                                <div class="attr variable">
            <span class="name">acceptances</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.CollectSupplierResponses.acceptances"></a>
    
    

                            </div>
                            <div id="Warehouse.CollectSupplierResponses.rejections" class="classattr">
                                <div class="attr variable">
            <span class="name">rejections</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.CollectSupplierResponses.rejections"></a>
    
    

                            </div>
                            <div id="Warehouse.CollectSupplierResponses.run" class="classattr">
                                        <input id="Warehouse.CollectSupplierResponses.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.CollectSupplierResponses.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.CollectSupplierResponses.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.CollectSupplierResponses.run-1437"><a href="#Warehouse.CollectSupplierResponses.run-1437"><span class="linenos">1437</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1438"><a href="#Warehouse.CollectSupplierResponses.run-1438"><span class="linenos">1438</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1439"><a href="#Warehouse.CollectSupplierResponses.run-1439"><span class="linenos">1439</span></a>            
</span><span id="Warehouse.CollectSupplierResponses.run-1440"><a href="#Warehouse.CollectSupplierResponses.run-1440"><span class="linenos">1440</span></a>            <span class="c1"># Setup template that accepts BOTH supplier-accept AND supplier-reject</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1441"><a href="#Warehouse.CollectSupplierResponses.run-1441"><span class="linenos">1441</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1442"><a href="#Warehouse.CollectSupplierResponses.run-1442"><span class="linenos">1442</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1443"><a href="#Warehouse.CollectSupplierResponses.run-1443"><span class="linenos">1443</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1444"><a href="#Warehouse.CollectSupplierResponses.run-1444"><span class="linenos">1444</span></a>            <span class="c1"># Don&#39;t filter by performative - we want both accept and reject</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1445"><a href="#Warehouse.CollectSupplierResponses.run-1445"><span class="linenos">1445</span></a>            
</span><span id="Warehouse.CollectSupplierResponses.run-1446"><a href="#Warehouse.CollectSupplierResponses.run-1446"><span class="linenos">1446</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1447"><a href="#Warehouse.CollectSupplierResponses.run-1447"><span class="linenos">1447</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Setting up to receive supplier responses for request_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1448"><a href="#Warehouse.CollectSupplierResponses.run-1448"><span class="linenos">1448</span></a>            
</span><span id="Warehouse.CollectSupplierResponses.run-1449"><a href="#Warehouse.CollectSupplierResponses.run-1449"><span class="linenos">1449</span></a>            <span class="c1"># Create a combined behaviour to listen for both</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1450"><a href="#Warehouse.CollectSupplierResponses.run-1450"><span class="linenos">1450</span></a>            <span class="n">combined_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ReceiveAllSupplierResponses</span><span class="p">(</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1451"><a href="#Warehouse.CollectSupplierResponses.run-1451"><span class="linenos">1451</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1452"><a href="#Warehouse.CollectSupplierResponses.run-1452"><span class="linenos">1452</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="p">,</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1453"><a href="#Warehouse.CollectSupplierResponses.run-1453"><span class="linenos">1453</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">,</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1454"><a href="#Warehouse.CollectSupplierResponses.run-1454"><span class="linenos">1454</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1455"><a href="#Warehouse.CollectSupplierResponses.run-1455"><span class="linenos">1455</span></a>            <span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1456"><a href="#Warehouse.CollectSupplierResponses.run-1456"><span class="linenos">1456</span></a>            
</span><span id="Warehouse.CollectSupplierResponses.run-1457"><a href="#Warehouse.CollectSupplierResponses.run-1457"><span class="linenos">1457</span></a>            <span class="c1"># Add with template that matches both performatives</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1458"><a href="#Warehouse.CollectSupplierResponses.run-1458"><span class="linenos">1458</span></a>            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">combined_behav</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1459"><a href="#Warehouse.CollectSupplierResponses.run-1459"><span class="linenos">1459</span></a>            
</span><span id="Warehouse.CollectSupplierResponses.run-1460"><a href="#Warehouse.CollectSupplierResponses.run-1460"><span class="linenos">1460</span></a>            <span class="c1"># Wait for collection to complete</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1461"><a href="#Warehouse.CollectSupplierResponses.run-1461"><span class="linenos">1461</span></a>            <span class="k">await</span> <span class="n">combined_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1462"><a href="#Warehouse.CollectSupplierResponses.run-1462"><span class="linenos">1462</span></a>            
</span><span id="Warehouse.CollectSupplierResponses.run-1463"><a href="#Warehouse.CollectSupplierResponses.run-1463"><span class="linenos">1463</span></a>            <span class="c1"># Now evaluate and choose best supplier</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1464"><a href="#Warehouse.CollectSupplierResponses.run-1464"><span class="linenos">1464</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1465"><a href="#Warehouse.CollectSupplierResponses.run-1465"><span class="linenos">1465</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1466"><a href="#Warehouse.CollectSupplierResponses.run-1466"><span class="linenos">1466</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> acceptance(s) and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejection(s)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1467"><a href="#Warehouse.CollectSupplierResponses.run-1467"><span class="linenos">1467</span></a>                
</span><span id="Warehouse.CollectSupplierResponses.run-1468"><a href="#Warehouse.CollectSupplierResponses.run-1468"><span class="linenos">1468</span></a>                <span class="c1"># Calculate scores for each supplier that accepted</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1469"><a href="#Warehouse.CollectSupplierResponses.run-1469"><span class="linenos">1469</span></a>                <span class="n">best_supplier</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1470"><a href="#Warehouse.CollectSupplierResponses.run-1470"><span class="linenos">1470</span></a>                <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1471"><a href="#Warehouse.CollectSupplierResponses.run-1471"><span class="linenos">1471</span></a>                
</span><span id="Warehouse.CollectSupplierResponses.run-1472"><a href="#Warehouse.CollectSupplierResponses.run-1472"><span class="linenos">1472</span></a>                <span class="k">for</span> <span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1473"><a href="#Warehouse.CollectSupplierResponses.run-1473"><span class="linenos">1473</span></a>                    <span class="n">score</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">calculate_supplier_score</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1474"><a href="#Warehouse.CollectSupplierResponses.run-1474"><span class="linenos">1474</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1475"><a href="#Warehouse.CollectSupplierResponses.run-1475"><span class="linenos">1475</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Warehouse </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2"> score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1476"><a href="#Warehouse.CollectSupplierResponses.run-1476"><span class="linenos">1476</span></a>                    
</span><span id="Warehouse.CollectSupplierResponses.run-1477"><a href="#Warehouse.CollectSupplierResponses.run-1477"><span class="linenos">1477</span></a>                    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">best_score</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1478"><a href="#Warehouse.CollectSupplierResponses.run-1478"><span class="linenos">1478</span></a>                        <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1479"><a href="#Warehouse.CollectSupplierResponses.run-1479"><span class="linenos">1479</span></a>                        <span class="n">best_supplier</span> <span class="o">=</span> <span class="p">(</span><span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1480"><a href="#Warehouse.CollectSupplierResponses.run-1480"><span class="linenos">1480</span></a>                
</span><span id="Warehouse.CollectSupplierResponses.run-1481"><a href="#Warehouse.CollectSupplierResponses.run-1481"><span class="linenos">1481</span></a>                <span class="k">if</span> <span class="n">best_supplier</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1482"><a href="#Warehouse.CollectSupplierResponses.run-1482"><span class="linenos">1482</span></a>                    <span class="n">supplier_jid</span><span class="p">,</span> <span class="n">accept_msg</span> <span class="o">=</span> <span class="n">best_supplier</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1483"><a href="#Warehouse.CollectSupplierResponses.run-1483"><span class="linenos">1483</span></a>                    <span class="c1"># Essential print - supplier selected</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1484"><a href="#Warehouse.CollectSupplierResponses.run-1484"><span class="linenos">1484</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Selected supplier </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1485"><a href="#Warehouse.CollectSupplierResponses.run-1485"><span class="linenos">1485</span></a>                    
</span><span id="Warehouse.CollectSupplierResponses.run-1486"><a href="#Warehouse.CollectSupplierResponses.run-1486"><span class="linenos">1486</span></a>                    <span class="c1"># Send confirmation to the chosen supplier</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1487"><a href="#Warehouse.CollectSupplierResponses.run-1487"><span class="linenos">1487</span></a>                    <span class="n">confirm_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendWarehouseConfirmation</span><span class="p">(</span><span class="n">accept_msg</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1488"><a href="#Warehouse.CollectSupplierResponses.run-1488"><span class="linenos">1488</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">confirm_behav</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1489"><a href="#Warehouse.CollectSupplierResponses.run-1489"><span class="linenos">1489</span></a>                    <span class="k">await</span> <span class="n">confirm_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1490"><a href="#Warehouse.CollectSupplierResponses.run-1490"><span class="linenos">1490</span></a>                    
</span><span id="Warehouse.CollectSupplierResponses.run-1491"><a href="#Warehouse.CollectSupplierResponses.run-1491"><span class="linenos">1491</span></a>                    <span class="c1"># Send denial to other suppliers that accepted but weren&#39;t chosen</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1492"><a href="#Warehouse.CollectSupplierResponses.run-1492"><span class="linenos">1492</span></a>                    <span class="k">for</span> <span class="n">other_supplier_jid</span><span class="p">,</span> <span class="n">other_msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1493"><a href="#Warehouse.CollectSupplierResponses.run-1493"><span class="linenos">1493</span></a>                        <span class="k">if</span> <span class="n">other_supplier_jid</span> <span class="o">!=</span> <span class="n">supplier_jid</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1494"><a href="#Warehouse.CollectSupplierResponses.run-1494"><span class="linenos">1494</span></a>                            <span class="n">deny_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">SendWarehouseDenial</span><span class="p">(</span><span class="n">other_msg</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1495"><a href="#Warehouse.CollectSupplierResponses.run-1495"><span class="linenos">1495</span></a>                            <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">deny_behav</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1496"><a href="#Warehouse.CollectSupplierResponses.run-1496"><span class="linenos">1496</span></a>                            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1497"><a href="#Warehouse.CollectSupplierResponses.run-1497"><span class="linenos">1497</span></a>                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Sent denial to </span><span class="si">{</span><span class="n">other_supplier_jid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1498"><a href="#Warehouse.CollectSupplierResponses.run-1498"><span class="linenos">1498</span></a>                    
</span><span id="Warehouse.CollectSupplierResponses.run-1499"><a href="#Warehouse.CollectSupplierResponses.run-1499"><span class="linenos">1499</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1500"><a href="#Warehouse.CollectSupplierResponses.run-1500"><span class="linenos">1500</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1501"><a href="#Warehouse.CollectSupplierResponses.run-1501"><span class="linenos">1501</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No acceptances received. All suppliers rejected or timed out.&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1502"><a href="#Warehouse.CollectSupplierResponses.run-1502"><span class="linenos">1502</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Request saved in self.failed_requests&quot;</span><span class="p">)</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1503"><a href="#Warehouse.CollectSupplierResponses.run-1503"><span class="linenos">1503</span></a>                
</span><span id="Warehouse.CollectSupplierResponses.run-1504"><a href="#Warehouse.CollectSupplierResponses.run-1504"><span class="linenos">1504</span></a>                <span class="c1"># Add to failed requests</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1505"><a href="#Warehouse.CollectSupplierResponses.run-1505"><span class="linenos">1505</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;current_buy_request&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span><span class="p">:</span>
</span><span id="Warehouse.CollectSupplierResponses.run-1506"><a href="#Warehouse.CollectSupplierResponses.run-1506"><span class="linenos">1506</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">current_buy_request</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.ReceiveAllSupplierResponses">
                            <input id="Warehouse.ReceiveAllSupplierResponses-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.ReceiveAllSupplierResponses</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Warehouse.ReceiveAllSupplierResponses-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveAllSupplierResponses"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveAllSupplierResponses-1508"><a href="#Warehouse.ReceiveAllSupplierResponses-1508"><span class="linenos">1508</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveAllSupplierResponses</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1509"><a href="#Warehouse.ReceiveAllSupplierResponses-1509"><span class="linenos">1509</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1510"><a href="#Warehouse.ReceiveAllSupplierResponses-1510"><span class="linenos">1510</span></a><span class="sd">        Worker behaviour that collects supplier-accept and supplier-reject responses.</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1511"><a href="#Warehouse.ReceiveAllSupplierResponses-1511"><span class="linenos">1511</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1512"><a href="#Warehouse.ReceiveAllSupplierResponses-1512"><span class="linenos">1512</span></a><span class="sd">        Waits for responses from all suppliers (with timeout), categorizing them into</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1513"><a href="#Warehouse.ReceiveAllSupplierResponses-1513"><span class="linenos">1513</span></a><span class="sd">        acceptances and rejections lists shared with CollectSupplierResponses coordinator.</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1514"><a href="#Warehouse.ReceiveAllSupplierResponses-1514"><span class="linenos">1514</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1515"><a href="#Warehouse.ReceiveAllSupplierResponses-1515"><span class="linenos">1515</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_suppliers</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">acceptances</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">rejections</span> <span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1516"><a href="#Warehouse.ReceiveAllSupplierResponses-1516"><span class="linenos">1516</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1517"><a href="#Warehouse.ReceiveAllSupplierResponses-1517"><span class="linenos">1517</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1518"><a href="#Warehouse.ReceiveAllSupplierResponses-1518"><span class="linenos">1518</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span> <span class="o">=</span> <span class="n">num_suppliers</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1519"><a href="#Warehouse.ReceiveAllSupplierResponses-1519"><span class="linenos">1519</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="n">acceptances</span>  <span class="c1"># Shared list</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1520"><a href="#Warehouse.ReceiveAllSupplierResponses-1520"><span class="linenos">1520</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="n">rejections</span>    <span class="c1"># Shared list</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1521"><a href="#Warehouse.ReceiveAllSupplierResponses-1521"><span class="linenos">1521</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1522"><a href="#Warehouse.ReceiveAllSupplierResponses-1522"><span class="linenos">1522</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds to wait for all responses</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1523"><a href="#Warehouse.ReceiveAllSupplierResponses-1523"><span class="linenos">1523</span></a>            
</span><span id="Warehouse.ReceiveAllSupplierResponses-1524"><a href="#Warehouse.ReceiveAllSupplierResponses-1524"><span class="linenos">1524</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1525"><a href="#Warehouse.ReceiveAllSupplierResponses-1525"><span class="linenos">1525</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1526"><a href="#Warehouse.ReceiveAllSupplierResponses-1526"><span class="linenos">1526</span></a>            
</span><span id="Warehouse.ReceiveAllSupplierResponses-1527"><a href="#Warehouse.ReceiveAllSupplierResponses-1527"><span class="linenos">1527</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1528"><a href="#Warehouse.ReceiveAllSupplierResponses-1528"><span class="linenos">1528</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ReceiveAllSupplierResponses starting - waiting for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="si">}</span><span class="s2"> responses (request_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1529"><a href="#Warehouse.ReceiveAllSupplierResponses-1529"><span class="linenos">1529</span></a>            
</span><span id="Warehouse.ReceiveAllSupplierResponses-1530"><a href="#Warehouse.ReceiveAllSupplierResponses-1530"><span class="linenos">1530</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1531"><a href="#Warehouse.ReceiveAllSupplierResponses-1531"><span class="linenos">1531</span></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1532"><a href="#Warehouse.ReceiveAllSupplierResponses-1532"><span class="linenos">1532</span></a>            
</span><span id="Warehouse.ReceiveAllSupplierResponses-1533"><a href="#Warehouse.ReceiveAllSupplierResponses-1533"><span class="linenos">1533</span></a>            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1534"><a href="#Warehouse.ReceiveAllSupplierResponses-1534"><span class="linenos">1534</span></a>                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1535"><a href="#Warehouse.ReceiveAllSupplierResponses-1535"><span class="linenos">1535</span></a>                <span class="n">remaining_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">-</span> <span class="n">elapsed</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1536"><a href="#Warehouse.ReceiveAllSupplierResponses-1536"><span class="linenos">1536</span></a>                
</span><span id="Warehouse.ReceiveAllSupplierResponses-1537"><a href="#Warehouse.ReceiveAllSupplierResponses-1537"><span class="linenos">1537</span></a>                <span class="k">if</span> <span class="n">remaining_timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1538"><a href="#Warehouse.ReceiveAllSupplierResponses-1538"><span class="linenos">1538</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1539"><a href="#Warehouse.ReceiveAllSupplierResponses-1539"><span class="linenos">1539</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Timeout: Only received </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="si">}</span><span class="s2"> responses&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1540"><a href="#Warehouse.ReceiveAllSupplierResponses-1540"><span class="linenos">1540</span></a>                    <span class="k">break</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1541"><a href="#Warehouse.ReceiveAllSupplierResponses-1541"><span class="linenos">1541</span></a>                
</span><span id="Warehouse.ReceiveAllSupplierResponses-1542"><a href="#Warehouse.ReceiveAllSupplierResponses-1542"><span class="linenos">1542</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1543"><a href="#Warehouse.ReceiveAllSupplierResponses-1543"><span class="linenos">1543</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Waiting for supplier response... (timeout=</span><span class="si">{</span><span class="n">remaining_timeout</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1544"><a href="#Warehouse.ReceiveAllSupplierResponses-1544"><span class="linenos">1544</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">remaining_timeout</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1545"><a href="#Warehouse.ReceiveAllSupplierResponses-1545"><span class="linenos">1545</span></a>                
</span><span id="Warehouse.ReceiveAllSupplierResponses-1546"><a href="#Warehouse.ReceiveAllSupplierResponses-1546"><span class="linenos">1546</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1547"><a href="#Warehouse.ReceiveAllSupplierResponses-1547"><span class="linenos">1547</span></a>                    <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1548"><a href="#Warehouse.ReceiveAllSupplierResponses-1548"><span class="linenos">1548</span></a>                    <span class="n">supplier_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1549"><a href="#Warehouse.ReceiveAllSupplierResponses-1549"><span class="linenos">1549</span></a>                    
</span><span id="Warehouse.ReceiveAllSupplierResponses-1550"><a href="#Warehouse.ReceiveAllSupplierResponses-1550"><span class="linenos">1550</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1551"><a href="#Warehouse.ReceiveAllSupplierResponses-1551"><span class="linenos">1551</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received message from </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2"> with performative=</span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1552"><a href="#Warehouse.ReceiveAllSupplierResponses-1552"><span class="linenos">1552</span></a>                    
</span><span id="Warehouse.ReceiveAllSupplierResponses-1553"><a href="#Warehouse.ReceiveAllSupplierResponses-1553"><span class="linenos">1553</span></a>                    <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;supplier-accept&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1554"><a href="#Warehouse.ReceiveAllSupplierResponses-1554"><span class="linenos">1554</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1555"><a href="#Warehouse.ReceiveAllSupplierResponses-1555"><span class="linenos">1555</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1556"><a href="#Warehouse.ReceiveAllSupplierResponses-1556"><span class="linenos">1556</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1557"><a href="#Warehouse.ReceiveAllSupplierResponses-1557"><span class="linenos">1557</span></a>                        
</span><span id="Warehouse.ReceiveAllSupplierResponses-1558"><a href="#Warehouse.ReceiveAllSupplierResponses-1558"><span class="linenos">1558</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1559"><a href="#Warehouse.ReceiveAllSupplierResponses-1559"><span class="linenos">1559</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received acceptance from </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1560"><a href="#Warehouse.ReceiveAllSupplierResponses-1560"><span class="linenos">1560</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1561"><a href="#Warehouse.ReceiveAllSupplierResponses-1561"><span class="linenos">1561</span></a>                        
</span><span id="Warehouse.ReceiveAllSupplierResponses-1562"><a href="#Warehouse.ReceiveAllSupplierResponses-1562"><span class="linenos">1562</span></a>                    <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;supplier-reject&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1563"><a href="#Warehouse.ReceiveAllSupplierResponses-1563"><span class="linenos">1563</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1564"><a href="#Warehouse.ReceiveAllSupplierResponses-1564"><span class="linenos">1564</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1565"><a href="#Warehouse.ReceiveAllSupplierResponses-1565"><span class="linenos">1565</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1566"><a href="#Warehouse.ReceiveAllSupplierResponses-1566"><span class="linenos">1566</span></a>                        <span class="n">reason</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1567"><a href="#Warehouse.ReceiveAllSupplierResponses-1567"><span class="linenos">1567</span></a>                        
</span><span id="Warehouse.ReceiveAllSupplierResponses-1568"><a href="#Warehouse.ReceiveAllSupplierResponses-1568"><span class="linenos">1568</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1569"><a href="#Warehouse.ReceiveAllSupplierResponses-1569"><span class="linenos">1569</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received rejection from </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> (reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1570"><a href="#Warehouse.ReceiveAllSupplierResponses-1570"><span class="linenos">1570</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1571"><a href="#Warehouse.ReceiveAllSupplierResponses-1571"><span class="linenos">1571</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1572"><a href="#Warehouse.ReceiveAllSupplierResponses-1572"><span class="linenos">1572</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1573"><a href="#Warehouse.ReceiveAllSupplierResponses-1573"><span class="linenos">1573</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; WARNING: Received unknown performative: </span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1574"><a href="#Warehouse.ReceiveAllSupplierResponses-1574"><span class="linenos">1574</span></a>                    
</span><span id="Warehouse.ReceiveAllSupplierResponses-1575"><a href="#Warehouse.ReceiveAllSupplierResponses-1575"><span class="linenos">1575</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1576"><a href="#Warehouse.ReceiveAllSupplierResponses-1576"><span class="linenos">1576</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1577"><a href="#Warehouse.ReceiveAllSupplierResponses-1577"><span class="linenos">1577</span></a>                    <span class="c1"># No more messages, timeout</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1578"><a href="#Warehouse.ReceiveAllSupplierResponses-1578"><span class="linenos">1578</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1579"><a href="#Warehouse.ReceiveAllSupplierResponses-1579"><span class="linenos">1579</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No message received in timeout window&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1580"><a href="#Warehouse.ReceiveAllSupplierResponses-1580"><span class="linenos">1580</span></a>                    <span class="k">break</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1581"><a href="#Warehouse.ReceiveAllSupplierResponses-1581"><span class="linenos">1581</span></a>            
</span><span id="Warehouse.ReceiveAllSupplierResponses-1582"><a href="#Warehouse.ReceiveAllSupplierResponses-1582"><span class="linenos">1582</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses-1583"><a href="#Warehouse.ReceiveAllSupplierResponses-1583"><span class="linenos">1583</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Finished collecting responses: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> accepts, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejects&quot;</span><span class="p">)</span>               
</span></pre></div>


            <div class="docstring"><p>Worker behaviour that collects supplier-accept and supplier-reject responses.</p>

<p>Waits for responses from all suppliers (with timeout), categorizing them into
acceptances and rejections lists shared with CollectSupplierResponses coordinator.</p>
</div>


                            <div id="Warehouse.ReceiveAllSupplierResponses.__init__" class="classattr">
                                        <input id="Warehouse.ReceiveAllSupplierResponses.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Warehouse.ReceiveAllSupplierResponses</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">request_id</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">num_suppliers</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">acceptances</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">rejections</span><span class="p">:</span> <span class="nb">list</span></span>)</span>

                <label class="view-source-button" for="Warehouse.ReceiveAllSupplierResponses.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveAllSupplierResponses.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveAllSupplierResponses.__init__-1515"><a href="#Warehouse.ReceiveAllSupplierResponses.__init__-1515"><span class="linenos">1515</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_suppliers</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">acceptances</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">rejections</span> <span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.__init__-1516"><a href="#Warehouse.ReceiveAllSupplierResponses.__init__-1516"><span class="linenos">1516</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.__init__-1517"><a href="#Warehouse.ReceiveAllSupplierResponses.__init__-1517"><span class="linenos">1517</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.__init__-1518"><a href="#Warehouse.ReceiveAllSupplierResponses.__init__-1518"><span class="linenos">1518</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span> <span class="o">=</span> <span class="n">num_suppliers</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.__init__-1519"><a href="#Warehouse.ReceiveAllSupplierResponses.__init__-1519"><span class="linenos">1519</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span> <span class="o">=</span> <span class="n">acceptances</span>  <span class="c1"># Shared list</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.__init__-1520"><a href="#Warehouse.ReceiveAllSupplierResponses.__init__-1520"><span class="linenos">1520</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span> <span class="o">=</span> <span class="n">rejections</span>    <span class="c1"># Shared list</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.__init__-1521"><a href="#Warehouse.ReceiveAllSupplierResponses.__init__-1521"><span class="linenos">1521</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.__init__-1522"><a href="#Warehouse.ReceiveAllSupplierResponses.__init__-1522"><span class="linenos">1522</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds to wait for all responses</span>
</span></pre></div>


    

                            </div>
                            <div id="Warehouse.ReceiveAllSupplierResponses.request_id" class="classattr">
                                <div class="attr variable">
            <span class="name">request_id</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.ReceiveAllSupplierResponses.request_id"></a>
    
    

                            </div>
                            <div id="Warehouse.ReceiveAllSupplierResponses.num_suppliers" class="classattr">
                                <div class="attr variable">
            <span class="name">num_suppliers</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.ReceiveAllSupplierResponses.num_suppliers"></a>
    
    

                            </div>
                            <div id="Warehouse.ReceiveAllSupplierResponses.acceptances" class="classattr">
                                <div class="attr variable">
            <span class="name">acceptances</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.ReceiveAllSupplierResponses.acceptances"></a>
    
    

                            </div>
                            <div id="Warehouse.ReceiveAllSupplierResponses.rejections" class="classattr">
                                <div class="attr variable">
            <span class="name">rejections</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.ReceiveAllSupplierResponses.rejections"></a>
    
    

                            </div>
                            <div id="Warehouse.ReceiveAllSupplierResponses.responses_received" class="classattr">
                                <div class="attr variable">
            <span class="name">responses_received</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.ReceiveAllSupplierResponses.responses_received"></a>
    
    

                            </div>
                            <div id="Warehouse.ReceiveAllSupplierResponses.timeout" class="classattr">
                                <div class="attr variable">
            <span class="name">timeout</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.ReceiveAllSupplierResponses.timeout"></a>
    
    

                            </div>
                            <div id="Warehouse.ReceiveAllSupplierResponses.run" class="classattr">
                                        <input id="Warehouse.ReceiveAllSupplierResponses.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.ReceiveAllSupplierResponses.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveAllSupplierResponses.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveAllSupplierResponses.run-1524"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1524"><span class="linenos">1524</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1525"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1525"><span class="linenos">1525</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1526"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1526"><span class="linenos">1526</span></a>            
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1527"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1527"><span class="linenos">1527</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1528"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1528"><span class="linenos">1528</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ReceiveAllSupplierResponses starting - waiting for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="si">}</span><span class="s2"> responses (request_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1529"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1529"><span class="linenos">1529</span></a>            
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1530"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1530"><span class="linenos">1530</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1531"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1531"><span class="linenos">1531</span></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1532"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1532"><span class="linenos">1532</span></a>            
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1533"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1533"><span class="linenos">1533</span></a>            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1534"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1534"><span class="linenos">1534</span></a>                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1535"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1535"><span class="linenos">1535</span></a>                <span class="n">remaining_timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">-</span> <span class="n">elapsed</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1536"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1536"><span class="linenos">1536</span></a>                
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1537"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1537"><span class="linenos">1537</span></a>                <span class="k">if</span> <span class="n">remaining_timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1538"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1538"><span class="linenos">1538</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1539"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1539"><span class="linenos">1539</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Timeout: Only received </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_suppliers</span><span class="si">}</span><span class="s2"> responses&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1540"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1540"><span class="linenos">1540</span></a>                    <span class="k">break</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1541"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1541"><span class="linenos">1541</span></a>                
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1542"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1542"><span class="linenos">1542</span></a>                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1543"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1543"><span class="linenos">1543</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Waiting for supplier response... (timeout=</span><span class="si">{</span><span class="n">remaining_timeout</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1544"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1544"><span class="linenos">1544</span></a>                <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">remaining_timeout</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1545"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1545"><span class="linenos">1545</span></a>                
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1546"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1546"><span class="linenos">1546</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1547"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1547"><span class="linenos">1547</span></a>                    <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1548"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1548"><span class="linenos">1548</span></a>                    <span class="n">supplier_jid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1549"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1549"><span class="linenos">1549</span></a>                    
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1550"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1550"><span class="linenos">1550</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1551"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1551"><span class="linenos">1551</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received message from </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2"> with performative=</span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1552"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1552"><span class="linenos">1552</span></a>                    
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1553"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1553"><span class="linenos">1553</span></a>                    <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;supplier-accept&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1554"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1554"><span class="linenos">1554</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1555"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1555"><span class="linenos">1555</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1556"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1556"><span class="linenos">1556</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1557"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1557"><span class="linenos">1557</span></a>                        
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1558"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1558"><span class="linenos">1558</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1559"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1559"><span class="linenos">1559</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received acceptance from </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1560"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1560"><span class="linenos">1560</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1561"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1561"><span class="linenos">1561</span></a>                        
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1562"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1562"><span class="linenos">1562</span></a>                    <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;supplier-reject&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1563"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1563"><span class="linenos">1563</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1564"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1564"><span class="linenos">1564</span></a>                        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1565"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1565"><span class="linenos">1565</span></a>                        <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1566"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1566"><span class="linenos">1566</span></a>                        <span class="n">reason</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1567"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1567"><span class="linenos">1567</span></a>                        
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1568"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1568"><span class="linenos">1568</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1569"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1569"><span class="linenos">1569</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Received rejection from </span><span class="si">{</span><span class="n">supplier_jid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2"> (reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1570"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1570"><span class="linenos">1570</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">supplier_jid</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1571"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1571"><span class="linenos">1571</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1572"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1572"><span class="linenos">1572</span></a>                        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1573"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1573"><span class="linenos">1573</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; WARNING: Received unknown performative: </span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1574"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1574"><span class="linenos">1574</span></a>                    
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1575"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1575"><span class="linenos">1575</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">responses_received</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1576"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1576"><span class="linenos">1576</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1577"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1577"><span class="linenos">1577</span></a>                    <span class="c1"># No more messages, timeout</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1578"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1578"><span class="linenos">1578</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1579"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1579"><span class="linenos">1579</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; No message received in timeout window&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1580"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1580"><span class="linenos">1580</span></a>                    <span class="k">break</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1581"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1581"><span class="linenos">1581</span></a>            
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1582"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1582"><span class="linenos">1582</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveAllSupplierResponses.run-1583"><a href="#Warehouse.ReceiveAllSupplierResponses.run-1583"><span class="linenos">1583</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Finished collecting responses: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptances</span><span class="p">)</span><span class="si">}</span><span class="s2"> accepts, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rejections</span><span class="p">)</span><span class="si">}</span><span class="s2"> rejects&quot;</span><span class="p">)</span>               
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.SendWarehouseConfirmation">
                            <input id="Warehouse.SendWarehouseConfirmation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.SendWarehouseConfirmation</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Warehouse.SendWarehouseConfirmation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseConfirmation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.SendWarehouseConfirmation-1585"><a href="#Warehouse.SendWarehouseConfirmation-1585"><span class="linenos">1585</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SendWarehouseConfirmation</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1586"><a href="#Warehouse.SendWarehouseConfirmation-1586"><span class="linenos">1586</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1587"><a href="#Warehouse.SendWarehouseConfirmation-1587"><span class="linenos">1587</span></a><span class="sd">        Sends warehouse-confirm (FIPA accept-proposal) to selected supplier.</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1588"><a href="#Warehouse.SendWarehouseConfirmation-1588"><span class="linenos">1588</span></a><span class="sd">        </span>
</span><span id="Warehouse.SendWarehouseConfirmation-1589"><a href="#Warehouse.SendWarehouseConfirmation-1589"><span class="linenos">1589</span></a><span class="sd">        Awards the contract to the best supplier, updates stock immediately,</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1590"><a href="#Warehouse.SendWarehouseConfirmation-1590"><span class="linenos">1590</span></a><span class="sd">        and notifies the supplier that their proposal was accepted.</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1591"><a href="#Warehouse.SendWarehouseConfirmation-1591"><span class="linenos">1591</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1592"><a href="#Warehouse.SendWarehouseConfirmation-1592"><span class="linenos">1592</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1593"><a href="#Warehouse.SendWarehouseConfirmation-1593"><span class="linenos">1593</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1594"><a href="#Warehouse.SendWarehouseConfirmation-1594"><span class="linenos">1594</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1595"><a href="#Warehouse.SendWarehouseConfirmation-1595"><span class="linenos">1595</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1596"><a href="#Warehouse.SendWarehouseConfirmation-1596"><span class="linenos">1596</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1597"><a href="#Warehouse.SendWarehouseConfirmation-1597"><span class="linenos">1597</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1598"><a href="#Warehouse.SendWarehouseConfirmation-1598"><span class="linenos">1598</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1599"><a href="#Warehouse.SendWarehouseConfirmation-1599"><span class="linenos">1599</span></a>            
</span><span id="Warehouse.SendWarehouseConfirmation-1600"><a href="#Warehouse.SendWarehouseConfirmation-1600"><span class="linenos">1600</span></a>        
</span><span id="Warehouse.SendWarehouseConfirmation-1601"><a href="#Warehouse.SendWarehouseConfirmation-1601"><span class="linenos">1601</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1602"><a href="#Warehouse.SendWarehouseConfirmation-1602"><span class="linenos">1602</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1603"><a href="#Warehouse.SendWarehouseConfirmation-1603"><span class="linenos">1603</span></a>            
</span><span id="Warehouse.SendWarehouseConfirmation-1604"><a href="#Warehouse.SendWarehouseConfirmation-1604"><span class="linenos">1604</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1605"><a href="#Warehouse.SendWarehouseConfirmation-1605"><span class="linenos">1605</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1606"><a href="#Warehouse.SendWarehouseConfirmation-1606"><span class="linenos">1606</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1607"><a href="#Warehouse.SendWarehouseConfirmation-1607"><span class="linenos">1607</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>           
</span><span id="Warehouse.SendWarehouseConfirmation-1608"><a href="#Warehouse.SendWarehouseConfirmation-1608"><span class="linenos">1608</span></a>            
</span><span id="Warehouse.SendWarehouseConfirmation-1609"><a href="#Warehouse.SendWarehouseConfirmation-1609"><span class="linenos">1609</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1610"><a href="#Warehouse.SendWarehouseConfirmation-1610"><span class="linenos">1610</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-confirm&quot;</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1611"><a href="#Warehouse.SendWarehouseConfirmation-1611"><span class="linenos">1611</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;supplier_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1612"><a href="#Warehouse.SendWarehouseConfirmation-1612"><span class="linenos">1612</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1613"><a href="#Warehouse.SendWarehouseConfirmation-1613"><span class="linenos">1613</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1614"><a href="#Warehouse.SendWarehouseConfirmation-1614"><span class="linenos">1614</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1615"><a href="#Warehouse.SendWarehouseConfirmation-1615"><span class="linenos">1615</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1616"><a href="#Warehouse.SendWarehouseConfirmation-1616"><span class="linenos">1616</span></a>            
</span><span id="Warehouse.SendWarehouseConfirmation-1617"><a href="#Warehouse.SendWarehouseConfirmation-1617"><span class="linenos">1617</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1618"><a href="#Warehouse.SendWarehouseConfirmation-1618"><span class="linenos">1618</span></a>            
</span><span id="Warehouse.SendWarehouseConfirmation-1619"><a href="#Warehouse.SendWarehouseConfirmation-1619"><span class="linenos">1619</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.SendWarehouseConfirmation-1620"><a href="#Warehouse.SendWarehouseConfirmation-1620"><span class="linenos">1620</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Confirmation sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sends warehouse-confirm (FIPA accept-proposal) to selected supplier.</p>

<p>Awards the contract to the best supplier, updates stock immediately,
and notifies the supplier that their proposal was accepted.</p>
</div>


                            <div id="Warehouse.SendWarehouseConfirmation.__init__" class="classattr">
                                        <input id="Warehouse.SendWarehouseConfirmation.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Warehouse.SendWarehouseConfirmation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span></span>)</span>

                <label class="view-source-button" for="Warehouse.SendWarehouseConfirmation.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseConfirmation.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.SendWarehouseConfirmation.__init__-1592"><a href="#Warehouse.SendWarehouseConfirmation.__init__-1592"><span class="linenos">1592</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Warehouse.SendWarehouseConfirmation.__init__-1593"><a href="#Warehouse.SendWarehouseConfirmation.__init__-1593"><span class="linenos">1593</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.SendWarehouseConfirmation.__init__-1594"><a href="#Warehouse.SendWarehouseConfirmation.__init__-1594"><span class="linenos">1594</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Warehouse.SendWarehouseConfirmation.__init__-1595"><a href="#Warehouse.SendWarehouseConfirmation.__init__-1595"><span class="linenos">1595</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseConfirmation.__init__-1596"><a href="#Warehouse.SendWarehouseConfirmation.__init__-1596"><span class="linenos">1596</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseConfirmation.__init__-1597"><a href="#Warehouse.SendWarehouseConfirmation.__init__-1597"><span class="linenos">1597</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.SendWarehouseConfirmation.__init__-1598"><a href="#Warehouse.SendWarehouseConfirmation.__init__-1598"><span class="linenos">1598</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                            <div id="Warehouse.SendWarehouseConfirmation.dest" class="classattr">
                                <div class="attr variable">
            <span class="name">dest</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseConfirmation.dest"></a>
    
    

                            </div>
                            <div id="Warehouse.SendWarehouseConfirmation.request_id" class="classattr">
                                <div class="attr variable">
            <span class="name">request_id</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseConfirmation.request_id"></a>
    
    

                            </div>
                            <div id="Warehouse.SendWarehouseConfirmation.quantity" class="classattr">
                                <div class="attr variable">
            <span class="name">quantity</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseConfirmation.quantity"></a>
    
    

                            </div>
                            <div id="Warehouse.SendWarehouseConfirmation.product" class="classattr">
                                <div class="attr variable">
            <span class="name">product</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseConfirmation.product"></a>
    
    

                            </div>
                            <div id="Warehouse.SendWarehouseConfirmation.run" class="classattr">
                                        <input id="Warehouse.SendWarehouseConfirmation.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.SendWarehouseConfirmation.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseConfirmation.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.SendWarehouseConfirmation.run-1601"><a href="#Warehouse.SendWarehouseConfirmation.run-1601"><span class="linenos">1601</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1602"><a href="#Warehouse.SendWarehouseConfirmation.run-1602"><span class="linenos">1602</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1603"><a href="#Warehouse.SendWarehouseConfirmation.run-1603"><span class="linenos">1603</span></a>            
</span><span id="Warehouse.SendWarehouseConfirmation.run-1604"><a href="#Warehouse.SendWarehouseConfirmation.run-1604"><span class="linenos">1604</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1605"><a href="#Warehouse.SendWarehouseConfirmation.run-1605"><span class="linenos">1605</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1606"><a href="#Warehouse.SendWarehouseConfirmation.run-1606"><span class="linenos">1606</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1607"><a href="#Warehouse.SendWarehouseConfirmation.run-1607"><span class="linenos">1607</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>           
</span><span id="Warehouse.SendWarehouseConfirmation.run-1608"><a href="#Warehouse.SendWarehouseConfirmation.run-1608"><span class="linenos">1608</span></a>            
</span><span id="Warehouse.SendWarehouseConfirmation.run-1609"><a href="#Warehouse.SendWarehouseConfirmation.run-1609"><span class="linenos">1609</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1610"><a href="#Warehouse.SendWarehouseConfirmation.run-1610"><span class="linenos">1610</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-confirm&quot;</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1611"><a href="#Warehouse.SendWarehouseConfirmation.run-1611"><span class="linenos">1611</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;supplier_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1612"><a href="#Warehouse.SendWarehouseConfirmation.run-1612"><span class="linenos">1612</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1613"><a href="#Warehouse.SendWarehouseConfirmation.run-1613"><span class="linenos">1613</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1614"><a href="#Warehouse.SendWarehouseConfirmation.run-1614"><span class="linenos">1614</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1615"><a href="#Warehouse.SendWarehouseConfirmation.run-1615"><span class="linenos">1615</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1616"><a href="#Warehouse.SendWarehouseConfirmation.run-1616"><span class="linenos">1616</span></a>            
</span><span id="Warehouse.SendWarehouseConfirmation.run-1617"><a href="#Warehouse.SendWarehouseConfirmation.run-1617"><span class="linenos">1617</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1618"><a href="#Warehouse.SendWarehouseConfirmation.run-1618"><span class="linenos">1618</span></a>            
</span><span id="Warehouse.SendWarehouseConfirmation.run-1619"><a href="#Warehouse.SendWarehouseConfirmation.run-1619"><span class="linenos">1619</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.SendWarehouseConfirmation.run-1620"><a href="#Warehouse.SendWarehouseConfirmation.run-1620"><span class="linenos">1620</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Confirmation sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.SendWarehouseDenial">
                            <input id="Warehouse.SendWarehouseDenial-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.SendWarehouseDenial</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Warehouse.SendWarehouseDenial-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseDenial"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.SendWarehouseDenial-1622"><a href="#Warehouse.SendWarehouseDenial-1622"><span class="linenos">1622</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SendWarehouseDenial</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.SendWarehouseDenial-1623"><a href="#Warehouse.SendWarehouseDenial-1623"><span class="linenos">1623</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.SendWarehouseDenial-1624"><a href="#Warehouse.SendWarehouseDenial-1624"><span class="linenos">1624</span></a><span class="sd">        Sends warehouse-deny (FIPA reject-proposal) to non-selected suppliers.</span>
</span><span id="Warehouse.SendWarehouseDenial-1625"><a href="#Warehouse.SendWarehouseDenial-1625"><span class="linenos">1625</span></a><span class="sd">        </span>
</span><span id="Warehouse.SendWarehouseDenial-1626"><a href="#Warehouse.SendWarehouseDenial-1626"><span class="linenos">1626</span></a><span class="sd">        Notifies suppliers that their proposal was not accepted, allowing them</span>
</span><span id="Warehouse.SendWarehouseDenial-1627"><a href="#Warehouse.SendWarehouseDenial-1627"><span class="linenos">1627</span></a><span class="sd">        to release any resources they may have reserved.</span>
</span><span id="Warehouse.SendWarehouseDenial-1628"><a href="#Warehouse.SendWarehouseDenial-1628"><span class="linenos">1628</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.SendWarehouseDenial-1629"><a href="#Warehouse.SendWarehouseDenial-1629"><span class="linenos">1629</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Warehouse.SendWarehouseDenial-1630"><a href="#Warehouse.SendWarehouseDenial-1630"><span class="linenos">1630</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.SendWarehouseDenial-1631"><a href="#Warehouse.SendWarehouseDenial-1631"><span class="linenos">1631</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Warehouse.SendWarehouseDenial-1632"><a href="#Warehouse.SendWarehouseDenial-1632"><span class="linenos">1632</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseDenial-1633"><a href="#Warehouse.SendWarehouseDenial-1633"><span class="linenos">1633</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseDenial-1634"><a href="#Warehouse.SendWarehouseDenial-1634"><span class="linenos">1634</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.SendWarehouseDenial-1635"><a href="#Warehouse.SendWarehouseDenial-1635"><span class="linenos">1635</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.SendWarehouseDenial-1636"><a href="#Warehouse.SendWarehouseDenial-1636"><span class="linenos">1636</span></a>        
</span><span id="Warehouse.SendWarehouseDenial-1637"><a href="#Warehouse.SendWarehouseDenial-1637"><span class="linenos">1637</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.SendWarehouseDenial-1638"><a href="#Warehouse.SendWarehouseDenial-1638"><span class="linenos">1638</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.SendWarehouseDenial-1639"><a href="#Warehouse.SendWarehouseDenial-1639"><span class="linenos">1639</span></a>            
</span><span id="Warehouse.SendWarehouseDenial-1640"><a href="#Warehouse.SendWarehouseDenial-1640"><span class="linenos">1640</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseDenial-1641"><a href="#Warehouse.SendWarehouseDenial-1641"><span class="linenos">1641</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-deny&quot;</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseDenial-1642"><a href="#Warehouse.SendWarehouseDenial-1642"><span class="linenos">1642</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;supplier_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseDenial-1643"><a href="#Warehouse.SendWarehouseDenial-1643"><span class="linenos">1643</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseDenial-1644"><a href="#Warehouse.SendWarehouseDenial-1644"><span class="linenos">1644</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseDenial-1645"><a href="#Warehouse.SendWarehouseDenial-1645"><span class="linenos">1645</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseDenial-1646"><a href="#Warehouse.SendWarehouseDenial-1646"><span class="linenos">1646</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.SendWarehouseDenial-1647"><a href="#Warehouse.SendWarehouseDenial-1647"><span class="linenos">1647</span></a>            
</span><span id="Warehouse.SendWarehouseDenial-1648"><a href="#Warehouse.SendWarehouseDenial-1648"><span class="linenos">1648</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseDenial-1649"><a href="#Warehouse.SendWarehouseDenial-1649"><span class="linenos">1649</span></a>            
</span><span id="Warehouse.SendWarehouseDenial-1650"><a href="#Warehouse.SendWarehouseDenial-1650"><span class="linenos">1650</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.SendWarehouseDenial-1651"><a href="#Warehouse.SendWarehouseDenial-1651"><span class="linenos">1651</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Denial sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sends warehouse-deny (FIPA reject-proposal) to non-selected suppliers.</p>

<p>Notifies suppliers that their proposal was not accepted, allowing them
to release any resources they may have reserved.</p>
</div>


                            <div id="Warehouse.SendWarehouseDenial.__init__" class="classattr">
                                        <input id="Warehouse.SendWarehouseDenial.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Warehouse.SendWarehouseDenial</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">msg</span><span class="p">:</span> <span class="n">spade</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span></span>)</span>

                <label class="view-source-button" for="Warehouse.SendWarehouseDenial.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseDenial.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.SendWarehouseDenial.__init__-1629"><a href="#Warehouse.SendWarehouseDenial.__init__-1629"><span class="linenos">1629</span></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
</span><span id="Warehouse.SendWarehouseDenial.__init__-1630"><a href="#Warehouse.SendWarehouseDenial.__init__-1630"><span class="linenos">1630</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Warehouse.SendWarehouseDenial.__init__-1631"><a href="#Warehouse.SendWarehouseDenial.__init__-1631"><span class="linenos">1631</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender</span>
</span><span id="Warehouse.SendWarehouseDenial.__init__-1632"><a href="#Warehouse.SendWarehouseDenial.__init__-1632"><span class="linenos">1632</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseDenial.__init__-1633"><a href="#Warehouse.SendWarehouseDenial.__init__-1633"><span class="linenos">1633</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseDenial.__init__-1634"><a href="#Warehouse.SendWarehouseDenial.__init__-1634"><span class="linenos">1634</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.SendWarehouseDenial.__init__-1635"><a href="#Warehouse.SendWarehouseDenial.__init__-1635"><span class="linenos">1635</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                            <div id="Warehouse.SendWarehouseDenial.dest" class="classattr">
                                <div class="attr variable">
            <span class="name">dest</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseDenial.dest"></a>
    
    

                            </div>
                            <div id="Warehouse.SendWarehouseDenial.request_id" class="classattr">
                                <div class="attr variable">
            <span class="name">request_id</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseDenial.request_id"></a>
    
    

                            </div>
                            <div id="Warehouse.SendWarehouseDenial.quantity" class="classattr">
                                <div class="attr variable">
            <span class="name">quantity</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseDenial.quantity"></a>
    
    

                            </div>
                            <div id="Warehouse.SendWarehouseDenial.product" class="classattr">
                                <div class="attr variable">
            <span class="name">product</span>

        
    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseDenial.product"></a>
    
    

                            </div>
                            <div id="Warehouse.SendWarehouseDenial.run" class="classattr">
                                        <input id="Warehouse.SendWarehouseDenial.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.SendWarehouseDenial.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.SendWarehouseDenial.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.SendWarehouseDenial.run-1637"><a href="#Warehouse.SendWarehouseDenial.run-1637"><span class="linenos">1637</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.SendWarehouseDenial.run-1638"><a href="#Warehouse.SendWarehouseDenial.run-1638"><span class="linenos">1638</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.SendWarehouseDenial.run-1639"><a href="#Warehouse.SendWarehouseDenial.run-1639"><span class="linenos">1639</span></a>            
</span><span id="Warehouse.SendWarehouseDenial.run-1640"><a href="#Warehouse.SendWarehouseDenial.run-1640"><span class="linenos">1640</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseDenial.run-1641"><a href="#Warehouse.SendWarehouseDenial.run-1641"><span class="linenos">1641</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-deny&quot;</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseDenial.run-1642"><a href="#Warehouse.SendWarehouseDenial.run-1642"><span class="linenos">1642</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;supplier_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseDenial.run-1643"><a href="#Warehouse.SendWarehouseDenial.run-1643"><span class="linenos">1643</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseDenial.run-1644"><a href="#Warehouse.SendWarehouseDenial.run-1644"><span class="linenos">1644</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseDenial.run-1645"><a href="#Warehouse.SendWarehouseDenial.run-1645"><span class="linenos">1645</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.SendWarehouseDenial.run-1646"><a href="#Warehouse.SendWarehouseDenial.run-1646"><span class="linenos">1646</span></a>            <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Warehouse.SendWarehouseDenial.run-1647"><a href="#Warehouse.SendWarehouseDenial.run-1647"><span class="linenos">1647</span></a>            
</span><span id="Warehouse.SendWarehouseDenial.run-1648"><a href="#Warehouse.SendWarehouseDenial.run-1648"><span class="linenos">1648</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.SendWarehouseDenial.run-1649"><a href="#Warehouse.SendWarehouseDenial.run-1649"><span class="linenos">1649</span></a>            
</span><span id="Warehouse.SendWarehouseDenial.run-1650"><a href="#Warehouse.SendWarehouseDenial.run-1650"><span class="linenos">1650</span></a>            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.SendWarehouseDenial.run-1651"><a href="#Warehouse.SendWarehouseDenial.run-1651"><span class="linenos">1651</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Denial sent to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="si">}</span><span class="s2"> for request: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.RetryPreviousBuy">
                            <input id="Warehouse.RetryPreviousBuy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.RetryPreviousBuy</span><wbr>(<span class="base">spade.behaviour.OneShotBehaviour</span>):

                <label class="view-source-button" for="Warehouse.RetryPreviousBuy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.RetryPreviousBuy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.RetryPreviousBuy-1653"><a href="#Warehouse.RetryPreviousBuy-1653"><span class="linenos">1653</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">RetryPreviousBuy</span><span class="p">(</span><span class="n">OneShotBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.RetryPreviousBuy-1654"><a href="#Warehouse.RetryPreviousBuy-1654"><span class="linenos">1654</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.RetryPreviousBuy-1655"><a href="#Warehouse.RetryPreviousBuy-1655"><span class="linenos">1655</span></a><span class="sd">        Retries failed supplier purchase requests from the failed_requests queue.</span>
</span><span id="Warehouse.RetryPreviousBuy-1656"><a href="#Warehouse.RetryPreviousBuy-1656"><span class="linenos">1656</span></a><span class="sd">        </span>
</span><span id="Warehouse.RetryPreviousBuy-1657"><a href="#Warehouse.RetryPreviousBuy-1657"><span class="linenos">1657</span></a><span class="sd">        Dequeues one failed request and re-initiates the FIPA Contract Net Protocol</span>
</span><span id="Warehouse.RetryPreviousBuy-1658"><a href="#Warehouse.RetryPreviousBuy-1658"><span class="linenos">1658</span></a><span class="sd">        with suppliers, reusing the same request_id for traceability.</span>
</span><span id="Warehouse.RetryPreviousBuy-1659"><a href="#Warehouse.RetryPreviousBuy-1659"><span class="linenos">1659</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.RetryPreviousBuy-1660"><a href="#Warehouse.RetryPreviousBuy-1660"><span class="linenos">1660</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.RetryPreviousBuy-1661"><a href="#Warehouse.RetryPreviousBuy-1661"><span class="linenos">1661</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.RetryPreviousBuy-1662"><a href="#Warehouse.RetryPreviousBuy-1662"><span class="linenos">1662</span></a>            
</span><span id="Warehouse.RetryPreviousBuy-1663"><a href="#Warehouse.RetryPreviousBuy-1663"><span class="linenos">1663</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="Warehouse.RetryPreviousBuy-1664"><a href="#Warehouse.RetryPreviousBuy-1664"><span class="linenos">1664</span></a>                <span class="n">request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="Warehouse.RetryPreviousBuy-1665"><a href="#Warehouse.RetryPreviousBuy-1665"><span class="linenos">1665</span></a>                <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.RetryPreviousBuy-1666"><a href="#Warehouse.RetryPreviousBuy-1666"><span class="linenos">1666</span></a>                
</span><span id="Warehouse.RetryPreviousBuy-1667"><a href="#Warehouse.RetryPreviousBuy-1667"><span class="linenos">1667</span></a>                <span class="c1"># Parse quantity and product from request body</span>
</span><span id="Warehouse.RetryPreviousBuy-1668"><a href="#Warehouse.RetryPreviousBuy-1668"><span class="linenos">1668</span></a>                <span class="n">parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy-1669"><a href="#Warehouse.RetryPreviousBuy-1669"><span class="linenos">1669</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.RetryPreviousBuy-1670"><a href="#Warehouse.RetryPreviousBuy-1670"><span class="linenos">1670</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.RetryPreviousBuy-1671"><a href="#Warehouse.RetryPreviousBuy-1671"><span class="linenos">1671</span></a>                
</span><span id="Warehouse.RetryPreviousBuy-1672"><a href="#Warehouse.RetryPreviousBuy-1672"><span class="linenos">1672</span></a>                <span class="c1"># Only send to suppliers, not all contacts</span>
</span><span id="Warehouse.RetryPreviousBuy-1673"><a href="#Warehouse.RetryPreviousBuy-1673"><span class="linenos">1673</span></a>                <span class="n">num_suppliers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy-1674"><a href="#Warehouse.RetryPreviousBuy-1674"><span class="linenos">1674</span></a>                
</span><span id="Warehouse.RetryPreviousBuy-1675"><a href="#Warehouse.RetryPreviousBuy-1675"><span class="linenos">1675</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Warehouse.RetryPreviousBuy-1676"><a href="#Warehouse.RetryPreviousBuy-1676"><span class="linenos">1676</span></a>                <span class="k">for</span> <span class="n">supplier_jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="Warehouse.RetryPreviousBuy-1677"><a href="#Warehouse.RetryPreviousBuy-1677"><span class="linenos">1677</span></a>                    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">supplier_jid</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy-1678"><a href="#Warehouse.RetryPreviousBuy-1678"><span class="linenos">1678</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-buy&quot;</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy-1679"><a href="#Warehouse.RetryPreviousBuy-1679"><span class="linenos">1679</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.RetryPreviousBuy-1680"><a href="#Warehouse.RetryPreviousBuy-1680"><span class="linenos">1680</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.RetryPreviousBuy-1681"><a href="#Warehouse.RetryPreviousBuy-1681"><span class="linenos">1681</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse.RetryPreviousBuy-1682"><a href="#Warehouse.RetryPreviousBuy-1682"><span class="linenos">1682</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
</span><span id="Warehouse.RetryPreviousBuy-1683"><a href="#Warehouse.RetryPreviousBuy-1683"><span class="linenos">1683</span></a>
</span><span id="Warehouse.RetryPreviousBuy-1684"><a href="#Warehouse.RetryPreviousBuy-1684"><span class="linenos">1684</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.RetryPreviousBuy-1685"><a href="#Warehouse.RetryPreviousBuy-1685"><span class="linenos">1685</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Retrying request (id=</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="Warehouse.RetryPreviousBuy-1686"><a href="#Warehouse.RetryPreviousBuy-1686"><span class="linenos">1686</span></a>                              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy-1687"><a href="#Warehouse.RetryPreviousBuy-1687"><span class="linenos">1687</span></a>
</span><span id="Warehouse.RetryPreviousBuy-1688"><a href="#Warehouse.RetryPreviousBuy-1688"><span class="linenos">1688</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy-1689"><a href="#Warehouse.RetryPreviousBuy-1689"><span class="linenos">1689</span></a>
</span><span id="Warehouse.RetryPreviousBuy-1690"><a href="#Warehouse.RetryPreviousBuy-1690"><span class="linenos">1690</span></a>                <span class="c1"># Use CollectSupplierResponses with all required parameters</span>
</span><span id="Warehouse.RetryPreviousBuy-1691"><a href="#Warehouse.RetryPreviousBuy-1691"><span class="linenos">1691</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse.RetryPreviousBuy-1692"><a href="#Warehouse.RetryPreviousBuy-1692"><span class="linenos">1692</span></a>                    <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectSupplierResponses</span><span class="p">(</span>
</span><span id="Warehouse.RetryPreviousBuy-1693"><a href="#Warehouse.RetryPreviousBuy-1693"><span class="linenos">1693</span></a>                        <span class="n">msg</span><span class="p">,</span>
</span><span id="Warehouse.RetryPreviousBuy-1694"><a href="#Warehouse.RetryPreviousBuy-1694"><span class="linenos">1694</span></a>                        <span class="n">request_id</span><span class="p">,</span>
</span><span id="Warehouse.RetryPreviousBuy-1695"><a href="#Warehouse.RetryPreviousBuy-1695"><span class="linenos">1695</span></a>                        <span class="n">num_suppliers</span><span class="p">,</span>
</span><span id="Warehouse.RetryPreviousBuy-1696"><a href="#Warehouse.RetryPreviousBuy-1696"><span class="linenos">1696</span></a>                        <span class="n">quantity</span><span class="p">,</span>
</span><span id="Warehouse.RetryPreviousBuy-1697"><a href="#Warehouse.RetryPreviousBuy-1697"><span class="linenos">1697</span></a>                        <span class="n">product</span>
</span><span id="Warehouse.RetryPreviousBuy-1698"><a href="#Warehouse.RetryPreviousBuy-1698"><span class="linenos">1698</span></a>                    <span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy-1699"><a href="#Warehouse.RetryPreviousBuy-1699"><span class="linenos">1699</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy-1700"><a href="#Warehouse.RetryPreviousBuy-1700"><span class="linenos">1700</span></a>
</span><span id="Warehouse.RetryPreviousBuy-1701"><a href="#Warehouse.RetryPreviousBuy-1701"><span class="linenos">1701</span></a>                    <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Retries failed supplier purchase requests from the failed_requests queue.</p>

<p>Dequeues one failed request and re-initiates the FIPA Contract Net Protocol
with suppliers, reusing the same request_id for traceability.</p>
</div>


                            <div id="Warehouse.RetryPreviousBuy.run" class="classattr">
                                        <input id="Warehouse.RetryPreviousBuy.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.RetryPreviousBuy.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.RetryPreviousBuy.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.RetryPreviousBuy.run-1660"><a href="#Warehouse.RetryPreviousBuy.run-1660"><span class="linenos">1660</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1661"><a href="#Warehouse.RetryPreviousBuy.run-1661"><span class="linenos">1661</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1662"><a href="#Warehouse.RetryPreviousBuy.run-1662"><span class="linenos">1662</span></a>            
</span><span id="Warehouse.RetryPreviousBuy.run-1663"><a href="#Warehouse.RetryPreviousBuy.run-1663"><span class="linenos">1663</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1664"><a href="#Warehouse.RetryPreviousBuy.run-1664"><span class="linenos">1664</span></a>                <span class="n">request</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">failed_requests</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1665"><a href="#Warehouse.RetryPreviousBuy.run-1665"><span class="linenos">1665</span></a>                <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">))</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1666"><a href="#Warehouse.RetryPreviousBuy.run-1666"><span class="linenos">1666</span></a>                
</span><span id="Warehouse.RetryPreviousBuy.run-1667"><a href="#Warehouse.RetryPreviousBuy.run-1667"><span class="linenos">1667</span></a>                <span class="c1"># Parse quantity and product from request body</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1668"><a href="#Warehouse.RetryPreviousBuy.run-1668"><span class="linenos">1668</span></a>                <span class="n">parts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1669"><a href="#Warehouse.RetryPreviousBuy.run-1669"><span class="linenos">1669</span></a>                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1670"><a href="#Warehouse.RetryPreviousBuy.run-1670"><span class="linenos">1670</span></a>                <span class="n">product</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1671"><a href="#Warehouse.RetryPreviousBuy.run-1671"><span class="linenos">1671</span></a>                
</span><span id="Warehouse.RetryPreviousBuy.run-1672"><a href="#Warehouse.RetryPreviousBuy.run-1672"><span class="linenos">1672</span></a>                <span class="c1"># Only send to suppliers, not all contacts</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1673"><a href="#Warehouse.RetryPreviousBuy.run-1673"><span class="linenos">1673</span></a>                <span class="n">num_suppliers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1674"><a href="#Warehouse.RetryPreviousBuy.run-1674"><span class="linenos">1674</span></a>                
</span><span id="Warehouse.RetryPreviousBuy.run-1675"><a href="#Warehouse.RetryPreviousBuy.run-1675"><span class="linenos">1675</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1676"><a href="#Warehouse.RetryPreviousBuy.run-1676"><span class="linenos">1676</span></a>                <span class="k">for</span> <span class="n">supplier_jid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">suppliers</span><span class="p">:</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1677"><a href="#Warehouse.RetryPreviousBuy.run-1677"><span class="linenos">1677</span></a>                    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="n">supplier_jid</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1678"><a href="#Warehouse.RetryPreviousBuy.run-1678"><span class="linenos">1678</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">,</span> <span class="s2">&quot;warehouse-buy&quot;</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1679"><a href="#Warehouse.RetryPreviousBuy.run-1679"><span class="linenos">1679</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;warehouse_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="p">))</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1680"><a href="#Warehouse.RetryPreviousBuy.run-1680"><span class="linenos">1680</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1681"><a href="#Warehouse.RetryPreviousBuy.run-1681"><span class="linenos">1681</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;node_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1682"><a href="#Warehouse.RetryPreviousBuy.run-1682"><span class="linenos">1682</span></a>                    <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1683"><a href="#Warehouse.RetryPreviousBuy.run-1683"><span class="linenos">1683</span></a>
</span><span id="Warehouse.RetryPreviousBuy.run-1684"><a href="#Warehouse.RetryPreviousBuy.run-1684"><span class="linenos">1684</span></a>                    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1685"><a href="#Warehouse.RetryPreviousBuy.run-1685"><span class="linenos">1685</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Retrying request (id=</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">):&quot;</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1686"><a href="#Warehouse.RetryPreviousBuy.run-1686"><span class="linenos">1686</span></a>                              <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1687"><a href="#Warehouse.RetryPreviousBuy.run-1687"><span class="linenos">1687</span></a>
</span><span id="Warehouse.RetryPreviousBuy.run-1688"><a href="#Warehouse.RetryPreviousBuy.run-1688"><span class="linenos">1688</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1689"><a href="#Warehouse.RetryPreviousBuy.run-1689"><span class="linenos">1689</span></a>
</span><span id="Warehouse.RetryPreviousBuy.run-1690"><a href="#Warehouse.RetryPreviousBuy.run-1690"><span class="linenos">1690</span></a>                <span class="c1"># Use CollectSupplierResponses with all required parameters</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1691"><a href="#Warehouse.RetryPreviousBuy.run-1691"><span class="linenos">1691</span></a>                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1692"><a href="#Warehouse.RetryPreviousBuy.run-1692"><span class="linenos">1692</span></a>                    <span class="n">behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">CollectSupplierResponses</span><span class="p">(</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1693"><a href="#Warehouse.RetryPreviousBuy.run-1693"><span class="linenos">1693</span></a>                        <span class="n">msg</span><span class="p">,</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1694"><a href="#Warehouse.RetryPreviousBuy.run-1694"><span class="linenos">1694</span></a>                        <span class="n">request_id</span><span class="p">,</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1695"><a href="#Warehouse.RetryPreviousBuy.run-1695"><span class="linenos">1695</span></a>                        <span class="n">num_suppliers</span><span class="p">,</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1696"><a href="#Warehouse.RetryPreviousBuy.run-1696"><span class="linenos">1696</span></a>                        <span class="n">quantity</span><span class="p">,</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1697"><a href="#Warehouse.RetryPreviousBuy.run-1697"><span class="linenos">1697</span></a>                        <span class="n">product</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1698"><a href="#Warehouse.RetryPreviousBuy.run-1698"><span class="linenos">1698</span></a>                    <span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1699"><a href="#Warehouse.RetryPreviousBuy.run-1699"><span class="linenos">1699</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">behav</span><span class="p">)</span>
</span><span id="Warehouse.RetryPreviousBuy.run-1700"><a href="#Warehouse.RetryPreviousBuy.run-1700"><span class="linenos">1700</span></a>
</span><span id="Warehouse.RetryPreviousBuy.run-1701"><a href="#Warehouse.RetryPreviousBuy.run-1701"><span class="linenos">1701</span></a>                    <span class="k">await</span> <span class="n">behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.HandleResupply">
                            <input id="Warehouse.HandleResupply-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.HandleResupply</span><wbr>(<span class="base">spade.behaviour.PeriodicBehaviour</span>):

                <label class="view-source-button" for="Warehouse.HandleResupply-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.HandleResupply"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.HandleResupply-1703"><a href="#Warehouse.HandleResupply-1703"><span class="linenos">1703</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">HandleResupply</span><span class="p">(</span><span class="n">PeriodicBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.HandleResupply-1704"><a href="#Warehouse.HandleResupply-1704"><span class="linenos">1704</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.HandleResupply-1705"><a href="#Warehouse.HandleResupply-1705"><span class="linenos">1705</span></a><span class="sd">        Periodic behaviour that monitors stock levels and triggers restocking.</span>
</span><span id="Warehouse.HandleResupply-1706"><a href="#Warehouse.HandleResupply-1706"><span class="linenos">1706</span></a><span class="sd">        </span>
</span><span id="Warehouse.HandleResupply-1707"><a href="#Warehouse.HandleResupply-1707"><span class="linenos">1707</span></a><span class="sd">        Checks each product&#39;s stock against WAREHOUSE_RESUPPLY_THRESHOLD and</span>
</span><span id="Warehouse.HandleResupply-1708"><a href="#Warehouse.HandleResupply-1708"><span class="linenos">1708</span></a><span class="sd">        launches BuyMaterial behaviour when inventory falls below threshold.</span>
</span><span id="Warehouse.HandleResupply-1709"><a href="#Warehouse.HandleResupply-1709"><span class="linenos">1709</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.HandleResupply-1710"><a href="#Warehouse.HandleResupply-1710"><span class="linenos">1710</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.HandleResupply-1711"><a href="#Warehouse.HandleResupply-1711"><span class="linenos">1711</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.HandleResupply-1712"><a href="#Warehouse.HandleResupply-1712"><span class="linenos">1712</span></a>            
</span><span id="Warehouse.HandleResupply-1713"><a href="#Warehouse.HandleResupply-1713"><span class="linenos">1713</span></a>            <span class="c1"># Check stock levels</span>
</span><span id="Warehouse.HandleResupply-1714"><a href="#Warehouse.HandleResupply-1714"><span class="linenos">1714</span></a>            <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Warehouse.HandleResupply-1715"><a href="#Warehouse.HandleResupply-1715"><span class="linenos">1715</span></a>                <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_RESUPPLY_THRESHOLD</span><span class="p">:</span>
</span><span id="Warehouse.HandleResupply-1716"><a href="#Warehouse.HandleResupply-1716"><span class="linenos">1716</span></a>                    <span class="c1"># Need to restock this product</span>
</span><span id="Warehouse.HandleResupply-1717"><a href="#Warehouse.HandleResupply-1717"><span class="linenos">1717</span></a>                    <span class="n">restock_amount</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span> <span class="o">-</span> <span class="n">amount</span>
</span><span id="Warehouse.HandleResupply-1718"><a href="#Warehouse.HandleResupply-1718"><span class="linenos">1718</span></a>                    <span class="c1"># Essential print - warehouse restocking</span>
</span><span id="Warehouse.HandleResupply-1719"><a href="#Warehouse.HandleResupply-1719"><span class="linenos">1719</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Restocking </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span><span class="si">}</span><span class="s2"> (buying </span><span class="si">{</span><span class="n">restock_amount</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.HandleResupply-1720"><a href="#Warehouse.HandleResupply-1720"><span class="linenos">1720</span></a>                    
</span><span id="Warehouse.HandleResupply-1721"><a href="#Warehouse.HandleResupply-1721"><span class="linenos">1721</span></a>                    <span class="n">buy_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">BuyMaterial</span><span class="p">(</span><span class="n">restock_amount</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
</span><span id="Warehouse.HandleResupply-1722"><a href="#Warehouse.HandleResupply-1722"><span class="linenos">1722</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">buy_behav</span><span class="p">)</span>
</span><span id="Warehouse.HandleResupply-1723"><a href="#Warehouse.HandleResupply-1723"><span class="linenos">1723</span></a>                    
</span><span id="Warehouse.HandleResupply-1724"><a href="#Warehouse.HandleResupply-1724"><span class="linenos">1724</span></a>                    <span class="k">await</span> <span class="n">buy_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Periodic behaviour that monitors stock levels and triggers restocking.</p>

<p>Checks each product's stock against WAREHOUSE_RESUPPLY_THRESHOLD and
launches BuyMaterial behaviour when inventory falls below threshold.</p>
</div>


                            <div id="Warehouse.HandleResupply.run" class="classattr">
                                        <input id="Warehouse.HandleResupply.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.HandleResupply.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.HandleResupply.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.HandleResupply.run-1710"><a href="#Warehouse.HandleResupply.run-1710"><span class="linenos">1710</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.HandleResupply.run-1711"><a href="#Warehouse.HandleResupply.run-1711"><span class="linenos">1711</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.HandleResupply.run-1712"><a href="#Warehouse.HandleResupply.run-1712"><span class="linenos">1712</span></a>            
</span><span id="Warehouse.HandleResupply.run-1713"><a href="#Warehouse.HandleResupply.run-1713"><span class="linenos">1713</span></a>            <span class="c1"># Check stock levels</span>
</span><span id="Warehouse.HandleResupply.run-1714"><a href="#Warehouse.HandleResupply.run-1714"><span class="linenos">1714</span></a>            <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Warehouse.HandleResupply.run-1715"><a href="#Warehouse.HandleResupply.run-1715"><span class="linenos">1715</span></a>                <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_RESUPPLY_THRESHOLD</span><span class="p">:</span>
</span><span id="Warehouse.HandleResupply.run-1716"><a href="#Warehouse.HandleResupply.run-1716"><span class="linenos">1716</span></a>                    <span class="c1"># Need to restock this product</span>
</span><span id="Warehouse.HandleResupply.run-1717"><a href="#Warehouse.HandleResupply.run-1717"><span class="linenos">1717</span></a>                    <span class="n">restock_amount</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span> <span class="o">-</span> <span class="n">amount</span>
</span><span id="Warehouse.HandleResupply.run-1718"><a href="#Warehouse.HandleResupply.run-1718"><span class="linenos">1718</span></a>                    <span class="c1"># Essential print - warehouse restocking</span>
</span><span id="Warehouse.HandleResupply.run-1719"><a href="#Warehouse.HandleResupply.run-1719"><span class="linenos">1719</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Restocking </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">WAREHOUSE_MAX_PRODUCT_CAPACITY</span><span class="si">}</span><span class="s2"> (buying </span><span class="si">{</span><span class="n">restock_amount</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.HandleResupply.run-1720"><a href="#Warehouse.HandleResupply.run-1720"><span class="linenos">1720</span></a>                    
</span><span id="Warehouse.HandleResupply.run-1721"><a href="#Warehouse.HandleResupply.run-1721"><span class="linenos">1721</span></a>                    <span class="n">buy_behav</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">BuyMaterial</span><span class="p">(</span><span class="n">restock_amount</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
</span><span id="Warehouse.HandleResupply.run-1722"><a href="#Warehouse.HandleResupply.run-1722"><span class="linenos">1722</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">add_behaviour</span><span class="p">(</span><span class="n">buy_behav</span><span class="p">)</span>
</span><span id="Warehouse.HandleResupply.run-1723"><a href="#Warehouse.HandleResupply.run-1723"><span class="linenos">1723</span></a>                    
</span><span id="Warehouse.HandleResupply.run-1724"><a href="#Warehouse.HandleResupply.run-1724"><span class="linenos">1724</span></a>                    <span class="k">await</span> <span class="n">buy_behav</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.ReceiveVehicleArrival">
                            <input id="Warehouse.ReceiveVehicleArrival-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.ReceiveVehicleArrival</span><wbr>(<span class="base">spade.behaviour.CyclicBehaviour</span>):

                <label class="view-source-button" for="Warehouse.ReceiveVehicleArrival-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveVehicleArrival"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveVehicleArrival-1730"><a href="#Warehouse.ReceiveVehicleArrival-1730"><span class="linenos">1730</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveVehicleArrival</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1731"><a href="#Warehouse.ReceiveVehicleArrival-1731"><span class="linenos">1731</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1732"><a href="#Warehouse.ReceiveVehicleArrival-1732"><span class="linenos">1732</span></a><span class="sd">        Cyclic behaviour that processes vehicle pickup and delivery notifications.</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1733"><a href="#Warehouse.ReceiveVehicleArrival-1733"><span class="linenos">1733</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveVehicleArrival-1734"><a href="#Warehouse.ReceiveVehicleArrival-1734"><span class="linenos">1734</span></a><span class="sd">        Handles vehicle-pickup messages (vehicle collects order from warehouse) and</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1735"><a href="#Warehouse.ReceiveVehicleArrival-1735"><span class="linenos">1735</span></a><span class="sd">        vehicle-delivery messages (vehicle delivers supplies from supplier), updating</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1736"><a href="#Warehouse.ReceiveVehicleArrival-1736"><span class="linenos">1736</span></a><span class="sd">        pending_deliveries and stock accordingly.</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1737"><a href="#Warehouse.ReceiveVehicleArrival-1737"><span class="linenos">1737</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1738"><a href="#Warehouse.ReceiveVehicleArrival-1738"><span class="linenos">1738</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1739"><a href="#Warehouse.ReceiveVehicleArrival-1739"><span class="linenos">1739</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1740"><a href="#Warehouse.ReceiveVehicleArrival-1740"><span class="linenos">1740</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1741"><a href="#Warehouse.ReceiveVehicleArrival-1741"><span class="linenos">1741</span></a>            
</span><span id="Warehouse.ReceiveVehicleArrival-1742"><a href="#Warehouse.ReceiveVehicleArrival-1742"><span class="linenos">1742</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1743"><a href="#Warehouse.ReceiveVehicleArrival-1743"><span class="linenos">1743</span></a>                <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1744"><a href="#Warehouse.ReceiveVehicleArrival-1744"><span class="linenos">1744</span></a>                
</span><span id="Warehouse.ReceiveVehicleArrival-1745"><a href="#Warehouse.ReceiveVehicleArrival-1745"><span class="linenos">1745</span></a>                <span class="c1"># Double-check (should already be filtered by templates)</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1746"><a href="#Warehouse.ReceiveVehicleArrival-1746"><span class="linenos">1746</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">]:</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1747"><a href="#Warehouse.ReceiveVehicleArrival-1747"><span class="linenos">1747</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Received unexpected performative &#39;</span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1748"><a href="#Warehouse.ReceiveVehicleArrival-1748"><span class="linenos">1748</span></a>                    <span class="k">return</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1749"><a href="#Warehouse.ReceiveVehicleArrival-1749"><span class="linenos">1749</span></a>                
</span><span id="Warehouse.ReceiveVehicleArrival-1750"><a href="#Warehouse.ReceiveVehicleArrival-1750"><span class="linenos">1750</span></a>                <span class="c1"># Parse message body</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1751"><a href="#Warehouse.ReceiveVehicleArrival-1751"><span class="linenos">1751</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1752"><a href="#Warehouse.ReceiveVehicleArrival-1752"><span class="linenos">1752</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1753"><a href="#Warehouse.ReceiveVehicleArrival-1753"><span class="linenos">1753</span></a>                    <span class="n">orderid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1754"><a href="#Warehouse.ReceiveVehicleArrival-1754"><span class="linenos">1754</span></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">orderid</span><span class="p">]</span> 
</span><span id="Warehouse.ReceiveVehicleArrival-1755"><a href="#Warehouse.ReceiveVehicleArrival-1755"><span class="linenos">1755</span></a>                <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1756"><a href="#Warehouse.ReceiveVehicleArrival-1756"><span class="linenos">1756</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Failed to parse vehicle message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1757"><a href="#Warehouse.ReceiveVehicleArrival-1757"><span class="linenos">1757</span></a>                    <span class="k">return</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1758"><a href="#Warehouse.ReceiveVehicleArrival-1758"><span class="linenos">1758</span></a>                
</span><span id="Warehouse.ReceiveVehicleArrival-1759"><a href="#Warehouse.ReceiveVehicleArrival-1759"><span class="linenos">1759</span></a>                <span class="c1"># Handle based on performative</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1760"><a href="#Warehouse.ReceiveVehicleArrival-1760"><span class="linenos">1760</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1761"><a href="#Warehouse.ReceiveVehicleArrival-1761"><span class="linenos">1761</span></a>                    <span class="c1"># Vehicle is picking up an order to deliver to store</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1762"><a href="#Warehouse.ReceiveVehicleArrival-1762"><span class="linenos">1762</span></a>                    <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1763"><a href="#Warehouse.ReceiveVehicleArrival-1763"><span class="linenos">1763</span></a>                        <span class="k">del</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1764"><a href="#Warehouse.ReceiveVehicleArrival-1764"><span class="linenos">1764</span></a>                        <span class="c1"># Essential print - vehicle pickup</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1765"><a href="#Warehouse.ReceiveVehicleArrival-1765"><span class="linenos">1765</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> picked up order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1766"><a href="#Warehouse.ReceiveVehicleArrival-1766"><span class="linenos">1766</span></a>                            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1767"><a href="#Warehouse.ReceiveVehicleArrival-1767"><span class="linenos">1767</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1768"><a href="#Warehouse.ReceiveVehicleArrival-1768"><span class="linenos">1768</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2"> not found in pending orders!&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1769"><a href="#Warehouse.ReceiveVehicleArrival-1769"><span class="linenos">1769</span></a>                
</span><span id="Warehouse.ReceiveVehicleArrival-1770"><a href="#Warehouse.ReceiveVehicleArrival-1770"><span class="linenos">1770</span></a>                <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1771"><a href="#Warehouse.ReceiveVehicleArrival-1771"><span class="linenos">1771</span></a>                    <span class="c1"># Vehicle is delivering supplies from supplier</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1772"><a href="#Warehouse.ReceiveVehicleArrival-1772"><span class="linenos">1772</span></a>                    <span class="n">product</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1773"><a href="#Warehouse.ReceiveVehicleArrival-1773"><span class="linenos">1773</span></a>                    <span class="n">quantity</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1774"><a href="#Warehouse.ReceiveVehicleArrival-1774"><span class="linenos">1774</span></a>                    
</span><span id="Warehouse.ReceiveVehicleArrival-1775"><a href="#Warehouse.ReceiveVehicleArrival-1775"><span class="linenos">1775</span></a>                    <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1776"><a href="#Warehouse.ReceiveVehicleArrival-1776"><span class="linenos">1776</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1777"><a href="#Warehouse.ReceiveVehicleArrival-1777"><span class="linenos">1777</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1778"><a href="#Warehouse.ReceiveVehicleArrival-1778"><span class="linenos">1778</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1779"><a href="#Warehouse.ReceiveVehicleArrival-1779"><span class="linenos">1779</span></a>                    
</span><span id="Warehouse.ReceiveVehicleArrival-1780"><a href="#Warehouse.ReceiveVehicleArrival-1780"><span class="linenos">1780</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> delivered </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival-1781"><a href="#Warehouse.ReceiveVehicleArrival-1781"><span class="linenos">1781</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>                            
</span></pre></div>


            <div class="docstring"><p>Cyclic behaviour that processes vehicle pickup and delivery notifications.</p>

<p>Handles vehicle-pickup messages (vehicle collects order from warehouse) and
vehicle-delivery messages (vehicle delivers supplies from supplier), updating
pending_deliveries and stock accordingly.</p>
</div>


                            <div id="Warehouse.ReceiveVehicleArrival.run" class="classattr">
                                        <input id="Warehouse.ReceiveVehicleArrival.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.ReceiveVehicleArrival.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveVehicleArrival.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveVehicleArrival.run-1738"><a href="#Warehouse.ReceiveVehicleArrival.run-1738"><span class="linenos">1738</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1739"><a href="#Warehouse.ReceiveVehicleArrival.run-1739"><span class="linenos">1739</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1740"><a href="#Warehouse.ReceiveVehicleArrival.run-1740"><span class="linenos">1740</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1741"><a href="#Warehouse.ReceiveVehicleArrival.run-1741"><span class="linenos">1741</span></a>            
</span><span id="Warehouse.ReceiveVehicleArrival.run-1742"><a href="#Warehouse.ReceiveVehicleArrival.run-1742"><span class="linenos">1742</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1743"><a href="#Warehouse.ReceiveVehicleArrival.run-1743"><span class="linenos">1743</span></a>                <span class="n">performative</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;performative&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1744"><a href="#Warehouse.ReceiveVehicleArrival.run-1744"><span class="linenos">1744</span></a>                
</span><span id="Warehouse.ReceiveVehicleArrival.run-1745"><a href="#Warehouse.ReceiveVehicleArrival.run-1745"><span class="linenos">1745</span></a>                <span class="c1"># Double-check (should already be filtered by templates)</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1746"><a href="#Warehouse.ReceiveVehicleArrival.run-1746"><span class="linenos">1746</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">,</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">]:</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1747"><a href="#Warehouse.ReceiveVehicleArrival.run-1747"><span class="linenos">1747</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Received unexpected performative &#39;</span><span class="si">{</span><span class="n">performative</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1748"><a href="#Warehouse.ReceiveVehicleArrival.run-1748"><span class="linenos">1748</span></a>                    <span class="k">return</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1749"><a href="#Warehouse.ReceiveVehicleArrival.run-1749"><span class="linenos">1749</span></a>                
</span><span id="Warehouse.ReceiveVehicleArrival.run-1750"><a href="#Warehouse.ReceiveVehicleArrival.run-1750"><span class="linenos">1750</span></a>                <span class="c1"># Parse message body</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1751"><a href="#Warehouse.ReceiveVehicleArrival.run-1751"><span class="linenos">1751</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1752"><a href="#Warehouse.ReceiveVehicleArrival.run-1752"><span class="linenos">1752</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1753"><a href="#Warehouse.ReceiveVehicleArrival.run-1753"><span class="linenos">1753</span></a>                    <span class="n">orderid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;orderid&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1754"><a href="#Warehouse.ReceiveVehicleArrival.run-1754"><span class="linenos">1754</span></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">orderid</span><span class="p">]</span> 
</span><span id="Warehouse.ReceiveVehicleArrival.run-1755"><a href="#Warehouse.ReceiveVehicleArrival.run-1755"><span class="linenos">1755</span></a>                <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1756"><a href="#Warehouse.ReceiveVehicleArrival.run-1756"><span class="linenos">1756</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Failed to parse vehicle message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1757"><a href="#Warehouse.ReceiveVehicleArrival.run-1757"><span class="linenos">1757</span></a>                    <span class="k">return</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1758"><a href="#Warehouse.ReceiveVehicleArrival.run-1758"><span class="linenos">1758</span></a>                
</span><span id="Warehouse.ReceiveVehicleArrival.run-1759"><a href="#Warehouse.ReceiveVehicleArrival.run-1759"><span class="linenos">1759</span></a>                <span class="c1"># Handle based on performative</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1760"><a href="#Warehouse.ReceiveVehicleArrival.run-1760"><span class="linenos">1760</span></a>                <span class="k">if</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;vehicle-pickup&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1761"><a href="#Warehouse.ReceiveVehicleArrival.run-1761"><span class="linenos">1761</span></a>                    <span class="c1"># Vehicle is picking up an order to deliver to store</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1762"><a href="#Warehouse.ReceiveVehicleArrival.run-1762"><span class="linenos">1762</span></a>                    <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">orderid</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1763"><a href="#Warehouse.ReceiveVehicleArrival.run-1763"><span class="linenos">1763</span></a>                        <span class="k">del</span> <span class="n">agent</span><span class="o">.</span><span class="n">pending_deliveries</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1764"><a href="#Warehouse.ReceiveVehicleArrival.run-1764"><span class="linenos">1764</span></a>                        <span class="c1"># Essential print - vehicle pickup</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1765"><a href="#Warehouse.ReceiveVehicleArrival.run-1765"><span class="linenos">1765</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> picked up order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1766"><a href="#Warehouse.ReceiveVehicleArrival.run-1766"><span class="linenos">1766</span></a>                            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">product</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1767"><a href="#Warehouse.ReceiveVehicleArrival.run-1767"><span class="linenos">1767</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1768"><a href="#Warehouse.ReceiveVehicleArrival.run-1768"><span class="linenos">1768</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; ERROR: Order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s2"> not found in pending orders!&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1769"><a href="#Warehouse.ReceiveVehicleArrival.run-1769"><span class="linenos">1769</span></a>                
</span><span id="Warehouse.ReceiveVehicleArrival.run-1770"><a href="#Warehouse.ReceiveVehicleArrival.run-1770"><span class="linenos">1770</span></a>                <span class="k">elif</span> <span class="n">performative</span> <span class="o">==</span> <span class="s2">&quot;vehicle-delivery&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1771"><a href="#Warehouse.ReceiveVehicleArrival.run-1771"><span class="linenos">1771</span></a>                    <span class="c1"># Vehicle is delivering supplies from supplier</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1772"><a href="#Warehouse.ReceiveVehicleArrival.run-1772"><span class="linenos">1772</span></a>                    <span class="n">product</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">product</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1773"><a href="#Warehouse.ReceiveVehicleArrival.run-1773"><span class="linenos">1773</span></a>                    <span class="n">quantity</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1774"><a href="#Warehouse.ReceiveVehicleArrival.run-1774"><span class="linenos">1774</span></a>                    
</span><span id="Warehouse.ReceiveVehicleArrival.run-1775"><a href="#Warehouse.ReceiveVehicleArrival.run-1775"><span class="linenos">1775</span></a>                    <span class="k">if</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1776"><a href="#Warehouse.ReceiveVehicleArrival.run-1776"><span class="linenos">1776</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1777"><a href="#Warehouse.ReceiveVehicleArrival.run-1777"><span class="linenos">1777</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1778"><a href="#Warehouse.ReceiveVehicleArrival.run-1778"><span class="linenos">1778</span></a>                        <span class="n">agent</span><span class="o">.</span><span class="n">stock</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="n">quantity</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1779"><a href="#Warehouse.ReceiveVehicleArrival.run-1779"><span class="linenos">1779</span></a>                    
</span><span id="Warehouse.ReceiveVehicleArrival.run-1780"><a href="#Warehouse.ReceiveVehicleArrival.run-1780"><span class="linenos">1780</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">jid</span><span class="si">}</span><span class="s2">&gt; Vehicle </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">sender</span><span class="si">}</span><span class="s2"> delivered </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> units of </span><span class="si">{</span><span class="n">product</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveVehicleArrival.run-1781"><a href="#Warehouse.ReceiveVehicleArrival.run-1781"><span class="linenos">1781</span></a>                    <span class="n">agent</span><span class="o">.</span><span class="n">print_stock</span><span class="p">()</span>                            
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
                <section id="Warehouse.ReceiveTimeDelta">
                            <input id="Warehouse.ReceiveTimeDelta-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Warehouse.ReceiveTimeDelta</span><wbr>(<span class="base">spade.behaviour.CyclicBehaviour</span>):

                <label class="view-source-button" for="Warehouse.ReceiveTimeDelta-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveTimeDelta"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveTimeDelta-1783"><a href="#Warehouse.ReceiveTimeDelta-1783"><span class="linenos">1783</span></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ReceiveTimeDelta</span><span class="p">(</span><span class="n">CyclicBehaviour</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveTimeDelta-1784"><a href="#Warehouse.ReceiveTimeDelta-1784"><span class="linenos">1784</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveTimeDelta-1785"><a href="#Warehouse.ReceiveTimeDelta-1785"><span class="linenos">1785</span></a><span class="sd">        Cyclic behaviour that synchronizes simulation time and applies traffic updates.</span>
</span><span id="Warehouse.ReceiveTimeDelta-1786"><a href="#Warehouse.ReceiveTimeDelta-1786"><span class="linenos">1786</span></a><span class="sd">        </span>
</span><span id="Warehouse.ReceiveTimeDelta-1787"><a href="#Warehouse.ReceiveTimeDelta-1787"><span class="linenos">1787</span></a><span class="sd">        Receives time delta messages from world agent, updates current_tick, and</span>
</span><span id="Warehouse.ReceiveTimeDelta-1788"><a href="#Warehouse.ReceiveTimeDelta-1788"><span class="linenos">1788</span></a><span class="sd">        applies dynamic graph edge weight changes for traffic simulation.</span>
</span><span id="Warehouse.ReceiveTimeDelta-1789"><a href="#Warehouse.ReceiveTimeDelta-1789"><span class="linenos">1789</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Warehouse.ReceiveTimeDelta-1790"><a href="#Warehouse.ReceiveTimeDelta-1790"><span class="linenos">1790</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveTimeDelta-1791"><a href="#Warehouse.ReceiveTimeDelta-1791"><span class="linenos">1791</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ReceiveTimeDelta-1792"><a href="#Warehouse.ReceiveTimeDelta-1792"><span class="linenos">1792</span></a>            
</span><span id="Warehouse.ReceiveTimeDelta-1793"><a href="#Warehouse.ReceiveTimeDelta-1793"><span class="linenos">1793</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveTimeDelta-1794"><a href="#Warehouse.ReceiveTimeDelta-1794"><span class="linenos">1794</span></a>            
</span><span id="Warehouse.ReceiveTimeDelta-1795"><a href="#Warehouse.ReceiveTimeDelta-1795"><span class="linenos">1795</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveTimeDelta-1796"><a href="#Warehouse.ReceiveTimeDelta-1796"><span class="linenos">1796</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveTimeDelta-1797"><a href="#Warehouse.ReceiveTimeDelta-1797"><span class="linenos">1797</span></a>                
</span><span id="Warehouse.ReceiveTimeDelta-1798"><a href="#Warehouse.ReceiveTimeDelta-1798"><span class="linenos">1798</span></a>                <span class="nb">type</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveTimeDelta-1799"><a href="#Warehouse.ReceiveTimeDelta-1799"><span class="linenos">1799</span></a>                <span class="n">delta</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveTimeDelta-1800"><a href="#Warehouse.ReceiveTimeDelta-1800"><span class="linenos">1800</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="Warehouse.ReceiveTimeDelta-1801"><a href="#Warehouse.ReceiveTimeDelta-1801"><span class="linenos">1801</span></a>                
</span><span id="Warehouse.ReceiveTimeDelta-1802"><a href="#Warehouse.ReceiveTimeDelta-1802"><span class="linenos">1802</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;arrival&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveTimeDelta-1803"><a href="#Warehouse.ReceiveTimeDelta-1803"><span class="linenos">1803</span></a>                    <span class="n">map_updates</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> 
</span><span id="Warehouse.ReceiveTimeDelta-1804"><a href="#Warehouse.ReceiveTimeDelta-1804"><span class="linenos">1804</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">update_graph</span><span class="p">(</span><span class="n">map_updates</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Cyclic behaviour that synchronizes simulation time and applies traffic updates.</p>

<p>Receives time delta messages from world agent, updates current_tick, and
applies dynamic graph edge weight changes for traffic simulation.</p>
</div>


                            <div id="Warehouse.ReceiveTimeDelta.run" class="classattr">
                                        <input id="Warehouse.ReceiveTimeDelta.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Warehouse.ReceiveTimeDelta.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Warehouse.ReceiveTimeDelta.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Warehouse.ReceiveTimeDelta.run-1790"><a href="#Warehouse.ReceiveTimeDelta.run-1790"><span class="linenos">1790</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Warehouse.ReceiveTimeDelta.run-1791"><a href="#Warehouse.ReceiveTimeDelta.run-1791"><span class="linenos">1791</span></a>            <span class="n">agent</span> <span class="p">:</span> <span class="n">Warehouse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
</span><span id="Warehouse.ReceiveTimeDelta.run-1792"><a href="#Warehouse.ReceiveTimeDelta.run-1792"><span class="linenos">1792</span></a>            
</span><span id="Warehouse.ReceiveTimeDelta.run-1793"><a href="#Warehouse.ReceiveTimeDelta.run-1793"><span class="linenos">1793</span></a>            <span class="n">msg</span> <span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveTimeDelta.run-1794"><a href="#Warehouse.ReceiveTimeDelta.run-1794"><span class="linenos">1794</span></a>            
</span><span id="Warehouse.ReceiveTimeDelta.run-1795"><a href="#Warehouse.ReceiveTimeDelta.run-1795"><span class="linenos">1795</span></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveTimeDelta.run-1796"><a href="#Warehouse.ReceiveTimeDelta.run-1796"><span class="linenos">1796</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span id="Warehouse.ReceiveTimeDelta.run-1797"><a href="#Warehouse.ReceiveTimeDelta.run-1797"><span class="linenos">1797</span></a>                
</span><span id="Warehouse.ReceiveTimeDelta.run-1798"><a href="#Warehouse.ReceiveTimeDelta.run-1798"><span class="linenos">1798</span></a>                <span class="nb">type</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveTimeDelta.run-1799"><a href="#Warehouse.ReceiveTimeDelta.run-1799"><span class="linenos">1799</span></a>                <span class="n">delta</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
</span><span id="Warehouse.ReceiveTimeDelta.run-1800"><a href="#Warehouse.ReceiveTimeDelta.run-1800"><span class="linenos">1800</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">current_tick</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="Warehouse.ReceiveTimeDelta.run-1801"><a href="#Warehouse.ReceiveTimeDelta.run-1801"><span class="linenos">1801</span></a>                
</span><span id="Warehouse.ReceiveTimeDelta.run-1802"><a href="#Warehouse.ReceiveTimeDelta.run-1802"><span class="linenos">1802</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;arrival&quot;</span><span class="p">:</span>
</span><span id="Warehouse.ReceiveTimeDelta.run-1803"><a href="#Warehouse.ReceiveTimeDelta.run-1803"><span class="linenos">1803</span></a>                    <span class="n">map_updates</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> 
</span><span id="Warehouse.ReceiveTimeDelta.run-1804"><a href="#Warehouse.ReceiveTimeDelta.run-1804"><span class="linenos">1804</span></a>                <span class="n">agent</span><span class="o">.</span><span class="n">update_graph</span><span class="p">(</span><span class="n">map_updates</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Body of the behaviour.
To be implemented by user.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>